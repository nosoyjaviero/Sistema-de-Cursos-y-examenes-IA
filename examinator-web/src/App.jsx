import React, { useState, useEffect, useRef } from 'react';
import './App.css';
import './ModalGuardarTxt.css';
import './ModoSesion.css';
import './EditorNotion.css';
import { InlineMath, BlockMath } from 'react-katex';
import 'katex/dist/katex.min.css';
import MathEditor from './components/MathEditor';
import MathToolbar from './components/MathToolbar';
import ChemEditor from './components/ChemEditor';
import ChemToolbar from './components/ChemToolbar';
import PhysicsEditor from './components/PhysicsEditor';
import PhysicsToolbar from './components/PhysicsToolbar';
import EngineeringCanvas from './components/EngineeringCanvas';
import EngineeringToolbar from './components/EngineeringToolbar';
import ProgrammingCanvas from './components/ProgrammingCanvas';
import ProgrammingToolbar from './components/ProgrammingToolbar';
import DiscreteCanvas from './components/DiscreteCanvas';
import DiscreteToolbar from './components/DiscreteToolbar';
import LinguisticsCanvas from './components/LinguisticsCanvas';
import LinguisticsToolbar from './components/LinguisticsToolbar';
import MusicCanvas from './components/MusicCanvas';
import MusicToolbar from './components/MusicToolbar';
import GeometryCanvas from './components/GeometryCanvas';
import GeometryToolbar from './components/GeometryToolbar';
import AdvancedChemistryCanvas from './components/AdvancedChemistryCanvas';
import AdvancedChemistryToolbar from './components/AdvancedChemistryToolbar';
import ProbabilityCanvas from './ProbabilityCanvas';
import ProbabilityToolbar from './ProbabilityToolbar';
import VisualModeSelector from './VisualModeSelector';
import ArtCanvas from './components/ArtCanvas';
import ArtToolbar from './components/ArtToolbar';

// ========================================
// FUNCIONES HELPER PARA DATOS PERSISTENTES
// ========================================
const SERVER_IP = window.location.hostname;

/**
 * Obtiene datos (notas, flashcards, practicas) desde el backend
 * @param {string} tipo - 'notas', 'flashcards' o 'practicas'
 * @returns {Promise<Array>} Array de datos o array vac√≠o si falla
 */
async function getDatos(tipo) {
  try {
    const response = await fetch(`http://${SERVER_IP}:8000/datos/${tipo}`);
    if (!response.ok) {
      console.error(`Error al obtener ${tipo}: ${response.status}`);
      return [];
    }
    const data = await response.json();
    return Array.isArray(data) ? data : [];
  } catch (error) {
    console.error(`Error de red al obtener ${tipo}:`, error);
    return [];
  }
}

/**
 * Guarda datos (notas, flashcards, practicas) en el backend
 * @param {string} tipo - 'notas', 'flashcards' o 'practicas'
 * @param {Array|Object} data - Datos a guardar
 * @returns {Promise<boolean>} true si tuvo √©xito, false si fall√≥
 */
async function setDatos(tipo, data) {
  try {
    const response = await fetch(`http://${SERVER_IP}:8000/datos/${tipo}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!response.ok) {
      console.error(`Error al guardar ${tipo}: ${response.status}`);
      return false;
    }
    const result = await response.json();
    return result.ok === true;
  } catch (error) {
    console.error(`Error de red al guardar ${tipo}:`, error);
    return false;
  }
}

/**
 * Obtiene sesiones completadas desde el backend
 * @returns {Promise<Array>} Array de sesiones o array vac√≠o si falla
 */
async function getSesionesCompletadas() {
  try {
    const response = await fetch(`http://${SERVER_IP}:8000/datos/sesiones/completadas`);
    if (!response.ok) {
      console.error(`Error al obtener sesiones completadas: ${response.status}`);
      return [];
    }
    const data = await response.json();
    return Array.isArray(data) ? data : [];
  } catch (error) {
    console.error('Error de red al obtener sesiones completadas:', error);
    return [];
  }
}

/**
 * Guarda sesiones completadas en el backend
 * @param {Array} data - Array de sesiones completadas
 * @returns {Promise<boolean>} true si tuvo √©xito, false si fall√≥
 */
async function setSesionesCompletadas(data) {
  try {
    const response = await fetch(`http://${SERVER_IP}:8000/datos/sesiones/completadas`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!response.ok) {
      console.error(`Error al guardar sesiones completadas: ${response.status}`);
      return false;
    }
    const result = await response.json();
    return result.ok === true;
  } catch (error) {
    console.error('Error de red al guardar sesiones completadas:', error);
    return false;
  }
}

/**
 * Obtiene la sesi√≥n activa desde el backend
 * @returns {Promise<Object>} Objeto de sesi√≥n activa o {} si falla
 */
async function getSesionActiva() {
  try {
    const response = await fetch(`http://${SERVER_IP}:8000/datos/sesion/activa`);
    if (!response.ok) {
      console.error(`Error al obtener sesi√≥n activa: ${response.status}`);
      return {};
    }
    const data = await response.json();
    return typeof data === 'object' ? data : {};
  } catch (error) {
    console.error('Error de red al obtener sesi√≥n activa:', error);
    return {};
  }
}

/**
 * Guarda la sesi√≥n activa en el backend
 * @param {Object} data - Objeto de sesi√≥n activa
 * @returns {Promise<boolean>} true si tuvo √©xito, false si fall√≥
 */
async function setSesionActiva(data) {
  try {
    const response = await fetch(`http://${SERVER_IP}:8000/datos/sesion/activa`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!response.ok) {
      console.error(`Error al guardar sesi√≥n activa: ${response.status}`);
      return false;
    }
    const result = await response.json();
    return result.ok === true;
  } catch (error) {
    console.error('Error de red al guardar sesi√≥n activa:', error);
    return false;
  }
}

function App() {
  const [selectedMenu, setSelectedMenu] = useState('inicio')
  const [rutaActual, setRutaActual] = useState('')
  const [carpetas, setCarpetas] = useState([])
  const [documentos, setDocumentos] = useState([])
  const [loading, setLoading] = useState(false)
  const [mensaje, setMensaje] = useState(null)
  const [visorAbierto, setVisorAbierto] = useState(false)
  const [documentoActual, setDocumentoActual] = useState(null)
  const [modoEdicion, setModoEdicion] = useState(false)
  const [contenidoEditado, setContenidoEditado] = useState('')
  const [leyendo, setLeyendo] = useState(false)
  const [pausado, setPausado] = useState(false)
  const [posicionLectura, setPosicionLectura] = useState({ inicio: 0, fin: 0 })
  const [menuAbierto, setMenuAbierto] = useState(null)
  const [moverCarpeta, setMoverCarpeta] = useState(null)
  const [modalMoverAbierto, setModalMoverAbierto] = useState(false)
  const [rutaDestinoSeleccionada, setRutaDestinoSeleccionada] = useState('')
  const [carpetasDestino, setCarpetasDestino] = useState([])
  const [modelosDisponibles, setModelosDisponibles] = useState([])
  const [configuracion, setConfiguracion] = useState(null)
  const [modeloSeleccionado, setModeloSeleccionado] = useState(null)
  const [cargandoConfig, setCargandoConfig] = useState(false)
  const [modelosParaDescargar, setModelosParaDescargar] = useState([])
  const [mostrarDescarga, setMostrarDescarga] = useState(false)
  const [mostrarModelos, setMostrarModelos] = useState(true)
  const [mensajesChat, setMensajesChat] = useState([])
  const [inputChat, setInputChat] = useState('')
  const [cargandoChat, setCargandoChat] = useState(false)
  const [editandoMensaje, setEditandoMensaje] = useState(null)
  const [textoEditado, setTextoEditado] = useState('')
  const [historialChats, setHistorialChats] = useState([])
  const [chatActualId, setChatActualId] = useState(null)
  const [nombreChatNuevo, setNombreChatNuevo] = useState('')
  const [mostrarModalHistorial, setMostrarModalHistorial] = useState(false)
  const [archivoContexto, setArchivoContexto] = useState(null)
  const [contenidoContexto, setContenidoContexto] = useState('')
  const [nombreArchivoContexto, setNombreArchivoContexto] = useState('')
  const [busquedaWebActiva, setBusquedaWebActiva] = useState(false)
  
  // Estados para carpetas de chats (proyectos)
  const [carpetasChats, setCarpetasChats] = useState([])
  const [carpetaChatActual, setCarpetaChatActual] = useState('')
  const [mostrarModalCarpetas, setMostrarModalCarpetas] = useState(false)
  
  // Estados para mover chats y carpetas
  const [mostrarModalMover, setMostrarModalMover] = useState(false)
  const [itemAMover, setItemAMover] = useState(null) // {tipo: 'chat'|'carpeta', id: string, nombre: string, rutaActual: string}
  const [carpetasDestinoMover, setCarpetasDestinoMover] = useState([])
  const [rutaDestinoMover, setRutaDestinoMover] = useState('')
  
  // Estados para ex√°menes
  const [examenActivo, setExamenActivo] = useState(null)
  const [menuDropdownAbierto, setMenuDropdownAbierto] = useState(false)
  
  // Estados para marcado de carpetas y generaci√≥n masiva
  const [modalSeleccionArchivos, setModalSeleccionArchivos] = useState(false)
  const [archivosEncontrados, setArchivosEncontrados] = useState([])
  const [archivosExcluidos, setArchivosExcluidos] = useState([])
  const [tipoCarpeta, setTipoCarpeta] = useState('') // 'curso', 'capitulo', 'clase', 'leccion'
  const [carpetasMarcadas, setCarpetasMarcadas] = useState({}) // {ruta: {tipo, fecha}}
  const [configExamenCarpeta, setConfigExamenCarpeta] = useState({
    num_multiple: 10,
    num_corta: 5,
    num_vf: 5,
    num_desarrollo: 3
  })
  const [generandoExamenPorBloques, setGenerandoExamenPorBloques] = useState(false)
  const [bloqueActual, setBloqueActual] = useState(0)
  const [totalBloques, setTotalBloques] = useState(0)
  
  const [preguntasExamen, setPreguntasExamen] = useState([])
  const [respuestasUsuario, setRespuestasUsuario] = useState({})
  const [preguntasComprendidas, setPreguntasComprendidas] = useState({}) // {practicaId: {preguntaIndex: true}}
  const [resultadoExamen, setResultadoExamen] = useState(null)
  const [examenCompletado, setExamenCompletado] = useState(false)
  
  // Estados para carpetas recientes en inicio (cursos, cap√≠tulos, clases, lecciones)
  const [cursosRecientes, setCursosRecientes] = useState([])
  const [capitulosRecientes, setCapitulosRecientes] = useState([])
  const [clasesRecientes, setClasesRecientes] = useState([])
  const [leccionesRecientes, setLeccionesRecientes] = useState([])
  
  // Estados para sesi√≥n de estudio
  const [modalSesionAbierto, setModalSesionAbierto] = useState(false)
  const [modalConfigSesion, setModalConfigSesion] = useState(false)
  const [tiempoSesion, setTiempoSesion] = useState(30) // minutos
  const [tiempoPersonalizado, setTiempoPersonalizado] = useState('') // input personalizado
  const [modoLibreActivo, setModoLibreActivo] = useState(false) // sin l√≠mite de tiempo
  const [prioridadSesion, setPrioridadSesion] = useState('errores') // 'errores', 'flashcards', 'contenido'
  const [sesionActiva, setSesionActiva] = useState(false)
  const [sesionPersistente, setSesionPersistente] = useState(null) // datos de sesi√≥n guardada
  const [estadoGuardado, setEstadoGuardado] = useState(false) // indicador de guardado
  const [sesionPausada, setSesionPausada] = useState(false)
  const [tiempoPausaRestante, setTiempoPausaRestante] = useState(0) // segundos de pausa
  const [tiempoHastaDescanso, setTiempoHastaDescanso] = useState(1500) // 25 minutos seg√∫n Pomodoro (1500 seg)
  const [intervaloDescansoInicial, setIntervaloDescansoInicial] = useState(1500) // Guardar valor inicial para reiniciar
  const [faseActual, setFaseActual] = useState(null) // null, 'calentamiento', 'errores', 'flashcards', 'contenido', 'cierre', 'descanso'
  const [fasesSesion, setFasesSesion] = useState([]) // Array de fases planificadas
  const [indiceFaseActual, setIndiceFaseActual] = useState(0)
  const [tiempoRestante, setTiempoRestante] = useState(0) // segundos
  const [tiempoFaseActual, setTiempoFaseActual] = useState(0)
  const [tiempoTotalEfectivo, setTiempoTotalEfectivo] = useState(0) // tiempo real estudiado
  const [tiempoAcumuladoEstudio, setTiempoAcumuladoEstudio] = useState(0) // tiempo acumulado sin descanso
  const [enDescanso, setEnDescanso] = useState(false)
  const [estadisticasSesion, setEstadisticasSesion] = useState({
    erroresReforzados: 0,
    flashcardsRepasadas: 0,
    practicasHechas: 0,
    notasTomadas: 0
  })
  const [datosCalentamiento, setDatosCalentamiento] = useState(null)
  const [erroresActuales, setErroresActuales] = useState([])
  const [indiceErrorActual, setIndiceErrorActual] = useState(0)
  const [respuestaErrorSeleccionada, setRespuestaErrorSeleccionada] = useState(null) // Para el wizard de errores
  const [errorYaRespondido, setErrorYaRespondido] = useState(false) // Si ya seleccion√≥ una respuesta
  const [respuestaTextual, setRespuestaTextual] = useState('') // Para preguntas de respuesta corta
  const [historialIntentos, setHistorialIntentos] = useState([]) // Historial de intentos para preguntas cortas
  const [evaluandoRespuesta, setEvaluandoRespuesta] = useState(false) // Estado de carga al evaluar
  const [feedbackIA, setFeedbackIA] = useState(null) // Feedback del modelo
  const [flashcardsSesion, setFlashcardsSesion] = useState([])
  const [indiceFlashcardActual, setIndiceFlashcardActual] = useState(0)
  const [contenidoSesion, setContenidoSesion] = useState(null)
  const [notaSesion, setNotaSesion] = useState('')
  const [reflexionSesion, setReflexionSesion] = useState('')
  const [timerMinimizado, setTimerMinimizado] = useState(false)
  const [selectorCursosAbierto, setSelectorCursosAbierto] = useState(false) // panel lateral de cursos
  const [busquedaCursos, setBusquedaCursos] = useState('') // b√∫squeda en el selector de cursos
  const [headerCompacto, setHeaderCompacto] = useState(false) // header en modo compacto
  const [editorInlineActivo, setEditorInlineActivo] = useState(false) // editor de notas inline
  const [fuentePracticaSeleccionada, setFuentePracticaSeleccionada] = useState('documento') // documento, carpeta, curso, pegado, actual
  const [textoPegadoPractica, setTextoPegadoPractica] = useState('') // para generar desde texto pegado
  
  // Estados para Fase 4 - Contenido Nuevo
  const [tabContenidoActivo, setTabContenidoActivo] = useState(0) // 0: Lectura, 1: Notas, 2: Flashcards
  const [notasVinculadas, setNotasVinculadas] = useState([])
  const [cursoActual, setCursoActual] = useState(null)
  const [drawerNotaAbierto, setDrawerNotaAbierto] = useState(false)
  const [notaEnDrawer, setNotaEnDrawer] = useState(null)
  const [sidebarNotasColapsado, setSidebarNotasColapsado] = useState(false)
  const [carpetasContenido, setCarpetasContenido] = useState([])
  const [rutaContenidoActual, setRutaContenidoActual] = useState('')
  const [navegacionHistorial, setNavegacionHistorial] = useState([])
  const [mostrandoSelectorCarpetas, setMostrandoSelectorCarpetas] = useState(false)
  
  // Estados para explorador de calentamiento
  const [carpetasCalentamiento, setCarpetasCalentamiento] = useState([])
  const [rutaCalentamientoActual, setRutaCalentamientoActual] = useState('')
  const [modalNuevaCarpetaCalentamiento, setModalNuevaCarpetaCalentamiento] = useState(false)
  
  const [practicaGenerada, setPracticaGenerada] = useState(null)
  const [generandoPractica, setGenerandoPractica] = useState(false)
  const [tipoPractica, setTipoPractica] = useState('mcq') // mcq, short_answer, open_question
  const [dificultadPractica, setDificultadPractica] = useState('media') // facil, media, dificil
  const [numPreguntasPractica, setNumPreguntasPractica] = useState(3)
  const [preguntaActualPractica, setPreguntaActualPractica] = useState(0)
  const [respuestasPractica, setRespuestasPractica] = useState([])
  const [mostrandoFeedback, setMostrandoFeedback] = useState(false)
  const [resultadoPractica, setResultadoPractica] = useState(null)
  const [historialPracticas, setHistorialPracticas] = useState([])
  const [editorNotaTitulo, setEditorNotaTitulo] = useState('')
  const [editorNotaContenido, setEditorNotaContenido] = useState('')
  const [editorNotaTags, setEditorNotaTags] = useState('')
  const [tipoNotaEditor, setTipoNotaEditor] = useState('normal') // 'normal' | 'linguistica' | 'matematica'
  const [vincularADocumento, setVincularADocumento] = useState(true)
  const [guardandoNota, setGuardandoNota] = useState(false)
  const [modalFlashcardCreator, setModalFlashcardCreator] = useState(false)
  const [textoSeleccionadoFlashcard, setTextoSeleccionadoFlashcard] = useState('')
  const [modoConversionFlashcard, setModoConversionFlashcard] = useState('linea') // linea, parrafo, manual
  const [progresoDocumento, setProgresoDocumento] = useState(0)
  const [scrollPositions, setScrollPositions] = useState({ 0: 0, 1: 0, 2: 0 })
  const [autoSaveTimer, setAutoSaveTimer] = useState(null)
  
  // Estados para men√∫ de comandos estilo Notion
  const [menuComandosAbierto, setMenuComandosAbierto] = useState(false)
  const [posicionMenuComandos, setPosicionMenuComandos] = useState({ top: 0, left: 0 })
  const [comandoSeleccionado, setComandoSeleccionado] = useState(0)
  const [cursorPosition, setCursorPosition] = useState(0)
  
  // Estados para Fase 5 - Cierre/Resumen
  const [resumenSesion, setResumenSesion] = useState(null)
  const [reflexionDificil, setReflexionDificil] = useState('')
  const [reflexionManana, setReflexionManana] = useState('')
  const [recomendacionesSesion, setRecomendacionesSesion] = useState([])
  const [guardandoSesion, setGuardandoSesion] = useState(false)
  const [tiempoInicioSesion, setTiempoInicioSesion] = useState(null)
  const [tiempoFinSesion, setTiempoFinSesion] = useState(null)
  const [tiempoPausaTotal, setTiempoPausaTotal] = useState(0)
  const [timestampInicioPausa, setTimestampInicioPausa] = useState(null)
  const [contadorPausaActualizado, setContadorPausaActualizado] = useState(0) // Para forzar re-render del contador
  
  const [carpetaExamen, setCarpetaExamen] = useState(null)
  const [esPractica, setEsPractica] = useState(false) // üî• Flag para distinguir pr√°cticas de ex√°menes
  const [flashcardsVolteadas, setFlashcardsVolteadas] = useState({}) // üÉè Estado de volteo de flashcards
  const [generandoExamen, setGenerandoExamen] = useState(false)
  const [abortController, setAbortController] = useState(null)
  const [progresoGeneracion, setProgresoGeneracion] = useState(0)
  const [mensajeProgreso, setMensajeProgreso] = useState('')
  const [sessionIdGeneracion, setSessionIdGeneracion] = useState(null)
  const [modalExamenAbierto, setModalExamenAbierto] = useState(false)
  const [configExamen, setConfigExamen] = useState({
    num_multiple: 5,      // Default: 5 preguntas de opci√≥n m√∫ltiple
    num_corta: 3,         // Default: 3 preguntas cortas
    num_desarrollo: 2     // Default: 2 preguntas de desarrollo
  })
  const [examenesGuardados, setExamenesGuardados] = useState({
    completados: [],
    enProgreso: []
  })
  const [viendoExamen, setViendoExamen] = useState(null)
  const [modalListaExamenes, setModalListaExamenes] = useState(false)
  
  // Estados para modal de configuraci√≥n de generaci√≥n de examen
  const [modalConfigExamen, setModalConfigExamen] = useState(false)
  const [carpetaConfigExamen, setCarpetaConfigExamen] = useState(null)
  const [archivosDisponibles, setArchivosDisponibles] = useState([])
  const [archivosSeleccionados, setArchivosSeleccionados] = useState([])
  const [promptPersonalizado, setPromptPersonalizado] = useState('')
  
  // Estados para sistema de Flashcards
  const [flashcardsCarpetas, setFlashcardsCarpetas] = useState([])
  const [flashcardsActuales, setFlashcardsActuales] = useState([])
  const [carpetaFlashcardActual, setCarpetaFlashcardActual] = useState(null)
  const [rutaFlashcardsActual, setRutaFlashcardsActual] = useState('')
  const [filtroTipoFlashcard, setFiltroTipoFlashcard] = useState('todas')
  const [modalNuevaFlashcard, setModalNuevaFlashcard] = useState(false)
  const [flashcardEditando, setFlashcardEditando] = useState(null)
  const [flashcardVistaCompleta, setFlashcardVistaCompleta] = useState(null)
  const [imagenZoom, setImagenZoom] = useState(null) // üîç Imagen para zoom
  const [modalAsistenteLatex, setModalAsistenteLatex] = useState(false) // üß† Modal asistente LaTeX
  const [promptLatex, setPromptLatex] = useState('') // üìù Prompt en lenguaje natural
  const [latexGenerado, setLatexGenerado] = useState('') // ‚ú® LaTeX generado
  const [modoVisual, setModoVisual] = useState('texto') // üé® Modo contextual: texto, matematicas, quimica, fisica, etc.
  const [formDataFlashcard, setFormDataFlashcard] = useState({
    tipo: 'clasica',
    titulo: '',
    contenido: '',
    opciones: [],
    respuestaCorrecta: '',
    explicacion: '',
    tema: '',
    carpeta: '',
    estadoRevision: 'nueva',
    archivos: [],
    imagenes: [],
    latex: false,
    subtema: '',
    lenguaje: 'javascript', // Para tipo Programaci√≥n
    dificultad: 'medio', // Para tipo Programaci√≥n
    patronCodigo: 'comprension', // comprension | bug | cloze | produccion
    // Campos para Qu√≠mica
    subtipoQuimica: 'estructura', // estructura | enlace | funcional | reaccion | mecanismo
    nivelQuimica: 'basico', // basico | intermedio | avanzado
    rama: 'organica', // organica | inorganica | fisicoquimica
    // Campos para F√≠sica
    subtipoFisica: 'ecuacion', // ecuacion | diagrama-fuerzas | campo | proceso | experimento
    nivelFisica: 'basico', // basico | intermedio | avanzado
    ramaFisica: 'mecanica', // mecanica | electromagnetismo | optica | termodinamica | cuantica
    // Campos para Ingenier√≠a
    subtipoIngenieria: 'circuito', // circuito | fbd | viga | material | mecanismo
    nivelIngenieria: 'basico', // basico | intermedio | avanzado
    ramaIngenieria: 'electrica' // electrica | mecanica | materiales | civil
  })

  const [promptSistema, setPromptSistema] = useState('')
  
  // Estados para filtros de historial
  const [filtroTipoHistorial, setFiltroTipoHistorial] = useState('todos')
  const [rangoVistaHistorial, setRangoVistaHistorial] = useState(30)
  
  // Estado para modal de mapa de repetici√≥n espaciada
  const [itemMapaRepeticion, setItemMapaRepeticion] = useState(null)
  
  // Estados para Buscador IA
  const [queryBusqueda, setQueryBusqueda] = useState('')
  const [resultadosBusqueda, setResultadosBusqueda] = useState([])
  const [buscando, setBuscando] = useState(false)
  const [filtroBusquedaTipo, setFiltroBusquedaTipo] = useState('todos')
  const [estadoIndice, setEstadoIndice] = useState(null)
  const [actualizandoIndice, setActualizandoIndice] = useState(false)
  
  const [rutaExploracion, setRutaExploracion] = useState('')
  const [carpetasExploracion, setCarpetasExploracion] = useState([])
  
  // Estados para navegaci√≥n de carpetas de ex√°menes
  const [rutaActualExamenes, setRutaActualExamenes] = useState('')
  const [carpetasExamenes, setCarpetasExamenes] = useState([])
  const [examenesCompletados, setExamenesCompletados] = useState([])
  const [examenesProgreso, setExamenesProgreso] = useState([])
  const [examenesProgresoGlobal, setExamenesProgresoGlobal] = useState([])
  
  // Estados para reconocimiento de voz
  const [reconocimientoVoz, setReconocimientoVoz] = useState(null)
  const [escuchandoPregunta, setEscuchandoPregunta] = useState(null)
  const [transcripcionTemp, setTranscripcionTemp] = useState('')
  
  // Estados para men√∫ m√≥vil
  const [menuMovilAbierto, setMenuMovilAbierto] = useState(false)
  
  // Estados para ajustes avanzados
  const [ajustesAvanzados, setAjustesAvanzados] = useState({
    n_ctx: 4096,
    temperature: 0.7,
    max_tokens: 512,
    top_p: 0.9,
    repeat_penalty: 1.15,
    n_gpu_layers: 35
  })
  const [mostrarAjustesAvanzados, setMostrarAjustesAvanzados] = useState(false)
  
  // Estados para Ollama
  const [modelosOllama, setModelosOllama] = useState([])
  const [pestanaModelos, setPestanaModelos] = useState('ollama') // 'ollama' o 'gguf'

  // Estados para navegaci√≥n en modal de historial
  const [rutaHistorialModal, setRutaHistorialModal] = useState('')
  const [carpetasHistorialModal, setCarpetasHistorialModal] = useState([])
  const [chatsHistorialModal, setChatsHistorialModal] = useState([])
  const [loadingHistorialModal, setLoadingHistorialModal] = useState(false)

  // Estados para el sistema de notas
  const [notasGuardadas, setNotasGuardadas] = useState([])
  const [editorNotaAbierto, setEditorNotaAbierto] = useState(false)
  const [notaActual, setNotaActual] = useState(null)
  const [tituloNota, setTituloNota] = useState('')
  const [contenidoNota, setContenidoNota] = useState('')
  const [carpetaNota, setCarpetaNota] = useState('')
  
  // Estados para explorador de guardado en fase contenido
  const [modalGuardarContenido, setModalGuardarContenido] = useState(false)
  const [tipoGuardado, setTipoGuardado] = useState('txt') // 'txt' o 'nota'
  const [carpetasGuardado, setCarpetasGuardado] = useState([])
  const [rutaGuardadoActual, setRutaGuardadoActual] = useState('')
  const [modalNuevaCarpetaGuardado, setModalNuevaCarpetaGuardado] = useState(false)
  const [modoSoloLectura, setModoSoloLectura] = useState(false)
  const [modalCarpetasNotaAbierto, setModalCarpetasNotaAbierto] = useState(false)
  const [menuContextual, setMenuContextual] = useState({ visible: false, x: 0, y: 0 })
  const [rangoSeleccionado, setRangoSeleccionado] = useState(null)
  const [arrastandoMenu, setArrastandoMenu] = useState({ activo: false, offsetX: 0, offsetY: 0 })
  const [submenuActivo, setSubmenuActivo] = useState(null) // 'tipografias', 'enlaces', null
  const [rutaNotasActual, setRutaNotasActual] = useState('')
  const [carpetasNotas, setCarpetasNotas] = useState([])
  const [modalHipervinculos, setModalHipervinculos] = useState(false)
  const [textoSeleccionado, setTextoSeleccionado] = useState('')
  const [urlHipervinculo, setUrlHipervinculo] = useState('')
  const [tipoHipervinculo, setTipoHipervinculo] = useState('url') // 'url' o 'nota'
  const [notaReferenciaId, setNotaReferenciaId] = useState(null)

  // Estados para navegaci√≥n de carpetas de pr√°cticas
  const [rutaPracticasActual, setRutaPracticasActual] = useState('')
  const [carpetasPracticas, setCarpetasPracticas] = useState([])
  const [modalMoverPractica, setModalMoverPractica] = useState(false)
  const [practicaAMover, setPracticaAMover] = useState(null)
  const [rutaCarpetasChat, setRutaCarpetasChat] = useState('')
  const [practicas, setPracticas] = useState([])

  // üß† M√ìDULO ASISTENTE LaTeX INTELIGENTE
  // Convierte lenguaje natural a LaTeX perfecto (6 niveles)
  const asistenteLaTeX = (promptNatural) => {
    const prompt = promptNatural.toLowerCase().trim();
    
    // NIVEL 1: Expresiones b√°sicas
    if (prompt.match(/elevado a|potencia de|a la/)) {
      const match = prompt.match(/(\d+|[a-z])\s*(?:elevado a|a la)\s*(\d+|[a-z])/i);
      if (match) return `${match[1]}^{${match[2]}}`;
    }
    
    if (prompt.match(/\d+\s*[+\-*/]\s*\d+\s*=\s*\d+/)) {
      return prompt.replace(/\*/g, '\\cdot ').replace(/\//g, '\\div ');
    }
    
    // NIVEL 2: Fracciones y ra√≠ces
    if (prompt.match(/fracci√≥n|dividir|sobre/)) {
      const match = prompt.match(/(?:fracci√≥n\s+(?:de\s+)?)?(.+?)\s+(?:sobre|dividido|entre)\s+(.+)/i);
      if (match) return `\\frac{${match[1].trim()}}{${match[2].trim()}}`;
    }
    
    if (prompt.match(/ra√≠z cuadrada/)) {
      const match = prompt.match(/ra√≠z cuadrada\s+(?:de\s+)?(.+)/i);
      if (match) return `\\sqrt{${match[1].trim()}}`;
    }
    
    if (prompt.match(/ra√≠z\s+(\w+)(?:-√©sima)?/)) {
      const matchN = prompt.match(/ra√≠z\s+(\w+)(?:-√©sima)?\s+(?:de\s+)?(.+)/i);
      if (matchN) return `\\sqrt[${matchN[1]}]{${matchN[2].trim()}}`;
    }
    
    // NIVEL 3: Integrales, sumatorias y l√≠mites
    if (prompt.match(/integral/)) {
      const match = prompt.match(/integral\s+(?:de\s+)?(.+?)\s+(?:a|hasta)\s+(.+?)\s+(?:de\s+)?(.+)/i);
      if (match) {
        return `\\int_{${match[1].trim()}}^{${match[2].trim()}} ${match[3].trim()} \\, dx`;
      }
      const matchSimple = prompt.match(/integral\s+(?:de\s+)?(.+)/i);
      if (matchSimple) return `\\int ${matchSimple[1].trim()} \\, dx`;
    }
    
    if (prompt.match(/sumatoria|suma/)) {
      const match = prompt.match(/(?:sumatoria|suma)\s+(?:de\s+)?(.+?)\s*=\s*(\d+)\s+(?:a|hasta)\s+(.+)/i);
      if (match) return `\\sum_{${match[1].trim()}=${match[2]}}^{${match[3].trim()}}`;
    }
    
    if (prompt.match(/l√≠mite|limite/)) {
      const match = prompt.match(/l√≠mite\s+(?:de\s+)?(.+?)\s*‚Üí\s*(.+?)\s+(?:de\s+)?(.+)/i);
      if (match) return `\\lim_{${match[1].trim()} \\to ${match[2].trim()}} ${match[3].trim()}`;
    }
    
    // NIVEL 4: Matrices y vectores
    if (prompt.match(/matriz\s+(?:de\s+)?(\d+)\s*x\s*(\d+)/)) {
      const match = prompt.match(/matriz\s+(?:de\s+)?(\d+)\s*x\s*(\d+)\s+(?:con\s+)?(.+)/i);
      if (match) {
        const elementos = match[3].split(/[\s,]+/).filter(e => e);
        const filas = parseInt(match[1]);
        const cols = parseInt(match[2]);
        let matriz = '\\begin{pmatrix}\n';
        for (let i = 0; i < filas; i++) {
          matriz += elementos.slice(i * cols, (i + 1) * cols).join(' & ');
          if (i < filas - 1) matriz += ' \\\\\n';
        }
        matriz += '\n\\end{pmatrix}';
        return matriz;
      }
    }
    
    if (prompt.match(/vector columna/)) {
      const match = prompt.match(/vector columna\s+(.+)/i);
      if (match) {
        const elementos = match[1].split(/[\s,]+/).filter(e => e);
        return `\\begin{pmatrix} ${elementos.join(' \\\\\\\\ ')} \\end{pmatrix}`;
      }
    }
    
    // NIVEL 5: √Ålgebra lineal
    if (prompt.match(/producto punto|producto escalar/)) {
      const match = prompt.match(/producto\s+(?:punto|escalar)\s+(?:de\s+)?(.+?)\s+(?:y|con)\s+(.+)/i);
      if (match) return `\\vec{${match[1].trim()}} \\cdot \\vec{${match[2].trim()}}`;
    }
    
    if (prompt.match(/norma/)) {
      const match = prompt.match(/norma\s+(?:de\s+)?(.+)/i);
      if (match) return `\\|${match[1].trim()}\\|`;
    }
    
    if (prompt.match(/transpuesta/)) {
      const match = prompt.match(/transpuesta\s+(?:de\s+)?(.+)/i);
      if (match) return `${match[1].trim()}^T`;
    }
    
    // NIVEL 6: Ecuaciones diferenciales
    if (prompt.match(/derivada|dy\/dx/)) {
      const match = prompt.match(/(?:derivada\s+)?d(.+?)\/d(.+?)\s*=\s*(.+)/i);
      if (match) return `\\frac{d${match[1].trim()}}{d${match[2].trim()}} = ${match[3].trim()}`;
      
      const matchSimple = prompt.match(/derivada\s+(?:de\s+)?(.+)/i);
      if (matchSimple) return `\\frac{d}{dx} ${matchSimple[1].trim()}`;
    }
    
    if (prompt.match(/segunda derivada|derivada segunda/)) {
      const match = prompt.match(/segunda\s+derivada\s+(?:de\s+)?(.+)/i);
      if (match) return `\\frac{d^2}{dx^2} ${match[1].trim()}`;
    }
    
    if (prompt.match(/taylor/)) {
      return `f(x) = \\sum_{n=0}^{\\infty} \\frac{f^{(n)}(a)}{n!}(x-a)^n`;
    }
    
    // Fallback: devolver el texto tal cual (podr√≠a ser LaTeX directo)
    return promptNatural;
  };  // Estados para diagn√≥stico de Ollama
  const [diagnosticoOllama, setDiagnosticoOllama] = useState(null)
  const [reparandoOllama, setReparandoOllama] = useState(false)

  // Estados para sistema de archivos del chatbot
  const [mostrarExploradorChat, setMostrarExploradorChat] = useState(false)
  const [archivosRecientes, setArchivosRecientes] = useState([])
  const [archivosContextoChat, setArchivosContextoChat] = useState([])
  const [rutaExploradorChat, setRutaExploradorChat] = useState('')
  const [carpetasExploradorChat, setCarpetasExploradorChat] = useState([])
  const [tipoExploradorChat, setTipoExploradorChat] = useState('notas') // 'notas', 'examenes', 'practicas', 'cursos'
  const [cargandoArchivos, setCargandoArchivos] = useState(false)

  // Estados para guardar chat/consulta como TXT
  const [modalGuardarTxt, setModalGuardarTxt] = useState(false)
  const [tipoGuardadoTxt, setTipoGuardadoTxt] = useState('chat') // 'chat' o 'consulta'
  const [consultaAGuardar, setConsultaAGuardar] = useState(null)
  const [nombreArchivoTxt, setNombreArchivoTxt] = useState('')
  const [rutaGuardadoTxt, setRutaGuardadoTxt] = useState('')
  const [carpetasCursos, setCarpetasCursos] = useState([])

  // Estados para tipograf√≠as personalizadas
  const [tipografiasPersonalizadas, setTipografiasPersonalizadas] = useState([])
  const [modalTipografias, setModalTipografias] = useState(false)
  const [tipografiaActual, setTipografiaActual] = useState('Arial, sans-serif')

  // Estados para modal de selecci√≥n de nota de referencia
  const [modalSeleccionarNotaRef, setModalSeleccionarNotaRef] = useState(false)
  const [rutaModalNotaRef, setRutaModalNotaRef] = useState('')
  const [carpetasModalNotaRef, setCarpetasModalNotaRef] = useState([])
  const [dropdownNotaAbierto, setDropdownNotaAbierto] = useState(null) // ID de la nota con dropdown abierto

  // Estados para instalador de modelos Ollama
  const [modalInstaladorModelo, setModalInstaladorModelo] = useState(false)
  const [archivoModeloGGUF, setArchivoModeloGGUF] = useState(null)
  const [nombreModeloNuevo, setNombreModeloNuevo] = useState('')
  const [instalandoModelo, setInstalandoModelo] = useState(false)

  // Ref para el editor de notas
  const editorRef = useRef(null)

  // Estados para calendario de repasos (evitar localStorage directo en JSX)
  const [datosCalendarioRepasos, setDatosCalendarioRepasos] = useState({
    flashcards: [],
    notas: [],
    practicas: [],
    examenes: []
  });
  const calendarioCargandoRef = useRef(false);

  // Estados para mini calendario visual
  const [mesCalendario, setMesCalendario] = useState(new Date().getMonth());
  const [anioCalendario, setAnioCalendario] = useState(new Date().getFullYear());
  const [fechaSeleccionada, setFechaSeleccionada] = useState(null);

  // Detectar autom√°ticamente la URL del API
  // Si accedes desde otra IP (m√≥vil/tablet), usa esa IP para el backend
  // Si accedes desde localhost, usa localhost
  const getApiUrl = () => {
    const hostname = window.location.hostname
    const apiUrl = (hostname === 'localhost' || hostname === '127.0.0.1') 
      ? 'http://localhost:8000' 
      : `http://${hostname}:8000`
    
    // Debug: mostrar en consola qu√© URL est√° usando
    console.log(`üåê Frontend: ${window.location.hostname}:${window.location.port}`)
    console.log(`üîå Backend API: ${apiUrl}`)
    
    return apiUrl
  }

  const API_URL = getApiUrl()

  // Auto-ocultar mensajes despu√©s de 8 segundos
  useEffect(() => {
    if (mensaje) {
      const timer = setTimeout(() => {
        setMensaje(null)
      }, 8000)
      
      return () => clearTimeout(timer)
    }
  }, [mensaje])

  // Debug: Loguear cada vez que cambie la configuraci√≥n
  useEffect(() => {
    if (configuracion) {
      console.log('üîÑ Estado de configuraci√≥n actualizado:')
      console.log('   usar_ollama:', configuracion.usar_ollama)
      console.log('   gpu_activa:', configuracion.gpu_activa)
      console.log('   Evaluaci√≥n Ollama GPU:', configuracion?.gpu_activa && configuracion?.usar_ollama)
      console.log('   Evaluaci√≥n Ollama CPU:', !configuracion?.gpu_activa && configuracion?.usar_ollama)
      console.log('   Evaluaci√≥n GGUF CPU:', !configuracion?.usar_ollama)
    }
  }, [configuracion])

  // Recargar ex√°menes cuando se cambia a la pesta√±a "generar"
  useEffect(() => {
    if (selectedMenu === 'generar') {
      cargarCarpetasExamenes()
    }
  }, [selectedMenu])

  // Helper: Verificar si algo fue revisado hoy (control de spaced repetition)
  const fueRevisadoHoy = (fechaUltimaRevision) => {
    if (!fechaUltimaRevision) return false;
    
    const hoy = new Date();
    const ultimaRevision = new Date(fechaUltimaRevision);
    
    // Comparar solo a√±o, mes y d√≠a (ignorar horas)
    return (
      hoy.getFullYear() === ultimaRevision.getFullYear() &&
      hoy.getMonth() === ultimaRevision.getMonth() &&
      hoy.getDate() === ultimaRevision.getDate()
    );
  };

  // Cargar pr√°cticas desde localStorage al iniciar y cuando cambia el men√∫
  useEffect(() => {
    const cargarPracticasIniciales = async () => {
      const practicasGuardadas = await getDatos('practicas');
      if (practicasGuardadas && practicasGuardadas.length > 0) {
        // ‚úÖ CARGAR TODAS LAS PR√ÅCTICAS (sin filtrar)
        // El filtro por carpeta se hace en la UI
        setPracticas(practicasGuardadas);
      }
    };
    cargarPracticasIniciales();
  }, [selectedMenu]);

  // Cargar notas y flashcards al iniciar la aplicaci√≥n
  useEffect(() => {
    const cargarDatosIniciales = async () => {
      try {
        const notas = await getDatos('notas');
        const flashcards = await cargarTodasFlashcards();
        
        if (notas && notas.length > 0) {
          setNotasGuardadas(notas);
        }
        
        if (flashcards && flashcards.length > 0) {
          // Filtrar flashcards: mostrar todas EXCEPTO las ya revisadas hoy
          const flashcardsPendientes = flashcards.filter(fc => {
            // Si fue creada hoy y ya se revis√≥ hoy, no mostrar repetidamente
            if (fueRevisadoHoy(fc.fecha_creacion) && fueRevisadoHoy(fc.ultima_revision)) {
              return false;
            }
            // Si fue creada antes y ya se revis√≥ hoy, no mostrar
            if (!fueRevisadoHoy(fc.fecha_creacion) && fueRevisadoHoy(fc.ultima_revision)) {
              return false;
            }
            // En cualquier otro caso, mostrar
            return true;
          });
          setFlashcardsActuales(flashcardsPendientes);
        }
      } catch (error) {
        console.error('Error cargando datos iniciales:', error);
      }
    };
    cargarDatosIniciales();
  }, []);

  // Cargar datos para el calendario de repasos cuando se entra a historial
  useEffect(() => {
    if (selectedMenu === 'historial') {
      // Prevenir cargas duplicadas simult√°neas
      if (calendarioCargandoRef.current) {
        console.log('‚è≥ Calendario ya est√° cargando, evitando duplicado');
        return;
      }
      
      const cargarDatosCalendario = async () => {
        calendarioCargandoRef.current = true;
        try {
          const flashcards = await cargarTodasFlashcards();
          const notas = await getDatos('notas');
          let practicas = await getDatos('practicas');
          
          // üî• Cargar ex√°menes desde el nuevo sistema de carpetas
          let examenes = [];
          try {
            examenes = await getDatos('examenes');
            console.log('üìÖ Ex√°menes cargados para calendario:', examenes.length);
          } catch (error) {
            console.error('Error cargando ex√°menes para calendario:', error);
            examenes = [];
          }
          
          // Normalizar nombres de campos (snake_case a camelCase)
          practicas = practicas.map(p => ({
            ...p,
            proximaRevision: p.proximaRevision || p.proxima_revision,
            ultimaRevision: p.ultimaRevision || p.ultima_revision,
            fechaCreacion: p.fechaCreacion || p.fecha_creacion || p.fecha
          }));
          
          examenes = examenes.map(e => ({
            ...e,
            proximaRevision: e.proximaRevision || e.proxima_revision,
            ultimaRevision: e.ultimaRevision || e.ultima_revision,
            fechaCreacion: e.fechaCreacion || e.fecha_creacion || e.fecha_completado
          }));
          
          setDatosCalendarioRepasos({
            flashcards,
            notas,
            practicas,
            examenes
          });
        } finally {
          calendarioCargandoRef.current = false;
        }
      };
      cargarDatosCalendario();
    }
  }, [selectedMenu]);

  // Verificar estado de Ollama cuando se abre el chat
  useEffect(() => {
    if (selectedMenu === 'chat') {
      verificarEstadoOllama()
      cargarArchivosRecientes()
    }
  }, [selectedMenu])

  // Cargar carpetas de pr√°cticas al cambiar a esa pesta√±a
  useEffect(() => {
    if (selectedMenu === 'practicas') {
      cargarCarpetasPracticas(rutaPracticasActual)
    }
  }, [selectedMenu])

  // Cargar tipograf√≠as personalizadas desde localStorage
  useEffect(() => {
    const tipografiasGuardadas = localStorage.getItem('tipografiasPersonalizadas');
    if (tipografiasGuardadas) {
      try {
        const tipografias = JSON.parse(tipografiasGuardadas);
        tipografias.forEach(tipografia => {
          // Recrear @font-face para cada tipograf√≠a guardada
          const fontFace = `
            @font-face {
              font-family: '${tipografia.nombre}';
              src: url('${tipografia.data}');
              font-weight: normal;
              font-style: normal;
            }
          `;
          const style = document.createElement('style');
          style.textContent = fontFace;
          style.id = tipografia.id;
          document.head.appendChild(style);
        });
        setTipografiasPersonalizadas(tipografias);
      } catch (error) {
        console.error('Error cargando tipograf√≠as:', error);
      }
    }
  }, []);

  // Auto-cargar configuraci√≥n y modelos cuando se abre la pesta√±a de configuraci√≥n
  useEffect(() => {
    if (selectedMenu === 'configuracion') {
      cargarConfiguracion()
      
      // Cargar modelos de Ollama autom√°ticamente
      fetch(`${API_URL}/api/ollama/modelos`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            setModelosOllama(data.modelos)
            console.log(`‚úÖ ${data.total} modelos de Ollama cargados autom√°ticamente`)
          }
        })
        .catch(err => console.error('Error cargando modelos Ollama:', err))
    }
  }, [selectedMenu])

  // üî• RESTAURAR SESI√ìN AL MONTAR O VOLVER A LA VISTA DE SESI√ìN
  useEffect(() => {
    const verificarSesionGuardada = async () => {
      const estadoGuardado = await cargarEstadoSesion();
      if (estadoGuardado && estadoGuardado.estado?.sesionActiva) {
        console.log('üîÑ Sesi√≥n guardada detectada al montar componente');
        // Solo restaurar si no hay una sesi√≥n activa ya
        if (!sesionActiva) {
          setSesionPersistente(estadoGuardado);
        }
      }
    };
    verificarSesionGuardada();
  }, []); // Solo al montar

  // üî• MANTENER SESI√ìN ACTIVA AL CAMBIAR DE MEN√ö
  useEffect(() => {
    // Si hay una sesi√≥n activa guardada en localStorage y volvemos al men√∫ de sesi√≥n
    if (selectedMenu === 'sesion' && !sesionActiva) {
      const estadoGuardado = cargarEstadoSesion();
      if (estadoGuardado && estadoGuardado.estado?.sesionActiva) {
        console.log('üîÑ Detectada sesi√≥n activa al volver al men√∫, restaurando...');
        // Restaurar sin cambiar el men√∫ (ya estamos en 'sesion')
        try {
          // Restaurar configuraci√≥n
          setTiempoSesion(estadoGuardado.configuracion.tiempoSesion);
          setTiempoPersonalizado(estadoGuardado.configuracion.tiempoPersonalizado || '');
          setModoLibreActivo(estadoGuardado.configuracion.modoLibreActivo || false);
          setPrioridadSesion(estadoGuardado.configuracion.prioridadSesion);
          
          // Restaurar estado de sesi√≥n
          setSesionActiva(estadoGuardado.estado.sesionActiva);
          setSesionPausada(estadoGuardado.estado.sesionPausada);
          setFaseActual(estadoGuardado.estado.faseActual);
          setIndiceFaseActual(estadoGuardado.estado.indiceFaseActual);
          setTiempoRestante(estadoGuardado.estado.tiempoRestante);
          setTiempoFaseActual(estadoGuardado.estado.tiempoFaseActual);
          setTiempoTotalEfectivo(estadoGuardado.estado.tiempoTotalEfectivo);
          setTiempoPausaTotal(estadoGuardado.estado.tiempoPausaTotal || 0);
          setTiempoInicioSesion(estadoGuardado.estado.tiempoInicioSesion);
          setTimestampInicioPausa(estadoGuardado.estado.timestampInicioPausa);
          
          // Restaurar fases
          setFasesSesion(estadoGuardado.fases || []);
          
          // Restaurar estad√≠sticas
          setEstadisticasSesion(estadoGuardado.estadisticas || {
            erroresReforzados: 0,
            flashcardsRepasadas: 0,
            practicasHechas: 0,
            notasTomadas: 0
          });
          
          // Restaurar datos de fases
          if (estadoGuardado.datos) {
            setDatosCalentamiento(estadoGuardado.datos.calentamiento);
            
            if (estadoGuardado.datos.errores) {
              setErroresActuales(estadoGuardado.datos.errores.lista || []);
              setIndiceErrorActual(estadoGuardado.datos.errores.indiceActual || 0);
            }
            
            if (estadoGuardado.datos.flashcards) {
              setFlashcardsSesion(estadoGuardado.datos.flashcards.lista || []);
              setIndiceFlashcardActual(estadoGuardado.datos.flashcards.indiceActual || 0);
            }
            
            if (estadoGuardado.datos.contenido) {
              setTabContenidoActivo(estadoGuardado.datos.contenido.tab || 0);
              setDocumentoActual(estadoGuardado.datos.contenido.documento);
              setCursoActual(estadoGuardado.datos.contenido.curso);
              setNotasVinculadas(estadoGuardado.datos.contenido.notasVinculadas || []);
              setPracticaGenerada(estadoGuardado.datos.contenido.practicaGenerada);
              setHistorialPracticas(estadoGuardado.datos.contenido.historialPracticas || []);
              setProgresoDocumento(estadoGuardado.datos.contenido.progresoDocumento || 0);
              setScrollPositions(estadoGuardado.datos.contenido.scrollPositions || { 0: 0, 1: 0, 2: 0 });
            }
            
            if (estadoGuardado.datos.cierre) {
              setResumenSesion(estadoGuardado.datos.cierre.resumen);
              setReflexionDificil(estadoGuardado.datos.cierre.reflexionDificil || '');
              setReflexionManana(estadoGuardado.datos.cierre.reflexionManana || '');
              setRecomendacionesSesion(estadoGuardado.datos.cierre.recomendaciones || []);
            }
          }
          
          // Restaurar notas en progreso
          if (estadoGuardado.notasEnProgreso) {
            setEditorNotaTitulo(estadoGuardado.notasEnProgreso.titulo || '');
            setEditorNotaContenido(estadoGuardado.notasEnProgreso.contenido || '');
            setEditorNotaTags(estadoGuardado.notasEnProgreso.tags || '');
          }
          
          setSesionPersistente(estadoGuardado);
          console.log('‚úÖ Sesi√≥n restaurada al volver al men√∫');
        } catch (error) {
          console.error('‚ùå Error restaurando sesi√≥n:', error);
        }
      }
    }
  }, [selectedMenu, sesionActiva]);

  // Event listener para clicks en enlaces de referencia a notas
  useEffect(() => {
    const handleNotaClick = async (e) => {
      const link = e.target.closest('a[data-nota-id]');
      if (link) {
        e.preventDefault();
        const notaId = parseInt(link.getAttribute('data-nota-id'));
        const notasActuales = await getDatos('notas');
        const nota = notasActuales.find(n => n.id === notaId);
        if (nota) {
          // Actualizar el estado de notas guardadas primero
          setNotasGuardadas(notasActuales);
          setSelectedMenu('notas');
          // Navegar a la carpeta de la nota
          if (nota.carpeta) {
            setRutaNotasActual(nota.carpeta);
            cargarCarpetasNotas(nota.carpeta);
          } else {
            setRutaNotasActual('');
            cargarCarpetasNotas('');
          }
          // Abrir la nota despu√©s de un breve delay para que cargue la vista
          setTimeout(() => {
            setNotaActual(nota);
            setTituloNota(nota.titulo);
            setContenidoNota(nota.contenido);
            setCarpetaNota(nota.carpeta || '');
            setModoSoloLectura(true);
            setEditorNotaAbierto(true);
          }, 250);
        }
      }
    };
    document.addEventListener('click', handleNotaClick);
    return () => document.removeEventListener('click', handleNotaClick);
  }, []);

  // Cerrar dropdowns de notas al hacer clic fuera
  useEffect(() => {
    const handleClickOutside = (e) => {
      if (!e.target.closest('.dropdown-nota')) {
        setDropdownNotaAbierto(null);
      }
    };
    
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // Actualizar contenido del editor cuando se abre una nota
  useEffect(() => {
    if (editorRef.current && editorNotaAbierto) {
      editorRef.current.innerHTML = contenidoNota;
      // Asegurar direcci√≥n LTR
      editorRef.current.setAttribute('dir', 'ltr');
      editorRef.current.style.direction = 'ltr';
      editorRef.current.style.textAlign = 'left';
      
      // Sistema completo de edici√≥n de im√°genes
      window.imagenSeleccionada = null;
      window.modoEdicion = null; // 'resize', 'move', 'crop'
      window.datosInicio = {};
      
      window.mostrarControlesImagen = function(img) {
        if (modoSoloLectura) return;
        
        // Remover controles anteriores
        document.querySelectorAll('.controles-imagen').forEach(c => c.remove());
        document.querySelectorAll('.imagen-editable.seleccionada').forEach(i => i.classList.remove('seleccionada'));
        
        img.classList.add('seleccionada');
        window.imagenSeleccionada = img;
        
        // Crear controles avanzados con etiquetas visibles
        const controles = document.createElement('div');
        controles.className = 'controles-imagen';
        
        // Crear barra de arrastre para los controles
        const barraArrastre = document.createElement('div');
        barraArrastre.style.cssText = `
          background: rgba(100, 108, 255, 0.3);
          padding: 0.3rem;
          margin-bottom: 0.5rem;
          border-radius: 6px;
          cursor: move;
          text-align: center;
          font-size: 0.7rem;
          color: rgba(255,255,255,0.7);
          user-select: none;
          display: flex;
          justify-content: space-between;
          align-items: center;
        `;
        
        // Contenedor izquierdo (espaciador)
        const espaciadorIzq = document.createElement('span');
        espaciadorIzq.style.opacity = '0';
        espaciadorIzq.textContent = '‚úï';
        
        // Indicador central de arrastre
        const indicadorArrastre = document.createElement('span');
        indicadorArrastre.textContent = '‚ãÆ‚ãÆ‚ãÆ';
        
        // Bot√≥n de cerrar
        const btnCerrar = document.createElement('button');
        btnCerrar.textContent = '‚úï';
        btnCerrar.style.cssText = `
          background: transparent;
          border: none;
          color: rgba(255,255,255,0.8);
          cursor: pointer;
          font-size: 1rem;
          padding: 0 0.3rem;
          line-height: 1;
        `;
        btnCerrar.title = 'Cerrar controles';
        btnCerrar.onclick = (e) => {
          e.stopPropagation();
          controles.remove();
          img.classList.remove('seleccionada');
          window.imagenSeleccionada = null;
        };
        
        barraArrastre.appendChild(espaciadorIzq);
        barraArrastre.appendChild(indicadorArrastre);
        barraArrastre.appendChild(btnCerrar);
        
        let arrastrando = false;
        let offsetX = 0;
        let offsetY = 0;
        
        indicadorArrastre.addEventListener('mousedown', (e) => {
          e.preventDefault();
          arrastrando = true;
          const rect = controles.getBoundingClientRect();
          offsetX = e.clientX - rect.left;
          offsetY = e.clientY - rect.top;
          controles.style.position = 'fixed';
        });
        
        document.addEventListener('mousemove', (e) => {
          if (arrastrando) {
            controles.style.left = (e.clientX - offsetX) + 'px';
            controles.style.top = (e.clientY - offsetY) + 'px';
            controles.style.transform = 'none';
          }
        });
        
        document.addEventListener('mouseup', () => {
          if (arrastrando) {
            arrastrando = false;
          }
        });
        
        controles.appendChild(barraArrastre);
        
        const contenidoControles = document.createElement('div');
        contenidoControles.innerHTML = `
          <div class="control-seccion">
            <div class="control-titulo">Tama√±o</div>
            <div class="control-grupo">
              <button class="control-btn" onclick="window.ajustarImagen('peque√±a')">Peque√±a</button>
              <button class="control-btn" onclick="window.ajustarImagen('mediana')">Mediana</button>
              <button class="control-btn" onclick="window.ajustarImagen('grande')">Grande</button>
              <button class="control-btn" onclick="window.ajustarImagen('completa')">Completa</button>
            </div>
          </div>
          <div class="control-separador"></div>
          <div class="control-seccion">
            <div class="control-titulo">Posici√≥n</div>
            <div class="control-grupo">
              <button class="control-btn" onclick="window.cambiarZIndex('delante')">Al Frente</button>
              <button class="control-btn" onclick="window.cambiarZIndex('detras')">Atr√°s</button>
            </div>
          </div>
          <div class="control-separador"></div>
          <div class="control-seccion">
            <div class="control-titulo">Transparencia</div>
            <div class="control-grupo">
              <button class="control-btn" onclick="window.cambiarOpacidad(-0.2)">‚ûñ</button>
              <button class="control-btn" onclick="window.cambiarOpacidad(0.2)">‚ûï</button>
            </div>
          </div>
          <div class="control-separador"></div>
          <div class="control-grupo">
            <button class="control-btn control-recortar" onclick="window.iniciarRecorte()">‚úÇÔ∏è Recortar</button>
            <button class="control-btn control-eliminar" onclick="window.eliminarImagen()">üóëÔ∏è Eliminar</button>
          </div>
        `;
        
        controles.appendChild(contenidoControles);
        img.parentElement.appendChild(controles);
        
        // Agregar manejadores de redimensionado
        agregarManejadoresResize(img);
      };
      
      function agregarManejadoresResize(img) {
        // Remover manejadores anteriores
        document.querySelectorAll('.resize-handle').forEach(h => h.remove());
        
        const contenedor = img.parentElement;
        const handles = ['nw', 'ne', 'sw', 'se', 'n', 's', 'e', 'w'];
        
        handles.forEach(pos => {
          const handle = document.createElement('div');
          handle.className = `resize-handle resize-${pos}`;
          handle.dataset.position = pos;
          
          handle.addEventListener('mousedown', (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            window.modoEdicion = 'resize';
            window.datosInicio = {
              x: e.clientX,
              y: e.clientY,
              width: img.offsetWidth,
              height: img.offsetHeight,
              position: pos
            };
            
            document.body.style.cursor = getComputedStyle(handle).cursor;
          });
          
          contenedor.appendChild(handle);
        });
      }
      
      // Event listeners para mouse
      const mouseMoveHandler = (e) => {
        if (!window.imagenSeleccionada || !window.modoEdicion) return;
        
        if (window.modoEdicion === 'resize') {
          const deltaX = e.clientX - window.datosInicio.x;
          const deltaY = e.clientY - window.datosInicio.y;
          const pos = window.datosInicio.position;
          
          let newWidth = window.datosInicio.width;
          let newHeight = window.datosInicio.height;
          
          // Calcular nuevo tama√±o seg√∫n la posici√≥n del handle
          if (pos.includes('e')) newWidth = window.datosInicio.width + deltaX;
          if (pos.includes('w')) newWidth = window.datosInicio.width - deltaX;
          if (pos.includes('s')) newHeight = window.datosInicio.height + deltaY;
          if (pos.includes('n')) newHeight = window.datosInicio.height - deltaY;
          
          // Mantener proporci√≥n si es esquina
          if (pos.length === 2) {
            const ratio = window.datosInicio.width / window.datosInicio.height;
            newHeight = newWidth / ratio;
          }
          
          // L√≠mites m√≠nimos
          newWidth = Math.max(50, Math.min(1200, newWidth));
          newHeight = Math.max(50, Math.min(1200, newHeight));
          
          window.imagenSeleccionada.style.width = newWidth + 'px';
          window.imagenSeleccionada.style.height = newHeight + 'px';
        }
        
        if (window.modoEdicion === 'move') {
          const deltaX = e.clientX - window.datosInicio.x;
          const deltaY = e.clientY - window.datosInicio.y;
          
          window.imagenSeleccionada.parentElement.style.left = (window.datosInicio.left + deltaX) + 'px';
          window.imagenSeleccionada.parentElement.style.top = (window.datosInicio.top + deltaY) + 'px';
        }
      };
      
      const mouseUpHandler = () => {
        window.modoEdicion = null;
        document.body.style.cursor = 'default';
      };
      
      document.addEventListener('mousemove', mouseMoveHandler);
      document.addEventListener('mouseup', mouseUpHandler);
      
      // Funciones globales
      window.ajustarImagen = function(tama√±o) {
        if (!window.imagenSeleccionada) return;
        const anchos = { peque√±a: 200, mediana: 400, grande: 600, completa: '100%' };
        window.imagenSeleccionada.style.width = typeof anchos[tama√±o] === 'number' ? anchos[tama√±o] + 'px' : anchos[tama√±o];
        window.imagenSeleccionada.style.height = 'auto';
      };
      
      window.cambiarZIndex = function(direccion) {
        if (!window.imagenSeleccionada) return;
        const contenedor = window.imagenSeleccionada.parentElement;
        contenedor.style.position = 'relative';
        contenedor.style.zIndex = direccion === 'delante' ? '100' : '-1';
      };
      
      window.cambiarOpacidad = function(delta) {
        if (!window.imagenSeleccionada) return;
        const opacidadActual = parseFloat(window.imagenSeleccionada.style.opacity || '1');
        const nuevaOpacidad = Math.max(0.1, Math.min(1, opacidadActual + delta));
        window.imagenSeleccionada.style.opacity = nuevaOpacidad;
      };
      
      window.iniciarRecorte = function() {
        if (!window.imagenSeleccionada) return;
        
        const porcentaje = prompt('¬øQu√© porcentaje deseas recortar de cada lado?\nEjemplo: 10 (recorta 10% de cada lado)\n0-50:', '10');
        
        if (porcentaje === null) return;
        
        const pct = Math.max(0, Math.min(50, parseFloat(porcentaje) || 10));
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const img = window.imagenSeleccionada;
        
        // Crear imagen temporal para cargar
        const tempImg = new Image();
        tempImg.onload = function() {
          const cropPct = pct / 100;
          const cropX = tempImg.width * cropPct;
          const cropY = tempImg.height * cropPct;
          const cropWidth = tempImg.width * (1 - cropPct * 2);
          const cropHeight = tempImg.height * (1 - cropPct * 2);
          
          canvas.width = cropWidth;
          canvas.height = cropHeight;
          
          ctx.drawImage(tempImg, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
          
          img.src = canvas.toDataURL();
          img.style.width = 'auto';
          img.style.height = 'auto';
          
          alert('‚úÇÔ∏è Imagen recortada exitosamente');
        };
        tempImg.src = img.src;
      };
      
      
      window.eliminarImagen = function() {
        if (!window.imagenSeleccionada || !confirm('¬øEliminar esta imagen?')) return;
        window.imagenSeleccionada.parentElement.remove();
        window.imagenSeleccionada = null;
      };
      
      // Click fuera para deseleccionar
      const clickHandler = (e) => {
        if (!e.target.closest('.imagen-contenedor') && !e.target.closest('.controles-imagen')) {
          document.querySelectorAll('.controles-imagen').forEach(c => c.remove());
          document.querySelectorAll('.resize-handle').forEach(h => h.remove());
          document.querySelectorAll('.imagen-editable.seleccionada').forEach(i => i.classList.remove('seleccionada'));
          window.imagenSeleccionada = null;
        }
      };
      
      document.addEventListener('click', clickHandler);
      
      return () => {
        document.removeEventListener('click', clickHandler);
        document.removeEventListener('mousemove', mouseMoveHandler);
        document.removeEventListener('mouseup', mouseUpHandler);
      };
    }
  }, [editorNotaAbierto, modoSoloLectura])

  // Cargar prompt del sistema al inicio (solo una vez)
  useEffect(() => {
    const cargarPromptInicial = async () => {
      try {
        console.log('üîÑ Cargando prompt del sistema...')
        const promptResp = await fetch(`${API_URL}/api/prompt-personalizado`)
        const promptData = await promptResp.json()
        
        if (promptData.prompt) {
          // Hay un prompt guardado, usarlo
          console.log('‚úÖ Prompt guardado cargado')
          setPromptSistema(promptData.prompt)
        } else {
          // No hay prompt guardado, cargar el template
          console.log('üìù Cargando template predeterminado...')
          const templateResp = await fetch(`${API_URL}/api/prompt-template`)
          const templateData = await templateResp.json()
          setPromptSistema(templateData.template)
          console.log('‚úÖ Template cargado')
        }
      } catch (error) {
        console.error('‚ùå Error cargando prompt inicial:', error)
        // Si hay error, cargar un prompt por defecto simple
        setPromptSistema('Eres un profesor universitario experto. Crea preguntas basadas en:\n{contenido}\n\nGenera {total_preguntas} preguntas en formato JSON.')
      }
    }
    
    cargarPromptInicial()
  }, [])  // Solo se ejecuta una vez al montar el componente

  // Cargar configuraci√≥n del modelo al inicio
  useEffect(() => {
    cargarConfiguracion()
  }, [])  // Solo una vez al montar
  
  // Cargar carpetas de ex√°menes (estructura paralela)
  const cargarCarpetasExamenes = async (ruta = '') => {
    setLoading(true)
    try {
      const response = await fetch(`${API_URL}/api/examenes/carpetas?ruta=${encodeURIComponent(ruta)}`)
      const data = await response.json()
      
      setCarpetasExamenes(data.carpetas || [])
      setExamenesCompletados(data.examenes_completados || [])
      setExamenesProgreso(data.examenes_progreso || [])
      setExamenesProgresoGlobal(data.examenes_progreso_global || [])
      setRutaActualExamenes(ruta)
      
      console.log('Carpetas ex√°menes:', data.carpetas)
      console.log('Ex√°menes en progreso (carpeta actual):', data.examenes_progreso)
      console.log('Ex√°menes en progreso (global):', data.examenes_progreso_global)
    } catch (error) {
      console.error('Error cargando ex√°menes:', error)
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al cargar ex√°menes'
      })
    } finally {
      setLoading(false)
    }
  }

  // Cargar contenido de carpeta
  const cargarCarpeta = async (ruta = '') => {
    setLoading(true)
    try {
      const response = await fetch(`${API_URL}/api/carpetas?ruta=${encodeURIComponent(ruta)}`)
      const data = await response.json()
      setCarpetas(data.carpetas || [])
      setDocumentos(data.documentos || [])
      setRutaActual(ruta)
    } catch (error) {
      console.error('Error al cargar carpeta:', error)
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al cargar carpeta: ${error.message}`
      })
    } finally {
      setLoading(false)
    }
  }

  // Crear carpeta
  const crearCarpeta = async () => {
    const nombre = prompt('Nombre de la nueva carpeta:')
    if (!nombre) return

    try {
      const response = await fetch(`${API_URL}/api/carpetas`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          ruta_padre: rutaActual, 
          nombre: nombre 
        })
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Carpeta "${nombre}" creada exitosamente`
        })
        cargarCarpeta(rutaActual)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al crear carpeta: ${error.message}`
      })
    }
  }

  // Eliminar carpeta
  const eliminarCarpeta = async (ruta, nombre) => {
    const confirmMsg = `¬øEliminar la carpeta "${nombre}"?\n\nSi tiene contenido, se eliminar√° TODO (carpetas y documentos dentro).`
    if (!confirm(confirmMsg)) return

    try {
      const response = await fetch(`${API_URL}/api/carpetas?ruta=${encodeURIComponent(ruta)}&forzar=true`, {
        method: 'DELETE'
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: '‚úÖ Carpeta eliminada'
        })
        cargarCarpeta(rutaActual)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå ${error.message}`
      })
    }
  }

  // ========== SISTEMA DE MARCADO DE CARPETAS Y GENERACI√ìN MASIVA ==========
  
  // Cargar carpetas marcadas desde localStorage
  useEffect(() => {
    const marcadas = localStorage.getItem('carpetasMarcadas');
    if (marcadas) {
      setCarpetasMarcadas(JSON.parse(marcadas));
    }
  }, []);
  
  // Cargar cursos recientes cuando cambien las carpetas marcadas
  useEffect(() => {
    cargarCursosRecientes();
  }, [carpetasMarcadas]);
  
  // Marcar carpeta con un tipo espec√≠fico
  const marcarCarpeta = (ruta, tipo) => {
    const nuevasMarcadas = {
      ...carpetasMarcadas,
      [ruta]: {
        tipo,
        fecha: new Date().toISOString()
      }
    };
    setCarpetasMarcadas(nuevasMarcadas);
    localStorage.setItem('carpetasMarcadas', JSON.stringify(nuevasMarcadas));
    setMensaje({
      tipo: 'success',
      texto: `‚úÖ Carpeta marcada como ${tipo.toUpperCase()}`
    });
    // Actualizar carpetas recientes seg√∫n el tipo
    cargarCarpetasRecientesPorTipo(tipo);
  };
  
  // Cargar carpetas recientes seg√∫n tipo
  const cargarCarpetasRecientesPorTipo = async (tipo) => {
    try {
      // Filtrar carpetas por tipo
      const carpetasFiltradas = Object.entries(carpetasMarcadas)
        .filter(([ruta, info]) => info.tipo === tipo)
        .sort((a, b) => new Date(b[1].fecha) - new Date(a[1].fecha))
        .slice(0, 5);
      
      // Obtener informaci√≥n detallada de cada carpeta
      const carpetasConInfo = await Promise.all(
        carpetasFiltradas.map(async ([ruta, info]) => {
          try {
            const response = await fetch(`${API_URL}/api/carpetas/info?ruta=${encodeURIComponent(ruta)}`);
            const data = await response.json();
            return {
              ruta,
              nombre: ruta.split('\\').pop() || tipo.charAt(0).toUpperCase() + tipo.slice(1),
              num_documentos: data.num_documentos || 0,
              num_subcarpetas: data.num_subcarpetas || 0,
              fecha: info.fecha
            };
          } catch (error) {
            console.error(`Error cargando info de ${ruta}:`, error);
            return {
              ruta,
              nombre: ruta.split('\\').pop() || tipo.charAt(0).toUpperCase() + tipo.slice(1),
              num_documentos: 0,
              num_subcarpetas: 0,
              fecha: info.fecha
            };
          }
        })
      );
      
      // Actualizar el estado correspondiente
      switch(tipo) {
        case 'curso':
          setCursosRecientes(carpetasConInfo);
          break;
        case 'capitulo':
          setCapitulosRecientes(carpetasConInfo);
          break;
        case 'clase':
          setClasesRecientes(carpetasConInfo);
          break;
        case 'leccion':
          setLeccionesRecientes(carpetasConInfo);
          break;
      }
    } catch (error) {
      console.error(`Error cargando ${tipo}s recientes:`, error);
    }
  };
  
  // Obtener √∫ltimos 5 de cada tipo
  const cargarCursosRecientes = async () => {
    await cargarCarpetasRecientesPorTipo('curso');
    await cargarCarpetasRecientesPorTipo('capitulo');
    await cargarCarpetasRecientesPorTipo('clase');
    await cargarCarpetasRecientesPorTipo('leccion');
  };
  
  // ========== FUNCIONES PARA SESI√ìN DE ESTUDIO ==========
  
  // Calcular tiempo de descanso √≥ptimo seg√∫n la ciencia
  const calcularTiempoDescanso = (tiempoTotalMinutos) => {
    // Basado en estudios de neurociencia y t√©cnica Pomodoro
    
    if (tiempoTotalMinutos <= 0 || !isFinite(tiempoTotalMinutos)) {
      // Modo infinito: usar m√°ximo recomendado (90 min = l√≠mite de atenci√≥n)
      return 5400; // 90 minutos en segundos
    }
    
    if (tiempoTotalMinutos <= 25) {
      // Sesi√≥n corta (‚â§25 min): 1 descanso al final
      return tiempoTotalMinutos * 60; // Todo el tiempo sin interrupciones
    } else if (tiempoTotalMinutos <= 50) {
      // Sesi√≥n media (26-50 min): Pomodoro est√°ndar - descanso a los 25 min
      return 1500; // 25 minutos
    } else if (tiempoTotalMinutos <= 90) {
      // Sesi√≥n larga (51-90 min): Ultradian rhythm - descanso cada 30-35 min
      return 1800; // 30 minutos
    } else if (tiempoTotalMinutos <= 120) {
      // Sesi√≥n muy larga (91-120 min): descanso cada 40 min
      return 2400; // 40 minutos
    } else {
      // Sesi√≥n extensa (>120 min): descanso cada 50 min (m√°ximo recomendado)
      return 3000; // 50 minutos
    }
  };
  
  const iniciarSesion = () => {
    const tiempoEnSegundos = tiempoSesion * 60;
    const tiempoDescansoOptimo = calcularTiempoDescanso(tiempoSesion);
    
    setTiempoRestante(tiempoEnSegundos);
    setTiempoFaseActual(tiempoEnSegundos / 3); // Dividir en 3 fases
    setFaseActual('repaso');
    setSesionActiva(true);
    setTiempoHastaDescanso(tiempoDescansoOptimo); // Calcular seg√∫n tiempo total
    setIntervaloDescansoInicial(tiempoDescansoOptimo); // Guardar para reiniciar
    setModalSesionAbierto(false);
  };
  
  const detenerSesion = async () => {
    console.log('‚èπÔ∏è Deteniendo sesi√≥n...');
    
    // üî• CR√çTICO: Detener PRIMERO sesionActiva para que los useEffect dejen de ejecutarse
    setSesionActiva(false);
    
    // Peque√±a espera para que React procese el cambio de estado
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // 1Ô∏è‚É£ Cambiar men√∫ para ocultar indicadores visuales
    setSelectedMenu('inicio');
    
    // 2Ô∏è‚É£ Limpiar estado de sesi√≥n completo
    setTiempoRestante(0);
    setFaseActual(null);
    setIndiceFaseActual(0);
    setSesionPausada(false);
    setTiempoHastaDescanso(1500); // Resetear contador de descanso
    setEnDescanso(false);
    setTimestampInicioPausa(null);
    setTiempoFaseActual(0);
    setTiempoTotalEfectivo(0);
    setTiempoAcumuladoEstudio(0);
    setTiempoPausaRestante(0);
    
    // 3Ô∏è‚É£ Limpiar estad√≠sticas
    setEstadisticasSesion({
      erroresReforzados: 0,
      flashcardsRepasadas: 0,
      practicasHechas: 0,
      notasTomadas: 0
    });
    
    // 4Ô∏è‚É£ Limpiar datos de fases
    setErroresActuales([]);
    setFlashcardsSesion([]);
    setDocumentoActual(null);
    setCursoActual(null);
    setNotasVinculadas([]);
    setFasesSesion([]);
    setIndiceErrorActual(0);
    setIndiceFlashcardActual(0);
    
    // 5Ô∏è‚É£ ELIMINAR SESI√ìN GUARDADA DEL BACKEND Y LOCALSTORAGE
    try {
      // Eliminar del backend
      const response = await fetch(`${API_URL}/sesion`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        console.log('‚úÖ Sesi√≥n eliminada del backend');
      }
      
      // Eliminar de localStorage
      localStorage.removeItem('examinator_sesion_activa');
      setSesionPersistente(null);
      
      console.log('‚úÖ Sesi√≥n detenida y eliminada completamente');
    } catch (error) {
      console.error('‚ùå Error eliminando sesi√≥n al detener:', error);
      // Aunque falle el backend, limpiamos localStorage
      localStorage.removeItem('examinator_sesion_activa');
      setSesionPersistente(null);
    }
  };
  
  const obtenerNombreFase = (fase) => {
    const fases = {
      'repaso': 'Repaso de Flashcards üìö',
      'practica': 'Pr√°ctica Activa ‚úçÔ∏è',
      'examen': 'Evaluaci√≥n Final üéØ',
      'descanso': 'Descanso üßò'
    };
    return fases[fase] || fase;
  };
  
  const obtenerSiguienteFase = (faseActual) => {
    const fases = {
      'repaso': 'Pr√°ctica Activa',
      'practica': 'Evaluaci√≥n Final',
      'examen': 'Sesi√≥n Completa'
    };
    return fases[faseActual] || '';
  };
  
  // Timer de la sesi√≥n con descansos autom√°ticos basados en ciencia
  useEffect(() => {
    let intervalo;
    
    // üî• CR√çTICO: Solo ejecutar si sesionActiva es true
    if (!sesionActiva) {
      // Si la sesi√≥n no est√° activa, limpiar cualquier intervalo
      if (intervalo) clearInterval(intervalo);
      return;
    }
    
    if (sesionActiva && !sesionPausada && tiempoRestante > 0) {
      intervalo = setInterval(() => {
        setTiempoRestante(prev => {
          if (prev <= 1) {
            // Si estamos en descanso, volver al estudio
            if (enDescanso) {
              setEnDescanso(false);
              setFaseActual(fasesSesion[indiceFaseActual]?.tipo || 'calentamiento');
              const tiempoFase = fasesSesion[indiceFaseActual]?.duracion || 1500; // 25 min por defecto
              setTiempoRestante(tiempoFase);
              setTiempoFaseActual(tiempoFase);
              return tiempoFase;
            }
            
            // Tiempo de fase terminado, avanzar autom√°ticamente
            avanzarFase();
            return 0;
          }
          return prev - 1;
        });
        
        // Solo incrementar tiempo efectivo si no estamos en descanso
        if (!enDescanso) {
          setTiempoTotalEfectivo(prev => prev + 1);
          setTiempoAcumuladoEstudio(prev => {
            const nuevoTiempo = prev + 1;
            
            // T√©cnica Pomodoro basada en ciencia:
            // - Cada 25 minutos (1500 seg) ‚Üí 5 min descanso
            // - Cada 2 horas (7200 seg) ‚Üí 15-20 min descanso
            
            if (nuevoTiempo >= 7200) { // 2 horas
              // Descanso largo (15 min)
              iniciarDescanso(900);
              return 0;
            } else if (nuevoTiempo >= 1500) { // 25 minutos
              // Descanso corto (5 min)
              iniciarDescanso(300);
              return 0;
            }
            
            return nuevoTiempo;
          });
        }
      }, 1000);
    }
    
    // üî• CLEANUP: Siempre limpiar el intervalo al desmontar o cuando cambien las dependencias
    return () => {
      if (intervalo) {
        clearInterval(intervalo);
        console.log('‚èπÔ∏è Timer principal detenido');
      }
    };
  }, [sesionActiva, sesionPausada, tiempoRestante, indiceFaseActual, enDescanso]);
  
  // Contador de tiempo de pausa (cuenta regresiva)
  useEffect(() => {
    let intervaloPausa;
    
    // üî• CR√çTICO: Solo ejecutar si sesionActiva es true
    if (!sesionActiva) {
      if (intervaloPausa) clearInterval(intervaloPausa);
      return;
    }
    
    if (sesionPausada && tiempoPausaRestante > 0) {
      intervaloPausa = setInterval(() => {
        setTiempoPausaRestante(prev => {
          if (prev <= 1) {
            // Pausa terminada, reanudar autom√°ticamente
            setSesionPausada(false);
            setMensaje({ tipo: 'info', texto: '‚è∞ Pausa terminada. ¬°Continuemos!' });
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }
    
    return () => {
      if (intervaloPausa) {
        clearInterval(intervaloPausa);
        console.log('‚èπÔ∏è Contador de pausa detenido');
      }
    };
  }, [sesionActiva, sesionPausada, tiempoPausaRestante]);
  
  // Contador hasta el pr√≥ximo descanso (independiente del timer principal)
  useEffect(() => {
    let intervaloDescanso;
    
    // üî• CR√çTICO: Solo ejecutar si sesionActiva es true
    if (!sesionActiva) {
      if (intervaloDescanso) clearInterval(intervaloDescanso);
      return;
    }
    
    if (sesionActiva && !sesionPausada && !enDescanso && tiempoHastaDescanso > 0) {
      intervaloDescanso = setInterval(() => {
        setTiempoHastaDescanso(prev => {
          if (prev <= 1) {
            // Tiempo de descanso alcanzado - AUTO-PAUSA
            setSesionPausada(true);
            setTiempoPausaRestante(300); // 5 minutos de pausa
            setMensaje({ 
              tipo: 'warning', 
              texto: '‚è∏Ô∏è ¬°Tiempo de descanso! Lev√°ntate, est√≠rate, ve al ba√±o. Pausa de 5 minutos.' 
            });
            // Reiniciar contador usando el valor inicial calculado
            return intervaloDescansoInicial;
          }
          return prev - 1;
        });
      }, 1000);
    }
    
    return () => {
      if (intervaloDescanso) {
        clearInterval(intervaloDescanso);
        console.log('‚èπÔ∏è Contador de descanso detenido');
      }
    };
  }, [sesionActiva, sesionPausada, enDescanso, tiempoHastaDescanso]);

  // Sincronizar estado de la sesi√≥n con el backend cada 5 segundos (para red)
  useEffect(() => {
    let intervaloSincronizacion;
    
    // üî• CR√çTICO: Solo sincronizar si sesionActiva es true
    if (!sesionActiva) {
      if (intervaloSincronizacion) clearInterval(intervaloSincronizacion);
      return;
    }
    
    if (sesionActiva) {
      intervaloSincronizacion = setInterval(async () => {
        try {
          // Guardar estado ligero para sincronizaci√≥n en red
          const estadoSincronizado = {
            timer: tiempoRestante,
            fase: faseActual,
            pausada: sesionPausada,
            timestamp: Date.now()
          };
          await setSesionActiva(estadoSincronizado);
        } catch (error) {
          console.error('Error sincronizando timer:', error);
        }
      }, 5000); // Cada 5 segundos
    }
    
    // üî• CLEANUP: Siempre limpiar el intervalo
    return () => {
      if (intervaloSincronizacion) {
        clearInterval(intervaloSincronizacion);
        console.log('‚èπÔ∏è Sincronizaci√≥n detenida');
      }
    };
  }, [sesionActiva, tiempoRestante, faseActual, sesionPausada]);
  
  const iniciarDescanso = (duracion) => {
    setEnDescanso(true);
    setFaseActual('descanso');
    setTiempoRestante(duracion);
    setTiempoFaseActual(duracion);
    
    // Notificar al usuario
    setMensaje({
      tipo: 'info',
      texto: `üßò Momento de descansar ${duracion === 900 ? '15' : '5'} minutos seg√∫n la ciencia del aprendizaje`
    });
  };
  
  // ============================================
  // üéØ FUNCIONES DEL MODO SESI√ìN DE ESTUDIO
  // ============================================
  
  const abrirConfiguracionSesion = () => {
    setModalConfigSesion(true);
  };
  
  const iniciarSesionEstudio = async () => {
    // Limpiar cualquier sesi√≥n persistente anterior antes de iniciar nueva
    await eliminarSesionGuardada();
    
    // Calcular tiempo de descanso √≥ptimo seg√∫n el tiempo de sesi√≥n
    const tiempoDescansoOptimo = modoLibreActivo 
      ? 5400 // Modo libre: 90 min (l√≠mite m√°ximo de atenci√≥n)
      : calcularTiempoDescanso(tiempoSesion);
    
    // Si es modo libre, configurar fases sin l√≠mite de tiempo
    let fases;
    
    if (modoLibreActivo) {
      // Modo libre: todas las fases disponibles, sin tiempo l√≠mite
      fases = [
        { tipo: 'calentamiento', nombre: 'Calentamiento', duracion: Infinity, emoji: 'üî•' },
        { tipo: 'errores', nombre: 'Refuerzo de Errores', duracion: Infinity, emoji: 'üéØ' },
        { tipo: 'flashcards', nombre: 'Flashcards', duracion: Infinity, emoji: 'üÉè' },
        { tipo: 'contenido', nombre: 'Estudio Nuevo', duracion: Infinity, emoji: 'üìö' },
        { tipo: 'cierre', nombre: 'Cierre', duracion: Infinity, emoji: '‚úÖ' }
      ];
    } else {
      // Modo con tiempo: calcular distribuci√≥n seg√∫n prioridad
      fases = calcularFasesSesion(tiempoSesion, prioridadSesion);
    }
    
    setFasesSesion(fases);
    setIndiceFaseActual(0);
    setFaseActual(fases[0]?.tipo || 'calentamiento');
    setTiempoRestante(fases[0]?.duracion || 0);
    setTiempoFaseActual(fases[0]?.duracion || 0);
    setTiempoTotalEfectivo(0);
    setSesionActiva(true);
    setSesionPausada(false);
    setTiempoHastaDescanso(tiempoDescansoOptimo); // Usar tiempo calculado seg√∫n sesi√≥n
    setIntervaloDescansoInicial(tiempoDescansoOptimo); // Guardar para reiniciar
    setModalConfigSesion(false);
    setModalSesionAbierto(false);
    setEstadisticasSesion({
      erroresReforzados: 0,
      flashcardsRepasadas: 0,
      practicasHechas: 0,
      notasTomadas: 0
    });
    
    // Cargar datos para cada fase
    await cargarDatosSesion();
    
    // Cargar carpetas para fase de calentamiento
    await cargarCarpetasCalentamiento('');
    
    // Cambiar a la vista de sesi√≥n
    setSelectedMenu('sesion');
    
    // Guardar estado inicial
    setTimeout(() => guardarEstadoSesion(), 1000);
  };
  
  const calcularFasesSesion = (minutos, prioridad) => {
    const segundos = minutos * 60;
    const fases = [];
    
    if (minutos <= 15) {
      // Sesi√≥n corta (15 min)
      fases.push(
        { tipo: 'calentamiento', nombre: 'Calentamiento', duracion: Math.floor(segundos * 0.15), emoji: 'üî•' },
        prioridad === 'errores' 
          ? { tipo: 'errores', nombre: 'Refuerzo de Errores', duracion: Math.floor(segundos * 0.70), emoji: 'üéØ' }
          : prioridad === 'flashcards'
          ? { tipo: 'flashcards', nombre: 'Flashcards', duracion: Math.floor(segundos * 0.70), emoji: 'üÉè' }
          : { tipo: 'contenido', nombre: 'Estudio Nuevo', duracion: Math.floor(segundos * 0.70), emoji: 'üìö' },
        { tipo: 'cierre', nombre: 'Cierre', duracion: Math.floor(segundos * 0.15), emoji: '‚úÖ' }
      );
    } else if (minutos <= 30) {
      // Sesi√≥n media (30 min)
      fases.push(
        { tipo: 'calentamiento', nombre: 'Calentamiento', duracion: Math.floor(segundos * 0.10), emoji: 'üî•' }
      );
      
      if (prioridad === 'errores') {
        fases.push(
          { tipo: 'errores', nombre: 'Refuerzo de Errores', duracion: Math.floor(segundos * 0.50), emoji: 'üéØ' },
          { tipo: 'flashcards', nombre: 'Flashcards', duracion: Math.floor(segundos * 0.30), emoji: 'üÉè' }
        );
      } else if (prioridad === 'flashcards') {
        fases.push(
          { tipo: 'flashcards', nombre: 'Flashcards', duracion: Math.floor(segundos * 0.50), emoji: 'üÉè' },
          { tipo: 'errores', nombre: 'Refuerzo de Errores', duracion: Math.floor(segundos * 0.30), emoji: 'üéØ' }
        );
      } else {
        fases.push(
          { tipo: 'contenido', nombre: 'Estudio Nuevo', duracion: Math.floor(segundos * 0.50), emoji: 'üìö' },
          { tipo: 'flashcards', nombre: 'Flashcards', duracion: Math.floor(segundos * 0.30), emoji: 'üÉè' }
        );
      }
      
      fases.push({ tipo: 'cierre', nombre: 'Cierre', duracion: Math.floor(segundos * 0.10), emoji: '‚úÖ' });
    } else {
      // Sesi√≥n larga (45-60 min)
      fases.push(
        { tipo: 'calentamiento', nombre: 'Calentamiento', duracion: Math.floor(segundos * 0.08), emoji: 'üî•' }
      );
      
      if (prioridad === 'errores') {
        fases.push(
          { tipo: 'errores', nombre: 'Refuerzo de Errores', duracion: Math.floor(segundos * 0.35), emoji: 'üéØ' },
          { tipo: 'flashcards', nombre: 'Flashcards', duracion: Math.floor(segundos * 0.25), emoji: 'üÉè' },
          { tipo: 'contenido', nombre: 'Estudio Nuevo', duracion: Math.floor(segundos * 0.25), emoji: 'üìö' }
        );
      } else if (prioridad === 'flashcards') {
        fases.push(
          { tipo: 'flashcards', nombre: 'Flashcards', duracion: Math.floor(segundos * 0.35), emoji: 'üÉè' },
          { tipo: 'errores', nombre: 'Refuerzo de Errores', duracion: Math.floor(segundos * 0.25), emoji: 'üéØ' },
          { tipo: 'contenido', nombre: 'Estudio Nuevo', duracion: Math.floor(segundos * 0.25), emoji: 'üìö' }
        );
      } else {
        fases.push(
          { tipo: 'contenido', nombre: 'Estudio Nuevo', duracion: Math.floor(segundos * 0.35), emoji: 'üìö' },
          { tipo: 'flashcards', nombre: 'Flashcards', duracion: Math.floor(segundos * 0.25), emoji: 'üÉè' },
          { tipo: 'errores', nombre: 'Refuerzo de Errores', duracion: Math.floor(segundos * 0.25), emoji: 'üéØ' }
        );
      }
      
      fases.push({ tipo: 'cierre', nombre: 'Cierre y Resumen', duracion: Math.floor(segundos * 0.07), emoji: '‚úÖ' });
    }
    
    return fases;
  };
  
  const cargarDatosSesion = async () => {
    try {
      // Cargar datos de calentamiento (√∫ltimos ex√°menes y flashcards)
      const responseExamenes = await fetch(`${API_URL}/api/examenes/listar`);
      const dataExamenes = await responseExamenes.json();
      
      setDatosCalentamiento({
        ultimosExamenes: dataExamenes.completados?.slice(0, 5) || [],
        carpetaActual: rutaActual
      });
      
      // Cargar errores (preguntas con bajo rendimiento)
      const errores = extraerErroresDeExamenes(dataExamenes.completados || []);
      setErroresActuales(errores);
      setIndiceErrorActual(0);
      
      // Cargar flashcards desde archivo
      const cargarFlashcardsAsync = async () => {
        try {
          const todasFlashcards = await cargarTodasFlashcards();
          
          // Filtrar flashcards que necesitan repaso (seg√∫n repetici√≥n espaciada)
          const flashcardsParaRepasar = filtrarItemsParaRepasar(todasFlashcards);
          
          // Filtrar por carpeta actual si existe
          const flashcardsFiltradas = rutaActual 
            ? flashcardsParaRepasar.filter(f => f.carpeta === rutaActual)
            : flashcardsParaRepasar;
          
          console.log('üìö Flashcards para repasar:', {
            total: todasFlashcards.length,
            paraRepasar: flashcardsParaRepasar.length,
            enCarpeta: flashcardsFiltradas.length,
            nuevas: flashcardsParaRepasar.filter(f => !f.fechaRevision).length,
            enProgreso: flashcardsParaRepasar.filter(f => f.estadoRevision === 'en_progreso').length
          });
          
          setFlashcardsSesion(flashcardsFiltradas.length > 0 ? flashcardsFiltradas : todasFlashcards.slice(0, 10));
          setIndiceFlashcardActual(0);
        } catch (error) {
          console.error('Error parseando flashcards:', error);
          setFlashcardsSesion([]);
        }
      };
      cargarFlashcardsAsync();
      
    } catch (error) {
      console.error('Error cargando datos de sesi√≥n:', error);
    }
  };
  
  const extraerErroresDeExamenes = (examenes) => {
    const errores = [];
    
    console.log('üîç Extrayendo errores de', examenes.length, 'ex√°menes/pr√°cticas');
    
    examenes.forEach(examen => {
      // üî• BUSCAR EN AMBAS ESTRUCTURAS: resultados directos Y resultado.resultados
      let resultados = null;
      
      if (examen.resultados && Array.isArray(examen.resultados)) {
        resultados = examen.resultados;
      } else if (examen.resultado?.resultados && Array.isArray(examen.resultado.resultados)) {
        resultados = examen.resultado.resultados;
      }
      
      if (resultados) {
        resultados.forEach(resultado => {
          const porcentaje = (resultado.puntos / resultado.puntos_maximos) * 100;
          
          // Considerar error si obtuvo menos del 60% Y no ha sido corregido
          if (porcentaje < 60 && !resultado.corregido) {
            console.log('‚ùå Error encontrado:', {
              examen_id: examen.id,
              archivo: examen.archivo,
              pregunta: resultado.pregunta.substring(0, 50) + '...',
              porcentaje: porcentaje.toFixed(2) + '%',
              puntos: resultado.puntos,
              maximos: resultado.puntos_maximos,
              corregido: resultado.corregido
            });
            
            errores.push({
              ...resultado,
              examen_id: examen.id,
              archivo: examen.archivo, // üî• NECESARIO para actualizar archivo individual
              carpeta_ruta: examen.carpeta_ruta || examen.carpeta, // üî• NECESARIO para actualizar archivo individual
              fecha: examen.fecha_completado,
              carpeta: examen.carpeta_nombre,
              es_practica: examen.es_practica, // üî• Para distinguir entre examen y pr√°ctica
              porcentaje_obtenido: porcentaje
            });
          } else if (porcentaje < 60 && resultado.corregido) {
            console.log('‚úÖ Error ya corregido (ignorado):', {
              examen_id: examen.id,
              pregunta: resultado.pregunta.substring(0, 50) + '...',
              porcentaje: porcentaje.toFixed(2) + '%',
              corregido: resultado.corregido,
              fechaCorreccion: resultado.fechaCorreccion
            });
          }
        });
      }
    });
    
    console.log('üìä Total errores encontrados:', errores.length);
    return errores;
    
    // Ordenar por peor rendimiento primero
    return errores.sort((a, b) => a.porcentaje_obtenido - b.porcentaje_obtenido);
  };
  
  const avanzarFase = () => {
    const siguienteIndice = indiceFaseActual + 1;
    
    if (siguienteIndice < fasesSesion.length) {
      const siguienteFase = fasesSesion[siguienteIndice];
      
      // üí° TRANSFERIR TIEMPO SOBRANTE de la fase actual a la siguiente
      const tiempoSobrante = tiempoRestante > 0 ? tiempoRestante : 0;
      const nuevaDuracion = siguienteFase.duracion + tiempoSobrante;
      
      if (tiempoSobrante > 0) {
        console.log(`‚è±Ô∏è Transferencia de tiempo: +${Math.floor(tiempoSobrante/60)} min ${tiempoSobrante%60} seg a ${siguienteFase.nombre}`);
      }
      
      setIndiceFaseActual(siguienteIndice);
      setFaseActual(siguienteFase.tipo);
      setTiempoRestante(nuevaDuracion);
      setTiempoFaseActual(nuevaDuracion);
      
      // Si avanzamos desde calentamiento y hay una carpeta seleccionada, establecerla para las siguientes fases
      if (faseActual === 'calentamiento' && rutaCalentamientoActual) {
        // Establecer carpeta para flashcards
        setCarpetaFlashcardActual({
          nombre: rutaCalentamientoActual.split('\\').pop() || rutaCalentamientoActual,
          ruta: rutaCalentamientoActual
        });
        
        // Establecer carpeta para notas
        setRutaNotasActual(rutaCalentamientoActual);
        
        // Establecer carpeta para contenido
        setRutaContenidoActual(rutaCalentamientoActual);
      }
    } else {
      // Sesi√≥n completada
      finalizarSesion();
    }
  };
  
  const pausarReanudarSesion = () => {
    if (!sesionPausada) {
      // Al pausar, establecer 5 minutos de pausa
      setTiempoPausaRestante(300);
    }
    setSesionPausada(!sesionPausada);
  };
  
  const finalizarSesion = async () => {
    console.log('üèÅ Finalizando sesi√≥n...');
    
    // üî• CR√çTICO: Detener PRIMERO sesionActiva para que los useEffect dejen de ejecutarse
    setSesionActiva(false);
    
    // Peque√±a espera para que React procese el cambio de estado
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // Cambiar a fase de cierre
    setFaseActual('cierre');
    
    // Limpiar todos los timers
    setTiempoRestante(0);
    setSesionPausada(false);
    setEnDescanso(false);
    setTiempoHastaDescanso(0);
    setTiempoPausaRestante(0);
    
    // Eliminar sesi√≥n del backend
    try {
      await setSesionActiva({});
      localStorage.removeItem('examinator_sesion_activa');
      setSesionPersistente(null);
    } catch (error) {
      console.error('‚ùå Error eliminando sesi√≥n al finalizar:', error);
    }
    
    setMensaje({
      tipo: 'success',
      texto: 'üéâ ¬°Sesi√≥n completada! Revisa tu resumen de estudio.'
    });
  };
  
  const salirSesion = async () => {
    if (window.confirm('¬øSeguro que quieres salir de la sesi√≥n? Se perder√° el progreso actual.')) {
      setSesionActiva(false);
      setSesionPausada(false);
      setFaseActual(null);
      
      // Eliminar sesi√≥n guardada del backend
      try {
        await setSesionActiva({});
        setSesionPersistente(null);
        console.log('üóëÔ∏è Sesi√≥n abandonada y eliminada');
      } catch (error) {
        console.error('‚ùå Error eliminando sesi√≥n al salir:', error);
      }
      
      setSelectedMenu('inicio');
    }
  };
  
  const siguienteError = () => {
    if (indiceErrorActual < erroresActuales.length - 1) {
      setIndiceErrorActual(indiceErrorActual + 1);
      setEstadisticasSesion(prev => ({
        ...prev,
        erroresReforzados: prev.erroresReforzados + 1
      }));
    } else {
      // No hay m√°s errores, avanzar fase
      avanzarFase();
    }
  };
  
  // Funci√≥n para seleccionar respuesta al error
  const seleccionarRespuestaError = (opcion) => {
    setRespuestaErrorSeleccionada(opcion);
    setErrorYaRespondido(true);
    
    const errorActual = erroresActuales[indiceErrorActual];
    const esCorrecta = opcion.startsWith(errorActual.respuesta_correcta);
    
    if (esCorrecta) {
      console.log('‚úÖ ¬°Respuesta correcta! El error fue comprendido.');
    } else {
      console.log('‚ùå Respuesta incorrecta. Intenta nuevamente.');
    }
  };

  // üî• NUEVA: Funci√≥n para evaluar respuesta textual con IA (usando backend con modelo configurado)
  const evaluarRespuestaTextual = async () => {
    if (!respuestaTextual.trim()) {
      alert('Por favor escribe una respuesta antes de enviar');
      return;
    }

    const errorActual = erroresActuales[indiceErrorActual];
    setEvaluandoRespuesta(true);

    try {
      // Obtener el modelo activo desde la configuraci√≥n
      const modelo = configuracion?.modelo_ollama_activo || modeloSeleccionado;
      
      if (!modelo) {
        alert('‚ö†Ô∏è No hay un modelo seleccionado. Por favor, activa un modelo en la configuraci√≥n.');
        setEvaluandoRespuesta(false);
        return;
      }
      
      console.log('ü§ñ Evaluando con modelo configurado:', modelo);
      console.log('   üìù Pregunta:', errorActual.pregunta);
      console.log('   üí≠ Respuesta usuario:', respuestaTextual);
      
      // Llamar al nuevo endpoint del backend que usa el modelo configurado
      const response = await fetch(`${API_URL}/api/evaluar-respuesta-textual`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          pregunta: errorActual.pregunta,
          respuesta_usuario: respuestaTextual,
          respuesta_correcta: errorActual.respuesta_correcta,
          intentos_previos: historialIntentos,
          modelo: modelo
        })
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `Error del servidor: ${response.status}`);
      }

      const data = await response.json();
      const evaluacion = data.evaluacion;
      
      console.log('‚úÖ Evaluaci√≥n recibida:', evaluacion);

      // Convertir puntuaci√≥n 0-10 a 0-100 para compatibilidad
      const puntaje = Math.round((evaluacion.puntuacion / 10) * 100);
      
      // Construir feedback en formato compatible
      const feedbackTexto = `Puntaje: ${puntaje}/100 (${evaluacion.puntuacion}/10)

${evaluacion.feedback}

${evaluacion.sugerencias ? `üí° Sugerencias: ${evaluacion.sugerencias}` : ''}`;

      // Guardar en historial
      setHistorialIntentos(prev => [...prev, {
        respuesta: respuestaTextual,
        feedback: feedbackTexto,
        puntaje: puntaje,
        timestamp: new Date().toISOString()
      }]);

      setFeedbackIA({
        texto: feedbackTexto,
        puntaje: puntaje,
        esSuficiente: evaluacion.aprobada || puntaje >= 70
      });

      // Si la respuesta fue aprobada, marcar como respondido
      if (evaluacion.aprobada || puntaje >= 70) {
        setRespuestaErrorSeleccionada(respuestaTextual);
        setErrorYaRespondido(true);
      }

    } catch (error) {
      console.error('‚ùå Error al evaluar respuesta:', error);
      
      let mensajeError = 'Error al evaluar con el modelo.';
      
      if (error.message.includes('conectar') || error.message.includes('503')) {
        mensajeError = '‚ùå No se pudo conectar con Ollama. Verifica que est√© corriendo.';
      } else if (error.message.includes('modelo')) {
        mensajeError = '‚ùå Error con el modelo. Verifica que est√© correctamente configurado.';
      } else {
        mensajeError = `‚ùå ${error.message}`;
      }
      
      alert(mensajeError);
    } finally {
      setEvaluandoRespuesta(false);
    }
  };

  const marcarErrorComprendido = async () => {
    const errorActual = erroresActuales[indiceErrorActual];
    let esCorrecta = false;
    
    console.log('üîç MARCANDO ERROR COMPRENDIDO:', {
      pregunta: errorActual.pregunta.substring(0, 50) + '...',
      respuestaSeleccionada: respuestaErrorSeleccionada,
      respuestaTextual: respuestaTextual,
      feedbackIA: feedbackIA
    });
    
    // Verificar si la respuesta es correcta (puede ser de opci√≥n m√∫ltiple o texto)
    if (respuestaErrorSeleccionada && respuestaErrorSeleccionada.startsWith(errorActual.respuesta_correcta)) {
      esCorrecta = true;
      console.log('‚úÖ Respuesta de opci√≥n m√∫ltiple CORRECTA');
    } else if (feedbackIA && (feedbackIA.porcentaje_similitud >= 70 || feedbackIA.puntos >= 2)) {
      // Si es respuesta de texto y la IA la calific√≥ bien
      esCorrecta = true;
      console.log('‚úÖ Respuesta de texto CORRECTA (similitud:', feedbackIA.porcentaje_similitud, '%, puntos:', feedbackIA.puntos, ')');
    }
    
    // Si el usuario respondi√≥ correctamente, actualizar el examen/pr√°ctica original
    if (esCorrecta) {
      console.log('‚úÖ Error corregido. Actualizando examen/pr√°ctica original...');
      
      try {
        // üî• OPTIMIZACI√ìN: Buscar directamente por ID del error
        const esExamen = !errorActual.es_practica;
        const listaABuscar = esExamen ? await getDatos('examenes') : await getDatos('practicas');
        
        console.log(`üì¶ Buscando en ${listaABuscar.length} ${esExamen ? 'ex√°menes' : 'pr√°cticas'}`);
        console.log('   üîç Buscando ID:', errorActual.examen_id);
        console.log('   üìÇ Archivo:', errorActual.archivo);
        console.log('   üìÅ Carpeta:', errorActual.carpeta_ruta);
        
        // Buscar por ID
        const itemEncontrado = listaABuscar.find(item => item.id === errorActual.examen_id);
        
        if (!itemEncontrado) {
          console.error('‚ùå No se encontr√≥ el item con ID:', errorActual.examen_id);
          throw new Error(`Item con ID ${errorActual.examen_id} no encontrado`);
        }
        
        console.log('‚úÖ Item encontrado:', {
          id: itemEncontrado.id,
          archivo: itemEncontrado.archivo,
          carpeta_ruta: itemEncontrado.carpeta_ruta,
          tiene_archivo: !!itemEncontrado.archivo,
          tiene_carpeta_ruta: !!itemEncontrado.carpeta_ruta
        });
        
        // Obtener resultados
        let resultados = null;
        let esEstructuraDirecta = false;
        
        if (itemEncontrado.resultado?.resultados) {
          resultados = itemEncontrado.resultado.resultados;
          esEstructuraDirecta = false;
        } else if (itemEncontrado.resultados && Array.isArray(itemEncontrado.resultados)) {
          resultados = itemEncontrado.resultados;
          esEstructuraDirecta = true;
        }
        
        if (!resultados) {
          console.error('‚ùå No se encontraron resultados en el item');
          throw new Error('No se encontraron resultados');
        }
        
        // Buscar la pregunta espec√≠fica
        const preguntaIndex = resultados.findIndex(r => r.pregunta === errorActual.pregunta);
        
        if (preguntaIndex === -1) {
          console.error('‚ùå Pregunta no encontrada en resultados');
          throw new Error('Pregunta no encontrada');
        }
        
        console.log(`üìù Pregunta encontrada en √≠ndice ${preguntaIndex}`);
        
        // Actualizar la respuesta a correcta
        if (respuestaErrorSeleccionada) {
          resultados[preguntaIndex].respuesta_usuario = errorActual.respuesta_correcta;
        } else if (respuestaTextual) {
          resultados[preguntaIndex].respuesta_usuario = respuestaTextual;
        }
        resultados[preguntaIndex].puntos = resultados[preguntaIndex].puntos_maximos;
        resultados[preguntaIndex].corregido = true;
        resultados[preguntaIndex].fechaCorreccion = new Date().toISOString();
        
        console.log('   ‚úÖ Pregunta marcada como corregida:', {
          corregido: resultados[preguntaIndex].corregido,
          fechaCorreccion: resultados[preguntaIndex].fechaCorreccion,
          puntos_antes: errorActual.puntos,
          puntos_despues: resultados[preguntaIndex].puntos
        });
        
        // Recalcular puntos totales
        const nuevosPuntosObtenidos = resultados.reduce((sum, r) => sum + (r.puntos || 0), 0);
        const puntosTotales = esEstructuraDirecta ? itemEncontrado.puntos_totales : itemEncontrado.resultado.puntos_totales;
        const nuevoPorcentaje = (nuevosPuntosObtenidos / puntosTotales) * 100;
        
        if (esEstructuraDirecta) {
          itemEncontrado.puntos_obtenidos = nuevosPuntosObtenidos;
          itemEncontrado.porcentaje = nuevoPorcentaje;
        } else {
          itemEncontrado.resultado.puntos_obtenidos = nuevosPuntosObtenidos;
          itemEncontrado.resultado.porcentaje = nuevoPorcentaje;
        }
        
        // Guardar usando la funci√≥n correcta
        console.log('   üíæ Guardando item actualizado...');
        if (esExamen) {
          await guardarExamenEnCarpeta(itemEncontrado);
        } else {
          await guardarPracticaEnCarpeta(itemEncontrado);
        }
        
        console.log('‚úÖ Item actualizado y guardado - Nuevo porcentaje:', nuevoPorcentaje.toFixed(2) + '%');
        
        // üî• RECARGAR DATOS DESDE BACKEND PARA VERIFICAR QUE SE GUARD√ì
        console.log('üîÑ Recargando desde backend...');
        const itemsActualizados = esExamen ? await getDatos('examenes') : await getDatos('practicas');
        console.log('üì¶ Recargados:', itemsActualizados.length, esExamen ? 'ex√°menes' : 'pr√°cticas');
        
        // Refiltrar errores con los datos actualizados
        const todosItems = [...await getDatos('examenes'), ...await getDatos('practicas')];
        const erroresRefrescados = extraerErroresDeExamenes(todosItems);
        console.log('üîç Errores despu√©s de recargar:', erroresRefrescados.length);
        
        // Verificar que la pregunta ya NO est√© en la lista
        const preguntaAunEnLista = erroresRefrescados.find(e => 
          e.pregunta === errorActual.pregunta && e.examen_id === errorActual.examen_id
        );
        if (preguntaAunEnLista) {
          console.error('‚ùå ERROR: La pregunta sigue en la lista despu√©s de marcarla como corregida!', {
            pregunta: errorActual.pregunta.substring(0, 50),
            id: preguntaAunEnLista.examen_id,
            archivo: preguntaAunEnLista.archivo,
            corregido: preguntaAunEnLista.corregido,
            puntos: preguntaAunEnLista.puntos
          });
        } else {
          console.log('‚úÖ VERIFICADO: La pregunta ya NO est√° en la lista de errores');
        }
        
      } catch (error) {
        console.error('‚ùå Error actualizando item:', error);
      }
    } else {
      console.log('‚ö†Ô∏è El usuario no respondi√≥ correctamente, no se actualiza el examen.');
      
      // Si respondi√≥ mal, programar para ma√±ana
      const errorConRevision = calcularProximaRevision(errorActual, 'dificil');
      console.log('üìÖ Error mal respondido, revisi√≥n para:', errorConRevision.proximaRevision);
    }
    
    // Si fue corregido, eliminarlo de la lista de errores actuales
    if (esCorrecta) {
      const nuevosErrores = erroresActuales.filter((_, idx) => idx !== indiceErrorActual);
      setErroresActuales(nuevosErrores);
      
      // Si ya no quedan errores, avanzar fase
      if (nuevosErrores.length === 0) {
        setMensaje({
          tipo: 'success',
          texto: 'üéâ ¬°Felicidades! Has corregido todos los errores'
        });
        setRespuestaErrorSeleccionada(null);
        setErrorYaRespondido(false);
        setRespuestaTextual('');
        setHistorialIntentos([]);
        setFeedbackIA(null);
        avanzarFase();
        return;
      }
      
      // Ajustar √≠ndice si es necesario
      if (indiceErrorActual >= nuevosErrores.length) {
        setIndiceErrorActual(nuevosErrores.length - 1);
      }
    }
    
    // Resetear estados de respuesta
    setRespuestaErrorSeleccionada(null);
    setErrorYaRespondido(false);
    setRespuestaTextual('');
    setHistorialIntentos([]);
    setFeedbackIA(null);
    
    // Si no fue corregido, pasar al siguiente
    if (!esCorrecta) {
      siguienteError();
    }
  };
  
  // ============================================
  // üß† ALGORITMO SM-2 DE REPETICI√ìN ESPACIADA
  // ============================================
  
  /**
   * Calcula la pr√≥xima revisi√≥n seg√∫n el algoritmo SM-2 (SuperMemo 2)
   * @param {Object} item - Item a evaluar (flashcard, nota, pr√°ctica, etc.)
   * @param {String} dificultad - 'facil', 'medio', 'dificil'
   * @returns {Object} Item actualizado con nuevos valores de revisi√≥n
   */
  const calcularProximaRevision = (item, dificultad) => {
    let { intervalo, repeticiones, facilidad } = item;
    let nuevoIntervalo = intervalo || 1;
    let nuevasRepeticiones = repeticiones || 0;
    let nuevaFacilidad = facilidad || 2.5;
    
    // üî• CONTADOR DE REVISIONES DIARIAS (m√°ximo 2 por d√≠a)
    const ahora = new Date();
    const hoyInicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate(), 0, 0, 0);
    const ultimaRevision = item.ultima_revision || item.ultimaRevision;
    let revisionesHoy = item.revisionesHoy || 0;
    
    console.log('üìä calcularProximaRevision - Estado inicial:', {
      titulo: item.titulo || item.frente || item.pregunta,
      ultimaRevision: ultimaRevision,
      revisionesHoyActual: revisionesHoy,
      horaActual: ahora.toISOString(),
      inicioDia: hoyInicio.toISOString()
    });
    
    // Si la √∫ltima revisi√≥n fue hoy, incrementar contador
    if (ultimaRevision) {
      const fechaUltima = new Date(ultimaRevision);
      if (fechaUltima >= hoyInicio) {
        revisionesHoy += 1;
        console.log(`‚úÖ √öltima revisi√≥n fue HOY ‚Üí revisionesHoy: ${revisionesHoy - 1} ‚Üí ${revisionesHoy}`);
      } else {
        // Nuevo d√≠a, resetear contador
        console.log(`üîÑ Nueva d√≠a detectado ‚Üí resetear revisionesHoy: ${revisionesHoy} ‚Üí 1`);
        revisionesHoy = 1;
      }
    } else {
      console.log(`üÜï Primera revisi√≥n ‚Üí revisionesHoy: ${revisionesHoy} ‚Üí 1`);
      revisionesHoy = 1;
    }
    
    // Calidad de respuesta: facil=5, medio=3, dificil=1
    const calidad = dificultad === 'facil' ? 5 : dificultad === 'medio' ? 3 : 1;
    
    if (calidad >= 3) {
      // Respuesta correcta
      if (nuevasRepeticiones === 0) {
        nuevoIntervalo = 1; // 1 d√≠a
      } else if (nuevasRepeticiones === 1) {
        nuevoIntervalo = 6; // 6 d√≠as
      } else {
        nuevoIntervalo = Math.round(intervalo * nuevaFacilidad);
      }
      nuevasRepeticiones += 1;
    } else {
      // Respuesta incorrecta - reiniciar
      nuevasRepeticiones = 0;
      nuevoIntervalo = 1;
    }
    
    // Actualizar factor de facilidad
    nuevaFacilidad = nuevaFacilidad + (0.1 - (5 - calidad) * (0.08 + (5 - calidad) * 0.02));
    if (nuevaFacilidad < 1.3) nuevaFacilidad = 1.3;
    
    // Calcular pr√≥xima fecha de revisi√≥n
    const proximaFecha = new Date();
    proximaFecha.setDate(proximaFecha.getDate() + nuevoIntervalo);
    
    const itemActualizado = {
      ...item,
      fechaRevision: new Date().toISOString(),
      ultima_revision: new Date().toISOString(), // Para control de repetici√≥n diaria
      proximaRevision: proximaFecha.toISOString(),
      intervalo: nuevoIntervalo,
      repeticiones: nuevasRepeticiones,
      facilidad: nuevaFacilidad,
      estadoRevision: nuevasRepeticiones >= 3 ? 'dominada' : nuevasRepeticiones > 0 ? 'en_progreso' : 'nueva',
      revisionesHoy: revisionesHoy  // üî• Contador de revisiones diarias
    };
    
    console.log('üìä calcularProximaRevision - Estado final:', {
      revisionesHoy: itemActualizado.revisionesHoy,
      proximaRevision: itemActualizado.proximaRevision,
      intervalo: itemActualizado.intervalo
    });
    
    return itemActualizado;
  };
  
  /**
   * Filtra items que necesitan repaso seg√∫n su fecha de pr√≥xima revisi√≥n
   * @param {Array} items - Array de items (flashcards, notas, pr√°cticas)
   * @returns {Array} Items que necesitan repaso ordenados por prioridad
   */
  const filtrarItemsParaRepasar = (items) => {
    const ahora = new Date();
    const hoyInicio = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate(), 0, 0, 0);
    
    console.log('üîç FILTRANDO ITEMS PARA REPASAR:', {
      totalItems: items.length,
      horaActual: ahora.toISOString(),
      inicioDia: hoyInicio.toISOString()
    });
    
    const itemsParaRepasar = items.filter(item => {
      const titulo = item.titulo || item.frente || item.pregunta || item.id;
      
      // üî• INICIALIZAR revisionesHoy si no existe
      if (item.revisionesHoy === undefined || item.revisionesHoy === null) {
        // Verificar si la √∫ltima revisi√≥n fue hoy para inicializar correctamente
        const ultimaRevision = item.ultima_revision || item.ultimaRevision || item.fechaRevision;
        if (ultimaRevision) {
          const fechaUltima = new Date(ultimaRevision);
          if (fechaUltima >= hoyInicio) {
            // Ya fue revisado hoy, pero no tiene contador - asumir 1 revisi√≥n
            item.revisionesHoy = 1;
            console.log(`‚ö†Ô∏è Flashcard sin contador, inicializando a 1 (revisada hoy): ${titulo}`);
          } else {
            // Revisado en otro d√≠a - inicializar a 0
            item.revisionesHoy = 0;
          }
        } else {
          // Nunca revisado - inicializar a 0
          item.revisionesHoy = 0;
        }
      }
      
      // üî• REGLA 1: M√°ximo 2 revisiones por d√≠a (sistema Anki) - VERIFICAR PRIMERO
      const revisionesHoy = item.revisionesHoy || 0;
      if (revisionesHoy >= 2) {
        console.log(`‚ùå EXCLUIDO (${revisionesHoy} revisiones hoy, m√°ximo 2): ${titulo}`);
        return false;
      }
      
      // üî• REGLA 2: Si ya fue revisado HOY, verificar que no haya alcanzado el l√≠mite
      const ultimaRevision = item.ultima_revision || item.ultimaRevision || item.fechaRevision;
      if (ultimaRevision) {
        const fechaUltimaRevision = new Date(ultimaRevision);
        
        // Si la √∫ltima revisi√≥n fue hoy, verificar contador
        if (fechaUltimaRevision >= hoyInicio) {
          if (revisionesHoy >= 2) {
            console.log(`‚ùå EXCLUIDO (revisado hoy ${revisionesHoy} veces): ${titulo}`, {
              ultima_revision: fechaUltimaRevision.toISOString(),
              revisionesHoy: revisionesHoy
            });
            return false;
          }
          // Si tiene 1 revisi√≥n, puede aparecer una vez m√°s
          if (revisionesHoy === 1) {
            console.log(`‚ö†Ô∏è ALERTA: Puede aparecer 1 vez m√°s hoy (${revisionesHoy}/2): ${titulo}`);
          }
        } else {
          // √öltima revisi√≥n fue en otro d√≠a - deber√≠a tener revisionesHoy = 0
          if (revisionesHoy > 0) {
            console.log(`üîÑ CORRIGIENDO contador obsoleto: ${titulo} (${revisionesHoy} ‚Üí 0)`);
            item.revisionesHoy = 0;
          }
        }
      }
      
      // üî• REGLA 3: Si NO tiene proximaRevision, es nuevo (mostrar solo si nunca revisado)
      if (!item.proximaRevision) {
        // Solo mostrar si NUNCA ha sido revisado O si fue revisado hace d√≠as
        const esNuevo = !ultimaRevision;
        const revisadoHacetiempo = ultimaRevision && new Date(ultimaRevision) < hoyInicio;
        
        if (esNuevo) {
          console.log(`‚úÖ INCLUIDO (nuevo, nunca revisado): ${titulo}`);
          return true;
        } else if (revisadoHacetiempo && revisionesHoy === 0) {
          console.log(`‚úÖ INCLUIDO (revisado antes, pero no hoy): ${titulo}`);
          return true;
        }
        return false;
      }
      
      // üî• REGLA 4: Si tiene proximaRevision, verificar si ya lleg√≥ la fecha
      const fechaRevision = new Date(item.proximaRevision);
      const debeRepasar = fechaRevision <= ahora;
      
      if (debeRepasar) {
        console.log(`‚úÖ INCLUIDO (fecha llegada, ${revisionesHoy}/2 revisiones): ${titulo}`, {
          proximaRevision: fechaRevision.toISOString(),
          ahora: ahora.toISOString(),
          revisionesHoy: revisionesHoy
        });
      } else {
        console.log(`‚è≠Ô∏è EXCLUIDO (fecha no llegada): ${titulo}`, {
          proximaRevision: fechaRevision.toISOString(),
          faltanHoras: Math.round((fechaRevision - ahora) / (1000 * 60 * 60))
        });
      }
      
      return debeRepasar;
    });
    
    console.log(`üìä RESULTADO FILTRADO: ${itemsParaRepasar.length} de ${items.length} items para repasar`);
    
    // Ordenar por prioridad: nuevos primero, luego por fecha de revisi√≥n
    return itemsParaRepasar.sort((a, b) => {
      if (!a.proximaRevision && !b.proximaRevision) return 0;
      if (!a.proximaRevision) return -1; // Nuevos primero
      if (!b.proximaRevision) return 1;
      return new Date(a.proximaRevision) - new Date(b.proximaRevision);
    });
  };
  
  /**
   * Calcula el rendimiento de una carpeta basado en el estado de sus items
   * @param {String} rutaCarpeta - Ruta de la carpeta
   * @returns {Object} Estad√≠sticas de rendimiento
   */
  const calcularRendimientoCarpeta = async (rutaCarpeta) => {
    const flashcards = await cargarTodasFlashcards();
    const notas = await getDatos('notas');
    const practicas = await getDatos('practicas');
    
    const itemsCarpeta = [
      ...flashcards.filter(f => f.carpeta && f.carpeta.includes(rutaCarpeta)),
      ...notas.filter(n => n.carpeta && n.carpeta.includes(rutaCarpeta)),
      ...practicas.filter(p => p.carpeta && p.carpeta.includes(rutaCarpeta))
    ];
    
    const total = itemsCarpeta.length;
    const dominadas = itemsCarpeta.filter(i => i.estadoRevision === 'dominada').length;
    const enProgreso = itemsCarpeta.filter(i => i.estadoRevision === 'en_progreso').length;
    const nuevas = itemsCarpeta.filter(i => !i.estadoRevision || i.estadoRevision === 'nueva').length;
    
    const porcentajeDominado = total > 0 ? Math.round((dominadas / total) * 100) : 0;
    
    return {
      total,
      dominadas,
      enProgreso,
      nuevas,
      porcentajeDominado
    };
  };
  
  /**
   * Genera un mapa de repeticiones futuras para un item
   * Simula las pr√≥ximas 10 repeticiones con diferentes escenarios
   * @param {Object} item - Item a analizar
   * @returns {Object} Mapa con escenarios de repetici√≥n
   */
  const generarMapaRepeticiones = (item) => {
    const fechaInicial = item.proximaRevision ? new Date(item.proximaRevision) : new Date();
    const intervaloActual = item.intervalo || 1;
    const facilidadActual = item.facilidad || 2.5;
    const repeticionesActuales = item.repeticiones || 0;
    
    // Generar 3 escenarios: siempre f√°cil, siempre medio, siempre dif√≠cil
    const escenarios = {
      facil: [],
      medio: [],
      dificil: []
    };
    
    // Simular cada escenario
    ['facil', 'medio', 'dificil'].forEach(dificultad => {
      let fecha = new Date(fechaInicial);
      let intervalo = intervaloActual;
      let facilidad = facilidadActual;
      let repeticiones = repeticionesActuales;
      
      for (let i = 0; i < 10; i++) {
        // Calcular siguiente intervalo seg√∫n dificultad
        let nuevoIntervalo;
        let nuevaFacilidad = facilidad;
        
        if (repeticiones === 0) {
          nuevoIntervalo = 1;
        } else if (repeticiones === 1) {
          nuevoIntervalo = 6;
        } else {
          if (dificultad === 'facil') {
            nuevaFacilidad = Math.min(facilidad + 0.15, 2.5);
            nuevoIntervalo = Math.round(intervalo * nuevaFacilidad);
          } else if (dificultad === 'medio') {
            nuevoIntervalo = Math.round(intervalo * facilidad);
          } else { // dif√≠cil
            nuevaFacilidad = Math.max(facilidad - 0.2, 1.3);
            nuevoIntervalo = Math.max(1, Math.round(intervalo * 0.5));
          }
        }
        
        // Calcular pr√≥xima fecha
        const proximaFecha = new Date(fecha.getTime() + nuevoIntervalo * 24 * 60 * 60 * 1000);
        
        escenarios[dificultad].push({
          repeticion: repeticiones + 1,
          fecha: proximaFecha,
          intervalo: nuevoIntervalo,
          facilidad: nuevaFacilidad,
          diasDesdeHoy: Math.ceil((proximaFecha - new Date()) / (1000 * 60 * 60 * 24))
        });
        
        // Actualizar para siguiente iteraci√≥n
        fecha = proximaFecha;
        intervalo = nuevoIntervalo;
        facilidad = nuevaFacilidad;
        repeticiones++;
      }
    });
    
    return {
      item,
      fechaInicial,
      escenarios
    };
  };
  
  // ============================================
  // üé¥ FUNCIONES FASE 3 - FLASHCARDS
  // ============================================

  // Funci√≥n auxiliar para guardar flashcards en su carpeta correspondiente
  const guardarFlashcardEnCarpeta = async (flashcard) => {
    const carpeta = flashcard.carpeta || '';
    
    if (!carpeta) {
      console.warn('‚ö†Ô∏è Flashcard sin carpeta, usando "Sin carpeta":', flashcard.id);
      flashcard.carpeta = 'Sin carpeta';
    }
    
    try {
      const response = await fetch(`${API_URL}/datos/flashcards/carpeta`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          flashcard: flashcard,
          carpeta: flashcard.carpeta
        })
      });

      if (!response.ok) throw new Error('Error al guardar flashcard');
      
      return await response.json();
    } catch (error) {
      console.error('Error guardando flashcard en carpeta:', error);
      throw error;
    }
  };

  // Funci√≥n auxiliar para guardar pr√°cticas en su carpeta correspondiente
  const guardarPracticaEnCarpeta = async (practica) => {
    const carpeta = practica.carpeta || '';
    
    if (!carpeta) {
      console.warn('‚ö†Ô∏è Pr√°ctica sin carpeta, usando "Sin carpeta":', practica.id);
      practica.carpeta = 'Sin carpeta';
    }
    
    try {
      // üî• VERIFICAR SI ES ARCHIVO INDIVIDUAL (resultados_practicas/examen_*.json)
      const esArchivoIndividual = practica.carpeta_ruta && practica.archivo;
      
      if (esArchivoIndividual) {
        // Usar endpoint para actualizar archivo individual
        console.log('üìù Actualizando archivo individual de pr√°ctica:', practica.archivo);
        const response = await fetch(`${API_URL}/datos/practicas/actualizar_archivo`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            practica: practica
          })
        });

        if (!response.ok) throw new Error('Error al actualizar archivo de pr√°ctica');
        
        return await response.json();
      } else {
        // Usar endpoint legacy para practicas.json
        const response = await fetch(`${API_URL}/datos/practicas/carpeta`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            practica: practica,
            carpeta: practica.carpeta
          })
        });

        if (!response.ok) throw new Error('Error al guardar pr√°ctica');
        
        return await response.json();
      }
    } catch (error) {
      console.error('Error guardando pr√°ctica en carpeta:', error);
      throw error;
    }
  };

  // Funci√≥n auxiliar para guardar ex√°menes en su carpeta correspondiente
  const guardarExamenEnCarpeta = async (examen) => {
    const carpeta = examen.carpeta || '';
    
    if (!carpeta) {
      console.warn('‚ö†Ô∏è Examen sin carpeta, usando "Sin carpeta":', examen.id);
      examen.carpeta = 'Sin carpeta';
    }
    
    try {
      // üî• VERIFICAR SI ES ARCHIVO INDIVIDUAL (resultados_examenes/examen_*.json)
      const esArchivoIndividual = examen.carpeta_ruta && examen.archivo;
      
      if (esArchivoIndividual) {
        // Usar endpoint para actualizar archivo individual
        console.log('üìù Actualizando archivo individual de examen:', examen.archivo);
        const response = await fetch(`${API_URL}/datos/examenes/actualizar_archivo`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            examen: examen
          })
        });

        if (!response.ok) throw new Error('Error al actualizar archivo de examen');
        
        return await response.json();
      } else {
        // Usar endpoint legacy para examenes.json
        const response = await fetch(`${API_URL}/datos/examenes/carpeta`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            examen: examen,
            carpeta: examen.carpeta
          })
        });

        if (!response.ok) throw new Error('Error al guardar examen');
        
        return await response.json();
      }
    } catch (error) {
      console.error('Error guardando examen en carpeta:', error);
      throw error;
    }
  };

  // Funci√≥n auxiliar para guardar notas en su carpeta correspondiente
  const guardarNotaEnCarpeta = async (nota) => {
    const carpeta = nota.carpeta || '';
    
    if (!carpeta) {
      console.warn('‚ö†Ô∏è Nota sin carpeta, usando "Sin carpeta":', nota.id);
      nota.carpeta = 'Sin carpeta';
    }
    
    try {
      const response = await fetch(`${API_URL}/datos/notas/carpeta`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          nota: nota,
          carpeta: nota.carpeta
        })
      });

      if (!response.ok) throw new Error('Error al guardar nota');
      
      return await response.json();
    } catch (error) {
      console.error('Error guardando nota en carpeta:', error);
      throw error;
    }
  };
  
  const evaluarFlashcard = async (dificultad) => {
    // dificultad: 'facil', 'medio', 'dificil'
    const flashcardActual = flashcardsSesion[indiceFlashcardActual];
    
    console.log('üîç EVALUANDO FLASHCARD:', {
      id: flashcardActual?.id,
      titulo: flashcardActual?.titulo || flashcardActual?.frente,
      dificultad,
      indiceActual: indiceFlashcardActual,
      totalEnSesion: flashcardsSesion.length
    });
    
    // Actualizar flashcard con algoritmo SM-2 (SuperMemo 2)
    const flashcardsGuardadas = await cargarTodasFlashcards();
    const flashcardActualizada = flashcardsGuardadas.find(f => f.id === flashcardActual.id);
    
    if (!flashcardActualizada) {
      console.error('‚ùå Flashcard no encontrada en archivo:', flashcardActual.id);
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error: Flashcard no encontrada'
      });
      return;
    }
    
    console.log('üìã Datos actuales de la flashcard:', {
      ultima_revision: flashcardActualizada.ultima_revision,
      proximaRevision: flashcardActualizada.proximaRevision,
      intervalo: flashcardActualizada.intervalo,
      repeticiones: flashcardActualizada.repeticiones
    });
    
    const flashcardConNuevosDatos = calcularProximaRevision(flashcardActualizada, dificultad);
    
    console.log('üìä Nuevos datos calculados:', {
      ultima_revision: flashcardConNuevosDatos.ultima_revision,
      proximaRevision: flashcardConNuevosDatos.proximaRevision,
      intervalo: flashcardConNuevosDatos.intervalo,
      repeticiones: flashcardConNuevosDatos.repeticiones,
      estadoRevision: flashcardConNuevosDatos.estadoRevision
    });
    
    // üî• GUARDAR EN SU CARPETA CORRESPONDIENTE
    try {
      await guardarFlashcardEnCarpeta(flashcardConNuevosDatos);
      console.log('‚úÖ Flashcard guardada en carpeta:', flashcardConNuevosDatos.carpeta);
      
      // ‚è≥ Esperar un momento para asegurar que el archivo se escribi√≥ completamente
      await new Promise(resolve => setTimeout(resolve, 300));
      
      // üî• RECARGAR TODAS LAS FLASHCARDS para que el filtro funcione correctamente
      const flashcardsReacargadas = await cargarTodasFlashcards();
      console.log('üîÑ Flashcards recargadas:', flashcardsReacargadas.length);
      
      // Actualizar estado local
      setFlashcardsActuales(flashcardsReacargadas);
      
      // üî• ACTUALIZAR la lista de flashcards de sesi√≥n eliminando las ya repasadas hoy
      const flashcardsParaRepasar = filtrarItemsParaRepasar(flashcardsReacargadas);
      
      console.log('üéØ Filtrado de flashcards para repasar:', {
        totalRecargadas: flashcardsReacargadas.length,
        paraRepasar: flashcardsParaRepasar.length,
        eliminadas: flashcardsReacargadas.length - flashcardsParaRepasar.length,
        anteriorEnSesion: flashcardsSesion.length
      });
      
      // Verificar si la flashcard actual sigue en la lista
      const flashcardSigueEnLista = flashcardsParaRepasar.find(f => f.id === flashcardActual.id);
      if (flashcardSigueEnLista) {
        console.warn('‚ö†Ô∏è PROBLEMA: La flashcard evaluada A√öN est√° en la lista para repasar!');
        console.warn('   ultima_revision guardada:', flashcardSigueEnLista.ultima_revision);
        console.warn('   Hora actual:', new Date().toISOString());
      } else {
        console.log('‚úÖ Correcto: Flashcard eliminada de la lista de repaso');
      }
      
      setFlashcardsSesion(flashcardsParaRepasar);
    } catch (error) {
      console.error('Error guardando flashcard evaluada:', error);
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al guardar la evaluaci√≥n'
      });
      return;
    }
    
    setEstadisticasSesion(prev => ({
      ...prev,
      flashcardsRepasadas: prev.flashcardsRepasadas + 1
    }));
    
    // Avanzar a siguiente flashcard O terminar fase
    // Usar setTimeout para dar tiempo a que se actualice flashcardsSesion
    setTimeout(() => {
      if (indiceFlashcardActual >= flashcardsSesion.length - 1) {
        // No hay m√°s flashcards, avanzar de fase
        console.log('‚úÖ Todas las flashcards repasadas, avanzando de fase');
        avanzarFase();
      } else {
        // Hay m√°s flashcards, avanzar al siguiente √≠ndice
        setIndiceFlashcardActual(prev => prev + 1);
        // Resetear estado de volteo para nueva flashcard
        setFlashcardsVolteadas({});
      }
    }, 100);
  };
  
  // ============================================
  // üéØ FUNCIONES FASE 4 - CONTENIDO NUEVO
  // ============================================
  
  // Cargar carpetas disponibles para navegaci√≥n de contenido
  const cargarCarpetasContenido = async (ruta = '') => {
    try {
      const url = `${API_URL}/api/cursos/carpetas?ruta=${encodeURIComponent(ruta)}`
      const response = await fetch(url)
      const data = await response.json()
      setCarpetasContenido(data.carpetas || [])
      setRutaContenidoActual(ruta)
    } catch (error) {
      console.error('Error cargando carpetas de contenido:', error)
      setMensaje({
        tipo: 'error',
        texto: 'Error al cargar carpetas'
      })
    }
  }

  // Cargar carpetas para fase de calentamiento
  const cargarCarpetasCalentamiento = async (ruta = '') => {
    try {
      const url = `${API_URL}/api/carpetas?ruta=${encodeURIComponent(ruta)}`
      console.log('üî• Cargando carpetas de calentamiento desde:', url);
      const response = await fetch(url)
      const data = await response.json()
      console.log('‚úÖ Carpetas de calentamiento cargadas:', data.carpetas?.length || 0);
      setCarpetasCalentamiento(data.carpetas || [])
      setRutaCalentamientoActual(ruta)
    } catch (error) {
      console.error('Error cargando carpetas de calentamiento:', error)
      setMensaje({
        tipo: 'error',
        texto: 'Error al cargar carpetas'
      })
    }
  }

  // Crear nueva carpeta en calentamiento
  const crearCarpetaCalentamiento = async (nombreCarpeta) => {
    try {
      const url = `${API_URL}/api/cursos/crear_carpeta`
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ruta: rutaCalentamientoActual,
          nombre: nombreCarpeta
        })
      })
      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Carpeta "${nombreCarpeta}" creada`
        })
        // Recargar carpetas
        cargarCarpetasCalentamiento(rutaCalentamientoActual)
        setModalNuevaCarpetaCalentamiento(false)
      } else {
        setMensaje({
          tipo: 'error',
          texto: data.error || 'Error al crear carpeta'
        })
      }
    } catch (error) {
      console.error('Error creando carpeta:', error)
      setMensaje({
        tipo: 'error',
        texto: 'Error al crear carpeta'
      })
    }
  }

  // Funciones para explorador de guardado en fase contenido
  const cargarCarpetasGuardado = async (ruta = '') => {
    try {
      const url = `${API_URL}/api/cursos/carpetas?ruta=${encodeURIComponent(ruta)}`
      const response = await fetch(url)
      const data = await response.json()
      setCarpetasGuardado(data.carpetas || [])
      setRutaGuardadoActual(ruta)
    } catch (error) {
      console.error('Error cargando carpetas de guardado:', error)
      setMensaje({
        tipo: 'error',
        texto: 'Error al cargar carpetas'
      })
    }
  }

  const crearCarpetaGuardado = async (nombreCarpeta) => {
    try {
      const url = `${API_URL}/api/cursos/crear_carpeta`
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ruta: rutaGuardadoActual,
          nombre: nombreCarpeta
        })
      })
      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Carpeta "${nombreCarpeta}" creada`
        })
        cargarCarpetasGuardado(rutaGuardadoActual)
        setModalNuevaCarpetaGuardado(false)
      } else {
        setMensaje({
          tipo: 'error',
          texto: data.error || 'Error al crear carpeta'
        })
      }
    } catch (error) {
      console.error('Error creando carpeta:', error)
      setMensaje({
        tipo: 'error',
        texto: 'Error al crear carpeta'
      })
    }
  }

  const guardarContenidoComoTXT = async (rutaDestino) => {
    // Generar t√≠tulo autom√°tico si est√° vac√≠o
    const titulo = editorNotaTitulo.trim() || `nota_${new Date().toISOString().slice(0,19).replace(/[T:]/g, '_')}`
    
    try {
      const nombreArchivo = `${titulo.replace(/[^a-z0-9√°√©√≠√≥√∫√±\s]/gi, '_')}_${Date.now()}.txt`
      const contenidoTxt = `${titulo}\n${'='.repeat(titulo.length)}\n\n${editorNotaContenido}\n\n---\nTags: ${editorNotaTags}\nFecha: ${new Date().toLocaleString('es-ES')}`
      
      const response = await fetch(`${API_URL}/api/guardar-nota-txt`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          carpeta: rutaDestino,
          nombreArchivo: nombreArchivo,
          contenido: contenidoTxt
        })
      })
      
      if (response.ok) {
        setMensaje({
          tipo: 'success',
          texto: `üìÑ TXT guardado en: ${rutaDestino}/${nombreArchivo}`
        })
        setModalGuardarContenido(false)
      } else {
        throw new Error('Error al guardar')
      }
    } catch (error) {
      console.error('Error guardando TXT:', error)
      setMensaje({ tipo: 'error', texto: 'Error al guardar TXT' })
    }
  }

  const guardarContenidoComoNota = async (rutaDestino) => {
    // Generar t√≠tulo autom√°tico si est√° vac√≠o
    const titulo = editorNotaTitulo.trim() || `nota_${new Date().toISOString().slice(0,19).replace(/[T:]/g, '_')}`
    
    try {
      const ahora = new Date().toISOString()
      
      // Extraer texto plano del HTML si es necesario
      let textoPlano = editorNotaContenido
      if (editorNotaContenido && editorNotaContenido.includes('<')) {
        const tempDiv = document.createElement('div')
        tempDiv.innerHTML = editorNotaContenido
        textoPlano = tempDiv.textContent || tempDiv.innerText
      }
      
      // Preparar contenido en formato TXT legible
      const contenidoTxt = `${titulo}\n${'='.repeat(titulo.length)}\n\n${textoPlano}\n\n---\nTags: ${editorNotaTags}\nFecha: ${new Date(ahora).toLocaleString('es-ES')}`
      
      // Guardar archivo f√≠sico en el servidor
      const nombreArchivo = `${titulo.replace(/[^a-z0-9√°√©√≠√≥√∫√±\s]/gi, '_')}.txt`
      
      const response = await fetch(`${API_URL}/api/guardar-nota-txt`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          carpeta: rutaDestino,
          nombreArchivo: nombreArchivo,
          contenido: contenidoTxt
        })
      })
      
      if (response.ok) {
        // Crear objeto de nota
        const nuevaNota = {
          id: Date.now(),
          titulo: titulo,
          contenido: editorNotaContenido,
          carpeta: rutaDestino,
          tags: editorNotaTags.split(',').map(t => t.trim()).filter(t => t),
          fecha: ahora,
          fechaModificacion: ahora,
          // Repetici√≥n espaciada
          proximaRevision: new Date().toISOString(),
          intervalo: 1,
          repeticiones: 0,
          facilidad: 2.5,
          estadoRevision: 'nueva'
        }
        
        // Guardar en carpeta con la nueva API
        await guardarNotaEnCarpeta(nuevaNota);
        
        // Actualizar el estado de notas guardadas
        setNotasGuardadas(notasActuales)
        
        setMensaje({
          tipo: 'success',
          texto: `üìù Nota guardada: ${rutaDestino}/${nombreArchivo}`
        })
        setModalGuardarContenido(false)
        
        setEstadisticasSesion(prev => ({
          ...prev,
          notasTomadas: prev.notasTomadas + 1
        }))
      } else {
        throw new Error(`Error ${response.status}`)
      }
    } catch (error) {
      console.error('Error guardando nota:', error)
      setMensaje({ tipo: 'error', texto: `Error al guardar: ${error.message}` })
    }
  }

  // Navegar a una carpeta
  const navegarACarpetaContenido = (carpeta) => {
    const nuevaRuta = rutaContenidoActual 
      ? `${rutaContenidoActual}/${carpeta.nombre}`
      : carpeta.nombre
    
    // Agregar al historial
    setNavegacionHistorial([...navegacionHistorial, rutaContenidoActual])
    cargarCarpetasContenido(nuevaRuta)
  }

  // Volver atr√°s en la navegaci√≥n
  const volverAtrasContenido = () => {
    if (navegacionHistorial.length > 0) {
      const rutaAnterior = navegacionHistorial[navegacionHistorial.length - 1]
      setNavegacionHistorial(navegacionHistorial.slice(0, -1))
      cargarCarpetasContenido(rutaAnterior)
    } else {
      // Si no hay historial, volver a ra√≠z
      cargarCarpetasContenido('')
    }
  }

  // Seleccionar carpeta para trabajar
  const seleccionarCarpetaContenido = (carpeta) => {
    setCursoActual({
      ...cursoActual,
      carpeta_trabajo: rutaContenidoActual ? `${rutaContenidoActual}/${carpeta.nombre}` : carpeta.nombre,
      nombre: carpeta.nombre
    })
    setMostrandoSelectorCarpetas(false)
    setMensaje({
      tipo: 'success',
      texto: `üìÅ Carpeta seleccionada: ${carpeta.nombre}`
    })
  }
  
  const cargarContenidoFase4 = async () => {
    try {
      // L√≥gica de selecci√≥n de documento
      let documentoSeleccionado = null;
      
      // 1. Si hay curso seleccionado en Fase 1
      if (datosCalentamiento && datosCalentamiento.cursoSeleccionado) {
        documentoSeleccionado = await obtenerSiguienteDocumento(datosCalentamiento.cursoSeleccionado);
      }
      
      // 2. Si prioridad es contenido en Fase 0
      if (!documentoSeleccionado && prioridadSesion === 'contenido') {
        documentoSeleccionado = await obtenerDocumentoCursoConMasProgreso();
      }
      
      // 3. √öltimo curso accedido
      if (!documentoSeleccionado) {
        const ultimoCurso = localStorage.getItem('ultimoCursoAccedido');
        if (ultimoCurso) {
          documentoSeleccionado = await obtenerSiguienteDocumento(ultimoCurso);
        }
      }
      
      // 4. Default: mostrar selector (simulado)
      if (!documentoSeleccionado) {
        documentoSeleccionado = {
          id: 'doc_default',
          titulo: 'Documento de Ejemplo',
          contenido_html: '<h1>Bienvenido</h1><p>Este es un documento de ejemplo. En una implementaci√≥n real, aqu√≠ cargar√≠as contenido de tus cursos.</p>',
          tipo: 'html',
          videos: []
        };
      }
      
      setDocumentoActual(documentoSeleccionado);
      
      // Cargar notas vinculadas (simulado - en producci√≥n vendr√≠a del backend)
      const notasVinculadasDoc = JSON.parse(localStorage.getItem('notas_vinculadas') || '[]')
        .filter(nota => nota.vinculado_a_documento === documentoSeleccionado.id);
      setNotasVinculadas(notasVinculadasDoc);
      
      // Cargar informaci√≥n del curso actual (simulado)
      setCursoActual({
        id: 'curso_001',
        nombre: datosCalentamiento?.cursoSeleccionado || 'Curso General',
        tema_actual: 'Tema Actual',
        progreso_curso: 60,
        docs_total: 20,
        docs_completados: 12
      });
      
    } catch (error) {
      console.error('Error cargando contenido Fase 4:', error);
      setMensaje({
        tipo: 'error',
        texto: 'Error al cargar contenido. Intenta nuevamente.'
      });
    }
  };
  
  const obtenerSiguienteDocumento = async (cursoId) => {
    // Simulaci√≥n - en producci√≥n har√≠a request al backend
    return {
      id: `doc_${Date.now()}`,
      titulo: `Documento de ${cursoId}`,
      contenido_html: '<h1>Contenido del curso</h1><p>Aqu√≠ va el contenido real del documento.</p>',
      tipo: 'html',
      videos: []
    };
  };
  
  const obtenerDocumentoCursoConMasProgreso = async () => {
    // Simulaci√≥n
    return null;
  };
  
  const generarPracticaRapida = async () => {
    if (!documentoActual) {
      setMensaje({
        tipo: 'warning',
        texto: 'No hay documento cargado para generar pr√°ctica'
      });
      return;
    }
    
    setGenerandoPractica(true);
    
    try {
      // Simulaci√≥n de generaci√≥n de pr√°ctica
      // En producci√≥n: POST /api/practice/generate
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      const preguntasGeneradas = [];
      
      if (tipoPractica === 'mcq') {
        for (let i = 0; i < numPreguntasPractica; i++) {
          preguntasGeneradas.push({
            id: i + 1,
            tipo: 'mcq',
            pregunta: `Pregunta de opci√≥n m√∫ltiple ${i + 1} sobre ${documentoActual.titulo}`,
            opciones: [
              { id: 'A', texto: 'Opci√≥n A' },
              { id: 'B', texto: 'Opci√≥n B' },
              { id: 'C', texto: 'Opci√≥n C' },
              { id: 'D', texto: 'Opci√≥n D' }
            ],
            respuesta_correcta: 'B',
            explicacion: 'La opci√≥n B es correcta porque...'
          });
        }
      } else if (tipoPractica === 'short_answer') {
        for (let i = 0; i < numPreguntasPractica; i++) {
          preguntasGeneradas.push({
            id: i + 1,
            tipo: 'short_answer',
            pregunta: `Pregunta corta ${i + 1} sobre ${documentoActual.titulo}`,
            respuesta_esperada: 'Respuesta esperada...',
            explicacion: 'Explicaci√≥n de la respuesta'
          });
        }
      }
      
      setPracticaGenerada({
        id: `practica_${Date.now()}`,
        preguntas: preguntasGeneradas,
        documento_id: documentoActual.id
      });
      
      setPreguntaActualPractica(0);
      setRespuestasPractica([]);
      setMostrandoFeedback(false);
      setResultadoPractica(null);
      
      setMensaje({
        tipo: 'success',
        texto: `‚úÖ Pr√°ctica generada: ${preguntasGeneradas.length} preguntas`
      });
      
    } catch (error) {
      console.error('Error generando pr√°ctica:', error);
      setMensaje({
        tipo: 'error',
        texto: 'Error al generar pr√°ctica. Intenta nuevamente.'
      });
    } finally {
      setGenerandoPractica(false);
    }
  };
  
  const responderPreguntaPractica = (respuesta) => {
    const preguntaActual = practicaGenerada.preguntas[preguntaActualPractica];
    const esCorrecta = respuesta === preguntaActual.respuesta_correcta;
    
    setRespuestasPractica([...respuestasPractica, {
      pregunta_id: preguntaActual.id,
      respuesta: respuesta,
      correcta: esCorrecta
    }]);
    
    setMostrandoFeedback(true);
  };
  
  const siguientePreguntaPractica = () => {
    setMostrandoFeedback(false);
    
    if (preguntaActualPractica < practicaGenerada.preguntas.length - 1) {
      setPreguntaActualPractica(preguntaActualPractica + 1);
    } else {
      // Pr√°ctica completada
      finalizarPractica();
    }
  };
  
  const finalizarPractica = () => {
    const correctas = respuestasPractica.filter(r => r.correcta).length;
    const total = respuestasPractica.length;
    const porcentaje = Math.round((correctas / total) * 100);
    
    setResultadoPractica({
      correctas,
      total,
      porcentaje,
      fecha: new Date().toISOString()
    });
    
    setEstadisticasSesion(prev => ({
      ...prev,
      practicasHechas: prev.practicasHechas + 1
    }));
  };
  
  const guardarResultadosPractica = async () => {
    // Agregar al historial local
    const nuevaPractica = {
      id: practicaGenerada.id,
      tipo: tipoPractica,
      resultado: resultadoPractica,
      fecha: new Date().toISOString(),
      // Repetici√≥n espaciada
      proximaRevision: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
      intervalo: 1,
      repeticiones: 0,
      facilidad: 2.5,
      estadoRevision: 'nueva'
    };
    
    setHistorialPracticas([...historialPracticas, nuevaPractica]);
    
    setMensaje({
      tipo: 'success',
      texto: '‚úÖ Resultados guardados'
    });
    
    // Reset para nueva pr√°ctica
    setPracticaGenerada(null);
    setResultadoPractica(null);
  };
  
  const guardarNotaRapida = async () => {
    if (!editorNotaTitulo.trim()) {
      setMensaje({
        tipo: 'warning',
        texto: '‚ö†Ô∏è Debes agregar un t√≠tulo a la nota'
      });
      return;
    }
    
    setGuardandoNota(true);
    
    try {
      const ahora = new Date().toISOString();
      
      const nuevaNota = {
        id: `nota_${Date.now()}`,
        titulo: editorNotaTitulo,
        contenido: editorNotaContenido,
        tags: editorNotaTags.split(',').map(t => t.trim()).filter(t => t),
        vinculado_a_documento: vincularADocumento ? documentoActual?.id : null,
        carpeta: rutaNotasActual || '',
        fecha: ahora,
        fecha_creacion: ahora,
        fechaModificacion: ahora,
        sesion_id: sesionActual?.id || `session_${Date.now()}`,
        // Repetici√≥n espaciada
        proximaRevision: new Date().toISOString(),
        intervalo: 1,
        repeticiones: 0,
        facilidad: 2.5,
        estadoRevision: 'nueva'
      };
      
      // 1. Guardar usando el sistema per-carpeta
      await guardarNotaEnCarpeta(nuevaNota);
      const notasActualizadas = [...notasGuardadas, nuevaNota];
      setNotasGuardadas(notasActualizadas);
      
      // 2. Guardar como archivo .txt en el servidor
      const nombreArchivo = `${editorNotaTitulo.replace(/[^a-z0-9√°√©√≠√≥√∫√±\s]/gi, '_')}_${Date.now()}.txt`;
      const contenidoTxt = `${editorNotaTitulo}\n${'='.repeat(editorNotaTitulo.length)}\n\n${editorNotaContenido}\n\n---\nTags: ${editorNotaTags}\nFecha: ${new Date(ahora).toLocaleString('es-ES')}\nSesi√≥n: ${nuevaNota.sesion_id}`;
      
      const response = await fetch(`${API_URL}/api/guardar-nota-txt`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          carpeta: rutaNotasActual || 'notas',
          nombreArchivo: nombreArchivo,
          contenido: contenidoTxt
        })
      });
      
      if (!response.ok) {
        throw new Error('Error al guardar en el servidor');
      }
      
      // 3. Actualizar notas vinculadas si corresponde
      if (vincularADocumento && documentoActual) {
        setNotasVinculadas([...notasVinculadas, nuevaNota]);
      }
      
      setMensaje({
        tipo: 'success',
        texto: `‚úÖ Nota guardada en: ${rutaNotasActual || 'notas'}/${nombreArchivo}`
      });
      
      setEstadisticasSesion(prev => ({
        ...prev,
        notasTomadas: prev.notasTomadas + 1
      }));
      
      // Limpiar formulario
      setEditorNotaTitulo('');
      setEditorNotaContenido('');
      setEditorNotaTags('');
      
    } catch (error) {
      console.error('Error guardando nota:', error);
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al guardar nota: ' + error.message
      });
    } finally {
      setGuardandoNota(false);
    }
  };
  
  const convertirTextoEnFlashcards = async () => {
    if (!textoSeleccionadoFlashcard.trim()) {
      setMensaje({
        tipo: 'warning',
        texto: 'Selecciona texto para convertir en flashcards'
      });
      return;
    }
    
    try {
      const flashcardsNuevas = [];
      
      if (modoConversionFlashcard === 'linea') {
        // Dividir por l√≠neas numeradas
        const lineas = textoSeleccionadoFlashcard.split('\n').filter(l => l.trim());
        
        lineas.forEach((linea, index) => {
          // Detectar l√≠neas numeradas (ej: "1. Texto")
          const match = linea.match(/^\d+\.\s*(.+)$/);
          if (match) {
            flashcardsNuevas.push({
              id: `fc_${Date.now()}_${index}`,
              frente: `¬øCu√°l es el punto ${index + 1}?`,
              reverso: match[1].trim(),
              tema: editorNotaTitulo || 'General',
              tipo: 'clasica',
              carpeta: cursoActual?.nombre || 'General',
              fecha_creacion: new Date().toISOString()
            });
          }
        });
      } else if (modoConversionFlashcard === 'parrafo') {
        // Dividir por p√°rrafos
        const parrafos = textoSeleccionadoFlashcard.split('\n\n').filter(p => p.trim());
        
        parrafos.forEach((parrafo, index) => {
          flashcardsNuevas.push({
            id: `fc_${Date.now()}_${index}`,
            frente: `Explica el concepto ${index + 1}`,
            reverso: parrafo.trim(),
            tema: editorNotaTitulo || 'General',
            tipo: 'clasica',
            carpeta: cursoActual?.nombre || 'General',
            fecha_creacion: new Date().toISOString()
          });
        });
      }
      
      if (flashcardsNuevas.length === 0) {
        setMensaje({
          tipo: 'warning',
          texto: 'No se pudieron generar flashcards del texto seleccionado'
        });
        return;
      }
      
      // üî• GUARDAR CADA FLASHCARD EN SU CARPETA CORRESPONDIENTE
      try {
        for (const flashcard of flashcardsNuevas) {
          await guardarFlashcardEnCarpeta(flashcard);
        }
        
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ ${flashcardsNuevas.length} flashcards creadas en carpeta: ${flashcardsNuevas[0].carpeta}`
        });
      } catch (error) {
        console.error('Error guardando flashcards:', error);
        setMensaje({
          tipo: 'error',
          texto: '‚ùå Error al guardar flashcards'
        });
        return;
      }
      
      setModalFlashcardCreator(false);
      setTextoSeleccionadoFlashcard('');
      
    } catch (error) {
      console.error('Error creando flashcards:', error);
      setMensaje({
        tipo: 'error',
        texto: 'Error al crear flashcards'
      });
    }
  };
  
  const abrirNotaEnDrawer = (nota) => {
    setNotaEnDrawer(nota);
    setDrawerNotaAbierto(true);
  };
  
  const cerrarDrawerNota = () => {
    setDrawerNotaAbierto(false);
    setNotaEnDrawer(null);
  };
  
  const actualizarProgresoDocumento = (scrollPercentage) => {
    setProgresoDocumento(scrollPercentage);
    
    // Si scrollea m√°s del 50%, marcar como "en progreso"
    if (scrollPercentage > 50 && documentoActual) {
      // En producci√≥n: POST /api/session/update-progreso
      console.log(`Documento ${documentoActual.id} marcado como en progreso (${scrollPercentage}%)`);
    }
  };

  // üéØ FUNCIONES DEL MEN√ö DE COMANDOS ESTILO NOTION
  const comandosDisponibles = [
    { id: 'text', nombre: 'Text', icono: 'T', descripcion: 'Texto simple' },
    { id: 'h1', nombre: 'Heading 1', icono: 'H1', descripcion: '#' },
    { id: 'h2', nombre: 'Heading 2', icono: 'H2', descripcion: '##' },
    { id: 'h3', nombre: 'Heading 3', icono: 'H3', descripcion: '###' },
    { id: 'bullet', nombre: 'Bulleted list', icono: '‚Ä¢', descripcion: '-' },
    { id: 'numbered', nombre: 'Numbered list', icono: '1.', descripcion: '1.' },
    { id: 'todo', nombre: 'To-do list', icono: '‚òë', descripcion: '[]' },
    { id: 'toggle', nombre: 'Toggle list', icono: '‚ñ∏', descripcion: '>' },
    { id: 'page', nombre: 'Page', icono: 'üìÑ', descripcion: 'Subp√°gina' },
    { id: 'callout', nombre: 'Callout', icono: 'üí°', descripcion: 'Nota destacada' },
    { id: 'quote', nombre: 'Quote', icono: '‚ùù', descripcion: '> Cita' },
    { id: 'table', nombre: 'Table', icono: '‚äû', descripcion: 'Tabla simple' },
    { id: 'divider', nombre: 'Divider', icono: '‚Äî', descripcion: '---' },
    { id: 'link', nombre: 'Link to page', icono: 'üîó', descripcion: 'Enlace' },
    { id: 'image', nombre: 'Image', icono: 'üñºÔ∏è', descripcion: 'Imagen' },
    { id: 'video', nombre: 'Video', icono: '‚ñ∂Ô∏è', descripcion: 'Video' },
    { id: 'audio', nombre: 'Audio', icono: 'üîä', descripcion: 'Audio' },
    { id: 'code', nombre: 'Code', icono: '</>', descripcion: '```' },
    { id: 'file', nombre: 'File', icono: 'üìé', descripcion: 'Archivo adjunto' },
    { id: 'bookmark', nombre: 'Web bookmark', icono: 'üîñ', descripcion: 'URL' },
    { id: 'equation', nombre: 'Block equation', icono: '‚àë', descripcion: 'LaTeX' },
    { id: 'button', nombre: 'Button', icono: 'üîò', descripcion: 'Bot√≥n' },
    { id: 'breadcrumb', nombre: 'Breadcrumb', icono: '‚Üó', descripcion: 'Navegaci√≥n' },
    { id: 'synced', nombre: 'Synced block', icono: '‚ü≤', descripcion: 'Bloque sincronizado' },
    { id: 'toggle-h1', nombre: 'Toggle heading 1', icono: 'H1‚ñ∏', descripcion: '#>' },
    { id: 'toggle-h2', nombre: 'Toggle heading 2', icono: 'H2‚ñ∏', descripcion: '##>' },
    { id: 'toggle-h3', nombre: 'Toggle heading 3', icono: 'H3‚ñ∏', descripcion: '###>' },
    { id: 'col2', nombre: '2 columns', icono: '‚´¥', descripcion: 'Dos columnas' },
    { id: 'col3', nombre: '3 columns', icono: '‚´¥‚´¥', descripcion: 'Tres columnas' },
  ];

  const insertarBloque = (comando) => {
    const textarea = document.querySelector('.editor-inline-content');
    if (!textarea) return;

    const start = cursorPosition;
    const antes = editorNotaContenido.substring(0, start);
    const despues = editorNotaContenido.substring(start);
    
    let bloqueTexto = '';
    
    switch (comando.id) {
      case 'text':
        bloqueTexto = '';
        break;
      case 'h1':
        bloqueTexto = '# T√≠tulo Principal\n';
        break;
      case 'h2':
        bloqueTexto = '## Subt√≠tulo\n';
        break;
      case 'h3':
        bloqueTexto = '### Secci√≥n\n';
        break;
      case 'bullet':
        bloqueTexto = '‚Ä¢ Elemento de lista\n';
        break;
      case 'numbered':
        bloqueTexto = '1. Primer elemento\n';
        break;
      case 'todo':
        bloqueTexto = '- [ ] Tarea pendiente\n';
        break;
      case 'toggle':
        bloqueTexto = '‚ñ∏ Click para expandir\n  Contenido oculto aqu√≠\n';
        break;
      case 'page':
        bloqueTexto = 'üìÑ [[Nueva P√°gina]]\n';
        break;
      case 'callout':
        bloqueTexto = 'üí° **Nota importante:**\nContenido destacado aqu√≠\n';
        break;
      case 'quote':
        bloqueTexto = '> Cita o referencia importante\n';
        break;
      case 'table':
        bloqueTexto = '| Columna 1 | Columna 2 | Columna 3 |\n|-----------|-----------|--------|\n| Dato 1    | Dato 2    | Dato 3 |\n';
        break;
      case 'divider':
        bloqueTexto = '\n---\n\n';
        break;
      case 'link':
        bloqueTexto = '[Texto del enlace](URL)\n';
        break;
      case 'image':
        bloqueTexto = '![Descripci√≥n de imagen](URL_de_imagen)\n';
        break;
      case 'video':
        bloqueTexto = 'üé¨ [Video: T√≠tulo](URL_video)\n';
        break;
      case 'audio':
        bloqueTexto = 'üîä [Audio: T√≠tulo](URL_audio)\n';
        break;
      case 'code':
        bloqueTexto = '```javascript\n// Tu c√≥digo aqu√≠\nconsole.log("Hello World");\n```\n';
        break;
      case 'file':
        bloqueTexto = 'üìé [Nombre del archivo.pdf](ruta/archivo)\n';
        break;
      case 'bookmark':
        bloqueTexto = 'üîñ **[T√≠tulo del sitio](https://ejemplo.com)**\nDescripci√≥n del enlace\n';
        break;
      case 'equation':
        bloqueTexto = '$$\nE = mc^2\n$$\n';
        break;
      case 'button':
        bloqueTexto = '[üîò Bot√≥n de Acci√≥n](#accion)\n';
        break;
      case 'breadcrumb':
        bloqueTexto = '‚Üó Inicio > Categor√≠a > Subcategor√≠a\n';
        break;
      case 'synced':
        bloqueTexto = '‚ü≤ [Bloque Sincronizado]\nContenido que se refleja en otros lugares\n';
        break;
      case 'toggle-h1':
        bloqueTexto = '# ‚ñ∏ T√≠tulo Expandible\nContenido oculto aqu√≠\n';
        break;
      case 'toggle-h2':
        bloqueTexto = '## ‚ñ∏ Subt√≠tulo Expandible\nContenido oculto aqu√≠\n';
        break;
      case 'toggle-h3':
        bloqueTexto = '### ‚ñ∏ Secci√≥n Expandible\nContenido oculto aqu√≠\n';
        break;
      case 'col2':
        bloqueTexto = '\n[COLUMNA 1]          [COLUMNA 2]\nContenido izq.       Contenido der.\n\n';
        break;
      case 'col3':
        bloqueTexto = '\n[COL 1]        [COL 2]        [COL 3]\nContenido 1    Contenido 2    Contenido 3\n\n';
        break;
      default:
        bloqueTexto = '';
    }
    
    // Eliminar el "/" que activ√≥ el men√∫
    const textoSinSlash = antes.endsWith('/') ? antes.slice(0, -1) : antes;
    setEditorNotaContenido(textoSinSlash + bloqueTexto + despues);
    
    // Cerrar men√∫
    setMenuComandosAbierto(false);
    
    // Enfocar textarea
    setTimeout(() => {
      textarea.focus();
      const newPos = textoSinSlash.length + bloqueTexto.length;
      textarea.setSelectionRange(newPos, newPos);
    }, 0);
  };
  
  const limpiarEditorNotas = () => {
    if (editorNotaContenido.trim() && !window.confirm('¬øSeguro que quieres limpiar el editor? Perder√°s el texto no guardado.')) {
      return;
    }
    
    setEditorNotaTitulo('');
    setEditorNotaContenido('');
    setEditorNotaTags('');
  };
  
  // Renderizar contenido estilo Notion
  const renderizarContenidoNotion = (texto) => {
    if (!texto) return '';
    
    let html = texto;
    
    // Headers
    html = html.replace(/^### (.+)$/gm, '<h3 class="notion-h3">$1</h3>');
    html = html.replace(/^## (.+)$/gm, '<h2 class="notion-h2">$1</h2>');
    html = html.replace(/^# (.+)$/gm, '<h1 class="notion-h1">$1</h1>');
    
    // Listas
    html = html.replace(/^‚Ä¢ (.+)$/gm, '<li class="notion-li">$1</li>');
    html = html.replace(/^- \[ \] (.+)$/gm, '<div class="notion-todo"><input type="checkbox" disabled /> <span>$1</span></div>');
    html = html.replace(/^- \[x\] (.+)$/gm, '<div class="notion-todo done"><input type="checkbox" checked disabled /> <span>$1</span></div>');
    html = html.replace(/^\d+\. (.+)$/gm, '<li class="notion-ol">$1</li>');
    
    // Callout
    html = html.replace(/üí° \*\*(.+?):\*\*\n(.+)/g, '<div class="notion-callout"><div class="callout-icon">üí°</div><div class="callout-content"><strong>$1</strong><br/>$2</div></div>');
    
    // Quote
    html = html.replace(/^> (.+)$/gm, '<blockquote class="notion-quote">$1</blockquote>');
    
    // Divider
    html = html.replace(/^---$/gm, '<hr class="notion-divider" />');
    
    // Code block
    html = html.replace(/```(\w+)?\n([\s\S]+?)```/g, '<pre class="notion-code"><code>$2</code></pre>');
    
    // Inline code
    html = html.replace(/`([^`]+)`/g, '<code class="notion-inline-code">$1</code>');
    
    // Bold
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    
    // Italic
    html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
    
    // Links
    html = html.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" class="notion-link" target="_blank">$1</a>');
    
    // Paragraphs
    html = html.replace(/^(?!<[h|l|d|b|p])(.+)$/gm, '<p class="notion-p">$1</p>');
    
    return html;
  };
  
  // Auto-save de notas cada 30 segundos
  useEffect(() => {
    if (faseActual === 'contenido' && tabContenidoActivo === 2 && editorNotaContenido.trim()) {
      const timer = setTimeout(() => {
        // Auto-save en localStorage
        localStorage.setItem('nota_autosave', JSON.stringify({
          titulo: editorNotaTitulo,
          contenido: editorNotaContenido,
          tags: editorNotaTags,
          fecha: new Date().toISOString()
        }));
        console.log('Auto-save realizado');
      }, 30000);
      
      return () => clearTimeout(timer);
    }
  }, [editorNotaContenido, editorNotaTitulo, editorNotaTags, faseActual, tabContenidoActivo]);
  
  // Cargar contenido al entrar en Fase 4
  useEffect(() => {
    if (faseActual === 'contenido' && !documentoActual) {
      cargarContenidoFase4();
    }
  }, [faseActual]);
  
  // ============================================
  // üéØ FUNCIONES FASE 5 - CIERRE/RESUMEN
  // ============================================
  
  const prepararResumenSesion = () => {
    const ahora = Date.now();
    const tiempoFinSesionMs = ahora;
    
    // Calcular tiempo total en minutos
    const tiempoTotalMs = tiempoFinSesionMs - tiempoInicioSesion;
    const tiempoTotalMin = Math.floor(tiempoTotalMs / 60000);
    
    // Calcular tiempo efectivo (sin pausas)
    const tiempoEfectivoMin = tiempoTotalMin - tiempoPausaTotal;
    
    // Filtrar documentos estudiados (progreso > 25%)
    const docsEstudiados = documentoActual && progresoDocumento > 25 ? 1 : 0;
    
    const resumen = {
      tiempoEfectivo: tiempoEfectivoMin,
      tiempoTotal: tiempoTotalMin,
      tiempoPausa: tiempoPausaTotal,
      erroresReforzados: estadisticasSesion.erroresReforzados,
      flashcardsRepasadas: estadisticasSesion.flashcardsRepasadas,
      documentosEstudiados: docsEstudiados,
      notasCreadas: estadisticasSesion.notasTomadas,
      practicasCompletadas: estadisticasSesion.practicasHechas
    };
    
    setResumenSesion(resumen);
    setTiempoFinSesion(ahora);
    
    // Cargar recomendaciones
    cargarRecomendacionesSesion();
  };
  
  const cargarRecomendacionesSesion = async () => {
    try {
      // Simulaci√≥n de recomendaciones basadas en la sesi√≥n
      // En producci√≥n: GET /api/session/recommendations
      
      const recomendaciones = [];
      
      // Si hay errores no trabajados, recomendar
      if (estadisticasSesion.erroresReforzados < erroresActuales.length) {
        const pendientes = erroresActuales.length - estadisticasSesion.erroresReforzados;
        recomendaciones.push({
          tipo: 'errores',
          texto: `Repasar ${pendientes} errores pendientes`,
          prioridad: 'alta'
        });
      }
      
      // Si hay flashcards en el sistema, recomendar revisi√≥n
      const flashcardsTotal = JSON.parse(localStorage.getItem('flashcards') || '[]').length;
      if (flashcardsTotal > 0) {
        recomendaciones.push({
          tipo: 'flashcards',
          texto: `${flashcardsTotal} flashcards disponibles para revisar`,
          cantidad: flashcardsTotal
        });
      }
      
      // Si hay curso actual, recomendar continuar
      if (cursoActual) {
        recomendaciones.push({
          tipo: 'contenido',
          texto: `Continuar "${cursoActual.nombre}" (${cursoActual.progreso_curso}% completado)`,
          curso_id: cursoActual.id,
          progreso: cursoActual.progreso_curso
        });
      }
      
      setRecomendacionesSesion(recomendaciones);
      
    } catch (error) {
      console.error('Error cargando recomendaciones:', error);
    }
  };
  
  const finalizarYGuardarSesion = async () => {
    setGuardandoSesion(true);
    
    try {
      // Construir payload completo
      const payload = {
        sesion_id: `session_${tiempoInicioSesion}`,
        usuario_id: 'user_123', // En producci√≥n vendr√≠a del contexto de usuario
        fecha_inicio: new Date(tiempoInicioSesion).toISOString(),
        fecha_fin: new Date(tiempoFinSesion || Date.now()).toISOString(),
        configuracion: {
          duracion_planificada: tiempoSesion,
          prioridad: prioridadSesion
        },
        tiempos: {
          total_minutos: resumenSesion.tiempoTotal,
          pausa_minutos: resumenSesion.tiempoPausa,
          efectivo_minutos: resumenSesion.tiempoEfectivo
        },
        actividades: {
          errores_reforzados: resumenSesion.erroresReforzados,
          flashcards_repasadas: resumenSesion.flashcardsRepasadas,
          documentos_estudiados: documentoActual ? [{
            id: documentoActual.id,
            titulo: documentoActual.titulo,
            progreso: progresoDocumento
          }] : [],
          notas_creadas: resumenSesion.notasCreadas,
          practicas_completadas: resumenSesion.practicasCompletadas
        },
        reflexion: {
          dificil: reflexionDificil,
          revisar_manana: reflexionManana
        }
      };
      
      // Guardar en archivo (en producci√≥n: POST /api/session/finalize)
      const sesionesGuardadas = await getSesionesCompletadas();
      sesionesGuardadas.push(payload);
      await setSesionesCompletadas(sesionesGuardadas);
      
      // Simular delay de red
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      setMensaje({
        tipo: 'success',
        texto: '‚úÖ Sesi√≥n guardada exitosamente'
      });
      
      // Esperar 1 segundo antes de redirect
      setTimeout(() => {
        redirigirAInicioDesdeResumen();
      }, 1000);
      
    } catch (error) {
      console.error('Error guardando sesi√≥n:', error);
      setMensaje({
        tipo: 'error',
        texto: 'Error al guardar sesi√≥n. Intenta nuevamente.'
      });
    } finally {
      setGuardandoSesion(false);
    }
  };
  
  const redirigirAInicioDesdeResumen = async () => {
    console.log('üèÅ Finalizando sesi√≥n y limpiando todo...');
    
    // üî• CR√çTICO: Detener PRIMERO sesionActiva para que los useEffect dejen de ejecutarse
    setSesionActiva(false);
    
    // Peque√±a espera para que React procese el cambio de estado
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // 1Ô∏è‚É£ Cambiar men√∫ para ocultar indicadores visuales
    setSelectedMenu('inicio');
    
    // 2Ô∏è‚É£ Limpiar estado de sesi√≥n completo (igual que detenerSesion)
    setTiempoRestante(0);
    setFaseActual(null);
    setIndiceFaseActual(0);
    setSesionPausada(false);
    setTiempoHastaDescanso(1500); // Resetear contador de descanso
    setEnDescanso(false);
    setTimestampInicioPausa(null);
    setTiempoFaseActual(0);
    setTiempoTotalEfectivo(0);
    setTiempoAcumuladoEstudio(0);
    setTiempoPausaRestante(0);
    
    // 3Ô∏è‚É£ Limpiar estad√≠sticas
    setEstadisticasSesion({
      erroresReforzados: 0,
      flashcardsRepasadas: 0,
      practicasHechas: 0,
      notasTomadas: 0
    });
    
    // 4Ô∏è‚É£ Limpiar datos de fases
    setErroresActuales([]);
    setFlashcardsSesion([]);
    setDocumentoActual(null);
    setCursoActual(null);
    setNotasVinculadas([]);
    setFasesSesion([]);
    setIndiceErrorActual(0);
    setIndiceFlashcardActual(0);
    
    // 5Ô∏è‚É£ Limpiar datos de resumen
    setResumenSesion(null);
    setReflexionDificil('');
    setReflexionManana('');
    setRecomendacionesSesion([]);
    setTiempoInicioSesion(null);
    setTiempoFinSesion(null);
    setTiempoPausaTotal(0);
    
    // 6Ô∏è‚É£ ELIMINAR SESI√ìN GUARDADA DEL BACKEND Y LOCALSTORAGE
    try {
      // Eliminar del backend
      const response = await fetch(`${API_URL}/sesion`, {
        method: 'DELETE'
      });
      
      if (response.ok) {
        console.log('‚úÖ Sesi√≥n eliminada del backend');
      }
      
      // Eliminar de localStorage
      localStorage.removeItem('examinator_sesion_activa');
      setSesionPersistente(null);
      
      console.log('‚úÖ Sesi√≥n finalizada y eliminada completamente');
    } catch (error) {
      console.error('‚ùå Error eliminando sesi√≥n al finalizar:', error);
      // Aunque falle el backend, limpiamos localStorage
      localStorage.removeItem('examinator_sesion_activa');
      setSesionPersistente(null);
    }
  };
  
  // Tracking de pausas para c√°lculo de tiempo efectivo
  useEffect(() => {
    if (sesionPausada && !timestampInicioPausa) {
      // Usuario acaba de pausar
      setTimestampInicioPausa(Date.now());
    } else if (!sesionPausada && timestampInicioPausa) {
      // Usuario acaba de reanudar
      const tiempoPausaMs = Date.now() - timestampInicioPausa;
      const tiempoPausaMin = Math.floor(tiempoPausaMs / 60000);
      setTiempoPausaTotal(prev => prev + tiempoPausaMin);
      setTimestampInicioPausa(null);
    }
  }, [sesionPausada]);
  
  // Actualizar contador de pausa cada segundo
  useEffect(() => {
    if (sesionPausada && timestampInicioPausa) {
      const intervalo = setInterval(() => {
        setContadorPausaActualizado(Date.now());
      }, 1000);
      return () => clearInterval(intervalo);
    }
  }, [sesionPausada, timestampInicioPausa]);

  // Cargar estado del √≠ndice del buscador al inicio
  useEffect(() => {
    if (selectedMenu === 'buscar') {
      cargarEstadoIndice();
    }
  }, [selectedMenu]);
  
  // Preparar resumen al entrar en Fase 5
  useEffect(() => {
    if (faseActual === 'cierre' && !resumenSesion) {
      prepararResumenSesion();
    }
  }, [faseActual]);
  
  // Guardar timestamp de inicio de sesi√≥n
  useEffect(() => {
    if (sesionActiva && !tiempoInicioSesion) {
      setTiempoInicioSesion(Date.now());
    }
  }, [sesionActiva]);
  
  // ============================================
  // FIN FUNCIONES FASE 5
  // ============================================
  
  // ============================================
  // FUNCIONES DE PERSISTENCIA DE SESI√ìN
  // ============================================
  
  const guardarEstadoSesion = async () => {
    if (!sesionActiva) return;
    
    const estadoCompleto = {
      version: '1.0',
      timestamp: Date.now(),
      expiracion: Date.now() + (24 * 60 * 60 * 1000), // 24 horas
      
      // Configuraci√≥n b√°sica
      configuracion: {
        tiempoSesion,
        tiempoPersonalizado,
        modoLibreActivo,
        prioridadSesion
      },
      
      // Estado de la sesi√≥n
      estado: {
        sesionActiva,
        sesionPausada,
        faseActual,
        indiceFaseActual,
        tiempoRestante,
        tiempoFaseActual,
        tiempoTotalEfectivo,
        tiempoPausaTotal,
        tiempoInicioSesion,
        timestampInicioPausa
      },
      
      // Fases planificadas
      fases: fasesSesion,
      
      // Estad√≠sticas
      estadisticas: estadisticasSesion,
      
      // Datos de cada fase
      datos: {
        calentamiento: datosCalentamiento,
        errores: {
          lista: erroresActuales,
          indiceActual: indiceErrorActual
        },
        flashcards: {
          lista: flashcardsSesion,
          indiceActual: indiceFlashcardActual
        },
        contenido: {
          tab: tabContenidoActivo,
          documento: documentoActual,
          curso: cursoActual,
          notasVinculadas,
          practicaGenerada,
          historialPracticas,
          progresoDocumento,
          scrollPositions
        },
        cierre: {
          resumen: resumenSesion,
          reflexionDificil,
          reflexionManana,
          recomendaciones: recomendacionesSesion
        }
      },
      
      // Notas en progreso
      notasEnProgreso: {
        titulo: editorNotaTitulo,
        contenido: editorNotaContenido,
        tags: editorNotaTags
      }
    };
    
    try {
      await setSesionActiva(estadoCompleto);
      setEstadoGuardado(true);
      setTimeout(() => setEstadoGuardado(false), 2000);
      console.log('‚úÖ Estado de sesi√≥n guardado correctamente');
    } catch (error) {
      console.error('‚ùå Error guardando estado de sesi√≥n:', error);
    }
  };
  
  const cargarEstadoSesion = async () => {
    try {
      const estado = await getSesionActiva();
      if (!estado || Object.keys(estado).length === 0) return null;
      
      // Verificar expiraci√≥n (24 horas)
      if (Date.now() > estado.expiracion) {
        console.log('‚è∞ Sesi√≥n expirada, eliminando...');
        await setSesionActiva({});
        return null;
      }
      
      return estado;
    } catch (error) {
      console.error('‚ùå Error cargando estado de sesi√≥n:', error);
      return null;
    }
  };
  
  const restaurarSesion = (estado) => {
    if (!estado) return;
    
    try {
      // Restaurar configuraci√≥n
      setTiempoSesion(estado.configuracion.tiempoSesion);
      setTiempoPersonalizado(estado.configuracion.tiempoPersonalizado || '');
      setModoLibreActivo(estado.configuracion.modoLibreActivo || false);
      setPrioridadSesion(estado.configuracion.prioridadSesion);
      
      // Restaurar estado de sesi√≥n
      setSesionActiva(estado.estado.sesionActiva);
      setSesionPausada(estado.estado.sesionPausada);
      setFaseActual(estado.estado.faseActual);
      setIndiceFaseActual(estado.estado.indiceFaseActual);
      setTiempoRestante(estado.estado.tiempoRestante);
      setTiempoFaseActual(estado.estado.tiempoFaseActual);
      setTiempoTotalEfectivo(estado.estado.tiempoTotalEfectivo);
      setTiempoPausaTotal(estado.estado.tiempoPausaTotal || 0);
      setTiempoInicioSesion(estado.estado.tiempoInicioSesion);
      setTimestampInicioPausa(estado.estado.timestampInicioPausa);
      
      // Restaurar fases
      setFasesSesion(estado.fases || []);
      
      // Restaurar estad√≠sticas
      setEstadisticasSesion(estado.estadisticas || {
        erroresReforzados: 0,
        flashcardsRepasadas: 0,
        practicasHechas: 0,
        notasTomadas: 0
      });
      
      // Restaurar datos de fases
      if (estado.datos) {
        setDatosCalentamiento(estado.datos.calentamiento);
        
        if (estado.datos.errores) {
          setErroresActuales(estado.datos.errores.lista || []);
          setIndiceErrorActual(estado.datos.errores.indiceActual || 0);
        }
        
        if (estado.datos.flashcards) {
          setFlashcardsSesion(estado.datos.flashcards.lista || []);
          setIndiceFlashcardActual(estado.datos.flashcards.indiceActual || 0);
        }
        
        if (estado.datos.contenido) {
          setTabContenidoActivo(estado.datos.contenido.tab || 0);
          setDocumentoActual(estado.datos.contenido.documento);
          setCursoActual(estado.datos.contenido.curso);
          setNotasVinculadas(estado.datos.contenido.notasVinculadas || []);
          setPracticaGenerada(estado.datos.contenido.practicaGenerada);
          setHistorialPracticas(estado.datos.contenido.historialPracticas || []);
          setProgresoDocumento(estado.datos.contenido.progresoDocumento || 0);
          setScrollPositions(estado.datos.contenido.scrollPositions || { 0: 0, 1: 0, 2: 0 });
        }
        
        if (estado.datos.cierre) {
          setResumenSesion(estado.datos.cierre.resumen);
          setReflexionDificil(estado.datos.cierre.reflexionDificil || '');
          setReflexionManana(estado.datos.cierre.reflexionManana || '');
          setRecomendacionesSesion(estado.datos.cierre.recomendaciones || []);
        }
      }
      
      // Restaurar notas en progreso
      if (estado.notasEnProgreso) {
        setEditorNotaTitulo(estado.notasEnProgreso.titulo || '');
        setEditorNotaContenido(estado.notasEnProgreso.contenido || '');
        setEditorNotaTags(estado.notasEnProgreso.tags || '');
      }
      
      // Cambiar a vista de sesi√≥n
      setSelectedMenu('sesion');
      setSesionPersistente(estado);
      
      console.log('‚úÖ Sesi√≥n restaurada correctamente');
      
    } catch (error) {
      console.error('‚ùå Error restaurando sesi√≥n:', error);
    }
  };
  
  const eliminarSesionGuardada = async () => {
    try {
      // Eliminar del backend (getDatos/setDatos)
      await setSesionActiva({});
      // Eliminar del localStorage (legacy)
      localStorage.removeItem('examinator_sesion_activa');
      // Limpiar estado local
      setSesionPersistente(null);
      console.log('üóëÔ∏è Sesi√≥n guardada eliminada completamente');
    } catch (error) {
      console.error('‚ùå Error eliminando sesi√≥n:', error);
    }
  };
  
  // Auto-guardado cada 2 minutos cuando hay sesi√≥n activa
  useEffect(() => {
    let intervalo;
    
    // üî• CR√çTICO: Solo ejecutar si sesionActiva es true
    if (!sesionActiva) {
      if (intervalo) clearInterval(intervalo);
      return;
    }
    
    if (sesionActiva && !sesionPausada) {
      intervalo = setInterval(() => {
        guardarEstadoSesion();
      }, 120000); // 120000ms = 2 minutos
    }
    
    return () => {
      if (intervalo) {
        clearInterval(intervalo);
        console.log('‚èπÔ∏è Auto-guardado detenido');
      }
    };
  }, [sesionActiva, sesionPausada, faseActual, tiempoRestante, estadisticasSesion]);
  
  // Guardar estado cuando cambia de fase o se pausa
  useEffect(() => {
    if (sesionActiva) {
      guardarEstadoSesion();
    }
  }, [faseActual, sesionPausada]);

  // üî• GUARDAR ESTADO AL CAMBIAR DE MEN√ö (para no perder progreso)
  useEffect(() => {
    if (sesionActiva && selectedMenu !== 'sesion') {
      console.log('üíæ Guardando sesi√≥n antes de cambiar de men√∫...');
      guardarEstadoSesion();
    }
  }, [selectedMenu]);
  
  // Detectar sesi√≥n guardada al montar el componente
  useEffect(() => {
    const sesionGuardada = cargarEstadoSesion();
    if (sesionGuardada) {
      setSesionPersistente(sesionGuardada);
      // Mostrar modal de confirmaci√≥n en el UI
      console.log('üîÑ Sesi√≥n guardada detectada');
    }
  }, []);
  
  // ============================================
  // FIN FUNCIONES DE PERSISTENCIA
  // ============================================
  
  // ============================================
  // FIN FUNCIONES FASE 4
  // ============================================
  
  const evaluarFlashcard_old = (dificultad) => {
    // dificultad: 'facil', 'medio', 'dificil'
    setEstadisticasSesion(prev => ({
      ...prev,
      flashcardsRepasadas: prev.flashcardsRepasadas + 1
    }));
    
    // Resetear estado de volteo para la siguiente flashcard
    setFlashcardsVolteadas({});
    
    if (indiceFlashcardActual < flashcardsSesion.length - 1) {
      setIndiceFlashcardActual(indiceFlashcardActual + 1);
    } else {
      // No hay m√°s flashcards, avanzar fase
      avanzarFase();
    }
  };
  
  // ============================================
  // FIN FUNCIONES DEL MODO SESI√ìN
  // ============================================
  
  // Obtener todos los archivos recursivamente de una carpeta
  const obtenerArchivosRecursivos = async (ruta) => {
    try {
      const response = await fetch(`${API_URL}/api/carpetas/archivos-recursivos?ruta=${encodeURIComponent(ruta)}`);
      const data = await response.json();
      return data.archivos || [];
    } catch (error) {
      console.error('Error obteniendo archivos:', error);
      return [];
    }
  };
  
  // Abrir modal de selecci√≥n de archivos para generar examen
  const abrirGenerarExamenCarpeta = async (ruta, tipo) => {
    setMenuDropdownAbierto(false);
    setGenerandoExamen(true);
    setMensaje({
      tipo: 'info',
      texto: 'üîç Buscando archivos en todas las subcarpetas...'
    });
    
    // Obtener todos los archivos recursivamente
    const archivos = await obtenerArchivosRecursivos(ruta);
    
    if (archivos.length === 0) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå No se encontraron archivos en esta carpeta'
      });
      setGenerandoExamen(false);
      return;
    }
    
    // Extraer nombre de carpeta desde la ruta
    const nombreCarpeta = ruta.split(/[/\\]/).filter(Boolean).pop() || 'Sin nombre';
    
    setArchivosEncontrados(archivos);
    setArchivosExcluidos([]);
    setTipoCarpeta(tipo);
    setCarpetaExamen({ ruta, nombre: nombreCarpeta });
    setModalSeleccionArchivos(true);
    setGenerandoExamen(false);
    
    setMensaje({
      tipo: 'success',
      texto: `‚úÖ Se encontraron ${archivos.length} archivos`
    });
  };
  
  // Generar examen por bloques
  const generarExamenPorBloques = async () => {
    setModalSeleccionArchivos(false);
    setGenerandoExamenPorBloques(true);
    setProgresoGeneracion(0);
    
    // Filtrar archivos no excluidos
    const archivosIncluidos = archivosEncontrados.filter(
      archivo => !archivosExcluidos.includes(archivo.ruta)
    );
    
    if (archivosIncluidos.length === 0) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Debes seleccionar al menos un archivo'
      });
      setGenerandoExamenPorBloques(false);
      return;
    }
    
    try {
      const totalPreguntasDeseadas = configExamenCarpeta.num_multiple + 
                                     configExamenCarpeta.num_corta + 
                                     configExamenCarpeta.num_vf + 
                                     configExamenCarpeta.num_desarrollo;
      
      // Si hay pocos archivos (<=10), generar todo de una vez
      if (archivosIncluidos.length <= 10) {
        setTotalBloques(1);
        setBloqueActual(1);
        setMensajeProgreso(`Generando ${totalPreguntasDeseadas} preguntas desde ${archivosIncluidos.length} archivos...`);
        setProgresoGeneracion(50);
        
        // Llamar al endpoint con TODOS los archivos
        const response = await fetch(`${API_URL}/api/generar_examen_bloque`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            archivos: archivosIncluidos.map(a => a.ruta),
            config: {
              num_multiple: configExamenCarpeta.num_multiple,
              num_corta: configExamenCarpeta.num_corta,
              num_vf: configExamenCarpeta.num_vf,
              num_desarrollo: configExamenCarpeta.num_desarrollo
            }
          })
        });
        
        if (!response.ok) {
          throw new Error('Error generando examen');
        }
        
        const data = await response.json();
        setProgresoGeneracion(100);
        
        setPreguntasExamen(data.preguntas || []);
        setRespuestasUsuario({});
        setExamenCompletado(false);
        setModalExamenAbierto(true);
        
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Examen generado con ${data.preguntas?.length || 0} preguntas`
        });
        
        return;
      }
      
      // Para muchos archivos (>10), dividir en bloques
      const tama√±oBloque = 5;
      const bloques = [];
      for (let i = 0; i < archivosIncluidos.length; i += tama√±oBloque) {
        bloques.push(archivosIncluidos.slice(i, i + tama√±oBloque));
      }
      
      setTotalBloques(bloques.length);
      const todasLasPreguntas = [];
      
      // Usar la variable ya declarada arriba
      const preguntasPorBloque = Math.ceil(totalPreguntasDeseadas / bloques.length);
      
      // Ajustar config para cada bloque (floor para evitar exceso)
      const configPorBloque = {
        num_multiple: Math.floor(configExamenCarpeta.num_multiple / bloques.length),
        num_corta: Math.floor(configExamenCarpeta.num_corta / bloques.length),
        num_vf: Math.floor(configExamenCarpeta.num_vf / bloques.length),
        num_desarrollo: Math.floor(configExamenCarpeta.num_desarrollo / bloques.length)
      };
      
      // Calcular residuos para distribuir en los primeros bloques
      const residuos = {
        num_multiple: configExamenCarpeta.num_multiple % bloques.length,
        num_corta: configExamenCarpeta.num_corta % bloques.length,
        num_vf: configExamenCarpeta.num_vf % bloques.length,
        num_desarrollo: configExamenCarpeta.num_desarrollo % bloques.length
      };
      
      // Procesar cada bloque
      for (let i = 0; i < bloques.length; i++) {
        setBloqueActual(i + 1);
        setMensajeProgreso(`Procesando bloque ${i + 1} de ${bloques.length}...`);
        setProgresoGeneracion(Math.round(((i + 1) / bloques.length) * 100));
        
        const bloque = bloques[i];
        
        // Config para este bloque espec√≠fico (agregar residuos a los primeros bloques)
        const configBloqueActual = {
          num_multiple: configPorBloque.num_multiple + (i < residuos.num_multiple ? 1 : 0),
          num_corta: configPorBloque.num_corta + (i < residuos.num_corta ? 1 : 0),
          num_vf: configPorBloque.num_vf + (i < residuos.num_vf ? 1 : 0),
          num_desarrollo: configPorBloque.num_desarrollo + (i < residuos.num_desarrollo ? 1 : 0)
        };
        
        // Llamar al endpoint para generar preguntas de este bloque
        const response = await fetch(`${API_URL}/api/generar_examen_bloque`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            archivos: bloque.map(a => a.ruta),
            config: configBloqueActual  // Usar config ajustada para este bloque
          })
        });
        
        if (!response.ok) {
          throw new Error(`Error en bloque ${i + 1}`);
        }
        
        const data = await response.json();
        if (data.preguntas) {
          todasLasPreguntas.push(...data.preguntas);
        }
      }
      
      // Seleccionar las mejores preguntas
      setMensajeProgreso('Seleccionando las mejores preguntas...');
      const totalDeseado = configExamenCarpeta.num_multiple + 
                          configExamenCarpeta.num_corta + 
                          configExamenCarpeta.num_vf + 
                          configExamenCarpeta.num_desarrollo;
      
      const preguntasSeleccionadas = seleccionarMejoresPreguntas(todasLasPreguntas, totalDeseado, configExamenCarpeta);
      
      setPreguntasExamen(preguntasSeleccionadas);
      setRespuestasUsuario({});
      setExamenCompletado(false);
      setModalExamenAbierto(true);
      
      setMensaje({
        tipo: 'success',
        texto: `‚úÖ Examen generado con ${preguntasSeleccionadas.length} preguntas`
      });
      
    } catch (error) {
      console.error('Error generando examen:', error);
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      });
    } finally {
      setGenerandoExamenPorBloques(false);
      setBloqueActual(0);
      setTotalBloques(0);
      setProgresoGeneracion(0);
    }
  };
  
  // Seleccionar las mejores preguntas (diversidad y relevancia)
  const seleccionarMejoresPreguntas = (preguntas, total, config) => {
    const seleccionadas = [];
    
    // Separar por tipo (aceptando variantes normalizadas del backend)
    const porTipo = {
      'multiple': preguntas.filter(p => p.tipo === 'multiple' || p.tipo === 'mcq'),
      'corta': preguntas.filter(p => p.tipo === 'corta' || p.tipo === 'short_answer'),
      'verdadero-falso': preguntas.filter(p => p.tipo === 'verdadero-falso' || p.tipo === 'true_false'),
      'desarrollo': preguntas.filter(p => p.tipo === 'desarrollo' || p.tipo === 'open_question')
    };
    
    // Seleccionar aleatoriamente de cada tipo
    if (config.num_multiple > 0) {
      seleccionadas.push(...seleccionarAleatorias(porTipo['multiple'], config.num_multiple));
    }
    if (config.num_corta > 0) {
      seleccionadas.push(...seleccionarAleatorias(porTipo['corta'], config.num_corta));
    }
    if (config.num_vf > 0) {
      seleccionadas.push(...seleccionarAleatorias(porTipo['verdadero-falso'], config.num_vf));
    }
    if (config.num_desarrollo > 0) {
      seleccionadas.push(...seleccionarAleatorias(porTipo['desarrollo'], config.num_desarrollo));
    }
    
    return seleccionadas;
  };
  
  // Seleccionar N elementos aleatorios de un array
  const seleccionarAleatorias = (array, n) => {
    const copia = [...array];
    const resultado = [];
    const cantidad = Math.min(n, copia.length);
    
    for (let i = 0; i < cantidad; i++) {
      const indice = Math.floor(Math.random() * copia.length);
      resultado.push(copia[indice]);
      copia.splice(indice, 1);
    }
    
    return resultado;
  };

  // Eliminar carpeta de ex√°menes
  const eliminarCarpetaExamenes = async (ruta, nombre) => {
    const confirmMsg = `¬øEliminar la carpeta de ex√°menes "${nombre}"?\n\nSe eliminar√°n TODOS los ex√°menes dentro (completados y en progreso).`
    if (!confirm(confirmMsg)) return

    try {
      const response = await fetch(`${API_URL}/api/examenes/carpeta?ruta=${encodeURIComponent(ruta)}&forzar=true`, {
        method: 'DELETE'
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: '‚úÖ Carpeta de ex√°menes eliminada'
        })
        cargarCarpetasExamenes(rutaActualExamenes)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå ${error.message}`
      })
    }
  }

  // Eliminar examen individual
  const eliminarExamen = async (examen, tipo) => {
    const tipoTexto = tipo === 'progreso' ? 'en progreso' : 'completado'
    const confirmMsg = `¬øEliminar el examen ${tipoTexto} "${examen.carpeta_nombre}"?`
    if (!confirm(confirmMsg)) return

    try {
      // Determinar el nombre del archivo seg√∫n el tipo
      let nombreArchivo
      if (tipo === 'progreso') {
        // Los ex√°menes en progreso est√°n en examenes_progreso/
        nombreArchivo = examen.archivo || `examen_progreso_${examen.id}.json`
      } else {
        // Los ex√°menes completados est√°n en la ra√≠z de la carpeta
        nombreArchivo = examen.archivo || `examen_${examen.id}.json`
      }

      const ruta = examen.carpeta_ruta || rutaActualExamenes
      const response = await fetch(`${API_URL}/api/examenes/examen?ruta=${encodeURIComponent(ruta)}&archivo=${encodeURIComponent(nombreArchivo)}`, {
        method: 'DELETE'
      })

      const data = await response.json()
      if (data.success) {
        // Si era un examen en progreso, limpiar tambi√©n el temporal
        if (tipo === 'progreso') {
          await limpiarExamenLocal()
          // Si es el examen activo, cerrarlo
          if (examenActivo) {
            setExamenActivo(false)
            setModalExamenAbierto(false)
            setPreguntasExamen([])
            setRespuestasUsuario({})
          }
        }
        
        setMensaje({
          tipo: 'success',
          texto: '‚úÖ Examen eliminado'
        })
        cargarCarpetasExamenes(rutaActualExamenes)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå ${error.message}`
      })
    }
  }

  // Renombrar carpeta
  const renombrarCarpeta = async (ruta, nombreActual) => {
    const nuevoNombre = prompt(`Renombrar carpeta "${nombreActual}":`, nombreActual)
    if (!nuevoNombre || nuevoNombre === nombreActual) return

    try {
      const response = await fetch(`${API_URL}/api/carpetas/renombrar`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          ruta_actual: ruta,
          nuevo_nombre: nuevoNombre 
        })
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Carpeta renombrada a "${nuevoNombre}"`
        })
        cargarCarpeta(rutaActual)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå ${error.message}`
      })
    }
  }

  // Iniciar proceso de mover carpeta
  const iniciarMoverCarpeta = (carpeta) => {
    setMoverCarpeta(carpeta)
    setMenuAbierto(null)
    setModalMoverAbierto(true)
    setRutaDestinoSeleccionada(rutaActual)
    cargarCarpetasDestino(rutaActual)
  }

  // Cargar carpetas para selector de destino
  const cargarCarpetasDestino = async (ruta = '') => {
    try {
      const response = await fetch(`${API_URL}/api/carpetas?ruta=${encodeURIComponent(ruta)}`)
      const data = await response.json()
      setCarpetasDestino(data.carpetas || [])
      setRutaDestinoSeleccionada(ruta)
    } catch (error) {
      console.error('Error al cargar carpetas destino:', error)
    }
  }

  // Confirmar mover carpeta
  const confirmarMoverCarpeta = async () => {
    if (!moverCarpeta) return

    // Obtener la ruta padre de la carpeta actual
    const rutaPadreOrigen = moverCarpeta.ruta.split('\\').slice(0, -1).join('\\')

    // Validar que no se est√© moviendo a su misma ubicaci√≥n (mismo padre)
    if (rutaPadreOrigen === rutaDestinoSeleccionada) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå No puedes mover una carpeta a su misma ubicaci√≥n actual'
      })
      return
    }

    // Validar que no se est√© moviendo dentro de s√≠ misma
    if (rutaDestinoSeleccionada.startsWith(moverCarpeta.ruta + '\\') || 
        rutaDestinoSeleccionada === moverCarpeta.ruta) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå No puedes mover una carpeta dentro de s√≠ misma'
      })
      return
    }

    try {
      const response = await fetch(`${API_URL}/api/carpetas/mover`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ruta_origen: moverCarpeta.ruta,
          ruta_destino: rutaDestinoSeleccionada
        })
      })

      const data = await response.json()
      
      if (response.ok && data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Carpeta "${moverCarpeta.nombre}" movida exitosamente`
        })
        setMoverCarpeta(null)
        setModalMoverAbierto(false)
        cargarCarpeta(rutaDestinoSeleccionada) // Recargar la carpeta destino
      } else {
        setMensaje({
          tipo: 'error',
          texto: `‚ùå ${data.detail || data.error || 'Error al mover carpeta'}`
        })
        setModalMoverAbierto(false)
      }
    } catch (error) {
      console.error('Error al mover carpeta:', error)
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error de conexi√≥n: ${error.message}`
      })
      setModalMoverAbierto(false)
    }
  }

  // Cancelar mover carpeta
  const cancelarMoverCarpeta = () => {
    setMoverCarpeta(null)
    setModalMoverAbierto(false)
    setRutaDestinoSeleccionada('')
    setCarpetasDestino([])
  }

  // Cargar configuraci√≥n y modelos
  const cargarConfiguracion = async () => {
    setCargandoConfig(true)
    try {
      // Cargar configuraci√≥n actual
      const configResponse = await fetch(`${API_URL}/api/config`)
      const configData = await configResponse.json()
      console.log('üì• Configuraci√≥n cargada del servidor:', configData)
      console.log('   - usar_ollama:', configData.usar_ollama)
      console.log('   - gpu_activa:', configData.gpu_activa)
      console.log('   - modelo_cargado:', configData.modelo_cargado)
      console.log('   - tipo_motor:', configData.tipo_motor)
      
      // Verificar qu√© opci√≥n deber√≠a estar seleccionada
      if (configData.usar_ollama && configData.gpu_activa) {
        console.log('‚úÖ Deber√≠a seleccionarse: Ollama GPU')
      } else if (configData.usar_ollama && !configData.gpu_activa) {
        console.log('‚úÖ Deber√≠a seleccionarse: Ollama CPU')
      } else if (!configData.usar_ollama) {
        console.log('‚úÖ Deber√≠a seleccionarse: GGUF CPU')
      }
      
      setConfiguracion(configData)
      setModeloSeleccionado(configData.modelo_path || null)
      
      // Cargar ajustes avanzados si existen en la configuraci√≥n
      if (configData.ajustes_avanzados) {
        setAjustesAvanzados({
          n_ctx: configData.ajustes_avanzados.n_ctx || 4096,
          temperature: configData.ajustes_avanzados.temperature || 0.7,
          max_tokens: configData.ajustes_avanzados.max_tokens || 512,
          top_p: configData.ajustes_avanzados.top_p || 0.9,
          repeat_penalty: configData.ajustes_avanzados.repeat_penalty || 1.15
        })
        console.log('‚öôÔ∏è Ajustes avanzados cargados:', configData.ajustes_avanzados)
      }

      // Cargar modelos instalados
      const modelosResponse = await fetch(`${API_URL}/api/modelos`)
      const modelosData = await modelosResponse.json()
      console.log('Modelos instalados:', modelosData)
      setModelosDisponibles(modelosData.modelos || [])

      // Cargar modelos disponibles para descargar
      const descargablesResponse = await fetch(`${API_URL}/api/modelos/disponibles`)
      const descargablesData = await descargablesResponse.json()
      console.log('Modelos para descargar:', descargablesData)
      setModelosParaDescargar(descargablesData.modelos || [])
    } catch (error) {
      console.error('Error al cargar configuraci√≥n:', error)
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al cargar configuraci√≥n: ${error.message}`
      })
    } finally {
      setCargandoConfig(false)
    }
  }

  // Guardar configuraci√≥n
  const guardarConfiguracion = async () => {
    if (!modeloSeleccionado) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Debes seleccionar un modelo'
      })
      return
    }

    setCargandoConfig(true)
    try {
      const response = await fetch(`${API_URL}/api/config`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          modelo_path: modeloSeleccionado,
          ajustes_avanzados: ajustesAvanzados
        })
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: '‚úÖ Modelo cambiado exitosamente. Recarga la configuraci√≥n para verificar.'
        })
        // Recargar configuraci√≥n para verificar
        cargarConfiguracion()
      } else {
        setMensaje({
          tipo: 'error',
          texto: `‚ùå ${data.message || 'Error al cambiar modelo'}`
        })
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    } finally {
      setCargandoConfig(false)
    }
  }

  // Guardar solo ajustes avanzados (sin mostrar mensaje)
  const guardarAjustesAvanzados = async () => {
    try {
      // Obtener configuraci√≥n actual
      const configResponse = await fetch(`${API_URL}/api/config`)
      const configData = await configResponse.json()
      
      // Guardar con ajustes actualizados
      await fetch(`${API_URL}/api/config`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          modelo_path: configData.modelo_path,
          ajustes_avanzados: ajustesAvanzados
        })
      })
      
      console.log('‚öôÔ∏è Ajustes avanzados guardados:', ajustesAvanzados)
    } catch (error) {
      console.error('Error guardando ajustes:', error)
    }
  }

  // Enviar mensaje al chat
  const enviarMensajeChat = async () => {
    if (!inputChat.trim() || cargandoChat) return

    const mensaje = inputChat.trim()
    setInputChat('')
    
    // Agregar mensaje del usuario
    const horaNueva = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
    const mensajeUsuario = {
      tipo: 'usuario',
      texto: mensaje,
      hora: horaNueva
    }
    
    // Si hay archivo de contexto, agregarlo al mensaje
    if (archivoContexto) {
      mensajeUsuario.archivo = nombreArchivoContexto
    }
    
    // Si hay b√∫squeda web activa, agregarlo
    if (busquedaWebActiva) {
      mensajeUsuario.busqueda_web = true
    }
    
    // Construir historial ANTES de agregar el mensaje actual al estado
    // Esto asegura que el backend reciba el contexto completo
    const historialCompleto = [...mensajesChat, mensajeUsuario]
    
    setMensajesChat(prev => [...prev, mensajeUsuario])

    // Crear AbortController para poder cancelar la petici√≥n
    const controller = new AbortController()
    setAbortController(controller)

    setCargandoChat(true)
    try {
      console.log('\n' + '='.repeat(70))
      console.log('üí¨ ENVIANDO MENSAJE AL BACKEND')
      console.log('='.repeat(70))
      console.log('üìù Mensaje actual:', mensaje)
      console.log('üìú Total mensajes en historial:', historialCompleto.length)
      console.log('‚öôÔ∏è Configuraci√≥n:', ajustesAvanzados)
      console.log('\nüîç DETALLE COMPLETO DEL HISTORIAL:')
      historialCompleto.forEach((msg, idx) => {
        const preview = msg.texto?.substring(0, 80) || ''
        console.log(`  ${idx + 1}. [${msg.tipo.toUpperCase()}] ${preview}${msg.texto?.length > 80 ? '...' : ''}`)
      })
      console.log('='.repeat(70) + '\n')
      
      // Combinar contexto de archivo √∫nico + archivos adjuntos
      let contextoFinal = contenidoContexto || null
      
      if (archivosContextoChat.length > 0) {
        const contextosArchivos = archivosContextoChat.map(archivo => 
          `[Archivo: ${archivo.nombre}]\n${archivo.contenido}\n[Fin de ${archivo.nombre}]\n`
        ).join('\n\n')
        
        if (contextoFinal) {
          contextoFinal = contextoFinal + '\n\n' + contextosArchivos
        } else {
          contextoFinal = contextosArchivos
        }
      }
      
      const response = await fetch(`${API_URL}/api/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          mensaje,
          contexto: contextoFinal,
          buscar_web: busquedaWebActiva,
          historial: historialCompleto,  // Enviar historial COMPLETO incluyendo mensaje actual
          ajustes: ajustesAvanzados  // Enviar configuraci√≥n avanzada
        }),
        signal: controller.signal
      })

      const data = await response.json()
      
      // Validar que data no sea null
      if (!data || typeof data !== 'object') {
        throw new Error('El servidor no respondi√≥ correctamente.');
      }
      
      if (!data.respuesta) {
        throw new Error('El modelo no gener√≥ una respuesta. Verifica la configuraci√≥n.');
      }
      
      // Si la respuesta contiene un mensaje de error sobre modelos, mostrarlo directamente
      if (data.respuesta.includes('‚ùå')) {
        const nuevaRespuesta = {
          tipo: 'asistente',
          texto: data.respuesta,
          hora: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
        }
        setMensajesChat(prev => [...prev, nuevaRespuesta])
        return
      }
      
      // Agregar respuesta del asistente
      const nuevaRespuesta = {
        tipo: 'asistente',
        texto: data.respuesta,
        hora: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
      }
      setMensajesChat(prev => {
        const nuevosMensajes = [...prev, nuevaRespuesta]
        // Guardar autom√°ticamente despu√©s de cada respuesta
        guardarAutomaticamente(nuevosMensajes)
        return nuevosMensajes
      })
    } catch (error) {
      if (error.name === 'AbortError') {
        setMensajesChat(prev => [...prev, {
          tipo: 'asistente',
          texto: '‚ö†Ô∏è Consulta cancelada por el usuario',
          hora: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
        }])
      } else {
        setMensajesChat(prev => [...prev, {
          tipo: 'asistente',
          texto: `‚ùå Error: ${error.message}`,
          hora: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
        }])
      }
    } finally {
      setCargandoChat(false)
      setAbortController(null)
    }
  }

  // Detener/cancelar la consulta
  const detenerConsulta = () => {
    if (abortController) {
      abortController.abort()
      setAbortController(null)
      setCargandoChat(false)
    }
  }

  // Editar mensaje del usuario
  const iniciarEdicionMensaje = (index) => {
    setEditandoMensaje(index)
    setTextoEditado(mensajesChat[index].texto)
  }

  const cancelarEdicion = () => {
    setEditandoMensaje(null)
    setTextoEditado('')
  }

  const guardarEdicionMensaje = async (index) => {
    if (!textoEditado.trim() || cargandoChat) return

    const mensajeEditado = textoEditado.trim()
    
    // Actualizar el mensaje editado
    const nuevosMensajes = [...mensajesChat]
    nuevosMensajes[index].texto = mensajeEditado
    
    // Eliminar mensajes posteriores (respuesta del asistente y mensajes siguientes)
    const mensajesHastaEditado = nuevosMensajes.slice(0, index + 1)
    setMensajesChat(mensajesHastaEditado)
    
    setEditandoMensaje(null)
    setTextoEditado('')
    
    // Crear AbortController para poder cancelar la petici√≥n
    const controller = new AbortController()
    setAbortController(controller)
    
    // Reenviar el mensaje editado al asistente
    setCargandoChat(true)
    try {
      const response = await fetch(`${API_URL}/api/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          mensaje: mensajeEditado,
          historial: mensajesHastaEditado  // Enviar historial actualizado
        }),
        signal: controller.signal
      })

      const data = await response.json()
      
      // Agregar nueva respuesta del asistente
      setMensajesChat(prev => [...prev, {
        tipo: 'asistente',
        texto: data.respuesta || 'Error al obtener respuesta',
        hora: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
      }])
    } catch (error) {
      if (error.name === 'AbortError') {
        setMensajesChat(prev => [...prev, {
          tipo: 'asistente',
          texto: '‚ö†Ô∏è Consulta cancelada por el usuario',
          hora: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
        }])
      } else {
        setMensajesChat(prev => [...prev, {
          tipo: 'asistente',
          texto: `‚ùå Error: ${error.message}`,
          hora: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
        }])
      }
    } finally {
      setCargandoChat(false)
      setAbortController(null)
    }
  }

  // Manejar carga de archivo al chat
  const handleArchivoContexto = async (e) => {
    const archivo = e.target.files[0]
    if (!archivo) return

    const extension = archivo.name.split('.').pop().toLowerCase()
    
    if (extension === 'txt') {
      // Leer archivo TXT directamente
      const reader = new FileReader()
      reader.onload = (event) => {
        setContenidoContexto(event.target.result)
        setNombreArchivoContexto(archivo.name)
        setArchivoContexto(archivo)
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Archivo ${archivo.name} cargado (${(archivo.size / 1024).toFixed(1)} KB)`
        })
      }
      reader.readAsText(archivo)
    } else if (extension === 'pdf') {
      // Procesar PDF en el backend
      const formData = new FormData()
      formData.append('file', archivo)

      try {
        const response = await fetch(`${API_URL}/api/extraer-texto-simple`, {
          method: 'POST',
          body: formData
        })

        const data = await response.json()
        if (data.texto) {
          setContenidoContexto(data.texto)
          setNombreArchivoContexto(archivo.name)
          setArchivoContexto(archivo)
          setMensaje({
            tipo: 'success',
            texto: `‚úÖ PDF ${archivo.name} procesado (${data.caracteres} caracteres)`
          })
        }
      } catch (error) {
        setMensaje({
          tipo: 'error',
          texto: `‚ùå Error al procesar PDF: ${error.message}`
        })
      }
    } else {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Solo se permiten archivos PDF o TXT'
      })
    }
  }

  // Remover archivo de contexto
  const removerArchivoContexto = () => {
    setArchivoContexto(null)
    setContenidoContexto('')
    setNombreArchivoContexto('')
    setMensaje({
      tipo: 'success',
      texto: '‚úÖ Archivo removido del contexto'
    })
  }

  // Cargar historial de chats
  const cargarHistorialChats = async () => {
    try {
      const response = await fetch(`${API_URL}/api/chats/historial`)
      const data = await response.json()
      setHistorialChats(data.chats || [])
    } catch (error) {
      console.error('Error al cargar historial:', error)
    }
  }

  // ===== FUNCIONES PARA NAVEGACI√ìN EN MODAL HISTORIAL =====
  
  // Cargar contenido del modal historial
  const cargarContenidoHistorialModal = async (ruta = '') => {
    setLoadingHistorialModal(true)
    try {
      const response = await fetch(`${API_URL}/api/chats/contenido?ruta=${encodeURIComponent(ruta)}`)
      const data = await response.json()
      setCarpetasHistorialModal(data.carpetas || [])
      setChatsHistorialModal(data.chats || [])
      setRutaHistorialModal(ruta)
    } catch (error) {
      console.error('Error al cargar contenido:', error)
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al cargar contenido`
      })
    } finally {
      setLoadingHistorialModal(false)
    }
  }

  // Crear carpeta en modal historial
  const crearCarpetaHistorialModal = async () => {
    const nombre = prompt('Nombre de la nueva carpeta:')
    if (!nombre) return

    try {
      const response = await fetch(`${API_URL}/api/chats/carpetas`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          nombre,
          ruta_padre: rutaHistorialModal
        })
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Carpeta "${nombre}" creada`
        })
        cargarContenidoHistorialModal(rutaHistorialModal)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    }
  }

  // Navegar a carpeta en modal
  const navegarCarpetaHistorialModal = (ruta) => {
    cargarContenidoHistorialModal(ruta)
  }

  // Navegar atr√°s en modal
  const navegarAtrasHistorialModal = () => {
    const partes = rutaHistorialModal.split(/[\\\/]/).filter(p => p)
    partes.pop()
    const nuevaRuta = partes.join('\\')
    cargarContenidoHistorialModal(nuevaRuta)
  }

  // Cargar chat desde modal
  const cargarChatDesdeModal = async (chatId) => {
    try {
      const response = await fetch(`${API_URL}/api/chats/${chatId}`)
      const data = await response.json()
      setMensajesChat(data.mensajes || [])
      setChatActualId(data.id)
      setNombreChatNuevo(data.nombre)
      setCarpetaChatActual(data.carpeta || '')
      setMostrarModalHistorial(false)
      setMensaje({
        tipo: 'success',
        texto: `‚úÖ Chat "${data.nombre}" cargado`
      })
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al cargar chat`
      })
    }
  }

  // Eliminar chat desde modal
  const eliminarChatModal = async (chatId, nombreChat) => {
    console.log('üóëÔ∏è Intentando eliminar chat:', chatId, nombreChat)
    
    if (!confirm(`¬øEliminar el chat "${nombreChat}"?`)) {
      console.log('‚ùå Usuario cancel√≥ eliminaci√≥n')
      return
    }

    try {
      const url = `${API_URL}/api/chats/${chatId}`
      console.log('üì§ DELETE request a:', url)
      
      const response = await fetch(url, {
        method: 'DELETE'
      })

      console.log('üì• Response status:', response.status)
      const data = await response.json()
      console.log('üì• Response data:', data)
      
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Chat eliminado`
        })
        console.log('‚úÖ Recargando contenido del modal...')
        cargarContenidoHistorialModal(rutaHistorialModal)
      } else {
        console.error('‚ö†Ô∏è Respuesta no exitosa:', data)
        setMensaje({
          tipo: 'error',
          texto: `‚ö†Ô∏è ${data.message || 'Error desconocido'}`
        })
      }
    } catch (error) {
      console.error('‚ùå Error eliminando chat:', error)
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    }
  }

  // Eliminar carpeta desde modal
  const eliminarCarpetaModal = async (ruta, nombre) => {
    if (!confirm(`¬øEliminar la carpeta "${nombre}" y todo su contenido?`)) return

    try {
      const response = await fetch(`${API_URL}/api/chats/carpetas/${encodeURIComponent(ruta)}`, {
        method: 'DELETE'
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Carpeta "${nombre}" eliminada`
        })
        cargarContenidoHistorialModal(rutaHistorialModal)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    }
  }

  // Renombrar carpeta desde modal
  const renombrarCarpetaModal = async (ruta, nombreActual) => {
    const nuevoNombre = prompt(`Renombrar carpeta "${nombreActual}":`, nombreActual)
    if (!nuevoNombre || nuevoNombre === nombreActual) return

    try {
      const response = await fetch(`${API_URL}/api/chats/carpetas/${encodeURIComponent(ruta)}/renombrar`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nuevo_nombre: nuevoNombre })
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Carpeta renombrada a "${nuevoNombre}"`
        })
        cargarContenidoHistorialModal(rutaHistorialModal)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    }
  }

  // Renombrar chat desde modal
  const renombrarChatModal = async (chatId, nombreActual) => {
    const nuevoNombre = prompt(`Renombrar chat:`, nombreActual)
    if (!nuevoNombre || nuevoNombre === nombreActual) return

    try {
      const response = await fetch(`${API_URL}/api/chats/${chatId}/renombrar`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nuevo_nombre: nuevoNombre })
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Chat renombrado a "${nuevoNombre}"`
        })
        cargarContenidoHistorialModal(rutaHistorialModal)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    }
  }

  // Abrir modal para mover chat
  const abrirModalMoverChat = async (chatId, nombreChat) => {
    setItemAMover({
      tipo: 'chat',
      id: chatId,
      nombre: nombreChat,
      rutaActual: rutaHistorialModal
    })
    setRutaDestinoMover('')
    await cargarCarpetasDestinoMover('')
    setMostrarModalMover(true)
  }

  // Abrir modal para mover carpeta
  const abrirModalMoverCarpeta = async (rutaCarpeta, nombreCarpeta) => {
    setItemAMover({
      tipo: 'carpeta',
      id: rutaCarpeta,
      nombre: nombreCarpeta,
      rutaActual: rutaHistorialModal
    })
    setRutaDestinoMover('')
    await cargarCarpetasDestinoMover('')
    setMostrarModalMover(true)
  }

  // Cargar carpetas de destino para mover
  const cargarCarpetasDestinoMover = async (ruta = '') => {
    try {
      const response = await fetch(`${API_URL}/api/chats/carpetas?ruta=${encodeURIComponent(ruta)}`)
      const data = await response.json()
      setCarpetasDestinoMover(data.carpetas || [])
      setRutaDestinoMover(ruta)
    } catch (error) {
      console.error('Error cargando carpetas destino:', error)
    }
  }

  // Ejecutar movimiento de chat o carpeta
  const ejecutarMovimiento = async () => {
    if (!itemAMover) return

    try {
      let endpoint = ''
      let body = {}

      if (itemAMover.tipo === 'chat') {
        endpoint = `${API_URL}/api/chats/${itemAMover.id}/mover`
        body = { nueva_ruta: rutaDestinoMover }
      } else {
        endpoint = `${API_URL}/api/chats/carpetas/${encodeURIComponent(itemAMover.id)}/mover`
        body = { nueva_ruta: rutaDestinoMover }
      }

      const response = await fetch(endpoint, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ ${itemAMover.tipo === 'chat' ? 'Chat' : 'Carpeta'} movido correctamente`
        })
        setMostrarModalMover(false)
        setItemAMover(null)
        cargarContenidoHistorialModal(rutaHistorialModal)
      } else {
        setMensaje({
          tipo: 'error',
          texto: `‚ùå ${data.message || 'Error al mover'}`
        })
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    }
  }

  // Cargar contenido cuando se abre el modal
  const abrirModalHistorial = () => {
    setMostrarModalHistorial(true)
    cargarContenidoHistorialModal('')
  }

  // Guardar chat actual
  const guardarChatActual = async () => {
    if (mensajesChat.length === 0) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå No hay mensajes para guardar'
      })
      return
    }

    const nombre = prompt('Nombre para este chat:', nombreChatNuevo || `Chat ${new Date().toLocaleDateString()}`)
    if (!nombre) return

    try {
      const response = await fetch(`${API_URL}/api/chats/guardar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: chatActualId,
          nombre: nombre,
          mensajes: mensajesChat
        })
      })

      const data = await response.json()
      if (data.success) {
        setChatActualId(data.id)
        setMensaje({
          tipo: 'success',
          texto: '‚úÖ Chat guardado exitosamente'
        })
        cargarHistorialChats()
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al guardar: ${error.message}`
      })
    }
  }

  // Cargar un chat del historial
  const cargarChat = async (id) => {
    try {
      const response = await fetch(`${API_URL}/api/chats/${id}`)
      const data = await response.json()
      
      setMensajesChat(data.mensajes || [])
      setChatActualId(id)
      setNombreChatNuevo(data.nombre || '')
      setMostrarModalHistorial(false)
      setSelectedMenu('chat')
      
      setMensaje({
        tipo: 'success',
        texto: `‚úÖ Chat "${data.nombre}" cargado`
      })
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al cargar chat: ${error.message}`
      })
    }
  }

  // Eliminar un chat del historial
  const eliminarChat = async (id, nombre) => {
    if (!confirm(`¬øEliminar el chat "${nombre}"?`)) return

    try {
      const response = await fetch(`${API_URL}/api/chats/${id}`, {
        method: 'DELETE'
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: '‚úÖ Chat eliminado'
        })
        cargarHistorialChats()
        
        // Si era el chat actual, limpiar
        if (chatActualId === id) {
          setMensajesChat([])
          setChatActualId(null)
          setNombreChatNuevo('')
        }
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al eliminar: ${error.message}`
      })
    }
  }

  // Crear nuevo chat
  const nuevoChat = () => {
    if (mensajesChat.length > 0 && !confirm('¬øIniciar un nuevo chat? Los mensajes actuales no guardados se perder√°n.')) {
      return
    }
    setMensajesChat([])
    setChatActualId(null)
    setNombreChatNuevo('')
  }

  // ===== FUNCIONES PARA DIAGN√ìSTICO Y REPARACI√ìN DE OLLAMA =====
  
  const verificarEstadoOllama = async () => {
    try {
      const response = await fetch(`${API_URL}/api/diagnostico/ollama`)
      const data = await response.json()
      setDiagnosticoOllama(data)
      return data
    } catch (error) {
      console.error('Error verificando Ollama:', error)
      setDiagnosticoOllama({
        estado: 'error',
        corriendo: false,
        mensaje: 'No se pudo conectar con el servidor'
      })
      return null
    }
  }

  const repararOllama = async () => {
    setReparandoOllama(true)
    try {
      const response = await fetch(`${API_URL}/api/diagnostico/reparar-ollama`, {
        method: 'POST'
      })
      const data = await response.json()
      
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: data.mensaje
        })
        // Verificar estado despu√©s de reparar
        await verificarEstadoOllama()
      } else {
        setMensaje({
          tipo: 'error',
          texto: data.mensaje
        })
      }
      
      return data
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al reparar: ${error.message}`
      })
      return null
    } finally {
      setReparandoOllama(false)
    }
  }

  // ===== FUNCIONES PARA SISTEMA DE ARCHIVOS DEL CHATBOT =====
  
  // Cargar archivos recientes
  const cargarArchivosRecientes = async () => {
    setCargandoArchivos(true)
    try {
      const response = await fetch(`${API_URL}/api/archivos/recientes?limite=30`)
      const data = await response.json()
      setArchivosRecientes(data.archivos || [])
    } catch (error) {
      console.error('Error al cargar archivos recientes:', error)
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al cargar archivos recientes'
      })
    } finally {
      setCargandoArchivos(false)
    }
  }

  // Explorar carpeta de archivos
  const explorarCarpetaChat = async (tipo, ruta = '') => {
    setCargandoArchivos(true)
    try {
      const response = await fetch(`${API_URL}/api/archivos/explorar?tipo=${tipo}&ruta=${encodeURIComponent(ruta)}`)
      const data = await response.json()
      setCarpetasExploradorChat(data.carpetas || [])
      setRutaExploradorChat(data.ruta_actual || '')
      
      // Actualizar lista de archivos recientes con los de la carpeta actual
      setArchivosRecientes(data.archivos || [])
    } catch (error) {
      console.error('Error al explorar carpeta:', error)
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al explorar carpeta'
      })
    } finally {
      setCargandoArchivos(false)
    }
  }

  // Adjuntar archivo al contexto del chat
  const adjuntarArchivoContexto = async (archivo) => {
    try {
      const response = await fetch(`${API_URL}/api/archivos/leer-contenido`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ruta: archivo.ruta_completa })
      })
      
      const data = await response.json()
      
      // Agregar a la lista de archivos del contexto
      const nuevoArchivo = {
        ...archivo,
        contenido: data.contenido,
        vista_previa: data.contenido.substring(0, 200) + (data.contenido.length > 200 ? '...' : '')
      }
      
      // Evitar duplicados
      const yaExiste = archivosContextoChat.some(a => a.ruta_completa === archivo.ruta_completa)
      if (!yaExiste) {
        setArchivosContextoChat(prev => [...prev, nuevoArchivo])
        setMensaje({
          tipo: 'success',
          texto: `üìé Archivo "${archivo.nombre}" adjuntado al contexto`
        })
      } else {
        setMensaje({
          tipo: 'info',
          texto: 'Este archivo ya est√° en el contexto'
        })
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al leer archivo: ${error.message}`
      })
    }
  }

  // Quitar archivo del contexto
  const quitarArchivoContexto = (rutaCompleta) => {
    setArchivosContextoChat(prev => prev.filter(a => a.ruta_completa !== rutaCompleta))
    setMensaje({
      tipo: 'info',
      texto: 'üìé Archivo removido del contexto'
    })
  }

  // Limpiar todos los archivos del contexto
  const limpiarContextoArchivos = () => {
    setArchivosContextoChat([])
    setMensaje({
      tipo: 'info',
      texto: 'üóëÔ∏è Contexto limpiado'
    })
  }

  // ===== FUNCIONES PARA GUARDAR CHAT/CONSULTA COMO TXT =====

  // Cargar carpetas de cursos para guardar TXT
  const cargarCarpetasCursos = async (ruta = '') => {
    console.log('üìÇ Cargando carpetas, ruta:', ruta)
    try {
      const url = `${API_URL}/api/cursos/carpetas?ruta=${encodeURIComponent(ruta)}`
      console.log('üåê URL:', url)
      const response = await fetch(url)
      const data = await response.json()
      console.log('üì• Carpetas recibidas:', data)
      console.log('üìä N√∫mero de carpetas:', data.carpetas?.length || 0)
      setCarpetasCursos(data.carpetas || [])
      setRutaGuardadoTxt(ruta)
    } catch (error) {
      console.error('‚ùå Error cargando carpetas:', error)
    }
  }

  // Abrir modal para guardar chat completo como TXT
  const abrirGuardarChatTxt = () => {
    if (mensajesChat.length === 0) {
      setMensaje({
        tipo: 'error',
        texto: '‚ö†Ô∏è No hay mensajes para guardar'
      })
      return
    }

    setTipoGuardadoTxt('chat')
    setConsultaAGuardar(null)
    const nombreDefault = nombreChatNuevo || `Chat_${new Date().toLocaleDateString('es-ES').replace(/\//g, '-')}`
    setNombreArchivoTxt(nombreDefault)
    setRutaGuardadoTxt('')
    cargarCarpetasCursos('')
    setModalGuardarTxt(true)
  }

  // Abrir modal para guardar consulta espec√≠fica como TXT
  const abrirGuardarConsultaTxt = (indexUsuario) => {
    console.log('üîç Intentando guardar consulta, √≠ndice:', indexUsuario)
    console.log('üìù Total mensajes:', mensajesChat.length)
    
    // Buscar el mensaje del usuario y su respuesta
    const mensajeUsuario = mensajesChat[indexUsuario]
    const mensajeAsistente = mensajesChat[indexUsuario + 1]

    console.log('üë§ Mensaje usuario:', mensajeUsuario)
    console.log('ü§ñ Mensaje asistente:', mensajeAsistente)

    if (!mensajeUsuario || !mensajeAsistente) {
      console.error('‚ùå Faltan mensajes')
      setMensaje({
        tipo: 'error',
        texto: '‚ö†Ô∏è No se pudo encontrar la consulta completa'
      })
      return
    }

    console.log('‚úÖ Abriendo modal de guardado')
    setTipoGuardadoTxt('consulta')
    setConsultaAGuardar({ pregunta: mensajeUsuario, respuesta: mensajeAsistente })
    setNombreArchivoTxt(`Consulta_${new Date().toLocaleDateString('es-ES').replace(/\//g, '-')}`)
    setRutaGuardadoTxt('')
    setCarpetasCursos([])
    cargarCarpetasCursos('') // Inicia en ra√≠z de extracciones
    setModalGuardarTxt(true)
  }

  // Abrir modal para guardar SOLO la respuesta del asistente (sin pregunta)
  const abrirGuardarRespuestaTxt = (indexRespuesta) => {
    console.log('üîç Guardando solo respuesta, √≠ndice:', indexRespuesta)
    
    const mensajeAsistente = mensajesChat[indexRespuesta]

    if (!mensajeAsistente || mensajeAsistente.tipo !== 'asistente') {
      console.error('‚ùå No es una respuesta v√°lida')
      setMensaje({
        tipo: 'error',
        texto: '‚ö†Ô∏è No se pudo encontrar la respuesta'
      })
      return
    }

    console.log('‚úÖ Abriendo modal de guardado (solo respuesta)')
    setTipoGuardadoTxt('respuesta') // Nuevo tipo
    setConsultaAGuardar({ respuesta: mensajeAsistente }) // Solo la respuesta
    setNombreArchivoTxt(`Respuesta_${new Date().toLocaleDateString('es-ES').replace(/\//g, '-')}`)
    setRutaGuardadoTxt('')
    setCarpetasCursos([])
    cargarCarpetasCursos('')
    setModalGuardarTxt(true)
  }

  // Guardar como TXT
  const guardarComoTxt = async () => {
    console.log('üíæ Iniciando guardado TXT')
    console.log('üìù Nombre archivo:', nombreArchivoTxt)
    console.log('üìÅ Ruta:', rutaGuardadoTxt)
    console.log('üìã Tipo:', tipoGuardadoTxt)
    
    if (!nombreArchivoTxt.trim()) {
      setMensaje({
        tipo: 'error',
        texto: '‚ö†Ô∏è Debes especificar un nombre para el archivo'
      })
      return
    }

    try {
      let contenido = ''

      if (tipoGuardadoTxt === 'chat') {
        // Generar contenido del chat completo
        contenido = `=================================================\n`
        contenido += `CHAT - ${nombreChatNuevo || 'Sin t√≠tulo'}\n`
        contenido += `Fecha: ${new Date().toLocaleString('es-ES')}\n`
        contenido += `Total mensajes: ${mensajesChat.length}\n`
        contenido += `=================================================\n\n`

        mensajesChat.forEach((msg, idx) => {
          const tipo = msg.tipo === 'usuario' ? 'üë§ USUARIO' : 'ü§ñ ASISTENTE'
          contenido += `${'-'.repeat(50)}\n`
          contenido += `${tipo} - ${msg.hora}\n`
          contenido += `${'-'.repeat(50)}\n`
          contenido += `${msg.texto}\n\n`
        })
      } else if (tipoGuardadoTxt === 'consulta') {
        console.log('üìÑ Generando contenido de consulta completa...')
        console.log('üîç Consulta a guardar:', consultaAGuardar)
        
        // Generar contenido de consulta espec√≠fica (pregunta + respuesta)
        contenido = `=================================================\n`
        contenido += `CONSULTA GUARDADA\n`
        contenido += `Fecha: ${new Date().toLocaleString('es-ES')}\n`
        contenido += `=================================================\n\n`
        contenido += `üë§ PREGUNTA:\n`
        contenido += `${'-'.repeat(50)}\n`
        contenido += `${consultaAGuardar.pregunta.texto}\n\n`
        contenido += `ü§ñ RESPUESTA:\n`
        contenido += `${'-'.repeat(50)}\n`
        contenido += `${consultaAGuardar.respuesta.texto}\n`
      } else if (tipoGuardadoTxt === 'respuesta') {
        console.log('üìÑ Generando contenido de solo respuesta...')
        console.log('üîç Respuesta a guardar:', consultaAGuardar)
        
        // Generar contenido SOLO de la respuesta (sin pregunta)
        contenido = `=================================================\n`
        contenido += `RESPUESTA DEL ASISTENTE\n`
        contenido += `Fecha: ${new Date().toLocaleString('es-ES')}\n`
        contenido += `=================================================\n\n`
        contenido += `${consultaAGuardar.respuesta.texto}\n`
      }

      console.log('üì§ Enviando al servidor...')
      console.log('üì¶ Datos:', { carpeta: rutaGuardadoTxt, nombreArchivo: nombreArchivoTxt })

      // Guardar en el servidor
      const response = await fetch(`${API_URL}/api/cursos/guardar-txt`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          carpeta: rutaGuardadoTxt,
          nombreArchivo: nombreArchivoTxt.endsWith('.txt') ? nombreArchivoTxt : `${nombreArchivoTxt}.txt`,
          contenido: contenido
        })
      })

      const data = await response.json()
      console.log('üì• Respuesta del servidor:', data)

      if (data.success) {
        console.log('‚úÖ Guardado exitoso!')
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ ${tipoGuardadoTxt === 'chat' ? 'Chat' : 'Consulta'} guardado en ${data.ruta || 'cursos'}`
        })
        setModalGuardarTxt(false)
      } else {
        throw new Error(data.message || 'Error al guardar')
      }
    } catch (error) {
      console.error('‚ùå Error al guardar:', error)
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    }
  }

  // ===== FUNCIONES PARA CARPETAS DE CHATS =====
  
  // Cargar carpetas de chats
  const cargarCarpetasChats = async () => {
    try {
      const response = await fetch(`${API_URL}/api/chats/carpetas`)
      const data = await response.json()
      setCarpetasChats(data.carpetas || [])
    } catch (error) {
      console.error('Error al cargar carpetas:', error)
    }
  }

  // Crear nueva carpeta de chats
  const crearCarpetaChat = async () => {
    const nombre = prompt('Nombre de la carpeta/proyecto:')
    if (!nombre) return

    try {
      const response = await fetch(`${API_URL}/api/chats/carpetas`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre })
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Carpeta "${nombre}" creada`
        })
        cargarCarpetasChats()
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    }
  }

  // Guardado autom√°tico silencioso
  const guardarAutomaticamente = async (mensajes) => {
    try {
      // Generar nombre autom√°tico si no existe
      const nombre = nombreChatNuevo || `Chat ${new Date().toLocaleDateString('es-ES')}`
      
      const response = await fetch(`${API_URL}/api/chats/guardar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: chatActualId,
          nombre: nombre,
          mensajes: mensajes,
          carpeta: carpetaChatActual
        })
      })

      const data = await response.json()
      if (data.success) {
        // Actualizar ID del chat si es nuevo
        if (!chatActualId) {
          setChatActualId(data.id)
          setNombreChatNuevo(nombre)
        }
      }
    } catch (error) {
      console.error('Error en guardado autom√°tico:', error)
    }
  }

  // Mover chat a carpeta espec√≠fica
  const moverChatACarpeta = async (carpeta = '') => {
    if (mensajesChat.length === 0) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå No hay mensajes para mover'
      })
      return
    }

    const nombre = nombreChatNuevo || `Chat ${new Date().toLocaleDateString('es-ES')}`

    try {
      const response = await fetch(`${API_URL}/api/chats/guardar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: chatActualId,
          nombre: nombre,
          mensajes: mensajesChat,
          carpeta: carpeta
        })
      })

      const data = await response.json()
      if (data.success) {
        setChatActualId(data.id)
        setCarpetaChatActual(carpeta)
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Chat movido${carpeta ? ` a "${carpeta}"` : ' a la ra√≠z'}`
        })
        cargarHistorialChats()
        setMostrarModalCarpetas(false)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    }
  }

  // Effect para cargar historial cuando se abre el chat
  useEffect(() => {
    if (selectedMenu === 'chat') {
      cargarHistorialChats()
      cargarCarpetasChats()
      // Cargar modelos Ollama disponibles
      fetch(`${API_URL}/api/ollama/modelos`)
        .then(res => res.json())
        .then(data => {
          if (data.success && data.modelos) {
            setModelosOllama(data.modelos)
          }
        })
        .catch(err => console.error('Error cargando modelos Ollama:', err))
    }
  }, [selectedMenu])

  // Eliminar documento
  const eliminarDocumento = async (ruta, nombre) => {
    if (!confirm(`¬øEliminar el documento "${nombre}"?`)) return

    try {
      const response = await fetch(`${API_URL}/api/documentos?ruta=${encodeURIComponent(ruta)}`, {
        method: 'DELETE'
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: '‚úÖ Documento eliminado'
        })
        cargarCarpeta(rutaActual)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    }
  }

  const renombrarDocumento = async (ruta, nombreActual) => {
    // Extraer extensi√≥n de forma m√°s robusta
    const lastDotIndex = nombreActual.lastIndexOf('.')
    
    // Tiene extensi√≥n si el punto no est√° al inicio y hay caracteres despu√©s
    let extension = ''
    let nombreSinExt = nombreActual
    
    if (lastDotIndex > 0 && lastDotIndex < nombreActual.length - 1) {
      extension = nombreActual.substring(lastDotIndex)
      nombreSinExt = nombreActual.substring(0, lastDotIndex)
    }
    
    console.log('DEBUG Renombrar:', { 
      nombreActual, 
      lastDotIndex,
      extension, 
      nombreSinExt 
    })
    
    const nuevoNombreSinExt = prompt(`Renombrar documento (sin extensi√≥n):`, nombreSinExt)
    
    if (!nuevoNombreSinExt || nuevoNombreSinExt.trim() === '') return
    if (nuevoNombreSinExt.trim() === nombreSinExt) return
    
    const nuevoNombreCompleto = nuevoNombreSinExt.trim() + extension
    
    console.log('DEBUG Enviando:', { 
      ruta_actual: ruta, 
      nuevo_nombre: nuevoNombreCompleto,
      extension_agregada: extension
    })

    try {
      const response = await fetch(`${API_URL}/api/documentos/renombrar`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          ruta_actual: ruta,
          nuevo_nombre: nuevoNombreCompleto
        })
      })

      const data = await response.json()
      console.log('DEBUG Respuesta:', data)
      
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Documento renombrado a "${nuevoNombreCompleto}"`
        })
        cargarCarpeta(rutaActual)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå ${error.message}`
      })
    }
  }

  // Cargar configuraci√≥n cuando se selecciona el men√∫
  useEffect(() => {
    if (selectedMenu === 'configuracion') {
      cargarConfiguracion()
    }
  }, [selectedMenu])

  // Subir PDF
  const handleFileUpload = async (event) => {
    const file = event.target.files[0]
    if (!file) return

    setLoading(true)
    setMensaje(null)

    try {
      const formData = new FormData()
      formData.append('file', file)
      formData.append('carpeta', rutaActual)

      const response = await fetch(`${API_URL}/api/extraer-pdf`, {
        method: 'POST',
        body: formData
      })

      const data = await response.json()
      
      if (data.success) {
        const ubicacion = data.carpeta === 'ra√≠z' ? 'la ra√≠z' : `"${data.carpeta}"`
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Documento guardado en ${ubicacion}: ${data.palabras} palabras extra√≠das`
        })
        if (selectedMenu === 'cursos') {
          cargarCarpeta(rutaActual)
        }
      } else {
        setMensaje({
          tipo: 'error',
          texto: '‚ùå Error al procesar el documento'
        })
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    } finally {
      setLoading(false)
      event.target.value = '' // Reset input
    }
  }

  // Navegar hacia atr√°s
  const navegarAtras = () => {
    const partes = rutaActual.split('\\').filter(p => p)
    partes.pop()
    const nuevaRuta = partes.join('\\')
    cargarCarpeta(nuevaRuta)
  }

  // Ver documento
  const verDocumento = async (ruta, nombre) => {
    setLoading(true)
    try {
      const response = await fetch(`${API_URL}/api/documentos/contenido?ruta=${encodeURIComponent(ruta)}`)
      const data = await response.json()
      
      setDocumentoActual({
        nombre: nombre,
        ruta: ruta,
        contenido: data.contenido,
        tama√±o_kb: data.tama√±o_kb,
        lineas: data.lineas
      })
      setContenidoEditado(data.contenido)
      setModoEdicion(false)
      setVisorAbierto(true)
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al cargar documento: ${error.message}`
      })
    } finally {
      setLoading(false)
    }
  }

  // Activar modo edici√≥n
  const activarEdicion = () => {
    setModoEdicion(true)
  }

  // Cancelar edici√≥n de documento
  const cancelarEdicionDocumento = () => {
    setContenidoEditado(documentoActual.contenido)
    setModoEdicion(false)
  }

  // Guardar cambios del documento
  const guardarDocumento = async () => {
    try {
      const response = await fetch(`${API_URL}/api/documentos/contenido`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ruta: documentoActual.ruta,
          contenido: contenidoEditado
        })
      })

      const data = await response.json()
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: '‚úÖ Documento guardado exitosamente'
        })
        setDocumentoActual({
          ...documentoActual,
          contenido: contenidoEditado,
          tama√±o_kb: data.tama√±o_kb,
          lineas: data.lineas
        })
        setModoEdicion(false)
        cargarCarpeta(rutaActual)
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al guardar: ${error.message}`
      })
    }
  }

  // Cerrar visor
  const cerrarVisor = () => {
    detenerLectura()
    setVisorAbierto(false)
    setDocumentoActual(null)
    setModoEdicion(false)
    setContenidoEditado('')
    setPosicionLectura({ inicio: 0, fin: 0 })
  }

  // Control de voz - Leer documento
  const leerDocumento = () => {
    if (!documentoActual) return
    
    // Verificar si el navegador soporta Web Speech API
    if (!('speechSynthesis' in window)) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Tu navegador no soporta s√≠ntesis de voz'
      })
      return
    }

    // Si ya est√° leyendo y pausado, reanudar
    if (pausado) {
      window.speechSynthesis.resume()
      setPausado(false)
      setLeyendo(true)
      return
    }

    // Si ya est√° leyendo, no hacer nada
    if (leyendo) return

    // Crear nueva instancia de lectura
    const utterance = new SpeechSynthesisUtterance(documentoActual.contenido)
    
    // Configurar voz en espa√±ol si est√° disponible
    const voices = window.speechSynthesis.getVoices()
    const spanishVoice = voices.find(voice => voice.lang.startsWith('es'))
    if (spanishVoice) {
      utterance.voice = spanishVoice
    }
    utterance.lang = 'es-ES'
    utterance.rate = 1.0 // Velocidad normal
    utterance.pitch = 1.0 // Tono normal
    utterance.volume = 1.0 // Volumen m√°ximo

    // Eventos
    utterance.onstart = () => {
      setLeyendo(true)
      setPausado(false)
      setPosicionLectura({ inicio: 0, fin: 0 })
    }

    utterance.onboundary = (event) => {
      // Actualizar posici√≥n de lectura cuando cambia de palabra
      if (event.name === 'word') {
        setPosicionLectura({
          inicio: event.charIndex,
          fin: event.charIndex + (event.charLength || 0)
        })
      }
    }

    utterance.onend = () => {
      setLeyendo(false)
      setPausado(false)
      setPosicionLectura({ inicio: 0, fin: 0 })
    }

    utterance.onerror = (error) => {
      console.error('Error en s√≠ntesis de voz:', error)
      setLeyendo(false)
      setPausado(false)
      setPosicionLectura({ inicio: 0, fin: 0 })
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al leer el documento'
      })
    }

    // Iniciar lectura
    window.speechSynthesis.speak(utterance)
  }

  // Pausar lectura
  const pausarLectura = () => {
    if (leyendo && !pausado) {
      window.speechSynthesis.pause()
      setPausado(true)
      setLeyendo(false)
    }
  }

  // Detener lectura
  const detenerLectura = () => {
    window.speechSynthesis.cancel()
    setLeyendo(false)
    setPausado(false)
    setPosicionLectura({ inicio: 0, fin: 0 })
  }

  // ============= FUNCIONES DE EX√ÅMENES =============
  
  // Verificar examen local al inicio (sin cargar del servidor)
  useEffect(() => {
    // Verificar si hay un examen guardado localmente
    const hayExamenLocal = cargarExamenLocal()
    if (hayExamenLocal) {
      console.log('‚úÖ Examen local recuperado')
    }
  }, [])
  
  const cargarExamenesGuardados = async () => {
    try {
      const response = await fetch(`${API_URL}/api/examenes/listar`)
      const data = await response.json()
      if (data.success) {
        setExamenesGuardados({
          completados: data.completados || [],
          enProgreso: data.enProgreso || []
        })
      }
    } catch (error) {
      console.error('Error cargando ex√°menes:', error)
    }
  }
  
  // Generar examen desde carpeta
  const generarExamenDesdeCarpeta = async (carpeta) => {
    console.log('üéì Preparando generaci√≥n de examen desde carpeta:', carpeta.nombre)
    
    try {
      // Obtener archivos de la carpeta
      const response = await fetch(`${API_URL}/api/carpetas?ruta=${encodeURIComponent(carpeta.ruta)}`)
      const data = await response.json()
      
      console.log('üìÅ Datos recibidos:', data)
      
      if (!data.documentos || data.documentos.length === 0) {
        setMensaje({
          tipo: 'error',
          texto: '‚ùå La carpeta no contiene documentos para generar el examen'
        })
        return
      }
      
      console.log('üìÑ Archivos encontrados:', data.documentos.length)
      
      // Abrir modal de configuraci√≥n (el prompt ya est√° cargado desde el useEffect inicial)
      setCarpetaConfigExamen(carpeta)
      setArchivosDisponibles(data.documentos)
      setArchivosSeleccionados(data.documentos.map(doc => doc.ruta))
      setPromptPersonalizado('')
      setRutaExploracion(carpeta.ruta)
      setCarpetasExploracion(data.carpetas || [])
      setModalConfigExamen(true)
      
      console.log('‚úÖ Modal de configuraci√≥n deber√≠a abrirse ahora')
      
    } catch (error) {
      console.error('Error preparando examen:', error)
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al preparar la generaci√≥n del examen'
      })
    }
  }

  const toggleSeleccionArchivo = (ruta) => {
    setArchivosSeleccionados(prev => {
      if (prev.includes(ruta)) {
        return prev.filter(r => r !== ruta)
      } else {
        return [...prev, ruta]
      }
    })
  }

  const cargarArchivosSubcarpeta = async (rutaSubcarpeta) => {
    try {
      const response = await fetch(`${API_URL}/api/carpetas?ruta=${encodeURIComponent(rutaSubcarpeta)}`)
      const data = await response.json()
      
      // Agregar nuevos archivos que no est√©n ya en la lista
      const nuevosArchivos = data.documentos.filter(
        doc => !archivosDisponibles.some(a => a.ruta === doc.ruta)
      )
      
      if (nuevosArchivos.length > 0) {
        setArchivosDisponibles(prev => [...prev, ...nuevosArchivos])
        setArchivosSeleccionados(prev => [...prev, ...nuevosArchivos.map(doc => doc.ruta)])
      }
      
      setRutaExploracion(rutaSubcarpeta)
      setCarpetasExploracion(data.carpetas || [])
      
    } catch (error) {
      console.error('Error cargando subcarpeta:', error)
    }
  }

  const volverCarpetaPadre = () => {
    const partes = rutaExploracion.split(/[/\\\\]/).filter(Boolean)
    partes.pop()
    const nuevaRuta = partes.join('/')
    cargarArchivosSubcarpeta(nuevaRuta || carpetaConfigExamen.ruta)
  }

  const confirmarGeneracionExamen = async () => {
    if (archivosSeleccionados.length === 0) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Debes seleccionar al menos un archivo'
      })
      return
    }

    setModalConfigExamen(false)
    setGenerandoExamen(true)
    setProgresoGeneracion(0)
    setMensajeProgreso('Preparando generaci√≥n...')
    
    // Crear nuevo AbortController para esta generaci√≥n
    const controller = new AbortController()
    setAbortController(controller)
    setMensaje(null)
    
    // Generar ID de sesi√≥n √∫nico
    const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
    setSessionIdGeneracion(sessionId)
    
    // Conectar al stream de progreso SSE
    const eventSource = new EventSource(`${API_URL}/api/progreso-examen/${sessionId}`)
    
    eventSource.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data)
        setProgresoGeneracion(data.progreso)
        setMensajeProgreso(data.mensaje)
        
        if (data.completado) {
          eventSource.close()
          if (data.error) {
            console.error('Error en generaci√≥n:', data.error)
          }
        }
      } catch (error) {
        console.error('Error parseando evento SSE:', error)
      }
    }
    
    eventSource.onerror = (error) => {
      console.error('Error en EventSource:', error)
      eventSource.close()
    }
    
    try {
      // Leer contenido solo de los archivos seleccionados
      setProgresoGeneracion(5)
      setMensajeProgreso('Leyendo archivos seleccionados...')
      let contenidoCompleto = ''
      
      console.log('üìö Cargando archivos para el examen:')
      console.log(`   Total de archivos seleccionados: ${archivosSeleccionados.length}`)
      
      for (const rutaArchivo of archivosSeleccionados) {
        try {
          const archivo = archivosDisponibles.find(a => a.ruta === rutaArchivo)
          console.log(`   üìÑ Cargando: ${archivo?.nombre || rutaArchivo}`)
          
          const respDoc = await fetch(`${API_URL}/api/documentos/contenido?ruta=${encodeURIComponent(rutaArchivo)}`, {
            signal: controller.signal
          })
          const dataDoc = await respDoc.json()
          
          console.log(`      ‚úì Cargado: ${dataDoc.contenido?.length || 0} caracteres`)
          contenidoCompleto += `\n\n=== ${archivo?.nombre || 'Documento'} ===\n${dataDoc.contenido}\n`
        } catch (error) {
          if (error.name === 'AbortError') {
            eventSource.close()
            throw error
          }
          console.error(`      ‚úó Error leyendo archivo:`, error)
        }
      }
      
      console.log(`‚úÖ Total de contenido cargado: ${contenidoCompleto.length} caracteres`)
      
      if (!contenidoCompleto.trim()) {
        eventSource.close()
        setMensaje({
          tipo: 'error',
          texto: '‚ùå No se pudo leer el contenido de los documentos'
        })
        setGenerandoExamen(false)
        return
      }
      
      // Logging de configuraci√≥n
      console.log('‚öôÔ∏è Configuraci√≥n de generaci√≥n:')
      console.log(`   Prompt personalizado: ${promptPersonalizado ? 'S√ç (' + promptPersonalizado.length + ' caracteres)' : 'NO'}`)
      console.log(`   Prompt sistema: ${promptSistema ? 'S√ç (' + promptSistema.length + ' caracteres)' : 'NO'}`)
      console.log(`   Preguntas: ${configExamen.num_multiple} m√∫ltiple, ${configExamen.num_verdadero_falso || 0} V/F, ${configExamen.num_corta} corta, ${configExamen.num_desarrollo} desarrollo`)
      
      // Generar examen con la IA
      const respExamen = await fetch(`${API_URL}/api/generar-examen`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contenido: contenidoCompleto,
          prompt_personalizado: promptPersonalizado,
          prompt_sistema: promptSistema || null,  // Enviar el prompt del sistema si existe
          num_multiple: configExamen.num_multiple || 0,
          num_corta: configExamen.num_corta || 0,
          num_desarrollo: configExamen.num_desarrollo || 0,
          num_verdadero_falso: configExamen.num_verdadero_falso || 0,  // üî• AGREGAR VERDADERO/FALSO
          session_id: sessionId
        }),
        signal: controller.signal
      })
      
      const dataExamen = await respExamen.json()
      
      if (dataExamen.success) {
        setPreguntasExamen(dataExamen.preguntas)
        setExamenActivo(true)
        setEsPractica(false) // üî• Es un EXAMEN, no pr√°ctica
        setCarpetaExamen(carpetaConfigExamen)
        setRespuestasUsuario({})
        setResultadoExamen(null)
        setModalExamenAbierto(true)
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Examen generado: ${dataExamen.total_preguntas} preguntas (${dataExamen.puntos_totales} puntos)`
        })
      } else {
        throw new Error(dataExamen.message || 'Error al generar examen')
      }
    } catch (error) {
      eventSource.close()
      if (error.name === 'AbortError') {
        console.log('‚èπÔ∏è Generaci√≥n de examen cancelada')
        setMensaje({
          tipo: 'info',
          texto: '‚èπÔ∏è Generaci√≥n de examen cancelada'
        })
      } else {
        console.error('Error generando examen:', error)
        setMensaje({
          tipo: 'error',
          texto: '‚ùå Error al generar el examen: ' + error.message
        })
      }
    } finally {
      setGenerandoExamen(false)
      setAbortController(null)
      setProgresoGeneracion(0)
      setMensajeProgreso('')
      setSessionIdGeneracion(null)
    }
  }

  const cancelarGeneracionExamen = () => {
    if (abortController) {
      abortController.abort()
      console.log('üõë Cancelando generaci√≥n de examen...')
    }
  }

  const guardarPromptSistema = async () => {
    try {
      const response = await fetch(`${API_URL}/api/prompt-personalizado`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: promptSistema })
      })
      
      const data = await response.json()
      
      if (data.success) {
        setMensaje({
          tipo: 'success',
          texto: '‚úÖ Prompt guardado exitosamente'
        })
      }
    } catch (error) {
      console.error('Error guardando prompt:', error)
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al guardar el prompt'
      })
    }
  }

  const cargarPromptPredeterminado = async () => {
    // Cargar directamente el template por defecto sin depender del servidor
    const templateDefault = `Eres un profesor universitario experto. Tu trabajo es crear preguntas de examen QUE EVAL√öEN DIRECTAMENTE EL CONTENIDO del material proporcionado.

‚ö†Ô∏è CR√çTICO: Todas las preguntas DEBEN estar basadas en informaci√≥n ESPEC√çFICA del documento. NO inventes conceptos que no aparecen en el texto.

CONTENIDO DEL MATERIAL DE ESTUDIO:
{contenido}

OBJETIVO: Crear preguntas que eval√∫en si el estudiante LEY√ì Y COMPRENDI√ì el material proporcionado.

‚ö†Ô∏è REGLAS ABSOLUTAS:
1. Cada pregunta debe referirse a INFORMACI√ìN ESPEC√çFICA que aparece en el documento
2. Menciona conceptos, nombres, t√©rminos o ideas QUE EST√ÅN EN EL TEXTO
3. NO inventes preguntas sobre temas generales
4. Las respuestas correctas deben estar JUSTIFICADAS por el contenido del documento

INSTRUCCIONES ESTRICTAS:
Genera EXACTAMENTE {total_preguntas} preguntas siguiendo esta distribuci√≥n:
- {num_multiple} preguntas de opci√≥n m√∫ltiple
- {num_corta} preguntas de respuesta corta
- {num_desarrollo} preguntas de desarrollo

CRITERIOS DE CALIDAD OBLIGATORIOS:

1. PREGUNTAS DE OPCI√ìN M√öLTIPLE (tipo: "multiple"):
   - Deben evaluar COMPRENSI√ìN, no solo memoria
   - Incluir casos pr√°cticos o escenarios reales
   - Opciones incorrectas deben ser plausibles pero claramente err√≥neas
   - Evitar preguntas triviales tipo "¬øQu√© es...?"
   - Formato de respuesta: Solo la letra (A, B, C o D)
   - Valor: 3 puntos cada una

2. PREGUNTAS DE RESPUESTA CORTA (tipo: "corta"):
   - Pedir EXPLICACIONES de conceptos clave
   - Solicitar COMPARACIONES entre ideas
   - Preguntar C√ìMO aplicar el conocimiento
   - Requieren 2-4 oraciones de respuesta
   - La respuesta_correcta debe ser una gu√≠a detallada de lo que se espera
   - Valor: 4 puntos cada una

3. PREGUNTAS DE DESARROLLO (tipo: "desarrollo"):
   - Requieren AN√ÅLISIS PROFUNDO y ARGUMENTACI√ìN
   - Deben conectar m√∫ltiples conceptos del material
   - Pedir ejemplos, aplicaciones o cr√≠ticas fundamentadas
   - La respuesta_correcta debe listar criterios de evaluaci√≥n espec√≠ficos
   - Valor: 6 puntos cada una

FORMATO DE RESPUESTA (JSON ESTRICTO - sin comentarios):
{
  "preguntas": [
    {
      "tipo": "multiple",
      "pregunta": "[Pregunta pr√°ctica sobre aplicaci√≥n del concepto]",
      "opciones": ["A) [Opci√≥n plausible pero incorrecta]", "B) [Respuesta correcta bien justificada]", "C) [Error conceptual com√∫n]", "D) [Otro error plausible]"],
      "respuesta_correcta": "B",
      "puntos": 3
    },
    {
      "tipo": "corta",
      "pregunta": "[Pregunta que requiere explicaci√≥n clara]",
      "respuesta_correcta": "Debe explicar: [punto 1], mencionar [punto 2], y ejemplificar con [punto 3]",
      "puntos": 4
    },
    {
      "tipo": "desarrollo",
      "pregunta": "[Pregunta que requiere an√°lisis profundo]",
      "respuesta_correcta": "Criterios: 1) Identifica los conceptos clave [espec√≠ficos], 2) Analiza la relaci√≥n entre ellos, 3) Proporciona ejemplos concretos, 4) Argumenta conclusiones l√≥gicas",
      "puntos": 6
    }
  ]
}

IMPORTANTE: 
- Responde SOLO con el JSON v√°lido
- NO agregues texto antes o despu√©s del JSON
- Aseg√∫rate que las preguntas cubran TODO el contenido importante
- Las preguntas deben ser DESAFIANTES pero JUSTAS
- Enf√≥cate en comprensi√≥n y aplicaci√≥n, NO en memorizaci√≥n

JSON:`
    
    setPromptSistema(templateDefault)
    setMensaje({
      tipo: 'success',
      texto: '‚úÖ Prompt predeterminado cargado'
    })
  }
  
  // Actualizar respuesta del usuario
  const actualizarRespuesta = (indice, respuesta) => {
    const nuevasRespuestas = {
      ...respuestasUsuario,
      [indice]: respuesta
    }
    setRespuestasUsuario(nuevasRespuestas)
    
    // Guardar autom√°ticamente en archivo local (mediante servidor)
    if (examenActivo && preguntasExamen.length > 0) {
      guardarExamenLocal(nuevasRespuestas)
    }
  }
  
  // Marcar pregunta como comprendida
  const marcarPreguntaComprendida = async (indicePregunta) => {
    const practicaId = examenActivo?.id || practicaActual?.id;
    if (!practicaId) {
      setMensaje({
        tipo: 'warning',
        texto: '‚ö†Ô∏è No hay pr√°ctica activa'
      });
      return;
    }
    
    try {
      // Actualizar estado local
      const nuevasComprendidas = {
        ...preguntasComprendidas,
        [practicaId]: {
          ...(preguntasComprendidas[practicaId] || {}),
          [indicePregunta]: true
        }
      };
      setPreguntasComprendidas(nuevasComprendidas);
      
      // Guardar en getDatos/setDatos
      const practicas = await getDatos('practicas');
      const practicaIndex = practicas.findIndex(p => p.id === practicaId);
      
      if (practicaIndex >= 0) {
        if (!practicas[practicaIndex].preguntasComprendidas) {
          practicas[practicaIndex].preguntasComprendidas = {};
        }
        practicas[practicaIndex].preguntasComprendidas[indicePregunta] = {
          comprendida: true,
          fecha: new Date().toISOString()
        };
        
        // üî• GUARDAR EN CARPETA CORRESPONDIENTE
        await guardarPracticaEnCarpeta(practicas[practicaIndex]);
        
        setMensaje({
          tipo: 'success',
          texto: '‚úÖ Pregunta marcada como comprendida'
        });
      }
    } catch (error) {
      console.error('Error marcando pregunta como comprendida:', error);
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al marcar pregunta'
      });
    }
  }
  
  // Guardar examen en archivo local (a trav√©s del servidor)
  const guardarExamenLocal = async (respuestas = respuestasUsuario) => {
    // üî• NO guardar pr√°cticas en archivo temporal (solo ex√°menes)
    if (esPractica) {
      console.log('üö´ Pr√°ctica activa - no guardando en temporal de ex√°menes');
      return;
    }
    
    try {
      await fetch(`${API_URL}/api/examenes/guardar-temporal`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          preguntas: preguntasExamen,
          respuestas: respuestas,
          carpeta: carpetaExamen
        })
      })
      // No mostrar mensaje para no molestar al usuario
    } catch (error) {
      // Ignorar errores silenciosamente (servidor podr√≠a estar apagado)
      console.log('Guardado autom√°tico sin servidor - OK')
    }
  }
  
  // Cargar examen desde archivo local
  const cargarExamenLocal = async () => {
    try {
      const response = await fetch(`${API_URL}/api/examenes/cargar-temporal`)
      const data = await response.json()
      
      if (data.success && data.examen && data.examen.preguntas && data.examen.preguntas.length > 0) {
        const examen = data.examen
        // Validar que el examen tenga datos v√°lidos
        if (!examen.carpeta || !examen.carpeta.nombre) {
          console.log('‚ùå Examen temporal inv√°lido, limpiando...')
          await limpiarExamenLocal()
          return false
        }
        
        setPreguntasExamen(examen.preguntas)
        setRespuestasUsuario(examen.respuestas || {})
        setCarpetaExamen(examen.carpeta)
        setExamenActivo(true)
        setEsPractica(false) // üî• Es un EXAMEN, no pr√°ctica
        setModalExamenAbierto(true)
        setMensaje({
          tipo: 'success',
          texto: 'üìã Examen recuperado desde √∫ltima sesi√≥n'
        })
        return true
      } else {
        // No hay examen o est√° vac√≠o, limpiar por seguridad
        if (data.examen) {
          await limpiarExamenLocal()
        }
      }
    } catch (error) {
      console.log('No hay examen temporal para cargar')
    }
    return false
  }
  
  // Limpiar examen local
  const limpiarExamenLocal = async () => {
    try {
      await fetch(`${API_URL}/api/examenes/limpiar-temporal`, {
        method: 'DELETE'
      })
    } catch (error) {
      console.log('No se pudo limpiar examen temporal')
    }
  }
  
  // Inicializar reconocimiento de voz
  const iniciarReconocimientoVoz = () => {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Tu navegador no soporta reconocimiento de voz. Prueba con Chrome o Edge.'
      })
      return null
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition
    const recognition = new SpeechRecognition()
    
    recognition.lang = 'es-ES'
    recognition.continuous = true
    recognition.interimResults = true
    recognition.maxAlternatives = 1
    
    return recognition
  }
  
  // Alternar escucha de voz para una pregunta
  const alternarEscuchaVoz = (indicePregunta) => {
    // Si ya est√° escuchando esta pregunta, detener
    if (escuchandoPregunta === indicePregunta) {
      if (reconocimientoVoz) {
        reconocimientoVoz.stop()
      }
      setEscuchandoPregunta(null)
      setTranscripcionTemp('')
      return
    }
    
    // Si hay otro reconocimiento activo, detenerlo
    if (reconocimientoVoz) {
      reconocimientoVoz.stop()
    }
    
    // Crear nuevo reconocimiento
    const nuevoReconocimiento = iniciarReconocimientoVoz()
    if (!nuevoReconocimiento) return
    
    // Eventos del reconocimiento
    nuevoReconocimiento.onstart = () => {
      setEscuchandoPregunta(indicePregunta)
      setTranscripcionTemp('')
    }
    
    nuevoReconocimiento.onresult = (event) => {
      let transcripcionInterina = ''
      let transcripcionFinal = ''
      
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const transcript = event.results[i][0].transcript
        if (event.results[i].isFinal) {
          transcripcionFinal += transcript + ' '
        } else {
          transcripcionInterina += transcript
        }
      }
      
      // Actualizar transcripci√≥n temporal
      if (transcripcionInterina) {
        setTranscripcionTemp(transcripcionInterina)
      }
      
      // Si hay transcripci√≥n final, agregar a la respuesta
      if (transcripcionFinal) {
        const respuestaActual = respuestasUsuario[indicePregunta] || ''
        const nuevaRespuesta = respuestaActual + transcripcionFinal
        actualizarRespuesta(indicePregunta, nuevaRespuesta)
        setTranscripcionTemp('')
      }
    }
    
    nuevoReconocimiento.onerror = (event) => {
      console.error('Error en reconocimiento de voz:', event.error)
      if (event.error !== 'no-speech' && event.error !== 'aborted') {
        setMensaje({
          tipo: 'error',
          texto: '‚ùå Error en el reconocimiento de voz: ' + event.error
        })
      }
      setEscuchandoPregunta(null)
      setTranscripcionTemp('')
    }
    
    nuevoReconocimiento.onend = () => {
      // Si se detuvo inesperadamente y seguimos queriendo escuchar, reiniciar
      if (escuchandoPregunta === indicePregunta) {
        try {
          nuevoReconocimiento.start()
        } catch (e) {
          setEscuchandoPregunta(null)
          setTranscripcionTemp('')
        }
      }
    }
    
    setReconocimientoVoz(nuevoReconocimiento)
    nuevoReconocimiento.start()
  }
  
  // Limpiar reconocimiento al cerrar examen
  const detenerReconocimientoVoz = () => {
    if (reconocimientoVoz) {
      reconocimientoVoz.stop()
      setReconocimientoVoz(null)
    }
    setEscuchandoPregunta(null)
    setTranscripcionTemp('')
  }
  
  // Enviar examen para calificar
  const enviarExamen = async () => {
    if (Object.keys(respuestasUsuario).length === 0) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Debes responder al menos una pregunta'
      })
      return
    }
    
    setGenerandoExamen(true)
    
    try {
      // Determinar la ruta seg√∫n si es pr√°ctica o examen
      let carpetaRuta = carpetaExamen?.ruta || 'Examenes_Generales'
      if (esPractica && carpetaExamen?.tipo === 'practica') {
        // Para pr√°cticas, usar una carpeta de pr√°cticas
        carpetaRuta = `Practicas/${carpetaRuta}`
      }
      
      const response = await fetch(`${API_URL}/api/evaluar-examen`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          preguntas: preguntasExamen,
          respuestas: respuestasUsuario,
          carpeta_path: carpetaRuta,
          es_practica: esPractica
        })
      })
      
      const data = await response.json()
      
      console.log('üìä Datos recibidos del backend:', data);
      console.log('üìù Resultados:', data.resultados);
      
      if (data.success || data.resultados) {
        limpiarExamenLocal() // Limpiar guardado local
        setResultadoExamen(data)
        setExamenCompletado(true)
        
        console.log('‚úÖ ResultadoExamen guardado:', data);
        
        // Guardar progreso de pr√°ctica si viene de una pr√°ctica
        const practicas = await getDatos('practicas');
        
        // üî• BUSCAR POR ID √öNICO si tenemos examenActivo
        let practicaIndex = -1;
        if (examenActivo && examenActivo.id) {
          practicaIndex = practicas.findIndex(p => p.id === examenActivo.id);
          console.log('üîç Buscando pr√°ctica por ID:', examenActivo.id, '‚Üí √≠ndice:', practicaIndex);
        } else {
          // Fallback: buscar por caracter√≠sticas (m√©todo antiguo, menos confiable)
          practicaIndex = practicas.findIndex(p => {
            if (p.completada) return false;
            const esReciente = new Date(p.fecha).getTime() > Date.now() - 3600000; // √öltima hora
            return p.preguntas.length === preguntasExamen.length && esReciente;
          });
          console.log('‚ö†Ô∏è B√∫squeda sin ID - usando fallback ‚Üí √≠ndice:', practicaIndex);
        }
        
        if (practicaIndex !== -1) {
          console.log('üìù Actualizando pr√°ctica en √≠ndice:', practicaIndex);
          const ahora = new Date();
          const manana = new Date(ahora);
          manana.setDate(manana.getDate() + 1); // Programar pr√≥xima revisi√≥n para ma√±ana
          
          const practicaActual = practicas[practicaIndex];
          
          practicas[practicaIndex].respuestas = respuestasUsuario;
          practicas[practicaIndex].completada = true;
          practicas[practicaIndex].estado = 'completada';
          practicas[practicaIndex].fecha_completada = ahora.toISOString();
          practicas[practicaIndex].ultimaRevision = ahora.toISOString();
          practicas[practicaIndex].proximaRevision = manana.toISOString();
          practicas[practicaIndex].intervalo = 1;
          practicas[practicaIndex].repeticiones = 0;
          practicas[practicaIndex].facilidad = 2.5;
          practicas[practicaIndex].estadoRevision = 'nueva';
          practicas[practicaIndex].titulo = practicas[practicaIndex].titulo || `Pr√°ctica ${data.puntos_obtenidos}/${data.puntos_totales}`;
          practicas[practicaIndex].resultado = {
            puntos_obtenidos: data.puntos_obtenidos,
            puntos_totales: data.puntos_totales,
            porcentaje: data.porcentaje,
            resultados: data.resultados
          };
          
          // üî• GUARDAR EN CARPETA CORRESPONDIENTE
          await guardarPracticaEnCarpeta(practicas[practicaIndex]);
          setPracticas([...practicas]);
          console.log('‚úÖ Pr√°ctica actualizada con repetici√≥n espaciada programada en carpeta:', practicas[practicaIndex].carpeta);
          
          // üÉè CONVERTIR PREGUNTAS TIPO FLASHCARD A FLASHCARDS REALES
          const preguntasFlashcard = practicaActual.preguntas.filter(p => p.tipo === 'flashcard');
          if (preguntasFlashcard.length > 0) {
            console.log(`üé¥ Convirtiendo ${preguntasFlashcard.length} preguntas flashcard a flashcards reales`);
            
            for (const pregunta of preguntasFlashcard) {
              const nuevaFlashcard = {
                id: Date.now() + Math.random(),
                tipo: 'clasica',
                titulo: pregunta.pregunta,
                contenido: pregunta.respuesta_correcta || '',
                opciones: pregunta.opciones || [],
                respuestaCorrecta: pregunta.respuesta_correcta || '',
                explicacion: pregunta.explicacion || pregunta.feedback || '',
                tema: pregunta.tema || pregunta.metadata?.tema || '',
                subtema: pregunta.subtema || '',
                carpeta: practicaActual.carpeta || '',
                fecha: ahora.toISOString(),
                fecha_creacion: ahora.toISOString(),
                proximaRevision: manana.toISOString(),
                intervalo: 1,
                repeticiones: 0,
                facilidad: 2.5,
                estadoRevision: 'nueva',
                archivos: [],
                imagenes: [],
                latex: false,
                dificultad: 'medio'
              };
              
              // Guardar cada flashcard en su carpeta individual
              try {
                await fetch(`${API_URL}/datos/flashcards/carpeta`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    flashcard: nuevaFlashcard,
                    carpeta: practicaActual.carpeta || ''
                  })
                });
              } catch (error) {
                console.error('Error guardando flashcard de pr√°ctica:', error);
              }
            }
            
            // Recargar todas las flashcards
            const todasFlashcards = await cargarTodasFlashcards();
            setFlashcardsActuales(todasFlashcards);
            console.log(`‚úÖ ${preguntasFlashcard.length} flashcards guardadas en carpeta: ${practicaActual.carpeta}`);
          }
        } else if (!esPractica) {
          // üî• SI ES UN EXAMEN (NO PR√ÅCTICA), GUARDARLO EN SU CARPETA
          console.log('üìù Guardando examen completado en carpeta:', carpetaExamen?.ruta);
          const ahora = new Date();
          const manana = new Date(ahora);
          manana.setDate(manana.getDate() + 1);
          
          const nuevoExamen = {
            id: `examen_${Date.now()}`,
            preguntas: preguntasExamen,
            respuestas: respuestasUsuario,
            completado: true,
            carpeta: carpetaExamen?.ruta || 'Sin carpeta',
            titulo: `Examen ${data.puntos_obtenidos}/${data.puntos_totales}`,
            fecha: ahora.toISOString(),
            fecha_creacion: ahora.toISOString(),
            fecha_completada: ahora.toISOString(),
            ultimaRevision: ahora.toISOString(),
            proximaRevision: manana.toISOString(),
            intervalo: 1,
            repeticiones: 0,
            facilidad: 2.5,
            estadoRevision: 'nueva',
            resultado: {
              puntos_obtenidos: data.puntos_obtenidos,
              puntos_totales: data.puntos_totales,
              porcentaje: data.porcentaje,
              resultados: data.resultados
            }
          };
          
          await guardarExamenEnCarpeta(nuevoExamen);
          console.log('‚úÖ Examen guardado en carpeta:', nuevoExamen.carpeta);
        } else {
          console.log('‚ö†Ô∏è No se encontr√≥ pr√°ctica activa para actualizar');
        }
        
        // üî• CONVERTIR ERRORES Y ACIERTOS EN FLASHCARDS AUTOM√ÅTICAMENTE
        if (data.resultados && Array.isArray(data.resultados)) {
          const ahora = new Date();
          const manana = new Date(ahora);
          manana.setDate(manana.getDate() + 1);
          
          const errores = data.resultados.filter(r => {
            const porcentaje = (r.puntos / r.puntos_maximos) * 100;
            return porcentaje < 60; // Menos de 60% = error
          });
          
          const aciertos = data.resultados.filter(r => {
            const porcentaje = (r.puntos / r.puntos_maximos) * 100;
            return porcentaje >= 60; // 60% o m√°s = acierto
          });
          
          // üéØ ERRORES: Revisi√≥n ma√±ana
          if (errores.length > 0) {
            console.log(`üéØ Creando ${errores.length} flashcards de errores`);
            
            for (const error of errores) {
              const nuevaFlashcard = {
                id: Date.now() + Math.random(),
                tipo: 'clasica',
                titulo: error.pregunta,
                contenido: error.respuesta_correcta || error.feedback || '',
                opciones: error.opciones || [],
                respuestaCorrecta: error.respuesta_correcta || '',
                explicacion: error.feedback || '',
                tema: 'Error de examen',
                subtema: '',
                carpeta: carpetaExamen?.ruta || 'Sin carpeta',
                fecha: ahora.toISOString(),
                fecha_creacion: ahora.toISOString(),
                proximaRevision: manana.toISOString(), // üî• Pr√≥xima revisi√≥n MA√ëANA
                intervalo: 1,
                repeticiones: 0,
                facilidad: 2.5,
                estadoRevision: 'nueva',
                archivos: [],
                imagenes: [],
                latex: false,
                dificultad: 'medio'
              };
              
              // Guardar flashcard en carpeta
              try {
                await fetch(`${API_URL}/datos/flashcards/carpeta`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    flashcard: nuevaFlashcard,
                    carpeta: carpetaExamen?.ruta || 'Sin carpeta'
                  })
                });
              } catch (error) {
                console.error('Error guardando flashcard de error:', error);
              }
            }
            console.log(`‚úÖ ${errores.length} flashcards de errores creadas para revisi√≥n ma√±ana`);
          }
          
          // ‚úÖ ACIERTOS: Revisi√≥n entre 3 y 10 d√≠as
          if (aciertos.length > 0) {
            console.log(`‚úÖ Creando ${aciertos.length} flashcards de aciertos`);
            
            for (const acierto of aciertos) {
              const diasAleatorios = Math.floor(Math.random() * 8) + 3; // 3-10 d√≠as
              const fechaRevision = new Date(ahora);
              fechaRevision.setDate(fechaRevision.getDate() + diasAleatorios);
              
              const nuevaFlashcard = {
                id: Date.now() + Math.random(),
                tipo: 'clasica',
                titulo: acierto.pregunta,
                contenido: acierto.respuesta_correcta || acierto.feedback || '',
                opciones: acierto.opciones || [],
                respuestaCorrecta: acierto.respuesta_correcta || '',
                explicacion: acierto.feedback || '',
                tema: 'Acierto de examen',
                subtema: '',
                carpeta: carpetaExamen?.ruta || 'Sin carpeta',
                fecha: ahora.toISOString(),
                fecha_creacion: ahora.toISOString(),
                proximaRevision: fechaRevision.toISOString(), // üî• Revisi√≥n en 3-10 d√≠as
                intervalo: diasAleatorios,
                repeticiones: 1,
                facilidad: 2.6, // Un poco m√°s f√°cil porque ya acert√≥
                estadoRevision: 'en_progreso',
                archivos: [],
                imagenes: [],
                latex: false,
                dificultad: 'medio'
              };
              
              // Guardar flashcard en carpeta
              try {
                await fetch(`${API_URL}/datos/flashcards/carpeta`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    flashcard: nuevaFlashcard,
                    carpeta: carpetaExamen?.ruta || 'Sin carpeta'
                  })
                });
              } catch (error) {
                console.error('Error guardando flashcard de acierto:', error);
              }
            }
            console.log(`‚úÖ ${aciertos.length} flashcards de aciertos creadas para revisi√≥n en 3-10 d√≠as`);
          }
          
          // Recargar flashcards si se cre√≥ alguna
          if (errores.length > 0 || aciertos.length > 0) {
            const todasFlashcards = await cargarTodasFlashcards();
            setFlashcardsActuales(todasFlashcards);
          }
        }
        
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Examen calificado: ${data.puntos_obtenidos}/${data.puntos_totales} puntos (${data.porcentaje.toFixed(1)}%)`
        })
        // Recargar lista de ex√°menes guardados
        cargarExamenesGuardados()
        // Recargar carpetas de ex√°menes para actualizar contadores
        cargarCarpetasExamenes(rutaActualExamenes)
      } else {
        throw new Error(data.message || 'Error al evaluar')
      }
    } catch (error) {
      console.error('Error evaluando examen:', error)
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al calificar el examen: ' + error.message
      })
    } finally {
      setGenerandoExamen(false)
    }
  }
  
  // Pausar examen (guardar progreso)
  const pausarExamen = async () => {
    if (preguntasExamen.length === 0) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå No hay examen activo para pausar'
      })
      return
    }
    
    try {
      // Usar carpeta asignada o carpeta por defecto
      let carpetaRuta = carpetaExamen?.ruta || 'Examenes_Generales'
      let carpetaNombre = carpetaExamen?.nombre || 'Ex√°menes Generales'
      
      // Para pr√°cticas, usar carpeta de pr√°cticas
      if (esPractica && carpetaExamen?.tipo === 'practica') {
        carpetaRuta = `Practicas/${carpetaRuta}`
        carpetaNombre = `Pr√°cticas - ${carpetaNombre}`
      }
      
      const response = await fetch(`${API_URL}/api/examenes/pausar`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          carpeta_ruta: carpetaRuta,
          carpeta_nombre: carpetaNombre,
          preguntas: preguntasExamen,
          respuestas: respuestasUsuario,
          fecha_inicio: new Date().toISOString(),
          es_practica: esPractica
        })
      })
      
      const data = await response.json()
      if (data.success) {
        limpiarExamenLocal() // Limpiar guardado local
        setMensaje({
          tipo: 'success',
          texto: '‚è∏Ô∏è Examen pausado correctamente. Ve a la pesta√±a "Generar Ex√°menes" para continuarlo'
        })
        cerrarExamen()
        cargarExamenesGuardados()
        // Cambiar autom√°ticamente a la pesta√±a de generar ex√°menes
        setTimeout(() => {
          setSelectedMenu('generar')
        }, 2000)
      }
    } catch (error) {
      console.error('Error pausando examen:', error)
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al pausar el examen'
      })
    }
  }
  
  // Continuar examen pausado
  const continuarExamen = (examen) => {
    limpiarExamenLocal() // Limpiar cualquier examen local anterior
    setPreguntasExamen(examen.preguntas)
    setRespuestasUsuario(examen.respuestas || {})
    setCarpetaExamen({
      ruta: examen.carpeta_ruta,
      nombre: examen.carpeta_nombre
    })
    setExamenActivo(true)
    setResultadoExamen(null)
    setModalExamenAbierto(true)
    setModalListaExamenes(false)
    // Guardar en localStorage para continuar trabajando sin servidor
    guardarExamenLocal(examen.respuestas || {})
  }
  
  // Ver resultado de examen completado
  const verResultadoExamen = (examen) => {
    setViendoExamen(examen)
    setModalListaExamenes(false)
  }
  
  // Reintentar examen completado
  const reintentarExamen = (examen) => {
    // Cargar las preguntas del examen
    setPreguntasExamen(examen.resultados.map((r, idx) => ({
      pregunta: r.pregunta,
      tipo: r.tipo,
      opciones: r.opciones || [],
      respuesta_correcta: r.respuesta_correcta,
      puntos: r.puntos_maximos
    })))
    
    // Configurar la carpeta
    setCarpetaExamen({
      ruta: examen.carpeta_ruta,
      nombre: examen.carpeta_nombre
    })
    
    // Limpiar respuestas y abrir modal
    setRespuestasUsuario({})
    setResultadoExamen(null)
    setExamenActivo(true)
    setModalExamenAbierto(true)
    setViendoExamen(null)
    
    setMensaje({
      tipo: 'info',
      texto: 'üîÑ Reintentando examen. ¬°Buena suerte!'
    })
  }
  
  // Cerrar examen
  const cerrarExamen = async () => {
    // Guardar progreso de pr√°ctica si no est√° completada
    if (!examenCompletado && preguntasExamen.length > 0) {
      const practicas = await getDatos('practicas');
      const practicaIndex = practicas.findIndex(p => 
        p.preguntas.length === preguntasExamen.length &&
        JSON.stringify(p.preguntas) === JSON.stringify(preguntasExamen)
      );
      
      if (practicaIndex !== -1) {
        // Actualizar respuestas parciales
        practicas[practicaIndex].respuestas = respuestasUsuario;
        
        // üî• GUARDAR EN CARPETA CORRESPONDIENTE
        await guardarPracticaEnCarpeta(practicas[practicaIndex]);
        console.log('‚úÖ Progreso guardado autom√°ticamente');
      }
    }
    
    detenerReconocimientoVoz() // Detener reconocimiento de voz
    setModalExamenAbierto(false)
    setExamenActivo(null)
    setPreguntasExamen([])
    setRespuestasUsuario({})
    setResultadoExamen(null)
    setCarpetaExamen(null)
  }
  
  // Reiniciar examen
  const reiniciarExamen = () => {
    detenerReconocimientoVoz() // Detener reconocimiento de voz
    setRespuestasUsuario({})
    setResultadoExamen(null)
  }

  // Nueva funci√≥n para generar pr√°ctica
  const generarPractica = async (ruta) => {
    try {
      setLoading(true);
      const response = await fetch(`${API_URL}/api/generar_practica`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ ruta }),
      });

      if (response.ok) {
        const data = await response.json();
        setPreguntasExamen(data.preguntas || []);
        setMensaje('Pr√°ctica generada con √©xito.');
        setModalExamenAbierto(true);
      } else {
        const errorData = await response.json();
        setMensaje(`Error: ${errorData.detail || 'No se pudo generar la pr√°ctica.'}`);
      }
    } catch (error) {
      setMensaje('Error al conectar con el servidor.');
    } finally {
      setLoading(false);
    }
  };

  const abrirGenerarPractica = () => {
    const ruta = prompt('Ingrese la ruta de la carpeta para generar la pr√°ctica:')
    if (ruta) {
      generarPractica(ruta)
    }
  }

  const [modalPracticaAbierto, setModalPracticaAbierto] = useState(false);
  const [promptPractica, setPromptPractica] = useState('');
  const [carpetaPractica, setCarpetaPractica] = useState(null);
  const [tipoFuentePractica, setTipoFuentePractica] = useState('carpeta'); // 'carpeta' o 'documento'
  
  // Configuraci√≥n de tipos de pr√°ctica - Generales
  const [numFlashcards, setNumFlashcards] = useState(0);
  const [tipoFlashcard, setTipoFlashcard] = useState('respuesta_corta'); // 'respuesta_corta' o 'seleccion_confusa'
  
  // 12 Flashcards Avanzadas
  const [numFlashClassic, setNumFlashClassic] = useState(0);
  const [numFlashRecognition, setNumFlashRecognition] = useState(0);
  const [numFlashCloze, setNumFlashCloze] = useState(0);
  const [numFlashScenario, setNumFlashScenario] = useState(0);
  const [numFlashMCQ, setNumFlashMCQ] = useState(0);
  const [numFlashVisual, setNumFlashVisual] = useState(0);
  const [numFlashAudio, setNumFlashAudio] = useState(0);
  const [numFlashProduction, setNumFlashProduction] = useState(0);
  const [numFlashReversed, setNumFlashReversed] = useState(0);
  const [numFlashHierarchy, setNumFlashHierarchy] = useState(0);
  const [numFlashError, setNumFlashError] = useState(0);
  const [numFlashComparison, setNumFlashComparison] = useState(0);
  
  const [numMCQ, setNumMCQ] = useState(0);
  const [numCloze, setNumCloze] = useState(0);
  const [numOpenQuestion, setNumOpenQuestion] = useState(0);
  const [numVerdaderoFalso, setNumVerdaderoFalso] = useState(0);
  const [numRespuestaCorta, setNumRespuestaCorta] = useState(0);
  const [numCasoEstudio, setNumCasoEstudio] = useState(0);
  const [tipoCasoEstudio, setTipoCasoEstudio] = useState('descriptivo'); // Tipo de caso de estudio
  
  // Reading types (6 tipos)
  const [numReadingComprehension, setNumReadingComprehension] = useState(0);
  const [numReadingTrueFalse, setNumReadingTrueFalse] = useState(0);
  const [numReadingCloze, setNumReadingCloze] = useState(0);
  const [numReadingSkill, setNumReadingSkill] = useState(0);
  const [numReadingMatching, setNumReadingMatching] = useState(0);
  const [numReadingSequence, setNumReadingSequence] = useState(0);
  
  // Writing types (8 tipos)
  const [numWritingShort, setNumWritingShort] = useState(0);
  const [numWritingParaphrase, setNumWritingParaphrase] = useState(0);
  const [numWritingCorrection, setNumWritingCorrection] = useState(0);
  const [numWritingTransformation, setNumWritingTransformation] = useState(0);
  const [numWritingEssay, setNumWritingEssay] = useState(0);
  const [numWritingSentenceBuilder, setNumWritingSentenceBuilder] = useState(0);
  const [numWritingPictureDescription, setNumWritingPictureDescription] = useState(0);
  const [numWritingEmail, setNumWritingEmail] = useState(0);

  const abrirModalPractica = (ruta, tipo = 'carpeta') => {
    // Limpiar estado anterior
    setPreguntasExamen([]);
    setRespuestasUsuario({});
    setExamenCompletado(false);
    setResultadoExamen(null);
    setFlashcardsVolteadas({});
    
    setCarpetaPractica(ruta);
    setTipoFuentePractica(tipo);
    setPromptPractica(''); 
    setModalPracticaAbierto(true);
  };

  const confirmarGenerarPractica = async () => {
    // Limpiar estados antes de generar nueva pr√°ctica
    setPreguntasExamen([]);
    setRespuestasUsuario({});
    setExamenCompletado(false);
    setResultadoExamen(null);
    setFlashcardsVolteadas({});
    
    setModalPracticaAbierto(false);
    if (!carpetaPractica) return;
    
    const totalPreguntas = numFlashcards + numMCQ + numVerdaderoFalso + numCloze + numRespuestaCorta + numOpenQuestion + numCasoEstudio +
                          numReadingComprehension + numReadingTrueFalse + numReadingCloze + numReadingSkill + numReadingMatching + numReadingSequence +
                          numWritingShort + numWritingParaphrase + numWritingCorrection + numWritingTransformation + 
                          numWritingEssay + numWritingSentenceBuilder + numWritingPictureDescription + numWritingEmail;
    if (totalPreguntas === 0) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Debes seleccionar al menos un tipo de pregunta'
      });
      return;
    }
    
    setLoading(true);
    setMensaje({
      tipo: 'info',
      texto: `‚è≥ Generando ${totalPreguntas} preguntas de pr√°ctica...`
    });
    
    try {
      // Construir el prompt con las especificaciones JSON para cada tipo
      // NOTA: Este prompt solo se usa si NO hay archivo/ruta
      // Cuando hay ruta, el backend carga el contenido y genera el prompt internamente
      let promptCompleto = ``;
      
      if (promptPractica.trim()) {
        promptCompleto += `INSTRUCCIONES PERSONALIZADAS:\n${promptPractica}\n\n`;
      }
      
      promptCompleto += `TIPOS DE PREGUNTAS A GENERAR:\n\n`;
      
      if (numFlashcards > 0) {
        const tipoTexto = tipoFlashcard === 'seleccion_confusa' 
          ? 'SELECCI√ìN CONFUSA - 4 opciones donde solo 1 es correcta'
          : 'RESPUESTA CORTA - Usuario escribe libremente';
          
        promptCompleto += `**${numFlashcards} Flashcards (${tipoTexto})** - Formato JSON con evaluaci√≥n (ESTILO ANKI - JUEGO DE ADIVINANZAS):
`;
        
        if (tipoFlashcard === 'seleccion_confusa') {
          promptCompleto += `{
  "type": "flashcard",
  "flashcard_type": "seleccion_confusa",
  "difficulty": 1,
  "tags": ["concepto1", "tema2"],
  "data": {
    "front": "Pregunta desafiante tipo adivinanza",
    "hint": "Pista inteligente que ayude sin dar la respuesta completa"
  },
  "confusing_options": [
    "Respuesta CORRECTA clara",
    "Opci√≥n confusa pero incorrecta (similar a la correcta)",
    "Otra opci√≥n confusa (concepto relacionado pero err√≥neo)",
    "Opci√≥n trampa (suena bien pero es falsa)"
  ],
  "solution": {
    "answer": "Respuesta CORRECTA (DEBE coincidir EXACTAMENTE con confusing_options[0])",
    "key_points": ["Concepto clave 1", "Concepto clave 2", "Concepto clave 3"],
    "explanation": "Explicaci√≥n pedag√≥gica detallada del concepto"
  }
}

üéØ REGLAS CR√çTICAS PARA SELECCI√ìN CONFUSA:
- confusing_options: ARRAY de exactamente 4 opciones
- La opci√≥n [0] es la CORRECTA
- Las opciones [1], [2], [3] son CONFUSAS pero incorrectas
- Las opciones confusas deben ser SIMILARES para que sea dif√≠cil elegir
- solution.answer DEBE ser id√©ntica a confusing_options[0]
- hint: SIEMPRE genera una pista √∫til que ayude a distinguir

Ejemplo completo:
{
  "type": "flashcard",
  "flashcard_type": "seleccion_confusa",
  "data": {
    "front": "¬øQu√© principio de dise√±o sugiere que menos elementos visuales crean una mejor experiencia?",
    "hint": "Piensa en la filosof√≠a de 'menos es m√°s' aplicada al dise√±o"
  },
  "confusing_options": [
    "Minimalismo",
    "Funcionalismo",
    "Esencialismo",
    "Reduccionismo"
  ],
  "solution": {
    "answer": "Minimalismo",
    "key_points": ["Simplicidad", "Reducci√≥n de elementos", "Enfoque en lo esencial"],
    "explanation": "El minimalismo es un principio de dise√±o que se basa en eliminar todo lo innecesario..."
  }
}
`;
        } else {
          promptCompleto += `{
  "type": "flashcard",
  "flashcard_type": "respuesta_corta",
  "difficulty": 1,
  "tags": ["concepto1", "tema2"],
  "data": {
    "front": "Pregunta desafiante que invite a pensar (NO revelar la respuesta)",
    "hint": "Pista inteligente que ayude sin dar la respuesta completa. SIEMPRE GENERA UNA PISTA √öTIL."
  },
  "solution": {
    "answer": "Respuesta correcta clara y concisa",
    "key_points": ["Concepto clave 1", "Concepto clave 2", "Concepto clave 3"],
    "explanation": "Explicaci√≥n pedag√≥gica detallada del concepto (3-4 oraciones que profundicen)"
  }
}

üéØ REGLAS CR√çTICAS PARA RESPUESTA CORTA:
- front: Pregunta tipo adivinanza que haga pensar al usuario
- hint: SIEMPRE genera una pista √∫til (palabra clave, categor√≠a, ejemplo parcial). NUNCA dejes vac√≠o "".
- La pista debe dar una direcci√≥n sin revelar todo
- answer: Respuesta modelo de 1-2 l√≠neas m√°ximo
- key_points: Conceptos esenciales que debe mencionar (3-5 puntos)
- explanation: Explicaci√≥n completa con contexto adicional
- difficulty: 1 (concepto b√°sico), 2 (aplicaci√≥n), 3 (an√°lisis profundo)

Ejemplo de buena flashcard:
{
  "data": {
    "front": "¬øQu√© principio de dise√±o sugiere que menos elementos visuales crean una mejor experiencia?",
    "hint": "Piensa en la filosof√≠a de 'menos es m√°s' aplicada al dise√±o"
  },
  "solution": {
    "answer": "Minimalismo",
    "key_points": ["Simplicidad", "Reducci√≥n de elementos", "Enfoque en lo esencial"],
    "explanation": "El minimalismo es un principio de dise√±o que se basa en eliminar todo lo innecesario para mantener solo los elementos esenciales. Esto mejora la claridad, facilita el uso y crea interfaces m√°s elegantes y efectivas."
  }
}
`;
        }
        promptCompleto += `\n\n`;
      }
      
      if (numMCQ > 0) {
        promptCompleto += `**${numMCQ} Preguntas de Opci√≥n M√∫ltiple (MCQ)** - Formato JSON:
{
  "type": "mcq",
  "difficulty": "easy|medium|hard",
  "tags": ["concepto1"],
  "question": "Pregunta clara",
  "description": "Contexto o informaci√≥n adicional para la pregunta (opcional)",
  "options": ["Opci√≥n A", "Opci√≥n B", "Opci√≥n C", "Opci√≥n D"],
  "correct_indices": [0, 2],
  "explanation": "Por qu√© estas opciones son correctas y las otras no"
}\n\n`;
      }
      
      if (numVerdaderoFalso > 0) {
        promptCompleto += `**${numVerdaderoFalso} Verdadero/Falso** - Formato JSON:
{
  "type": "true_false",
  "difficulty": "easy|medium|hard",
  "tags": ["concepto1"],
  "statement": "Afirmaci√≥n clara y espec√≠fica",
  "description": "Contexto adicional sobre la afirmaci√≥n (opcional)",
  "correct_answer": true,
  "explanation": "Explicaci√≥n detallada de por qu√© es verdadera o falsa"
}\n\n`;
      }
      
      if (numCloze > 0) {
        promptCompleto += `**${numCloze} Cloze Test (Relleno de huecos)** - Formato JSON:
{
  "type": "cloze",
  "difficulty": "easy|medium|hard",
  "tags": ["concepto1"],
  "description": "Contexto o instrucci√≥n (opcional)",
  "text_with_gaps": "El {{}} es fundamental porque {{}}",
  "answers": ["concepto clave", "explicaci√≥n breve"],
  "hint": "Pista opcional"
}\n\n`;
      }
      
      if (numRespuestaCorta > 0) {
        promptCompleto += `**${numRespuestaCorta} Respuesta Corta** - Formato JSON:
{
  "type": "short_answer",
  "difficulty": "easy|medium|hard",
  "tags": ["concepto1"],
  "question": "Pregunta que requiere respuesta breve (1-3 frases)",
  "description": "Contexto o aclaraci√≥n adicional (opcional)",
  "expected_answer": "Respuesta modelo concisa",
  "keywords": ["palabra1", "palabra2", "concepto3"],
  "explanation": "Explicaci√≥n ampliada de la respuesta"
}\n\n`;
      }
      
      if (numOpenQuestion > 0) {
        promptCompleto += `**${numOpenQuestion} Preguntas Abiertas de Desarrollo** - Formato JSON:
{
  "type": "open_question",
  "difficulty": "easy|medium|hard",
  "tags": ["concepto1"],
  "question": "Pregunta que requiere explicaci√≥n detallada",
  "description": "Contexto o instrucciones espec√≠ficas (opcional)",
  "expected_answer": "Respuesta modelo completa y estructurada",
  "key_points": ["Punto 1 para evaluar", "Punto 2 para evaluar", "Punto 3 para evaluar"]
}\n\n`;
      }
      
      if (numCasoEstudio > 0) {
        promptCompleto += `**${numCasoEstudio} Casos de Estudio** - Formato JSON:
{
  "type": "case_study",
  "difficulty": "medium|hard",
  "tags": ["aplicaci√≥n", "an√°lisis"],
  "scenario": "Descripci√≥n detallada de la situaci√≥n o caso pr√°ctico (2-4 p√°rrafos)",
  "question": "¬øQu√© har√≠as en esta situaci√≥n? ¬øC√≥mo lo resolver√≠as? ¬øQu√© enfoque usar√≠as?",
  "description": "Instrucciones espec√≠ficas o aspectos a considerar",
  "expected_approach": "Enfoque o metodolog√≠a esperada",
  "key_considerations": ["Aspecto clave 1", "Aspecto clave 2", "Aspecto clave 3"],
  "sample_answer": "Ejemplo de respuesta bien estructurada"
}\n\n`;
      }
      
      // ========== READING TYPES (6 tipos) ==========
      
      if (numReadingComprehension > 0) {
        promptCompleto += `**${numReadingComprehension} Reading Comprehension** - Formato JSON:
{
  "type": "reading_comprehension",
  "difficulty": "easy|medium|hard",
  "tags": ["reading", "comprehension"],
  "text": "Texto en ingl√©s de 100-200 palabras sobre un tema espec√≠fico",
  "questions": [
    {
      "type": "mcq",
      "question": "What is the main idea of the text?",
      "options": ["Option A", "Option B", "Option C", "Option D"],
      "correct_indices": [1],
      "explanation": "Explanation of why this is correct"
    },
    {
      "type": "true_false",
      "statement": "The author argues that...",
      "correct_answer": true,
      "explanation": "Evidence from the text"
    },
    {
      "type": "short_answer",
      "question": "According to the text, what is...?",
      "expected_answer": "Brief answer based on text",
      "keywords": ["key", "terms"]
    }
  ]
}\n\n`;
      }
      
      if (numReadingTrueFalse > 0) {
        promptCompleto += `**${numReadingTrueFalse} Reading True/False with Justification** - Formato JSON:
{
  "type": "reading_true_false",
  "difficulty": "easy|medium|hard",
  "tags": ["reading", "critical_thinking"],
  "text": "Texto en ingl√©s de 100-150 palabras",
  "statements": [
    {
      "claim": "The main character is a doctor.",
      "answer": false,
      "explanation_expected": "He is a student, as mentioned in paragraph 2.",
      "keywords": ["student", "mentioned"]
    },
    {
      "claim": "The story takes place in London.",
      "answer": true,
      "explanation_expected": "The text explicitly states London in line 3.",
      "keywords": ["London", "line 3"]
    }
  ]
}\n\n`;
      }
      
      if (numReadingCloze > 0) {
        promptCompleto += `**${numReadingCloze} Reading Cloze (Fill in the gaps)** - Formato JSON:
{
  "type": "reading_cloze",
  "difficulty": "easy|medium|hard",
  "tags": ["reading", "vocabulary", "grammar"],
  "text_with_gaps": "The company ______ to expand last year. They ______ several new offices across Europe.",
  "answers": ["decided", "opened"],
  "hint": "Use past simple tense",
  "context": "Short text about business expansion (opcional)"
}\n\n`;
      }
      
      if (numReadingSkill > 0) {
        promptCompleto += `**${numReadingSkill} Reading Skill (Main Idea/Details/Inference)** - Formato JSON:
{
  "type": "reading_skill",
  "skill": "inference|main_idea|detail|purpose|tone",
  "difficulty": "medium|hard",
  "tags": ["reading", "analysis"],
  "text": "Texto en ingl√©s de 150-250 palabras",
  "question": "What can be inferred from paragraph 2 about the author's opinion?",
  "expected_keywords": ["because", "implies", "suggests", "indicates"],
  "expected_answer": "The author implies that technology has changed communication patterns.",
  "explanation": "Evidence: paragraph 2 states '...', which suggests..."
}\n\n`;
      }
      
      if (numReadingMatching > 0) {
        promptCompleto += `**${numReadingMatching} Reading Matching (Match sentences to paragraphs)** - Formato JSON:
{
  "type": "reading_matching",
  "difficulty": "medium|hard",
  "tags": ["reading", "comprehension"],
  "text_paragraphs": [
    "Paragraph 1 content about topic A...",
    "Paragraph 2 content about topic B...",
    "Paragraph 3 content about topic C..."
  ],
  "sentences": [
    "This paragraph describes the historical context.",
    "The author argues for immediate action here.",
    "This section provides statistical evidence."
  ],
  "correct_mapping": [0, 2, 1],
  "explanation": "Sentence 1 matches paragraph 1 because..., sentence 2 matches paragraph 3..."
}\n\n`;
      }
      
      if (numReadingSequence > 0) {
        promptCompleto += `**${numReadingSequence} Reading Sequence (Order events)** - Formato JSON:
{
  "type": "reading_sequence",
  "difficulty": "easy|medium",
  "tags": ["reading", "narrative"],
  "shuffled_text": [
    "Event A: The team celebrated their victory.",
    "Event B: They trained for six months.",
    "Event C: The final match began at noon."
  ],
  "correct_order": [1, 2, 0],
  "explanation": "The logical sequence is B (training) ‚Üí C (match) ‚Üí A (celebration)",
  "context": "Brief introduction to the narrative (opcional)"
}\n\n`;
      }
      
      // ========== WRITING TYPES (8 tipos) ==========
      
      if (numWritingShort > 0) {
        promptCompleto += `**${numWritingShort} Writing Short Answer** - Formato JSON:
{
  "type": "writing_short",
  "difficulty": "easy|medium|hard",
  "tags": ["writing", "explanation"],
  "prompt": "Explain why the Earth has seasons.",
  "expected_keywords": ["tilt", "sunlight", "axis", "orbit"],
  "max_words": 50,
  "min_words": 30,
  "expected_answer": "The Earth has seasons because its axis is tilted. This tilt causes different amounts of sunlight to reach different parts of Earth as it orbits the Sun.",
  "evaluation_criteria": ["keyword presence", "grammatical accuracy", "coherence"]
}\n\n`;
      }
      
      if (numWritingParaphrase > 0) {
        promptCompleto += `**${numWritingParaphrase} Writing Paraphrase** - Formato JSON:
{
  "type": "writing_paraphrase",
  "difficulty": "medium|hard",
  "tags": ["writing", "paraphrasing"],
  "original": "Global warming is affecting weather patterns around the world.",
  "expected_features": ["preserve meaning", "different structure", "synonyms"],
  "sample_paraphrase": "Climate change is influencing meteorological systems across the globe.",
  "forbidden_words": ["global", "warming"],
  "evaluation_criteria": ["meaning preserved", "structure changed", "vocabulary varied"]
}\n\n`;
      }
      
      if (numWritingCorrection > 0) {
        promptCompleto += `**${numWritingCorrection} Writing Error Correction** - Formato JSON:
{
  "type": "writing_correction",
  "difficulty": "easy|medium|hard",
  "tags": ["writing", "grammar"],
  "text_with_errors": "She don't likes apples. Yesterday, she go to the market and buy some oranges.",
  "correct_text": "She doesn't like apples. Yesterday, she went to the market and bought some oranges.",
  "error_types": ["subject-verb agreement", "verb tense"],
  "num_errors": 4,
  "hint": "Check verb forms and tenses"
}\n\n`;
      }
      
      if (numWritingTransformation > 0) {
        promptCompleto += `**${numWritingTransformation} Writing Transformation** - Formato JSON:
{
  "type": "writing_transformation",
  "difficulty": "medium|hard",
  "tags": ["writing", "grammar"],
  "prompt": "Rewrite the sentence in the past simple.",
  "input_sentence": "She goes to school every day.",
  "expected_output": "She went to school.",
  "transformation_type": "tense_change|voice_change|form_change|negative|question",
  "hint": "Remember irregular verb forms",
  "alternative_answers": ["She went to school yesterday."]
}\n\n`;
      }
      
      if (numWritingEssay > 0) {
        promptCompleto += `**${numWritingEssay} Writing Mini-Essay** - Formato JSON:
{
  "type": "writing_essay",
  "difficulty": "medium|hard",
  "tags": ["writing", "composition"],
  "prompt": "Write 120-150 words about the impact of social media on modern communication.",
  "expected_structure": ["introduction", "body", "conclusion"],
  "keywords": ["communication", "influence", "behavior", "technology"],
  "min_words": 120,
  "max_words": 150,
  "sample_answer": "Social media has fundamentally transformed how we communicate...",
  "evaluation_criteria": ["structure", "coherence", "vocabulary range", "grammar", "task completion"]
}\n\n`;
      }
      
      if (numWritingSentenceBuilder > 0) {
        promptCompleto += `**${numWritingSentenceBuilder} Writing Sentence Builder** - Formato JSON:
{
  "type": "writing_sentence_builder",
  "difficulty": "easy|medium",
  "tags": ["writing", "structure"],
  "blocks": ["Although", "he was tired", "he finished the project", "on time"],
  "correct_sentence": "Although he was tired, he finished the project on time.",
  "alternative_orders": ["He finished the project on time although he was tired."],
  "hint": "Start with a subordinating conjunction",
  "grammar_focus": "complex sentences with subordinate clauses"
}\n\n`;
      }
      
      if (numWritingPictureDescription > 0) {
        promptCompleto += `**${numWritingPictureDescription} Writing Picture Description** - Formato JSON:
{
  "type": "writing_picture_description",
  "difficulty": "medium",
  "tags": ["writing", "description"],
  "description_prompt": "Imagine a photo showing a busy street market in an Asian city. Describe what you see in 80-100 words.",
  "expected_elements": ["people", "activities", "environment", "atmosphere"],
  "required_vocabulary": ["crowd", "vendors", "stalls", "colorful"],
  "min_words": 80,
  "max_words": 100,
  "sample_answer": "The photograph captures a vibrant street market bustling with activity...",
  "evaluation_criteria": ["descriptive language", "present continuous usage", "vocabulary range"]
}\n\n`;
      }
      
      if (numWritingEmail > 0) {
        promptCompleto += `**${numWritingEmail} Writing Email/Message** - Formato JSON:
{
  "type": "writing_email",
  "difficulty": "medium",
  "tags": ["writing", "formal_informal"],
  "prompt": "Write a short email (60-80 words) requesting information about a product you want to buy.",
  "email_type": "formal|informal",
  "expected_sections": ["greeting", "purpose", "specific_request", "closing"],
  "required_elements": ["polite language", "clear purpose", "contact information"],
  "min_words": 60,
  "max_words": 80,
  "sample_answer": "Dear Sir/Madam,\\n\\nI am writing to inquire about...",
  "evaluation_criteria": ["format", "tone", "clarity", "politeness"]
}\n\n`;
      }
      
      promptCompleto += `\n\nFORMATO DE RESPUESTA REQUERIDO:
Debes responder √öNICAMENTE con un objeto JSON con esta estructura exacta:

{
  "questions": [
    {objeto pregunta 1},
    {objeto pregunta 2},
    ...
  ]
}

REGLAS CR√çTICAS:
- NO incluyas texto explicativo antes o despu√©s del JSON
- El array "questions" debe contener TODAS las preguntas solicitadas
- Cada pregunta debe usar EXACTAMENTE el "type" especificado arriba
- ${numFlashcards > 0 && totalPreguntas === numFlashcards ? 'SOLO genera flashcards (type: "flashcard"), NO generes MCQ ni otros tipos' : ''}
- ${numMCQ > 0 && totalPreguntas === numMCQ ? 'SOLO genera MCQ (type: "mcq"), NO generes flashcards ni otros tipos' : ''}
- Var√≠a la dificultad entre easy, medium y hard (para flashcards usa n√∫meros 1, 2, 3)
- Usa tags descriptivos para clasificaci√≥n
- Las explicaciones deben ser claras y educativas
- En MCQ puede haber 1 o m√°s respuestas correctas (usa correct_indices como array)
- Incluye "description" cuando el contexto adicional ayude
- Los casos de estudio deben ser realistas y aplicados

EJEMPLO DE ESTRUCTURA CORRECTA:
{
  "questions": [
    {
      "type": "mcq",
      "difficulty": "easy",
      "tags": ["concepto1"],
      "question": "¬øQu√© es...?",
      "options": ["A", "B", "C", "D"],
      "correct_indices": [0],
      "explanation": "La respuesta A es correcta porque..."
    },
    {
      "type": "true_false",
      "difficulty": "medium",
      "tags": ["concepto2"],
      "statement": "Afirmaci√≥n para evaluar",
      "correct_answer": true,
      "explanation": "Es verdadera porque..."
    }
  ]
}

Ahora genera las ${totalPreguntas} preguntas en formato JSON:`;

      const response = await fetch(`${API_URL}/api/generar_practica`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          ruta: carpetaPractica, 
          prompt: promptCompleto,
          tipo_caso: tipoCasoEstudio, // Tipo de caso de estudio
          tipo_flashcard: tipoFlashcard, // 'respuesta_corta' o 'seleccion_confusa'
          // Tipos generales
          num_flashcards: numFlashcards,
          num_mcq: numMCQ,
          num_verdadero_falso: numVerdaderoFalso,
          num_cloze: numCloze,
          num_respuesta_corta: numRespuestaCorta,
          num_open_question: numOpenQuestion,
          num_caso_estudio: numCasoEstudio,
          // Reading types
          num_reading_comprehension: numReadingComprehension,
          num_reading_true_false: numReadingTrueFalse,
          num_reading_cloze: numReadingCloze,
          num_reading_skill: numReadingSkill,
          num_reading_matching: numReadingMatching,
          num_reading_sequence: numReadingSequence,
          // Writing types
          num_writing_short: numWritingShort,
          num_writing_paraphrase: numWritingParaphrase,
          num_writing_correction: numWritingCorrection,
          num_writing_transformation: numWritingTransformation,
          num_writing_essay: numWritingEssay,
          num_writing_sentence_builder: numWritingSentenceBuilder,
          num_writing_picture_description: numWritingPictureDescription,
          num_writing_email: numWritingEmail
        }),
      });
      
      if (response.ok) {
        const data = await response.json();
        
        console.log('üéØ Pr√°ctica generada - Total preguntas:', data.preguntas?.length);
        data.preguntas?.forEach((p, i) => {
          console.log(`  Pregunta ${i+1}: tipo="${p.tipo}", tiene metadata:`, !!p.metadata);
        });
        
        // üî• LIMPIAR ARCHIVO TEMPORAL DE EX√ÅMENES ANTES DE MOSTRAR PR√ÅCTICA
        await limpiarExamenLocal();
        
        // Guardar pr√°ctica generada
        const practicaId = `practica_${Date.now()}`;
        
        // Extraer carpeta de la ruta y normalizarla (relativa a extracciones)
        let carpetaPracticaGuardar = '';
        if (tipoFuentePractica === 'carpeta') {
          carpetaPracticaGuardar = carpetaPractica;
        } else {
          // Es un documento, extraer la carpeta padre
          const partes = carpetaPractica.split('\\');
          partes.pop(); // Quitar el nombre del archivo
          carpetaPracticaGuardar = partes.join('\\');
        }
        
        // Normalizar carpeta: remover parte absoluta y "extracciones\"
        if (carpetaPracticaGuardar.includes('extracciones\\')) {
          const partes = carpetaPracticaGuardar.split('extracciones\\');
          carpetaPracticaGuardar = partes[partes.length - 1] || '';
        } else if (carpetaPracticaGuardar.includes('extracciones/')) {
          const partes = carpetaPracticaGuardar.split('extracciones/');
          carpetaPracticaGuardar = partes[partes.length - 1] || '';
        }
        
        console.log('üìÅ Carpeta pr√°ctica normalizada:', carpetaPracticaGuardar);
        
        const nuevaPractica = {
          id: practicaId,
          ruta: carpetaPractica,
          carpeta: carpetaPracticaGuardar,
          tipo: tipoFuentePractica,
          prompt: promptPractica,
          preguntas: data.preguntas || [],
          respuestas: {},
          fecha: new Date().toISOString(),
          completada: false,
          stats: {
            flashcards: numFlashcards,
            mcq: numMCQ,
            verdadero_falso: numVerdaderoFalso,
            cloze: numCloze,
            respuesta_corta: numRespuestaCorta,
            open_question: numOpenQuestion,
            caso_estudio: numCasoEstudio,
            // Reading
            reading_comprehension: numReadingComprehension,
            reading_true_false: numReadingTrueFalse,
            reading_cloze: numReadingCloze,
            reading_skill: numReadingSkill,
            reading_matching: numReadingMatching,
            reading_sequence: numReadingSequence,
            // Writing
            writing_short: numWritingShort,
            writing_paraphrase: numWritingParaphrase,
            writing_correction: numWritingCorrection,
            writing_transformation: numWritingTransformation,
            writing_essay: numWritingEssay,
            writing_sentence_builder: numWritingSentenceBuilder,
            writing_picture_description: numWritingPictureDescription,
            writing_email: numWritingEmail
          }
        };
        
        // üî• GUARDAR EN CARPETA CORRESPONDIENTE
        await guardarPracticaEnCarpeta(nuevaPractica);
        const practicas = await getDatos('practicas');
        setPracticas([...practicas, nuevaPractica]); // Actualizar estado para forzar re-render
        
        // üî• ESTABLECER CARPETA DE PR√ÅCTICA (no examen)
        setCarpetaExamen({
          nombre: carpetaPracticaGuardar.split('\\').pop() || 'Pr√°ctica',
          ruta: carpetaPracticaGuardar,
          tipo: 'practica'
        });
        
        // üî• MARCAR COMO PR√ÅCTICA (NO examen)
        setEsPractica(true);
        setExamenActivo(true);
        
        setPreguntasExamen(data.preguntas || []);
        setRespuestasUsuario({});
        setExamenCompletado(false);
        setMensaje({
          tipo: 'success',
          texto: `‚úÖ Pr√°ctica generada: ${totalPreguntas} preguntas`
        });
        setModalExamenAbierto(true);
      } else {
        const errorData = await response.json();
        setMensaje({
          tipo: 'error',
          texto: `‚ùå Error: ${errorData.detail || 'No se pudo generar la pr√°ctica'}`
        });
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al conectar con el servidor'
      });
    } finally {
      setLoading(false);
    }
  };

  // Los contadores del timer se ejecutan localmente en el navegador
  // Los datos se env√≠an al servidor solo cuando se env√≠a la sesi√≥n de estudio
  // (Sincronizaci√≥n en red removida para evitar saturaci√≥n de logs)
  
    // ============================================
    // FUNCIONES DEL SISTEMA DE NOTAS
    // ============================================

  // Cargar notas al iniciar
  useEffect(() => {
    const cargarNotasIniciales = async () => {
      try {
        console.log('üìì Cargando notas iniciales...')
        const notasGuardadas = await getDatos('notas');
        console.log('‚úÖ Notas cargadas:', notasGuardadas?.length || 0)
        if (notasGuardadas && notasGuardadas.length > 0) {
          setNotasGuardadas(notasGuardadas);
        } else {
          setNotasGuardadas([]);
        }
      } catch (error) {
        console.error('‚ùå Error cargando notas:', error)
        setNotasGuardadas([]);
      }
    };
    cargarNotasIniciales();
  }, [])

  // Cargar carpetas cuando cambia la ruta de notas
  useEffect(() => {
    if (selectedMenu === 'notas') {
      cargarCarpetasNotas(rutaNotasActual)
    }
  }, [selectedMenu, rutaNotasActual])

  // Manejar clics en enlaces de notas dentro del editor
  useEffect(() => {
    const handleNotaClick = (e) => {
      const target = e.target;
      if (target.tagName === 'A' && target.hasAttribute('data-nota-id')) {
        e.preventDefault();
        const notaId = parseInt(target.getAttribute('data-nota-id'));
        const nota = (notasGuardadas || []).find(n => n.id === notaId);
        if (nota) {
          abrirNota(nota);
        } else {
          alert('‚ö†Ô∏è La nota referenciada no existe o fue eliminada');
        }
      }
      
      // Cerrar dropdowns al hacer click fuera
      if (!target.closest('.dropdown-nota')) {
        document.querySelectorAll('.dropdown-menu-nota.show').forEach(menu => {
          menu.classList.remove('show');
        });
      }
    };
    
    document.addEventListener('click', handleNotaClick);
    return () => document.removeEventListener('click', handleNotaClick);
  }, [notasGuardadas])

  const cerrarEditorNota = () => {
    if (contenidoNota.trim() || tituloNota.trim()) {
      if (confirm('¬øCerrar sin guardar? Se perder√°n los cambios no guardados.')) {
        setEditorNotaAbierto(false)
        // Limpiar estados
        setTituloNota('')
        setContenidoNota('')
        setNotaActual(null)
        setMenuContextual({ visible: false, x: 0, y: 0 })
      }
    } else {
      setEditorNotaAbierto(false)
      setMenuContextual({ visible: false, x: 0, y: 0 })
    }
  }
  
  const restaurarSeleccion = () => {
    if (rangoSeleccionado) {
      const selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(rangoSeleccionado);
    } else if (editorRef.current) {
      // Si no hay selecci√≥n guardada, crear una al final del editor
      editorRef.current.focus();
      const selection = window.getSelection();
      const range = document.createRange();
      range.selectNodeContents(editorRef.current);
      range.collapse(false); // Colapsar al final
      selection.removeAllRanges();
      selection.addRange(range);
    }
  }
  
  const cerrarMenuContextual = () => {
    setTimeout(() => {
      setMenuContextual({ visible: false, x: 0, y: 0 });
      setRangoSeleccionado(null);
    }, 100);
  }

  // Funciones para arrastrar men√∫ contextual
  const iniciarArrastreMenu = (e) => {
    if (e.button !== 0) return; // Solo bot√≥n izquierdo
    setArrastandoMenu({
      activo: true,
      offsetX: e.clientX - menuContextual.x,
      offsetY: e.clientY - menuContextual.y
    });
  };

  const arrastrarMenu = (e) => {
    if (arrastandoMenu.activo) {
      setMenuContextual({
        ...menuContextual,
        x: e.clientX - arrastandoMenu.offsetX,
        y: e.clientY - arrastandoMenu.offsetY
      });
    }
  };

  const finalizarArrastreMenu = () => {
    setArrastandoMenu({ activo: false, offsetX: 0, offsetY: 0 });
  };

  // Agregar listeners globales para arrastre
  useEffect(() => {
    if (arrastandoMenu.activo) {
      document.addEventListener('mousemove', arrastrarMenu);
      document.addEventListener('mouseup', finalizarArrastreMenu);
      return () => {
        document.removeEventListener('mousemove', arrastrarMenu);
        document.removeEventListener('mouseup', finalizarArrastreMenu);
      };
    }
  }, [arrastandoMenu]);

  // Funciones para tipograf√≠as personalizadas
  const cargarTipografiaPersonalizada = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const nombreFuente = prompt('Nombre para esta tipograf√≠a:', file.name.replace(/\.(ttf|otf|woff|woff2)$/i, ''));
    if (!nombreFuente) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      const fontData = event.target.result;
      const fontId = 'font_' + Date.now();
      
      // Crear @font-face din√°micamente
      const fontFace = `
        @font-face {
          font-family: '${nombreFuente}';
          src: url('${fontData}');
          font-weight: normal;
          font-style: normal;
        }
      `;
      
      // Agregar al head
      const style = document.createElement('style');
      style.textContent = fontFace;
      style.id = fontId;
      document.head.appendChild(style);
      
      // Guardar referencia
      const nuevaTipografia = {
        id: fontId,
        nombre: nombreFuente,
        familia: nombreFuente,
        data: fontData
      };
      
      const nuevasTipografias = [...tipografiasPersonalizadas, nuevaTipografia];
      setTipografiasPersonalizadas(nuevasTipografias);
      
      // Guardar en localStorage
      localStorage.setItem('tipografiasPersonalizadas', JSON.stringify(nuevasTipografias));
      
      alert(`‚úÖ Tipograf√≠a "${nombreFuente}" instalada correctamente`);
    };
    
    reader.readAsDataURL(file);
  };
  
  const aplicarTipografia = (familia) => {
    if (editorRef.current) {
      editorRef.current.focus();
      document.execCommand('fontName', false, familia);
      setTipografiaActual(familia);
    }
  };
  
  const eliminarTipografia = (id) => {
    if (confirm('¬øEliminar esta tipograf√≠a personalizada?')) {
      // Remover del DOM
      const style = document.getElementById(id);
      if (style) style.remove();
      
      // Actualizar estado
      const nuevasTipografias = tipografiasPersonalizadas.filter(t => t.id !== id);
      setTipografiasPersonalizadas(nuevasTipografias);
      localStorage.setItem('tipografiasPersonalizadas', JSON.stringify(nuevasTipografias));
    }
  };

  // Funci√≥n para insertar enlace a nota desde men√∫ contextual
  const insertarEnlaceNota = (notaId) => {
    const notaRef = (notasGuardadas || []).find(n => n.id === notaId);
    if (!notaRef) return;
    
    restaurarSeleccion();
    const link = `<a href="#nota-${notaId}" data-nota-id="${notaId}" style="color: #22c55e; text-decoration: underline; padding: 0; margin: 0; cursor: pointer;" title="Referencia a: ${notaRef.titulo}">üìù ${notaRef.titulo}</a>`;
    document.execCommand('insertHTML', false, link);
    setContenidoNota(editorRef.current.innerHTML);
    setSubmenuActivo(null);
  };

  // Funci√≥n para insertar enlace URL desde men√∫ contextual
  const insertarEnlaceURL = () => {
    const url = prompt('üîó URL:');
    if (url) {
      restaurarSeleccion();
      document.execCommand('createLink', false, url);
      setContenidoNota(editorRef.current.innerHTML);
    }
    setSubmenuActivo(null);
  };

  // Funciones para modal de selecci√≥n de nota de referencia
  const abrirModalSeleccionarNotaRef = () => {
    guardarSeleccion();
    setSubmenuActivo(null);
    setModalSeleccionarNotaRef(true);
    setRutaModalNotaRef('');
    cargarCarpetasModalNotaRef('');
  };

  const cargarCarpetasModalNotaRef = async (ruta = '') => {
    try {
      const response = await fetch(`${API_URL}/api/carpetas?ruta=${encodeURIComponent(ruta)}`);
      const data = await response.json();
      setCarpetasModalNotaRef(data.carpetas || []);
      setRutaModalNotaRef(ruta);
    } catch (error) {
      console.error('Error cargando carpetas:', error);
      setCarpetasModalNotaRef([]);
    }
  };

  const seleccionarNotaReferencia = (notaId) => {
    const notaRef = (notasGuardadas || []).find(n => n.id === notaId);
    if (!notaRef) return;
    
    restaurarSeleccion();
    const link = `<a href="#nota-${notaId}" data-nota-id="${notaId}" style="color: #22c55e; text-decoration: underline; padding: 0; margin: 0; cursor: pointer;" title="Referencia a: ${notaRef.titulo}">üìù ${notaRef.titulo}</a>`;
    document.execCommand('insertHTML', false, link);
    setContenidoNota(editorRef.current.innerHTML);
    setModalSeleccionarNotaRef(false);
  };

  const insertarHipervinculo = () => {
    if (!editorRef.current) return;
    
    editorRef.current.focus();
    
    if (tipoHipervinculo === 'url' && urlHipervinculo) {
      // Insertar enlace externo que se abre en nueva ventana
      const link = `<a href="${urlHipervinculo}" target="_blank" rel="noopener noreferrer" style="color: #646cff; text-decoration: underline; padding: 0; margin: 0;">${textoSeleccionado}</a>`;
      document.execCommand('insertHTML', false, link);
      setContenidoNota(editorRef.current.innerHTML);
    } else if (tipoHipervinculo === 'nota' && notaReferenciaId) {
      // Insertar referencia a nota con atributo especial
      const notaRef = (notasGuardadas || []).find(n => n.id === notaReferenciaId);
      if (notaRef) {
        const link = `<a href="#nota-${notaReferenciaId}" data-nota-id="${notaReferenciaId}" style="color: #22c55e; text-decoration: underline; padding: 0; margin: 0; cursor: pointer;" title="Referencia a: ${notaRef.titulo}">${textoSeleccionado} üìù</a>`;
        document.execCommand('insertHTML', false, link);
        setContenidoNota(editorRef.current.innerHTML);
      }
    }
    setModalHipervinculos(false);
  }

  // Funciones para carpetas de pr√°cticas
  const cargarCarpetasPracticas = async (ruta = '') => {
    try {
      const response = await fetch(`${API_URL}/api/carpetas?ruta=${encodeURIComponent(ruta)}`);
      const data = await response.json();
      if (data.carpetas) {
        setCarpetasPracticas(data.carpetas);
        setRutaPracticasActual(ruta);
      }
    } catch (error) {
      console.error('Error cargando carpetas de pr√°cticas:', error);
    }
  };

  const moverPractica = async (practicaId, nuevaRuta) => {
    const practicas = await getDatos('practicas');
    const index = practicas.findIndex(p => p.id === practicaId);
    if (index !== -1) {
      practicas[index].carpeta = nuevaRuta;
      
      // üî• GUARDAR EN NUEVA CARPETA
      await guardarPracticaEnCarpeta(practicas[index]);
      setPracticas([...practicas]); // Actualizar estado
      setMensaje({
        tipo: 'success',
        texto: '‚úÖ Pr√°ctica movida correctamente'
      });
    }
  };

  const crearNuevaNota = () => {
    console.log('üìù Creando nueva nota en carpeta:', rutaNotasActual);
    setNotaActual(null)
    setTituloNota('')
    setContenidoNota('')
    setCarpetaNota(rutaNotasActual) // Usar carpeta actual de notas
    setModoSoloLectura(false)
    setEditorNotaAbierto(true)
  }

  const convertirDocumentoANota = async (documento) => {
    try {
      console.log('üìù Convirtiendo documento a nota:', documento)
      
      // Cargar el contenido del documento usando el endpoint correcto
      const url = `${API_URL}/api/documentos/contenido?ruta=${encodeURIComponent(documento.ruta)}`
      console.log('üì° Llamando a:', url)
      
      const response = await fetch(url)
      
      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`)
      }
      
      const data = await response.json()
      console.log('üì• Datos recibidos:', data)
      
      if (!data.contenido) {
        throw new Error('No se pudo obtener el contenido del documento')
      }
      
      // Convertir el contenido a formato HTML para las notas
      // Preservar formato: p√°rrafos, saltos de l√≠nea, etc.
      let contenidoHTML = data.contenido
        .split('\n')
        .map(linea => {
          if (linea.trim() === '') {
            return '<br>' // L√≠nea vac√≠a
          }
          // Detectar t√≠tulos (l√≠neas que parecen encabezados)
          if (linea.match(/^#+\s/) || linea.match(/^[A-Z√Å√â√ç√ì√ö√ë\s]+:$/)) {
            return `<h3>${linea.replace(/^#+\s/, '')}</h3>`
          }
          // Detectar listas
          if (linea.match(/^[\-\*\‚Ä¢]\s/)) {
            return `<li>${linea.replace(/^[\-\*\‚Ä¢]\s/, '')}</li>`
          }
          if (linea.match(/^\d+\.\s/)) {
            return `<li>${linea.replace(/^\d+\.\s/, '')}</li>`
          }
          return `<p>${linea}</p>`
        })
        .join('')
      
      // Envolver listas en ul/ol
      contenidoHTML = contenidoHTML.replace(/(<li>.*?<\/li>)+/g, (match) => {
        return `<ul>${match}</ul>`
      })
      
      // Crear nueva nota con el contenido del documento
      const nombreNota = documento.nombre.replace(/\.(txt|pdf)$/i, '') // Quitar extensi√≥n
      const notaNueva = {
        id: Date.now(),
        titulo: nombreNota,
        contenido: contenidoHTML,
        carpeta: rutaNotasActual || '', // Usar carpeta actual de notas
        fecha: new Date().toISOString(),
        fechaModificacion: new Date().toISOString()
      }

      console.log('üíæ Guardando nota:', notaNueva)

      await guardarNotaEnCarpeta(notaNueva);
      const notasActualizadas = [...notasGuardadas, notaNueva]
      setNotasGuardadas(notasActualizadas)
      
      setMensaje({
        tipo: 'success',
        texto: `‚úÖ "${nombreNota}" convertido a nota exitosamente`
      })
      
      setMenuAbierto(null)
      
      // Opcional: abrir la nota reci√©n creada
      setTimeout(() => {
        abrirNota(notaNueva)
      }, 500)
      
    } catch (error) {
      console.error('‚ùå Error al convertir documento a nota:', error)
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error al convertir: ${error.message}`
      })
    }
  }

  const abrirNota = (nota) => {
    setNotaActual(nota)
    setTituloNota(nota.titulo)
    setContenidoNota(nota.contenido)
    setCarpetaNota(nota.carpeta || '')
    setModoSoloLectura(true) // Modo solo lectura
    setEditorNotaAbierto(true)
  }

  const editarNota = (nota) => {
    setNotaActual(nota)
    setTituloNota(nota.titulo)
    setContenidoNota(nota.contenido)
    setCarpetaNota(nota.carpeta || '')
    setModoSoloLectura(false) // Modo edici√≥n
    setEditorNotaAbierto(true)
  }

  const guardarNota = async () => {
    if (!tituloNota.trim()) {
      alert('‚ö†Ô∏è Debes escribir un t√≠tulo para la nota')
      return
    }

    console.log('üíæ Guardando nota en carpeta:', carpetaNota);

    const notaNueva = {
      id: notaActual?.id || Date.now(),
      titulo: tituloNota,
      contenido: contenidoNota,
      carpeta: carpetaNota,
      fecha: notaActual?.fecha || new Date().toISOString(),
      fechaModificacion: new Date().toISOString(),
      // Repetici√≥n espaciada (mantener valores existentes si es edici√≥n)
      proximaRevision: notaActual?.proximaRevision || new Date().toISOString(),
      intervalo: notaActual?.intervalo || 1,
      repeticiones: notaActual?.repeticiones || 0,
      facilidad: notaActual?.facilidad || 2.5,
      estadoRevision: notaActual?.estadoRevision || 'nueva'
    }

    let notasActualizadas
    if (notaActual) {
      // Editar nota existente
      notasActualizadas = (notasGuardadas || []).map(n => n.id === notaActual.id ? notaNueva : n)
    } else {
      // Crear nota nueva
      notasActualizadas = [...(notasGuardadas || []), notaNueva]
    }

    await guardarNotaEnCarpeta(notaNueva);
    setNotasGuardadas(notasActualizadas)
    
    setMensaje({
      tipo: 'success',
      texto: notaActual ? '‚úÖ Nota actualizada' : '‚úÖ Nota creada'
    })
    
    setEditorNotaAbierto(false)
  }

  const eliminarNota = async (idNota) => {
    if (!confirm('¬øEst√°s seguro de eliminar esta nota?')) return
    
    const nota = (notasGuardadas || []).find(n => n.id === idNota);
    const carpeta = nota?.carpeta || '';
    
    try {
      const response = await fetch(`${API_URL}/datos/notas/${idNota}?carpeta=${encodeURIComponent(carpeta)}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) throw new Error('Error al eliminar');
      
      const notasActualizadas = (notasGuardadas || []).filter(n => n.id !== idNota)
      setNotasGuardadas(notasActualizadas)
      
      setMensaje({
        tipo: 'success',
        texto: 'üóëÔ∏è Nota eliminada'
      })
    } catch (error) {
      console.error('Error eliminando nota:', error);
      setMensaje({ tipo: 'error', texto: '‚ùå Error al eliminar nota' });
    }
  }
  
  // Evaluar comprensi√≥n de nota con repetici√≥n espaciada
  const evaluarNota = async (idNota, dificultad) => {
    const nota = notasGuardadas.find(n => n.id === idNota);
    if (!nota) return;
    
    const resultado = calcularProximaRevision(nota, dificultad);
    const notaActualizada = { ...nota, ...resultado };
    
    await guardarNotaEnCarpeta(notaActualizada);
    
    const notasActualizadas = notasGuardadas.map(n => n.id === idNota ? notaActualizada : n);
    setNotasGuardadas(notasActualizadas);
    setNotasGuardadas(notasActualizadas);
    
    console.log('üìù Nota evaluada:', {
      dificultad,
      nota: notasActualizadas.find(n => n.id === idNota)
    });
    
    setMensaje({
      tipo: 'success',
      texto: `‚úÖ Revisi√≥n registrada: ${dificultad === 'facil' ? 'Dominado' : dificultad === 'medio' ? 'En progreso' : 'Necesita repaso'}`
    });
  };
  
  // Evaluar pr√°ctica con repetici√≥n espaciada
  const evaluarPractica = async (idPractica, dificultad) => {
    const practicasActuales = await getDatos('practicas');
    const practicaActualizada = practicasActuales.find(p => p.id === idPractica);
    
    if (practicaActualizada) {
      const practicaConNuevosDatos = calcularProximaRevision(practicaActualizada, dificultad);
      
      // üî• GUARDAR EN CARPETA CORRESPONDIENTE
      await guardarPracticaEnCarpeta(practicaConNuevosDatos);
      
      // Actualizar estado local
      const practicasActualizadas = practicasActuales.map(p => 
        p.id === idPractica ? practicaConNuevosDatos : p
      );
      setPracticas(practicasActualizadas);
      
      console.log('üéØ Pr√°ctica evaluada:', {
        dificultad,
        practica: practicaConNuevosDatos
      });
      
      setMensaje({
        tipo: 'success',
        texto: `‚úÖ Pr√°ctica evaluada: ${dificultad === 'facil' ? 'Excelente' : dificultad === 'medio' ? 'Bien' : 'Necesita m√°s pr√°ctica'}`
      });
    }
  };

  const exportarNotaTXT = (nota) => {
    // Extraer texto plano del HTML
    const tempDiv = document.createElement('div')
    tempDiv.innerHTML = nota.contenido
    const textoPlano = tempDiv.textContent || tempDiv.innerText
    
    const contenidoTxt = `${nota.titulo}\n${'='.repeat(nota.titulo.length)}\n\n${textoPlano}`
    const blob = new Blob([contenidoTxt], { type: 'text/plain' })
    const url = URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = `${nota.titulo.replace(/[^a-z0-9]/gi, '_')}.txt`
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    URL.revokeObjectURL(url)
    
    setMensaje({
      tipo: 'success',
      texto: 'üìÑ Nota exportada como TXT'
    })
  }

  const leerNotaVozAlta = (texto) => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel()
      const utterance = new SpeechSynthesisUtterance(texto)
      utterance.lang = 'es-ES'
      utterance.rate = 0.9
      window.speechSynthesis.speak(utterance)
      
      setMensaje({
        tipo: 'info',
        texto: 'üîä Reproduciendo nota...'
      })
    } else {
      alert('‚ùå Tu navegador no soporta s√≠ntesis de voz')
    }
  }

  const cargarCarpetasNotas = async (ruta = '') => {
    try {
      console.log('üîç Cargando carpetas de notas, ruta:', ruta)
      const response = await fetch(`${API_URL}/api/carpetas?ruta=${encodeURIComponent(ruta)}`)
      
      if (!response.ok) {
        console.error('‚ùå Error en respuesta:', response.status, response.statusText)
        setCarpetasNotas([])
        return
      }
      
      const data = await response.json()
      console.log('‚úÖ Carpetas cargadas:', data.carpetas?.length || 0)
      setCarpetasNotas(data.carpetas || [])
      setRutaNotasActual(ruta)
    } catch (error) {
      console.error('‚ùå Error cargando carpetas:', error)
      setCarpetasNotas([])
    }
  }

  // ============================================
  // FUNCIONES DEL SISTEMA DE FLASHCARDS
  // ============================================

  // Funci√≥n auxiliar para cargar todas las flashcards desde el nuevo sistema
  const cargarTodasFlashcards = async () => {
    try {
      // üî• Agregar timestamp para evitar cach√© del navegador
      const timestamp = Date.now();
      const response = await fetch(`${API_URL}/datos/flashcards?_t=${timestamp}`);
      let flashcards = await response.json();
      
      // üî• NORMALIZAR contadores de revisiones diarias
      const hoyInicio = new Date();
      hoyInicio.setHours(0, 0, 0, 0);
      
      flashcards = flashcards.map(fc => {
        // Si no tiene revisionesHoy, inicializar
        if (fc.revisionesHoy === undefined || fc.revisionesHoy === null) {
          const ultimaRevision = fc.ultima_revision || fc.ultimaRevision || fc.fechaRevision;
          if (ultimaRevision) {
            const fechaUltima = new Date(ultimaRevision);
            // Si √∫ltima revisi√≥n fue hoy, inicializar a 1; si no, a 0
            fc.revisionesHoy = (fechaUltima >= hoyInicio) ? 1 : 0;
          } else {
            fc.revisionesHoy = 0;
          }
        } else {
          // Si tiene contador pero la √∫ltima revisi√≥n no fue hoy, resetear a 0
          const ultimaRevision = fc.ultima_revision || fc.ultimaRevision || fc.fechaRevision;
          if (ultimaRevision) {
            const fechaUltima = new Date(ultimaRevision);
            if (fechaUltima < hoyInicio && fc.revisionesHoy > 0) {
              console.log(`üîÑ Reseteando contador obsoleto para: ${fc.titulo || fc.id} (${fc.revisionesHoy} ‚Üí 0)`);
              fc.revisionesHoy = 0;
            }
          }
        }
        return fc;
      });
      
      console.log(`üìö cargarTodasFlashcards: ${flashcards.length} flashcards cargadas (timestamp: ${timestamp})`);
      return flashcards;
    } catch (error) {
      console.error('Error cargando flashcards:', error);
      return [];
    }
  };

  // Cargar flashcards del archivo
  useEffect(() => {
    const cargarFlashcardsIniciales = async () => {
      try {
        // üî• USAR NUEVO ENDPOINT QUE AGREGA DE TODAS LAS CARPETAS
        const flashcardsGuardadas = await cargarTodasFlashcards();
        
        console.log('üìö Flashcards cargadas:', flashcardsGuardadas.length);
        if (flashcardsGuardadas && flashcardsGuardadas.length > 0) {
          setFlashcardsActuales(flashcardsGuardadas);
        } else {
          setFlashcardsActuales([]);
        }
      } catch (error) {
        console.error('Error cargando flashcards:', error);
        setFlashcardsActuales([]);
      }
    };
    cargarFlashcardsIniciales();
  }, [])

  // Cargar carpetas cuando entras a la secci√≥n de flashcards
  useEffect(() => {
    if (selectedMenu === 'flashcards') {
      // üî• Recargar flashcards cada vez que entras a la secci√≥n
      cargarTodasFlashcards().then(flashcards => {
        console.log('üìö Flashcards recargadas al entrar a secci√≥n:', flashcards.length);
        setFlashcardsActuales(flashcards);
      });
      cargarCarpetasFlashcards('');
    }
  }, [selectedMenu])

  const cargarCarpetasFlashcards = async (ruta = '') => {
    try {
      const response = await fetch(`${API_URL}/api/carpetas?ruta=${encodeURIComponent(ruta)}`)
      const data = await response.json()
      
      // üî• Cargar flashcards y actualizar estado global
      const flashcards = await cargarTodasFlashcards();
      console.log('üìö Flashcards cargadas para conteo:', flashcards.length);
      setFlashcardsActuales(flashcards); // üî• ACTUALIZAR ESTADO
      
      // Contar flashcards por carpeta desde el backend
      const carpetasConConteo = (data.carpetas || []).map(carpeta => {
        // Normalizar ruta de Windows (\\) a Unix (/)
        const rutaNormalizada = carpeta.ruta.replace(/\\/g, '/');
        const totalFlashcards = flashcards.filter(f => {
          const carpetaFlashcard = (f.carpeta || '').replace(/\\/g, '/');
          return carpetaFlashcard === rutaNormalizada;
        }).length;
        
        return { 
          ...carpeta,
          ruta: rutaNormalizada, // Guardar ruta normalizada
          totalFlashcards,
          subcarpetas: carpeta.num_subcarpetas || 0 // del backend
        }
      })
      
      console.log('üìÇ Carpetas cargadas:', carpetasConConteo.map(c => `${c.nombre} (üÉè ${c.totalFlashcards}, üìÅ ${c.subcarpetas})`))
      setFlashcardsCarpetas(carpetasConConteo)
      setRutaFlashcardsActual(ruta)
    } catch (error) {
      console.error('Error cargando carpetas de flashcards:', error)
      setFlashcardsCarpetas([])
    }
  }

  const abrirCarpetaFlashcards = (carpeta) => {
    // Navegar a subcarpetas de esta carpeta
    const rutaNormalizada = carpeta.ruta.replace(/\\/g, '/');
    console.log('üìÇ Navegando a carpeta:', rutaNormalizada)
    cargarCarpetasFlashcards(rutaNormalizada)
    setCarpetaFlashcardActual(null) // Resetear para mostrar subcarpetas
    setFiltroTipoFlashcard('todas')
  }
  
  const verFlashcardsDeCarpeta = async (carpeta) => {
    // Mostrar SOLO flashcards de esta carpeta espec√≠fica (sin navegar)
    console.log('üÉè Mostrando flashcards de:', carpeta.ruta);
    
    // üî• IMPORTANTE: Recargar flashcards antes de mostrar la carpeta
    try {
      const flashcardsReacargadas = await cargarTodasFlashcards();
      console.log('üìö Flashcards recargadas:', flashcardsReacargadas.length);
      setFlashcardsActuales(flashcardsReacargadas);
      
      // Filtrar flashcards de esta carpeta espec√≠fica
      const flashcardsCarpeta = flashcardsReacargadas.filter(f => {
        const carpetaFlashcard = (f.carpeta || '').replace(/\\/g, '/');
        return carpetaFlashcard === carpeta.ruta;
      });
      
      console.log('üÉè Flashcards en carpeta', carpeta.ruta, ':', flashcardsCarpeta.length);
      
      // Establecer carpeta actual para mostrar las flashcards
      setCarpetaFlashcardActual(carpeta);
      setFiltroTipoFlashcard('todas');
    } catch (error) {
      console.error('‚ùå Error cargando flashcards de carpeta:', error);
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al cargar flashcards de la carpeta'
      });
    }
  };

  const volverListaFlashcards = () => {
    setCarpetaFlashcardActual(null)
    // Mantener la ruta actual para mostrar subcarpetas
  }
  
  const navegarRutaFlashcards = (ruta) => {
    cargarCarpetasFlashcards(ruta)
    setCarpetaFlashcardActual(null)
  }
  
  const volverAtrasFlashcards = () => {
    if (rutaFlashcardsActual) {
      const partesRuta = rutaFlashcardsActual.split('/')
      partesRuta.pop()
      const rutaPadre = partesRuta.join('/')
      cargarCarpetasFlashcards(rutaPadre)
      setCarpetaFlashcardActual(null)
    }
  }

  // ============================================
  // FUNCIONES BUSCADOR IA
  // ============================================

  // Funci√≥n para resaltar t√©rminos de b√∫squeda en el texto
  const resaltarTexto = (texto, query) => {
    if (!query || !texto) return texto;
    
    // Dividir query en palabras
    const palabras = query.toLowerCase().split(/\s+/).filter(p => p.length > 2);
    
    if (palabras.length === 0) return texto;
    
    // Crear regex para buscar todas las palabras
    const regex = new RegExp(`(${palabras.join('|')})`, 'gi');
    
    // Dividir texto en partes y resaltar
    const partes = texto.split(regex);
    
    return partes.map((parte, idx) => {
      // Si la parte coincide con alguna palabra de b√∫squeda
      if (palabras.some(p => parte.toLowerCase().includes(p.toLowerCase()))) {
        return <mark key={idx} className="highlight-search">{parte}</mark>;
      }
      return parte;
    });
  };

  // Funci√≥n auxiliar para normalizar texto (quitar acentos y caracteres especiales)
  const normalizarTexto = (texto) => {
    if (!texto) return '';
    try {
      return String(texto)
        .toLowerCase()
        .normalize('NFD') // Descomponer caracteres acentuados
        .replace(/[\u0300-\u036f]/g, '') // Eliminar marcas de acento
        .replace(/[¬ø?¬°!]/g, ''); // Eliminar signos de interrogaci√≥n y exclamaci√≥n
    } catch (e) {
      console.warn('Error normalizando texto:', e);
      return String(texto).toLowerCase();
    }
  };

  const buscarConIA = async () => {
    if (!queryBusqueda.trim()) {
      setMensaje({ tipo: 'error', texto: 'Escribe algo para buscar' });
      return;
    }

    setBuscando(true);
    setResultadosBusqueda([]);

    try {
      const startTime = Date.now();
      const resultados = [];
      const query = queryBusqueda.toLowerCase();
      const queryNormalizada = normalizarTexto(queryBusqueda); // üî• Normalizar para b√∫squeda flexible
      
      console.log('üîç B√∫squeda original:', query);
      console.log('üîç B√∫squeda normalizada:', queryNormalizada);

      // Buscar en notas
      if (filtroBusquedaTipo === 'todos' || filtroBusquedaTipo === 'nota') {
        const notas = await getDatos('notas');
        console.log('üîç Buscando en notas:', notas.length, 'notas cargadas');
        console.log('üîç Query:', query, '| Filtro:', filtroBusquedaTipo);
        notas.forEach(nota => {
          const tituloNormalizado = normalizarTexto(nota.titulo);
          const contenidoNormalizado = normalizarTexto(nota.contenido);
          
          const tituloMatch = tituloNormalizado.includes(queryNormalizada);
          const contenidoMatch = contenidoNormalizado.includes(queryNormalizada);
          
          if (tituloMatch || contenidoMatch) {
            console.log('‚úÖ Nota encontrada:', nota.titulo);
            resultados.push({
              tipo: 'nota',
              titulo: nota.titulo,
              contenido: nota.contenido?.substring(0, 200) + '...',
              ruta: nota.carpeta || 'Ra√≠z',
              id: nota.id,
              relevancia: tituloMatch ? 10 : 5
            });
          }
        });
      }

      // Buscar en flashcards
      if (filtroBusquedaTipo === 'todos' || filtroBusquedaTipo === 'flashcard') {
        const flashcards = await cargarTodasFlashcards();
        console.log('üîç Buscando en flashcards:', flashcards.length, 'flashcards cargadas');
        flashcards.forEach(fc => {
          // Soporte para dos formatos: pregunta/respuesta Y titulo/contenido
          const pregunta = fc.pregunta || fc.titulo || '';
          const respuesta = fc.respuesta || fc.contenido || '';
          
          // üî• Normalizar para b√∫squeda flexible
          const preguntaMatch = normalizarTexto(pregunta).includes(queryNormalizada);
          const respuestaMatch = normalizarTexto(respuesta).includes(queryNormalizada);
          
          // Buscar en campos adicionales
          const temaMatch = normalizarTexto(fc.tema).includes(queryNormalizada);
          const subtemaMatch = normalizarTexto(fc.subtema).includes(queryNormalizada);
          const explicacionMatch = normalizarTexto(fc.explicacion).includes(queryNormalizada);
          const dificultadMatch = normalizarTexto(fc.dificultad).includes(queryNormalizada);
          const tipoMatch = normalizarTexto(fc.tipo).includes(queryNormalizada);
          const respuestaCorrectaMatch = normalizarTexto(fc.respuestaCorrecta).includes(queryNormalizada);
          
          if (preguntaMatch || respuestaMatch || temaMatch || subtemaMatch || explicacionMatch || dificultadMatch || tipoMatch || respuestaCorrectaMatch) {
            console.log('‚úÖ Flashcard encontrada:', pregunta || 'Sin t√≠tulo');
            resultados.push({
              tipo: 'flashcard',
              titulo: pregunta || 'Sin t√≠tulo',
              contenido: respuesta?.substring(0, 200) || 'Sin contenido',
              ruta: fc.carpeta || 'Ra√≠z',
              id: fc.id,
              relevancia: preguntaMatch ? 10 : (respuestaMatch ? 8 : 5)
            });
          }
        });
      }

      // üî• Buscar en ex√°menes
      if (filtroBusquedaTipo === 'todos' || filtroBusquedaTipo === 'examen') {
        const examenes = await getDatos('examenes');
        console.log('üîç Buscando en ex√°menes:', examenes.length, 'ex√°menes cargados');
        console.log('üîç Query normalizada para b√∫squeda:', queryNormalizada);
        
        // üî• LOG DETALLADO: Mostrar todas las preguntas de todos los ex√°menes
        examenes.forEach((examen, idx) => {
          const numPreguntas = examen.preguntas?.length || 0;
          const numResultados = examen.resultado?.resultados?.length || 0;
          const numResultadosDirectos = examen.resultados?.length || 0;
          console.log(`üìö Examen[${idx}]: "${examen.titulo}" - ${numPreguntas} preguntas, ${numResultados} resultado.resultados, ${numResultadosDirectos} resultados`);
          
          // Mostrar primeras 3 preguntas de cada examen
          if (examen.preguntas && examen.preguntas.length > 0) {
            examen.preguntas.slice(0, 3).forEach((p, pIdx) => {
              const preguntaTexto = p.pregunta || p.texto || '';
              console.log(`  [preguntas[${pIdx}]]: "${preguntaTexto.substring(0, 80)}..."`);
            });
          }
          
          // Mostrar primeras 3 preguntas de resultados directos
          if (examen.resultados && examen.resultados.length > 0) {
            examen.resultados.slice(0, 3).forEach((r, rIdx) => {
              const preguntaTexto = r.pregunta || '';
              console.log(`  [resultados[${rIdx}]]: "${preguntaTexto.substring(0, 80)}..."`);
            });
          }
        });
        
        examenes.forEach((examen, idx) => {
          const tituloMatch = normalizarTexto(examen.titulo).includes(queryNormalizada);
          const carpetaMatch = normalizarTexto(examen.carpeta).includes(queryNormalizada);
          
          // Buscar en preguntas del examen
          let preguntaMatch = false;
          let preguntaEncontrada = '';
          
          // Buscar en array de preguntas
          if (examen.preguntas) {
            examen.preguntas.forEach((p, pIdx) => {
              const preguntaTexto = p.pregunta || p.texto || '';
              const respuestaCorrecta = p.respuesta_correcta || p.correcta || '';
              
              const preguntaNormalizada = normalizarTexto(preguntaTexto);
              const respuestaNormalizada = normalizarTexto(respuestaCorrecta);
              
              if (preguntaNormalizada.includes(queryNormalizada) || 
                  respuestaNormalizada.includes(queryNormalizada)) {
                preguntaMatch = true;
                if (!preguntaEncontrada) {
                  preguntaEncontrada = preguntaTexto;
                  console.log(`‚úÖ MATCH en examen[${idx}].preguntas[${pIdx}]:`, preguntaTexto.substring(0, 100));
                }
              }
            });
          }
          
          // üî• IMPORTANTE: Tambi√©n buscar en resultado.resultados (donde est√°n los detalles)
          if (examen.resultado?.resultados) {
            examen.resultado.resultados.forEach((r, rIdx) => {
              const preguntaTexto = r.pregunta || '';
              const respuestaUsuario = r.respuesta_usuario || '';
              const respuestaCorrecta = r.respuesta_correcta || '';
              const feedback = r.feedback || '';
              
              if (normalizarTexto(preguntaTexto).includes(queryNormalizada) || 
                  normalizarTexto(respuestaUsuario).includes(queryNormalizada) ||
                  normalizarTexto(respuestaCorrecta).includes(queryNormalizada) ||
                  normalizarTexto(feedback).includes(queryNormalizada)) {
                preguntaMatch = true;
                if (!preguntaEncontrada) {
                  preguntaEncontrada = preguntaTexto;
                  console.log(`‚úÖ MATCH en examen[${idx}].resultado.resultados[${rIdx}]:`, preguntaTexto.substring(0, 100));
                }
              }
            });
          }
          
          // üî• NUEVO: Tambi√©n buscar directamente en examen.resultados (estructura alternativa)
          if (examen.resultados && Array.isArray(examen.resultados)) {
            examen.resultados.forEach((r, rIdx) => {
              const preguntaTexto = r.pregunta || '';
              const respuestaUsuario = r.respuesta_usuario || '';
              const respuestaCorrecta = r.respuesta_correcta || '';
              const feedback = r.feedback || '';
              
              if (normalizarTexto(preguntaTexto).includes(queryNormalizada) || 
                  normalizarTexto(respuestaUsuario).includes(queryNormalizada) ||
                  normalizarTexto(respuestaCorrecta).includes(queryNormalizada) ||
                  normalizarTexto(feedback).includes(queryNormalizada)) {
                preguntaMatch = true;
                if (!preguntaEncontrada) {
                  preguntaEncontrada = preguntaTexto;
                  console.log(`‚úÖ MATCH en examen[${idx}].resultados[${rIdx}]:`, preguntaTexto.substring(0, 100));
                }
              }
            });
          }
          
          if (tituloMatch || carpetaMatch || preguntaMatch) {
            console.log('‚úÖ Examen encontrado:', examen.titulo || 'Sin t√≠tulo');
            const porcentaje = examen.resultado?.porcentaje || 0;
            resultados.push({
              tipo: 'examen',
              titulo: examen.titulo || 'Examen sin t√≠tulo',
              contenido: `${porcentaje.toFixed(0)}% - ${examen.preguntas?.length || 0} preguntas${preguntaEncontrada ? ' - ' + preguntaEncontrada.substring(0, 100) : ''}`,
              ruta: examen.carpeta || 'Ra√≠z',
              id: examen.id,
              relevancia: tituloMatch ? 10 : (preguntaMatch ? 8 : 5)
            });
          }
        });
      }

      // üî• Buscar en pr√°cticas
      if (filtroBusquedaTipo === 'todos' || filtroBusquedaTipo === 'practica') {
        const practicas = await getDatos('practicas');
        console.log('üîç Buscando en pr√°cticas:', practicas.length, 'pr√°cticas cargadas');
        practicas.forEach(practica => {
          const tituloMatch = normalizarTexto(practica.titulo).includes(queryNormalizada);
          const nombreMatch = normalizarTexto(practica.nombre).includes(queryNormalizada);
          const carpetaMatch = normalizarTexto(practica.carpeta).includes(queryNormalizada);
          
          // Buscar en preguntas de la pr√°ctica
          let preguntaMatch = false;
          let preguntaEncontrada = '';
          
          // Buscar en array de preguntas
          if (practica.preguntas) {
            practica.preguntas.forEach(p => {
              const preguntaTexto = p.pregunta || p.texto || '';
              const respuestaCorrecta = p.respuesta_correcta || p.correcta || '';
              if (normalizarTexto(preguntaTexto).includes(queryNormalizada) || 
                  normalizarTexto(respuestaCorrecta).includes(queryNormalizada)) {
                preguntaMatch = true;
                if (!preguntaEncontrada) preguntaEncontrada = preguntaTexto;
              }
            });
          }
          
          // üî• IMPORTANTE: Tambi√©n buscar en resultado.resultados (donde est√°n los detalles)
          if (practica.resultado?.resultados) {
            practica.resultado.resultados.forEach(r => {
              const preguntaTexto = r.pregunta || '';
              const respuestaUsuario = r.respuesta_usuario || '';
              const respuestaCorrecta = r.respuesta_correcta || '';
              const feedback = r.feedback || '';
              
              if (normalizarTexto(preguntaTexto).includes(queryNormalizada) || 
                  normalizarTexto(respuestaUsuario).includes(queryNormalizada) ||
                  normalizarTexto(respuestaCorrecta).includes(queryNormalizada) ||
                  normalizarTexto(feedback).includes(queryNormalizada)) {
                preguntaMatch = true;
                if (!preguntaEncontrada) preguntaEncontrada = preguntaTexto;
              }
            });
          }
          
          if (tituloMatch || nombreMatch || carpetaMatch || preguntaMatch) {
            console.log('‚úÖ Pr√°ctica encontrada:', practica.titulo || practica.nombre || 'Sin t√≠tulo');
            const porcentaje = practica.resultado?.porcentaje || 0;
            resultados.push({
              tipo: 'practica',
              titulo: practica.titulo || practica.nombre || 'Pr√°ctica sin t√≠tulo',
              contenido: `${porcentaje.toFixed(0)}% - ${practica.preguntas?.length || 0} preguntas${preguntaEncontrada ? ' - ' + preguntaEncontrada.substring(0, 100) : ''}`,
              ruta: practica.carpeta || 'Ra√≠z',
              id: practica.id,
              relevancia: tituloMatch || nombreMatch ? 10 : (preguntaMatch ? 8 : 5)
            });
          }
        });
      }

      // Buscar en documentos usando el API existente
      try {
        const response = await fetch(`${API_URL}/api/buscar?q=${encodeURIComponent(queryBusqueda)}`);
        if (response.ok) {
          const data = await response.json();
          if (data.resultados) {
            data.resultados.forEach(doc => {
              resultados.push({
                tipo: 'documento',
                titulo: doc.nombre,
                contenido: doc.preview || '',
                ruta: doc.ruta,
                relevancia: doc.score || 5
              });
            });
          }
        }
      } catch (err) {
        console.log('B√∫squeda en documentos no disponible:', err);
      }

      // Ordenar por relevancia
      resultados.sort((a, b) => b.relevancia - a.relevancia);

      const tiempo = ((Date.now() - startTime) / 1000).toFixed(2);
      setResultadosBusqueda(resultados);
      setMensaje({ 
        tipo: 'exito', 
        texto: `‚úÖ ${resultados.length} resultados encontrados en ${tiempo}s` 
      });

    } catch (error) {
      console.error('Error buscando:', error);
      setMensaje({ 
        tipo: 'error', 
        texto: '‚ùå Error al buscar. Verifica que el backend est√© corriendo' 
      });
    } finally {
      setBuscando(false);
    }
  };

  const actualizarIndice = async (completo = false) => {
    if (actualizandoIndice) return;

    setActualizandoIndice(true);
    setMensaje({ 
      tipo: 'info', 
      texto: completo ? 'üîÑ Reindexando todo...' : 'üîÑ Actualizando √≠ndice...' 
    });

    try {
      const response = await fetch('http://localhost:5001/api/actualizar_indice', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ completo })
      });

      if (!response.ok) {
        throw new Error('Error actualizando √≠ndice');
      }

      const data = await response.json();
      setMensaje({ 
        tipo: 'exito', 
        texto: `‚úÖ √çndice actualizado: ${data.archivos_procesados} archivos, ${data.chunks_indexados} chunks. Total: ${data.total_chunks}` 
      });

      cargarEstadoIndice();

    } catch (error) {
      console.error('Error actualizando √≠ndice:', error);
      setMensaje({ 
        tipo: 'error', 
        texto: '‚ùå Error al actualizar √≠ndice. Servidor no disponible.' 
      });
    } finally {
      setActualizandoIndice(false);
    }
  };

  const cargarEstadoIndice = async () => {
    try {
      const response = await fetch('http://localhost:5001/api/estado');
      
      if (response.ok) {
        const data = await response.json();
        setEstadoIndice(data);
      }
    } catch (error) {
      console.error('Error cargando estado:', error);
    }
  };

  const abrirResultadoBusqueda = async (resultado) => {
    console.log('üîç Abriendo resultado:', resultado);
    console.log('üîç Tipo de resultado:', resultado.tipo);
    
    switch(resultado.tipo) {
      case 'nota':
        console.log('üìù Procesando nota...');
        // Buscar la nota por ID
        const nota = (notasGuardadas || []).find(n => n.id === resultado.id);
        console.log('üìù Nota encontrada en estado:', nota);
        if (nota) {
          // Cambiar a secci√≥n Notas y abrir
          console.log('üìù Cambiando a secci√≥n notas...');
          setSelectedMenu('notas');
          setTimeout(() => {
            console.log('üìù Abriendo nota...');
            abrirNota(nota);
          }, 100);
        } else {
          console.error('‚ùå Nota no encontrada en notasGuardadas');
          setMensaje({ tipo: 'error', texto: '‚ùå Nota no encontrada' });
        }
        break;
        
      case 'flashcard':
        console.log('üÉè Procesando flashcard...');
        // Buscar la flashcard por ID  
        const allFlashcards = await cargarTodasFlashcards();
        console.log('üÉè Flashcards cargadas:', allFlashcards.length);
        const flashcard = allFlashcards.find(f => f.id === resultado.id);
        console.log('üÉè Flashcard encontrada:', flashcard);
        if (flashcard) {
          // Cambiar a secci√≥n Flashcards y abrir
          console.log('üÉè Cambiando a secci√≥n flashcards...');
          setSelectedMenu('flashcards');
          setTimeout(() => {
            console.log('üÉè Abriendo flashcard...');
            setFlashcardSeleccionada(flashcard);
            setMostrandoRespuesta(false);
          }, 100);
        } else {
          console.error('‚ùå Flashcard no encontrada');
          setMensaje({ tipo: 'error', texto: '‚ùå Flashcard no encontrada' });
        }
        break;
        
      case 'documento':
        console.log('üìÑ Procesando documento...');
        // Cambiar a Mis Cursos y abrir
        setSelectedMenu('cursos');
        setTimeout(() => {
          console.log('üìÑ Abriendo documento...');
          abrirArchivoBusqueda(resultado.ruta);
        }, 100);
        break;
        
      case 'examen':
        console.log('üìã Procesando examen...');
        // Buscar el examen por ID
        const examenes = await getDatos('examenes');
        const examen = examenes.find(e => e.id === resultado.id);
        console.log('üìã Examen encontrado:', examen);
        if (examen) {
          // Cargar el examen completo para mostrar
          setPreguntasExamen(examen.preguntas || []);
          setRespuestasUsuario(examen.respuestas || {});
          setExamenCompletado(true);
          setResultadoExamen(examen.resultado || null);
          setExamenActivo(examen);
          setModalExamenAbierto(true);
          
          setMensaje({ 
            tipo: 'exito', 
            texto: `üìã Mostrando examen: ${examen.titulo || 'Sin t√≠tulo'}` 
          });
        } else {
          console.error('‚ùå Examen no encontrado');
          setMensaje({ tipo: 'error', texto: '‚ùå Examen no encontrado' });
        }
        break;
        
      case 'practica':
        console.log('üéØ Procesando pr√°ctica...');
        // Buscar la pr√°ctica por ID
        const practicas = await getDatos('practicas');
        const practica = practicas.find(p => p.id === resultado.id);
        console.log('üéØ Pr√°ctica encontrada:', practica);
        if (practica) {
          // Cargar la pr√°ctica completa para mostrar
          setPreguntasExamen(practica.preguntas || []);
          setRespuestasUsuario(practica.respuestas || {});
          setExamenCompletado(practica.completada || false);
          setResultadoExamen(practica.resultado || null);
          setExamenActivo(practica);
          setEsPractica(true);
          setModalExamenAbierto(true);
          
          setMensaje({ 
            tipo: 'exito', 
            texto: `üéØ Mostrando pr√°ctica: ${practica.titulo || practica.nombre || 'Sin t√≠tulo'}` 
          });
        } else {
          console.error('‚ùå Pr√°ctica no encontrada');
          setMensaje({ tipo: 'error', texto: '‚ùå Pr√°ctica no encontrada' });
        }
        break;
        
      default:
        console.warn('‚ö†Ô∏è Tipo no soportado:', resultado.tipo);
        setMensaje({ tipo: 'info', texto: 'üìÑ Tipo de archivo no soportado' });
    }
  };

  const irARutaResultado = (resultado) => {
    console.log('üìç Navegando a ruta:', resultado);
    switch(resultado.tipo) {
      case 'nota':
        console.log('üìù Navegando a secci√≥n Notas, ruta:', resultado.ruta);
        setSelectedMenu('notas');
        if (resultado.ruta && resultado.ruta !== 'Ra√≠z') {
          setRutaNotasActual(resultado.ruta);
        }
        setMensaje({ tipo: 'exito', texto: 'üìù Navegando a Notas...' });
        break;
        
      case 'flashcard':
        console.log('üÉè Navegando a secci√≥n Flashcards, ruta:', resultado.ruta);
        setSelectedMenu('flashcards');
        if (resultado.ruta && resultado.ruta !== 'Ra√≠z') {
          setCarpetaFlashcardActual(resultado.ruta);
        }
        setMensaje({ tipo: 'exito', texto: 'üÉè Navegando a Flashcards...' });
        break;
        
      case 'documento':
        console.log('üìÑ Navegando a secci√≥n Mis Cursos, ruta:', resultado.ruta);
        setSelectedMenu('cursos');
        // Extraer la ruta de la carpeta del path completo
        const rutaDoc = resultado.ruta.split('\\').slice(0, -1).join('\\');
        if (rutaDoc) {
          setRutaActual(rutaDoc);
        }
        setMensaje({ tipo: 'exito', texto: 'üìö Navegando a Mis Cursos...' });
        break;
        
      case 'examen':
        console.log('üìã Navegando a secci√≥n Historial (ex√°menes), carpeta:', resultado.ruta);
        setSelectedMenu('historial');
        setMensaje({ tipo: 'exito', texto: 'üìã Navegando a Historial de Ex√°menes...' });
        break;
        
      case 'practica':
        console.log('üéØ Navegando a secci√≥n Historial (pr√°cticas), carpeta:', resultado.ruta);
        setSelectedMenu('historial');
        setMensaje({ tipo: 'exito', texto: 'üéØ Navegando a Historial de Pr√°cticas...' });
        break;
    }
  };

  const abrirArchivoBusqueda = (ruta) => {
    const rutaLower = ruta.toLowerCase();
    
    // Detectar tipo de archivo por la ruta
    if (rutaLower.includes('extracciones')) {
      // Archivos en extracciones/ - navegar a Contenido
      setSelectedMenu('contenido');
      setTabContenidoActivo(0); // Tab "Contenido de estudio"
      
      // Intentar cargar el archivo
      const carpeta = ruta.split('\\').slice(0, -1).join('\\');
      const subcarpeta = carpeta.includes('extracciones') 
        ? carpeta.split('extracciones\\')[1] || '' 
        : '';
      
      if (subcarpeta) {
        setRutaContenidoActual(subcarpeta);
        cargarCarpetaContenido(subcarpeta);
      }
      
      setMensaje({ 
        tipo: 'success', 
        texto: `üìÑ Navegando a: ${ruta.split('\\').pop()}` 
      });
      
    } else if (rutaLower.includes('flashcard')) {
      setSelectedMenu('flashcards');
      const carpeta = ruta.split('\\').slice(0, -1).join('\\');
      cargarCarpetasFlashcards(carpeta.split('flashcards\\')[1] || '');
    } else if (rutaLower.includes('nota')) {
      setSelectedMenu('notas');
      const carpeta = ruta.split('\\').slice(0, -1).join('\\');
      cargarCarpetasNotas(carpeta.split('notas\\')[1] || '');
    } else if (rutaLower.includes('curso')) {
      setSelectedMenu('cursos');
      const carpeta = ruta.split('\\').slice(0, -1).join('\\');
      cargarCarpeta(carpeta.split('cursos\\')[1] || '');
    } else {
      setMensaje({ tipo: 'info', texto: `üìÅ Archivo: ${ruta}` });
    }
  };

  const extraerInfoRelevante = (resultado) => {
    // Extraer informaci√≥n √∫til del contenido seg√∫n el tipo
    const contenido = resultado.contenido || resultado.texto_completo || '';
    const info = { titulo: '', subtitulo: '', carpeta: '', textoReal: '' };
    
    // Obtener carpeta legible
    const partes = resultado.ruta.split('\\');
    if (partes.length > 2) {
      info.carpeta = partes.slice(-3, -1).join(' ‚Ä∫ ');
    }
    
    // Extraer snippet del texto real (primeras l√≠neas limpias)
    const lineas = contenido.split('\n').filter(l => l.trim().length > 0);
    if (lineas.length > 0) {
      // Primer l√≠nea como t√≠tulo si es corta
      const primeraLinea = lineas[0].trim().replace(/[#*_"{}\[\]]/g, '').trim();
      if (primeraLinea.length > 0 && primeraLinea.length < 150) {
        info.titulo = primeraLinea;
        // Siguiente l√≠nea como snippet
        if (lineas.length > 1) {
          info.textoReal = lineas.slice(1, 3).join(' ').substring(0, 200) + '...';
        }
      } else {
        // Si primera l√≠nea es larga, usarla como snippet
        info.textoReal = primeraLinea.substring(0, 250) + '...';
      }
    }
    
    // Intentar parsear JSON para extraer info estructurada
    try {
      // Buscar patrones comunes en el texto
      
      // Para ex√°menes
      if (resultado.tipo === 'examen') {
        const preguntaMatch = contenido.match(/"texto":\s*"([^"]+)"/);
        const carpetaMatch = contenido.match(/"carpeta_nombre":\s*"([^"]+)"/);
        
        if (preguntaMatch) info.titulo = preguntaMatch[1];
        if (carpetaMatch) info.subtitulo = `Carpeta: ${carpetaMatch[1]}`;
      }
      
      // Para notas y documentos generales
      const primeraLinea = contenido.split('\n')[0].trim();
      if (primeraLinea && primeraLinea.length > 0 && primeraLinea.length < 100) {
        info.titulo = primeraLinea.replace(/[#*_]/g, '').trim();
      }
      
    } catch (e) {
      // Si falla el parseo, usar snippet directo
    }
    
    return info;
  };

  const crearNuevaFlashcard = () => {
    setFlashcardEditando(null)
    const carpetaActual = carpetaFlashcardActual?.ruta || rutaFlashcardsActual || '';
    console.log('üìù Creando nueva flashcard en carpeta:', carpetaActual);
    setFormDataFlashcard({
      tipo: 'clasica',
      titulo: '',
      contenido: '',
      opciones: [],
      respuestaCorrecta: '',
      explicacion: '',
      tema: '',
      carpeta: carpetaActual,
      estadoRevision: 'nueva',
      archivos: [],
      imagenes: [],
      latex: false,
      subtema: '',
      lenguaje: 'javascript',
      dificultad: 'medio',
      patronCodigo: 'comprension',
      subtipoQuimica: 'estructura',
      nivelQuimica: 'basico',
      rama: 'organica',
      subtipoFisica: 'ecuacion',
      nivelFisica: 'basico',
      ramaFisica: 'mecanica',
      subtipoIngenieria: 'circuito',
      nivelIngenieria: 'basico',
      ramaIngenieria: 'electrica',
      subtipoProgramacion: 'uml',
      patronProgramacion: 'clase',
      nivelProgramacion: 'basico',
      subtipoDiscreta: 'logica',
      categoriaDiscreta: 'proposicional',
      nivelDiscreta: 'basico',
      subtipoLinguistica: 'ipa',
      categoriaLinguistica: 'vocales',
      nivelLinguistica: 'basico',
      subtipoMusica: 'pentagramas',
      categoriaMusica: 'claves',
      nivelMusica: 'basico',
      subtipoGeometria: 'puntos',
      categoriaGeometria: 'basicos',
      nivelGeometria: 'basico',
      subtipoQuimicaAvanzada: 'orbitales',
      categoriaQuimicaAvanzada: 'atomicos',
      nivelQuimicaAvanzada: 'basico',
      subtipoProbabilidad: 'arboles',
      categoriaProbabilidad: 'simple',
      nivelProbabilidad: 'basico',
      subtipoArte: 'figuras',
      categoriaArte: 'basico',
      estiloArtistico: 'ninguno',
      paletaColor: 'ninguna'
    })
    setModalNuevaFlashcard(true)
  }


  const guardarFlashcard = async (flashcard) => {
    const carpetaDestino = carpetaFlashcardActual?.ruta || rutaFlashcardsActual || '';
    
    if (!carpetaDestino) {
      setMensaje({
        tipo: 'error',
        texto: '‚ö†Ô∏è Por favor, navega a una carpeta primero'
      });
      return;
    }
    
    console.log('üíæ Guardando flashcard:', {
      titulo: flashcard.titulo,
      carpetaFlashcardActual: carpetaFlashcardActual,
      rutaFlashcardsActual: rutaFlashcardsActual,
      carpetaDestino: carpetaDestino
    });
    
    const nuevaFlashcard = {
      id: flashcard.id || Date.now(),
      tipo: flashcard.tipo,
      titulo: flashcard.titulo,
      contenido: flashcard.contenido,
      opciones: flashcard.opciones || [],
      respuestaCorrecta: flashcard.respuestaCorrecta,
      explicacion: flashcard.explicacion,
      tema: flashcard.tema,
      subtema: flashcard.subtema || '',
      carpeta: carpetaDestino,
      fecha: flashcard.fecha || new Date().toISOString(),
      fecha_creacion: flashcard.fecha_creacion || new Date().toISOString(),
      // Campos de repetici√≥n espaciada (SM-2)
      fechaRevision: flashcard.fechaRevision || null,
      ultima_revision: flashcard.ultima_revision || null, // Para control de repetici√≥n diaria
      proximaRevision: flashcard.proximaRevision || new Date().toISOString(),
      intervalo: flashcard.intervalo || 1, // d√≠as hasta pr√≥xima revisi√≥n
      repeticiones: flashcard.repeticiones || 0, // veces que se ha recordado correctamente
      facilidad: flashcard.facilidad || 2.5, // factor de facilidad (1.3-2.5)
      estadoRevision: flashcard.estadoRevision || 'nueva',
      archivos: flashcard.archivos || [],
      imagenes: flashcard.imagenes || [],
      latex: flashcard.latex || false,
      lenguaje: flashcard.lenguaje || 'javascript',
      dificultad: flashcard.dificultad || 'medio',
      patronCodigo: flashcard.patronCodigo || 'comprension',
      subtipoQuimica: flashcard.subtipoQuimica || 'estructura',
      nivelQuimica: flashcard.nivelQuimica || 'basico',
      rama: flashcard.rama || 'organica',
      subtipoFisica: flashcard.subtipoFisica || 'ecuacion',
      nivelFisica: flashcard.nivelFisica || 'basico',
      ramaFisica: flashcard.ramaFisica || 'mecanica',
      subtipoIngenieria: flashcard.subtipoIngenieria || 'circuito',
      nivelIngenieria: flashcard.nivelIngenieria || 'basico',
      ramaIngenieria: flashcard.ramaIngenieria || 'electrica',
      subtipoProgramacion: flashcard.subtipoProgramacion || 'uml',
      patronProgramacion: flashcard.patronProgramacion || 'clase',
      nivelProgramacion: flashcard.nivelProgramacion || 'basico',
      subtipoDiscreta: flashcard.subtipoDiscreta || 'logica',
      categoriaDiscreta: flashcard.categoriaDiscreta || 'proposicional',
      nivelDiscreta: flashcard.nivelDiscreta || 'basico',
      subtipoLinguistica: flashcard.subtipoLinguistica || 'ipa',
      categoriaLinguistica: flashcard.categoriaLinguistica || 'vocales',
      nivelLinguistica: flashcard.nivelLinguistica || 'basico',
      subtipoMusica: flashcard.subtipoMusica || 'pentagramas',
      categoriaMusica: flashcard.categoriaMusica || 'claves',
      nivelMusica: flashcard.nivelMusica || 'basico',
      subtipoGeometria: flashcard.subtipoGeometria || 'puntos',
      categoriaGeometria: flashcard.categoriaGeometria || 'basicos',
      nivelGeometria: flashcard.nivelGeometria || 'basico',
      subtipoQuimicaAvanzada: flashcard.subtipoQuimicaAvanzada || 'orbitales',
      categoriaQuimicaAvanzada: flashcard.categoriaQuimicaAvanzada || 'atomicos',
      nivelQuimicaAvanzada: flashcard.nivelQuimicaAvanzada || 'basico',
      subtipoProbabilidad: flashcard.subtipoProbabilidad || 'arboles',
      categoriaProbabilidad: flashcard.categoriaProbabilidad || 'simple',
      nivelProbabilidad: flashcard.nivelProbabilidad || 'basico',
      subtipoArte: flashcard.subtipoArte || 'figuras',
      categoriaArte: flashcard.categoriaArte || 'basico',
      estiloArtistico: flashcard.estiloArtistico || 'ninguno',
      paletaColor: flashcard.paletaColor || 'ninguna'
    }

    // üî• GUARDAR EN ARCHIVO INDIVIDUAL DE LA CARPETA
    try {
      const response = await fetch(`${API_URL}/datos/flashcards/carpeta`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          flashcard: nuevaFlashcard,
          carpeta: carpetaDestino
        })
      });
      
      const result = await response.json();
      
      if (result.ok) {
        console.log(`‚úÖ Flashcard guardada en: ${result.archivo}`);
        console.log(`   Total en carpeta: ${result.count}`);
        
        // üî• Recargar todas las flashcards usando el NUEVO ENDPOINT
        const todasFlashcards = await cargarTodasFlashcards();
        setFlashcardsActuales(todasFlashcards);
        setModalNuevaFlashcard(false);
        
        // Recargar carpetas para actualizar el conteo
        if (selectedMenu === 'flashcards') {
          cargarCarpetasFlashcards(rutaFlashcardsActual);
        }
        
        setMensaje({
          tipo: 'success',
          texto: flashcard.id ? '‚úÖ Flashcard actualizada' : `‚úÖ Flashcard creada en ${carpetaDestino}`
        });
      } else {
        throw new Error(result.error || 'Error al guardar');
      }
    } catch (error) {
      console.error('‚ùå Error guardando flashcard:', error);
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al guardar flashcard'
      });
    }
  }

  const eliminarFlashcard = async (id) => {
    if (!confirm('¬øEliminar esta flashcard?')) return
    
    // Buscar la carpeta de la flashcard
    const flashcards = await cargarTodasFlashcards();
    const flashcard = flashcards.find(f => f.id === id);
    const carpeta = flashcard?.carpeta || '';
    
    try {
      // üî• ELIMINAR USANDO ENDPOINT DELETE
      const response = await fetch(`${API_URL}/datos/flashcards/${id}?carpeta=${encodeURIComponent(carpeta)}`, {
        method: 'DELETE'
      });
      
      if (!response.ok) throw new Error('Error al eliminar');
      
      // Actualizar estado local
      const flashcardsActualizadas = flashcards.filter(f => f.id !== id);
      setFlashcardsActuales(flashcardsActualizadas);
      
      // Recargar carpetas para actualizar el conteo
      if (selectedMenu === 'flashcards') {
        cargarCarpetasFlashcards(rutaFlashcardsActual);
      }
      
      setMensaje({
        tipo: 'success',
        texto: 'üóëÔ∏è Flashcard eliminada'
      });
    } catch (error) {
      console.error('Error eliminando flashcard:', error);
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al eliminar flashcard'
      });
    }
  }

  const seleccionarCarpetaNota = (carpeta) => {
    setCarpetaNota(carpeta)
    setModalCarpetasNotaAbierto(false)
  }

  const moverNota = async (idNota, nuevaCarpeta) => {
    const nota = (notasGuardadas || []).find(n => n.id === idNota);
    if (!nota) return;
    
    const notaActualizada = { ...nota, carpeta: nuevaCarpeta };
    await guardarNotaEnCarpeta(notaActualizada);
    
    const notasActualizadas = (notasGuardadas || []).map(n => 
      n.id === idNota ? notaActualizada : n
    )
    setNotasGuardadas(notasActualizadas)
    
    setMensaje({
      tipo: 'success',
      texto: '‚úÖ Nota movida a ' + (nuevaCarpeta || 'Ra√≠z')
    })
  }

  const exportarNotaTXTCarpeta = async (nota) => {
    try {
      // Extraer texto plano del HTML
      const tempDiv = document.createElement('div')
      tempDiv.innerHTML = nota.contenido
      const textoPlano = tempDiv.textContent || tempDiv.innerText
      
      const contenidoTxt = `${nota.titulo}\n${'='.repeat(nota.titulo.length)}\n\n${textoPlano}`
      
      // Enviar al backend para guardar en la carpeta real
      const response = await fetch(`${API_URL}/api/guardar-nota-txt`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          carpeta: nota.carpeta || '',
          nombreArchivo: `${nota.titulo.replace(/[^a-z0-9]/gi, '_')}.txt`,
          contenido: contenidoTxt
        })
      })
      
      if (response.ok) {
        setMensaje({
          tipo: 'success',
          texto: 'üìÑ Nota guardada como TXT en la carpeta'
        })
      } else {
        throw new Error('Error al guardar')
      }
    } catch (error) {
      setMensaje({
        tipo: 'error',
        texto: '‚ùå Error al guardar TXT'
      })
    }
  }

  const exportarNotaPDF = (nota) => {
    // Crear un iframe oculto con el contenido
    const iframe = document.createElement('iframe')
    iframe.style.display = 'none'
    document.body.appendChild(iframe)
    
    const iframeDoc = iframe.contentWindow.document
    iframeDoc.open()
    iframeDoc.write(`
      <!DOCTYPE html>
      <html>
        <head>
          <meta charset="UTF-8">
          <title>${nota.titulo}</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              max-width: 800px;
              margin: 40px auto;
              padding: 20px;
              line-height: 1.6;
            }
            h1 {
              color: #333;
              border-bottom: 2px solid #646cff;
              padding-bottom: 10px;
            }
            img {
              max-width: 100%;
              height: auto;
            }
          </style>
        </head>
        <body>
          <h1>${nota.titulo}</h1>
          ${nota.contenido}
        </body>
      </html>
    `)
    iframeDoc.close()
    
    // Esperar a que cargue y luego imprimir
    setTimeout(() => {
      iframe.contentWindow.print()
      setTimeout(() => {
        document.body.removeChild(iframe)
      }, 1000)
    }, 500)
    
    setMensaje({
      tipo: 'info',
      texto: 'üìÑ Abriendo di√°logo de impresi√≥n (Guardar como PDF)'
    })
  }

  // Funci√≥n para instalar modelo GGUF en Ollama
  const instalarModeloOllama = async () => {
    if (!archivoModeloGGUF) {
      setMensaje({ tipo: 'error', texto: '‚ö†Ô∏è Selecciona un archivo .gguf' })
      return
    }

    if (!nombreModeloNuevo.trim()) {
      setMensaje({ tipo: 'error', texto: '‚ö†Ô∏è Ingresa un nombre para el modelo' })
      return
    }

    setInstalandoModelo(true)

    try {
      const formData = new FormData()
      formData.append('archivo', archivoModeloGGUF)
      formData.append('nombre_modelo', nombreModeloNuevo)

      const response = await fetch(`${API_URL}/api/ollama/install-model`, {
        method: 'POST',
        body: formData
      })

      if (!response.ok) {
        const errorData = await response.json()
        throw new Error(errorData.detail || 'Error instalando modelo')
      }

      const data = await response.json()

      setMensaje({
        tipo: 'exito',
        texto: `‚úÖ Modelo '${nombreModeloNuevo}' instalado exitosamente`
      })

      // Actualizar lista de modelos
      if (data.modelos_disponibles) {
        setModelosDisponibles(data.modelos_disponibles)
      }

      // Activar autom√°ticamente el modelo reci√©n instalado
      try {
        const responseMotor = await fetch(`${API_URL}/api/motor/cambiar`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            usar_ollama: true,
            modelo_ollama: nombreModeloNuevo,
            n_gpu_layers: 35
          })
        })
        const dataMotor = await responseMotor.json()
        
        if (dataMotor.success) {
          setMensaje({tipo: 'exito', texto: `‚úÖ Modelo ${nombreModeloNuevo} instalado y activado con GPU`})
        } else {
          console.warn('No se pudo activar autom√°ticamente:', dataMotor)
        }
      } catch (errorActivacion) {
        console.warn('Error al activar autom√°ticamente:', errorActivacion)
      }

      // Cerrar modal y limpiar
      setModalInstaladorModelo(false)
      setArchivoModeloGGUF(null)
      setNombreModeloNuevo('')

      // Recargar configuraci√≥n
      cargarConfiguracion()

    } catch (error) {
      console.error('Error instalando modelo:', error)
      setMensaje({
        tipo: 'error',
        texto: `‚ùå Error: ${error.message}`
      })
    } finally {
      setInstalandoModelo(false)
    }
  }

  return (
    <div className="app-container">
      {/* Bot√≥n men√∫ m√≥vil */}
      <button 
        className="mobile-menu-btn"
        onClick={() => setMenuMovilAbierto(!menuMovilAbierto)}
        aria-label="Men√∫"
      >
        <span className="icon">{menuMovilAbierto ? '‚úï' : '‚ò∞'}</span>
      </button>

      {/* Overlay para cerrar men√∫ */}
      <div 
        className={`sidebar-overlay ${menuMovilAbierto ? 'show' : ''}`}
        onClick={() => setMenuMovilAbierto(false)}
      />

      {/* Sidebar */}
      <aside className={`sidebar ${menuMovilAbierto ? 'open' : ''}`}>
        <div className="sidebar-header">
          <h2>üìù Examinator</h2>
          <button 
            className="btn-close-sidebar"
            onClick={() => setMenuMovilAbierto(false)}
            aria-label="Cerrar men√∫"
          >
            ‚úï
          </button>
        </div>
        <nav className="sidebar-nav">
          <button 
            className={`nav-item ${selectedMenu === 'inicio' ? 'active' : ''}`}
            onClick={() => { 
              setSelectedMenu('inicio'); 
              setMenuMovilAbierto(false); 
            }}
          >
            <span className="icon">üè†</span>
            <span>Inicio</span>
          </button>
          <button 
            className={`nav-item ${selectedMenu === 'cursos' ? 'active' : ''}`}
            onClick={() => { 
              setSelectedMenu('cursos'); 
              cargarCarpeta(''); 
              setMenuMovilAbierto(false); 
            }}
          >
            <span className="icon">üìö</span>
            <span>Mis Cursos</span>
          </button>
          <button 
            className={`nav-item ${selectedMenu === 'generar' ? 'active' : ''}`}
            onClick={() => { 
              setSelectedMenu('generar'); 
              setMenuMovilAbierto(false); 
            }}
          >
            <span className="icon">‚ú®</span>
            <span>Examenes</span>
          </button>
          <button 
            className={`nav-item ${selectedMenu === 'practicas' ? 'active' : ''}`}
            onClick={() => { 
              setSelectedMenu('practicas'); 
              setMenuMovilAbierto(false); 
            }}
          >
            <span className="icon">üßë‚Äçüíª</span>
            <span>Pr√°cticas</span>
          </button>
          <button 
            className={`nav-item ${selectedMenu === 'notas' ? 'active' : ''}`}
            onClick={() => { 
              setSelectedMenu('notas'); 
              setMenuMovilAbierto(false); 
            }}
          >
            <span className="icon">üìì</span>
            <span>Notas</span>
          </button>
          <button 
            className={`nav-item ${selectedMenu === 'flashcards' ? 'active' : ''}`}
            onClick={() => { 
              setSelectedMenu('flashcards'); 
              setMenuMovilAbierto(false);
              cargarCarpetasFlashcards();
            }}
          >
            <span className="icon">üÉè</span>
            <span>Flashcards</span>
          </button>
          
          <button 
            className={`nav-item ${selectedMenu === 'buscar' ? 'active' : ''}`}
            onClick={() => { 
              setSelectedMenu('buscar'); 
              setMenuMovilAbierto(false);
            }}
          >
            <span className="icon">üîç</span>
            <span>Buscar</span>
          </button>
          
          {/* üî• BOT√ìN DE SESI√ìN - Mostrar cuando hay sesi√≥n activa */}
          {sesionActiva && (
            <>
              <button 
                className={`nav-item ${selectedMenu === 'sesion' ? 'active' : ''} sesion-activa-indicator`}
                onClick={() => { 
                  setSelectedMenu('sesion'); 
                  setMenuMovilAbierto(false); 
                }}
                title="Volver a tu sesi√≥n activa"
              >
                <span className="icon">üéØ</span>
                <span>Sesi√≥n Activa</span>
                <span className="pulse-dot"></span>
              </button>

              {/* CONTROLES DE SESI√ìN EN SIDEBAR */}
              <div className="sidebar-sesion-controls">
                {/* Contador de pausa */}
                {sesionPausada && timestampInicioPausa && (
                  <div className="contador-pausa">
                    <div className="contador-pausa-header">
                      <span className="pausa-icono">‚è∏Ô∏è</span>
                      <span className="pausa-texto">Sesi√≥n en Pausa</span>
                    </div>
                    <div className="contador-pausa-timer">
                      {(() => {
                        const tiempoPausaSegundos = Math.floor((Date.now() - timestampInicioPausa) / 1000);
                        const minutos = Math.floor(tiempoPausaSegundos / 60);
                        const segundos = tiempoPausaSegundos % 60;
                        return (
                          <>
                            <span className="pausa-tiempo">
                              {minutos}:{String(segundos).padStart(2, '0')}
                            </span>
                            <div className="pausa-recomendacion">
                              {minutos < 5 ? (
                                <span className="recomendacion-verde">‚úÖ Pausa ideal: 5-10 min</span>
                              ) : minutos < 10 ? (
                                <span className="recomendacion-verde">‚úÖ Tiempo √≥ptimo de descanso</span>
                              ) : minutos < 15 ? (
                                <span className="recomendacion-amarillo">‚ö†Ô∏è Considera reanudar pronto</span>
                              ) : (
                                <span className="recomendacion-rojo">üî¥ Mucho tiempo pausado</span>
                              )}
                            </div>
                          </>
                        );
                      })()}
                    </div>
                  </div>
                )}
                
                {/* Timer y fase actual */}
                <div className="sidebar-sesion-info">
                  <div className="sidebar-fase-badge">
                    <span className="fase-emoji">
                      {faseActual === 'calentamiento' ? 'üî•' :
                       faseActual === 'errores' ? '‚ùå' :
                       faseActual === 'flashcards' ? 'üé¥' :
                       faseActual === 'contenido' ? 'üìö' :
                       faseActual === 'descanso' ? (tiempoRestante > 600 ? 'üßò' : '‚òï') :
                       'üìä'}
                    </span>
                    <span className="fase-texto">{obtenerNombreFase(faseActual)}</span>
                  </div>
                  
                  {/* Timer */}
                  {!modoLibreActivo ? (
                    <div className="sidebar-timer">
                      {faseActual === 'descanso' ? (
                        <div className="timer-display timer-descanso">
                          <div className="timer-descanso-label">
                            Descanso en {Math.floor(tiempoRestante / 60)} min
                          </div>
                        </div>
                      ) : (
                        <div className="timer-display">
                          <span className="timer-minutos">{Math.floor(tiempoRestante / 60)}</span>
                          <span className="timer-separador">:</span>
                          <span className="timer-segundos">{String(tiempoRestante % 60).padStart(2, '0')}</span>
                        </div>
                      )}
                      <div className="timer-progreso">
                        <div 
                          className="timer-progreso-barra"
                          style={{width: `${(tiempoRestante / tiempoFaseActual) * 100}%`}}
                        ></div>
                      </div>
                      
                      {/* Contador de descanso - siempre visible */}
                      {!enDescanso && (
                        <div className="contador-descanso">
                          <span className="descanso-label">Descanso en:</span>
                          <span className="descanso-tiempo">
                            {Math.floor(tiempoHastaDescanso / 60)}:{String(tiempoHastaDescanso % 60).padStart(2, '0')}
                          </span>
                          <div className="descanso-progreso">
                            <div 
                              className="descanso-progreso-barra"
                              style={{width: `${(tiempoHastaDescanso / intervaloDescansoInicial) * 100}%`}}
                            ></div>
                          </div>
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="sidebar-modo-libre">
                      <span>‚ôæÔ∏è</span>
                      <span>Modo Libre</span>
                    </div>
                  )}
                  
                  {/* Indicador de siguiente fase o contador de pausa */}
                  {sesionPausada && tiempoPausaRestante > 0 ? (
                    <div className="sidebar-siguiente-fase pausa-activa">
                      <span className="siguiente-label">‚è∏Ô∏è Pausa:</span>
                      <span className="siguiente-nombre pausa-contador">
                        {Math.floor(tiempoPausaRestante / 60)}:{String(tiempoPausaRestante % 60).padStart(2, '0')}
                      </span>
                    </div>
                  ) : enDescanso ? (
                    <div className="sidebar-siguiente-fase">
                      <span className="siguiente-label">Despu√©s del descanso:</span>
                      <span className="siguiente-nombre">
                        {fasesSesion[indiceFaseActual]?.tipo === 'calentamiento' ? 'üî• Calentamiento' :
                         fasesSesion[indiceFaseActual]?.tipo === 'errores' ? '‚ùå Errores' :
                         fasesSesion[indiceFaseActual]?.tipo === 'flashcards' ? 'üé¥ Flashcards' :
                         fasesSesion[indiceFaseActual]?.tipo === 'contenido' ? 'üìö Contenido' :
                         'üéØ ' + (fasesSesion[indiceFaseActual]?.tipo || 'Continuar')}
                      </span>
                    </div>
                  ) : !enDescanso && indiceFaseActual < fasesSesion.length - 1 ? (
                    <div className="sidebar-siguiente-fase">
                      <span className="siguiente-label">Siguiente:</span>
                      <span className="siguiente-nombre">
                        {fasesSesion[indiceFaseActual + 1]?.tipo === 'calentamiento' ? 'üî• Calentamiento' :
                         fasesSesion[indiceFaseActual + 1]?.tipo === 'errores' ? '‚ùå Errores' :
                         fasesSesion[indiceFaseActual + 1]?.tipo === 'flashcards' ? 'üé¥ Flashcards' :
                         fasesSesion[indiceFaseActual + 1]?.tipo === 'contenido' ? 'üìö Contenido' :
                         'üéØ ' + (fasesSesion[indiceFaseActual + 1]?.tipo || 'Siguiente')}
                      </span>
                    </div>
                  ) : null}
                </div>

                {/* Botones de control */}
                <div className="sidebar-sesion-buttons">
                  <button
                    className="btn-sidebar-sesion btn-pausar"
                    onClick={() => setSesionPausada(!sesionPausada)}
                    title={sesionPausada ? 'Reanudar' : 'Pausar'}
                  >
                    {sesionPausada ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'}
                  </button>
                  
                  <button
                    className="btn-sidebar-sesion btn-detener"
                    onClick={detenerSesion}
                    title="Detener sesi√≥n"
                  >
                    ‚èπÔ∏è
                  </button>
                </div>
              </div>
            </>
          )}
          
          <button 
            className={`nav-item ${selectedMenu === 'historial' ? 'active' : ''}`}
            onClick={() => { 
              setSelectedMenu('historial'); 
              setMenuMovilAbierto(false); 
            }}
          >
            <span className="icon">üìÖ</span>
            <span>Calendario</span>
          </button>
          <button 
            className={`nav-item ${selectedMenu === 'chat' ? 'active' : ''}`}
            onClick={() => { 
              setSelectedMenu('chat'); 
              setMenuMovilAbierto(false); 
            }}
          >
            <span className="icon">üí¨</span>
            <span>Chat con IA</span>
          </button>
          <button 
            className={`nav-item ${selectedMenu === 'configuracion' ? 'active' : ''}`}
            onClick={() => { 
              setSelectedMenu('configuracion'); 
              setMenuMovilAbierto(false); 
            }}
          >
            <span className="icon">‚öôÔ∏è</span>
            <span>Configuraci√≥n</span>
          </button>
        </nav>

        {/* Info de conexi√≥n al final del sidebar */}
        {window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1' && (
          <div style={{
            marginTop: 'auto',
            padding: '1rem',
            background: 'rgba(102, 126, 234, 0.1)',
            borderTop: '1px solid rgba(102, 126, 234, 0.2)',
            fontSize: '0.75rem',
            color: '#a0aec0',
            lineHeight: '1.6'
          }}>
            <div style={{ marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              <span>üåê</span>
              <div style={{ flex: 1, overflow: 'hidden' }}>
                <div style={{ fontSize: '0.7rem', opacity: 0.7 }}>Accediendo desde:</div>
                <div style={{ 
                  fontWeight: '600', 
                  color: '#667eea',
                  whiteSpace: 'nowrap',
                  overflow: 'hidden',
                  textOverflow: 'ellipsis'
                }}>
                  {window.location.hostname}:{window.location.port}
                </div>
              </div>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              <span>üîå</span>
              <div style={{ flex: 1, overflow: 'hidden' }}>
                <div style={{ fontSize: '0.7rem', opacity: 0.7 }}>API Backend:</div>
                <div style={{ 
                  fontWeight: '600', 
                  color: '#764ba2',
                  whiteSpace: 'nowrap',
                  overflow: 'hidden',
                  textOverflow: 'ellipsis'
                }}>
                  {API_URL}
                </div>
              </div>
            </div>
          </div>
        )}
      </aside>

      {/* Main Content */}
      <main className="main-content">
        {mensaje && (
          <div className={`mensaje ${mensaje.tipo}`}>
            {mensaje.texto}
            <button onClick={() => setMensaje(null)}>‚úï</button>
          </div>
        )}

        {selectedMenu === 'inicio' && (
          <div className="welcome-section">
            <h1>üìö Mis Carpetas Recientes</h1>
            <p className="subtitle">Accede r√°pidamente a tus cursos, cap√≠tulos, clases y lecciones marcadas</p>
            
            {/* BOT√ìN COMENZAR - Primera fila */}
            <div className="seccion-comenzar">
              <button 
                className="btn-comenzar"
                onClick={() => setModalConfigSesion(true)}
              >
                <div className="comenzar-icon">üöÄ</div>
                <div className="comenzar-content">
                  <h3>¬°Comienza a Estudiar!</h3>
                  <p>Sesi√≥n de estudio personalizada con IA</p>
                </div>
                <div className="comenzar-arrow">‚Üí</div>
              </button>
            </div>

            {/* CURSOS */}
            {cursosRecientes.length > 0 && (
              <div className="seccion-carpetas">
                <h2 className="titulo-seccion">üìö Cursos</h2>
                <div className="cursos-recientes-grid">
                  {cursosRecientes.map(curso => {
                    const rendimiento = calcularRendimientoCarpeta(curso.ruta);
                    
                    return (
                      <div 
                        key={curso.ruta} 
                        className="curso-card"
                        onClick={() => {
                          setSelectedMenu('cursos');
                          cargarCarpeta(curso.ruta);
                        }}
                      >
                        <div className="curso-icon">üìÅ</div>
                        <div className="curso-nombre">{curso.nombre}</div>
                        <div className="curso-rendimiento">
                          <div className="rendimiento-barra-container">
                            <div className="rendimiento-barra-bg">
                              <div 
                                className="rendimiento-barra-fill"
                                style={{
                                  width: `${rendimiento.porcentajeDominado}%`,
                                  background: rendimiento.porcentajeDominado >= 80 ? '#4caf50' : 
                                             rendimiento.porcentajeDominado >= 50 ? '#3b82f6' : 
                                             rendimiento.porcentajeDominado >= 25 ? '#f59e0b' : '#ef4444'
                                }}
                              ></div>
                            </div>
                            <span className="rendimiento-porcentaje">{rendimiento.porcentajeDominado}%</span>
                          </div>
                          <div className="rendimiento-detalles">
                            {rendimiento.total > 0 ? (
                              <>
                                <span className="detalle-item">‚úÖ {rendimiento.dominadas}</span>
                                <span className="detalle-item">üìñ {rendimiento.enProgreso}</span>
                                <span className="detalle-item">üÜï {rendimiento.nuevas}</span>
                              </>
                            ) : (
                              <span className="sin-datos">Sin datos</span>
                            )}
                          </div>
                        </div>
                        <div className="curso-stats">
                          <div className="stat-item">
                            <div className="stat-value">{curso.num_documentos}</div>
                            <div className="stat-label">Documentos</div>
                          </div>
                          <div className="stat-divider"></div>
                          <div className="stat-item">
                            <div className="stat-value">{curso.num_subcarpetas}</div>
                            <div className="stat-label">Carpetas</div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* CAP√çTULOS */}
            {capitulosRecientes.length > 0 && (
              <div className="seccion-carpetas">
                <h2 className="titulo-seccion">üìñ Cap√≠tulos</h2>
                <div className="cursos-recientes-grid">
                  {capitulosRecientes.map(capitulo => (
                    <div 
                      key={capitulo.ruta} 
                      className="curso-card"
                      onClick={() => {
                        setSelectedMenu('cursos');
                        cargarCarpeta(capitulo.ruta);
                      }}
                    >
                      <div className="curso-icon">üìÅ</div>
                      <div className="curso-nombre">{capitulo.nombre}</div>
                      <div className="curso-rendimiento">
                        <span className="rendimiento-label">Rendimiento</span>
                      </div>
                      <div className="curso-stats">
                        <div className="stat-item">
                          <div className="stat-value">{capitulo.num_documentos}</div>
                          <div className="stat-label">Documentos</div>
                        </div>
                        <div className="stat-divider"></div>
                        <div className="stat-item">
                          <div className="stat-value">{capitulo.num_subcarpetas}</div>
                          <div className="stat-label">Carpetas</div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* CLASES */}
            {clasesRecientes.length > 0 && (
              <div className="seccion-carpetas">
                <h2 className="titulo-seccion">üìë Clases</h2>
                <div className="cursos-recientes-grid">
                  {clasesRecientes.map(clase => (
                    <div 
                      key={clase.ruta} 
                      className="curso-card"
                      onClick={() => {
                        setSelectedMenu('cursos');
                        cargarCarpeta(clase.ruta);
                      }}
                    >
                      <div className="curso-icon">üìÅ</div>
                      <div className="curso-nombre">{clase.nombre}</div>
                      <div className="curso-rendimiento">
                        <span className="rendimiento-label">Rendimiento</span>
                      </div>
                      <div className="curso-stats">
                        <div className="stat-item">
                          <div className="stat-value">{clase.num_documentos}</div>
                          <div className="stat-label">Documentos</div>
                        </div>
                        <div className="stat-divider"></div>
                        <div className="stat-item">
                          <div className="stat-value">{clase.num_subcarpetas}</div>
                          <div className="stat-label">Carpetas</div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* LECCIONES */}
            {leccionesRecientes.length > 0 && (
              <div className="seccion-carpetas">
                <h2 className="titulo-seccion">üìÑ Lecciones</h2>
                <div className="cursos-recientes-grid">
                  {leccionesRecientes.map(leccion => (
                    <div 
                      key={leccion.ruta} 
                      className="curso-card"
                      onClick={() => {
                        setSelectedMenu('cursos');
                        cargarCarpeta(leccion.ruta);
                      }}
                    >
                      <div className="curso-icon">üìÅ</div>
                      <div className="curso-nombre">{leccion.nombre}</div>
                      <div className="curso-rendimiento">
                        <span className="rendimiento-label">Rendimiento</span>
                      </div>
                      <div className="curso-stats">
                        <div className="stat-item">
                          <div className="stat-value">{leccion.num_documentos}</div>
                          <div className="stat-label">Documentos</div>
                        </div>
                        <div className="stat-divider"></div>
                        <div className="stat-item">
                          <div className="stat-value">{leccion.num_subcarpetas}</div>
                          <div className="stat-label">Carpetas</div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {/* Estado vac√≠o */}
            {cursosRecientes.length === 0 && capitulosRecientes.length === 0 && 
             clasesRecientes.length === 0 && leccionesRecientes.length === 0 && (
              <div className="empty-state">
                <div className="empty-icon">üìö</div>
                <h3>A√∫n no hay carpetas marcadas</h3>
                <p>Ve a "Mis Cursos", selecciona una carpeta y m√°rcala como curso, cap√≠tulo, clase o lecci√≥n desde el men√∫ de opciones (‚ãÆ) para que aparezca aqu√≠</p>
                <button 
                  className="btn-primary"
                  onClick={() => { setSelectedMenu('cursos'); cargarCarpeta(''); }}
                  style={{marginTop: '1.5rem'}}
                >
                  Ir a Mis Cursos
                </button>
              </div>
            )}
          </div>
        )}

        {/* ============================================ */}
        {/* üéØ VISTA DEL MODO SESI√ìN DE ESTUDIO */}
        {/* ============================================ */}
        {selectedMenu === 'sesion' && sesionActiva && (
          <div className="sesion-estudio-container-wrapper">
            {/* SELECTOR DE CURSOS LATERAL */}
            {selectorCursosAbierto && (
              <div className="selector-cursos-panel">
                <div className="selector-header">
                  <h3>üìö Explorar Cursos</h3>
                  <button
                    className="btn-cerrar-selector"
                    onClick={() => setSelectorCursosAbierto(false)}
                  >
                    ‚úï
                  </button>
                </div>
                
                <div className="selector-busqueda">
                  <input
                    type="text"
                    placeholder="Buscar curso, cap√≠tulo, lecci√≥n..."
                    className="input-buscar-curso"
                    value={busquedaCursos}
                    onChange={(e) => setBusquedaCursos(e.target.value)}
                  />
                  {busquedaCursos && (
                    <button 
                      className="btn-limpiar-busqueda"
                      onClick={() => setBusquedaCursos('')}
                      title="Limpiar b√∫squeda"
                    >
                      ‚úï
                    </button>
                  )}
                </div>
                
                <div className="selector-contenido">
                  {/* √Årbol de cursos */}
                  <div className="arbol-cursos">
                    {carpetasCursos
                      .filter(carpeta => {
                        // Filtrar por b√∫squeda
                        if (!busquedaCursos.trim()) return true;
                        
                        const busqueda = busquedaCursos.toLowerCase();
                        const nombreCarpeta = carpeta.nombre.toLowerCase();
                        
                        // Buscar en el nombre de la carpeta
                        if (nombreCarpeta.includes(busqueda)) return true;
                        
                        // Buscar en subcarpetas
                        if (carpeta.subcarpetas) {
                          return carpeta.subcarpetas.some(sub => 
                            sub.nombre.toLowerCase().includes(busqueda)
                          );
                        }
                        
                        return false;
                      })
                      .map((carpeta) => (
                      <div key={carpeta.nombre} className="curso-item">
                        <div className="curso-header">
                          <span className="curso-icono">üìÅ</span>
                          <span className="curso-nombre">{carpeta.nombre}</span>
                        </div>
                        {carpeta.subcarpetas && carpeta.subcarpetas
                          .filter(subcarpeta => {
                            if (!busquedaCursos.trim()) return true;
                            return subcarpeta.nombre.toLowerCase().includes(busquedaCursos.toLowerCase());
                          })
                          .map((subcarpeta) => (
                          <div key={subcarpeta.nombre} className="subcarpeta-item">
                            <span className="subcarpeta-icono">üìÇ</span>
                            <span className="subcarpeta-nombre">{subcarpeta.nombre}</span>
                          </div>
                        ))}
                      </div>
                    ))}
                  </div>
                  
                  {carpetasCursos.filter(carpeta => {
                    if (!busquedaCursos.trim()) return true;
                    const busqueda = busquedaCursos.toLowerCase();
                    const nombreCarpeta = carpeta.nombre.toLowerCase();
                    if (nombreCarpeta.includes(busqueda)) return true;
                    if (carpeta.subcarpetas) {
                      return carpeta.subcarpetas.some(sub => 
                        sub.nombre.toLowerCase().includes(busqueda)
                      );
                    }
                    return false;
                  }).length === 0 && (
                    <div className="selector-vacio">
                      <div className="vacio-icon">üîç</div>
                      <p>No se encontraron resultados para "{busquedaCursos}"</p>
                      <button 
                        className="btn-limpiar-busqueda-vacio"
                        onClick={() => setBusquedaCursos('')}
                      >
                        ‚úï Limpiar b√∫squeda
                      </button>
                    </div>
                  )}
                </div>
              </div>
            )}
            
            {/* CONTENEDOR PRINCIPAL DE SESI√ìN */}
            <div className={`sesion-estudio-container ${selectorCursosAbierto ? 'con-selector' : ''}`}>
              {/* Header fijo con cron√≥metro (ANTIGUO - AHORA REEMPLAZADO POR HEADER SUPERIOR) */}
              <div className="sesion-header-fixed oculto">{/* Mantener por compatibilidad pero ocultar */}
              <div className="sesion-info">
                <div className="sesion-fase-actual">
                  <span className="fase-emoji">{fasesSesion[indiceFaseActual]?.emoji}</span>
                  <div className="fase-detalles">
                    <span className="fase-label">Fase {indiceFaseActual + 1} de {fasesSesion.length}</span>
                    <h2 className="fase-nombre">{fasesSesion[indiceFaseActual]?.nombre}</h2>
                  </div>
                </div>
                
                <div className="sesion-cronometro">
                  <div className="cronometro-circular">
                    <svg className="progreso-circular" viewBox="0 0 120 120">
                      <circle
                        cx="60"
                        cy="60"
                        r="54"
                        fill="none"
                        stroke="rgba(100, 108, 255, 0.1)"
                        strokeWidth="6"
                      />
                      <circle
                        cx="60"
                        cy="60"
                        r="54"
                        fill="none"
                        stroke="#646cff"
                        strokeWidth="6"
                        strokeLinecap="round"
                        strokeDasharray={`${(tiempoRestante / tiempoFaseActual) * 339.3} 339.3`}
                        transform="rotate(-90 60 60)"
                        style={{transition: 'stroke-dasharray 0.5s linear'}}
                      />
                    </svg>
                    <div className="tiempo-texto">
                      <span className="minutos">{Math.floor(tiempoRestante / 60)}</span>
                      <span className="separador">:</span>
                      <span className="segundos">{String(tiempoRestante % 60).padStart(2, '0')}</span>
                    </div>
                  </div>
                  
                  <div className="cronometro-progreso-fases">
                    {fasesSesion.map((fase, idx) => (
                      <div 
                        key={idx}
                        className={`fase-punto ${idx === indiceFaseActual ? 'activa' : idx < indiceFaseActual ? 'completada' : ''}`}
                        title={fase.nombre}
                      >
                        {idx < indiceFaseActual ? '‚úì' : fase.emoji}
                      </div>
                    ))}
                  </div>
                </div>

                <div className="sesion-controles">
                  <button 
                    className="btn-control"
                    onClick={pausarReanudarSesion}
                    title={sesionPausada ? 'Reanudar' : 'Pausar'}
                  >
                    {sesionPausada ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'}
                  </button>
                  <button 
                    className="btn-control btn-salir"
                    onClick={salirSesion}
                    title="Salir de la sesi√≥n"
                  >
                    ‚ùå
                  </button>
                </div>
              </div>
            </div>

            {/* Contenido din√°mico seg√∫n la fase */}
            <div className="sesion-contenido">
              {/* FASE: CALENTAMIENTO */}
              {faseActual === 'calentamiento' && (
                <div className="fase-calentamiento">
                  {/* Bloque central destacado - Hoy trabajaremos en */}
                  <div className="calentamiento-highlight">
                    <div className="highlight-header">
                      <h2>üéØ HOY TRABAJAREMOS EN</h2>
                    </div>
                    <div className="highlight-content">
                      <h3 className="curso-destacado">
                        üìö {rutaCalentamientoActual || rutaActual || 'Selecciona tu carpeta de trabajo'}
                      </h3>
                      <div className="contexto-sesion">
                        <div className="contexto-item">
                          <span className="contexto-icon">üìä</span>
                          <span className="contexto-label">Contexto:</span>
                        </div>
                        <ul className="contexto-lista">
                          {erroresActuales.length > 0 && (
                            <li>‚Ä¢ {erroresActuales.length} {erroresActuales.length === 1 ? 'error pendiente' : 'errores pendientes'} en este tema</li>
                          )}
                          {flashcardsSesion.length > 0 && (
                            <li>‚Ä¢ {flashcardsSesion.length} {flashcardsSesion.length === 1 ? 'flashcard lista' : 'flashcards listas'} para repasar</li>
                          )}
                          {datosCalentamiento?.ultimosExamenes?.length > 0 && (
                            <li>‚Ä¢ √öltimo estudio: {(() => {
                              const ultimoExamen = datosCalentamiento.ultimosExamenes[0];
                              const fecha = new Date(ultimoExamen.fecha);
                              const ahora = new Date();
                              const diffDias = Math.floor((ahora - fecha) / (1000 * 60 * 60 * 24));
                              return diffDias === 0 ? 'hoy' : diffDias === 1 ? 'ayer' : `hace ${diffDias} d√≠as`;
                            })()}</li>
                          )}
                        </ul>
                        <div className="prioridad-badge">
                          <span className="badge-icon">
                            {prioridadSesion === 'errores' ? 'üî•' : 
                             prioridadSesion === 'flashcards' ? 'üÉè' : 'üìö'}
                          </span>
                          <span className="badge-text">
                            Prioridad: {prioridadSesion === 'errores' ? 'Reforzar Errores' : 
                                       prioridadSesion === 'flashcards' ? 'Repaso de Flashcards' : 
                                       'Contenido Nuevo'}
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Grid de contexto */}
                  <div className="calentamiento-grid">
                    {/* Cursos recientes */}
                    <div className="context-card">
                      <div className="card-header">
                        <h3>üìñ Cursos Recientes</h3>
                      </div>
                      <div className="card-content">
                        {cursosRecientes.length > 0 ? (
                          <div className="cursos-lista">
                            {cursosRecientes.slice(0, 3).map((curso, idx) => (
                              <div key={idx} className="curso-item">
                                <div className="curso-info">
                                  <span className="curso-icon">üìö</span>
                                  <span className="curso-nombre">{curso.nombre}</span>
                                </div>
                                <span className="curso-fecha">
                                  {(() => {
                                    const fecha = new Date(curso.fecha);
                                    const ahora = new Date();
                                    const diffDias = Math.floor((ahora - fecha) / (1000 * 60 * 60 * 24));
                                    return diffDias === 0 ? 'Hoy' : diffDias === 1 ? 'Ayer' : `${diffDias}d`;
                                  })()}
                                </span>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <p className="no-data">No hay cursos recientes</p>
                        )}
                      </div>
                    </div>

                    {/* √öltimo examen */}
                    <div className="context-card">
                      <div className="card-header">
                        <h3>üìù √öltimo Examen</h3>
                      </div>
                      <div className="card-content">
                        {datosCalentamiento?.ultimosExamenes?.length > 0 ? (
                          (() => {
                            const examen = datosCalentamiento.ultimosExamenes[0];
                            return (
                              <div className="examen-detalle">
                                <h4 className="examen-titulo">{examen.carpeta_nombre || 'Examen'}</h4>
                                <div className="examen-nota-grande">
                                  <span className="nota-valor">{examen.porcentaje.toFixed(1)}</span>
                                  <span className="nota-simbolo">%</span>
                                </div>
                                <div className="examen-fecha">
                                  üìÖ {(() => {
                                    const fecha = new Date(examen.fecha);
                                    const diffDias = Math.floor((new Date() - fecha) / (1000 * 60 * 60 * 24));
                                    return diffDias === 0 ? 'Hoy' : diffDias === 1 ? 'Ayer' : `Hace ${diffDias} d√≠as`;
                                  })()}
                                </div>
                                <div className="examen-stats">
                                  <div className="stat-item">
                                    <span className="stat-icon">‚úÖ</span>
                                    <span className="stat-valor">{examen.aciertos || 0}</span>
                                  </div>
                                  <div className="stat-item">
                                    <span className="stat-icon">‚ùå</span>
                                    <span className="stat-valor">{examen.errores || 0}</span>
                                  </div>
                                </div>
                              </div>
                            );
                          })()
                        ) : (
                          <p className="no-data">No hay ex√°menes previos</p>
                        )}
                      </div>
                    </div>

                    {/* Estad√≠sticas r√°pidas */}
                    <div className="context-card stats-card">
                      <div className="card-header">
                        <h3>üìä Tu Semana de Estudio</h3>
                      </div>
                      <div className="card-content">
                        <div className="stats-grid">
                          <div className="stat-box">
                            <div className="stat-icon-large">‚è±Ô∏è</div>
                            <div className="stat-info">
                              <span className="stat-label">Tiempo total</span>
                              <span className="stat-value">
                                {Math.floor(tiempoTotalEfectivo / 3600)}h {Math.floor((tiempoTotalEfectivo % 3600) / 60)}m
                              </span>
                            </div>
                          </div>
                          <div className="stat-box">
                            <div className="stat-icon-large">üÉè</div>
                            <div className="stat-info">
                              <span className="stat-label">Flashcards</span>
                              <span className="stat-value">{estadisticasSesion.flashcardsRepasadas}</span>
                            </div>
                          </div>
                          <div className="stat-box">
                            <div className="stat-icon-large">üéØ</div>
                            <div className="stat-info">
                              <span className="stat-label">Errores reforzados</span>
                              <span className="stat-value">{estadisticasSesion.erroresReforzados}</span>
                            </div>
                          </div>
                          <div className="stat-box">
                            <div className="stat-icon-large">‚úÖ</div>
                            <div className="stat-info">
                              <span className="stat-label">Pr√°cticas hechas</span>
                              <span className="stat-value">{estadisticasSesion.practicasHechas}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Explorador de carpetas - Compacto */}
                  <div className="calentamiento-highlight calentamiento-highlight-compacto">
                    <div className="highlight-header">
                      <h2>üìÅ Selecciona tu Carpeta</h2>
                    </div>
                    
                    <div className="explorador-carpetas-calentamiento">
                      {/* Breadcrumb navigation */}
                      <div className="breadcrumb-explorador">
                        <button 
                          onClick={() => cargarCarpetasCalentamiento('')}
                          className="breadcrumb-btn-explorador"
                        >
                          üè† Inicio
                        </button>
                        {rutaCalentamientoActual && rutaCalentamientoActual.split('\\').filter(Boolean).map((parte, idx, arr) => {
                          const rutaParcial = arr.slice(0, idx + 1).join('\\');
                          return (
                            <span key={idx}>
                              <span className="breadcrumb-separador">/</span>
                              <button 
                                onClick={() => cargarCarpetasCalentamiento(rutaParcial)}
                                className="breadcrumb-btn-explorador"
                              >
                                {parte}
                              </button>
                            </span>
                          );
                        })}
                      </div>

                      {/* Controles de navegaci√≥n */}
                      <div className="explorador-controles">
                        <button
                          className="btn-explorador btn-volver"
                          onClick={() => {
                            if (rutaCalentamientoActual) {
                              const partes = rutaCalentamientoActual.split('\\');
                              partes.pop();
                              const rutaPadre = partes.join('\\');
                              cargarCarpetasCalentamiento(rutaPadre);
                            }
                          }}
                          disabled={!rutaCalentamientoActual}
                        >
                          ‚¨ÖÔ∏è Volver Atr√°s
                        </button>
                        
                        <button
                          className="btn-explorador btn-nueva-carpeta"
                          onClick={() => setModalNuevaCarpetaCalentamiento(true)}
                        >
                          ‚ûï Nueva Carpeta
                        </button>
                      </div>

                      {/* Carpeta actual seleccionada */}
                      <div className="carpeta-seleccionada-info">
                        <div className="info-icon">üìÇ</div>
                        <div className="info-texto">
                          <span className="info-label">Carpeta seleccionada:</span>
                          <span className="info-valor">{rutaCalentamientoActual || 'Ra√≠z'}</span>
                        </div>
                      </div>

                      {/* Lista de carpetas */}
                      <div className="carpetas-grid">
                        {carpetasCalentamiento.length > 0 ? (
                          carpetasCalentamiento.map((carpeta, idx) => (
                            <button
                              key={idx}
                              className="carpeta-card"
                              onClick={() => {
                                const nuevaRuta = rutaCalentamientoActual 
                                  ? `${rutaCalentamientoActual}\\${carpeta.nombre}`
                                  : carpeta.nombre;
                                cargarCarpetasCalentamiento(nuevaRuta);
                              }}
                            >
                              <div className="carpeta-icono">üìÅ</div>
                              <div className="carpeta-nombre">{carpeta.nombre}</div>
                              <div className="carpeta-info">
                                {carpeta.archivos > 0 && (
                                  <span className="carpeta-stat">üìÑ {carpeta.archivos}</span>
                                )}
                              </div>
                            </button>
                          ))
                        ) : (
                          <div className="carpetas-vacio">
                            <p className="vacio-icon">üì≠</p>
                            <p className="vacio-texto">No hay subcarpetas aqu√≠</p>
                            <p className="vacio-hint">Puedes crear una nueva carpeta con el bot√≥n de arriba</p>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Bot√≥n de continuar */}
                  <div className="calentamiento-footer">
                    <button 
                      className="btn-continuar-fase"
                      onClick={() => {
                        // Guardar la carpeta seleccionada si hay una
                        if (rutaCalentamientoActual) {
                          setRutaActual(rutaCalentamientoActual);
                          setCursoActual({
                            ...cursoActual,
                            carpeta_trabajo: rutaCalentamientoActual
                          });
                        }
                        avanzarFase();
                      }}
                    >
                      <span className="btn-icon">‚úÖ</span>
                      <span className="btn-text">Listo, Continuar</span>
                      <span className="btn-arrow">‚Üí</span>
                    </button>
                  </div>
                </div>
              )}

              {/* FASE: REFUERZO DE ERRORES */}
              {faseActual === 'errores' && (
                <div className="fase-errores">
                  {erroresActuales.length > 0 ? (
                    <>
                      {/* Header de la fase */}
                      <div className="errores-header">
                        <div className="errores-title">
                          <h2>üéØ Corrigiendo Errores Clave</h2>
                          <p>Refuerza los conceptos que necesitas dominar</p>
                        </div>
                        <div className="errores-progreso-numerico">
                          <span className="progreso-actual">{indiceErrorActual + 1}</span>
                          <span className="progreso-separador">/</span>
                          <span className="progreso-total">{erroresActuales.length}</span>
                        </div>
                      </div>

                      {/* Barra de progreso visual */}
                      <div className="errores-progress-bar">
                        <div 
                          className="progress-fill"
                          style={{width: `${((indiceErrorActual + 1) / erroresActuales.length) * 100}%`}}
                        >
                          <span className="progress-text">
                            {Math.round(((indiceErrorActual + 1) / erroresActuales.length) * 100)}%
                          </span>
                        </div>
                      </div>

                      {/* Tarjeta de pregunta */}
                      <div className="error-wizard-card">
                        {/* Tags del curso/tema */}
                        <div className="error-tags">
                          <span className="tag tag-curso">
                            üìö {erroresActuales[indiceErrorActual]?.carpeta || 'General'}
                          </span>
                          <span className="tag tag-rendimiento">
                            üìä {erroresActuales[indiceErrorActual]?.porcentaje_obtenido?.toFixed(0) || erroresActuales[indiceErrorActual]?.porcentaje?.toFixed(0) || 0}%
                          </span>
                          {erroresActuales[indiceErrorActual]?.proximaRevision && (
                            <span className="tag tag-proxima-revision" title="Pr√≥xima revisi√≥n programada">
                              üîÑ {new Date(erroresActuales[indiceErrorActual].proximaRevision).toLocaleDateString('es-ES', { 
                                day: 'numeric', 
                                month: 'short',
                                hour: '2-digit',
                                minute: '2-digit'
                              })}
                            </span>
                          )}
                        </div>

                        {/* Pregunta */}
                        <div className="error-question">
                          <div className="question-header">
                            <span className="question-badge">Pregunta {indiceErrorActual + 1}</span>
                          </div>
                          <h3 className="question-text">
                            {erroresActuales[indiceErrorActual]?.pregunta}
                          </h3>
                        </div>

                        {/* Opciones si existen (preguntas tipo multiple) */}
                        {erroresActuales[indiceErrorActual]?.opciones?.length > 0 && (
                          <div className="error-opciones">
                            <h4 className="opciones-label">
                              {errorYaRespondido ? 'Tu respuesta:' : 'üéØ Intenta responder correctamente:'}
                            </h4>
                            <div className="opciones-grid">
                              {erroresActuales[indiceErrorActual].opciones.map((opcion, idx) => {
                                const esRespuestaOriginal = opcion.startsWith(erroresActuales[indiceErrorActual].respuesta_usuario);
                                const esRespuestaCorrecta = opcion.startsWith(erroresActuales[indiceErrorActual].respuesta_correcta);
                                const esSeleccionada = respuestaErrorSeleccionada && opcion === respuestaErrorSeleccionada;
                                
                                let claseOpcion = 'opcion-item';
                                if (errorYaRespondido) {
                                  // Ya respondi√≥: mostrar correcta en verde, incorrecta en rojo
                                  if (esRespuestaCorrecta) {
                                    claseOpcion += ' correcta';
                                  } else if (esSeleccionada && !esRespuestaCorrecta) {
                                    claseOpcion += ' incorrecta';
                                  }
                                } else {
                                  // No ha respondido: hacer clickeable
                                  claseOpcion += ' clickeable';
                                  if (esRespuestaOriginal) {
                                    claseOpcion += ' tu-error-anterior'; // Estilo suave para mostrar su error anterior
                                  }
                                }
                                
                                return (
                                  <div 
                                    key={idx}
                                    className={claseOpcion}
                                    onClick={() => !errorYaRespondido && seleccionarRespuestaError(opcion)}
                                    style={{ cursor: errorYaRespondido ? 'default' : 'pointer' }}
                                  >
                                    <span className="opcion-letra">{String.fromCharCode(65 + idx)}</span>
                                    <span className="opcion-texto">{opcion}</span>
                                    {errorYaRespondido && esRespuestaCorrecta && (
                                      <span className="opcion-icon">‚úì</span>
                                    )}
                                    {errorYaRespondido && esSeleccionada && !esRespuestaCorrecta && (
                                      <span className="opcion-icon">‚úó</span>
                                    )}
                                    {!errorYaRespondido && esRespuestaOriginal && (
                                      <span className="opcion-hint" title="Esta fue tu respuesta anterior">‚ö†Ô∏è</span>
                                    )}
                                  </div>
                                );
                              })}
                            </div>
                            {!errorYaRespondido && (
                              <p className="opciones-instruccion">
                                üí° Haz clic en la opci√≥n que crees correcta
                              </p>
                            )}
                          </div>
                        )}

                        {/* üî• NUEVO: Input para respuestas cortas/casos (cuando no hay opciones) */}
                        {(!erroresActuales[indiceErrorActual]?.opciones || erroresActuales[indiceErrorActual]?.opciones.length === 0) && (
                          <div className="error-respuesta-textual">
                            <h4 className="respuesta-textual-label">
                              {errorYaRespondido ? 'Tu respuesta final:' : '‚úçÔ∏è Escribe tu respuesta:'}
                            </h4>
                            
                            {/* Mostrar respuesta original del examen */}
                            {!errorYaRespondido && erroresActuales[indiceErrorActual]?.respuesta_usuario && (
                              <div className="respuesta-original-error">
                                <h5>üìù Tu respuesta original en el examen:</h5>
                                <div className="respuesta-original-contenido">
                                  {erroresActuales[indiceErrorActual].respuesta_usuario}
                                </div>
                                <p className="respuesta-original-hint">
                                  üí° Esta respuesta obtuvo {erroresActuales[indiceErrorActual].porcentaje_obtenido?.toFixed(0)}%. Intenta mejorarla abajo.
                                </p>
                              </div>
                            )}
                            
                            {/* Historial de intentos */}
                            {historialIntentos.length > 0 && (
                              <div className="historial-intentos">
                                <h5>üìä Intentos anteriores:</h5>
                                {historialIntentos.map((intento, idx) => (
                                  <div key={idx} className="intento-card">
                                    <div className="intento-header">
                                      <span className="intento-numero">Intento {idx + 1}</span>
                                      <span className={`intento-puntaje ${intento.puntaje >= 70 ? 'aprobado' : 'pendiente'}`}>
                                        {intento.puntaje}/100
                                      </span>
                                    </div>
                                    <p className="intento-respuesta">"{intento.respuesta}"</p>
                                    <div className="intento-feedback">{intento.feedback}</div>
                                  </div>
                                ))}
                              </div>
                            )}

                            {/* Campo de texto para responder */}
                            {!errorYaRespondido && (
                              <div className="respuesta-textual-input-container">
                                <textarea
                                  className="respuesta-textual-input"
                                  placeholder="Escribe tu respuesta aqu√≠... El modelo te dar√° retroalimentaci√≥n para perfeccionarla."
                                  rows="5"
                                  value={respuestaTextual}
                                  onChange={(e) => setRespuestaTextual(e.target.value)}
                                  disabled={evaluandoRespuesta}
                                />
                                <button 
                                  className="btn-evaluar-respuesta"
                                  onClick={evaluarRespuestaTextual}
                                  disabled={evaluandoRespuesta || !respuestaTextual.trim()}
                                >
                                  {evaluandoRespuesta ? (
                                    <>
                                      <span className="spinner">‚è≥</span>
                                      <span>Evaluando con IA...</span>
                                    </>
                                  ) : (
                                    <>
                                      <span className="btn-icon">ü§ñ</span>
                                      <span>Evaluar Respuesta</span>
                                    </>
                                  )}
                                </button>
                                <p className="respuesta-textual-hint">
                                  üí° El modelo comparar√° tu respuesta con la correcta y te guiar√° para mejorarla
                                </p>
                              </div>
                            )}

                            {/* Feedback actual de la IA */}
                            {feedbackIA && (
                              <div className={`feedback-ia ${feedbackIA.esSuficiente ? 'aprobado' : 'mejorable'}`}>
                                <div className="feedback-ia-header">
                                  <span className="feedback-ia-icon">
                                    {feedbackIA.esSuficiente ? 'üéâ' : 'üí™'}
                                  </span>
                                  <span className="feedback-ia-puntaje">
                                    Puntaje: {feedbackIA.puntaje}/100
                                  </span>
                                </div>
                                <div className="feedback-ia-contenido">
                                  {feedbackIA.texto.split('\n').map((linea, idx) => (
                                    <p key={idx}>{linea}</p>
                                  ))}
                                </div>
                                {feedbackIA.esSuficiente && (
                                  <p className="feedback-ia-exito">
                                    ‚úÖ ¬°Excelente! Tu respuesta es suficientemente buena. Puedes continuar.
                                  </p>
                                )}
                                {!feedbackIA.esSuficiente && (
                                  <p className="feedback-ia-mejora">
                                    üìù Intenta nuevamente incorporando las sugerencias anteriores
                                  </p>
                                )}
                              </div>
                            )}
                          </div>
                        )}

                        {/* Comparaci√≥n de respuestas - SOLO SI YA RESPONDI√ì */}
                        {errorYaRespondido && (
                          <div className="error-comparison">
                            <div className="comparison-grid">
                              <div className="comparison-card user-answer">
                                <div className="card-icon">
                                  {respuestaErrorSeleccionada && respuestaErrorSeleccionada.startsWith(erroresActuales[indiceErrorActual].respuesta_correcta) ? '‚úÖ' : '‚ùå'}
                                </div>
                                <h4>Tu respuesta:</h4>
                                <p className="answer-text">
                                  {respuestaErrorSeleccionada || 'Sin respuesta'}
                                </p>
                              </div>
                              
                              <div className="comparison-arrow">‚Üí</div>
                              
                              <div className="comparison-card correct-answer">
                                <div className="card-icon">‚úÖ</div>
                                <h4>Respuesta correcta:</h4>
                                <p className="answer-text">
                                  {erroresActuales[indiceErrorActual]?.respuesta_correcta}
                                </p>
                              </div>
                            </div>
                            
                            {/* Mostrar mensaje de feedback */}
                            {respuestaErrorSeleccionada && (
                              <div className={`feedback-message ${respuestaErrorSeleccionada.startsWith(erroresActuales[indiceErrorActual].respuesta_correcta) ? 'correcto' : 'incorrecto'}`}>
                                {respuestaErrorSeleccionada.startsWith(erroresActuales[indiceErrorActual].respuesta_correcta) ? (
                                  <>
                                    <span className="feedback-icon">üéâ</span>
                                    <p><strong>¬°Excelente!</strong> Has corregido tu error. Esta respuesta se actualizar√° en tu examen/pr√°ctica original.</p>
                                  </>
                                ) : (
                                  <>
                                    <span className="feedback-icon">üí™</span>
                                    <p><strong>Sigue intentando.</strong> La respuesta correcta se mostrar√° arriba. Este error se programar√° para revisi√≥n ma√±ana.</p>
                                  </>
                                )}
                              </div>
                            )}
                          </div>
                        )}

                        {/* Explicaci√≥n */}
                        {erroresActuales[indiceErrorActual]?.feedback && (
                          <div className="error-explanation">
                            <div className="explanation-header">
                              <span className="explanation-icon">üí°</span>
                              <h4>Explicaci√≥n</h4>
                            </div>
                            <div className="explanation-content">
                              <p>{erroresActuales[indiceErrorActual].feedback}</p>
                            </div>
                          </div>
                        )}

                        {/* Notas del usuario */}
                        <div className="error-notes">
                          <label className="notes-label">
                            üìù Tus notas (opcional):
                          </label>
                          <textarea
                            className="notes-textarea"
                            placeholder="Escribe lo que aprendiste de este error..."
                            rows="3"
                            value={notaSesion}
                            onChange={(e) => setNotaSesion(e.target.value)}
                          />
                        </div>
                      </div>

                      {/* Acciones */}
                      <div className="error-actions">
                        <button 
                          className="btn-action btn-skip"
                          onClick={() => {
                            setNotaSesion('');
                            setRespuestaErrorSeleccionada(null);
                            setErrorYaRespondido(false);
                            setRespuestaTextual('');
                            setHistorialIntentos([]);
                            setFeedbackIA(null);
                            if (indiceErrorActual < erroresActuales.length - 1) {
                              setIndiceErrorActual(indiceErrorActual + 1);
                            } else {
                              avanzarFase();
                            }
                          }}
                        >
                          <span className="btn-icon">‚è≠Ô∏è</span>
                          <span>Saltar</span>
                        </button>

                        <button 
                          className="btn-action btn-understood"
                          onClick={marcarErrorComprendido}
                          disabled={!errorYaRespondido}
                          style={{
                            opacity: errorYaRespondido ? 1 : 0.5,
                            cursor: errorYaRespondido ? 'pointer' : 'not-allowed'
                          }}
                          title={!errorYaRespondido ? 'Primero selecciona una respuesta' : ''}
                        >
                          <span className="btn-icon">‚úÖ</span>
                          <span>{errorYaRespondido ? 'Siguiente' : 'Selecciona una respuesta primero'}</span>
                        </button>

                        <button 
                          className="btn-action btn-need-practice"
                          onClick={() => {
                            setEstadisticasSesion(prev => ({
                              ...prev,
                              erroresReforzados: prev.erroresReforzados + 1
                            }));
                            setNotaSesion('');
                            setRespuestaErrorSeleccionada(null);
                            setErrorYaRespondido(false);
                            setRespuestaTextual('');
                            setHistorialIntentos([]);
                            setFeedbackIA(null);
                            if (indiceErrorActual < erroresActuales.length - 1) {
                              setIndiceErrorActual(indiceErrorActual + 1);
                            } else {
                              avanzarFase();
                            }
                          }}
                        >
                          <span className="btn-icon">üîÑ</span>
                          <span>Necesito Practicar M√°s</span>
                        </button>
                      </div>

                      {/* Indicador de errores restantes */}
                      <div className="errores-footer">
                        <div className="errores-dots">
                          {erroresActuales.map((_, idx) => (
                            <div
                              key={idx}
                              className={`error-dot ${
                                idx < indiceErrorActual ? 'completed' : 
                                idx === indiceErrorActual ? 'active' : 'pending'
                              }`}
                              title={`Error ${idx + 1}`}
                            />
                          ))}
                        </div>
                        <p className="errores-mensaje">
                          {indiceErrorActual === erroresActuales.length - 1 
                            ? '¬°√öltimo error! üéâ' 
                            : `Quedan ${erroresActuales.length - indiceErrorActual - 1} errores por revisar`}
                        </p>
                      </div>
                    </>
                  ) : (
                    <div className="no-errores">
                      <div className="no-errores-icon">üéâ</div>
                      <h2>¬°No hay errores pendientes!</h2>
                      <p>Has dominado todo el material reciente</p>
                      <button className="btn-continuar" onClick={avanzarFase}>
                        Continuar a la siguiente fase ‚Üí
                      </button>
                    </div>
                  )}
                </div>
              )}

              {/* FASE: FLASHCARDS - SPACED REPETITION */}
              {faseActual === 'flashcards' && (
                <div className="fase-flashcards">
                  {flashcardsSesion.length > 0 ? (
                    <>
                      {/* Header de la fase */}
                      <div className="flashcards-header">
                        <div className="flashcards-title">
                          <h2>üÉè Repaso de Memoria (Flashcards)</h2>
                          <p>Mant√©n vivo lo que ya aprendiste</p>
                        </div>
                        <div className="flashcards-progreso-numerico">
                          <span className="progreso-actual">{indiceFlashcardActual + 1}</span>
                          <span className="progreso-separador">/</span>
                          <span className="progreso-total">{flashcardsSesion.length}</span>
                        </div>
                      </div>
                      
                      {/* Botones de Acceso R√°pido */}
                      <div className="accesos-rapidos-fase">
                        <div className="accesos-rapidos-titulo">
                          <span>üîó Accesos R√°pidos</span>
                          {flashcardsSesion[indiceFlashcardActual]?.carpeta ? (
                            <span className="carpeta-actual">üìÅ {flashcardsSesion[indiceFlashcardActual].carpeta}</span>
                          ) : (
                            <span className="carpeta-actual">üìÅ Ra√≠z</span>
                          )}
                        </div>
                        <div className="accesos-rapidos-botones">
                          <button
                            className="btn-acceso-rapido btn-cursos"
                            onClick={() => {
                              const carpeta = flashcardsSesion[indiceFlashcardActual]?.carpeta || '';
                              setRutaActual(carpeta);
                              setSelectedMenu('cursos');
                              cargarCarpeta(carpeta);
                            }}
                            title="Ver documentos en esta carpeta"
                          >
                            üìö Ver en Mis Cursos
                          </button>
                          <button
                            className="btn-acceso-rapido btn-notas"
                            onClick={() => {
                              const carpeta = flashcardsSesion[indiceFlashcardActual]?.carpeta || '';
                              setRutaNotasActual(carpeta);
                              setSelectedMenu('notas');
                              cargarCarpetasNotas(carpeta);
                            }}
                            title="Ver notas de esta carpeta"
                          >
                            üìù Ver Notas
                          </button>
                          <button
                            className="btn-acceso-rapido btn-flashcards"
                            onClick={() => {
                              const carpeta = flashcardsSesion[indiceFlashcardActual]?.carpeta || '';
                              setRutaFlashcardsActual(carpeta);
                              setCarpetaFlashcardActual({ ruta: carpeta });
                              setSelectedMenu('flashcards');
                              cargarCarpetasFlashcards(carpeta);
                            }}
                            title="Ver todas las flashcards de esta carpeta"
                          >
                            üé¥ Ver Flashcards
                          </button>
                        </div>
                      </div>

                      {/* Barra de progreso */}
                      <div className="flashcards-progress-bar">
                        <div 
                          className="progress-fill-flashcards"
                          style={{width: `${((indiceFlashcardActual + 1) / flashcardsSesion.length) * 100}%`}}
                        >
                          <span className="progress-text">
                            {Math.round(((indiceFlashcardActual + 1) / flashcardsSesion.length) * 100)}%
                          </span>
                        </div>
                      </div>

                      {/* Tags de contexto */}
                      <div className="flashcard-context">
                        <div className="flashcard-tags">
                          {flashcardsSesion[indiceFlashcardActual]?.tema && (
                            <span className="tag tag-tema-fc">
                              üè∑Ô∏è {flashcardsSesion[indiceFlashcardActual].tema}
                            </span>
                          )}
                          {flashcardsSesion[indiceFlashcardActual]?.tipo && (
                            <span className="tag tag-tipo-fc">
                              üìã {flashcardsSesion[indiceFlashcardActual].tipo}
                            </span>
                          )}
                        </div>
                      </div>

                      {/* Tarjeta tipo Anki */}
                      <div className="flashcard-anki-container">
                        <div 
                          className={`flashcard-anki ${flashcardsVolteadas[indiceFlashcardActual] ? 'flipped' : ''}`}
                          onClick={() => {
                            if (!flashcardsVolteadas[indiceFlashcardActual]) {
                              setFlashcardsVolteadas({...flashcardsVolteadas, [indiceFlashcardActual]: true});
                            }
                          }}
                        >
                          {/* Cara Frontal */}
                          <div className="flashcard-face flashcard-front">
                            <div className="flashcard-label">Pregunta</div>
                            <div className="flashcard-content-main">
                              <h3>{flashcardsSesion[indiceFlashcardActual]?.titulo || 
                                   flashcardsSesion[indiceFlashcardActual]?.frente || 
                                   'Flashcard'}</h3>
                            </div>
                            {!flashcardsVolteadas[indiceFlashcardActual] && (
                              <div className="flashcard-hint">
                                <span className="hint-icon">üëÜ</span>
                                <span className="hint-text">Click para ver la respuesta</span>
                              </div>
                            )}
                          </div>

                          {/* Cara Trasera */}
                          <div className="flashcard-face flashcard-back">
                            <div className="flashcard-label">Respuesta</div>
                            <div className="flashcard-content-main">
                              <div className="flashcard-answer">
                                {flashcardsSesion[indiceFlashcardActual]?.contenido || 
                                 flashcardsSesion[indiceFlashcardActual]?.reverso || 
                                 'Contenido de la flashcard'}
                              </div>
                            </div>
                            {flashcardsSesion[indiceFlashcardActual]?.explicacion && (
                              <div className="flashcard-extra-info">
                                <p><strong>üí° Explicaci√≥n:</strong> {flashcardsSesion[indiceFlashcardActual].explicacion}</p>
                              </div>
                            )}
                          </div>
                        </div>
                      </div>

                      {/* Botones de evaluaci√≥n (solo cuando est√° volteada) */}
                      {flashcardsVolteadas[indiceFlashcardActual] ? (
                        <div className="flashcard-evaluation">
                          <p className="evaluation-question">¬øQu√© tan bien recordaste esto?</p>
                          <div className="evaluation-buttons">
                            <button 
                              className="btn-evaluation btn-forgot"
                              onClick={() => evaluarFlashcard('dificil')}
                              title="Reiniciar ciclo - Ver√°s esta tarjeta pronto"
                            >
                              <div className="btn-eval-icon">üò∞</div>
                              <div className="btn-eval-text">
                                <span className="btn-eval-title">Lo Olvid√©</span>
                                <span className="btn-eval-subtitle">Revisar pronto</span>
                              </div>
                            </button>
                            
                            <button 
                              className="btn-evaluation btn-hard"
                              onClick={() => evaluarFlashcard('medio')}
                              title="Intervalo medio - Revisar en unos d√≠as"
                            >
                              <div className="btn-eval-icon">ü§î</div>
                              <div className="btn-eval-text">
                                <span className="btn-eval-title">Me Cost√≥</span>
                                <span className="btn-eval-subtitle">Intervalo medio</span>
                              </div>
                            </button>
                            
                            <button 
                              className="btn-evaluation btn-easy"
                              onClick={() => evaluarFlashcard('facil')}
                              title="Intervalo largo - Revisar en m√°s tiempo"
                            >
                              <div className="btn-eval-icon">üòé</div>
                              <div className="btn-eval-text">
                                <span className="btn-eval-title">Lo Record√© F√°cil</span>
                                <span className="btn-eval-subtitle">Intervalo largo</span>
                              </div>
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="flashcard-waiting">
                          <p className="waiting-message">
                            <span className="waiting-icon">üí≠</span>
                            Piensa en la respuesta antes de voltear la tarjeta
                          </p>
                        </div>
                      )}

                      {/* Footer con indicadores */}
                      <div className="flashcards-footer">
                        <div className="flashcards-dots">
                          {flashcardsSesion.map((_, idx) => (
                            <div
                              key={idx}
                              className={`flashcard-dot ${
                                idx < indiceFlashcardActual ? 'reviewed' : 
                                idx === indiceFlashcardActual ? 'current' : 'pending'
                              }`}
                              title={`Flashcard ${idx + 1}`}
                            />
                          ))}
                        </div>
                        <p className="flashcards-mensaje">
                          {indiceFlashcardActual === flashcardsSesion.length - 1 
                            ? '¬°√öltima tarjeta! üéâ' 
                            : `Quedan ${flashcardsSesion.length - indiceFlashcardActual - 1} tarjetas`}
                        </p>
                      </div>

                      {/* Atajos de teclado (info) */}
                      <div className="flashcards-shortcuts">
                        <p className="shortcuts-title">‚å®Ô∏è Atajos:</p>
                        <div className="shortcuts-list">
                          <span className="shortcut"><kbd>Espacio</kbd> Voltear</span>
                          <span className="shortcut"><kbd>1</kbd> Olvid√©</span>
                          <span className="shortcut"><kbd>2</kbd> Me cost√≥</span>
                          <span className="shortcut"><kbd>3</kbd> F√°cil</span>
                        </div>
                      </div>
                    </>
                  ) : (
                    <div className="no-flashcards">
                      <div className="no-flashcards-icon">üìù</div>
                      <h2>No hay flashcards pendientes</h2>
                      <p>¬°Excelente! Todas tus flashcards est√°n al d√≠a</p>
                      <button className="btn-continuar" onClick={avanzarFase}>
                        Continuar a la siguiente fase ‚Üí
                      </button>
                    </div>
                  )}
                </div>
              )}

              {/* FASE 4: CONTENIDO NUEVO */}
              {faseActual === 'contenido' && (
                <div className="fase-contenido">
                  {/* Modal Selector de Carpetas */}
                  {mostrandoSelectorCarpetas && (
                    <>
                      <div className="modal-backdrop" onClick={() => setMostrandoSelectorCarpetas(false)}></div>
                      <div className="modal-selector-carpetas">
                        <div className="modal-header">
                          <h2>üìÅ Seleccionar Carpeta de Trabajo</h2>
                          <button 
                            className="btn-cerrar-modal"
                            onClick={() => setMostrandoSelectorCarpetas(false)}
                          >
                            ‚úï
                          </button>
                        </div>

                        {/* Navegaci√≥n */}
                        <div className="navegacion-carpetas">
                          {(rutaContenidoActual || navegacionHistorial.length > 0) && (
                            <button 
                              className="btn-volver-atras"
                              onClick={volverAtrasContenido}
                            >
                              ‚Üê Volver atr√°s
                            </button>
                          )}
                          <div className="ruta-actual">
                            üìÇ {rutaContenidoActual || 'Mis Cursos'}
                          </div>
                        </div>

                        {/* Lista de carpetas */}
                        <div className="lista-carpetas-selector">
                          {carpetasContenido.length > 0 ? (
                            carpetasContenido.map((carpeta, idx) => (
                              <div key={idx} className="carpeta-item-selector">
                                <button
                                  className="btn-navegar-carpeta"
                                  onClick={() => navegarACarpetaContenido(carpeta)}
                                >
                                  üìÅ {carpeta.nombre}
                                </button>
                                <button
                                  className="btn-seleccionar-carpeta"
                                  onClick={() => seleccionarCarpetaContenido(carpeta)}
                                >
                                  ‚úì Seleccionar
                                </button>
                              </div>
                            ))
                          ) : (
                            <div className="no-carpetas">
                              <p>No hay carpetas disponibles en esta ubicaci√≥n</p>
                            </div>
                          )}
                        </div>
                      </div>
                    </>
                  )}

                  {/* Tab 1: Notas R√°pidas - EDITOR ESTILO NOTION CON VISTA PREVIA */}
                  {tabContenidoActivo === 0 && (
                    <div className="tab-notas-contenido">
                      {/* Botones de Acceso R√°pido */}
                      <div className="accesos-rapidos-fase">
                        <div className="accesos-rapidos-titulo">
                          <span>üîó Accesos R√°pidos</span>
                          <span className="carpeta-actual">üìÅ {rutaNotasActual || 'Ra√≠z'}</span>
                        </div>
                        <div className="accesos-rapidos-botones">
                          <button
                            className="btn-acceso-rapido btn-cursos"
                            onClick={() => {
                              setRutaActual(rutaNotasActual || '');
                              setSelectedMenu('cursos');
                              cargarCarpeta(rutaNotasActual || '');
                            }}
                            title="Ver documentos en esta carpeta"
                          >
                            üìö Ver en Mis Cursos
                            </button>
                            <button
                              className="btn-acceso-rapido btn-notas"
                              onClick={() => {
                                setSelectedMenu('notas');
                                cargarCarpetasNotas(rutaNotasActual || '');
                              }}
                              title="Ver todas las notas de esta carpeta"
                            >
                              üìù Ver Todas las Notas
                            </button>
                            <button
                              className="btn-acceso-rapido btn-flashcards"
                              onClick={() => {
                                setRutaFlashcardsActual(rutaNotasActual || '');
                                setCarpetaFlashcardActual({ ruta: rutaNotasActual || '' });
                                setSelectedMenu('flashcards');
                                cargarCarpetasFlashcards(rutaNotasActual || '');
                              }}
                              title="Ver flashcards de esta carpeta"
                            >
                              üé¥ Ver Flashcards
                            </button>
                          </div>
                        </div>

                        {/* Sistema de Tabs */}
                        <div className="tabs-header-contenido">
                          <button 
                            className={`tab-button-contenido ${tabContenidoActivo === 0 ? 'activo' : ''}`}
                            onClick={() => setTabContenidoActivo(0)}
                          >
                            <span className="tab-icon">üìù</span>
                            <span className="tab-label">Notas</span>
                          </button>
                          <button 
                            className={`tab-button-contenido ${tabContenidoActivo === 1 ? 'activo' : ''}`}
                            onClick={() => setTabContenidoActivo(1)}
                          >
                            <span className="tab-icon">üé¥</span>
                            <span className="tab-label">Flashcards</span>
                          </button>
                        </div>
                        
                        <div className="notas-editor-notion-layout">
                          {/* Sidebar izquierdo - Selector de carpeta y opciones */}
                          <div className="editor-sidebar-izq">
                            <div className="sidebar-section">
                              <h4>üìÅ Destino</h4>
                              <div 
                                className="carpeta-selector"
                                onClick={() => {
                                  const carpeta = prompt('üìÅ Carpeta para guardar:\n(Ejemplo: Biologia/Unidad1)', rutaNotasActual || 'notas');
                                  if (carpeta !== null) {
                                    setRutaNotasActual(carpeta);
                                    setMensaje({
                                      tipo: 'info',
                                      texto: `üìÅ Carpeta: ${carpeta || 'notas'}`
                                    });
                                  }
                                }}
                              >
                                <span className="carpeta-icon">üìÇ</span>
                                <span className="carpeta-path">{rutaNotasActual || 'notas'}</span>
                                <span className="carpeta-edit">‚úèÔ∏è</span>
                              </div>
                            </div>
                            
                            <div className="sidebar-section">
                              <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                                <h4>üìÑ Notas</h4>
                                <button 
                                  className="btn-nueva-nota-mini"
                                  onClick={() => {
                                    setEditorNotaTitulo('');
                                    setEditorNotaContenido('');
                                    setEditorNotaTags('');
                                  }}
                                  style={{
                                    background: '#4CAF50',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '50%',
                                    width: '28px',
                                    height: '28px',
                                    cursor: 'pointer',
                                    fontSize: '1.2rem',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                  }}
                                  title="Nueva nota"
                                >
                                  +
                                </button>
                              </div>
                              <div className="lista-notas-sidebar" style={{maxHeight: '300px', overflowY: 'auto'}}>
                                {(notasGuardadas || [])
                                  .filter(nota => !rutaNotasActual || nota.carpeta === rutaNotasActual)
                                  .map(nota => (
                                    <div key={nota.id} className="nota-item-sidebar" style={{
                                      display: 'flex',
                                      justifyContent: 'space-between',
                                      alignItems: 'center',
                                      padding: '0.5rem',
                                      marginBottom: '0.3rem',
                                      background: 'rgba(51, 65, 85, 0.5)',
                                      borderRadius: '4px',
                                      cursor: 'pointer',
                                      border: '1px solid rgba(148, 163, 184, 0.2)',
                                      transition: 'all 0.2s'
                                    }}
                                    onMouseEnter={(e) => {
                                      e.currentTarget.style.background = 'rgba(71, 85, 105, 0.6)';
                                      e.currentTarget.style.borderColor = 'rgba(148, 163, 184, 0.4)';
                                    }}
                                    onMouseLeave={(e) => {
                                      e.currentTarget.style.background = 'rgba(51, 65, 85, 0.5)';
                                      e.currentTarget.style.borderColor = 'rgba(148, 163, 184, 0.2)';
                                    }}>
                                      <span 
                                        onClick={() => {
                                          setEditorNotaTitulo(nota.titulo);
                                          setEditorNotaContenido(nota.contenido);
                                          setEditorNotaTags(nota.tags?.join(', ') || '');
                                        }}
                                        style={{flex: 1, fontSize: '0.85rem', color: '#e2e8f0'}}
                                      >
                                        {nota.titulo || 'Sin t√≠tulo'}
                                      </span>
                                      <button
                                        onClick={(e) => {
                                          e.stopPropagation();
                                          if (window.confirm(`¬øEliminar "${nota.titulo}"?`)) {
                                            eliminarNota(nota.id);
                                          }
                                        }}
                                        style={{
                                          background: 'rgba(239, 68, 68, 0.9)',
                                          color: 'white',
                                          border: 'none',
                                          borderRadius: '4px',
                                          padding: '0.2rem 0.5rem',
                                          cursor: 'pointer',
                                          fontSize: '0.75rem'
                                        }}
                                      >
                                        üóëÔ∏è
                                      </button>
                                    </div>
                                  ))}
                                {((notasGuardadas || []).filter(nota => !rutaNotasActual || nota.carpeta === rutaNotasActual).length === 0) && (
                                  <p style={{fontSize: '0.85rem', color: '#94a3b8', textAlign: 'center'}}>
                                    No hay notas en esta carpeta
                                  </p>
                                )}
                              </div>
                            </div>
                            
                            <div className="sidebar-actions sidebar-actions-fixed">
                              <button 
                                className="btn-sidebar-action secondary"
                                onClick={() => {
                                  setEditorNotaTitulo('');
                                  setEditorNotaContenido('');
                                  setEditorNotaTags('');
                                }}
                              >
                                üóëÔ∏è Limpiar
                              </button>
                              
                              <button 
                                className="btn-sidebar-action primary"
                                onClick={() => {
                                  // Si no hay t√≠tulo, generar uno autom√°tico
                                  if (!editorNotaTitulo.trim()) {
                                    const tituloAuto = `nota_${new Date().toISOString().slice(0,19).replace(/[T:]/g, '_')}`;
                                    setEditorNotaTitulo(tituloAuto);
                                  }
                                  setTipoGuardado('txt');
                                  setRutaGuardadoActual(rutaNotasActual || rutaCalentamientoActual || '');
                                  cargarCarpetasGuardado(rutaNotasActual || rutaCalentamientoActual || '');
                                  setModalGuardarContenido(true);
                                }}
                              >
                                üìÑ Guardar TXT
                              </button>
                              
                              <button 
                                className="btn-sidebar-action primary"
                                onClick={() => {
                                  // Si no hay t√≠tulo, generar uno autom√°tico
                                  if (!editorNotaTitulo.trim()) {
                                    const tituloAuto = `nota_${new Date().toISOString().slice(0,19).replace(/[T:]/g, '_')}`;
                                    setEditorNotaTitulo(tituloAuto);
                                  }
                                  setTipoGuardado('nota');
                                  setRutaGuardadoActual(rutaNotasActual || rutaCalentamientoActual || '');
                                  cargarCarpetasGuardado(rutaNotasActual || rutaCalentamientoActual || '');
                                  setModalGuardarContenido(true);
                                }}
                              >
                                üìù Guardar Nota
                              </button>
                              
                              <button 
                                className="btn-sidebar-action generar-ejercicio"
                                onClick={async () => {
                                  if (!editorNotaContenido.trim()) {
                                    setMensaje({
                                      tipo: 'error',
                                      texto: '‚ö†Ô∏è No hay contenido para generar ejercicios'
                                    });
                                    return;
                                  }
                                  
                                  // Establecer la carpeta de trabajo para la pr√°ctica
                                  const carpetaDestino = cursoActual?.carpeta_trabajo || rutaContenidoActual || rutaNotasActual || 'contexto_ejercicios';
                                  setCarpetaPractica(carpetaDestino);
                                  setTipoFuentePractica('carpeta');
                                  
                                  // Abrir modal inmediatamente
                                  setModalPracticaAbierto(true);
                                  
                                  // Intentar guardar contexto en segundo plano
                                  try {
                                    const nombreArchivo = editorNotaTitulo.trim() || `contexto_${new Date().toISOString().slice(0,10)}`;
                                    
                                    const response = await fetch(`${API_URL}/api/guardar_contexto_ejercicio`, {
                                      method: 'POST',
                                      headers: { 'Content-Type': 'application/json' },
                                      body: JSON.stringify({
                                        contenido: editorNotaContenido,
                                        titulo: nombreArchivo,
                                        carpeta: carpetaDestino,
                                        tags: editorNotaTags
                                      })
                                    });
                                    
                                    if (response.ok) {
                                      const data = await response.json();
                                      console.log('‚úÖ Contexto guardado:', data.ruta);
                                    }
                                  } catch (error) {
                                    console.error('‚ö†Ô∏è No se pudo guardar el contexto:', error);
                                  }
                                }}
                                disabled={!editorNotaContenido.trim()}
                              >
                                üéØ Generar Ejercicio
                              </button>
                            </div>
                          </div>

                          {/* √Årea principal - Editor + Preview */}
                          <div className="editor-area-principal">
                            {/* Header */}
                            <div className="editor-header-compact">
                              <input 
                                type="text"
                                className="nota-titulo-compact"
                                placeholder="‚úèÔ∏è T√≠tulo de la nota..."
                                value={editorNotaTitulo}
                                onChange={(e) => setEditorNotaTitulo(e.target.value)}
                              />
                              <input 
                                type="text"
                                className="nota-tags-compact"
                                placeholder="üè∑Ô∏è Tags (separados por coma)"
                                value={editorNotaTags}
                                onChange={(e) => setEditorNotaTags(e.target.value)}
                              />
                            </div>

                            {/* Selector de tipo de contenido */}
                            <div style={{marginBottom: '1rem', padding: '0.75rem', background: 'rgba(59, 130, 246, 0.1)', borderRadius: '8px'}}>
                              <label style={{fontSize: '0.9rem', fontWeight: '600', color: '#cbd5e1', marginRight: '1rem'}}>üìù Tipo de contenido:</label>
                              <select
                                value={tipoNotaEditor}
                                onChange={(e) => setTipoNotaEditor(e.target.value)}
                                style={{
                                  padding: '0.5rem 1rem',
                                  background: 'rgba(51, 65, 85, 0.6)',
                                  border: '1px solid rgba(148, 163, 184, 0.3)',
                                  borderRadius: '6px',
                                  color: '#e2e8f0',
                                  fontSize: '0.9rem',
                                  cursor: 'pointer'
                                }}
                              >
                                <option value="normal">üìÑ Normal (Markdown)</option>
                                <option value="linguistica">üó£Ô∏è Ling√º√≠stica/Fon√©tica (IPA)</option>
                              </select>
                            </div>

                            {/* Vista dividida: Editor | Preview */}
                            <div className="editor-split-view">
                              {/* Editor de texto */}
                              <div className="editor-panel" style={{position: 'relative'}}>
                                <div className="panel-label">‚úçÔ∏è Editor {tipoNotaEditor === 'linguistica' ? '(IPA/Fon√©tica)' : '(Markdown)'}</div>
                                
                                {tipoNotaEditor === 'linguistica' ? (
                                  /* Editor de Ling√º√≠stica con vista previa integrada */
                                  <div style={{marginTop: '1rem'}}>
                                    <div style={{
                                      background: 'rgba(236, 72, 153, 0.05)',
                                      borderRadius: '10px',
                                      padding: '1rem',
                                      border: '1px solid rgba(236, 72, 153, 0.2)',
                                      marginBottom: '1rem'
                                    }}>
                                      <LinguisticsToolbar
                                        onInsertSymbol={(symbol) => {
                                          setEditorNotaContenido(editorNotaContenido + symbol);
                                        }}
                                      />
                                    </div>
                                    <LinguisticsCanvas
                                      value={editorNotaContenido}
                                      onChange={(texto) => setEditorNotaContenido(texto)}
                                      placeholder="Escribe transcripciones IPA: /Ààw…îÀêt…ô/, s√≠mbolos de stress: Ààhello ‚Üó, etc..."
                                    />
                                  </div>
                                ) : (
                                  /* Textarea normal para Markdown */
                                  <textarea
                                    className="editor-textarea-notion"
                                    placeholder="Escribe aqu√≠... Presiona / para abrir men√∫ de bloques

Shortcuts:
‚Ä¢ # T√≠tulo grande
‚Ä¢ ## T√≠tulo mediano  
‚Ä¢ ### T√≠tulo peque√±o
‚Ä¢ **negrita**
‚Ä¢ *cursiva*
‚Ä¢ \`c√≥digo\`
‚Ä¢ - [ ] tarea
‚Ä¢ ‚Ä¢ lista
‚Ä¢ > cita
‚Ä¢ --- divisor"
                                    value={editorNotaContenido}
                                    onChange={(e) => {
                                      setEditorNotaContenido(e.target.value);
                                      
                                      const value = e.target.value;
                                      const cursorPos = e.target.selectionStart;
                                      const lastChar = value[cursorPos - 1];
                                      
                                      if (lastChar === '/' && (cursorPos === 1 || value[cursorPos - 2] === '\n' || value[cursorPos - 2] === ' ')) {
                                        const wrapper = e.target.closest('.editor-panel');
                                        if (wrapper) {
                                          const wrapperRect = wrapper.getBoundingClientRect();
                                          const rect = e.target.getBoundingClientRect();
                                          setPosicionMenuComandos({
                                            top: rect.top - wrapperRect.top + 60,
                                            left: rect.left - wrapperRect.left + 40
                                          });
                                          setMenuComandosAbierto(true);
                                          setComandoSeleccionado(0);
                                          setCursorPosition(cursorPos);
                                        }
                                      } else if (menuComandosAbierto && lastChar !== '/') {
                                        setMenuComandosAbierto(false);
                                      }
                                    }}
                                    onKeyDown={(e) => {
                                      if (menuComandosAbierto) {
                                        if (e.key === 'ArrowDown') {
                                          e.preventDefault();
                                          setComandoSeleccionado(prev => prev < comandosDisponibles.length - 1 ? prev + 1 : 0);
                                        } else if (e.key === 'ArrowUp') {
                                          e.preventDefault();
                                          setComandoSeleccionado(prev => prev > 0 ? prev - 1 : comandosDisponibles.length - 1);
                                        } else if (e.key === 'Enter') {
                                          e.preventDefault();
                                          insertarBloque(comandosDisponibles[comandoSeleccionado]);
                                        } else if (e.key === 'Escape') {
                                          e.preventDefault();
                                          setMenuComandosAbierto(false);
                                        }
                                        return;
                                      }
                                      
                                      if (e.ctrlKey || e.metaKey) {
                                        if (e.key === 's') {
                                          e.preventDefault();
                                          if (editorNotaTitulo.trim()) guardarNotaRapida();
                                        }
                                      }
                                    }}
                                  />
                                )}
                                
                                {/* Men√∫ de comandos */}
                                {menuComandosAbierto && (
                                  <div 
                                    className="menu-comandos-notion"
                                    style={{
                                      position: 'absolute',
                                      top: `${posicionMenuComandos.top}px`,
                                      left: `${posicionMenuComandos.left}px`,
                                      zIndex: 10000
                                    }}
                                  >
                                    <div className="menu-comandos-header">
                                      <span className="menu-titulo">üéØ Bloques</span>
                                      <button onClick={() => setMenuComandosAbierto(false)} className="btn-cerrar-menu">‚úï</button>
                                    </div>
                                    <div className="menu-comandos-lista">
                                      {comandosDisponibles.map((comando, index) => (
                                        <div
                                          key={comando.id}
                                          className={`comando-item ${index === comandoSeleccionado ? 'seleccionado' : ''}`}
                                          onClick={() => insertarBloque(comando)}
                                          onMouseEnter={() => setComandoSeleccionado(index)}
                                        >
                                          <div className="comando-icono">{comando.icono}</div>
                                          <div className="comando-info">
                                            <div className="comando-nombre">{comando.nombre}</div>
                                            <div className="comando-descripcion">{comando.descripcion}</div>
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </div>

                              {/* Vista previa renderizada */}
                              <div className="preview-panel">
                                <div className="panel-label">üëÅÔ∏è Vista Previa (Estilo Notion)</div>
                                <div 
                                  className="preview-content-notion"
                                  dangerouslySetInnerHTML={{ 
                                    __html: renderizarContenidoNotion(editorNotaContenido) || '<p class="placeholder-preview">La vista previa aparecer√° aqu√≠...</p>'
                                  }}
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}

                    {/* Tab 2: Flashcards */}
                    {tabContenidoActivo === 1 && (
                      <div className="tab-flashcards-contenido">
                        {/* Botones de Acceso R√°pido */}
                        <div className="accesos-rapidos-fase">
                          <div className="accesos-rapidos-titulo">
                            <span>üîó Accesos R√°pidos</span>
                            <span className="carpeta-actual">üìÅ {rutaNotasActual || carpetaFlashcardActual?.ruta || 'Ra√≠z'}</span>
                          </div>
                          <div className="accesos-rapidos-botones">
                            <button
                              className="btn-acceso-rapido btn-cursos"
                              onClick={() => {
                                const carpeta = rutaNotasActual || carpetaFlashcardActual?.ruta || '';
                                setRutaActual(carpeta);
                                setSelectedMenu('cursos');
                                cargarCarpeta(carpeta);
                              }}
                              title="Ver documentos en esta carpeta"
                            >
                              üìö Ver en Mis Cursos
                            </button>
                            <button
                              className="btn-acceso-rapido btn-notas"
                              onClick={() => {
                                const carpeta = rutaNotasActual || carpetaFlashcardActual?.ruta || '';
                                setRutaNotasActual(carpeta);
                                setSelectedMenu('notas');
                                cargarCarpetasNotas(carpeta);
                              }}
                              title="Ver notas de esta carpeta"
                            >
                              üìù Ver Notas
                            </button>
                            <button
                              className="btn-acceso-rapido btn-flashcards"
                              onClick={() => {
                                const carpeta = rutaNotasActual || carpetaFlashcardActual?.ruta || '';
                                setRutaFlashcardsActual(carpeta);
                                setCarpetaFlashcardActual({ ruta: carpeta });
                                setSelectedMenu('flashcards');
                                cargarCarpetasFlashcards(carpeta);
                              }}
                              title="Ver todas las flashcards de esta carpeta"
                            >
                              üé¥ Ver Todas las Flashcards
                            </button>
                          </div>
                        </div>

                        {/* Sistema de Tabs */}
                        <div className="tabs-header-contenido">
                          <button 
                            className={`tab-button-contenido ${tabContenidoActivo === 0 ? 'activo' : ''}`}
                            onClick={() => setTabContenidoActivo(0)}
                          >
                            <span className="tab-icon">üìù</span>
                            <span className="tab-label">Notas</span>
                          </button>
                          <button 
                            className={`tab-button-contenido ${tabContenidoActivo === 1 ? 'activo' : ''}`}
                            onClick={() => setTabContenidoActivo(1)}
                          >
                            <span className="tab-icon">üé¥</span>
                            <span className="tab-label">Flashcards</span>
                          </button>
                        </div>
                        
                        <div className="flashcards-layout">
                          <div className="flashcards-header">
                            <h2>üé¥ Repaso con Flashcards</h2>
                            <p className="flashcards-subtitle">Practica con flashcards basadas en tus notas y documentos</p>
                          </div>

                          {/* Bot√≥n para agregar flashcard */}
                          <div className="flashcards-actions">
                            <button 
                              className="btn-nueva-flashcard"
                              onClick={() => {
                                setFormDataFlashcard({
                                  tipo: 'clasica',
                                  titulo: '',
                                  contenido: '',
                                  opciones: [],
                                  respuestaCorrecta: '',
                                  explicacion: '',
                                  tema: '',
                                  carpeta: carpetaFlashcardActual?.ruta || rutaNotasActual || '',
                                  estadoRevision: 'nueva',
                                  archivos: [],
                                  imagenes: [],
                                  latex: false,
                                  subtema: '',
                                  lenguaje: 'javascript',
                                  dificultad: 'medio',
                                  patronCodigo: 'comprension',
                                  subtipoQuimica: 'estructura',
                                  nivelQuimica: 'basico',
                                  rama: 'organica',
                                  subtipoFisica: 'ecuacion',
                                  nivelFisica: 'basico',
                                  ramaFisica: 'mecanica',
                                  subtipoIngenieria: 'circuito',
                                  nivelIngenieria: 'basico',
                                  ramaIngenieria: 'electrica'
                                });
                                setModalNuevaFlashcard(true);
                              }}
                            >
                              <span className="btn-icon">‚ûï</span>
                              Nueva Flashcard
                            </button>
                          </div>

                          <div className="notas-editor-notion-layout">
                            {/* Sidebar izquierdo - Lista de flashcards */}
                            <div className="editor-sidebar-izq">
                              <div className="sidebar-section">
                                <h4>üìÅ Destino</h4>
                                <div 
                                  className="carpeta-selector"
                                  onClick={() => {
                                    const carpeta = prompt('üìÅ Carpeta para guardar:\n(Ejemplo: Biologia/Unidad1)', carpetaFlashcardActual?.ruta || 'flashcards');
                                    if (carpeta !== null) {
                                      setCarpetaFlashcardActual({ ruta: carpeta });
                                      setMensaje({
                                        tipo: 'info',
                                        texto: `üìÅ Carpeta: ${carpeta || 'flashcards'}`
                                      });
                                    }
                                  }}
                                >
                                  <span className="carpeta-icon">üìÇ</span>
                                  <span className="carpeta-path">{carpetaFlashcardActual?.ruta || 'flashcards'}</span>
                                  <span className="carpeta-edit">‚úèÔ∏è</span>
                                </div>
                              </div>
                              
                              <div className="sidebar-section">
                                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                                  <h4>üé¥ Flashcards</h4>
                                  <button 
                                    className="btn-nueva-nota-mini"
                                    onClick={() => {
                                      setFormDataFlashcard({
                                        tipo: 'clasica',
                                        titulo: '',
                                        contenido: '',
                                        opciones: [],
                                        respuestaCorrecta: '',
                                        explicacion: '',
                                        tema: '',
                                        carpeta: carpetaFlashcardActual?.ruta || '',
                                        estadoRevision: 'nueva',
                                        archivos: [],
                                        imagenes: [],
                                        latex: false,
                                        subtema: '',
                                        lenguaje: 'javascript',
                                        dificultad: 'medio',
                                        patronCodigo: 'comprension',
                                        subtipoQuimica: 'estructura',
                                        nivelQuimica: 'basico',
                                        rama: 'organica',
                                        subtipoFisica: 'ecuacion',
                                        nivelFisica: 'basico',
                                        ramaFisica: 'mecanica',
                                        subtipoIngenieria: 'circuito',
                                        nivelIngenieria: 'basico',
                                        ramaIngenieria: 'electrica'
                                      });
                                    }}
                                    style={{
                                      background: '#4CAF50',
                                      color: 'white',
                                      border: 'none',
                                      borderRadius: '50%',
                                      width: '28px',
                                      height: '28px',
                                      cursor: 'pointer',
                                      fontSize: '1.2rem',
                                      display: 'flex',
                                      alignItems: 'center',
                                      justifyContent: 'center'
                                    }}
                                    title="Nueva flashcard"
                                  >
                                    +
                                  </button>
                                </div>
                                <div className="lista-notas-sidebar" style={{maxHeight: '300px', overflowY: 'auto'}}>
                                  {(flashcardsActuales || [])
                                    .filter(fc => !carpetaFlashcardActual?.ruta || fc.carpeta === carpetaFlashcardActual.ruta)
                                    .map(fc => (
                                      <div key={fc.id} className="nota-item-sidebar" style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        padding: '0.5rem',
                                        marginBottom: '0.3rem',
                                        background: 'rgba(51, 65, 85, 0.5)',
                                        borderRadius: '4px',
                                        cursor: 'pointer',
                                        border: '1px solid rgba(148, 163, 184, 0.2)',
                                        transition: 'all 0.2s'
                                      }}
                                      onMouseEnter={(e) => {
                                        e.currentTarget.style.background = 'rgba(71, 85, 105, 0.6)';
                                        e.currentTarget.style.borderColor = 'rgba(148, 163, 184, 0.4)';
                                      }}
                                      onMouseLeave={(e) => {
                                        e.currentTarget.style.background = 'rgba(51, 65, 85, 0.5)';
                                        e.currentTarget.style.borderColor = 'rgba(148, 163, 184, 0.2)';
                                      }}>
                                        <span 
                                          onClick={() => {
                                            // Cargar todos los datos de la flashcard para edici√≥n
                                            setFormDataFlashcard({
                                              ...fc,
                                              titulo: fc.titulo || fc.pregunta || '',
                                              contenido: fc.contenido || '',
                                              respuestaCorrecta: fc.respuestaCorrecta || fc.respuesta || '',
                                              explicacion: fc.explicacion || '',
                                              tipo: fc.tipo || 'clasica',
                                              latex: fc.latex || false,
                                              opciones: fc.opciones || [],
                                              tema: fc.tema || '',
                                              carpeta: fc.carpeta || carpetaFlashcardActual?.ruta || ''
                                            });
                                          }}
                                          style={{flex: 1, fontSize: '0.85rem', color: '#e2e8f0'}}
                                        >
                                          {fc.pregunta || fc.titulo || 'Sin t√≠tulo'}
                                        </span>
                                        <button
                                          onClick={(e) => {
                                            e.stopPropagation();
                                            if (window.confirm(`¬øEliminar "${fc.pregunta || fc.titulo}"?`)) {
                                              eliminarFlashcard(fc.id);
                                            }
                                          }}
                                          style={{
                                            background: 'rgba(239, 68, 68, 0.9)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '4px',
                                            padding: '0.2rem 0.5rem',
                                            cursor: 'pointer',
                                            fontSize: '0.75rem',
                                            transition: 'all 0.2s'
                                          }}
                                          onMouseEnter={(e) => {
                                            e.currentTarget.style.background = '#dc2626';
                                          }}
                                          onMouseLeave={(e) => {
                                            e.currentTarget.style.background = 'rgba(239, 68, 68, 0.9)';
                                          }}
                                        >
                                          üóëÔ∏è
                                        </button>
                                      </div>
                                    ))}
                                  {((flashcardsActuales || []).filter(fc => !carpetaFlashcardActual?.ruta || fc.carpeta === carpetaFlashcardActual.ruta).length === 0) && (
                                    <p style={{fontSize: '0.85rem', color: '#94a3b8', textAlign: 'center'}}>
                                      No hay flashcards en esta carpeta
                                    </p>
                                  )}
                                </div>
                              </div>
                            </div>

                            {/* √Årea central - Editor de flashcard COMPLETO */}
                            <div className="editor-area-central" style={{
                              padding: '2rem',
                              overflowY: 'auto',
                              maxHeight: '70vh'
                            }}>
                              {/* Selecci√≥n de Tipo */}
                              <div className="config-section">
                                <label className="config-label">
                                  <span className="label-icon">üéØ</span>
                                  Tipo de Flashcard
                                </label>
                                <select
                                  className="input-select"
                                  value={formDataFlashcard.tipo}
                                  onChange={(e) => setFormDataFlashcard({...formDataFlashcard, tipo: e.target.value})}
                                >
                                  <option value="clasica">üìá Cl√°sica (Pregunta ‚Üí Respuesta)</option>
                                  <option value="reconocimiento">üëÅÔ∏è Reconocimiento (Identificar concepto)</option>
                                  <option value="cloze">üî§ Cloze (Completar espacios)</option>
                                  <option value="escenario">üé¨ Escenario (Caso pr√°ctico)</option>
                                  <option value="mcq">‚òëÔ∏è Opci√≥n M√∫ltiple</option>
                                  <option value="visual">üñºÔ∏è Visual (Imagen/Diagrama)</option>
                                  <option value="auditiva">üîä Auditiva (Audio/Pronunciaci√≥n)</option>
                                  <option value="produccion">‚úçÔ∏è Producci√≥n (Generar respuesta)</option>
                                  <option value="invertida">üîÑ Invertida (Respuesta ‚Üí Pregunta)</option>
                                  <option value="jerarquia">üèóÔ∏è Jerarqu√≠a (Organizar niveles)</option>
                                  <option value="error">‚ùå Error Com√∫n (Corregir)</option>
                                  <option value="comparacion">‚öñÔ∏è Comparaci√≥n (A vs B)</option>
                                  <option value="matematica">üî¢ Matem√°tica (F√≥rmulas/LaTeX)</option>
                                  <option value="archivo">üìé Archivo (PDF/Documento)</option>
                                  <option value="programacion">&lt;/&gt; Programaci√≥n (C√≥digo)</option>
                                  <option value="quimica">üß™ Qu√≠mica (Estructuras/Mol√©culas)</option>
                                  <option value="fisica">‚öõÔ∏è F√≠sica (Ecuaciones/Diagramas)</option>
                                  <option value="ingenieria">üîß Ingenier√≠a (Circuitos/FBD/Vigas)</option>
                                  <option value="programacion-avanzada">üíª Programaci√≥n Avanzada (UML/Flujo/Grafos)</option>
                                  <option value="logica-discreta">üîÆ L√≥gica/Matem√°tica Discreta (Tablas/Conjuntos/Grafos)</option>
                                  <option value="linguistica">üó£Ô∏è Lingu√≠stica/Fon√©tica (IPA/Stress/Entonaci√≥n)</option>
                                  <option value="musica">üéº M√∫sica/Teor√≠a Musical (Pentagramas/Acordes/Escalas)</option>
                                  <option value="geometria">üìê Geometr√≠a (Construcciones/√Ångulos/Trigonometr√≠a)</option>
                                  <option value="quimica-avanzada">üß¨ Qu√≠mica Avanzada (Orbitales/VSEPR/MO/Mecanismos)</option>
                                  <option value="probabilidad">üé≤ Probabilidad y Estad√≠stica (√Årboles/Venn/Distribuciones/Bayes)</option>
                                  <option value="arte">üé® Arte y Dise√±o Visual (Figuras/Paletas/Composiciones/Estilos)</option>
                                </select>
                                
                                {/* Toggle LaTeX */}
                                <div style={{
                                  marginTop: '1rem',
                                  padding: '0.75rem',
                                  background: 'rgba(59, 130, 246, 0.1)',
                                  borderRadius: '8px',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '0.75rem'
                                }}>
                                  <input
                                    type="checkbox"
                                    id="latex-toggle-editor"
                                    checked={formDataFlashcard.latex}
                                    onChange={(e) => setFormDataFlashcard({...formDataFlashcard, latex: e.target.checked})}
                                    style={{
                                      width: '18px',
                                      height: '18px',
                                      cursor: 'pointer',
                                      accentColor: '#3b82f6'
                                    }}
                                  />
                                  <label htmlFor="latex-toggle-editor" style={{
                                    color: '#cbd5e1',
                                    fontSize: '0.9rem',
                                    cursor: 'pointer',
                                    userSelect: 'none'
                                  }}>
                                    üìê Contiene f√≥rmulas matem√°ticas (LaTeX)
                                  </label>
                                </div>
                              </div>

                              {/* T√≠tulo */}
                              <div className="config-section">
                                <label className="config-label">
                                  <span className="label-icon">üìù</span>
                                  T√≠tulo
                                </label>
                                <input
                                  type="text"
                                  className="input-text"
                                  placeholder="T√≠tulo breve de la flashcard"
                                  value={formDataFlashcard.titulo}
                                  onChange={(e) => setFormDataFlashcard({...formDataFlashcard, titulo: e.target.value})}
                                />
                              </div>

                              {/* Contenido/Pregunta */}
                              <div className="config-section">
                                <label className="config-label">
                                  <span className="label-icon">üí≠</span>
                                  Pregunta/Contenido
                                </label>
                                
                                {/* Editor especializado seg√∫n el tipo */}
                                {formDataFlashcard.tipo === 'linguistica' ? (
                                  /* Editor de Ling√º√≠stica/Fon√©tica */
                                  <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                    {/* Toolbar de Ling√º√≠stica */}
                                    <div style={{
                                      background: 'rgba(236, 72, 153, 0.05)',
                                      borderRadius: '10px',
                                      padding: '1rem',
                                      border: '1px solid rgba(236, 72, 153, 0.2)'
                                    }}>
                                      <LinguisticsToolbar
                                        onInsertSymbol={(symbol) => {
                                          setFormDataFlashcard({
                                            ...formDataFlashcard,
                                            contenido: formDataFlashcard.contenido + symbol
                                          });
                                        }}
                                      />
                                    </div>

                                    {/* Editor de ling√º√≠stica con vista previa */}
                                    <LinguisticsCanvas
                                      value={formDataFlashcard.contenido}
                                      onChange={(texto) => setFormDataFlashcard({
                                        ...formDataFlashcard,
                                        contenido: texto
                                      })}
                                      placeholder="Escribe transcripciones IPA: /Ààw…îÀêt…ô/, s√≠mbolos de stress: Ààhello ‚Üó, etc..."
                                    />
                                  </div>
                                ) : (
                                  /* Textarea normal para otros tipos */
                                  <textarea
                                    className="textarea-prompt"
                                    placeholder="Escribe aqu√≠ el contenido de la flashcard..."
                                    value={formDataFlashcard.contenido}
                                    onChange={(e) => setFormDataFlashcard({...formDataFlashcard, contenido: e.target.value})}
                                    rows={6}
                                  />
                                )}
                              </div>

                              {/* Respuesta Correcta */}
                              <div className="config-section">
                                <label className="config-label">
                                  <span className="label-icon">‚úÖ</span>
                                  Respuesta Correcta
                                </label>
                                <textarea
                                  className="textarea-prompt"
                                  placeholder="Escribe la respuesta correcta..."
                                  value={formDataFlashcard.respuestaCorrecta}
                                  onChange={(e) => setFormDataFlashcard({...formDataFlashcard, respuestaCorrecta: e.target.value})}
                                  rows={4}
                                />
                              </div>

                              {/* Explicaci√≥n */}
                              <div className="config-section">
                                <label className="config-label">
                                  <span className="label-icon">üí°</span>
                                  Explicaci√≥n (opcional)
                                </label>
                                <textarea
                                  className="textarea-prompt"
                                  placeholder="Agrega contexto adicional o explicaci√≥n..."
                                  value={formDataFlashcard.explicacion}
                                  onChange={(e) => setFormDataFlashcard({...formDataFlashcard, explicacion: e.target.value})}
                                  rows={3}
                                />
                              </div>

                              {/* Botones de acci√≥n */}
                              <div className="editor-acciones-seccion" style={{
                                display: 'flex',
                                gap: '1rem',
                                marginTop: '2rem',
                                paddingTop: '1.5rem',
                                borderTop: '1px solid rgba(148, 163, 184, 0.2)'
                              }}>
                                <button 
                                  className="btn-guardar-nota-notion"
                                  onClick={async () => {
                                    if (!formDataFlashcard.titulo) {
                                      setMensaje({
                                        tipo: 'warning',
                                        texto: '‚ö†Ô∏è Debes agregar un t√≠tulo'
                                      });
                                      return;
                                    }
                                    
                                    try {
                                      const ahora = new Date().toISOString();
                                      const esNueva = !formDataFlashcard.id;
                                      
                                      const nuevaFlashcard = {
                                        ...formDataFlashcard,
                                        id: formDataFlashcard.id || `fc_${Date.now()}`,
                                        pregunta: formDataFlashcard.titulo,
                                        respuesta: formDataFlashcard.respuestaCorrecta || formDataFlashcard.contenido,
                                        fecha_creacion: formDataFlashcard.fecha_creacion || ahora,
                                        carpeta: carpetaFlashcardActual?.ruta || rutaFlashcardsActual || '',
                                        // Marcar como revisada solo si es nueva (reci√©n creada)
                                        ultima_revision: esNueva ? ahora : formDataFlashcard.ultima_revision,
                                        proxima_revision: esNueva ? new Date(Date.now() + 24*60*60*1000).toISOString() : formDataFlashcard.proxima_revision
                                      };
                                      
                                      // üî• GUARDAR EN SU CARPETA CORRESPONDIENTE
                                      await guardarFlashcardEnCarpeta(nuevaFlashcard);
                                      
                                      // Actualizar estado local
                                      const flashcardsActuales = await cargarTodasFlashcards();
                                      setFlashcardsActuales(flashcardsActuales);
                                      
                                      setMensaje({
                                        tipo: 'success',
                                        texto: '‚úÖ Flashcard guardada correctamente'
                                      });
                                      
                                      // Limpiar formulario
                                      setFormDataFlashcard({
                                        tipo: 'clasica',
                                        titulo: '',
                                        contenido: '',
                                        opciones: [],
                                        respuestaCorrecta: '',
                                        explicacion: '',
                                        tema: '',
                                        carpeta: carpetaFlashcardActual?.ruta || '',
                                        estadoRevision: 'nueva',
                                        archivos: [],
                                        imagenes: [],
                                        latex: false
                                      });
                                    } catch (error) {
                                      console.error('Error guardando flashcard:', error);
                                      setMensaje({
                                        tipo: 'error',
                                        texto: '‚ùå Error al guardar flashcard'
                                      });
                                    }
                                  }}
                                  disabled={guardandoNota}
                                  style={{flex: 1}}
                                >
                                  {guardandoNota ? 'üíæ Guardando...' : 'üíæ Guardar Flashcard'}
                                </button>
                                
                                <button 
                                  className="btn-limpiar-nota-notion"
                                  onClick={() => {
                                    setFormDataFlashcard({
                                      tipo: 'clasica',
                                      titulo: '',
                                      contenido: '',
                                      opciones: [],
                                      respuestaCorrecta: '',
                                      explicacion: '',
                                      tema: '',
                                      carpeta: carpetaFlashcardActual?.ruta || '',
                                      estadoRevision: 'nueva',
                                      archivos: [],
                                      imagenes: [],
                                      latex: false
                                    });
                                  }}
                                >
                                  üßπ Limpiar
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  
                  {/* Bot√≥n para volver a calentamiento y seleccionar otra carpeta */}
                  <div className="footer-fase-contenido" style={{ display: "flex", gap: "1rem", justifyContent: "center", flexWrap: "wrap" }}>
                    <button 
                      className="btn-volver-calentamiento" 
                      onClick={() => {
                        if (confirm('¬øQuieres volver al calentamiento para seleccionar otra carpeta? Se reiniciar√° la sesi√≥n.')) {
                          setFaseActual('calentamiento');
                          setIndiceFaseActual(0);
                          setDocumentoActual(null);
                          setDocumentosSesion([]);
                          setErroresSesion([]);
                          setFlashcardsSesion([]);
                          setContenidoHTML('');
                          setTabContenidoActivo(0);
                          setMensaje({
                            tipo: 'info',
                            texto: 'üî• Volviendo a calentamiento para seleccionar nueva carpeta'
                          });
                        }
                      }}
                      title="Volver a selecci√≥n de carpeta"
                    >
                      üîÑ Cambiar Carpeta
                    </button>
                    <button className="btn-continuar-fase" onClick={avanzarFase}>
                      Continuar a Cierre ‚Üí
                    </button>
                  </div>
                </div>
              )}

              {/* ============================================ */}
              {/* FASE - DESCANSO (Pomodoro) */}
              {/* ============================================ */}
              {faseActual === 'descanso' && (
                <div className="fase-descanso">
                  <div className="descanso-container">
                    <div className="descanso-icon-main">
                      {tiempoRestante > 600 ? 'üßò' : '‚òï'}
                    </div>
                    
                    <h1 className="descanso-titulo">
                      {tiempoRestante > 600 ? 'Descanso Largo' : 'Descanso Corto'}
                    </h1>
                    
                    <p className="descanso-subtitulo">
                      {tiempoRestante > 600 
                        ? 'Llevas 2 horas estudiando. Toma 15 minutos para recuperarte.' 
                        : 'Completaste 25 minutos de estudio. Toma 5 minutos de descanso.'}
                    </p>
                    
                    <div className="descanso-etiqueta">
                      Descanso en:
                    </div>
                    
                    <div className="descanso-tiempo-grande">
                      {Math.floor(tiempoRestante / 60)} {Math.floor(tiempoRestante / 60) === 1 ? 'minuto' : 'minutos'}
                    </div>
                    
                    <div className="descanso-recomendaciones">
                      <h3>üí° Recomendaciones basadas en ciencia:</h3>
                      <ul>
                        <li>üö∂ Lev√°ntate y camina un poco</li>
                        <li>üíß Hidrata tu cerebro (bebe agua)</li>
                        <li>üëÄ Mira hacia un punto lejano (20-20-20)</li>
                        <li>üßò Respira profundo 3 veces</li>
                        {tiempoRestante > 600 && <li>üçé Come algo ligero y saludable</li>}
                      </ul>
                    </div>
                    
                    <div className="descanso-progreso">
                      <div className="progreso-bar-descanso">
                        <div 
                          className="progreso-fill-descanso"
                          style={{
                            width: `${((tiempoFaseActual - tiempoRestante) / tiempoFaseActual) * 100}%`
                          }}
                        ></div>
                      </div>
                    </div>
                    
                    <button 
                      className="btn-saltar-descanso"
                      onClick={() => {
                        setEnDescanso(false);
                        setTiempoAcumuladoEstudio(0);
                        setFaseActual(fasesSesion[indiceFaseActual]?.tipo || 'contenido');
                        const tiempoFase = fasesSesion[indiceFaseActual]?.duracion || 1500;
                        setTiempoRestante(tiempoFase);
                        setTiempoFaseActual(tiempoFase);
                      }}
                    >
                      ‚è≠Ô∏è Saltar descanso
                    </button>
                  </div>
                </div>
              )}

              {/* ============================================ */}
              {/* FASE 5 - CIERRE/RESUMEN */}
              {/* ============================================ */}
              {faseActual === 'cierre' && (
                <div className="fase-cierre">
                  {/* Header de Celebraci√≥n */}
                  <div className="cierre-header-celebracion">
                    <div className="celebration-icon">üéâ</div>
                    <h1 className="celebration-title">¬°SESI√ìN COMPLETADA!</h1>
                    <p className="celebration-subtitle">
                      Has dedicado {resumenSesion?.tiempoEfectivo || 0} minutos a tu aprendizaje
                    </p>
                  </div>

                  {/* Bloque de Tiempo Efectivo */}
                  <div className="tiempo-efectivo-block">
                    <div className="tiempo-efectivo-numero">
                      <span className="tiempo-icon">‚è±Ô∏è</span>
                      <span className="tiempo-valor">{resumenSesion?.tiempoEfectivo || 0}</span>
                      <span className="tiempo-label">minutos efectivos</span>
                    </div>
                    <div className="tiempo-desglose">
                      ({resumenSesion?.tiempoTotal || 0} min totales - {resumenSesion?.tiempoPausa || 0} min en pausa)
                    </div>
                  </div>

                  {/* Grid de Resumen de Actividades */}
                  <div className="resumen-actividades-container">
                    <h2 className="resumen-titulo">üìä RESUMEN DE TU SESI√ìN</h2>
                    <div className="resumen-grid">
                      <div className={`stat-card-resumen ${(resumenSesion?.erroresReforzados || 0) === 0 ? 'stat-vacio' : ''}`}>
                        <div className="stat-icon-grande">‚ùå</div>
                        <div className="stat-numero-grande stat-rojo">
                          {resumenSesion?.erroresReforzados || 0}
                        </div>
                        <div className="stat-label-grande">Errores Reforzados</div>
                      </div>

                      <div className={`stat-card-resumen ${(resumenSesion?.flashcardsRepasadas || 0) === 0 ? 'stat-vacio' : ''}`}>
                        <div className="stat-icon-grande">üÉè</div>
                        <div className="stat-numero-grande stat-purpura">
                          {resumenSesion?.flashcardsRepasadas || 0}
                        </div>
                        <div className="stat-label-grande">Flashcards Repasadas</div>
                      </div>

                      <div className={`stat-card-resumen ${(resumenSesion?.documentosEstudiados || 0) === 0 ? 'stat-vacio' : ''}`}>
                        <div className="stat-icon-grande">üìñ</div>
                        <div className="stat-numero-grande stat-azul">
                          {resumenSesion?.documentosEstudiados || 0}
                        </div>
                        <div className="stat-label-grande">Documentos Nuevos</div>
                      </div>

                      <div className={`stat-card-resumen ${(resumenSesion?.notasCreadas || 0) === 0 ? 'stat-vacio' : ''}`}>
                        <div className="stat-icon-grande">üìù</div>
                        <div className="stat-numero-grande stat-verde">
                          {resumenSesion?.notasCreadas || 0}
                        </div>
                        <div className="stat-label-grande">Notas Creadas</div>
                      </div>
                    </div>
                  </div>

                  {/* Secci√≥n de Reflexi√≥n Personal */}
                  <div className="reflexion-section">
                    <h3 className="reflexion-titulo">üí≠ REFLEXI√ìN PERSONAL (opcional)</h3>
                    
                    <div className="reflexion-grupo">
                      <label className="reflexion-label">¬øQu√© fue lo m√°s dif√≠cil hoy?</label>
                      <textarea
                        className="reflexion-textarea"
                        placeholder="Ej: Entender recursividad en programaci√≥n..."
                        value={reflexionDificil}
                        onChange={(e) => setReflexionDificil(e.target.value.substring(0, 150))}
                        rows={3}
                        maxLength={150}
                      />
                      <div className="char-counter">
                        {reflexionDificil.length} / 150 caracteres
                      </div>
                    </div>

                    <div className="reflexion-grupo">
                      <label className="reflexion-label">¬øQu√© deber√≠as revisar ma√±ana?</label>
                      <textarea
                        className="reflexion-textarea"
                        placeholder="Ej: Repasar la f√≥rmula general y hacer m√°s ejercicios..."
                        value={reflexionManana}
                        onChange={(e) => setReflexionManana(e.target.value.substring(0, 150))}
                        rows={3}
                        maxLength={150}
                      />
                      <div className="char-counter">
                        {reflexionManana.length} / 150 caracteres
                      </div>
                    </div>
                  </div>

                  {/* Preview de Pr√≥xima Sesi√≥n */}
                  {recomendacionesSesion.length > 0 && (
                    <div className="proxima-sesion-preview">
                      <h3 className="preview-titulo">üîÆ PR√ìXIMA SESI√ìN RECOMENDADA</h3>
                      <p className="preview-subtitulo">Basado en tu rendimiento de hoy:</p>
                      <ul className="recomendaciones-lista">
                        {recomendacionesSesion.map((rec, idx) => (
                          <li key={idx} className="recomendacion-item">
                            <span className="rec-icon">
                              {rec.tipo === 'errores' && '‚ùå'}
                              {rec.tipo === 'flashcards' && 'üÉè'}
                              {rec.tipo === 'contenido' && 'üìñ'}
                            </span>
                            <span className="rec-texto">{rec.texto}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {/* Bot√≥n de Finalizar Sesi√≥n */}
                  <div className="footer-finalizar">
                    <button 
                      className="btn-finalizar-sesion"
                      onClick={finalizarYGuardarSesion}
                      disabled={guardandoSesion}
                    >
                      {guardandoSesion ? (
                        <>
                          <span className="spinner-small"></span>
                          Guardando...
                        </>
                      ) : (
                        <>
                          üéØ FINALIZAR SESI√ìN Y GUARDAR
                        </>
                      )}
                    </button>
                  </div>
                </div>
              )}
            </div>

            {/* Modal para crear flashcards desde nota - FUERA de las fases */}
            {modalFlashcardCreator && (
              <div className="modal-overlay" onClick={() => setModalFlashcardCreator(false)}>
                <div className="modal-flashcard-creator" onClick={(e) => e.stopPropagation()}>
                  <div className="modal-header">
                    <h2>üé¥ Crear Flashcards desde Nota</h2>
                    <button className="btn-cerrar-modal" onClick={() => setModalFlashcardCreator(false)}>‚úï</button>
                  </div>
                  
                  <div className="modal-body">
                    <div className="texto-seleccionado-preview">
                      <label>Texto seleccionado:</label>
                      <div className="preview-box">
                        {textoSeleccionadoFlashcard.substring(0, 200)}
                        {textoSeleccionadoFlashcard.length > 200 && '...'}
                      </div>
                    </div>

                    <div className="modo-conversion-opciones">
                      <label>¬øC√≥mo dividir en flashcards?</label>
                      <div className="radio-group">
                        <label className="radio-option">
                          <input 
                            type="radio" 
                            value="linea" 
                            checked={modoConversionFlashcard === 'linea'}
                            onChange={(e) => setModoConversionFlashcard(e.target.value)}
                          />
                          <span>Una flashcard por l√≠nea (numerada)</span>
                        </label>
                        <label className="radio-option">
                          <input 
                            type="radio" 
                            value="parrafo" 
                            checked={modoConversionFlashcard === 'parrafo'}
                            onChange={(e) => setModoConversionFlashcard(e.target.value)}
                          />
                          <span>Una flashcard por p√°rrafo</span>
                        </label>
                      </div>
                    </div>
                  </div>

                  <div className="modal-footer">
                    <button className="btn-cancelar-modal" onClick={() => setModalFlashcardCreator(false)}>
                      ‚ùå Cancelar
                    </button>
                    <button className="btn-crear-flashcards-modal" onClick={convertirTextoEnFlashcards}>
                      ‚úÖ Crear flashcards
                    </button>
                  </div>
                </div>
              </div>
            )}
            </div>
          </div>
        )}

        {selectedMenu === 'cursos' && (
          <div className="content-section">
            <div className="carpetas-header">
              <h1>üìÅ {rutaActual ? rutaActual.split('\\').pop() || 'Mis Cursos' : 'Mis Cursos'} üéì</h1>
              <div className="carpetas-actions">
                {/* Men√∫ dropdown con 3 puntos */}
                <div className="dropdown-menu-container">
                  <button 
                    className="btn-menu-dropdown" 
                    onClick={() => setMenuDropdownAbierto(!menuDropdownAbierto)}
                    title="M√°s opciones"
                  >
                    ‚ãÆ
                  </button>
                  {menuDropdownAbierto && !modalSeleccionArchivos && (
                    <>
                      <div 
                        className="dropdown-overlay" 
                        onClick={() => setMenuDropdownAbierto(false)}
                      />
                      <div className="dropdown-menu-content">
                        <button 
                          onClick={() => {
                            crearCarpeta();
                            setMenuDropdownAbierto(false);
                          }}
                          className="dropdown-item"
                        >
                          üìÅ Nueva Carpeta
                        </button>
                        
                        <label className="dropdown-item">
                          üì§ Subir PDF aqu√≠
                          <input 
                            type="file" 
                            accept=".pdf" 
                            onChange={(e) => {
                              handleFileUpload(e);
                              setMenuDropdownAbierto(false);
                            }}
                            disabled={loading}
                            style={{display: 'none'}}
                          />
                        </label>
                        
                        <button 
                          onClick={() => {
                            crearNuevaNota();
                            setMenuDropdownAbierto(false);
                          }}
                          className="dropdown-item"
                        >
                          üìù Crear Nota Aqu√≠
                        </button>
                        
                        {rutaActual && (
                          <>
                            <div className="dropdown-divider" />
                            
                            <div className="dropdown-section-title">üéØ Generar Examen por Carpeta</div>
                            
                            <button 
                              onClick={() => {
                                marcarCarpeta(rutaActual, 'curso');
                                abrirGenerarExamenCarpeta(rutaActual, 'curso');
                              }}
                              className="dropdown-item dropdown-item-highlight"
                            >
                              üéì Marcar como CURSO y Generar Examen
                            </button>
                            
                            <button 
                              onClick={() => {
                                marcarCarpeta(rutaActual, 'capitulo');
                                abrirGenerarExamenCarpeta(rutaActual, 'capitulo');
                              }}
                              className="dropdown-item dropdown-item-highlight"
                            >
                              üìö Marcar como CAP√çTULO y Generar Examen
                            </button>
                            
                            <button 
                              onClick={() => {
                                marcarCarpeta(rutaActual, 'clase');
                                abrirGenerarExamenCarpeta(rutaActual, 'clase');
                              }}
                              className="dropdown-item dropdown-item-highlight"
                            >
                              üìñ Marcar como CLASE y Generar Examen
                            </button>
                            
                            <button 
                              onClick={() => {
                                marcarCarpeta(rutaActual, 'leccion');
                                abrirGenerarExamenCarpeta(rutaActual, 'leccion');
                              }}
                              className="dropdown-item dropdown-item-highlight"
                            >
                              üìù Marcar como LECCI√ìN y Generar Examen
                            </button>
                          </>
                        )}
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>

            {rutaActual && (
              <div className="ruta-info">
                üìç Ubicaci√≥n actual: <strong>{rutaActual || 'Ra√≠z'}</strong>
                <br />
                <small style={{color: '#a0a0b0'}}>Los PDFs se guardar√°n en esta carpeta</small>
              </div>
            )}

            {/* Breadcrumb */}
            <div className="breadcrumb">
              {rutaActual && (
                <button 
                  onClick={() => {
                    const partes = rutaActual.split('\\').filter(p => p);
                    const rutaPadre = partes.slice(0, -1).join('\\');
                    cargarCarpeta(rutaPadre);
                  }}
                  className="btn-atras"
                  title="Volver a carpeta anterior"
                >
                  ‚Üê Atr√°s
                </button>
              )}
              <button onClick={() => cargarCarpeta('')} className="breadcrumb-item">
                üè† Inicio
              </button>
              {rutaActual && rutaActual.split('\\').filter(p => p).map((parte, idx, arr) => {
                const rutaParcial = arr.slice(0, idx + 1).join('\\')
                return (
                  <span key={idx}>
                    <span className="breadcrumb-separator">/</span>
                    <button 
                      onClick={() => cargarCarpeta(rutaParcial)}
                      className="breadcrumb-item"
                    >
                      {parte}
                    </button>
                  </span>
                )
              })}
            </div>

            {/* Botones de navegaci√≥n cruzada */}
            {rutaActual && (
              <div className="accesos-rapidos-fase" style={{marginBottom: '1rem'}}>
                <div className="accesos-rapidos-titulo">
                  <span>üîó Ver esta carpeta en:</span>
                </div>
                <div className="accesos-rapidos-botones">
                  <button
                    className="btn-acceso-rapido btn-notas"
                    onClick={() => {
                      setRutaNotasActual(rutaActual);
                      setSelectedMenu('notas');
                      cargarCarpetasNotas(rutaActual);
                    }}
                    title="Ver notas de esta carpeta"
                  >
                    üìù Notas
                  </button>
                  <button
                    className="btn-acceso-rapido btn-flashcards"
                    onClick={() => {
                      setRutaFlashcardsActual(rutaActual);
                      setCarpetaFlashcardActual({ ruta: rutaActual });
                      setSelectedMenu('flashcards');
                      cargarCarpetasFlashcards(rutaActual);
                    }}
                    title="Ver flashcards de esta carpeta"
                  >
                    üé¥ Flashcards
                  </button>
                </div>
              </div>
            )}

            {loading ? (
              <p className="loading">Cargando...</p>
            ) : generandoExamen ? (
              <div className="loading-examen">
                <div className="spinner"></div>
                <p>‚è≥ Generando examen con IA...</p>
                
                {/* Barra de progreso */}
                <div className="progreso-container">
                  <div className="progreso-barra">
                    <div 
                      className="progreso-fill" 
                      style={{width: `${progresoGeneracion}%`}}
                    >
                      <span className="progreso-texto">{progresoGeneracion}%</span>
                    </div>
                  </div>
                  <p className="progreso-mensaje">{mensajeProgreso}</p>
                </div>
                
                <p className="hint">Esto puede tomar varios minutos dependiendo del modelo</p>
                <button 
                  onClick={cancelarGeneracionExamen}
                  className="btn-cancelar-generacion"
                >
                  ‚èπÔ∏è Cancelar Generaci√≥n
                </button>
              </div>
            ) : (
              <>
                {/* Carpetas */}
                {carpetas.length > 0 && (
                  <div className="items-section">
                    <h3>üìÇ Carpetas (Generar Examen disponible)</h3>
                    <div className="items-grid">
                      {carpetas.map(carpeta => (
                        <div 
                          key={carpeta.ruta} 
                          className="item-card carpeta-item"
                          onClick={() => cargarCarpeta(carpeta.ruta)}
                          style={{cursor: 'pointer'}}
                        >
                          <div className="item-icon">üìÅ</div>
                          <div className="item-info">
                            <h4>{carpeta.nombre}</h4>
                            <p>
                              {carpeta.num_documentos} docs ¬∑ {carpeta.num_subcarpetas} carpetas
                            </p>
                          </div>
                          <div className="item-actions">
                            <button 
                              onClick={(e) => {
                                e.stopPropagation();
                                setMenuAbierto(menuAbierto === carpeta.ruta ? null : carpeta.ruta);
                              }}
                              className="btn-menu"
                            >
                              ‚ãÆ
                            </button>
                            {menuAbierto === carpeta.ruta && (
                              <div className="dropdown-menu">
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  generarExamenDesdeCarpeta(carpeta);
                                }}>
                                  üìù Generar Examen
                                </button>
                                  <button onClick={(e) => {
                                    e.stopPropagation();
                                    setMenuAbierto(null);
                                    if (carpeta.num_documentos > 0) {
                                      abrirModalPractica(carpeta.ruta, 'carpeta');
                                    }
                                  }}
                                    disabled={carpeta.num_documentos === 0}
                                  >
                                    {carpeta.num_documentos > 0 
                                      ? `üßë‚Äçüíª Generar pr√°ctica (${carpeta.num_documentos} docs)` 
                                      : 'No disponible: sin documentos'}
                                  </button>
                                <hr style={{margin: '0.5rem 0', border: 'none', borderTop: '1px solid rgba(255,255,255,0.1)'}} />
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  marcarCarpeta(carpeta.ruta, 'curso');
                                }}>
                                  üìö Marcar como CURSO
                                </button>
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  marcarCarpeta(carpeta.ruta, 'capitulo');
                                }}>
                                  üìñ Marcar como CAP√çTULO
                                </button>
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  marcarCarpeta(carpeta.ruta, 'clase');
                                }}>
                                  üìë Marcar como CLASE
                                </button>
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  marcarCarpeta(carpeta.ruta, 'leccion');
                                }}>
                                  üìÑ Marcar como LECCI√ìN
                                </button>
                                <hr style={{margin: '0.5rem 0', border: 'none', borderTop: '1px solid rgba(255,255,255,0.1)'}} />
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  renombrarCarpeta(carpeta.ruta, carpeta.nombre);
                                }}>
                                  ‚úèÔ∏è Renombrar
                                </button>
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  iniciarMoverCarpeta(carpeta);
                                }}>
                                  üì¶ Mover
                                </button>
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  eliminarCarpeta(carpeta.ruta, carpeta.nombre);
                                }} className="btn-menu-eliminar">
                                  üóëÔ∏è Eliminar
                                </button>
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Documentos */}
                {documentos.length > 0 && (
                  <div className="items-section">
                    <h3>üìÑ Documentos</h3>
                    <div className="items-grid">
                      {documentos.map(doc => (
                        <div key={doc.ruta} className="item-card documento-item">
                          <div className="item-icon">üìÑ</div>
                          <div className="item-info">
                            <h4>{doc.nombre}</h4>
                            <p>{doc.tama√±o_kb} KB</p>
                          </div>
                          <div className="item-actions">
                            <button 
                              onClick={() => verDocumento(doc.ruta, doc.nombre)}
                              className="btn-ver"
                            >
                              üëÅÔ∏è Ver
                            </button>
                            <button 
                              onClick={() => renombrarDocumento(doc.ruta, doc.nombre)}
                              className="btn-renombrar"
                              title="Renombrar documento"
                            >
                              ‚úèÔ∏è
                            </button>
                            <button 
                              onClick={() => eliminarDocumento(doc.ruta, doc.nombre)}
                              className="btn-eliminar"
                            >
                              üóëÔ∏è
                            </button>
                            <button 
                              className="btn-menu-dots"
                              onClick={(e) => {
                                e.stopPropagation();
                                setMenuAbierto(menuAbierto === `documento-${doc.ruta}` ? null : `documento-${doc.ruta}`);
                              }}
                              title="M√°s opciones"
                            >
                              ‚ãÆ
                            </button>
                            {menuAbierto === `documento-${doc.ruta}` && (
                              <div className="dropdown-menu">
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  convertirDocumentoANota(doc);
                                }}>
                                  üìù Convertir a Nota
                                </button>
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  abrirModalPractica(doc.ruta, 'documento');
                                }}>
                                  üßë‚Äçüíª Generar Pr√°ctica
                                </button>
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  generarExamenDesdeDocumento(doc);
                                }}>
                                  üìù Generar Examen
                                </button>
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {carpetas.length === 0 && documentos.length === 0 && (
                  <div className="empty-state">
                    <p>üì≠ Esta carpeta est√° vac√≠a</p>
                    <p className="empty-hint">Crea una carpeta o sube un PDF para comenzar</p>
                  </div>
                )}
              </>
            )}
          </div>
        )}

        {/* Visor de documentos */}
        {visorAbierto && documentoActual && (
          <div className="modal-overlay" onClick={cerrarVisor}>
            <div className="modal-content modal-content-editor" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üìÑ {documentoActual.nombre}</h2>
                <div className="modal-info">
                  <span>{documentoActual.tama√±o_kb} KB</span>
                  <span>‚Ä¢</span>
                  <span>{documentoActual.lineas} l√≠neas</span>
                </div>
                <div className="modal-actions">
                  {!modoEdicion ? (
                    <>
                      <button onClick={activarEdicion} className="btn-editar" title="Editar documento">
                        ‚úèÔ∏è Editar
                      </button>
                      {!leyendo && !pausado && (
                        <button onClick={leerDocumento} className="btn-leer" title="Leer documento con voz">
                          üîä Leer
                        </button>
                      )}
                      {leyendo && (
                        <button onClick={pausarLectura} className="btn-pausar" title="Pausar lectura">
                          ‚è∏Ô∏è Pausar
                        </button>
                      )}
                      {pausado && (
                        <button onClick={leerDocumento} className="btn-reanudar" title="Reanudar lectura">
                          ‚ñ∂Ô∏è Reanudar
                        </button>
                      )}
                      {(leyendo || pausado) && (
                        <button onClick={detenerLectura} className="btn-detener" title="Detener lectura">
                          ‚èπÔ∏è Detener
                        </button>
                      )}
                    </>
                  ) : (
                    <>
                      <button onClick={guardarDocumento} className="btn-guardar" title="Guardar cambios">
                        üíæ Guardar
                      </button>
                      <button onClick={cancelarEdicionDocumento} className="btn-cancelar" title="Cancelar edici√≥n">
                        ‚ùå Cancelar
                      </button>
                    </>
                  )}
                  <button onClick={cerrarVisor} className="btn-close">‚úï</button>
                </div>
              </div>
              <div className="modal-body">
                {!modoEdicion ? (
                  <pre className="documento-contenido">
                    {posicionLectura.inicio > 0 ? (
                      <>
                        {documentoActual.contenido.substring(0, posicionLectura.inicio)}
                        <span className="texto-leyendo">
                          {documentoActual.contenido.substring(posicionLectura.inicio, posicionLectura.fin)}
                        </span>
                        {documentoActual.contenido.substring(posicionLectura.fin)}
                      </>
                    ) : (
                      documentoActual.contenido
                    )}
                  </pre>
                ) : (
                  <textarea 
                    className="documento-editor"
                    value={contenidoEditado}
                    onChange={(e) => setContenidoEditado(e.target.value)}
                    autoFocus
                  />
                )}
              </div>
            </div>
          </div>
        )}

        {selectedMenu === 'generar' && (
          <div className="content-section">
            <h1>üìù Mis Ex√°menes</h1>
            
            {/* Navegaci√≥n de ruta */}
            <div className="ruta-navegacion">
              <button 
                className="btn-ruta"
                onClick={() => cargarCarpetasExamenes('')}
              >
                üè† Ex√°menes
              </button>
              {rutaActualExamenes && rutaActualExamenes.split(/[/\\]/).map((parte, idx, arr) => {
                const rutaParcial = arr.slice(0, idx + 1).join('/')
                return (
                  <span key={idx}>
                    <span className="separador-ruta"> ‚Ä∫ </span>
                    <button 
                      className="btn-ruta"
                      onClick={() => cargarCarpetasExamenes(rutaParcial)}
                    >
                      {parte}
                    </button>
                  </span>
                )
              })}
            </div>

            {loading ? (
              <div className="loading">Cargando ex√°menes...</div>
            ) : (
              <>
                {/* Ex√°menes en Progreso GLOBALES (solo en ra√≠z) */}
                {!rutaActualExamenes && examenesProgresoGlobal.length > 0 && (
                  <div className="examenes-section">
                    <h2>‚è≥ Ex√°menes Pendientes ({examenesProgresoGlobal.length})</h2>
                    <p className="section-hint">Todos tus ex√°menes sin completar de todas las carpetas</p>
                    <div className="examenes-grid">
                      {examenesProgresoGlobal.map((examen, idx) => (
                        <div key={idx} className="examen-card en-progreso">
                          <div className="examen-card-header">
                            <h3>üìù {examen.carpeta_nombre}</h3>
                            <div className="header-badges">
                              <span className="badge badge-warning">En Progreso</span>
                              <button 
                                className="btn-menu-dots"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(menuAbierto === `examen-progreso-global-${idx}` ? null : `examen-progreso-global-${idx}`);
                                }}
                              >
                                ‚ãÆ
                              </button>
                              {menuAbierto === `examen-progreso-global-${idx}` && (
                                <div className="menu-dropdown">
                                  <button onClick={(e) => {
                                    e.stopPropagation();
                                    setMenuAbierto(null);
                                    eliminarExamen(examen, 'progreso');
                                  }} className="btn-menu-eliminar">
                                    üóëÔ∏è Eliminar
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="examen-card-body">
                            <p className="examen-fecha">
                              Iniciado: {new Date(examen.fecha_inicio).toLocaleString('es-ES')}
                            </p>
                            <p className="examen-info">
                              {examen.preguntas.length} preguntas ‚Ä¢ {Object.keys(examen.respuestas || {}).length} respondidas
                            </p>
                            <div className="examen-progreso">
                              <div className="progreso-bar">
                                <div 
                                  className="progreso-fill"
                                  style={{
                                    width: `${(Object.keys(examen.respuestas || {}).length / examen.preguntas.length) * 100}%`
                                  }}
                                ></div>
                              </div>
                              <span className="progreso-texto">
                                {Math.round((Object.keys(examen.respuestas || {}).length / examen.preguntas.length) * 100)}% completado
                              </span>
                            </div>
                          </div>
                          <div className="examen-card-actions">
                            <button 
                              className="btn-continuar"
                              onClick={() => continuarExamen(examen)}
                            >
                              ‚ñ∂Ô∏è Continuar
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Carpetas */}
                {carpetasExamenes.length > 0 && (
                  <div className="carpetas-section">
                    <h2>üìÅ Carpetas</h2>
                    <div className="carpetas-grid">
                      {carpetasExamenes.map((carpeta, idx) => (
                        <div 
                          key={idx}
                          className="carpeta-card"
                        >
                          <div 
                            className="carpeta-card-clickable"
                            onClick={() => cargarCarpetasExamenes(carpeta.ruta)}
                          >
                            <div className="carpeta-card-icon">üìÅ</div>
                            <div className="carpeta-card-content">
                              <h4>{carpeta.nombre}</h4>
                              {carpeta.total_examenes > 0 ? (
                                <p className="carpeta-stats">
                                  {carpeta.num_completados > 0 && (
                                    <span className="stat-badge completado">
                                      ‚úÖ {carpeta.num_completados}
                                    </span>
                                  )}
                                  {carpeta.num_progreso > 0 && (
                                    <span className="stat-badge progreso">
                                      ‚è≥ {carpeta.num_progreso}
                                    </span>
                                  )}
                                </p>
                              ) : (
                                <p className="carpeta-stats">
                                  <span className="stat-badge vacio">Sin ex√°menes</span>
                                </p>
                              )}
                            </div>
                          </div>
                          <div className="carpeta-menu">
                            <button 
                              className="btn-menu-dots"
                              onClick={(e) => {
                                e.stopPropagation();
                                setMenuAbierto(menuAbierto === `carpeta-examen-${idx}` ? null : `carpeta-examen-${idx}`);
                              }}
                            >
                              ‚ãÆ
                            </button>
                            {menuAbierto === `carpeta-examen-${idx}` && (
                              <div className="menu-dropdown">
                                <button onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(null);
                                  eliminarCarpetaExamenes(carpeta.ruta, carpeta.nombre);
                                }} className="btn-menu-eliminar">
                                  üóëÔ∏è Eliminar
                                </button>
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Ex√°menes en Progreso en esta carpeta */}
                {examenesProgreso.length > 0 && (
                  <div className="examenes-section">
                    <h2>‚è≥ Por Completar ({examenesProgreso.length})</h2>
                    <div className="examenes-grid">
                      {examenesProgreso.map((examen, idx) => (
                        <div key={idx} className="examen-card en-progreso">
                          <div className="examen-card-header">
                            <h3>üìù {examen.carpeta_nombre}</h3>
                            <div className="header-badges">
                              <span className="badge badge-warning">En Progreso</span>
                              <button 
                                className="btn-menu-dots"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(menuAbierto === `examen-progreso-${idx}` ? null : `examen-progreso-${idx}`);
                                }}
                              >
                                ‚ãÆ
                              </button>
                              {menuAbierto === `examen-progreso-${idx}` && (
                                <div className="menu-dropdown">
                                  <button onClick={(e) => {
                                    e.stopPropagation();
                                    setMenuAbierto(null);
                                    eliminarExamen(examen, 'progreso');
                                  }} className="btn-menu-eliminar">
                                    üóëÔ∏è Eliminar
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="examen-card-body">
                            <p className="examen-fecha">
                              Iniciado: {new Date(examen.fecha_inicio).toLocaleString('es-ES')}
                            </p>
                            <p className="examen-info">
                              {examen.preguntas.length} preguntas ‚Ä¢ {Object.keys(examen.respuestas || {}).length} respondidas
                            </p>
                            <div className="examen-progreso">
                              <div className="progreso-bar">
                                <div 
                                  className="progreso-fill"
                                  style={{
                                    width: `${(Object.keys(examen.respuestas || {}).length / examen.preguntas.length) * 100}%`
                                  }}
                                ></div>
                              </div>
                              <span className="progreso-texto">
                                {Math.round((Object.keys(examen.respuestas || {}).length / examen.preguntas.length) * 100)}% completado
                              </span>
                            </div>
                          </div>
                          <div className="examen-card-actions">
                            <button 
                              className="btn-continuar"
                              onClick={() => continuarExamen(examen)}
                            >
                              ‚ñ∂Ô∏è Continuar
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Ex√°menes Completados en esta carpeta */}
                {examenesCompletados.length > 0 && (
                  <div className="examenes-section">
                    <h2>‚úÖ Completados ({examenesCompletados.length})</h2>
                    <div className="examenes-grid">
                      {examenesCompletados.map((examen, idx) => (
                        <div key={idx} className="examen-card completado">
                          <div className="examen-card-header">
                            <h3>üìù {examen.carpeta_nombre}</h3>
                            <div className="header-badges">
                              <span 
                                className={`badge ${
                                  examen.porcentaje >= 70 ? 'badge-success' : 
                                  examen.porcentaje >= 50 ? 'badge-warning' : 
                                  'badge-danger'
                                }`}
                              >
                                {examen.porcentaje.toFixed(1)}%
                              </span>
                              <button 
                                className="btn-menu-dots"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  setMenuAbierto(menuAbierto === `examen-completado-${idx}` ? null : `examen-completado-${idx}`);
                                }}
                              >
                                ‚ãÆ
                              </button>
                              {menuAbierto === `examen-completado-${idx}` && (
                                <div className="menu-dropdown">
                                  <button onClick={(e) => {
                                    e.stopPropagation();
                                    setMenuAbierto(null);
                                    eliminarExamen(examen, 'completado');
                                  }} className="btn-menu-eliminar">
                                    üóëÔ∏è Eliminar
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                          <div className="examen-card-body">
                            <p className="examen-fecha">
                              Completado: {new Date(examen.fecha_completado).toLocaleString('es-ES')}
                            </p>
                            <div className="examen-resultado">
                              <div className="resultado-item">
                                <span className="resultado-label">Puntuaci√≥n:</span>
                                <span className="resultado-valor">
                                  {examen.puntos_obtenidos} / {examen.puntos_totales}
                                </span>
                              </div>
                              <div className="resultado-item">
                                <span className="resultado-label">Estado:</span>
                                <span className={`resultado-estado ${
                                  examen.porcentaje >= 70 ? 'aprobado' : 
                                  examen.porcentaje >= 50 ? 'regular' : 
                                  'reprobado'
                                }`}>
                                  {examen.porcentaje >= 70 ? '‚úÖ Aprobado' : 
                                   examen.porcentaje >= 50 ? '‚ö†Ô∏è Regular' : 
                                   '‚ùå Reprobado'}
                                </span>
                              </div>
                            </div>
                          </div>
                          <div className="examen-card-actions">
                            <button 
                              className="btn-ver-resultado"
                              onClick={() => verResultadoExamen(examen)}
                            >
                              üëÅÔ∏è Ver Detalles
                            </button>
                            <button 
                              className="btn-reintentar"
                              onClick={() => reintentarExamen(examen)}
                            >
                              üîÑ Reintentar
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Mensaje cuando no hay nada */}
                {carpetasExamenes.length === 0 && examenesCompletados.length === 0 && examenesProgreso.length === 0 && (
                  <div className="no-data">
                    <p>üì≠ No hay ex√°menes en esta carpeta</p>
                    <p className="hint">Ve a Cursos y genera un examen desde una carpeta</p>
                  </div>
                )}
              </>
            )}
          </div>
        )}

        {selectedMenu === 'historial' && (
          <div className="content-section">
            <h1>üìÖ Calendario de Repasos</h1>
            
            {/* Calendario de Repasos */}
            <div className="calendario-repasos">
              <h2>üîî Pr√≥ximos Repasos Programados</h2>
              
              {(() => {
                // Usar datos del estado cargados por useEffect
                const { flashcards, notas, practicas, examenes } = datosCalendarioRepasos;
                
                // IMPORTANTE: Mostrar estad√≠sticas de TODOS los items
                const totalFlashcards = flashcards.length;
                const totalNotas = notas.length;
                const totalPracticas = practicas.length;
                const totalExamenes = examenes.length;
                const totalItems = totalFlashcards + totalNotas + totalPracticas + totalExamenes;
                
                // Separar items CON pr√≥xima revisi√≥n de los NUEVOS (sin revisi√≥n programada)
                const flashcardsConRevision = flashcards.filter(f => f.proximaRevision);
                const notasConRevision = notas.filter(n => n.proximaRevision);
                const practicasConRevision = practicas.filter(p => p.proximaRevision);
                const examenesConRevision = examenes.filter(e => e.proximaRevision);
                
                const flashcardsNuevas = flashcards.filter(f => !f.proximaRevision);
                const notasNuevas = notas.filter(n => !n.proximaRevision);
                const practicasNuevas = practicas.filter(p => !p.proximaRevision);
                const examenesNuevos = examenes.filter(e => !e.proximaRevision);
                
                // Combinar y mapear a formato com√∫n - INCLUIR TODOS
                let todosLosItems = [
                  ...flashcards.map(f => ({ 
                    ...f, 
                    tipo: 'üé¥ Flashcard', 
                    tipoInterno: 'flashcard',
                    titulo: f.titulo || f.pregunta || 'Flashcard sin t√≠tulo'
                  })),
                  ...notas.map(n => ({ 
                    ...n, 
                    tipo: 'üìù Nota', 
                    tipoInterno: 'nota',
                    titulo: n.titulo || 'Nota sin t√≠tulo'
                  })),
                  ...practicas.map(p => ({ 
                    ...p, 
                    tipo: 'üéØ Pr√°ctica', 
                    tipoInterno: 'practica',
                    titulo: p.titulo || p.nombre || 'Pr√°ctica sin t√≠tulo'
                  })),
                  ...examenes.map(e => ({ 
                    ...e, 
                    tipo: 'üìã Examen', 
                    tipoInterno: 'examen',
                    titulo: e.titulo || e.nombre || 'Examen sin t√≠tulo'
                  }))
                ];
                
                // Aplicar filtro por tipo
                if (filtroTipoHistorial !== 'todos') {
                  todosLosItems = todosLosItems.filter(item => item.tipoInterno === filtroTipoHistorial);
                }
                
                // Separar items con revisi√≥n programada vs items nuevos
                const itemsConRevision = todosLosItems.filter(item => item.proximaRevision);
                const itemsNuevos = todosLosItems.filter(item => !item.proximaRevision);
                
                // Agrupar items CON REVISI√ìN por fecha
                const itemsPorFecha = itemsConRevision.reduce((acc, item) => {
                  const fecha = new Date(item.proximaRevision);
                  const fechaKey = fecha.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                  });
                  
                  if (!acc[fechaKey]) {
                    acc[fechaKey] = {
                      fecha: fecha,
                      fechaTexto: fechaKey,
                      items: []
                    };
                  }
                  acc[fechaKey].items.push(item);
                  return acc;
                }, {});
                
                // Ordenar por fecha seg√∫n el rango seleccionado
                const ahora = new Date();
                const fechaLimite = new Date(ahora.getTime() + rangoVistaHistorial * 24 * 60 * 60 * 1000);
                
                const diasOrdenados = Object.values(itemsPorFecha)
                  .filter(dia => dia.fecha >= ahora && dia.fecha <= fechaLimite)
                  .sort((a, b) => a.fecha - b.fecha);
                
                // Estad√≠sticas generales (solo items con revisi√≥n programada)
                const estadisticas = {
                  hoy: itemsConRevision.filter(i => {
                    const fecha = new Date(i.proximaRevision);
                    return fecha.toDateString() === ahora.toDateString();
                  }).length,
                  estaSemana: itemsConRevision.filter(i => {
                    const fecha = new Date(i.proximaRevision);
                    const diff = Math.ceil((fecha - ahora) / (1000 * 60 * 60 * 24));
                    return diff >= 0 && diff <= 7;
                  }).length,
                  esteMes: itemsConRevision.filter(i => {
                    const fecha = new Date(i.proximaRevision);
                    const diff = Math.ceil((fecha - ahora) / (1000 * 60 * 60 * 24));
                    return diff >= 0 && diff <= 30;
                  }).length,
                  proximos90Dias: itemsConRevision.filter(i => {
                    const fecha = new Date(i.proximaRevision);
                    const diff = Math.ceil((fecha - ahora) / (1000 * 60 * 60 * 24));
                    return diff >= 0 && diff <= 90;
                  }).length,
                  nuevos: itemsNuevos.length,
                  conRevision: itemsConRevision.length
                };
                
                // Calcular distribuci√≥n por semana (para gr√°fico)
                const distribucionSemanal = [];
                for (let semana = 0; semana < Math.ceil(rangoVistaHistorial / 7); semana++) {
                  const inicioSemana = new Date(ahora.getTime() + semana * 7 * 24 * 60 * 60 * 1000);
                  const finSemana = new Date(inicioSemana.getTime() + 7 * 24 * 60 * 60 * 1000);
                  
                  const itemsEnSemana = itemsConRevision.filter(i => {
                    const fecha = new Date(i.proximaRevision);
                    return fecha >= inicioSemana && fecha < finSemana;
                  }).length;
                  
                  distribucionSemanal.push({
                    semana: semana + 1,
                    items: itemsEnSemana,
                    inicio: inicioSemana,
                    fin: finSemana
                  });
                }
                
                return (
                  <>
                    {/* Informaci√≥n sobre el sistema */}
                    <div className="info-calendario">
                      <div className="info-icono">üìö</div>
                      <div className="info-contenido">
                        <h3>Total de Items en el Sistema</h3>
                        <p>
                          <strong>üé¥ Flashcards:</strong> {totalFlashcards} total ({flashcardsConRevision.length} con revisi√≥n programada, {flashcardsNuevas.length} nuevas) ‚Ä¢ 
                          <strong>üìù Notas:</strong> {totalNotas} total ({notasConRevision.length} con revisi√≥n, {notasNuevas.length} nuevas) ‚Ä¢ 
                          <strong>üéØ Pr√°cticas:</strong> {totalPracticas} total ({practicasConRevision.length} con revisi√≥n, {practicasNuevas.length} nuevas) ‚Ä¢ 
                          <strong>üìã Ex√°menes:</strong> {totalExamenes} total ({examenesConRevision.length} con revisi√≥n, {examenesNuevos.length} nuevos)
                        </p>
                        <p className="info-nota">
                          üí° Los items nuevos (sin revisi√≥n programada) aparecer√°n en el calendario despu√©s de su primera evaluaci√≥n.
                          Los ex√°menes se guardan autom√°ticamente al completarlos y se programan para revisi√≥n ma√±ana.
                        </p>
                      </div>
                    </div>

                    {/* Mini Calendario Visual */}
                    <div className="mini-calendario-wrapper">
                      <h3 className="mini-calendario-titulo">üìÖ Vista de Calendario</h3>
                      
                      <div className="mini-calendario-compacto">
                        <div className="calendario-nav">
                          <button 
                            className="btn-nav-cal"
                            onClick={() => {
                              if (mesCalendario === 0) {
                                setMesCalendario(11);
                                setAnioCalendario(anioCalendario - 1);
                              } else {
                                setMesCalendario(mesCalendario - 1);
                              }
                            }}
                          >
                            ‚Äπ
                          </button>
                          <span className="mes-actual">
                            {new Date(anioCalendario, mesCalendario).toLocaleDateString('es-ES', { 
                              month: 'long', 
                              year: 'numeric' 
                            })}
                          </span>
                          <button 
                            className="btn-nav-cal"
                            onClick={() => {
                              if (mesCalendario === 11) {
                                setMesCalendario(0);
                                setAnioCalendario(anioCalendario + 1);
                              } else {
                                setMesCalendario(mesCalendario + 1);
                              }
                            }}
                          >
                            ‚Ä∫
                          </button>
                        </div>

                        <div className="calendario-grid-compacto">
                          {/* Cabecera */}
                          {['L', 'M', 'X', 'J', 'V', 'S', 'D'].map(dia => (
                            <div key={dia} className="cal-header">{dia}</div>
                          ))}
                          
                          {(() => {
                            const primerDia = new Date(anioCalendario, mesCalendario, 1);
                            const ultimoDia = new Date(anioCalendario, mesCalendario + 1, 0);
                            const diasEnMes = ultimoDia.getDate();
                            
                            let primerDiaSemana = primerDia.getDay();
                            primerDiaSemana = primerDiaSemana === 0 ? 6 : primerDiaSemana - 1;
                            
                            const dias = [];
                            const hoy = new Date();
                            hoy.setHours(0, 0, 0, 0);
                            
                            // D√≠as vac√≠os
                            for (let i = 0; i < primerDiaSemana; i++) {
                              dias.push(<div key={`vacio-${i}`} className="cal-dia-vacio"></div>);
                            }
                            
                            // D√≠as del mes
                            for (let dia = 1; dia <= diasEnMes; dia++) {
                              const fechaDia = new Date(anioCalendario, mesCalendario, dia);
                              fechaDia.setHours(0, 0, 0, 0);
                              
                              // Contar items para este d√≠a (CON Y SIN proximaRevision)
                              const itemsEnDia = todosLosItems.filter(item => {
                                if (item.proximaRevision) {
                                  const fechaItem = new Date(item.proximaRevision);
                                  fechaItem.setHours(0, 0, 0, 0);
                                  return fechaItem.getTime() === fechaDia.getTime();
                                }
                                // Si no tiene proximaRevision, mostrar en "hoy" como pendiente
                                if (!item.proximaRevision && fechaDia.getTime() === hoy.getTime()) {
                                  return true;
                                }
                                return false;
                              });
                              
                              const esHoy = fechaDia.getTime() === hoy.getTime();
                              const esFechaSeleccionada = fechaSeleccionada && 
                                fechaDia.getTime() === new Date(fechaSeleccionada).getTime();
                              const tieneItems = itemsEnDia.length > 0;
                              
                              dias.push(
                                <div 
                                  key={dia}
                                  className={`cal-dia ${esHoy ? 'es-hoy' : ''} ${esFechaSeleccionada ? 'seleccionado' : ''} ${tieneItems ? 'tiene-items' : ''}`}
                                  onClick={() => {
                                    if (tieneItems) {
                                      setFechaSeleccionada(fechaDia.toISOString());
                                    }
                                  }}
                                >
                                  <span>{dia}</span>
                                  {tieneItems && <span className="cal-dot">{itemsEnDia.length}</span>}
                                </div>
                              );
                            }
                            
                            return dias;
                          })()}
                        </div>
                      </div>

                      {/* Detalles de fecha seleccionada */}
                      {fechaSeleccionada && (() => {
                        const fechaSel = new Date(fechaSeleccionada);
                        fechaSel.setHours(0, 0, 0, 0);
                        const hoy = new Date();
                        hoy.setHours(0, 0, 0, 0);
                        
                        const itemsDelDia = todosLosItems.filter(item => {
                          if (item.proximaRevision) {
                            const fechaItem = new Date(item.proximaRevision);
                            fechaItem.setHours(0, 0, 0, 0);
                            return fechaItem.getTime() === fechaSel.getTime();
                          }
                          // Items sin proximaRevision en "hoy"
                          if (!item.proximaRevision && fechaSel.getTime() === hoy.getTime()) {
                            return true;
                          }
                          return false;
                        });
                        
                        if (itemsDelDia.length === 0) return null;
                        
                        return (
                          <div className="detalle-fecha">
                            <div className="detalle-header">
                              <span>
                                {new Date(fechaSeleccionada).toLocaleDateString('es-ES', { 
                                  weekday: 'long', 
                                  day: 'numeric', 
                                  month: 'long'
                                })}
                              </span>
                              <button onClick={() => setFechaSeleccionada(null)}>‚úï</button>
                            </div>
                            <div className="detalle-lista">
                              {itemsDelDia.map((item, idx) => (
                                <div 
                                  key={idx} 
                                  className="detalle-item"
                                  onClick={() => setItemMapaRepeticion(item)}
                                >
                                  <span className="item-icono">{item.tipo.split(' ')[0]}</span>
                                  <div className="item-texto">
                                    <div className="item-nombre">{item.titulo}</div>
                                    <div className="item-stats">
                                      {item.proximaRevision ? (
                                        <>
                                          <span>üìÖ {item.intervalo || 0}d</span>
                                          <span>‚ö° {(item.facilidad || 2.5).toFixed(1)}</span>
                                          <span>üëÅÔ∏è {item.repeticiones || 0}√ó</span>
                                        </>
                                      ) : (
                                        <span className="pendiente-badge">üÜï Pendiente de evaluar</span>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        );
                      })()}
                    </div>

                    {/* Controles de Filtro */}
                    <div className="controles-calendario">
                      <div className="filtro-tipo">
                        <label>üìã Tipo de Contenido:</label>
                        <div className="botones-filtro">
                          <button 
                            className={`btn-filtro ${filtroTipoHistorial === 'todos' ? 'activo' : ''}`}
                            onClick={() => setFiltroTipoHistorial('todos')}
                          >
                            Todos ({totalItems})
                          </button>
                          <button 
                            className={`btn-filtro ${filtroTipoHistorial === 'flashcard' ? 'activo' : ''}`}
                            onClick={() => setFiltroTipoHistorial('flashcard')}
                          >
                            üé¥ Flashcards ({totalFlashcards})
                          </button>
                          <button 
                            className={`btn-filtro ${filtroTipoHistorial === 'nota' ? 'activo' : ''}`}
                            onClick={() => setFiltroTipoHistorial('nota')}
                          >
                            üìù Notas ({totalNotas})
                          </button>
                          <button 
                            className={`btn-filtro ${filtroTipoHistorial === 'practica' ? 'activo' : ''}`}
                            onClick={() => setFiltroTipoHistorial('practica')}
                          >
                            üéØ Pr√°cticas ({totalPracticas})
                          </button>
                        </div>
                      </div>
                      
                      <div className="filtro-rango">
                        <label>üìÜ Rango de Tiempo:</label>
                        <div className="botones-filtro">
                          <button 
                            className={`btn-filtro ${rangoVistaHistorial === 30 ? 'activo' : ''}`}
                            onClick={() => setRangoVistaHistorial(30)}
                          >
                            30 d√≠as
                          </button>
                          <button 
                            className={`btn-filtro ${rangoVistaHistorial === 60 ? 'activo' : ''}`}
                            onClick={() => setRangoVistaHistorial(60)}
                          >
                            60 d√≠as
                          </button>
                          <button 
                            className={`btn-filtro ${rangoVistaHistorial === 90 ? 'activo' : ''}`}
                            onClick={() => setRangoVistaHistorial(90)}
                          >
                            90 d√≠as
                          </button>
                        </div>
                      </div>
                    </div>

                    {/* Resumen de Estad√≠sticas */}
                    <div className="resumen-repasos">
                      <div className="stat-repaso">
                        <div className="stat-repaso-icon">üÜï</div>
                        <div className="stat-repaso-content">
                          <div className="stat-repaso-value">{estadisticas.nuevos}</div>
                          <div className="stat-repaso-label">Sin Programar</div>
                        </div>
                      </div>
                      <div className="stat-repaso">
                        <div className="stat-repaso-icon">‚è∞</div>
                        <div className="stat-repaso-content">
                          <div className="stat-repaso-value">{estadisticas.hoy}</div>
                          <div className="stat-repaso-label">Para Hoy</div>
                        </div>
                      </div>
                      <div className="stat-repaso">
                        <div className="stat-repaso-icon">üìÖ</div>
                        <div className="stat-repaso-content">
                          <div className="stat-repaso-value">{estadisticas.estaSemana}</div>
                          <div className="stat-repaso-label">Esta Semana</div>
                        </div>
                      </div>
                      <div className="stat-repaso">
                        <div className="stat-repaso-icon">üìÜ</div>
                        <div className="stat-repaso-content">
                          <div className="stat-repaso-value">{estadisticas.esteMes}</div>
                          <div className="stat-repaso-label">Este Mes</div>
                        </div>
                      </div>
                      <div className="stat-repaso">
                        <div className="stat-repaso-icon">üéØ</div>
                        <div className="stat-repaso-content">
                          <div className="stat-repaso-value">{estadisticas.proximos90Dias}</div>
                          <div className="stat-repaso-label">Pr√≥ximos 90 D√≠as</div>
                        </div>
                      </div>
                    </div>
                    
                    {/* Gr√°fico de Distribuci√≥n Semanal */}
                    <div className="distribucion-semanal">
                      <h3>üìä Distribuci√≥n de Repasos por Semana</h3>
                      <div className="grafico-barras">
                        {distribucionSemanal.map((sem, idx) => {
                          const maxItems = Math.max(...distribucionSemanal.map(s => s.items), 1);
                          const alturaPorcentaje = (sem.items / maxItems) * 100;
                          
                          return (
                            <div key={idx} className="barra-semana">
                              <div className="barra-contenido">
                                <div 
                                  className="barra-fill" 
                                  style={{ height: `${alturaPorcentaje}%` }}
                                  title={`Semana ${sem.semana}: ${sem.items} items`}
                                >
                                  {sem.items > 0 && <span className="barra-valor">{sem.items}</span>}
                                </div>
                              </div>
                              <div className="barra-label">S{sem.semana}</div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                    
                    {/* Lista de D√≠as con Repasos */}
                    {diasOrdenados.length > 0 ? (
                      <div className="lista-dias-repaso">
                        {diasOrdenados.map((dia, idx) => {
                          const esHoy = dia.fecha.toDateString() === ahora.toDateString();
                          const diasHasta = Math.ceil((dia.fecha - ahora) / (1000 * 60 * 60 * 24));
                          
                          return (
                            <div key={idx} className={`dia-repaso ${esHoy ? 'dia-repaso-hoy' : ''}`}>
                              <div className="dia-repaso-header">
                                <h3>{esHoy ? '‚è∞ HOY' : dia.fechaTexto}</h3>
                                {!esHoy && (
                                  <span className="dias-hasta">En {diasHasta} d√≠a{diasHasta !== 1 ? 's' : ''}</span>
                                )}
                                <span className="total-items">{dia.items.length} item{dia.items.length !== 1 ? 's' : ''}</span>
                              </div>
                              
                              <div className="items-repaso-lista">
                                {dia.items.slice(0, 10).map((item, itemIdx) => {
                                  // Calcular intervalo de repetici√≥n
                                  const intervaloTexto = item.intervalo ? 
                                    (item.intervalo === 1 ? '1 d√≠a' : 
                                     item.intervalo < 7 ? `${item.intervalo} d√≠as` :
                                     item.intervalo < 30 ? `${Math.round(item.intervalo / 7)} semanas` :
                                     `${Math.round(item.intervalo / 30)} meses`) : 
                                    'Primera vez';
                                  
                                  return (
                                    <div 
                                      key={itemIdx} 
                                      className="item-repaso item-repaso-clickable"
                                      onClick={() => setItemMapaRepeticion(item)}
                                      title="Clic para ver mapa de repeticiones"
                                    >
                                      <span className="item-repaso-tipo">{item.tipo}</span>
                                      <span className="item-repaso-titulo">{item.titulo || 'Sin t√≠tulo'}</span>
                                      <div className="item-repaso-info">
                                        <span className="item-repaso-intervalo" title="Intervalo de repetici√≥n">
                                          üîÅ {intervaloTexto}
                                        </span>
                                        <span className={`item-repaso-estado estado-${item.estadoRevision || 'nueva'}`}>
                                          {item.estadoRevision === 'nueva' && 'üÜï'}
                                          {item.estadoRevision === 'en_progreso' && 'üìñ'}
                                          {item.estadoRevision === 'dominada' && '‚úÖ'}
                                          {' '}
                                          {item.repeticiones || 0}√ó visto
                                        </span>
                                        <span className="item-repaso-facilidad" title="Factor de facilidad">
                                          ‚ö° {(item.facilidad || 2.5).toFixed(1)}
                                        </span>
                                      </div>
                                    </div>
                                  );
                                })}
                                {dia.items.length > 10 && (
                                  <div className="items-mas">
                                    + {dia.items.length - 10} m√°s...
                                  </div>
                                )}
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    ) : (
                      <div className="empty-state">
                        <div className="empty-icon">üìÖ</div>
                        <h3>Sin Repasos Programados</h3>
                        <p>No hay items con revisi√≥n programada para los pr√≥ximos {rangoVistaHistorial} d√≠as</p>
                      </div>
                    )}
                    
                    {/* Secci√≥n de Items Nuevos (sin revisi√≥n programada) */}
                    {itemsNuevos.length > 0 && (
                      <div className="items-nuevos-seccion">
                        <h3>üÜï Items Pendientes de Primera Evaluaci√≥n ({itemsNuevos.length})</h3>
                        <p className="items-nuevos-descripcion">
                          Estos items a√∫n no han sido evaluados. Ve a la pesta√±a correspondiente para revisarlos
                          y programar su repetici√≥n espaciada.
                        </p>
                        <div className="lista-items-nuevos">
                          {itemsNuevos.slice(0, 20).map((item, idx) => (
                            <div 
                              key={idx} 
                              className="item-nuevo-card"
                              onClick={() => setItemMapaRepeticion(item)}
                              title="Clic para ver proyecci√≥n de repeticiones"
                            >
                              <span className="item-nuevo-tipo">{item.tipo}</span>
                              <span className="item-nuevo-titulo">{item.titulo || item.contenido?.substring(0, 50) || 'Sin t√≠tulo'}...</span>
                              <span className="item-nuevo-badge">Nuevo</span>
                            </div>
                          ))}
                          {itemsNuevos.length > 20 && (
                            <div className="items-nuevos-mas">
                              + {itemsNuevos.length - 20} items m√°s sin evaluar
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </>
                );
              })()}
            </div>
            
            <div style={{height: '2rem'}}></div>
            <hr style={{border: 'none', borderTop: '1px solid rgba(100, 108, 255, 0.2)', margin: '2rem 0'}} />
            
            <h2>üìö Historial de Ex√°menes</h2>
            <p>Revisa los ex√°menes generados anteriormente...</p>
          </div>
        )}

        {selectedMenu === 'buscar' && (
          <div className="content-section buscador-container">
            <h1>üîç B√∫squeda Inteligente con IA</h1>
            
            {/* Estado del Sistema */}
            {estadoIndice && (
              <div className="buscador-estado">
                <div className="estado-item">
                  <span className="estado-label">üìä Estado:</span>
                  <span className={`estado-valor ${estadoIndice.indexado ? 'online' : 'offline'}`}>
                    {estadoIndice.indexado ? '‚úÖ Listo' : '‚ö†Ô∏è Sin indexar'}
                  </span>
                </div>
                <div className="estado-item">
                  <span className="estado-label">üìÅ Archivos:</span>
                  <span className="estado-valor">{estadoIndice.total_archivos || 0}</span>
                </div>
                <div className="estado-item">
                  <span className="estado-label">üìÑ Fragmentos:</span>
                  <span className="estado-valor">{estadoIndice.total_chunks || 0}</span>
                </div>
                <div className="estado-item">
                  <span className="estado-label">ü§ñ Modelo:</span>
                  <span className="estado-valor">{estadoIndice.modelo || 'bge-small-en-v1.5'}</span>
                </div>
                <div className="estado-item">
                  <span className="estado-label">‚ö° GPU:</span>
                  <span className="estado-valor">{estadoIndice.gpu_disponible ? '‚úÖ Activa' : '‚ùå CPU'}</span>
                </div>
              </div>
            )}

            {/* Barra de b√∫squeda */}
            <div className="buscador-barra">
              <input
                type="text"
                value={queryBusqueda}
                onChange={(e) => setQueryBusqueda(e.target.value)}
                onKeyPress={(e) => e.key === 'Enter' && buscarConIA()}
                placeholder="üîé Busca en tus notas, flashcards, ex√°menes, pr√°cticas..."
                className="buscador-input"
                disabled={buscando}
              />
              <button 
                onClick={buscarConIA} 
                className="btn-primary"
                disabled={buscando || !queryBusqueda.trim()}
              >
                {buscando ? 'üîÑ Buscando...' : 'üîç Buscar'}
              </button>
            </div>

            {/* Filtros */}
            <div className="buscador-filtros">
              <label style={{marginRight: '1rem', fontWeight: 'bold'}}>üè∑Ô∏è Tipo de documento:</label>
              {['todos', 'nota', 'flashcard', 'examen', 'practica', 'curso', 'documento'].map(tipo => (
                <button
                  key={tipo}
                  onClick={() => setFiltroBusquedaTipo(tipo)}
                  className={`filtro-tipo ${filtroBusquedaTipo === tipo ? 'active' : ''}`}
                >
                  {tipo === 'todos' ? 'üåê Todos' :
                   tipo === 'nota' ? 'üìù Notas' :
                   tipo === 'flashcard' ? 'üé¥ Flashcards' :
                   tipo === 'examen' ? 'üìã Ex√°menes' :
                   tipo === 'practica' ? 'üéØ Pr√°cticas' :
                   tipo === 'curso' ? 'üìö Cursos' : 'üìÑ Documentos'}
                </button>
              ))}
            </div>

            {/* Acciones del √≠ndice */}
            <div className="buscador-acciones">
              <button 
                onClick={() => actualizarIndice(false)} 
                className="btn-secondary"
                disabled={actualizandoIndice}
              >
                {actualizandoIndice ? '‚è≥ Actualizando...' : 'üîÑ Actualizar √çndice'}
              </button>
              <button 
                onClick={() => actualizarIndice(true)} 
                className="btn-secondary"
                disabled={actualizandoIndice}
              >
                {actualizandoIndice ? '‚è≥ Reindexando...' : '‚ôªÔ∏è Reindexar Todo'}
              </button>
              
              <div style={{flex: 1}}></div>
              
              <span style={{fontSize: '0.9rem', color: '#888'}}>
                üí° B√∫squeda sem√°ntica + palabras clave (h√≠brida)
              </span>
            </div>

            {/* Resultados */}
            {resultadosBusqueda.length > 0 && (
              <div className="resultados-buscador">
                <h2>üìã Resultados ({resultadosBusqueda.length})</h2>
                
                <div className="resultados-lista">
                  {resultadosBusqueda.map((resultado, idx) => {
                    // Determinar el tipo y emoji
                    const tipoConfig = {
                      'nota': { emoji: 'üìù', color: '#22c55e', nombre: 'Nota' },
                      'flashcard': { emoji: 'üÉè', color: '#667eea', nombre: 'Flashcard' },
                      'examen': { emoji: 'üìã', color: '#f59e0b', nombre: 'Examen' },
                      'practica': { emoji: 'üéØ', color: '#ec4899', nombre: 'Pr√°ctica' },
                      'documento': { emoji: 'üìÑ', color: '#3b82f6', nombre: 'Documento' }
                    };
                    const config = tipoConfig[resultado.tipo] || tipoConfig['documento'];
                    
                    // T√≠tulo
                    const titulo = resultado.titulo || resultado.nombre || 'Sin t√≠tulo';
                    
                    // Contenido preview
                    const contenidoLimpio = resultado.contenido?.substring(0, 200) || '';
                    
                    return (
                      <div 
                        key={idx} 
                        className="resultado-busqueda-card" 
                        onClick={() => abrirResultadoBusqueda(resultado)}
                        style={{ cursor: 'pointer', borderLeft: `4px solid ${config.color}` }}
                      >
                        {/* Tipo y T√≠tulo */}
                        <div className="resultado-titulo-archivo" style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                          <span style={{ fontSize: '1.5rem' }}>{config.emoji}</span>
                          <span style={{ fontWeight: '600' }}>{titulo}</span>
                          <span style={{ 
                            background: config.color, 
                            color: 'white', 
                            padding: '0.2rem 0.6rem', 
                            borderRadius: '12px', 
                            fontSize: '0.75rem',
                            marginLeft: 'auto'
                          }}>
                            {config.nombre}
                          </span>
                        </div>
                        
                        {/* Contenido con resaltado */}
                        <div className="resultado-parrafo">
                          {resaltarTexto(contenidoLimpio, queryBusqueda)}...
                        </div>
                        
                        {/* Ruta con bot√≥n de navegaci√≥n */}
                        <div className="resultado-ruta-completa" style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', gap: '0.5rem' }}>
                          <span>üìÅ {resultado.ruta || resultado.carpeta || 'Sin carpeta'}</span>
                          <button
                            className="btn-secondary"
                            onClick={(e) => {
                              e.stopPropagation();
                              irARutaResultado(resultado);
                            }}
                            style={{ fontSize: '0.85rem', padding: '0.3rem 0.8rem' }}
                          >
                            üìç Ir a esta ruta
                          </button>
                        </div>
                        
                        {/* Relevancia */}
                        {resultado.relevancia && (
                          <div className="resultado-score-badge">
                            Relevancia: {resultado.relevancia * 10}%
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            )}

            {/* Estado vac√≠o */}
            {!buscando && resultadosBusqueda.length === 0 && queryBusqueda.trim() === '' && (
              <div className="buscador-vacio">
                <div style={{fontSize: '4rem', marginBottom: '1rem'}}>üîç</div>
                <h3>B√∫squeda Inteligente con IA</h3>
                <p>Encuentra cualquier contenido en tus documentos usando lenguaje natural.</p>
                
                <div className="ejemplos-busqueda">
                  <h4>üí° Ejemplos de b√∫squeda:</h4>
                  <ul>
                    <li>"¬øQu√© es una funci√≥n recursiva?"</li>
                    <li>"Conceptos de machine learning"</li>
                    <li>"Ejercicios de c√°lculo diferencial"</li>
                    <li>"Notas sobre React hooks"</li>
                    <li>"Flashcards de historia del arte"</li>
                  </ul>
                </div>

                <div className="info-tecnica">
                  <h4>ü§ñ Tecnolog√≠a:</h4>
                  <ul>
                    <li>‚úÖ B√∫squeda sem√°ntica con embeddings locales</li>
                    <li>‚úÖ B√∫squeda por palabras clave (BM25)</li>
                    <li>‚úÖ H√≠brido: combina ambos m√©todos</li>
                    <li>‚úÖ GPU acelerada (RTX 4050)</li>
                    <li>‚úÖ 100% local, sin APIs de pago</li>
                    <li>‚úÖ Actualizaci√≥n incremental del √≠ndice</li>
                  </ul>
                </div>

                {!estadoIndice?.indexado && (
                  <div className="alerta-info">
                    ‚ö†Ô∏è <strong>Primera vez:</strong> Debes crear el √≠ndice inicial.
                    <br/>
                    Ejecuta en terminal: <code>python crear_indice_inicial.py</code>
                  </div>
                )}
              </div>
            )}

            {/* Sin resultados */}
            {!buscando && resultadosBusqueda.length === 0 && queryBusqueda.trim() !== '' && (
              <div className="buscador-sin-resultados">
                <div style={{fontSize: '3rem', marginBottom: '1rem'}}>üòï</div>
                <h3>No se encontraron resultados</h3>
                <p>Intenta con otras palabras clave o aseg√∫rate de que el contenido est√© indexado.</p>
                <button onClick={() => actualizarIndice(false)} className="btn-primary">
                  üîÑ Actualizar √çndice
                </button>
              </div>
            )}
          </div>
        )}

        {selectedMenu === 'notas' && (() => {
          console.log('üéØ RENDERIZANDO SECCI√ìN DE NOTAS');
          console.log('üìä Estado actual:', {
            notasGuardadas: notasGuardadas?.length || 0,
            carpetasNotas: carpetasNotas?.length || 0,
            rutaNotasActual: rutaNotasActual
          });
          return (
          <div className="content-section">
            <div className="section-header">
              <h1>üìì Mis Notas</h1>
              <button className="btn-primary" onClick={crearNuevaNota}>
                ‚ûï Nueva Nota
              </button>
            </div>

            {/* Breadcrumb de navegaci√≥n */}
            <div className="breadcrumb">
              <button onClick={() => setRutaNotasActual('')} className="breadcrumb-item">
                üè† Inicio
              </button>
              {rutaNotasActual && rutaNotasActual.split('\\').filter(Boolean).map((parte, idx, arr) => {
                const rutaParcial = arr.slice(0, idx + 1).join('\\');
                return (
                  <span key={idx}>
                    <span className="breadcrumb-separator">/</span>
                    <button onClick={() => {
                      setRutaNotasActual(rutaParcial);
                      cargarCarpetasNotas(rutaParcial);
                    }} className="breadcrumb-item">
                      {parte}
                    </button>
                  </span>
                );
              })}
              {rutaNotasActual && (
                <button 
                  onClick={() => {
                    const partes = rutaNotasActual.split('\\').filter(Boolean);
                    partes.pop();
                    const rutaPadre = partes.join('\\');
                    setRutaNotasActual(rutaPadre);
                    cargarCarpetasNotas(rutaPadre);
                  }}
                  className="btn-volver"
                  style={{marginLeft: '1rem'}}
                >
                  ‚Üê Volver
                </button>
              )}
            </div>

            {/* Carpetas */}
            {carpetasNotas.length > 0 && (
              <div className="carpetas-grid" style={{marginBottom: '2rem'}}>
                {carpetasNotas.map((carpeta, idx) => (
                  <button
                    key={idx}
                    className="carpeta-card"
                    onClick={() => {
                      const nuevaRuta = rutaNotasActual 
                        ? `${rutaNotasActual}\\${carpeta.nombre}`
                        : carpeta.nombre;
                      setRutaNotasActual(nuevaRuta);
                      cargarCarpetasNotas(nuevaRuta);
                    }}
                  >
                    <span className="carpeta-icon">üìÅ</span>
                    <span className="carpeta-nombre">{carpeta.nombre}</span>
                  </button>
                ))}
              </div>
            )}

            {/* Notas filtradas por carpeta actual */}
            {(() => {
              const notasFiltradas = (notasGuardadas || []).filter(nota => 
                (nota.carpeta || '') === rutaNotasActual
              );

              if (notasFiltradas.length === 0 && carpetasNotas.length === 0) {
                return (
                  <div className="empty-state">
                    <div className="empty-icon">üìù</div>
                    <h3>No tienes notas en esta carpeta</h3>
                    <p>Crea tu primera nota para organizar tus apuntes y material de estudio</p>
                    <button className="btn-primary" onClick={crearNuevaNota}>
                      ‚úçÔ∏è Crear Primera Nota
                    </button>
                  </div>
                );
              }

              return (
                <div className="notas-grid">
                  {notasFiltradas.map((nota) => (
                  <div key={nota.id} className="nota-card">
                    <div className="nota-header">
                      <div style={{flex: 1}}>
                        <h3>{nota.titulo}</h3>
                        {nota.carpeta && (
                          <span className="nota-carpeta">üìÅ {nota.carpeta.split('\\').pop() || 'Ra√≠z'}</span>
                        )}
                      </div>
                      <div className="dropdown-nota">
                        <button
                          className="btn-nota-menu"
                          onClick={(e) => {
                            e.stopPropagation();
                            setDropdownNotaAbierto(dropdownNotaAbierto === nota.id ? null : nota.id);
                          }}
                          title="M√°s opciones"
                        >
                          ‚ãÆ
                        </button>
                        <div className={`dropdown-menu-nota ${dropdownNotaAbierto === nota.id ? 'show' : ''}`}>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              exportarNotaTXT(nota);
                              setDropdownNotaAbierto(null);
                            }}
                          >
                            üìÑ Descargar TXT
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              exportarNotaPDF(nota);
                              setDropdownNotaAbierto(null);
                            }}
                          >
                            üìï Exportar como PDF
                          </button>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              exportarNotaTXTCarpeta(nota);
                              setDropdownNotaAbierto(null);
                            }}
                          >
                            üìÅ Guardar TXT en carpeta
                          </button>
                          <button 
                            onClick={(e) => {
                              e.stopPropagation();
                              eliminarNota(nota.id);
                              setDropdownNotaAbierto(null);
                            }}
                            style={{color: '#ef4444', borderTop: '1px solid rgba(255, 255, 255, 0.1)'}}
                          >
                            üóëÔ∏è Eliminar nota
                          </button>
                        </div>
                      </div>
                    </div>
                    
                    <div 
                      className="nota-preview"
                      dangerouslySetInnerHTML={{
                        __html: nota.contenido.length > 200 
                          ? nota.contenido.substring(0, 200) + '...' 
                          : nota.contenido
                      }}
                    />
                    
                    <div className="nota-footer">
                      <span className="nota-fecha">
                        {new Date(nota.fechaModificacion || nota.fecha).toLocaleDateString('es-ES', {
                          day: 'numeric',
                          month: 'short',
                          hour: '2-digit',
                          minute: '2-digit'
                        })}
                      </span>
                      <div className="nota-acciones">
                        <button
                          className="btn-nota-ver"
                          onClick={() => abrirNota(nota)}
                          title="Ver nota completa"
                        >
                          üëÅÔ∏è Ver
                        </button>
                        <button
                          className="btn-nota-editar"
                          onClick={() => editarNota(nota)}
                          title="Editar nota"
                        >
                          ‚úèÔ∏è Editar
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              );
            })()}
          </div>
          );
        })()}

        {selectedMenu === 'practicas' && (
          <div className="content-section">
            <div className="section-header">
              <h1>üßë‚Äçüíª Pr√°cticas</h1>
              <p className="section-subtitle">Ejercicios personalizados para reforzar tu aprendizaje</p>
            </div>

            {/* Navegaci√≥n de carpetas */}
            <div className="breadcrumb-nav">
              <button onClick={() => {
                setRutaPracticasActual('');
                cargarCarpetasPracticas('');
              }} className="breadcrumb-btn">
                üè† Inicio
              </button>
              {rutaPracticasActual && rutaPracticasActual.split('\\').filter(Boolean).map((parte, idx, arr) => {
                const rutaParcial = arr.slice(0, idx + 1).join('\\');
                return (
                  <span key={idx}>
                    <span className="breadcrumb-separator">/</span>
                    <button onClick={() => {
                      setRutaPracticasActual(rutaParcial);
                      cargarCarpetasPracticas(rutaParcial);
                    }} className="breadcrumb-btn">
                      {parte}
                    </button>
                  </span>
                );
              })}
              {rutaPracticasActual && (
                <button 
                  onClick={() => {
                    const partes = rutaPracticasActual.split('\\').filter(Boolean);
                    partes.pop();
                    const rutaPadre = partes.join('\\');
                    setRutaPracticasActual(rutaPadre);
                    cargarCarpetasPracticas(rutaPadre);
                  }}
                  className="btn-volver"
                  style={{marginLeft: '1rem'}}
                >
                  ‚Üê Volver
                </button>
              )}
            </div>

            {/* Mostrar carpetas disponibles */}
            {carpetasPracticas.length > 0 && (
              <div className="carpetas-grid" style={{marginBottom: '2rem'}}>
                {carpetasPracticas.map((carpeta, idx) => (
                  <button
                    key={idx}
                    className="carpeta-card"
                    onClick={() => {
                      const nuevaRuta = rutaPracticasActual 
                        ? `${rutaPracticasActual}\\${carpeta.nombre}`
                        : carpeta.nombre;
                      setRutaPracticasActual(nuevaRuta);
                      cargarCarpetasPracticas(nuevaRuta);
                    }}
                  >
                    <span className="carpeta-icon">üìÅ</span>
                    <span className="carpeta-nombre">{carpeta.nombre}</span>
                  </button>
                ))}
              </div>
            )}

            {(() => {
              // Usar el estado 'practicas' que ya se carga con getDatos
              const practicasFiltradas = practicas.filter(p => (p.carpeta || '') === rutaPracticasActual);
              
              // Separar por completadas y sin completar
              const sinCompletar = practicasFiltradas.filter(p => !p.completada);
              const completadas = practicasFiltradas.filter(p => p.completada);
              
              if (practicas.length === 0) {
                return (
                  <div className="empty-state">
                    <div className="empty-icon">üìù</div>
                    <h3>No tienes pr√°cticas todav√≠a</h3>
                    <p>Ve a "Mis Cursos" y genera una pr√°ctica desde cualquier documento o carpeta</p>
                    <button 
                      className="btn-primary"
                      onClick={() => {
                        setSelectedMenu('cursos');
                        cargarCarpeta('');
                      }}
                    >
                      üìö Ir a Mis Cursos
                    </button>
                  </div>
                );
              }

              if (practicasFiltradas.length === 0) {
                return (
                  <div className="empty-state">
                    <div className="empty-icon">üìÇ</div>
                    <h3>No hay pr√°cticas en esta carpeta</h3>
                    <p>Las pr√°cticas se guardan en la carpeta desde donde las generas</p>
                  </div>
                );
              }

              return (
                <div>
                  {/* Pr√°cticas SIN COMPLETAR */}
                  {sinCompletar.length > 0 && (
                    <div style={{marginBottom: '2rem'}}>
                      <h2 style={{fontSize: '1.3rem', marginBottom: '1rem', color: '#ff9800'}}>
                        ‚è≥ Pr√°cticas sin completar ({sinCompletar.length})
                      </h2>
                      <div className="practicas-grid">
                        {sinCompletar.map((practica) => (
                          <div key={practica.id} className="practica-card" style={{borderLeft: '4px solid #ff9800'}}>
                            <div className="practica-header">
                              <div className="practica-icon">
                                {practica.tipo === 'documento' ? 'üìÑ' : 'üìÅ'}
                              </div>
                              <div className="practica-info">
                                <h3>{practica.ruta.split('/').pop()}</h3>
                                <p className="practica-fecha">
                                  {new Date(practica.fecha).toLocaleDateString('es-ES', {
                                    day: 'numeric',
                                    month: 'long',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                  })}
                                </p>
                              </div>
                            </div>
                            
                            {practica.prompt && (
                              <div className="practica-prompt">
                                <strong>Prompt:</strong> {practica.prompt}
                              </div>
                            )}

                            {practica.carpeta && (
                              <div className="practica-carpeta">
                                üìÅ {practica.carpeta}
                              </div>
                            )}
                            
                            <div className="practica-stats">
                              <span className="stat-badge">
                                üìù {practica.preguntas.length} preguntas
                              </span>
                              <span className="stat-badge pendiente">
                                {practica.completada || practica.estado === 'completada' ? '‚úÖ Completada' : '‚è≥ Pendiente'}
                              </span>
                            </div>
                            
                            <div className="practica-actions">
                              <button 
                                className="btn-primary"
                                onClick={() => {
                                  setPreguntasExamen(practica.preguntas);
                                  setRespuestasUsuario(practica.respuestas || {});
                                  setExamenCompletado(practica.completada || false);
                                  setResultadoExamen(practica.resultado || null);
                                  setExamenActivo(practica); // Guardar la pr√°ctica activa
                                  setEsPractica(true);
                                  
                                  // Cargar preguntas comprendidas de esta pr√°ctica
                                  if (practica.preguntasComprendidas) {
                                    setPreguntasComprendidas({
                                      ...preguntasComprendidas,
                                      [practica.id]: practica.preguntasComprendidas
                                    });
                                  }
                                  
                                  setModalExamenAbierto(true);
                                }}
                                title={practica.completada ? 'Ver Resultado' : 'Continuar pr√°ctica'}
                              >
                                {practica.completada ? 'üìä' : '‚ñ∂Ô∏è'}
                              </button>
                              <button 
                                className="btn-secondary"
                                onClick={() => {
                                  setPracticaAMover(practica);
                                  setModalMoverPractica(true);
                                  cargarCarpetasPracticas('');
                                }}
                                title="Mover a otra carpeta"
                              >
                                üìÇ
                              </button>
                              <button 
                                className="btn-eliminar"
                                onClick={async () => {
                                  if (confirm(`¬øEliminar esta pr√°ctica?`)) {
                                    const carpeta = practica.carpeta || '';
                                    
                                    try {
                                      // üî• ELIMINAR USANDO ENDPOINT DELETE
                                      const response = await fetch(`${API_URL}/datos/practicas/${practica.id}?carpeta=${encodeURIComponent(carpeta)}`, {
                                        method: 'DELETE'
                                      });
                                      
                                      if (response.ok) {
                                        const todasPracticas = await getDatos('practicas');
                                        setPracticas(todasPracticas);
                                      }
                                    } catch (error) {
                                      console.error('Error eliminando pr√°ctica:', error);
                                    }
                                  }
                                }}
                                title="Eliminar pr√°ctica"
                              >
                                üóëÔ∏è
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Pr√°cticas COMPLETADAS */}
                  {completadas.length > 0 && (
                    <div>
                      <h2 style={{fontSize: '1.3rem', marginBottom: '1rem', color: '#4caf50'}}>
                        ‚úÖ Pr√°cticas completadas ({completadas.length})
                      </h2>
                      <div className="practicas-grid">
                        {completadas.map((practica) => (
                          <div key={practica.id} className="practica-card" style={{borderLeft: '4px solid #4caf50'}}>
                            <div className="practica-header">
                              <div className="practica-icon">
                                {practica.tipo === 'documento' ? 'üìÑ' : 'üìÅ'}
                              </div>
                              <div className="practica-info">
                                <h3>{practica.ruta.split('/').pop()}</h3>
                                <p className="practica-fecha">
                                  {new Date(practica.fecha).toLocaleDateString('es-ES', {
                                    day: 'numeric',
                                    month: 'long',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                  })}
                                </p>
                              </div>
                              {/* Icono de reintentar en header */}
                              <button
                                className="btn-reintentar-header"
                                onClick={() => {
                                  // Buscar la pr√°ctica por ID para evitar referencias incorrectas
                                  const practicaActual = practicas.find(p => p.id === practica.id);
                                  if (!practicaActual) {
                                    console.error('‚ùå Pr√°ctica no encontrada:', practica.id);
                                    setMensaje({
                                      tipo: 'error',
                                      texto: '‚ùå No se pudo encontrar la pr√°ctica'
                                    });
                                    return;
                                  }
                                  
                                  console.log('üîÑ Reintentando pr√°ctica:', practicaActual.id);
                                  console.log('   Ruta:', practicaActual.ruta);
                                  console.log('   Preguntas:', practicaActual.preguntas.length);
                                  
                                  // Reintentar pr√°ctica - limpiar respuestas
                                  setPreguntasExamen(practicaActual.preguntas);
                                  setRespuestasUsuario({});
                                  setExamenCompletado(false);
                                  setResultadoExamen(null);
                                  setFlashcardsVolteadas({});
                                  setExamenActivo(practicaActual); // Guardar la pr√°ctica activa
                                  setModalExamenAbierto(true);
                                  
                                  setMensaje({
                                    tipo: 'info',
                                    texto: `üîÑ Reintentando: ${practicaActual.ruta.split('/').pop() || practicaActual.ruta}`
                                  });
                                }}
                                title="Reintentar pr√°ctica"
                                style={{
                                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '50%',
                                  width: '40px',
                                  height: '40px',
                                  fontSize: '1.2rem',
                                  cursor: 'pointer',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  transition: 'all 0.3s ease',
                                  boxShadow: '0 2px 8px rgba(102, 126, 234, 0.3)'
                                }}
                                onMouseEnter={(e) => {
                                  e.currentTarget.style.transform = 'scale(1.1) rotate(180deg)';
                                  e.currentTarget.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.5)';
                                }}
                                onMouseLeave={(e) => {
                                  e.currentTarget.style.transform = 'scale(1) rotate(0deg)';
                                  e.currentTarget.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.3)';
                                }}
                              >
                                üîÑ
                              </button>
                            </div>
                            
                            {practica.prompt && (
                              <div className="practica-prompt">
                                <strong>Prompt:</strong> {practica.prompt}
                              </div>
                            )}

                            {practica.carpeta && (
                              <div className="practica-carpeta">
                                üìÅ {practica.carpeta}
                              </div>
                            )}
                            
                            <div className="practica-stats">
                              <span className="stat-badge">
                                üìù {practica.preguntas.length} preguntas
                              </span>
                              <span className="stat-badge completada">
                                ‚úÖ Completada
                              </span>
                            </div>
                            
                            <div className="practica-actions">
                              <button 
                                className="btn-primary"
                                onClick={() => {
                                  setPreguntasExamen(practica.preguntas);
                                  setRespuestasUsuario(practica.respuestas || {});
                                  setExamenCompletado(true);
                                  setResultadoExamen(practica.resultado || null);
                                  setExamenActivo(practica); // ‚úÖ Establecer pr√°ctica activa
                                  setModalExamenAbierto(true);
                                }}
                                title="Ver Resultados"
                              >
                                üëÅÔ∏è
                              </button>
                              <button 
                                className="btn-secondary"
                                onClick={() => {
                                  // Buscar la pr√°ctica por ID para evitar referencias incorrectas
                                  const practicaActual = practicas.find(p => p.id === practica.id);
                                  if (!practicaActual) {
                                    console.error('Pr√°ctica no encontrada:', practica.id);
                                    setMensaje({
                                      tipo: 'error',
                                      texto: '‚ùå No se pudo encontrar la pr√°ctica'
                                    });
                                    return;
                                  }
                                  
                                  console.log('üîÑ Reintentando pr√°ctica:', practicaActual.id, practicaActual.ruta);
                                  console.log('   Preguntas:', practicaActual.preguntas.length);
                                  
                                  // Reintentar pr√°ctica - limpiar respuestas
                                  setPreguntasExamen(practicaActual.preguntas);
                                  setRespuestasUsuario({});
                                  setExamenCompletado(false);
                                  setResultadoExamen(null);
                                  setFlashcardsVolteadas({});
                                  setExamenActivo(practicaActual); // Guardar la pr√°ctica activa
                                  setModalExamenAbierto(true);
                                  
                                  setMensaje({
                                    tipo: 'info',
                                    texto: `üîÑ Reintentando: ${practicaActual.ruta.split('/').pop() || practicaActual.ruta}`
                                  });
                                }}
                                title="Reintentar pr√°ctica"
                              >
                                üîÑ
                              </button>
                              <button 
                                className="btn-secondary"
                                onClick={() => {
                                  setPracticaAMover(practica);
                                  setModalMoverPractica(true);
                                  cargarCarpetasPracticas('');
                                }}
                                title="Mover a otra carpeta"
                              >
                                üìÇ
                              </button>
                              <button 
                                className="btn-eliminar"
                                onClick={async () => {
                                  if (confirm(`¬øEliminar esta pr√°ctica?`)) {
                                    const carpeta = practica.carpeta || '';
                                    
                                    try {
                                      // üî• ELIMINAR USANDO ENDPOINT DELETE
                                      const response = await fetch(`${API_URL}/datos/practicas/${practica.id}?carpeta=${encodeURIComponent(carpeta)}`, {
                                        method: 'DELETE'
                                      });
                                      
                                      if (response.ok) {
                                        const todasPracticas = await getDatos('practicas');
                                        setPracticas(todasPracticas);
                                      }
                                    } catch (error) {
                                      console.error('Error eliminando pr√°ctica:', error);
                                    }
                                  }
                                }}
                                title="Eliminar pr√°ctica"
                              >
                                üóëÔ∏è
                              </button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
              );
            })()}
          </div>
        )}

        {/* ============= SECCI√ìN FLASHCARDS ============= */}
        {selectedMenu === 'flashcards' && (
          <div className="content-section">
            <div className="section-header">
              <h1>üÉè Mis Flashcards</h1>
              {(rutaFlashcardsActual || carpetaFlashcardActual) && (
                <button className="btn-primary" onClick={crearNuevaFlashcard}>
                  ‚ûï Nueva Flashcard
                  {carpetaFlashcardActual && ` en ${carpetaFlashcardActual.nombre}`}
                  {!carpetaFlashcardActual && rutaFlashcardsActual && ` en ${rutaFlashcardsActual.split('/').pop()}`}
                </button>
              )}
            </div>

            {/* Breadcrumb de navegaci√≥n */}
            {(rutaFlashcardsActual || carpetaFlashcardActual) && (
              <div className="breadcrumb-nav">
                <button onClick={() => navegarRutaFlashcards('')} className="breadcrumb-btn">
                  üè† Inicio
                </button>
                {rutaFlashcardsActual && (
                  <>
                    <span className="breadcrumb-separator">/</span>
                    {rutaFlashcardsActual.split('/').map((parte, idx, arr) => {
                      const rutaParcial = arr.slice(0, idx + 1).join('/');
                      const esUltimo = idx === arr.length - 1;
                      return (
                        <React.Fragment key={idx}>
                          {esUltimo && !carpetaFlashcardActual ? (
                            <span className="breadcrumb-current">{parte}</span>
                          ) : (
                            <>
                              <button onClick={() => navegarRutaFlashcards(rutaParcial)} className="breadcrumb-btn">
                                {parte}
                              </button>
                              <span className="breadcrumb-separator">/</span>
                            </>
                          )}
                        </React.Fragment>
                      );
                    })}
                  </>
                )}
                {carpetaFlashcardActual && (
                  <span className="breadcrumb-current">üÉè {carpetaFlashcardActual.nombre}</span>
                )}
                <button 
                  onClick={carpetaFlashcardActual ? volverListaFlashcards : volverAtrasFlashcards} 
                  className="btn-volver" 
                  style={{marginLeft: '1rem'}}
                >
                  ‚Üê Volver
                </button>
              </div>
            )}

            {/* Filtro dropdown por tipo (mostrar si hay carpeta abierta O si est√°s en una ruta con flashcards) */}
            {(carpetaFlashcardActual || (rutaFlashcardsActual && (() => {
              const rutaNormalizada = rutaFlashcardsActual.replace(/\\/g, '/');
              return flashcardsActuales.some(f => {
                const carpetaFlashcard = (f.carpeta || '').replace(/\\/g, '/');
                return carpetaFlashcard === rutaNormalizada;
              });
            })())) && (() => {
              const rutaParaFiltro = carpetaFlashcardActual?.ruta || rutaFlashcardsActual;
              const rutaNormalizada = rutaParaFiltro.replace(/\\/g, '/');
              const flashcards = flashcardsActuales.filter(f => {
                const carpetaFlashcard = (f.carpeta || '').replace(/\\/g, '/');
                return carpetaFlashcard === rutaNormalizada;
              });
              const contadores = {
                todas: flashcards.length,
                clasica: flashcards.filter(f => f.tipo === 'clasica').length,
                reconocimiento: flashcards.filter(f => f.tipo === 'reconocimiento').length,
                cloze: flashcards.filter(f => f.tipo === 'cloze').length,
                escenario: flashcards.filter(f => f.tipo === 'escenario').length,
                mcq: flashcards.filter(f => f.tipo === 'mcq').length,
                visual: flashcards.filter(f => f.tipo === 'visual').length,
                auditiva: flashcards.filter(f => f.tipo === 'auditiva').length,
                produccion: flashcards.filter(f => f.tipo === 'produccion').length,
                invertida: flashcards.filter(f => f.tipo === 'invertida').length,
                jerarquia: flashcards.filter(f => f.tipo === 'jerarquia').length,
                error: flashcards.filter(f => f.tipo === 'error').length,
                comparacion: flashcards.filter(f => f.tipo === 'comparacion').length,
                matematica: flashcards.filter(f => f.tipo === 'matematica').length,
                archivo: flashcards.filter(f => f.tipo === 'archivo').length,
                programacion: flashcards.filter(f => f.tipo === 'programacion').length,
                quimica: flashcards.filter(f => f.tipo === 'quimica').length,
                fisica: flashcards.filter(f => f.tipo === 'fisica').length,
                ingenieria: flashcards.filter(f => f.tipo === 'ingenieria').length,
                'programacion-avanzada': flashcards.filter(f => f.tipo === 'programacion-avanzada').length,
                'logica-discreta': flashcards.filter(f => f.tipo === 'logica-discreta').length,
                linguistica: flashcards.filter(f => f.tipo === 'linguistica').length,
                musica: flashcards.filter(f => f.tipo === 'musica').length,
                geometria: flashcards.filter(f => f.tipo === 'geometria').length,
                'quimica-avanzada': flashcards.filter(f => f.tipo === 'quimica-avanzada').length,
                probabilidad: flashcards.filter(f => f.tipo === 'probabilidad').length,
                arte: flashcards.filter(f => f.tipo === 'arte').length
              };

              const tiposFlashcard = [
                {id: 'todas', nombre: 'Todas las flashcards', icon: 'üÉè'},
                {id: 'clasica', nombre: 'Cl√°sica', icon: 'üìá'},
                {id: 'reconocimiento', nombre: 'Reconocimiento', icon: 'üëÅÔ∏è'},
                {id: 'cloze', nombre: 'Cloze', icon: 'üî§'},
                {id: 'escenario', nombre: 'Escenario', icon: 'üé¨'},
                {id: 'mcq', nombre: 'Opci√≥n M√∫ltiple', icon: '‚òëÔ∏è'},
                {id: 'visual', nombre: 'Visual', icon: 'üñºÔ∏è'},
                {id: 'auditiva', nombre: 'Auditiva', icon: 'üîä'},
                {id: 'produccion', nombre: 'Producci√≥n', icon: '‚úçÔ∏è'},
                {id: 'invertida', nombre: 'Invertida', icon: 'üîÑ'},
                {id: 'jerarquia', nombre: 'Jerarqu√≠a', icon: 'üèóÔ∏è'},
                {id: 'error', nombre: 'Error', icon: '‚ùå'},
                {id: 'comparacion', nombre: 'Comparaci√≥n', icon: '‚öñÔ∏è'},
                {id: 'matematica', nombre: 'Matem√°tica', icon: 'üî¢'},
                {id: 'archivo', nombre: 'Archivo', icon: 'üìé'},
                {id: 'programacion', nombre: 'Programaci√≥n', icon: '</>'},
                {id: 'quimica', nombre: 'Qu√≠mica', icon: 'üß™'},
                {id: 'fisica', nombre: 'F√≠sica', icon: '‚öõÔ∏è'},
                {id: 'ingenieria', nombre: 'Ingenier√≠a', icon: 'üîß'},
                {id: 'programacion-avanzada', nombre: 'Programaci√≥n Avanzada', icon: 'üíª'},
                {id: 'logica-discreta', nombre: 'L√≥gica/Discreta', icon: 'üîÆ'},
                {id: 'linguistica', nombre: 'Lingu√≠stica', icon: 'üó£Ô∏è'},
                {id: 'musica', nombre: 'M√∫sica', icon: 'üéº'},
                {id: 'geometria', nombre: 'Geometr√≠a', icon: 'üìê'},
                {id: 'quimica-avanzada', nombre: 'Qu√≠mica Avanzada', icon: 'üß¨'},
                {id: 'probabilidad', nombre: 'Probabilidad', icon: 'üé≤'},
                {id: 'arte', nombre: 'Arte', icon: 'üé®'}
              ];

              const tipoActual = tiposFlashcard.find(t => t.id === filtroTipoFlashcard) || tiposFlashcard[0];

              return (
                <div className="flashcard-filter-dropdown" style={{marginBottom: '1.5rem'}}>
                  <label style={{
                    display: 'block',
                    color: 'rgba(255,255,255,0.7)',
                    fontSize: '0.9rem',
                    marginBottom: '0.5rem',
                    fontWeight: '500'
                  }}>
                    üîç Filtrar por tipo:
                  </label>
                  <select 
                    value={filtroTipoFlashcard}
                    onChange={(e) => setFiltroTipoFlashcard(e.target.value)}
                    style={{
                      width: '100%',
                      maxWidth: '400px',
                      padding: '0.75rem 1rem',
                      background: 'rgba(255, 255, 255, 0.05)',
                      border: '2px solid rgba(102, 126, 234, 0.3)',
                      borderRadius: '12px',
                      color: 'white',
                      fontSize: '1rem',
                      cursor: 'pointer',
                      transition: 'all 0.3s ease',
                      outline: 'none'
                    }}
                    onMouseEnter={(e) => {
                      e.target.style.borderColor = 'rgba(102, 126, 234, 0.6)';
                      e.target.style.background = 'rgba(255, 255, 255, 0.08)';
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.borderColor = 'rgba(102, 126, 234, 0.3)';
                      e.target.style.background = 'rgba(255, 255, 255, 0.05)';
                    }}
                  >
                    {tiposFlashcard.map(tipo => (
                      <option 
                        key={tipo.id} 
                        value={tipo.id}
                        disabled={contadores[tipo.id] === 0 && tipo.id !== 'todas'}
                        style={{
                          background: '#1a1a2e',
                          color: contadores[tipo.id] === 0 && tipo.id !== 'todas' ? '#666' : 'white'
                        }}
                      >
                        {tipo.icon} {tipo.nombre} ({contadores[tipo.id]})
                      </option>
                    ))}
                  </select>
                </div>
              );
            })()}

            {/* Grid de carpetas */}
            {!carpetaFlashcardActual && flashcardsCarpetas.length > 0 && (
              <>
                {/* Mostrar flashcards de la carpeta actual si existe rutaFlashcardsActual */}
                {rutaFlashcardsActual && (() => {
                  const rutaNormalizada = rutaFlashcardsActual.replace(/\\/g, '/');
                  const flashcardsAqui = flashcardsActuales.filter(f => {
                    const carpetaFlashcard = (f.carpeta || '').replace(/\\/g, '/');
                    return carpetaFlashcard === rutaNormalizada;
                  }).filter(f => filtroTipoFlashcard === 'todas' || f.tipo === filtroTipoFlashcard);

                  if (flashcardsAqui.length > 0) {
                    const tipoConfig = {
                      clasica: { color: '#667eea', icon: 'üìá', nombre: 'Cl√°sica' },
                      reconocimiento: { color: '#f093fb', icon: 'üëÅÔ∏è', nombre: 'Reconocimiento' },
                      cloze: { color: '#4facfe', icon: 'üî§', nombre: 'Cloze' },
                      escenario: { color: '#43e97b', icon: 'üé¨', nombre: 'Escenario' },
                      mcq: { color: '#fa709a', icon: '‚òëÔ∏è', nombre: 'Opci√≥n M√∫ltiple' },
                      visual: { color: '#30cfd0', icon: 'üñºÔ∏è', nombre: 'Visual' },
                      auditiva: { color: '#a8edea', icon: 'üîä', nombre: 'Auditiva' },
                      produccion: { color: '#ffa751', icon: '‚úçÔ∏è', nombre: 'Producci√≥n' },
                      invertida: { color: '#764ba2', icon: 'üîÑ', nombre: 'Invertida' },
                      jerarquia: { color: '#667eea', icon: 'üèóÔ∏è', nombre: 'Jerarqu√≠a' },
                      error: { color: '#f093fb', icon: '‚ùå', nombre: 'Error' },
                      comparacion: { color: '#4facfe', icon: '‚öñÔ∏è', nombre: 'Comparaci√≥n' },
                      matematica: { color: '#3b82f6', icon: 'üìê', nombre: 'Matem√°ticas' },
                      quimica: { color: '#10b981', icon: 'üß™', nombre: 'Qu√≠mica' },
                      fisica: { color: '#f59e0b', icon: '‚ö°', nombre: 'F√≠sica' },
                      geometria: { color: '#22c55e', icon: 'üìê', nombre: 'Geometr√≠a' },
                      ingenieria: { color: '#ef4444', icon: 'üîß', nombre: 'Ingenier√≠a' },
                      'logica-discreta': { color: '#7c3aed', icon: 'üîÆ', nombre: 'L√≥gica' },
                      linguistica: { color: '#ec4899', icon: 'üó£Ô∏è', nombre: 'Fon√©tica' },
                      musica: { color: '#a855f7', icon: 'üéº', nombre: 'M√∫sica' },
                      programacion: { color: '#14b8a6', icon: 'üíª', nombre: 'Programaci√≥n' },
                      'programacion-avanzada': { color: '#8b5cf6', icon: 'üíª', nombre: 'Prog. Avanzada' },
                      'quimica-avanzada': { color: '#c084fc', icon: 'üß¨', nombre: 'Qu√≠mica Avz.' },
                      probabilidad: { color: '#8b5cf6', icon: 'üé≤', nombre: 'Probabilidad' },
                      datos: { color: '#06b6d4', icon: 'üìä', nombre: 'Datos' },
                      arte: { color: '#f472b6', icon: 'üé®', nombre: 'Arte' }
                    };

                    return (
                      <div style={{marginBottom: '2rem'}}>
                        <h3 style={{
                          margin: '0 0 1rem 0',
                          color: 'white',
                          fontSize: '1.25rem'
                        }}>
                          üÉè Flashcards en esta carpeta ({flashcardsAqui.length})
                        </h3>
                        <div className="flashcards-grid">
                          {flashcardsAqui.map((flashcard) => {
                            const config = tipoConfig[flashcard.tipo] || tipoConfig.clasica;
                            const estadoColor = {
                              nueva: '#ff9800',
                              en_progreso: '#3b82f6',
                              dominada: '#4caf50'
                            }[flashcard.estadoRevision] || '#ff9800';

                            return (
                              <div key={flashcard.id} className="flashcard-card">
                                <div className="flashcard-type-badge" style={{
                                  background: `linear-gradient(135deg, ${config.color} 0%, ${config.color}dd 100%)`
                                }}>
                                  <span>{config.icon}</span>
                                  <span>{config.nombre}</span>
                                </div>
                                <div className="flashcard-body" onClick={() => setFlashcardVistaCompleta(flashcard)} style={{cursor: 'pointer'}}>
                                  <h3 className="flashcard-titulo">{flashcard.titulo}</h3>
                                  <div className="flashcard-preview">
                                    {flashcard.contenido.substring(0, 100)}
                                    {flashcard.contenido.length > 100 && '...'}
                                  </div>
                                </div>

                                {/* Footer con metadata */}
                                <div className="flashcard-footer">
                                  <div style={{display: 'flex', flexDirection: 'column', gap: '0.25rem'}}>
                                    {flashcard.tema && (
                                      <span className="flashcard-tema">
                                        üè∑Ô∏è {flashcard.tema}
                                      </span>
                                    )}
                                    {flashcard.proximaRevision && (() => {
                                      const ahora = new Date();
                                      const proxima = new Date(flashcard.proximaRevision);
                                      const diff = Math.ceil((proxima - ahora) / (1000 * 60 * 60 * 24));
                                      const necesitaRepaso = diff <= 0;
                                      
                                      return (
                                        <span style={{
                                          color: necesitaRepaso ? '#fbbf24' : '#94a3b8',
                                          fontSize: '0.7rem',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '0.25rem'
                                        }}>
                                          {necesitaRepaso ? '‚è∞ Repasar ahora' : `üìÖ Repaso en ${diff} d√≠a${diff !== 1 ? 's' : ''}`}
                                        </span>
                                      );
                                    })()}
                                  </div>
                                  <span className="flashcard-estado" style={{
                                    background: estadoColor,
                                    color: 'white',
                                    padding: '0.3rem 0.6rem',
                                    borderRadius: '12px',
                                    fontSize: '0.75rem',
                                    fontWeight: '600'
                                  }}>
                                    {flashcard.estadoRevision === 'nueva' && 'üÜï Nueva'}
                                    {flashcard.estadoRevision === 'en_progreso' && 'üìñ En Progreso'}
                                    {flashcard.estadoRevision === 'dominada' && '‚úÖ Dominada'}
                                  </span>
                                </div>

                                {/* Acciones */}
                                <div className="flashcard-actions">
                                  <button 
                                    className="btn-flashcard-action"
                                    onClick={() => setFlashcardVistaCompleta(flashcard)}
                                    title="Ver completa"
                                    style={{
                                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                      color: 'white',
                                      fontWeight: '600'
                                    }}
                                  >
                                    üëÅÔ∏è
                                  </button>
                                  <button 
                                    className="btn-flashcard-action"
                                    onClick={() => {
                                      setFlashcardEditando(flashcard);
                                      setFormDataFlashcard(flashcard);
                                      setModalNuevaFlashcard(true);
                                    }}
                                    title="Editar"
                                  >
                                    ‚úèÔ∏è
                                  </button>
                                  <button 
                                    className="btn-flashcard-action"
                                    onClick={() => {
                                      const nueva = {
                                        ...flashcard,
                                        id: Date.now(),
                                        titulo: `${flashcard.titulo} (copia)`,
                                        estadoRevision: 'nueva',
                                        fecha: new Date().toISOString()
                                      };
                                      guardarFlashcard(nueva);
                                    }}
                                    title="Duplicar"
                                  >
                                    üìã
                                  </button>
                                  <button 
                                    className="btn-flashcard-action danger"
                                    onClick={() => eliminarFlashcard(flashcard.id)}
                                    title="Eliminar"
                                  >
                                    üóëÔ∏è
                                  </button>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>
                    );
                  }
                  return null;
                })()}

                {/* Grid de subcarpetas */}
                <div className="carpetas-grid">
                  {flashcardsCarpetas.map((carpeta, idx) => {
                  const tieneSubcarpetas = carpeta.subcarpetas && carpeta.subcarpetas > 0;
                  const tieneFlashcards = carpeta.totalFlashcards && carpeta.totalFlashcards > 0;
                  
                  return (
                    <div 
                      key={idx} 
                      className="carpeta-card flashcard-folder"
                      onClick={() => verFlashcardsDeCarpeta(carpeta)}
                      style={{
                        cursor: 'pointer',
                        position: 'relative'
                      }}
                    >
                      <div className="carpeta-header">
                        <span className="carpeta-icon">{tieneSubcarpetas ? 'üìÅ' : 'üìö'}</span>
                        <span className="carpeta-nombre">{carpeta.nombre}</span>
                        <div style={{
                          display: 'flex',
                          gap: '0.5rem',
                          fontSize: '0.85rem',
                          color: 'rgba(255,255,255,0.6)',
                          marginTop: '0.3rem'
                        }}>
                          {tieneFlashcards && (
                            <span>üÉè {carpeta.totalFlashcards}</span>
                          )}
                          {tieneSubcarpetas && (
                            <span>üìÇ {carpeta.subcarpetas}</span>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
              </>
            )}

            {/* Grid de Flashcards */}
            {carpetaFlashcardActual && (() => {
              const rutaCarpetaNormalizada = carpetaFlashcardActual.ruta.replace(/\\/g, '/');
              const flashcards = flashcardsActuales
                .filter(f => {
                  const carpetaFlashcard = (f.carpeta || '').replace(/\\/g, '/');
                  return carpetaFlashcard === rutaCarpetaNormalizada;
                })
                .filter(f => filtroTipoFlashcard === 'todas' || f.tipo === filtroTipoFlashcard);

              if (flashcards.length === 0) {
                return (
                  <div className="empty-state">
                    <div className="empty-icon">üÉè</div>
                    <h3>No hay flashcards {filtroTipoFlashcard !== 'todas' ? `de tipo "${filtroTipoFlashcard}"` : ''}</h3>
                    <p>Crea tu primera flashcard para comenzar a estudiar</p>
                    <button className="btn-primary" onClick={crearNuevaFlashcard}>
                      ‚ûï Nueva Flashcard
                    </button>
                  </div>
                );
              }

              const tipoConfig = {
                clasica: { color: '#667eea', icon: 'üìá', nombre: 'Cl√°sica' },
                reconocimiento: { color: '#f093fb', icon: 'üëÅÔ∏è', nombre: 'Reconocimiento' },
                cloze: { color: '#4facfe', icon: 'üî§', nombre: 'Cloze' },
                escenario: { color: '#43e97b', icon: 'üé¨', nombre: 'Escenario' },
                mcq: { color: '#fa709a', icon: '‚òëÔ∏è', nombre: 'Opci√≥n M√∫ltiple' },
                visual: { color: '#30cfd0', icon: 'üñºÔ∏è', nombre: 'Visual' },
                auditiva: { color: '#a8edea', icon: 'üîä', nombre: 'Auditiva' },
                produccion: { color: '#ffa751', icon: '‚úçÔ∏è', nombre: 'Producci√≥n' },
                invertida: { color: '#764ba2', icon: 'üîÑ', nombre: 'Invertida' },
                jerarquia: { color: '#667eea', icon: 'üèóÔ∏è', nombre: 'Jerarqu√≠a' },
                error: { color: '#f093fb', icon: '‚ùå', nombre: 'Error' },
                comparacion: { color: '#4facfe', icon: '‚öñÔ∏è', nombre: 'Comparaci√≥n' },
                matematica: { color: '#3b82f6', icon: 'üìê', nombre: 'Matem√°ticas' },
                quimica: { color: '#10b981', icon: 'üß™', nombre: 'Qu√≠mica' },
                fisica: { color: '#f59e0b', icon: '‚ö°', nombre: 'F√≠sica' },
                geometria: { color: '#22c55e', icon: 'üìê', nombre: 'Geometr√≠a' },
                ingenieria: { color: '#ef4444', icon: 'üîß', nombre: 'Ingenier√≠a' },
                'logica-discreta': { color: '#7c3aed', icon: 'üîÆ', nombre: 'L√≥gica' },
                linguistica: { color: '#ec4899', icon: 'üó£Ô∏è', nombre: 'Fon√©tica' },
                musica: { color: '#a855f7', icon: 'üéº', nombre: 'M√∫sica' },
                programacion: { color: '#14b8a6', icon: 'üíª', nombre: 'Programaci√≥n' },
                'programacion-avanzada': { color: '#8b5cf6', icon: 'üíª', nombre: 'Prog. Avanzada' },
                'quimica-avanzada': { color: '#c084fc', icon: 'üß¨', nombre: 'Qu√≠mica Avz.' },
                probabilidad: { color: '#8b5cf6', icon: 'üé≤', nombre: 'Probabilidad' },
                datos: { color: '#06b6d4', icon: 'üìä', nombre: 'Datos' },
                arte: { color: '#f472b6', icon: 'üé®', nombre: 'Arte' }
              };

              return (
                <div className="flashcards-grid">
                  {flashcards.map((flashcard) => {
                    const config = tipoConfig[flashcard.tipo] || tipoConfig.clasica;
                    const estadoColor = {
                      nueva: '#ff9800',
                      en_progreso: '#3b82f6',
                      dominada: '#4caf50'
                    }[flashcard.estadoRevision] || '#ff9800';

                    return (
                      <div key={flashcard.id} className="flashcard-card">
                        {/* Indicador de tipo */}
                        <div 
                          className="flashcard-type-badge"
                          style={{
                            background: `linear-gradient(135deg, ${config.color} 0%, ${config.color}dd 100%)`
                          }}
                        >
                          <span>{config.icon}</span>
                          <span>{config.nombre}</span>
                        </div>

                        {/* Cuerpo de la flashcard - clickeable para vista completa */}
                        <div 
                          className="flashcard-body" 
                          onClick={() => setFlashcardVistaCompleta(flashcard)}
                          style={{cursor: 'pointer'}}
                        >
                          <h3 className="flashcard-titulo">{flashcard.titulo}</h3>
                          <div className="flashcard-preview">
                            {flashcard.contenido.substring(0, 100)}
                            {flashcard.contenido.length > 100 && '...'}
                          </div>
                          
                          {/* Indicador de archivos */}
                          {((flashcard.imagenes && flashcard.imagenes.length > 0) || 
                            (flashcard.archivos && flashcard.archivos.length > 0)) && (
                            <div style={{
                              marginTop: '0.75rem',
                              fontSize: '0.8rem',
                              color: '#94a3b8',
                              display: 'flex',
                              gap: '0.5rem',
                              alignItems: 'center'
                            }}>
                              {flashcard.imagenes && flashcard.imagenes.length > 0 && (
                                <span>üñºÔ∏è {flashcard.imagenes.length} {flashcard.imagenes.length === 1 ? 'imagen' : 'im√°genes'}</span>
                              )}
                              {flashcard.archivos && flashcard.archivos.length > 0 && (
                                <span>üìé {flashcard.archivos.length} {flashcard.archivos.length === 1 ? 'archivo' : 'archivos'}</span>
                              )}
                            </div>
                          )}
                          
                          {/* Indicador LaTeX */}
                          {flashcard.latex && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#60a5fa',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(59, 130, 246, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üìê LaTeX
                            </div>
                          )}
                          
                          {/* Indicador Programaci√≥n */}
                          {flashcard.tipo === 'programacion' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#5eead4',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(20, 184, 166, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üíª {flashcard.lenguaje?.toUpperCase() || 'CODE'}
                            </div>
                          )}

                          {/* Indicador Qu√≠mica */}
                          {flashcard.tipo === 'quimica' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#6ee7b7',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(16, 185, 129, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              ‚öóÔ∏è {flashcard.rama?.toUpperCase() || 'QU√çMICA'}
                            </div>
                          )}

                          {/* Indicador F√≠sica */}
                          {flashcard.tipo === 'fisica' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#fbbf24',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(245, 158, 11, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              ‚öõÔ∏è {flashcard.ramaFisica?.toUpperCase() || 'F√çSICA'}
                            </div>
                          )}

                          {/* Indicador Ingenier√≠a */}
                          {flashcard.tipo === 'ingenieria' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#fca5a5',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(239, 68, 68, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üîß {flashcard.ramaIngenieria?.toUpperCase() || 'INGENIER√çA'}
                            </div>
                          )}

                          {/* Indicador Programaci√≥n Avanzada */}
                          {flashcard.tipo === 'programacion-avanzada' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#ddd6fe',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(139, 92, 246, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üíª {flashcard.subtipoProgramacion?.toUpperCase() || 'PROGRAMACI√ìN'}
                            </div>
                          )}

                          {/* Indicador L√≥gica/Discreta */}
                          {flashcard.tipo === 'logica-discreta' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#ddd6fe',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(124, 58, 237, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üîÆ {flashcard.subtipoDiscreta?.toUpperCase() || 'L√ìGICA'}
                            </div>
                          )}

                          {/* Indicador M√∫sica */}
                          {flashcard.tipo === 'musica' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#f0abfc',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(168, 85, 247, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üéº {flashcard.subtipoMusica?.toUpperCase() || 'M√öSICA'}
                            </div>
                          )}

                          {/* Indicador Geometr√≠a */}
                          {flashcard.tipo === 'geometria' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#86efac',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(34, 197, 94, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üìê {flashcard.subtipoGeometria?.toUpperCase() || 'GEOMETR√çA'}
                            </div>
                          )}

                          {/* Indicador Qu√≠mica Avanzada */}
                          {flashcard.tipo === 'quimica-avanzada' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#e9d5ff',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(192, 132, 252, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üß¨ {flashcard.subtipoQuimicaAvanzada?.toUpperCase() || 'QU√çMICA AVZ'}
                            </div>
                          )}

                          {/* Indicador M√∫sica */}
                          {flashcard.tipo === 'musica' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#f0abfc',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(168, 85, 247, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üéº {flashcard.subtipoMusica?.toUpperCase() || 'M√öSICA'}
                            </div>
                          )}

                          {/* Indicador Geometr√≠a */}
                          {flashcard.tipo === 'geometria' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#86efac',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(34, 197, 94, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üìê {flashcard.subtipoGeometria?.toUpperCase() || 'GEOMETR√çA'}
                            </div>
                          )}

                          {/* Indicador Qu√≠mica Avanzada */}
                          {flashcard.tipo === 'quimica-avanzada' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#e9d5ff',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(192, 132, 252, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üß¨ {flashcard.subtipoQuimicaAvanzada?.toUpperCase() || 'QU√çMICA AVZ'}
                            </div>
                          )}

                          {/* Indicador Probabilidad */}
                          {flashcard.tipo === 'probabilidad' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#c4b5fd',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(139, 92, 246, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üé≤ {flashcard.subtipoProbabilidad?.toUpperCase() || 'PROBABILIDAD'}
                            </div>
                          )}

                          {/* Indicador Arte */}
                          {flashcard.tipo === 'arte' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#fbcfe8',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(244, 114, 182, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üé® {flashcard.subtipoArte?.toUpperCase() || 'ARTE'}
                            </div>
                          )}

                          {/* Indicador Ling√º√≠stica */}
                          {flashcard.tipo === 'linguistica' && (
                            <div style={{
                              marginTop: '0.5rem',
                              fontSize: '0.75rem',
                              color: '#fce7f3',
                              display: 'inline-flex',
                              alignItems: 'center',
                              gap: '0.25rem',
                              background: 'rgba(236, 72, 153, 0.15)',
                              padding: '0.25rem 0.5rem',
                              borderRadius: '6px'
                            }}>
                              üó£Ô∏è {flashcard.subtipoLinguistica?.toUpperCase() || 'LING√ú√çSTICA'}
                            </div>
                          )}
                        </div>

                        {/* Footer con metadata */}
                        <div className="flashcard-footer">
                          <div style={{display: 'flex', flexDirection: 'column', gap: '0.25rem'}}>
                            {flashcard.tema && (
                              <span className="flashcard-tema">
                                üè∑Ô∏è {flashcard.tema}
                              </span>
                            )}
                            {flashcard.subtema && (
                              <span style={{
                                color: '#94a3b8',
                                fontSize: '0.75rem'
                              }}>
                                üìå {flashcard.subtema}
                              </span>
                            )}
                            {/* Indicador de pr√≥xima revisi√≥n */}
                            {flashcard.proximaRevision && (() => {
                              const ahora = new Date();
                              const proxima = new Date(flashcard.proximaRevision);
                              const diff = Math.ceil((proxima - ahora) / (1000 * 60 * 60 * 24));
                              const necesitaRepaso = diff <= 0;
                              
                              return (
                                <span style={{
                                  color: necesitaRepaso ? '#fbbf24' : '#94a3b8',
                                  fontSize: '0.7rem',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '0.25rem'
                                }}>
                                  {necesitaRepaso ? '‚è∞ Repasar ahora' : `üìÖ Repaso en ${diff} d√≠a${diff !== 1 ? 's' : ''}`}
                                  {flashcard.repeticiones > 0 && ` (${flashcard.repeticiones}√ó visto)`}
                                </span>
                              );
                            })()}
                          </div>
                          <span 
                            className="flashcard-estado"
                            style={{
                              background: estadoColor,
                              color: 'white',
                              padding: '0.3rem 0.6rem',
                              borderRadius: '12px',
                              fontSize: '0.75rem',
                              fontWeight: '600'
                            }}
                          >
                            {flashcard.estadoRevision === 'nueva' && 'üÜï'}
                            {flashcard.estadoRevision === 'en_progreso' && 'üìñ'}
                            {flashcard.estadoRevision === 'dominada' && '‚úÖ'}
                            {' '}
                            {flashcard.estadoRevision === 'nueva' && 'Nueva'}
                            {flashcard.estadoRevision === 'en_progreso' && 'En Progreso'}
                            {flashcard.estadoRevision === 'dominada' && 'Dominada'}
                          </span>
                        </div>

                        {/* Acciones */}
                        <div className="flashcard-actions">
                          <button 
                            className="btn-flashcard-action"
                            onClick={() => setFlashcardVistaCompleta(flashcard)}
                            title="Ver completa"
                            style={{
                              background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                              color: 'white',
                              fontWeight: '600'
                            }}
                          >
                            üëÅÔ∏è
                          </button>
                          <button 
                            className="btn-flashcard-action"
                            onClick={() => {
                              setFlashcardEditando(flashcard);
                              setFormDataFlashcard(flashcard);
                              setModalNuevaFlashcard(true);
                            }}
                            title="Editar"
                          >
                            ‚úèÔ∏è
                          </button>
                          <button 
                            className="btn-flashcard-action"
                            onClick={() => {
                              // Copiar flashcard
                              const nueva = {
                                ...flashcard,
                                id: Date.now(),
                                titulo: `${flashcard.titulo} (copia)`,
                                estadoRevision: 'nueva',
                                fecha: new Date().toISOString()
                              };
                              guardarFlashcard(nueva);
                            }}
                            title="Duplicar"
                          >
                            üìã
                          </button>
                          <button 
                            className="btn-flashcard-action danger"
                            onClick={() => eliminarFlashcard(flashcard.id)}
                            title="Eliminar"
                          >
                            üóëÔ∏è
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              );
            })()}

            {/* Estado vac√≠o - sin carpetas */}
            {!carpetaFlashcardActual && flashcardsCarpetas.length === 0 && (
              <div className="empty-state">
                <div className="empty-icon">üÉè</div>
                <h3>No tienes flashcards todav√≠a</h3>
                <p>Las flashcards se organizan por carpetas de cursos. Selecciona una carpeta para ver las flashcards asociadas.</p>
                <button 
                  className="btn-primary"
                  onClick={() => {
                    setSelectedMenu('cursos');
                    cargarCarpeta('');
                  }}
                >
                  üìö Ir a Mis Cursos
                </button>
              </div>
            )}
          </div>
        )}

        {selectedMenu === 'chat' && (
          <div className="chat-section">
            <div className="chat-header">
              <div className="chat-header-actions">
                {/* Bot√≥n de diagn√≥stico Ollama */}
                <button 
                  className={`btn-chat-action btn-diagnostico ${diagnosticoOllama?.corriendo ? 'ok' : 'error'}`}
                  onClick={verificarEstadoOllama}
                  title={diagnosticoOllama?.mensaje || 'Verificar estado de Ollama'}
                  style={{
                    backgroundColor: diagnosticoOllama?.corriendo ? '#4caf50' : '#ff9800',
                    color: 'white'
                  }}
                >
                  {diagnosticoOllama?.corriendo ? '‚úÖ Ollama' : '‚ö†Ô∏è Ollama'}
                </button>
                
                {/* Bot√≥n de reparaci√≥n (solo si Ollama no est√° corriendo) */}
                {diagnosticoOllama && !diagnosticoOllama.corriendo && (
                  <button 
                    className="btn-chat-action btn-reparar"
                    onClick={repararOllama}
                    disabled={reparandoOllama}
                    title="Reparar Ollama inici√°ndolo autom√°ticamente"
                    style={{
                      backgroundColor: '#2196f3',
                      color: 'white'
                    }}
                  >
                    {reparandoOllama ? 'üîÑ Reparando...' : 'üîß Reparar'}
                  </button>
                )}

                {modelosOllama.length > 0 && (
                  <div className="selector-modelo-chat">
                    <label className="label-selector">ü§ñ</label>
                    <select 
                      value={configuracion?.modelo_ollama || ''}
                      onChange={async (e) => {
                        const nuevoModelo = e.target.value;
                        try {
                          const response = await fetch(`${API_URL}/api/ollama/cambiar-modelo`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ modelo: nuevoModelo })
                          });
                          if (response.ok) {
                            setMensaje({
                              tipo: 'success',
                              texto: `‚úÖ Modelo cambiado a ${nuevoModelo}`
                            });
                            cargarConfiguracion();
                          }
                        } catch (error) {
                          setMensaje({
                            tipo: 'error',
                            texto: '‚ùå Error cambiando modelo'
                          });
                        }
                      }}
                      className="select-modelo-chat"
                    >
                      {modelosOllama.map(modelo => (
                        <option key={modelo.nombre} value={modelo.nombre}>
                          {modelo.nombre} ({modelo.tama√±o_gb}GB)
                        </option>
                      ))}
                    </select>
                  </div>
                )}
                <button 
                  className="btn-chat-action"
                  onClick={abrirModalHistorial}
                  title="Ver historial de chats"
                >
                  üìö Historial ({historialChats.length})
                </button>
                <button 
                  className="btn-chat-action"
                  onClick={nuevoChat}
                  title="Nuevo chat"
                >
                  ‚ûï Nuevo
                </button>
                <button 
                  className="btn-chat-action"
                  onClick={() => setMostrarExploradorChat(!mostrarExploradorChat)}
                  title="Explorador de archivos"
                  style={{
                    backgroundColor: mostrarExploradorChat ? '#646cff' : 'rgba(100, 108, 255, 0.1)',
                    borderColor: mostrarExploradorChat ? '#646cff' : 'rgba(100, 108, 255, 0.3)'
                  }}
                >
                  üìé Archivos {archivosContextoChat.length > 0 && `(${archivosContextoChat.length})`}
                </button>
                {rutaActual && (
                  <button 
                    className="btn-chat-action"
                    onClick={() => {
                      setSelectedMenu('cursos');
                      cargarCarpeta(rutaActual);
                    }}
                    title={`Ir a: ${rutaActual || 'Ra√≠z de Mis Cursos'}`}
                    style={{
                      backgroundColor: 'rgba(255, 152, 0, 0.2)',
                      borderColor: 'rgba(255, 152, 0, 0.5)',
                      color: '#ff9800'
                    }}
                  >
                    üìÇ {rutaActual ? rutaActual.split('/').pop() || 'Cursos' : 'Cursos'}
                  </button>
                )}
                {mensajesChat.length > 0 && (
                  <>
                    <button 
                      className="btn-chat-action btn-save-txt"
                      onClick={abrirGuardarChatTxt}
                      title="Guardar chat completo como TXT"
                      style={{
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        borderColor: 'rgba(76, 175, 80, 0.5)',
                        color: '#4caf50'
                      }}
                    >
                      üíæ Guardar TXT
                    </button>
                  </>
                )}
              </div>
            </div>
            {carpetaChatActual && (
              <div className="chat-carpeta-actual">
                üìÅ {carpetaChatActual}
              </div>
            )}
            {nombreChatNuevo && (
              <div className="chat-nombre-actual">
                üí¨ {nombreChatNuevo} ‚Ä¢ Guardado autom√°tico
              </div>
            )}

            {/* Panel del Explorador de Archivos */}
            {mostrarExploradorChat && (
              <div className="explorador-archivos-chat">
                <div className="explorador-header">
                  <h3>üìé Adjuntar Archivos al Contexto</h3>
                  <button 
                    className="btn-close-explorador"
                    onClick={() => setMostrarExploradorChat(false)}
                  >
                    ‚úï
                  </button>
                </div>

                {/* Tabs para cambiar entre tipos de archivos */}
                <div className="explorador-tabs">
                  <button
                    className={`explorador-tab ${tipoExploradorChat === 'recientes' ? 'active' : ''}`}
                    onClick={() => {
                      setTipoExploradorChat('recientes')
                      cargarArchivosRecientes()
                    }}
                  >
                    üïí Recientes
                  </button>
                  <button
                    className={`explorador-tab ${tipoExploradorChat === 'notas' ? 'active' : ''}`}
                    onClick={() => {
                      setTipoExploradorChat('notas')
                      explorarCarpetaChat('notas', '')
                    }}
                  >
                    üìù Notas
                  </button>
                  <button
                    className={`explorador-tab ${tipoExploradorChat === 'examenes' ? 'active' : ''}`}
                    onClick={() => {
                      setTipoExploradorChat('examenes')
                      explorarCarpetaChat('examenes', '')
                    }}
                  >
                    üìã Ex√°menes
                  </button>
                  <button
                    className={`explorador-tab ${tipoExploradorChat === 'practicas' ? 'active' : ''}`}
                    onClick={() => {
                      setTipoExploradorChat('practicas')
                      explorarCarpetaChat('practicas', '')
                    }}
                  >
                    ‚úÖ Pr√°cticas
                  </button>
                  <button
                    className={`explorador-tab ${tipoExploradorChat === 'flashcards' ? 'active' : ''}`}
                    onClick={() => {
                      setTipoExploradorChat('flashcards')
                      explorarCarpetaChat('flashcards', '')
                    }}
                  >
                    üé¥ Flashcards
                  </button>
                  <button
                    className={`explorador-tab ${tipoExploradorChat === 'cursos' ? 'active' : ''}`}
                    onClick={() => {
                      setTipoExploradorChat('cursos')
                      explorarCarpetaChat('cursos', '')
                    }}
                  >
                    üìö Cursos
                  </button>
                </div>

                {/* Navegaci√≥n de carpetas */}
                {tipoExploradorChat !== 'recientes' && rutaExploradorChat && (
                  <div className="explorador-breadcrumb">
                    <button
                      className="btn-breadcrumb"
                      onClick={() => {
                        const rutaPadre = rutaExploradorChat.split('/').slice(0, -1).join('/')
                        explorarCarpetaChat(tipoExploradorChat, rutaPadre)
                      }}
                    >
                      ‚¨ÖÔ∏è Volver
                    </button>
                    <span className="breadcrumb-path">üìÅ {rutaExploradorChat || 'Ra√≠z'}</span>
                  </div>
                )}

                {/* Lista de carpetas (si no es recientes) */}
                {tipoExploradorChat !== 'recientes' && carpetasExploradorChat.length > 0 && (
                  <div className="explorador-carpetas">
                    <h4>üìÅ Carpetas</h4>
                    <div className="carpetas-list">
                      {carpetasExploradorChat.map((carpeta, idx) => (
                        <button
                          key={idx}
                          className="carpeta-item"
                          onClick={() => explorarCarpetaChat(tipoExploradorChat, carpeta.ruta)}
                        >
                          <span className="carpeta-icon">üìÅ</span>
                          <span className="carpeta-nombre">{carpeta.nombre}</span>
                          <span className="carpeta-count">({carpeta.num_archivos} archivos)</span>
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Lista de archivos */}
                <div className="explorador-archivos">
                  <h4>üìÑ Archivos {tipoExploradorChat === 'recientes' && '(√öltimos 30)'}</h4>
                  {cargandoArchivos ? (
                    <div className="loading-archivos">üîÑ Cargando...</div>
                  ) : archivosRecientes.length === 0 ? (
                    <div className="no-archivos">No hay archivos disponibles</div>
                  ) : (
                    <div className="archivos-list">
                      {archivosRecientes.map((archivo, idx) => {
                        const yaAdjuntado = archivosContextoChat.some(a => a.ruta_completa === archivo.ruta_completa)
                        return (
                          <div key={idx} className={`archivo-item ${yaAdjuntado ? 'adjuntado' : ''}`}>
                            <div className="archivo-info">
                              <span className="archivo-icon">
                                {archivo.tipo === 'Nota' ? 'üìù' :
                                 archivo.tipo === 'Examen' ? 'üìã' :
                                 archivo.tipo === 'Pr√°ctica' ? '‚úÖ' :
                                 archivo.tipo === 'Flashcard' ? 'üé¥' :
                                 archivo.extension === '.pdf' ? 'üìï' :
                                 archivo.extension === '.html' ? 'üåê' :
                                 archivo.extension === '.json' ? 'üìä' :
                                 archivo.extension === '.txt' ? 'üìÑ' : 'üìù'}
                              </span>
                              <div className="archivo-detalles">
                                <span className="archivo-nombre">{archivo.nombre}</span>
                                <span className="archivo-meta">
                                  {archivo.tipo} ‚Ä¢ {archivo.carpeta && `${archivo.carpeta} ‚Ä¢ `}{(archivo.tama√±o / 1024).toFixed(1)} KB ‚Ä¢ 
                                  {new Date(archivo.modificado * 1000).toLocaleDateString('es-ES')}
                                </span>
                              </div>
                            </div>
                            <button
                              className={`btn-adjuntar ${yaAdjuntado ? 'adjuntado' : ''}`}
                              onClick={() => yaAdjuntado ? quitarArchivoContexto(archivo.ruta_completa) : adjuntarArchivoContexto(archivo)}
                              title={yaAdjuntado ? 'Quitar del contexto' : 'Adjuntar al contexto'}
                            >
                              {yaAdjuntado ? '‚úì Adjuntado' : '+ Adjuntar'}
                            </button>
                          </div>
                        )
                      })}
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Mostrar archivos adjuntos al contexto */}
            {archivosContextoChat.length > 0 && (
              <div className="archivos-contexto-activos">
                <div className="contexto-header">
                  <span>üìé Contexto activo ({archivosContextoChat.length} archivo{archivosContextoChat.length > 1 ? 's' : ''})</span>
                  <button
                    className="btn-limpiar-contexto"
                    onClick={limpiarContextoArchivos}
                    title="Limpiar todo el contexto"
                  >
                    üóëÔ∏è Limpiar todo
                  </button>
                </div>
                <div className="contexto-archivos-list">
                  {archivosContextoChat.map((archivo, idx) => (
                    <div key={idx} className="contexto-archivo-chip">
                      <span className="chip-icon">
                        {archivo.extension === '.pdf' ? 'üìï' :
                         archivo.extension === '.html' ? 'üåê' :
                         archivo.extension === '.json' ? 'üìä' : 'üìù'}
                      </span>
                      <span className="chip-nombre">{archivo.nombre}</span>
                      <button
                        className="btn-quitar-chip"
                        onClick={() => quitarArchivoContexto(archivo.ruta_completa)}
                        title="Quitar del contexto"
                      >
                        ‚úï
                      </button>
                    </div>
                  ))}
                </div>
              </div>
            )}

            {!configuracion?.modelo_path || !configuracion?.modelo_activo ? (
              <div className="no-data">
                {!configuracion?.modelo_path ? (
                  <>
                    <p>‚ö†Ô∏è No hay modelo configurado</p>
                    <p>Ve a Configuraci√≥n y selecciona un modelo para comenzar a chatear</p>
                  </>
                ) : (
                  <>
                    <p>‚ö†Ô∏è El modelo est√° configurado pero no cargado</p>
                    <p>Recarga la p√°gina o reinicia el servidor para cargar el modelo</p>
                  </>
                )}
                <button 
                  className="btn-primary"
                  onClick={() => setSelectedMenu('configuracion')}
                >
                  Ir a Configuraci√≥n
                </button>
              </div>
            ) : (
              <>
                <div className="chat-container">
                  <div className="chat-messages">
                    {mensajesChat.length === 0 ? (
                      <div className="chat-empty">
                        <div className="chat-empty-icon">ü§ñ</div>
                        <h3>¬°Hola! Soy tu asistente de IA</h3>
                        <p>Escribe un mensaje para comenzar la conversaci√≥n</p>
                        <div className="chat-suggestions">
                          <button 
                            className="suggestion-btn"
                            onClick={() => setInputChat('Expl√≠came sobre la fotos√≠ntesis')}
                          >
                            Expl√≠came sobre la fotos√≠ntesis
                          </button>
                          <button 
                            className="suggestion-btn"
                            onClick={() => setInputChat('¬øQu√© es la inteligencia artificial?')}
                          >
                            ¬øQu√© es la inteligencia artificial?
                          </button>
                          <button 
                            className="suggestion-btn"
                            onClick={() => setInputChat('Genera 3 preguntas sobre matem√°ticas')}
                          >
                            Genera 3 preguntas sobre matem√°ticas
                          </button>
                        </div>
                      </div>
                    ) : (
                      mensajesChat.map((msg, idx) => (
                        <div key={idx} className={`chat-message ${msg.tipo}`}>
                          <div className="message-icon">
                            {msg.tipo === 'usuario' ? 'üë§' : 'ü§ñ'}
                          </div>
                          <div className="message-content">
                            {editandoMensaje === idx && msg.tipo === 'usuario' ? (
                              <div className="message-edit-container">
                                <textarea
                                  className="message-edit-input"
                                  value={textoEditado}
                                  onChange={(e) => setTextoEditado(e.target.value)}
                                  rows={3}
                                  autoFocus
                                />
                                <div className="message-edit-actions">
                                  <button 
                                    className="btn-edit-save"
                                    onClick={() => guardarEdicionMensaje(idx)}
                                    disabled={!textoEditado.trim()}
                                  >
                                    ‚úì Guardar
                                  </button>
                                  <button 
                                    className="btn-edit-cancel"
                                    onClick={cancelarEdicion}
                                  >
                                    ‚úï Cancelar
                                  </button>
                                </div>
                              </div>
                            ) : (
                              <>
                                <div className="message-text">
                                  {msg.archivo && (
                                    <div className="message-archivo">
                                      üìé {msg.archivo}
                                    </div>
                                  )}
                                  {msg.busqueda_web && (
                                    <div className="message-web">
                                      üåê B√∫squeda web
                                    </div>
                                  )}
                                  {msg.texto}
                                </div>
                                <div className="message-footer">
                                  <div className="message-time">{msg.hora}</div>
                                  {msg.tipo === 'usuario' && !cargandoChat && (
                                    <>
                                      <button 
                                        className="btn-edit-message"
                                        onClick={() => iniciarEdicionMensaje(idx)}
                                        title="Editar mensaje"
                                      >
                                        ‚úèÔ∏è
                                      </button>
                                      {/* Mostrar bot√≥n guardar si hay respuesta siguiente */}
                                      {(() => {
                                        const siguienteMensaje = mensajesChat[idx + 1]
                                        const hayRespuesta = siguienteMensaje && siguienteMensaje.tipo === 'asistente'
                                        console.log(`Mensaje ${idx}: siguiente existe=${!!siguienteMensaje}, es asistente=${hayRespuesta}`)
                                        return hayRespuesta
                                      })() && (
                                        <button 
                                          className="btn-save-consulta"
                                          onClick={() => {
                                            console.log('Click en bot√≥n guardar, √≠ndice:', idx)
                                            abrirGuardarConsultaTxt(idx)
                                          }}
                                          title="Guardar esta consulta como TXT"
                                          style={{
                                            marginLeft: '0.5rem',
                                            padding: '0.5rem 0.75rem',
                                            background: '#4caf50',
                                            border: '2px solid #45a049',
                                            borderRadius: '6px',
                                            color: '#fff',
                                            cursor: 'pointer',
                                            fontSize: '0.9rem',
                                            fontWeight: 'bold',
                                            boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                                          }}
                                        >
                                          üíæ TXT
                                        </button>
                                      )}
                                    </>
                                  )}
                                  {/* Bot√≥n guardar en mensajes del asistente */}
                                  {msg.tipo === 'asistente' && !cargandoChat && (
                                    (() => {
                                      // Buscar el mensaje de usuario anterior
                                      const mensajeAnterior = mensajesChat[idx - 1]
                                      const hayPregunta = mensajeAnterior && mensajeAnterior.tipo === 'usuario'
                                      console.log(`Respuesta ${idx}: anterior existe=${!!mensajeAnterior}, es usuario=${hayPregunta}`)
                                      return hayPregunta
                                    })() && (
                                      <button 
                                        className="btn-save-consulta"
                                        onClick={() => {
                                          // Guardar SOLO la respuesta (sin pregunta)
                                          console.log('Click en bot√≥n guardar (solo respuesta), √≠ndice:', idx)
                                          abrirGuardarRespuestaTxt(idx)
                                        }}
                                        title="Guardar solo esta respuesta como TXT (sin pregunta)"
                                        style={{
                                          marginLeft: '0.5rem',
                                          padding: '0.5rem 0.75rem',
                                          background: '#4caf50',
                                          border: '2px solid #45a049',
                                          borderRadius: '6px',
                                          color: '#fff',
                                          cursor: 'pointer',
                                          fontSize: '0.9rem',
                                          fontWeight: 'bold',
                                          boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
                                        }}
                                      >
                                        üíæ Guardar
                                      </button>
                                    )
                                  )}
                                </div>
                              </>
                            )}
                          </div>
                        </div>
                      ))
                    )}
                    {cargandoChat && (
                      <div className="chat-message asistente">
                        <div className="message-icon">ü§ñ</div>
                        <div className="message-content">
                          <div className="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* √Årea de archivo de contexto */}
                {archivoContexto && (
                  <div className="contexto-archivo">
                    <div className="contexto-info">
                      <span className="contexto-icon">üìé</span>
                      <span className="contexto-nombre">{nombreArchivoContexto}</span>
                      <span className="contexto-size">({(contenidoContexto.length / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button 
                      className="btn-remover-contexto"
                      onClick={removerArchivoContexto}
                      title="Remover archivo"
                    >
                      ‚úï
                    </button>
                  </div>
                )}

                <div className="chat-input-container">
                  <div className="chat-input-wrapper">
                    <textarea
                      className="chat-input"
                      placeholder="Escribe tu mensaje aqu√≠..."
                      value={inputChat}
                      onChange={(e) => setInputChat(e.target.value)}
                      onKeyDown={(e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                          e.preventDefault();
                          enviarMensajeChat();
                        }
                      }}
                      disabled={cargandoChat}
                      rows={3}
                    />
                    <div className="chat-input-actions">
                      <label className="btn-adjuntar" title="Adjuntar PDF o TXT">
                        üìé
                        <input 
                          type="file" 
                          accept=".pdf,.txt"
                          onChange={handleArchivoContexto}
                          style={{ display: 'none' }}
                        />
                      </label>
                      <button 
                        className={`btn-busqueda-web ${busquedaWebActiva ? 'activo' : ''}`}
                        onClick={() => setBusquedaWebActiva(!busquedaWebActiva)}
                        title={busquedaWebActiva ? "B√∫squeda web activada" : "Activar b√∫squeda web"}
                      >
                        üåê
                      </button>
                      {cargandoChat ? (
                        <button 
                          className="btn-stop-chat"
                          onClick={detenerConsulta}
                          title="Detener consulta"
                        >
                          ‚èπÔ∏è Detener
                        </button>
                      ) : (
                        <button 
                          className="btn-send-chat"
                          onClick={enviarMensajeChat}
                          disabled={!inputChat.trim()}
                        >
                          üì§ Enviar
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* Modal para Guardar como TXT */}
            {modalGuardarTxt && (
              <div className="modal-overlay" onClick={() => setModalGuardarTxt(false)}>
                <div className="modal-content modal-guardar-txt" onClick={(e) => e.stopPropagation()}>
                  <div className="modal-header">
                    <h3>üíæ Guardar como TXT</h3>
                    <button className="btn-close-modal" onClick={() => setModalGuardarTxt(false)}>‚úï</button>
                  </div>

                  <div className="modal-body">
                    <div className="info-guardado">
                      {tipoGuardadoTxt === 'chat' ? (
                        <p>
                          <strong>Chat completo:</strong> {mensajesChat.length} mensajes
                        </p>
                      ) : tipoGuardadoTxt === 'respuesta' ? (
                        <div>
                          <p><strong>ü§ñ Solo respuesta del asistente</strong></p>
                          <div style={{
                            background: 'rgba(255,255,255,0.05)',
                            padding: '0.75rem',
                            borderRadius: '8px',
                            marginTop: '0.5rem',
                            fontSize: '0.9rem'
                          }}>
                            <div style={{color: '#999'}}>
                              {consultaAGuardar?.respuesta.texto.substring(0, 150)}...
                            </div>
                          </div>
                        </div>
                      ) : (
                        <div>
                          <p><strong>Consulta completa (pregunta + respuesta)</strong></p>
                          <div style={{
                            background: 'rgba(255,255,255,0.05)',
                            padding: '0.75rem',
                            borderRadius: '8px',
                            marginTop: '0.5rem',
                            fontSize: '0.9rem'
                          }}>
                            <div><strong>üë§ Pregunta:</strong></div>
                            <div style={{color: '#999', marginBottom: '0.5rem'}}>
                              {consultaAGuardar?.pregunta.texto.substring(0, 100)}...
                            </div>
                            <div><strong>ü§ñ Respuesta:</strong></div>
                            <div style={{color: '#999'}}>
                              {consultaAGuardar?.respuesta.texto.substring(0, 100)}...
                            </div>
                          </div>
                        </div>
                      )}
                    </div>

                    <div className="form-group">
                      <label>Nombre del archivo:</label>
                      <input
                        type="text"
                        className="form-input"
                        value={nombreArchivoTxt}
                        onChange={(e) => setNombreArchivoTxt(e.target.value)}
                        placeholder="Mi chat sobre programaci√≥n"
                        autoFocus
                      />
                      <small style={{color: '#999'}}>.txt se agregar√° autom√°ticamente</small>
                    </div>

                    <div className="form-group">
                      <label>Carpeta de destino:</label>
                      
                      {/* Navegaci√≥n de carpetas */}
                      <div className="breadcrumb-navegacion">
                        {rutaGuardadoTxt && (
                          <button
                            className="btn-back"
                            onClick={() => {
                              console.log('üîô Ir atr√°s desde:', rutaGuardadoTxt)
                              const partes = rutaGuardadoTxt.split('/').filter(p => p)
                              const rutaPadre = partes.slice(0, -1).join('/')
                              console.log('üîô Nueva ruta:', rutaPadre)
                              cargarCarpetasCursos(rutaPadre)
                            }}
                          >
                            ‚¨ÖÔ∏è Atr√°s
                          </button>
                        )}
                        <span className="ruta-actual">
                          üìÅ {rutaGuardadoTxt || 'Cursos (ra√≠z)'}
                        </span>
                      </div>

                      {/* Bot√≥n para guardar en carpeta actual */}
                      <div style={{marginBottom: '1rem'}}>
                        <button
                          className="btn-guardar-aqui"
                          style={{
                            width: '100%',
                            padding: '0.75rem',
                            background: 'rgba(76, 175, 80, 0.2)',
                            border: '2px solid #4caf50',
                            borderRadius: '8px',
                            color: '#4caf50',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            transition: 'all 0.3s'
                          }}
                          onMouseEnter={(e) => {
                            e.target.style.background = 'rgba(76, 175, 80, 0.3)'
                            e.target.style.transform = 'scale(1.02)'
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.background = 'rgba(76, 175, 80, 0.2)'
                            e.target.style.transform = 'scale(1)'
                          }}
                          onClick={() => {
                            console.log('üíæ Guardar en:', rutaGuardadoTxt || '(ra√≠z)')
                            guardarComoTxt()
                          }}
                          disabled={!nombreArchivoTxt.trim()}
                        >
                          üíæ Guardar aqu√≠
                        </button>
                      </div>

                      {/* Lista de subcarpetas para navegar */}
                      {(() => {
                        console.log('üóÇÔ∏è Carpetas en estado:', carpetasCursos)
                        console.log('üìè Longitud:', carpetasCursos.length)
                        return carpetasCursos.length > 0
                      })() && (
                        <>
                          <label style={{fontSize: '0.9rem', color: '#999', marginBottom: '0.5rem', display: 'block'}}>
                            O navegar a subcarpetas:
                          </label>
                          <div className="carpetas-selector">
                            {carpetasCursos.map((carpeta, idx) => (
                              <button
                                key={idx}
                                className="carpeta-opcion"
                                onClick={() => {
                                  console.log('üìÇ Navegando a carpeta:', carpeta.ruta)
                                  cargarCarpetasCursos(carpeta.ruta)
                                }}
                              >
                                <span className="carpeta-icon">üìÅ</span>
                                <span>{carpeta.nombre}</span>
                                <span className="carpeta-info">({carpeta.num_archivos} archivos)</span>
                              </button>
                            ))}
                          </div>
                        </>
                      )}

                      {carpetasCursos.length === 0 && rutaGuardadoTxt && (
                        <div className="no-carpetas" style={{fontSize: '0.9rem', color: '#666'}}>
                          Esta carpeta no tiene subcarpetas
                        </div>
                      )}

                      {carpetasCursos.length === 0 && !rutaGuardadoTxt && (
                        <div className="no-carpetas" style={{fontSize: '0.9rem', color: '#999'}}>
                          No hay carpetas de cursos. Crea carpetas en "extracciones/"
                        </div>
                      )}
                    </div>

                    <div className="ruta-seleccionada">
                      <strong>üìÇ Ruta de guardado:</strong> extracciones/{rutaGuardadoTxt ? rutaGuardadoTxt + '/' : ''}{nombreArchivoTxt || 'archivo'}.txt
                    </div>
                  </div>

                  <div className="modal-footer">
                    <button 
                      className="btn-secondary"
                      onClick={() => setModalGuardarTxt(false)}
                    >
                      Cancelar
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {selectedMenu === 'configuracion' && (
          <div className="content-section">
            <h1>‚öôÔ∏è Configuraci√≥n</h1>
            <p className="subtitle">Ajusta el modelo de IA para generar ex√°menes</p>

            {cargandoConfig ? (
              <p className="loading">Cargando configuraci√≥n...</p>
            ) : (
              <>
                <div className="config-section">
                  <h2>üéÆ Modo de Ejecuci√≥n</h2>
                  <p className="subtitle" style={{marginBottom: '1.5rem'}}>
                    Selecciona si quieres usar GPU o CPU
                  </p>

                  <div className="motor-selector">
                    <div 
                      className={`motor-opcion ${configuracion?.gpu_activa && configuracion?.usar_ollama ? 'seleccionada' : ''}`}
                      onClick={async () => {
                        try {
                          setLoading(true)
                          const response = await fetch(`${API_URL}/api/motor/cambiar`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                              usar_ollama: true,
                              modelo_ollama: configuracion?.modelo_ollama_activo || 'qwen-local:latest',
                              n_gpu_layers: 35
                            })
                          })
                          const data = await response.json()
                          if (data.success) {
                            setMensaje({tipo: 'exito', texto: '‚úÖ Ollama GPU activado'})
                            await new Promise(resolve => setTimeout(resolve, 100))
                            await cargarConfiguracion()
                          }
                        } catch (error) {
                          setMensaje({tipo: 'error', texto: '‚ùå Error: ' + error.message})
                        } finally {
                          setLoading(false)
                        }
                      }}
                    >
                      <div className="motor-icon">üéÆ</div>
                      <h3>Ollama GPU</h3>
                      <div className="motor-badge motor-badge-gpu">Recomendado</div>
                      <p className="motor-descripcion">
                        Ollama con aceleraci√≥n de tarjeta gr√°fica
                      </p>
                    </div>

                    <div 
                      className={`motor-opcion ${!configuracion?.gpu_activa && configuracion?.usar_ollama ? 'seleccionada' : ''}`}
                      onClick={async () => {
                        try {
                          setLoading(true)
                          console.log('üî∑ Activando Ollama CPU...')
                          console.log('Configuraci√≥n actual:', configuracion)
                          
                          const payload = {
                            usar_ollama: true,
                            modelo_ollama: configuracion?.modelo_ollama_activo || 'qwen-local:latest',
                            n_gpu_layers: 0
                          }
                          console.log('Enviando payload:', payload)
                          
                          const response = await fetch(`${API_URL}/api/motor/cambiar`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                          })
                          const data = await response.json()
                          console.log('Respuesta del servidor:', data)
                          
                          if (data.success) {
                            setMensaje({tipo: 'exito', texto: '‚úÖ Ollama CPU activado'})
                            // Peque√±o delay para asegurar que el backend guard√≥ todo
                            await new Promise(resolve => setTimeout(resolve, 100))
                            await cargarConfiguracion()
                            console.log('‚úÖ Configuraci√≥n recargada')
                          } else {
                            setMensaje({tipo: 'error', texto: '‚ùå Error: ' + (data.detail || data.mensaje)})
                          }
                        } catch (error) {
                          console.error('Error activando Ollama CPU:', error)
                          setMensaje({tipo: 'error', texto: '‚ùå Error: ' + error.message})
                        } finally {
                          setLoading(false)
                        }
                      }}
                    >
                      <div className="motor-icon">üî∑</div>
                      <h3>Ollama CPU</h3>
                      <div className="motor-badge motor-badge-ollama-cpu">Sin GPU</div>
                      <p className="motor-descripcion">
                        Ollama usando solo procesador (ahorra GPU)
                      </p>
                    </div>

                    <div 
                      className={`motor-opcion ${!configuracion?.usar_ollama ? 'seleccionada' : ''}`}
                      onClick={async () => {
                        if (!configuracion?.modelo_path) {
                          setMensaje({tipo: 'error', texto: '‚ö†Ô∏è Primero configura un modelo GGUF abajo'})
                          return
                        }
                        try {
                          setLoading(true)
                          const response = await fetch(`${API_URL}/api/motor/cambiar`, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                              usar_ollama: false,
                              modelo_gguf: configuracion.modelo_path,
                              n_gpu_layers: 0
                            })
                          })
                          const data = await response.json()
                          if (data.success) {
                            setMensaje({tipo: 'exito', texto: '‚úÖ GGUF CPU activado'})
                            await new Promise(resolve => setTimeout(resolve, 100))
                            await cargarConfiguracion()
                          }
                        } catch (error) {
                          setMensaje({tipo: 'error', texto: '‚ùå Error: ' + error.message})
                        } finally {
                          setLoading(false)
                        }
                      }}
                    >
                      <div className="motor-icon">üíª</div>
                      <h3>GGUF CPU</h3>
                      <div className="motor-badge motor-badge-manual">M√°s lento</div>
                      <p className="motor-descripcion">
                        Modelos GGUF locales en procesador
                      </p>
                    </div>

                    <div 
                      className="motor-opcion"
                      onClick={() => {
                        setMensaje({tipo: 'info', texto: 'üí° Configura tu API Externa en la pesta√±a de modelos abajo'})
                        setPestanaModelos('api')
                        setMostrarModelos(true)
                      }}
                    >
                      <div className="motor-icon">üåê</div>
                      <h3>API Externa</h3>
                      <div className="motor-badge motor-badge-api">Cloud</div>
                      <p className="motor-descripcion">
                        Conecta con ChatGPT, DeepSeek u otras APIs
                      </p>
                    </div>
                  </div>

                  {/* Estado actual */}
                  <div className="motor-estado-actual">
                    {configuracion?.usar_ollama ? (
                      <div className="estado-activo">
                        {configuracion?.gpu_activa ? 'üéÆ' : 'üî∑'} <strong>Modo activo:</strong> Ollama {configuracion?.gpu_activa ? 'GPU' : 'CPU'} | 
                        ü§ñ <strong>Modelo:</strong> {configuracion.modelo_cargado || 'N/A'}
                      </div>
                    ) : (
                      <div className="estado-activo">
                        üíª <strong>Modo activo:</strong> GGUF CPU | 
                        ü§ñ <strong>Modelo:</strong> {configuracion.modelo_cargado ? configuracion.modelo_cargado.split('\\').pop() : 'N/A'}
                      </div>
                    )}
                  </div>
                </div>

                {/* Modelos con pesta√±as - Expandible */}
                <div className="config-section">
                  <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', cursor: 'pointer'}} onClick={() => setMostrarModelos(!mostrarModelos)}>
                    <h2>ü§ñ Gesti√≥n de Modelos</h2>
                    <button className="btn-toggle-descarga">
                      {mostrarModelos ? '‚ñº Ocultar' : '‚ñ∂ Mostrar'}
                    </button>
                  </div>
                  
                  {mostrarModelos && (
                    <>
                  
                  {/* Pesta√±as */}
                  <div className="pestanas-modelos">
                    <button 
                      className={`pestana-btn ${pestanaModelos === 'ollama' ? 'activa' : ''}`}
                      onClick={() => setPestanaModelos('ollama')}
                    >
                      üéÆ Modelos Ollama (GPU)
                    </button>
                    <button 
                      className={`pestana-btn ${pestanaModelos === 'ollama-cpu' ? 'activa' : ''}`}
                      onClick={() => setPestanaModelos('ollama-cpu')}
                    >
                      üíª Modelos Ollama (CPU)
                    </button>
                    <button 
                      className={`pestana-btn ${pestanaModelos === 'gguf' ? 'activa' : ''}`}
                      onClick={() => setPestanaModelos('gguf')}
                    >
                      üì¶ Modelos GGUF (CPU)
                    </button>
                    <button 
                      className={`pestana-btn ${pestanaModelos === 'api' ? 'activa' : ''}`}
                      onClick={() => setPestanaModelos('api')}
                    >
                      üåê API Externa
                    </button>
                  </div>

                  {/* Contenido de Ollama */}
                  {pestanaModelos === 'ollama' && (
                    <div className="pestana-contenido" style={{position: 'relative'}}>
                      <p className="subtitle">Modelos que usan GPU autom√°ticamente</p>
                      
                      {/* Botones flotantes en esquina superior derecha */}
                      <div style={{
                        position: 'absolute',
                        top: '10px',
                        right: '10px',
                        display: 'flex',
                        gap: '8px',
                        zIndex: 10
                      }}>
                        {/* Bot√≥n de reparaci√≥n/reactivaci√≥n */}
                        <button
                          className="btn-reparar-motor"
                          onClick={async () => {
                            try {
                              setLoading(true)
                              const responseReparar = await fetch(`${API_URL}/api/motor/reparar`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'}
                              })
                              const dataReparar = await responseReparar.json()
                              
                              if (dataReparar.success) {
                                setMensaje({tipo: 'exito', texto: dataReparar.mensaje})
                                await cargarConfiguracion()
                                // Recargar lista de modelos
                                const responseModelos = await fetch(`${API_URL}/api/ollama/modelos`)
                                const dataModelos = await responseModelos.json()
                                if (dataModelos.success) {
                                  setModelosOllama(dataModelos.modelos)
                                }
                              } else {
                                setMensaje({tipo: 'error', texto: '‚ùå ' + (dataReparar.detail || dataReparar.mensaje)})
                              }
                            } catch (error) {
                              setMensaje({tipo: 'error', texto: '‚ùå Error reparando: ' + error.message})
                            } finally {
                              setLoading(false)
                            }
                          }}
                          title="üîß Reparar motor de IA (reinicia el generador sin cambiar configuraci√≥n)"
                          disabled={loading}
                          style={{
                            width: '42px',
                            height: '42px',
                            borderRadius: '12px',
                            background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                            border: 'none',
                            color: 'white',
                            fontSize: '20px',
                            cursor: 'pointer',
                            boxShadow: '0 3px 10px rgba(245, 158, 11, 0.3)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'all 0.3s ease',
                            opacity: loading ? 0.5 : 1
                          }}
                          onMouseEnter={(e) => {
                            if (!loading) {
                              e.target.style.transform = 'scale(1.05) translateY(-2px)';
                              e.target.style.boxShadow = '0 5px 15px rgba(245, 158, 11, 0.5)';
                            }
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.transform = 'scale(1) translateY(0)';
                            e.target.style.boxShadow = '0 3px 10px rgba(245, 158, 11, 0.3)';
                          }}
                        >
                          üîß
                        </button>

                        {/* Bot√≥n de instalaci√≥n */}
                        <button
                          onClick={() => setModalInstaladorModelo(true)}
                          title="Instalar nuevo modelo GGUF"
                          style={{
                            width: '42px',
                            height: '42px',
                            borderRadius: '12px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            border: 'none',
                            color: 'white',
                            fontSize: '24px',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            boxShadow: '0 3px 10px rgba(102, 126, 234, 0.3)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'all 0.3s ease'
                          }}
                          onMouseEnter={(e) => {
                            e.target.style.transform = 'scale(1.05) translateY(-2px)';
                            e.target.style.boxShadow = '0 5px 15px rgba(102, 126, 234, 0.5)';
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.transform = 'scale(1) translateY(0)';
                            e.target.style.boxShadow = '0 3px 10px rgba(102, 126, 234, 0.3)';
                          }}
                        >
                          +
                        </button>
                      </div>
                      
                      <button 
                        onClick={async () => {
                          try {
                            setLoading(true)
                            const response = await fetch(`${API_URL}/api/ollama/modelos`)
                            const data = await response.json()
                            if (data.success) {
                              setModelosOllama(data.modelos)
                              setMensaje({tipo: 'exito', texto: `‚úÖ ${data.total} modelos encontrados`})
                            } else {
                              setMensaje({tipo: 'error', texto: '‚ö†Ô∏è ' + data.mensaje})
                            }
                          } catch (error) {
                            setMensaje({tipo: 'error', texto: '‚ùå Error: ' + error.message})
                          } finally {
                            setLoading(false)
                          }
                        }}
                        className="btn-refrescar-ollama"
                        disabled={loading}
                      >
                        üîÑ Cargar Modelos de Ollama
                      </button>

                      {modelosOllama.length > 0 ? (
                        <div className="modelos-ollama-grid">
                          {modelosOllama.map(modelo => (
                            <div 
                              key={modelo.nombre}
                              className={`modelo-ollama-card ${configuracion?.modelo_ollama_activo === modelo.nombre ? 'seleccionado' : ''}`}
                            >
                              <div className="modelo-ollama-header">
                                <h3>ü§ñ {modelo.nombre}</h3>
                                <span className="modelo-badge modelo-badge-gpu">{modelo.tipo}</span>
                              </div>
                              <div className="modelo-ollama-info">
                                <div className="info-item">
                                  <span className="info-label">Tama√±o:</span>
                                  <span className="info-value">{modelo.tama√±o_gb} GB</span>
                                </div>
                                <div className="info-item">
                                  <span className="info-label">Velocidad:</span>
                                  <span className="info-value">{modelo.velocidad}</span>
                                </div>
                                <div className="info-item">
                                  <span className="info-label">ID:</span>
                                  <span className="info-value" style={{fontSize: '0.8rem'}}>{modelo.digest}</span>
                                </div>
                              </div>
                              <div className="modelo-ollama-actions">
                                <button
                                  className="btn-activar-modelo"
                                  onClick={async (e) => {
                                    e.stopPropagation()
                                    try {
                                      setLoading(true)
                                      const responseMotor = await fetch(`${API_URL}/api/motor/cambiar`, {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify({
                                          usar_ollama: true,
                                          modelo_ollama: modelo.nombre,
                                          n_gpu_layers: 35
                                        })
                                      })
                                      const dataMotor = await responseMotor.json()
                                      
                                      if (dataMotor.success) {
                                        setMensaje({tipo: 'exito', texto: `‚úÖ Modelo ${modelo.nombre} activado con GPU`})
                                        // Actualizar inmediatamente la configuraci√≥n local
                                        setConfiguracion(prev => ({
                                          ...prev,
                                          modelo_ollama_activo: modelo.nombre,
                                          usar_ollama: true,
                                          gpu_activa: true,
                                          n_gpu_layers: 35
                                        }))
                                        // Tambi√©n recargar del servidor
                                        await cargarConfiguracion()
                                      }
                                    } catch (error) {
                                      setMensaje({tipo: 'error', texto: '‚ùå Error: ' + error.message})
                                    } finally {
                                      setLoading(false)
                                    }
                                  }}
                                  disabled={configuracion?.modelo_ollama_activo === modelo.nombre}
                                >
                                  {configuracion?.modelo_ollama_activo === modelo.nombre ? '‚úì Activo' : 'üöÄ Activar'}
                                </button>
                                <button
                                  className="btn-eliminar-modelo"
                                  onClick={async (e) => {
                                    e.stopPropagation()
                                    if (!window.confirm(`¬øEst√°s seguro de eliminar el modelo "${modelo.nombre}"?\n\nEsto liberar√° ${modelo.tama√±o_gb} GB de espacio.`)) {
                                      return
                                    }
                                    try {
                                      setLoading(true)
                                      const response = await fetch(`${API_URL}/api/ollama/modelo/${encodeURIComponent(modelo.nombre)}`, {
                                        method: 'DELETE'
                                      })
                                      const data = await response.json()
                                      
                                      if (data.success) {
                                        setMensaje({tipo: 'exito', texto: data.mensaje})
                                        // Recargar lista de modelos
                                        const responseModelos = await fetch(`${API_URL}/api/ollama/modelos`)
                                        const dataModelos = await responseModelos.json()
                                        if (dataModelos.success) {
                                          setModelosOllama(dataModelos.modelos)
                                        }
                                      } else {
                                        setMensaje({tipo: 'error', texto: data.mensaje})
                                      }
                                    } catch (error) {
                                      setMensaje({tipo: 'error', texto: '‚ùå Error: ' + error.message})
                                    } finally {
                                      setLoading(false)
                                    }
                                  }}
                                  disabled={configuracion?.modelo_ollama_activo === modelo.nombre}
                                  title={configuracion?.modelo_ollama_activo === modelo.nombre ? 'No puedes eliminar el modelo activo' : 'Eliminar modelo'}
                                >
                                  üóëÔ∏è
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="empty-state">
                          <p>üì≠ No hay modelos de Ollama cargados</p>
                          <p className="empty-hint">
                            Haz clic en "Cargar Modelos" o instala modelos con: <code>ollama pull llama3.2:3b</code>
                          </p>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Contenido de Ollama CPU */}
                  {pestanaModelos === 'ollama-cpu' && (
                    <div className="pestana-contenido" style={{position: 'relative'}}>
                      <p className="subtitle">Modelos Ollama que usan solo CPU (ahorra GPU)</p>
                      
                      {/* Botones flotantes en esquina superior derecha */}
                      <div style={{
                        position: 'absolute',
                        top: '10px',
                        right: '10px',
                        display: 'flex',
                        gap: '8px',
                        zIndex: 10
                      }}>
                        {/* Bot√≥n de reparaci√≥n/reactivaci√≥n */}
                        <button
                          className="btn-reparar-motor"
                          onClick={async () => {
                            try {
                              setLoading(true)
                              const responseReparar = await fetch(`${API_URL}/api/motor/reparar`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'}
                              })
                              const dataReparar = await responseReparar.json()
                              
                              if (dataReparar.success) {
                                setMensaje({tipo: 'exito', texto: dataReparar.mensaje})
                                await cargarConfiguracion()
                                // Recargar lista de modelos
                                const responseModelos = await fetch(`${API_URL}/api/ollama/modelos`)
                                const dataModelos = await responseModelos.json()
                                if (dataModelos.success) {
                                  setModelosOllama(dataModelos.modelos)
                                }
                              } else {
                                setMensaje({tipo: 'error', texto: '‚ùå ' + (dataReparar.detail || dataReparar.mensaje)})
                              }
                            } catch (error) {
                              setMensaje({tipo: 'error', texto: '‚ùå Error reparando: ' + error.message})
                            } finally {
                              setLoading(false)
                            }
                          }}
                          title="üîß Reparar motor de IA (reinicia el generador sin cambiar configuraci√≥n)"
                          disabled={loading}
                          style={{
                            width: '42px',
                            height: '42px',
                            borderRadius: '12px',
                            background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
                            border: 'none',
                            color: 'white',
                            fontSize: '20px',
                            cursor: 'pointer',
                            boxShadow: '0 3px 10px rgba(245, 158, 11, 0.3)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'all 0.3s ease',
                            opacity: loading ? 0.5 : 1
                          }}
                          onMouseEnter={(e) => {
                            if (!loading) {
                              e.target.style.transform = 'scale(1.05) translateY(-2px)';
                              e.target.style.boxShadow = '0 5px 15px rgba(245, 158, 11, 0.5)';
                            }
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.transform = 'scale(1) translateY(0)';
                            e.target.style.boxShadow = '0 3px 10px rgba(245, 158, 11, 0.3)';
                          }}
                        >
                          üîß
                        </button>

                        {/* Bot√≥n de instalaci√≥n */}
                        <button
                          onClick={() => setModalInstaladorModelo(true)}
                          title="Instalar nuevo modelo desde Ollama"
                          style={{
                            width: '42px',
                            height: '42px',
                            borderRadius: '12px',
                            background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                            border: 'none',
                            color: 'white',
                            fontSize: '24px',
                            fontWeight: 'bold',
                            cursor: 'pointer',
                            boxShadow: '0 3px 10px rgba(102, 126, 234, 0.3)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            transition: 'all 0.3s ease'
                          }}
                          onMouseEnter={(e) => {
                            e.target.style.transform = 'scale(1.05) translateY(-2px)';
                            e.target.style.boxShadow = '0 5px 15px rgba(102, 126, 234, 0.5)';
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.transform = 'scale(1) translateY(0)';
                            e.target.style.boxShadow = '0 3px 10px rgba(102, 126, 234, 0.3)';
                          }}
                        >
                          +
                        </button>
                      </div>
                      
                      <button 
                        onClick={async () => {
                          try {
                            setLoading(true)
                            const response = await fetch(`${API_URL}/api/ollama/modelos`)
                            const data = await response.json()
                            if (data.success) {
                              setModelosOllama(data.modelos)
                              setMensaje({tipo: 'exito', texto: `‚úÖ ${data.total} modelos encontrados`})
                            } else {
                              setMensaje({tipo: 'error', texto: '‚ö†Ô∏è ' + data.mensaje})
                            }
                          } catch (error) {
                            setMensaje({tipo: 'error', texto: '‚ùå Error: ' + error.message})
                          } finally {
                            setLoading(false)
                          }
                        }}
                        className="btn-refrescar-ollama"
                        disabled={loading}
                      >
                        üîÑ Cargar Modelos de Ollama
                      </button>

                      {modelosOllama.length > 0 ? (
                        <div className="modelos-ollama-grid">
                          {modelosOllama.map(modelo => (
                            <div 
                              key={modelo.nombre}
                              className={`modelo-ollama-card ${!configuracion?.gpu_activa && configuracion?.modelo_ollama_activo === modelo.nombre ? 'seleccionado' : ''}`}
                            >
                              <div className="modelo-ollama-header">
                                <h3>ü§ñ {modelo.nombre}</h3>
                                <span className="modelo-badge modelo-badge-ollama-cpu">{modelo.tipo}</span>
                              </div>
                              <div className="modelo-ollama-info">
                                <div className="info-item">
                                  <span className="info-label">Tama√±o:</span>
                                  <span className="info-value">{modelo.tama√±o_gb} GB</span>
                                </div>
                                <div className="info-item">
                                  <span className="info-label">Velocidad:</span>
                                  <span className="info-value">{modelo.velocidad}</span>
                                </div>
                                <div className="info-item">
                                  <span className="info-label">ID:</span>
                                  <span className="info-value" style={{fontSize: '0.8rem'}}>{modelo.digest}</span>
                                </div>
                              </div>
                              <div className="modelo-ollama-actions">
                                <button
                                  className="btn-activar-modelo"
                                  onClick={async (e) => {
                                    e.stopPropagation()
                                    try {
                                      setLoading(true)
                                      const responseMotor = await fetch(`${API_URL}/api/motor/cambiar`, {
                                        method: 'POST',
                                        headers: {'Content-Type': 'application/json'},
                                        body: JSON.stringify({
                                          usar_ollama: true,
                                          modelo_ollama: modelo.nombre,
                                          n_gpu_layers: 0
                                        })
                                      })
                                      const dataMotor = await responseMotor.json()
                                      
                                      if (dataMotor.success) {
                                        setMensaje({tipo: 'exito', texto: `‚úÖ Modelo ${modelo.nombre} activado en CPU`})
                                        await cargarConfiguracion()
                                      }
                                    } catch (error) {
                                      setMensaje({tipo: 'error', texto: '‚ùå Error: ' + error.message})
                                    } finally {
                                      setLoading(false)
                                    }
                                  }}
                                  disabled={!configuracion?.gpu_activa && configuracion?.modelo_ollama_activo === modelo.nombre}
                                >
                                  {!configuracion?.gpu_activa && configuracion?.modelo_ollama_activo === modelo.nombre ? '‚úì Activo en CPU' : 'üíª Activar en CPU'}
                                </button>
                                <button
                                  className="btn-eliminar-modelo"
                                  onClick={async (e) => {
                                    e.stopPropagation()
                                    if (!window.confirm(`¬øEst√°s seguro de eliminar el modelo "${modelo.nombre}"?\n\nEsto liberar√° ${modelo.tama√±o_gb} GB de espacio.`)) {
                                      return
                                    }
                                    try {
                                      setLoading(true)
                                      const response = await fetch(`${API_URL}/api/ollama/modelo/${encodeURIComponent(modelo.nombre)}`, {
                                        method: 'DELETE'
                                      })
                                      const data = await response.json()
                                      
                                      if (data.success) {
                                        setMensaje({tipo: 'exito', texto: data.mensaje})
                                        // Recargar lista de modelos
                                        const responseModelos = await fetch(`${API_URL}/api/ollama/modelos`)
                                        const dataModelos = await responseModelos.json()
                                        if (dataModelos.success) {
                                          setModelosOllama(dataModelos.modelos)
                                        }
                                      } else {
                                        setMensaje({tipo: 'error', texto: data.mensaje})
                                      }
                                    } catch (error) {
                                      setMensaje({tipo: 'error', texto: '‚ùå Error: ' + error.message})
                                    } finally {
                                      setLoading(false)
                                    }
                                  }}
                                  disabled={!configuracion?.gpu_activa && configuracion?.modelo_ollama_activo === modelo.nombre}
                                  title={!configuracion?.gpu_activa && configuracion?.modelo_ollama_activo === modelo.nombre ? 'No puedes eliminar el modelo activo' : 'Eliminar modelo'}
                                >
                                  üóëÔ∏è
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="empty-state">
                          <p>üì≠ No hay modelos de Ollama cargados</p>
                          <p className="empty-hint">
                            Haz clic en "Cargar Modelos" o instala modelos con: <code>ollama pull llama3.2:3b</code>
                          </p>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Contenido de GGUF */}
                  {pestanaModelos === 'gguf' && (
                    <div className="pestana-contenido">
                      <p className="subtitle">Modelos que se ejecutan en CPU</p>
                      
                      {/* Bot√≥n de descargar modelos movido aqu√≠ */}
                      <div style={{marginBottom: '1.5rem'}}>
                        <button 
                          onClick={() => setMostrarDescarga(!mostrarDescarga)}
                          className="btn-toggle-descarga"
                        >
                          üì• {mostrarDescarga ? 'Ocultar' : 'Descargar Modelos'} ({modelosParaDescargar.length} disponibles)
                        </button>
                      </div>

                      {mostrarDescarga && (
                        <>
                          <p style={{color: '#b0b0c0', marginBottom: '1.5rem', fontSize: '0.95rem'}}>
                            Modelos optimizados para generar ex√°menes. Los modelos marcados con üîí requieren autenticaci√≥n de HuggingFace.
                          </p>
                          <div className="modelos-descarga-grid">
                            {modelosParaDescargar.map(modelo => (
                              <div key={modelo.id} className={`modelo-descarga-card ${modelo.descargado ? 'descargado' : ''}`}>
                                <div className="modelo-header">
                                  <div>
                                    <h3>ü§ñ {modelo.nombre}</h3>
                                    {modelo.recomendado && <span className="badge-recomendado">‚≠ê Recomendado</span>}
                                  </div>
                                  <span className="modelo-badge">{modelo.tama√±o_modelo}</span>
                                </div>
                                <div className="modelo-stats">
                                  <div className="stat">
                                    <span className="stat-label">Tama√±o:</span>
                                    <span className="stat-value">{modelo.tama√±o_gb} GB</span>
                                  </div>
                                  <div className="stat">
                                    <span className="stat-label">Velocidad:</span>
                                    <span className="stat-value">{modelo.velocidad}</span>
                                  </div>
                                </div>
                                <div className="modelo-descripcion">
                                  <p>{modelo.descripcion}</p>
                                </div>
                                {modelo.descargado ? (
                                  <div className="modelo-descargado-badge">‚úÖ Ya descargado</div>
                                ) : (
                                  <button
                                    onClick={async () => {
                                      try {
                                        setLoading(true)
                                        setMensaje({tipo: 'info', texto: `üì• Descargando ${modelo.nombre}...`})
                                        
                                        const response = await fetch(`${API_URL}/api/descargar-modelo`, {
                                          method: 'POST',
                                          headers: {'Content-Type': 'application/json'},
                                          body: JSON.stringify({
                                            modelo_id: modelo.id,
                                            url: modelo.url,
                                            nombre: modelo.nombre
                                          })
                                        })
                                        
                                        const data = await response.json()
                                        if (data.success) {
                                          setMensaje({tipo: 'exito', texto: `‚úÖ ${modelo.nombre} descargado`})
                                          cargarModelosDisponibles()
                                        } else {
                                          setMensaje({tipo: 'error', texto: data.mensaje || 'Error en la descarga'})
                                        }
                                      } catch (error) {
                                        setMensaje({tipo: 'error', texto: `‚ùå Error: ${error.message}`})
                                      } finally {
                                        setLoading(false)
                                      }
                                    }}
                                    className="btn-descargar-modelo"
                                    disabled={loading}
                                  >
                                    üì• Descargar
                                  </button>
                                )}
                              </div>
                            ))}
                          </div>
                        </>
                      )}
                      
                      <hr style={{margin: '2rem 0', border: 'none', borderTop: '1px solid #2a2a3e'}} />
                      
                      <h3 style={{marginBottom: '1rem'}}>üíæ Modelos Instalados</h3>
                      
                      {modelosDisponibles.length > 0 ? (
                        <div className="modelos-grid">
                          {modelosDisponibles.map(modelo => (
                            <div 
                              key={modelo.ruta}
                              className={`modelo-card ${modeloSeleccionado === modelo.ruta ? 'seleccionado' : ''}`}
                              onClick={async () => {
                                try {
                                  setLoading(true)
                                  setModeloSeleccionado(modelo.ruta)
                                  
                                  // Cambiar a modo CPU con este modelo
                                  const response = await fetch(`${API_URL}/api/motor/cambiar`, {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({
                                      usar_ollama: false,
                                      modelo_gguf: modelo.ruta,
                                      n_gpu_layers: 0
                                    })
                                  })
                                  const data = await response.json()
                                  
                                  if (data.success) {
                                    // Guardar configuraci√≥n
                                    await fetch(`${API_URL}/api/config`, {
                                      method: 'POST',
                                      headers: {'Content-Type': 'application/json'},
                                      body: JSON.stringify({
                                        modelo_path: modelo.ruta,
                                        ajustes_avanzados: ajustesAvanzados
                                      })
                                    })
                                    
                                    setMensaje({tipo: 'exito', texto: `‚úÖ Modelo ${modelo.nombre} activado en CPU`})
                                    cargarConfiguracion()
                                  }
                                } catch (error) {
                                  setMensaje({tipo: 'error', texto: '‚ùå Error: ' + error.message})
                                } finally {
                                  setLoading(false)
                                }
                              }}
                            >
                              <div className="modelo-header">
                                <h3>ü§ñ {modelo.nombre}</h3>
                                <span className="modelo-badge modelo-badge-manual">{modelo.tama√±o_modelo}</span>
                              </div>
                              
                              <div className="modelo-stats">
                                <div className="stat">
                                  <span className="stat-label">Tama√±o:</span>
                                  <span className="stat-value">{modelo.tama√±o_gb} GB</span>
                                </div>
                                <div className="stat">
                                  <span className="stat-label">Par√°metros:</span>
                                  <span className="stat-value">{modelo.parametros}</span>
                                </div>
                                <div className="stat">
                                  <span className="stat-label">Velocidad:</span>
                                  <span className="stat-value">{modelo.velocidad}</span>
                                </div>
                                <div className="stat">
                                  <span className="stat-label">RAM necesaria:</span>
                                  <span className="stat-value">{modelo.ram_necesaria}</span>
                                </div>
                              </div>

                              <div className="modelo-descripcion">
                                <p><strong>Calidad:</strong> {modelo.calidad}</p>
                                <p>{modelo.descripcion}</p>
                              </div>

                              {!configuracion?.gpu_activa && configuracion?.modelo_path === modelo.ruta && (
                                <div className="modelo-seleccionado-badge">
                                  ‚úì Activo en CPU
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      ) : (
                        <div className="empty-state">
                          <p>üí≠ No hay modelos GGUF instalados</p>
                          <p className="empty-hint">Descarga modelos desde la secci√≥n de abajo</p>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Contenido de API Externa */}
                  {pestanaModelos === 'api' && (
                    <div className="pestana-contenido">
                      <p className="subtitle">Conecta con servicios de IA en la nube</p>
                      
                      <div style={{
                        background: 'linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05))',
                        border: '2px solid rgba(59, 130, 246, 0.3)',
                        borderRadius: '12px',
                        padding: '1.5rem',
                        marginBottom: '2rem'
                      }}>
                        <h3 style={{color: '#3b82f6', marginBottom: '1rem'}}>üåê Configuraci√≥n de API Externa</h3>
                        
                        {/* Selector de Provider */}
                        <div style={{marginBottom: '1.5rem'}}>
                          <label style={{display: 'block', color: '#fff', marginBottom: '0.5rem', fontWeight: '600'}}>
                            Proveedor de API
                          </label>
                          <select 
                            style={{
                              width: '100%',
                              padding: '0.75rem',
                              background: 'rgba(26, 26, 46, 0.8)',
                              border: '2px solid rgba(59, 130, 246, 0.3)',
                              borderRadius: '8px',
                              color: '#fff',
                              fontSize: '1rem',
                              cursor: 'pointer'
                            }}
                            defaultValue="chatgpt"
                          >
                            <option value="chatgpt">ü§ñ ChatGPT (OpenAI)</option>
                            <option value="deepseek">üß† DeepSeek API</option>
                            <option value="anthropic">üé≠ Claude (Anthropic)</option>
                            <option value="custom">üîß API Personalizada</option>
                          </select>
                        </div>

                        {/* API Key */}
                        <div style={{marginBottom: '1.5rem'}}>
                          <label style={{display: 'block', color: '#fff', marginBottom: '0.5rem', fontWeight: '600'}}>
                            API Key üîë
                          </label>
                          <input 
                            type="password"
                            placeholder="sk-..."
                            style={{
                              width: '100%',
                              padding: '0.75rem',
                              background: 'rgba(26, 26, 46, 0.8)',
                              border: '2px solid rgba(59, 130, 246, 0.3)',
                              borderRadius: '8px',
                              color: '#fff',
                              fontSize: '1rem'
                            }}
                          />
                          <p style={{color: '#808090', fontSize: '0.85rem', marginTop: '0.5rem'}}>
                            üí° Tu clave API se almacena localmente y nunca se comparte
                          </p>
                        </div>

                        {/* Modelo */}
                        <div style={{marginBottom: '1.5rem'}}>
                          <label style={{display: 'block', color: '#fff', marginBottom: '0.5rem', fontWeight: '600'}}>
                            Modelo a utilizar
                          </label>
                          <input 
                            type="text"
                            placeholder="gpt-4o, deepseek-chat, claude-3-5-sonnet..."
                            defaultValue="gpt-4o"
                            style={{
                              width: '100%',
                              padding: '0.75rem',
                              background: 'rgba(26, 26, 46, 0.8)',
                              border: '2px solid rgba(59, 130, 246, 0.3)',
                              borderRadius: '8px',
                              color: '#fff',
                              fontSize: '1rem'
                            }}
                          />
                        </div>

                        {/* Endpoint URL (opcional) */}
                        <div style={{marginBottom: '1.5rem'}}>
                          <label style={{display: 'block', color: '#fff', marginBottom: '0.5rem', fontWeight: '600'}}>
                            Endpoint URL (opcional)
                          </label>
                          <input 
                            type="text"
                            placeholder="https://api.openai.com/v1/chat/completions"
                            style={{
                              width: '100%',
                              padding: '0.75rem',
                              background: 'rgba(26, 26, 46, 0.8)',
                              border: '2px solid rgba(59, 130, 246, 0.3)',
                              borderRadius: '8px',
                              color: '#fff',
                              fontSize: '1rem'
                            }}
                          />
                          <p style={{color: '#808090', fontSize: '0.85rem', marginTop: '0.5rem'}}>
                            ‚öôÔ∏è Deja en blanco para usar el endpoint por defecto del proveedor
                          </p>
                        </div>

                        {/* Par√°metros */}
                        <div style={{
                          display: 'grid',
                          gridTemplateColumns: '1fr 1fr',
                          gap: '1rem',
                          marginBottom: '1.5rem'
                        }}>
                          <div>
                            <label style={{display: 'block', color: '#fff', marginBottom: '0.5rem', fontWeight: '600'}}>
                              Temperature
                            </label>
                            <input 
                              type="number"
                              min="0"
                              max="2"
                              step="0.1"
                              defaultValue="0.7"
                              style={{
                                width: '100%',
                                padding: '0.75rem',
                                background: 'rgba(26, 26, 46, 0.8)',
                                border: '2px solid rgba(59, 130, 246, 0.3)',
                                borderRadius: '8px',
                                color: '#fff',
                                fontSize: '1rem'
                              }}
                            />
                          </div>
                          <div>
                            <label style={{display: 'block', color: '#fff', marginBottom: '0.5rem', fontWeight: '600'}}>
                              Max Tokens
                            </label>
                            <input 
                              type="number"
                              min="100"
                              max="32000"
                              step="100"
                              defaultValue="8000"
                              style={{
                                width: '100%',
                                padding: '0.75rem',
                                background: 'rgba(26, 26, 46, 0.8)',
                                border: '2px solid rgba(59, 130, 246, 0.3)',
                                borderRadius: '8px',
                                color: '#fff',
                                fontSize: '1rem'
                              }}
                            />
                          </div>
                        </div>

                        {/* Botones */}
                        <div style={{display: 'flex', gap: '1rem', marginTop: '2rem'}}>
                          <button
                            style={{
                              flex: 1,
                              padding: '0.875rem 1.5rem',
                              background: 'linear-gradient(135deg, #3b82f6, #2563eb)',
                              border: 'none',
                              borderRadius: '8px',
                              color: 'white',
                              fontSize: '1rem',
                              fontWeight: '600',
                              cursor: 'pointer',
                              opacity: 0.6,
                              transition: 'all 0.3s ease'
                            }}
                            disabled
                            title="Funcionalidad pr√≥ximamente"
                          >
                            üîå Probar Conexi√≥n
                          </button>
                          <button
                            style={{
                              flex: 1,
                              padding: '0.875rem 1.5rem',
                              background: 'linear-gradient(135deg, #10b981, #059669)',
                              border: 'none',
                              borderRadius: '8px',
                              color: 'white',
                              fontSize: '1rem',
                              fontWeight: '600',
                              cursor: 'pointer',
                              opacity: 0.6,
                              transition: 'all 0.3s ease'
                            }}
                            disabled
                            title="Funcionalidad pr√≥ximamente"
                          >
                            üíæ Guardar Configuraci√≥n
                          </button>
                        </div>

                        <div style={{
                          marginTop: '1.5rem',
                          padding: '1rem',
                          background: 'rgba(251, 146, 60, 0.1)',
                          border: '2px solid rgba(251, 146, 60, 0.3)',
                          borderRadius: '8px'
                        }}>
                          <p style={{color: '#fb923c', fontSize: '0.9rem', margin: 0}}>
                            ‚ö†Ô∏è <strong>Vista previa:</strong> Esta funcionalidad est√° en desarrollo. Los botones est√°n deshabilitados temporalmente.
                          </p>
                        </div>
                      </div>

                      {/* Informaci√≥n adicional */}
                      <div style={{
                        background: 'rgba(59, 130, 246, 0.05)',
                        border: '1px solid rgba(59, 130, 246, 0.2)',
                        borderRadius: '8px',
                        padding: '1.25rem',
                        marginTop: '1.5rem'
                      }}>
                        <h4 style={{color: '#3b82f6', marginBottom: '0.75rem'}}>üí° Informaci√≥n</h4>
                        <ul style={{color: '#b0b0c0', fontSize: '0.9rem', lineHeight: '1.8', marginLeft: '1.5rem'}}>
                          <li>Las APIs externas requieren conexi√≥n a internet y pueden tener costos asociados</li>
                          <li>ChatGPT (OpenAI) ofrece modelos como GPT-4o, GPT-4 Turbo, etc.</li>
                          <li>DeepSeek API proporciona modelos avanzados de razonamiento</li>
                          <li>Claude (Anthropic) incluye modelos como Claude 3.5 Sonnet</li>
                          <li>Puedes usar APIs personalizadas compatibles con OpenAI</li>
                        </ul>
                      </div>
                    </div>
                  )}
                    </>
                  )}
                </div>

                {/* Ajustes Avanzados */}
                <div className="config-section">
                  <div 
                    style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer'}}
                    onClick={() => setMostrarAjustesAvanzados(!mostrarAjustesAvanzados)}
                  >
                    <h2>üîß Ajustes Avanzados</h2>
                    <span style={{fontSize: '1.5rem'}}>{mostrarAjustesAvanzados ? '‚ñº' : '‚ñ∂'}</span>
                  </div>
                  
                  {mostrarAjustesAvanzados && (
                    <div style={{marginTop: '1rem'}}>
                      <p style={{color: '#b0b0c0', marginBottom: '1.5rem'}}>
                        Estos ajustes controlan c√≥mo trabaja el modelo de IA. Solo modif√≠calos si sabes lo que haces.
                      </p>

                      {/* Tama√±o del Contexto */}
                      <div className="ajuste-item">
                        <div className="ajuste-header">
                          <label>üìè Tama√±o del Contexto (n_ctx)</label>
                          <span className="ajuste-valor">{ajustesAvanzados.n_ctx} tokens</span>
                        </div>
                        <input 
                          type="range" 
                          min="1024" 
                          max="32768" 
                          step="1024"
                          value={ajustesAvanzados.n_ctx}
                          onChange={(e) => setAjustesAvanzados({...ajustesAvanzados, n_ctx: parseInt(e.target.value)})}
                          onMouseUp={guardarAjustesAvanzados}
                          onTouchEnd={guardarAjustesAvanzados}
                          className="ajuste-slider"
                        />
                        <div className="ajuste-explicacion">
                          <p><strong>¬øQu√© es?</strong> Cantidad de texto que el modelo puede "recordar" a la vez.</p>
                          <div className="pros-cons">
                            <div className="pros">
                              <strong>‚úÖ M√°s tokens (8192+):</strong>
                              <ul>
                                <li>Puede analizar documentos m√°s largos</li>
                                <li>Conversaciones m√°s extensas con memoria</li>
                                <li>Mejor para PDFs grandes</li>
                              </ul>
                            </div>
                            <div className="cons">
                              <strong>‚ùå M√°s tokens consume:</strong>
                              <ul>
                                <li>Mucha m√°s RAM (puede usar 8-16 GB extra)</li>
                                <li>Respuestas m√°s lentas</li>
                                <li>Puede congelar si no tienes suficiente RAM</li>
                              </ul>
                            </div>
                          </div>
                          <p className="recomendacion">
                            <strong>üí° Recomendado:</strong> 4096 tokens (3-4 p√°ginas de texto) para uso normal. 
                            Solo aumenta si necesitas analizar documentos muy largos Y tienes 16GB+ de RAM.
                          </p>
                        </div>
                      </div>

                      {/* Temperatura */}
                      <div className="ajuste-item">
                        <div className="ajuste-header">
                          <label>üå°Ô∏è Temperatura (Creatividad)</label>
                          <span className="ajuste-valor">{ajustesAvanzados.temperature}</span>
                        </div>
                        <input 
                          type="range" 
                          min="0.1" 
                          max="2.0" 
                          step="0.1"
                          value={ajustesAvanzados.temperature}
                          onChange={(e) => setAjustesAvanzados({...ajustesAvanzados, temperature: parseFloat(e.target.value)})}
                          onMouseUp={guardarAjustesAvanzados}
                          onTouchEnd={guardarAjustesAvanzados}
                          className="ajuste-slider"
                        />
                        <div className="ajuste-explicacion">
                          <p><strong>¬øQu√© es?</strong> Controla qu√© tan "creativo" o "predecible" es el modelo.</p>
                          <div className="pros-cons">
                            <div className="pros">
                              <strong>üî• Temperatura alta (1.0-2.0):</strong>
                              <ul>
                                <li>Respuestas m√°s variadas y creativas</li>
                                <li>Bueno para generar ideas diferentes</li>
                                <li>Menos repetitivo</li>
                              </ul>
                            </div>
                            <div className="cons">
                              <strong>‚ùÑÔ∏è Temperatura baja (0.1-0.5):</strong>
                              <ul>
                                <li>Respuestas m√°s precisas y consistentes</li>
                                <li>Mejor para tareas t√©cnicas</li>
                                <li>Menos errores o "alucinaciones"</li>
                              </ul>
                            </div>
                          </div>
                          <p className="recomendacion">
                            <strong>üí° Recomendado:</strong> 0.7 para uso general. Baja a 0.3-0.5 para ex√°menes t√©cnicos. 
                            Sube a 1.0+ si quieres preguntas m√°s creativas o variadas.
                          </p>
                        </div>
                      </div>

                      {/* M√°ximo de tokens de respuesta */}
                      <div className="ajuste-item">
                        <div className="ajuste-header">
                          <label>üìù Longitud M√°xima de Respuesta</label>
                          <span className="ajuste-valor">{ajustesAvanzados.max_tokens} tokens (~{Math.round(ajustesAvanzados.max_tokens * 0.75)} palabras)</span>
                        </div>
                        <input 
                          type="range" 
                          min="128" 
                          max="2048" 
                          step="128"
                          value={ajustesAvanzados.max_tokens}
                          onChange={(e) => setAjustesAvanzados({...ajustesAvanzados, max_tokens: parseInt(e.target.value)})}
                          onMouseUp={guardarAjustesAvanzados}
                          onTouchEnd={guardarAjustesAvanzados}
                          className="ajuste-slider"
                        />
                        <div className="ajuste-explicacion">
                          <p><strong>¬øQu√© es?</strong> Cu√°nto texto puede generar el modelo en una sola respuesta.</p>
                          <div className="pros-cons">
                            <div className="pros">
                              <strong>‚úÖ M√°s tokens (1024+):</strong>
                              <ul>
                                <li>Respuestas m√°s completas y detalladas</li>
                                <li>Puede generar textos largos de una vez</li>
                                <li>Mejor para explicaciones extensas</li>
                              </ul>
                            </div>
                            <div className="cons">
                              <strong>‚ùå M√°s tokens significa:</strong>
                              <ul>
                                <li>Esperas m√°s tiempo por cada respuesta</li>
                                <li>Mayor consumo de recursos</li>
                                <li>A veces genera relleno innecesario</li>
                              </ul>
                            </div>
                          </div>
                          <p className="recomendacion">
                            <strong>üí° Recomendado:</strong> 512 tokens para chat normal (respuestas de 1-2 p√°rrafos). 
                            Sube a 1024+ si necesitas generar ex√°menes completos o textos largos.
                          </p>
                        </div>
                      </div>

                      {/* Top P */}
                      <div className="ajuste-item">
                        <div className="ajuste-header">
                          <label>üéØ Top P (Selecci√≥n de palabras)</label>
                          <span className="ajuste-valor">{ajustesAvanzados.top_p}</span>
                        </div>
                        <input 
                          type="range" 
                          min="0.1" 
                          max="1.0" 
                          step="0.05"
                          value={ajustesAvanzados.top_p}
                          onChange={(e) => setAjustesAvanzados({...ajustesAvanzados, top_p: parseFloat(e.target.value)})}
                          onMouseUp={guardarAjustesAvanzados}
                          onTouchEnd={guardarAjustesAvanzados}
                          className="ajuste-slider"
                        />
                        <div className="ajuste-explicacion">
                          <p><strong>¬øQu√© es?</strong> Controla qu√© tan diversas pueden ser las palabras que elige el modelo.</p>
                          <div className="pros-cons">
                            <div className="pros">
                              <strong>‚úÖ Top P bajo (0.5-0.7):</strong>
                              <ul>
                                <li>M√°s preciso y enfocado</li>
                                <li>Menos errores o "alucinaciones"</li>
                                <li>Mejor para tareas t√©cnicas</li>
                              </ul>
                            </div>
                            <div className="cons">
                              <strong>‚ö†Ô∏è Top P alto (0.9-1.0):</strong>
                              <ul>
                                <li>M√°s variedad en las respuestas</li>
                                <li>Puede ser menos predecible</li>
                                                                                              <li>A veces genera ideas interesantes</li>
                              </ul>
                            </div>
                          </div>
                          <p className="recomendacion">
                            <strong>üí° Recomendado:</strong> 0.9 para la mayor√≠a de casos. Si quieres respuestas m√°s directas y precisas, baja a 0.7.
                          </p>
                        </div>
                      </div>

                      {/* Repeat Penalty */}
                      <div className="ajuste-item">
                        <div className="ajuste-header">
                          <label>üîÅ Penalizaci√≥n por Repetici√≥n</label>
                          <span className="ajuste-valor">{ajustesAvanzados.repeat_penalty}</span>
                        </div>
                        <input 
                          type="range" 
                          min="1.0" 
                          max="1.5" 
                          step="0.05"
                          value={ajustesAvanzados.repeat_penalty}
                          onChange={(e) => setAjustesAvanzados({...ajustesAvanzados, repeat_penalty: parseFloat(e.target.value)})}
                          onMouseUp={guardarAjustesAvanzados}
                          onTouchEnd={guardarAjustesAvanzados}
                          className="ajuste-slider"
                        />
                        <div className="ajuste-explicacion">
                          <p><strong>¬øQu√© es?</strong> Evita que el modelo repita las mismas palabras o frases constantemente.</p>
                          <div className="pros-cons">
                            <div className="pros">
                              <strong>‚úÖ Penalty bajo (1.0-1.1):</strong>
                              <ul>
                                <li>M√°s natural y fluido</li>
                                <li>Puede usar palabras clave repetidas</li>
                                <li>Mejor para textos t√©cnicos</li>
                              </ul>
                            </div>
                            <div className="cons">
                              <strong>‚ö†Ô∏è Penalty alto (1.3-1.5):</strong>
                              <ul>
                                <li>Evita mucho la repetici√≥n</li>
                                <li>M√°s variedad de vocabulario</li>
                                <li>A veces usa sin√≥nimos raros</li>
                              </ul>
                            </div>
                          </div>
                          <p className="recomendacion">
                            <strong>üí° Recomendado:</strong> 1.15 para la mayor√≠a de casos. Si el modelo repite mucho, sube a 1.3.
                          </p>
                        </div>
                      </div>

                      {/* GPU Layers */}
                      <div className="ajuste-item">
                        <div className="ajuste-header">
                          <label>üéÆ Capas en GPU (Aceleraci√≥n)</label>
                          <span className="ajuste-valor">{ajustesAvanzados.n_gpu_layers === -1 ? 'Todas' : ajustesAvanzados.n_gpu_layers}</span>
                        </div>
                        <input 
                          type="range" 
                          min="0" 
                          max="50" 
                          step="5"
                          value={ajustesAvanzados.n_gpu_layers === -1 ? 50 : ajustesAvanzados.n_gpu_layers}
                          onChange={(e) => {
                            const val = parseInt(e.target.value);
                            setAjustesAvanzados({...ajustesAvanzados, n_gpu_layers: val === 50 ? -1 : val});
                          }}
                          onMouseUp={guardarAjustesAvanzados}
                          onTouchEnd={guardarAjustesAvanzados}
                          className="ajuste-slider"
                        />
                        <div className="ajuste-escala">
                          <span>0 (Solo CPU)</span>
                          <span>25</span>
                          <span>50 (Todas)</span>
                        </div>
                        <div className="ajuste-explicacion">
                          <p><strong>¬øQu√© es?</strong> Cu√°ntas partes del modelo se cargan en tu tarjeta gr√°fica (GPU) para hacerlo m√°s r√°pido.</p>
                          <div className="pros-cons">
                            <div className="pros">
                              <strong>‚úÖ M√°s capas en GPU (30-50):</strong>
                              <ul>
                                <li>‚ö° Mucho m√°s r√°pido</li>
                                <li>‚ú® Respuestas instant√°neas</li>
                                <li>üöÄ Mejor para generar ex√°menes</li>
                              </ul>
                            </div>
                            <div className="cons">
                              <strong>‚ö†Ô∏è Pocas capas (0-15):</strong>
                              <ul>
                                <li>üêå M√°s lento</li>
                                <li>üíª Usa CPU en lugar de GPU</li>
                                <li>‚è∞ Puede tardar minutos</li>
                              </ul>
                            </div>
                          </div>
                          <p className="recomendacion">
                            <strong>üí° Gu√≠a seg√∫n tu GPU:</strong>
                          </p>
                          <ul style={{fontSize: '0.9rem', marginTop: '0.5rem', color: '#999'}}>
                            <li><strong>4GB VRAM:</strong> Usa 20-25 capas</li>
                            <li><strong>6GB VRAM:</strong> Usa 30-35 capas</li>
                            <li><strong>8GB+ VRAM:</strong> Usa 40-45 capas</li>
                            <li><strong>12GB+ VRAM:</strong> Usa 50 (todas las capas)</li>
                            <li><strong>Sin GPU o GPU d√©bil:</strong> Usa 0 (solo CPU)</li>
                          </ul>
                          <p style={{fontSize: '0.85rem', color: '#ff9800', marginTop: '0.8rem'}}>
                            ‚ö†Ô∏è <strong>Si tu PC se congela o da error de memoria:</strong> Baja el n√∫mero de capas. Empieza con 0 y sube gradualmente.
                          </p>
                        </div>
                      </div>

                      {/* Aviso de aplicaci√≥n */}
                      <div style={{marginTop: '1.5rem', padding: '1rem', background: 'rgba(255, 152, 0, 0.1)', borderRadius: '8px', borderLeft: '3px solid #ff9800'}}>
                        <p style={{color: '#ffb84d', margin: 0, fontSize: '0.9rem'}}>
                          ‚ö†Ô∏è <strong>Nota:</strong> Estos ajustes se aplicar√°n la pr√≥xima vez que uses el chatbot o generes un examen. 
                          Si cambias el contexto a un valor muy alto y tu PC se congela, reinicia y b√°jalo de nuevo.
                        </p>
                      </div>
                    </div>
                  )}
                </div>

                {/* Bot√≥n guardar */}
                {modelosDisponibles.length > 0 && (
                  <div className="config-actions">
                    <button 
                      onClick={guardarConfiguracion}
                      className="btn-guardar-config"
                      disabled={cargandoConfig || !modeloSeleccionado}
                    >
                      {cargandoConfig ? '‚è≥ Guardando...' : 'üíæ Guardar Configuraci√≥n'}
                    </button>
                  </div>
                )}
              </>
            )}
          </div>
        )}

        {/* Modal para mover carpeta */}
        {modalMoverAbierto && moverCarpeta && (
          <div className="modal-overlay" onClick={cancelarMoverCarpeta}>
            <div className="modal-content modal-mover" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üì¶ Mover carpeta: {moverCarpeta.nombre}</h2>
                <button onClick={cancelarMoverCarpeta} className="btn-cerrar-modal">‚úï</button>
              </div>
              
              <div className="modal-body">
                <p className="modal-instrucciones">
                  Selecciona la carpeta de destino donde quieres mover "{moverCarpeta.nombre}"
                </p>

                {/* Breadcrumb de navegaci√≥n en el modal */}
                <div className="breadcrumb modal-breadcrumb">
                  <button 
                    onClick={() => cargarCarpetasDestino('')} 
                    className="breadcrumb-item"
                  >
                    üè† Ra√≠z
                  </button>
                  {rutaDestinoSeleccionada && rutaDestinoSeleccionada.split('\\').filter(p => p).map((parte, idx, arr) => {
                    const rutaParcial = arr.slice(0, idx + 1).join('\\')
                    return (
                      <span key={idx}>
                        <span className="breadcrumb-separator">/</span>
                        <button 
                          onClick={() => cargarCarpetasDestino(rutaParcial)}
                          className="breadcrumb-item"
                        >
                          {parte}
                        </button>
                      </span>
                    )
                  })}
                </div>

                {/* Lista de carpetas disponibles */}
                <div className="carpetas-destino-lista">
                  {carpetasDestino.length > 0 ? (
                    carpetasDestino
                      .filter(c => c.ruta !== moverCarpeta.ruta) // No mostrar la carpeta que se est√° moviendo
                      .map(carpeta => (
                        <div 
                          key={carpeta.ruta}
                          className="carpeta-destino-item"
                          onClick={() => cargarCarpetasDestino(carpeta.ruta)}
                        >
                          <div className="carpeta-destino-icon">üìÅ</div>
                          <div className="carpeta-destino-info">
                            <h4>{carpeta.nombre}</h4>
                            <p>{carpeta.num_subcarpetas} carpetas ¬∑ {carpeta.num_documentos} docs</p>
                          </div>
                          <div className="carpeta-destino-arrow">‚Üí</div>
                        </div>
                      ))
                ) : (
                  <div className="empty-state-modal">
                    <p>üì≠ No hay subcarpetas en esta ubicaci√≥n</p>
                  </div>
                )}
                </div>

                {/* Bot√≥n para ir a carpeta padre */}
                {rutaDestinoSeleccionada && (
                  <button 
                    className="btn-carpeta-padre"
                    onClick={() => {
                      const partes = rutaDestinoSeleccionada.split('\\').filter(p => p);
                      const rutaPadre = partes.slice(0, -1).join('\\');
                      cargarCarpetasDestino(rutaPadre);
                    }}
                  >
                    ‚¨ÜÔ∏è Subir a carpeta padre
                  </button>
                )}
              </div>

              <div className="modal-footer">
                <div className="destino-actual">
                  <strong>Destino:</strong> {rutaDestinoSeleccionada || 'Ra√≠z'}
                </div>
                <div className="modal-actions">
                  <button onClick={cancelarMoverCarpeta} className="btn-modal-cancelar">
                    Cancelar
                  </button>
                  <button onClick={confirmarMoverCarpeta} className="btn-modal-confirmar">
                    ‚úì Mover aqu√≠
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de historial de chats */}
        {mostrarModalHistorial && (
          <div className="modal-overlay" onClick={() => setMostrarModalHistorial(false)}>
            <div className="modal-content modal-historial" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üìö Historial de Chats</h2>
                <div style={{display: 'flex', gap: '0.5rem'}}>
                  <button 
                    className="btn-crear-carpeta-modal"
                    onClick={crearCarpetaHistorialModal}
                    title="Crear carpeta"
                  >
                    ‚ûï Nueva Carpeta
                  </button>
                  <button onClick={() => setMostrarModalHistorial(false)} className="btn-close">‚úï</button>
                </div>
              </div>
              <div className="modal-body">
                {/* Breadcrumbs */}
                {rutaHistorialModal && (
                  <div className="breadcrumbs-modal">
                    <button 
                      className="breadcrumb-item-modal"
                      onClick={() => cargarContenidoHistorialModal('')}
                    >
                      üè† Inicio
                    </button>
                    {rutaHistorialModal.split(/[\\\/]/).filter(p => p).map((parte, index, arr) => {
                      const rutaParcial = arr.slice(0, index + 1).join('\\')
                      return (
                        <span key={index}>
                          <span className="breadcrumb-separator"> / </span>
                          <button 
                            className="breadcrumb-item-modal"
                            onClick={() => cargarContenidoHistorialModal(rutaParcial)}
                          >
                            üìÅ {parte}
                          </button>
                        </span>
                      )
                    })}
                  </div>
                )}

                {/* Bot√≥n atr√°s */}
                {rutaHistorialModal && (
                  <button 
                    className="btn-atras-modal"
                    onClick={navegarAtrasHistorialModal}
                  >
                    ‚¨ÖÔ∏è Atr√°s
                  </button>
                )}

                {loadingHistorialModal ? (
                  <div className="loading-modal">Cargando...</div>
                ) : (
                  <>
                    {/* Carpetas */}
                    {carpetasHistorialModal.length > 0 && (
                      <div className="seccion-carpetas-modal">
                        <h3 className="titulo-seccion-modal">üìÇ Carpetas</h3>
                        <div className="carpetas-grid">
                          {carpetasHistorialModal.map(carpeta => (
                            <div key={carpeta.ruta} className="carpeta-card-wrapper">
                              <div 
                                className="carpeta-card"
                                onClick={() => navegarCarpetaHistorialModal(carpeta.ruta)}
                              >
                                <div className="carpeta-card-icon">üìÅ</div>
                                <div className="carpeta-card-nombre">{carpeta.nombre}</div>
                                <div className="carpeta-stats">
                                  <div className="carpeta-stat-item">
                                    <span className="stat-icon">üí¨</span>
                                    <span className="stat-value">{carpeta.num_chats} chat{carpeta.num_chats !== 1 ? 's' : ''}</span>
                                </div>
                              </div>
                              </div>
                              <div className="carpeta-acciones-modal">
                                <button 
                                  className="btn-mover-carpeta-modal"
                                  onClick={(e) => {
                                    e.stopPropagation()
                                    abrirModalMoverCarpeta(carpeta.ruta, carpeta.nombre)
                                  }}
                                  title="Mover carpeta"
                                >
                                  üì¶
                                </button>
                                <button 
                                  className="btn-renombrar-carpeta-modal"
                                  onClick={(e) => {
                                    e.stopPropagation()
                                    renombrarCarpetaModal(carpeta.ruta, carpeta.nombre)
                                  }}
                                  title="Renombrar carpeta"
                                >
                                  ‚úèÔ∏è
                                </button>
                                <button 
                                  className="btn-eliminar-carpeta-modal"
                                  onClick={(e) => {
                                    e.stopPropagation()
                                    eliminarCarpetaModal(carpeta.ruta, carpeta.nombre)
                                  }}
                                  title="Eliminar carpeta"
                                >
                                  üóëÔ∏è
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Chats */}
                    {chatsHistorialModal.length > 0 && (
                      <div className="seccion-chats-modal">
                        <h3 className="titulo-seccion-modal">üí¨ Chats</h3>
                        <div className="historial-lista">
                          {chatsHistorialModal.map(chat => (
                            <div key={chat.id} className="historial-item">
                              <div className="historial-info" onClick={() => cargarChatDesdeModal(chat.id)}>
                                <div className="historial-icon">üí¨</div>
                                <div className="historial-detalles">
                                  <h4>{chat.nombre}</h4>
                                  <p>{chat.num_mensajes} mensajes ¬∑ {new Date(chat.fecha).toLocaleDateString()}</p>
                                </div>
                              </div>
                              <div className="historial-acciones">
                                <button 
                                  className="btn-mover-historial"
                                  onClick={() => abrirModalMoverChat(chat.id, chat.nombre)}
                                  title="Mover chat"
                                >
                                  üì¶
                                </button>
                                <button 
                                  className="btn-renombrar-historial"
                                  onClick={() => renombrarChatModal(chat.id, chat.nombre)}
                                  title="Renombrar chat"
                                >
                                  ‚úèÔ∏è
                                </button>
                                <button 
                                  className="btn-eliminar-historial"
                                  onClick={() => eliminarChatModal(chat.id, chat.nombre)}
                                  title="Eliminar chat"
                                >
                                  üóëÔ∏è
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    {/* Estado vac√≠o */}
                    {carpetasHistorialModal.length === 0 && chatsHistorialModal.length === 0 && (
                      <div className="empty-state-modal">
                        <div className="empty-icon">üì≠</div>
                        <p>No hay carpetas ni chats en esta ubicaci√≥n</p>
                        <p className="empty-hint">Crea una carpeta para organizar tus conversaciones</p>
                      </div>
                    )}
                  </>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal para mover chats/carpetas */}
        {mostrarModalMover && itemAMover && (
          <div className="modal-overlay" onClick={() => setMostrarModalMover(false)}>
            <div className="modal-content modal-mover" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üì¶ Mover {itemAMover.tipo === 'chat' ? 'Chat' : 'Carpeta'}</h2>
                <button onClick={() => setMostrarModalMover(false)} className="btn-close">‚úï</button>
              </div>
              <div className="modal-body">
                <div style={{marginBottom: '1rem', padding: '1rem', background: 'rgba(100, 108, 255, 0.1)', borderRadius: '8px'}}>
                  <p><strong>{itemAMover.tipo === 'chat' ? 'üí¨' : 'üìÅ'} {itemAMover.nombre}</strong></p>
                  <p style={{fontSize: '0.9rem', color: '#999', marginTop: '0.5rem'}}>
                    {itemAMover.rutaActual ? `De: ${itemAMover.rutaActual}` : 'De: Ra√≠z'}
                  </p>
                </div>

                {/* Navegaci√≥n de carpetas */}
                <div className="breadcrumbs-modal" style={{marginBottom: '1rem'}}>
                  <button 
                    className="breadcrumb-item-modal"
                    onClick={() => cargarCarpetasDestinoMover('')}
                  >
                    üè† Inicio
                  </button>
                  {rutaDestinoMover && rutaDestinoMover.split(/[\\\/]/).filter(p => p).map((parte, index, arr) => {
                    const rutaParcial = arr.slice(0, index + 1).join('\\')
                    return (
                      <span key={index}>
                        <span className="breadcrumb-separator"> / </span>
                        <button 
                          className="breadcrumb-item-modal"
                          onClick={() => cargarCarpetasDestinoMover(rutaParcial)}
                        >
                          üìÅ {parte}
                        </button>
                      </span>
                    )
                  })}
                </div>

                {rutaDestinoMover && (
                  <button 
                    className="btn-atras-modal"
                    onClick={() => {
                      const partes = rutaDestinoMover.split(/[\\\/]/).filter(p => p)
                      const rutaPadre = partes.slice(0, -1).join('\\')
                      cargarCarpetasDestinoMover(rutaPadre)
                    }}
                  >
                    ‚¨ÖÔ∏è Atr√°s
                  </button>
                )}

                {/* Bot√≥n para mover aqu√≠ */}
                <div style={{marginBottom: '1.5rem'}}>
                  <button
                    className="btn-mover-aqui"
                    style={{
                      width: '100%',
                      padding: '1rem',
                      background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                      border: 'none',
                      borderRadius: '12px',
                      color: 'white',
                      fontWeight: 'bold',
                      cursor: 'pointer',
                      fontSize: '1rem',
                      transition: 'all 0.3s'
                    }}
                    onClick={ejecutarMovimiento}
                    disabled={rutaDestinoMover === itemAMover.rutaActual}
                  >
                    üì¶ Mover a {rutaDestinoMover || 'Ra√≠z'}
                  </button>
                  {rutaDestinoMover === itemAMover.rutaActual && (
                    <p style={{color: '#f59e0b', fontSize: '0.9rem', marginTop: '0.5rem', textAlign: 'center'}}>
                      ‚ö†Ô∏è Ya est√° en esta ubicaci√≥n
                    </p>
                  )}
                </div>

                {/* Lista de carpetas disponibles */}
                {carpetasDestinoMover.length > 0 ? (
                  <div>
                    <h4 style={{color: '#b0b0c0', marginBottom: '1rem'}}>O navegar a subcarpetas:</h4>
                    <div className="carpetas-grid">
                      {carpetasDestinoMover
                        .filter(carpeta => carpeta.ruta !== itemAMover.id) // No mostrar la carpeta que se est√° moviendo
                        .map(carpeta => (
                          <div 
                            key={carpeta.ruta}
                            className="carpeta-card"
                            onClick={() => cargarCarpetasDestinoMover(carpeta.ruta)}
                            style={{cursor: 'pointer'}}
                          >
                            <div className="carpeta-card-icon">üìÅ</div>
                            <div className="carpeta-card-nombre">{carpeta.nombre}</div>
                            <div className="carpeta-stats">
                              <span className="stat-value">{carpeta.num_chats} chat{carpeta.num_chats !== 1 ? 's' : ''}</span>
                            </div>
                          </div>
                        ))}
                    </div>
                  </div>
                ) : (
                  <div className="empty-state-modal">
                    <p style={{color: '#666'}}>No hay subcarpetas en esta ubicaci√≥n</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal para mover a carpeta */}
        {mostrarModalCarpetas && (
          <div className="modal-overlay" onClick={() => setMostrarModalCarpetas(false)}>
            <div className="modal-content modal-carpetas-visual" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üìÅ Mover Chat a Proyecto</h2>
                <button onClick={() => setMostrarModalCarpetas(false)} className="btn-close">‚úï</button>
              </div>
              <div className="modal-body">
                <p style={{color: '#b0b0c0', marginBottom: '1rem', fontSize: '0.95rem'}}>
                  Organiza tus conversaciones por proyectos o temas
                </p>

                {/* Breadcrumb navigation */}
                <div className="breadcrumb-nav" style={{marginBottom: '1rem'}}>
                  <button onClick={async () => {
                    setRutaCarpetasChat('');
                    const resp = await fetch(`${API_URL}/api/chats/carpetas?ruta=`);
                    const data = await resp.json();
                    setCarpetasChats(data.carpetas || []);
                  }} className="breadcrumb-btn">
                    üè† Inicio
                  </button>
                  {rutaCarpetasChat && rutaCarpetasChat.split('\\').filter(Boolean).map((parte, idx, arr) => {
                    const rutaParcial = arr.slice(0, idx + 1).join('\\');
                    return (
                      <span key={idx}>
                        <span className="breadcrumb-separator">/</span>
                        <button onClick={async () => {
                          setRutaCarpetasChat(rutaParcial);
                          const resp = await fetch(`${API_URL}/api/chats/carpetas?ruta=${encodeURIComponent(rutaParcial)}`);
                          const data = await resp.json();
                          setCarpetasChats(data.carpetas || []);
                        }} className="breadcrumb-btn">
                          {parte}
                        </button>
                      </span>
                    );
                  })}
                </div>

                {/* Grid de carpetas */}
                <div className="carpetas-grid">
                  {/* Bot√≥n para mover a carpeta actual */}
                  <div 
                    className="carpeta-card sin-carpeta"
                    onClick={() => moverChatACarpeta(rutaCarpetasChat)}
                    style={{background: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)', gridColumn: '1 / -1'}}
                  >
                    <div className="carpeta-card-icon">‚úÖ</div>
                    <div className="carpeta-card-content">
                      <h4>Mover Aqu√≠</h4>
                      <p>{rutaCarpetasChat || 'Ra√≠z del proyecto'}</p>
                    </div>
                  </div>

                  {/* Tarjetas de carpetas existentes - hacer click para navegar */}
                  {carpetasChats.map((carpeta, index) => (
                    <div 
                      key={index}
                      className="carpeta-card"
                      onClick={async () => {
                        const nombreCarpeta = typeof carpeta === 'string' ? carpeta : carpeta.nombre;
                        const nuevaRuta = rutaCarpetasChat ? `${rutaCarpetasChat}\\${nombreCarpeta}` : nombreCarpeta;
                        setRutaCarpetasChat(nuevaRuta);
                        const resp = await fetch(`${API_URL}/api/chats/carpetas?ruta=${encodeURIComponent(nuevaRuta)}`);
                        const data = await resp.json();
                        setCarpetasChats(data.carpetas || []);
                      }}
                    >
                      <div className="carpeta-card-icon">üìÅ</div>
                      <div className="carpeta-card-content">
                        <h4>{typeof carpeta === 'string' ? carpeta : carpeta.nombre}</h4>
                        {carpeta.num_chats !== undefined && (
                          <div className="carpeta-stats">
                            <span className="stat-item">
                              üí¨ {carpeta.num_chats} {carpeta.num_chats === 1 ? 'chat' : 'chats'}
                            </span>
                            {carpeta.fecha_reciente && (
                              <span className="stat-item stat-fecha">
                                üïê {new Date(carpeta.fecha_reciente).toLocaleDateString('es-ES', { 
                                  day: 'numeric', 
                                  month: 'short' 
                                })}
                              </span>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}

                  {/* Tarjeta para crear nueva carpeta */}
                  <div 
                    className="carpeta-card crear-nueva"
                    onClick={crearCarpetaChat}
                  >
                    <div className="carpeta-card-icon">‚ûï</div>
                    <div className="carpeta-card-content">
                      <h4>Nuevo Proyecto</h4>
                      <p>Crear carpeta</p>
                    </div>
                  </div>
                </div>

                {carpetasChats.length === 0 && (
                  <div className="carpetas-empty">
                    <p>üóÇÔ∏è No tienes proyectos a√∫n</p>
                    <p className="hint">Crea tu primer proyecto para organizar tus chats</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal de Configuraci√≥n de Examen */}
        {modalConfigExamen && (
          <div className="modal-overlay" onClick={() => setModalConfigExamen(false)}>
            {console.log('üé® Renderizando modal de configuraci√≥n')}
            <div className="modal-content modal-config-examen" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>‚öôÔ∏è Configurar Generaci√≥n de Examen</h2>
                <button onClick={() => setModalConfigExamen(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                {/* Prompt Personalizado */}
                <div className="config-section">
                  <label className="config-label">
                    üí¨ Instrucciones Adicionales (opcional)
                    <span className="hint-text">Agrega instrucciones espec√≠ficas que se a√±adir√°n al prompt del sistema</span>
                  </label>
                  <textarea
                    className="prompt-textarea"
                    placeholder="Ejemplo: Enf√≥cate en conceptos pr√°cticos, incluye ejemplos del mundo real..."
                    value={promptPersonalizado}
                    onChange={(e) => setPromptPersonalizado(e.target.value)}
                    rows={3}
                  />
                </div>

                {/* Prompt del Sistema */}
                <div className="config-section">
                  <label className="config-label">
                    üé® Prompt del Sistema (avanzado)
                    <span className="hint-text">
                      {promptSistema 
                        ? `${promptSistema.length} caracteres cargados - Puedes editarlo libremente`
                        : 'Esperando carga... Si no aparece, usa el bot√≥n "Cargar Predeterminado"'
                      }
                    </span>
                  </label>
                  <div className="prompt-sistema-container">
                    <textarea
                      className="prompt-textarea prompt-sistema"
                      placeholder="Cargando prompt del sistema...&#10;&#10;Si no carga autom√°ticamente, haz click en 'üîÑ Cargar Predeterminado'&#10;&#10;El prompt te permitir√° personalizar completamente c√≥mo la IA genera los ex√°menes."
                      value={promptSistema}
                      onChange={(e) => setPromptSistema(e.target.value)}
                      rows={12}
                    />
                    <div className="prompt-sistema-info">
                      <span className="prompt-info-text">
                        Variables: {'{contenido}'}, {'{num_multiple}'}, {'{num_corta}'}, {'{num_desarrollo}'}
                      </span>
                    </div>
                    <div className="prompt-sistema-acciones">
                      <button 
                        className="btn-cargar-template"
                        onClick={cargarPromptPredeterminado}
                      >
                        üîÑ Cargar Predeterminado
                      </button>
                      <button 
                        className="btn-guardar-prompt"
                        onClick={guardarPromptSistema}
                        disabled={!promptSistema}
                      >
                        üíæ Guardar Prompt
                      </button>
                    </div>
                  </div>
                </div>

                {/* Explorador de Carpetas */}
                <div className="config-section">
                  <label className="config-label">
                    üìÅ Explorar Carpetas
                    <span className="hint-text">Navega a subcarpetas para agregar m√°s archivos</span>
                  </label>
                  <div className="explorador-carpetas">
                    <div className="ruta-actual">
                      {rutaExploracion !== carpetaConfigExamen?.ruta && (
                        <button 
                          className="btn-volver"
                          onClick={volverCarpetaPadre}
                        >
                          ‚¨ÖÔ∏è Volver
                        </button>
                      )}
                      <span className="ruta-texto">üìÇ {rutaExploracion || 'Ra√≠z'}</span>
                    </div>
                    
                    {carpetasExploracion.length > 0 && (
                      <div className="subcarpetas-lista">
                        {carpetasExploracion.map(carpeta => (
                          <button
                            key={carpeta.ruta}
                            className="subcarpeta-item"
                            onClick={() => cargarArchivosSubcarpeta(carpeta.ruta)}
                          >
                            üìÅ {carpeta.nombre}
                          </button>
                        ))}
                      </div>
                    )}
                  </div>
                </div>

                {/* Lista de Archivos */}
                <div className="config-section">
                  <label className="config-label">
                    üìÑ Archivos Seleccionados ({archivosSeleccionados.length}/{archivosDisponibles.length})
                    <span className="hint-text">Marca/desmarca los archivos que quieres incluir</span>
                  </label>
                  <div className="archivos-lista">
                    {archivosDisponibles.map((archivo, idx) => (
                      <label key={idx} className="archivo-item">
                        <input
                          type="checkbox"
                          checked={archivosSeleccionados.includes(archivo.ruta)}
                          onChange={() => toggleSeleccionArchivo(archivo.ruta)}
                        />
                        <div className="archivo-info">
                          <span className="archivo-nombre">üìÑ {archivo.nombre}</span>
                          <span className="archivo-detalles">{archivo.tama√±o_kb} KB</span>
                        </div>
                      </label>
                    ))}
                  </div>
                </div>

                {/* Configuraci√≥n de Preguntas */}
                <div className="config-section">
                  <label className="config-label">
                    üìã Cantidad de Preguntas
                  </label>
                  <div className="config-preguntas">
                    <div className="config-item">
                      <label>Opci√≥n M√∫ltiple:</label>
                      <input
                        type="number"
                        min="0"
                        max="20"
                        value={configExamen.num_multiple}
                        onChange={(e) => setConfigExamen({...configExamen, num_multiple: parseInt(e.target.value) || 0})}
                      />
                    </div>
                    <div className="config-item">
                      <label>Respuesta Corta:</label>
                      <input
                        type="number"
                        min="0"
                        max="20"
                        value={configExamen.num_corta}
                        onChange={(e) => setConfigExamen({...configExamen, num_corta: parseInt(e.target.value) || 0})}
                      />
                    </div>
                    <div className="config-item">
                      <label>Desarrollo:</label>
                      <input
                        type="number"
                        min="0"
                        max="20"
                        value={configExamen.num_desarrollo}
                        onChange={(e) => setConfigExamen({...configExamen, num_desarrollo: parseInt(e.target.value) || 0})}
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div className="modal-footer">
                <button 
                  className="btn-cancelar"
                  onClick={() => setModalConfigExamen(false)}
                >
                  ‚ùå Cancelar
                </button>
                <button 
                  className="btn-generar"
                  onClick={confirmarGeneracionExamen}
                  disabled={archivosSeleccionados.length === 0}
                >
                  ‚ú® Generar Examen
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Examen */}
        {modalExamenAbierto && (
          <div className="modal-overlay" onClick={cerrarExamen}>
            <div className="modal-examen" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <div style={{display: 'flex', alignItems: 'center', gap: '1rem'}}>
                  <button onClick={() => setModalExamenAbierto(false)} className="btn-volver" style={{padding: '0.5rem 1rem'}}>
                    ‚Üê Volver
                  </button>
                  <h2>üìù Examen - {carpetaExamen?.nombre}</h2>
                </div>
                <button onClick={cerrarExamen} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body examen-body">
                {!resultadoExamen ? (
                  <>
                    {/* Formulario de Examen */}
                    <div className="examen-info">
                      <p>Total de preguntas: <strong>{preguntasExamen.length}</strong></p>
                      <p>Puntos totales: <strong>{preguntasExamen.reduce((sum, p) => sum + p.puntos, 0)}</strong></p>
                    </div>

                    <div className="preguntas-lista">
                      {preguntasExamen.map((pregunta, index) => {
                        // Log para depuraci√≥n
                        if (index === 0) {
                          console.log('üîç Renderizando pregunta 1:', {
                            tipo: pregunta.tipo,
                            pregunta: pregunta.pregunta?.substring(0, 50),
                            metadata: pregunta.metadata
                          });
                        }
                        
                        return (
                        <div key={index} className="pregunta-card">
                          <div className="pregunta-header">
                            <span className="pregunta-numero">Pregunta {index + 1}</span>
                            <span className="pregunta-tipo">{
                              pregunta.tipo === 'multiple' ? 'üìã Selecci√≥n' : 
                              pregunta.tipo === 'mcq' ? '‚úÖ Opci√≥n M√∫ltiple' :
                              pregunta.tipo === 'flashcard' ? 'üÉè Flashcard' :
                              pregunta.tipo === 'verdadero_falso' ? '‚úì‚úó Verdadero/Falso' :
                              pregunta.tipo === 'verdadero-falso' ? '‚úì‚úó Verdadero/Falso' :
                              pregunta.tipo === 'true_false' ? '‚úì‚úó Verdadero/Falso' :
                              pregunta.tipo === 'cloze' ? 'üìù Relleno de Huecos' :
                              pregunta.tipo === 'corta' ? '‚úçÔ∏è Respuesta Corta' : 
                              pregunta.tipo === 'short_answer' ? '‚úçÔ∏è Respuesta Corta' :
                              pregunta.tipo === 'desarrollo' ? 'üìñ Desarrollo' :
                              pregunta.tipo === 'open_question' ? 'üìñ Desarrollo' :
                              pregunta.tipo === 'case_study' ? 'üíº Caso de Estudio' :
                              // Reading types
                              pregunta.tipo === 'reading_comprehension' ? 'üìñ Reading Comprehension' :
                              pregunta.tipo === 'reading_true_false' ? '‚úì‚úó Reading True/False' :
                              pregunta.tipo === 'reading_cloze' ? 'üìù Reading Cloze' :
                              pregunta.tipo === 'reading_skill' ? 'üéØ Reading Skill' :
                              pregunta.tipo === 'reading_matching' ? 'üîó Reading Matching' :
                              pregunta.tipo === 'reading_sequence' ? 'üî¢ Reading Sequence' :
                              // Writing types
                              pregunta.tipo === 'writing_short' ? '‚úçÔ∏è Writing Short' :
                              pregunta.tipo === 'writing_paraphrase' ? 'üîÑ Writing Paraphrase' :
                              pregunta.tipo === 'writing_correction' ? 'üîß Writing Correction' :
                              pregunta.tipo === 'writing_transformation' ? 'üé≠ Writing Transformation' :
                              pregunta.tipo === 'writing_essay' ? 'üìÑ Writing Essay' :
                              pregunta.tipo === 'writing_sentence_builder' ? 'üß© Sentence Builder' :
                              pregunta.tipo === 'writing_picture_description' ? 'üñºÔ∏è Picture Description' :
                              pregunta.tipo === 'writing_email' ? 'üìß Writing Email' :
                              'üìñ Desarrollo'
                            }</span>
                            <span className="pregunta-puntos">{pregunta.puntos} pts</span>
                          </div>
                          
                          {/* Mostrar escenario para casos de estudio */}
                          {pregunta.tipo === 'case_study' && (
                            <div className="case-study-container">
                              {/* T√≠tulo del caso */}
                              {pregunta.metadata?.titulo && (
                                <div style={{
                                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                  padding: '1rem 1.5rem',
                                  borderRadius: '8px 8px 0 0',
                                  marginBottom: '0',
                                  color: 'white'
                                }}>
                                  <h3 style={{margin: 0, fontSize: '1.2rem'}}>üìö {pregunta.metadata.titulo}</h3>
                                  {pregunta.metadata.subtipo && (
                                    <span style={{
                                      fontSize: '0.75rem',
                                      background: 'rgba(255,255,255,0.2)',
                                      padding: '3px 8px',
                                      borderRadius: '12px',
                                      marginTop: '8px',
                                      display: 'inline-block'
                                    }}>
                                      {pregunta.metadata.subtipo.charAt(0).toUpperCase() + pregunta.metadata.subtipo.slice(1)}
                                    </span>
                                  )}
                                </div>
                              )}
                              
                              {/* Escenario del Caso - NUEVO */}
                              {pregunta.metadata?.scenario && (
                                <div style={{
                                  background: 'linear-gradient(135deg, #1e3a8a 0%, #1e293b 100%)',
                                  padding: '1.5rem',
                                  borderRadius: pregunta.metadata?.titulo ? '0' : '8px 8px 0 0',
                                  marginBottom: '0',
                                  color: '#e2e8f0',
                                  borderTop: pregunta.metadata?.titulo ? '1px solid rgba(255,255,255,0.1)' : 'none',
                                  borderLeft: '4px solid #3b82f6'
                                }}>
                                  <h4 style={{
                                    marginTop: 0, 
                                    marginBottom: '1rem', 
                                    fontSize: '1.1rem',
                                    color: '#93c5fd',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem'
                                  }}>
                                    <span>üìñ</span>
                                    <span>Escenario del Caso</span>
                                  </h4>
                                  <p style={{
                                    whiteSpace: 'pre-wrap', 
                                    lineHeight: '1.8', 
                                    margin: 0,
                                    fontSize: '1rem',
                                    textAlign: 'justify'
                                  }}>{pregunta.metadata.scenario}</p>
                                </div>
                              )}
                              
                              {/* Contexto */}
                              {pregunta.metadata?.contexto && (
                                <div style={{
                                  background: 'linear-gradient(135deg, #2c192eff 0%, #42062eff 100%)',
                                  padding: '1.5rem',
                                  borderRadius: pregunta.metadata?.titulo ? '0' : '8px 8px 0 0',
                                  marginBottom: '0',
                                  color: 'white',
                                  borderTop: pregunta.metadata?.titulo ? '1px solid rgba(255,255,255,0.1)' : 'none'
                                }}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.75rem', fontSize: '1rem'}}>üéØ Contexto</h4>
                                  <p style={{whiteSpace: 'pre-wrap', lineHeight: '1.6', margin: 0}}>{pregunta.metadata.contexto}</p>
                                </div>
                              )}
                              
                              {/* Descripci√≥n */}
                              {pregunta.metadata?.descripcion && (
                                <div style={{
                                  padding: '1.5rem',
                                  background: 'rgba(39, 16, 41, 0.3)',
                                  marginBottom: '0',
                                  color: '#cbd5e0',
                                  borderTop: '1px solid rgba(255,255,255,0.05)'
                                }}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.75rem', fontSize: '1rem', color: '#f5576c'}}>üìã Descripci√≥n</h4>
                                  <p style={{whiteSpace: 'pre-wrap', lineHeight: '1.6', margin: 0}}>{pregunta.metadata.descripcion}</p>
                                </div>
                              )}
                              
                              {/* Datos Clave - Campo gen√©rico para todos los casos */}
                              {pregunta.metadata?.datos_clave && Array.isArray(pregunta.metadata.datos_clave) && pregunta.metadata.datos_clave.length > 0 && (
                                <div style={{
                                  padding: '1rem 1.5rem', 
                                  background: 'linear-gradient(135deg, rgba(245, 158, 11, 0.15) 0%, rgba(217, 119, 6, 0.1) 100%)', 
                                  borderTop: '1px solid rgba(255,255,255,0.05)',
                                  borderLeft: '3px solid #f59e0b'
                                }}>
                                  <h4 style={{
                                    marginTop: 0, 
                                    marginBottom: '0.75rem', 
                                    fontSize: '0.95rem', 
                                    color: '#fbbf24',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '0.5rem'
                                  }}>
                                    <span>üîë</span>
                                    <span>Datos Clave</span>
                                  </h4>
                                  <ul style={{
                                    margin: 0, 
                                    paddingLeft: '1.5rem', 
                                    color: '#fde68a',
                                    listStyleType: 'circle'
                                  }}>
                                    {pregunta.metadata.datos_clave.map((dato, idx) => (
                                      <li key={idx} style={{
                                        marginBottom: '0.5rem',
                                        lineHeight: '1.6'
                                      }}>{dato}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Campos espec√≠ficos por tipo de caso */}
                              
                              {/* Caso Descriptivo - Puntos clave */}
                              {pregunta.metadata?.puntos_clave && Array.isArray(pregunta.metadata.puntos_clave) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üîë Puntos Clave</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.puntos_clave.map((punto, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{punto}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Caso Anal√≠tico - √Åreas de an√°lisis */}
                              {pregunta.metadata?.areas_analisis && Array.isArray(pregunta.metadata.areas_analisis) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üî¨ √Åreas de An√°lisis</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.areas_analisis.map((area, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{area}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Caso Resoluci√≥n - Restricciones y criterios */}
                              {pregunta.metadata?.restricciones && Array.isArray(pregunta.metadata.restricciones) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(245, 87, 108, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#f5576c'}}>‚ö†Ô∏è Restricciones</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.restricciones.map((rest, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{rest}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {pregunta.metadata?.criterios_evaluacion && Array.isArray(pregunta.metadata.criterios_evaluacion) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üìä Criterios de Evaluaci√≥n</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.criterios_evaluacion.map((crit, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{crit}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Caso Decisi√≥n - Opciones y criterios */}
                              {pregunta.metadata?.opciones_disponibles && Array.isArray(pregunta.metadata.opciones_disponibles) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üéØ Opciones Disponibles</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.opciones_disponibles.map((opcion, idx) => (
                                      <li key={idx} style={{marginBottom: '0.5rem'}}>{opcion}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {pregunta.metadata?.criterios_decision && Array.isArray(pregunta.metadata.criterios_decision) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>‚öñÔ∏è Criterios de Decisi√≥n</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.criterios_decision.map((crit, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{crit}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Caso Comparativo - Elementos a comparar */}
                              {pregunta.metadata?.elementos_comparar && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.75rem', fontSize: '0.9rem', color: '#a0aec0'}}>üîÑ Elementos a Comparar</h4>
                                  {Object.entries(pregunta.metadata.elementos_comparar).map(([key, value], idx) => (
                                    <div key={idx} style={{marginBottom: '0.75rem'}}>
                                      <strong style={{color: '#667eea'}}>{value.nombre || key}:</strong>
                                      {value.caracteristicas && Array.isArray(value.caracteristicas) && (
                                        <ul style={{margin: '0.25rem 0 0 0', paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                          {value.caracteristicas.map((car, cidx) => (
                                            <li key={cidx}>{car}</li>
                                          ))}
                                        </ul>
                                      )}
                                    </div>
                                  ))}
                                </div>
                              )}
                              
                              {pregunta.metadata?.criterios_comparacion && Array.isArray(pregunta.metadata.criterios_comparacion) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üìä Criterios de Comparaci√≥n</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.criterios_comparacion.map((crit, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{crit}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Caso Predictivo - Datos y factores */}
                              {pregunta.metadata?.datos_actuales && Array.isArray(pregunta.metadata.datos_actuales) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üìà Datos Actuales</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.datos_actuales.map((dato, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{dato}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {pregunta.metadata?.factores_considerar && Array.isArray(pregunta.metadata.factores_considerar) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üé≤ Factores a Considerar</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.factores_considerar.map((factor, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{factor}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Caso Simulaci√≥n - Variables din√°micas */}
                              {pregunta.metadata?.variables_dinamicas && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.75rem', fontSize: '0.9rem', color: '#a0aec0'}}>üéÆ Variables Din√°micas</h4>
                                  {Object.entries(pregunta.metadata.variables_dinamicas).map(([varName, varData], idx) => (
                                    <div key={idx} style={{marginBottom: '0.5rem', color: '#cbd5e0'}}>
                                      <strong style={{color: '#667eea'}}>{varName}:</strong>
                                      {varData.valor_inicial && ` Inicial: ${varData.valor_inicial}`}
                                      {varData.rango && ` (Rango: ${varData.rango})`}
                                      {varData.opciones && ` (Opciones: ${varData.opciones.join(', ')})`}
                                    </div>
                                  ))}
                                </div>
                              )}
                              
                              {pregunta.metadata?.decisiones_tomar && Array.isArray(pregunta.metadata.decisiones_tomar) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üéØ Decisiones a Tomar</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.decisiones_tomar.map((dec, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{dec}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Caso Inverso - Resultado y pistas */}
                              {pregunta.metadata?.resultado_final && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(245, 87, 108, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#f5576c'}}>üéØ Resultado Final</h4>
                                  <p style={{margin: 0, color: '#cbd5e0'}}>{pregunta.metadata.resultado_final}</p>
                                </div>
                              )}
                              
                              {pregunta.metadata?.pistas && Array.isArray(pregunta.metadata.pistas) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üí° Pistas</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.pistas.map((pista, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{pista}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {pregunta.metadata?.pasos_reconstruir && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <p style={{margin: 0, color: '#a0aec0'}}>
                                    üî¢ Pasos a reconstruir: <strong style={{color: '#667eea'}}>{pregunta.metadata.pasos_reconstruir}</strong>
                                  </p>
                                </div>
                              )}
                              
                              {/* Caso Fallo - Se√±ales de alerta y consecuencias */}
                              {pregunta.metadata?.se√±ales_alerta && Array.isArray(pregunta.metadata.se√±ales_alerta) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(245, 87, 108, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#f5576c'}}>üö® Se√±ales de Alerta Ignoradas</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.se√±ales_alerta.map((se√±al, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{se√±al}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {pregunta.metadata?.consecuencias && Array.isArray(pregunta.metadata.consecuencias) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(245, 87, 108, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#f5576c'}}>üí• Consecuencias</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.consecuencias.map((cons, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{cons}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Caso Creativo - Criterios de creatividad */}
                              {pregunta.metadata?.criterios_creatividad && Array.isArray(pregunta.metadata.criterios_creatividad) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>‚ú® Criterios de Creatividad</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.criterios_creatividad.map((crit, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{crit}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Caso √âtico - Stakeholders y dilema */}
                              {pregunta.metadata?.stakeholders && Array.isArray(pregunta.metadata.stakeholders) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üë• Partes Afectadas</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.stakeholders.map((stake, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{stake}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {pregunta.metadata?.dilema && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(245, 87, 108, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#f5576c'}}>‚öñÔ∏è Dilema √âtico</h4>
                                  <p style={{margin: 0, color: '#cbd5e0'}}>{pregunta.metadata.dilema}</p>
                                </div>
                              )}
                              
                              {pregunta.metadata?.consideraciones_eticas && Array.isArray(pregunta.metadata.consideraciones_eticas) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üß≠ Consideraciones √âticas</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.consideraciones_eticas.map((cons, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{cons}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Caso T√©cnico - M√©tricas y limitaciones */}
                              {pregunta.metadata?.metricas_actuales && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.75rem', fontSize: '0.9rem', color: '#a0aec0'}}>üìä M√©tricas Actuales</h4>
                                  {Object.entries(pregunta.metadata.metricas_actuales).map(([metrica, valor], idx) => (
                                    <div key={idx} style={{marginBottom: '0.5rem', color: '#cbd5e0'}}>
                                      <strong style={{color: '#667eea'}}>{metrica}:</strong> {valor}
                                    </div>
                                  ))}
                                </div>
                              )}
                              
                              {pregunta.metadata?.limitaciones_tecnicas && Array.isArray(pregunta.metadata.limitaciones_tecnicas) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(245, 87, 108, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#f5576c'}}>‚ö†Ô∏è Limitaciones T√©cnicas</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.limitaciones_tecnicas.map((lim, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{lim}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {pregunta.metadata?.objetivos_optimizacion && Array.isArray(pregunta.metadata.objetivos_optimizacion) && (
                                <div style={{padding: '1rem 1.5rem', background: 'rgba(102, 126, 234, 0.1)', borderTop: '1px solid rgba(255,255,255,0.05)'}}>
                                  <h4 style={{marginTop: 0, marginBottom: '0.5rem', fontSize: '0.9rem', color: '#a0aec0'}}>üéØ Objetivos de Optimizaci√≥n</h4>
                                  <ul style={{margin: 0, paddingLeft: '1.5rem', color: '#cbd5e0'}}>
                                    {pregunta.metadata.objetivos_optimizacion.map((obj, idx) => (
                                      <li key={idx} style={{marginBottom: '0.25rem'}}>{obj}</li>
                                    ))}
                                  </ul>
                                </div>
                              )}
                              
                              {/* Pregunta principal del caso */}
                              <div style={{
                                padding: '1.5rem',
                                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                borderRadius: '0 0 8px 8px',
                                marginTop: '0',
                                color: 'white',
                                borderTop: '2px solid rgba(255,255,255,0.2)'
                              }}>
                                <h4 style={{marginTop: 0, marginBottom: '0.75rem', fontSize: '1rem'}}>‚ùì Pregunta</h4>
                                <p style={{margin: 0, fontSize: '1.05rem', fontWeight: '500'}}>{pregunta.pregunta}</p>
                              </div>
                            </div>
                          )}
                          
                          {/* Para otros tipos, mostrar pregunta normal */}
                          {pregunta.tipo !== 'case_study' && (
                            <p className="pregunta-texto">{pregunta.pregunta}</p>
                          )}
                          
                          {/* Descripci√≥n adicional para casos de estudio (legacy - por si el modelo no usa la nueva estructura) */}
                          {pregunta.tipo === 'case_study' && pregunta.metadata?.description && !pregunta.metadata?.descripcion && (
                            <div className="case-study-description" style={{
                              padding: '1rem',
                              background: 'rgba(39, 16, 41, 0.1)',
                              borderLeft: '3px solid #f5576c',
                              borderRadius: '4px',
                              marginTop: '0.5rem',
                              marginBottom: '1rem'
                            }}>
                              <strong style={{color: '#f5576c'}}>üí° Consideraciones:</strong>
                              <p style={{margin: '0.5rem 0 0 0', color: '#cbd5e0'}}>{pregunta.metadata.description}</p>
                            </div>
                          )}
                          
                          {/* Respuesta seg√∫n tipo */}
                          
                          {/* Flashcard con Bot√≥n Modal */}
                          {pregunta.tipo === 'flashcard' && (
                            <>
                              {/* Bot√≥n para abrir flashcard */}
                              <button
                                onClick={() => setFlashcardsVolteadas(prev => ({...prev, [index]: true}))}
                                className="btn-abrir-flashcard"
                                style={{
                                  width: '100%',
                                  padding: '1rem',
                                  background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '12px',
                                  fontSize: '1rem',
                                  fontWeight: '600',
                                  cursor: 'pointer',
                                  transition: 'all 0.3s ease',
                                  marginBottom: '1.5rem'
                                }}
                              >
                                üí° Pista
                              </button>
                              
                              {/* Modal Flashcard */}
                              {flashcardsVolteadas[index] && (
                                <div 
                                  className="flashcard-modal-overlay"
                                  onClick={() => setFlashcardsVolteadas(prev => ({...prev, [index]: false}))}
                                  style={{
                                    position: 'fixed',
                                    top: 0,
                                    left: 0,
                                    right: 0,
                                    bottom: 0,
                                    background: 'rgba(0, 0, 0, 0.75)',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    zIndex: 9999
                                  }}
                                >
                                  <div 
                                    className="flashcard-modal-content"
                                    onClick={(e) => e.stopPropagation()}
                                    style={{
                                      width: '90%',
                                      maxWidth: '500px',
                                      maxHeight: '80vh',
                                      overflowY: 'auto',
                                      background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
                                      borderRadius: '16px',
                                      padding: '2rem',
                                      position: 'relative',
                                      boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)'
                                    }}
                                  >
                                    {/* Bot√≥n cerrar */}
                                    <button
                                      onClick={() => setFlashcardsVolteadas(prev => ({...prev, [index]: false}))}
                                      style={{
                                        position: 'absolute',
                                        top: '1rem',
                                        right: '1rem',
                                        background: '#ef4444',
                                        color: 'white',
                                        border: 'none',
                                        borderRadius: '50%',
                                        width: '36px',
                                        height: '36px',
                                        fontSize: '1.2rem',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontWeight: 'bold'
                                      }}
                                    >
                                      √ó
                                    </button>
                                    
                                    {/* Contenido Flashcard */}
                                    <div style={{marginTop: '1rem'}}>
                                      <div style={{
                                        fontSize: '1.2rem',
                                        fontWeight: '600',
                                        color: '#e2e8f0',
                                        marginBottom: '1rem',
                                        textAlign: 'center'
                                      }}>
                                        ü§î {pregunta.pregunta || pregunta.metadata?.data?.front}
                                      </div>
                                      
                                      {pregunta.metadata?.data?.hint && (
                                        <div style={{
                                          background: 'rgba(59, 130, 246, 0.15)',
                                          padding: '0.75rem 1rem',
                                          borderRadius: '8px',
                                          fontSize: '0.9rem',
                                          marginBottom: '1rem',
                                          borderLeft: '4px solid #3b82f6',
                                          color: '#93c5fd'
                                        }}>
                                          üí° <strong>Pista:</strong> {pregunta.metadata.data.hint}
                                        </div>
                                      )}
                                      
                                      {/* Dropdown con respuesta y detalles */}
                                      <details style={{
                                        background: 'rgba(71, 85, 105, 0.3)',
                                        padding: '1rem',
                                        borderRadius: '12px',
                                        marginTop: '1rem',
                                        border: '1px solid rgba(148, 163, 184, 0.2)'
                                      }}>
                                        <summary style={{
                                          fontSize: '1.1rem',
                                          fontWeight: '600',
                                          color: '#60a5fa',
                                          cursor: 'pointer',
                                          userSelect: 'none',
                                          listStyle: 'none',
                                          display: 'flex',
                                          alignItems: 'center',
                                          gap: '0.5rem'
                                        }}>
                                          <span style={{fontSize: '1.3rem'}}>‚ñ∂</span> Ver Respuesta
                                        </summary>
                                        
                                        <div style={{marginTop: '1rem', paddingTop: '1rem', borderTop: '1px solid rgba(148, 163, 184, 0.2)'}}>
                                          <div style={{
                                            fontSize: '1.3rem',
                                            fontWeight: '700',
                                            color: '#34d399',
                                            marginBottom: '1rem',
                                            textAlign: 'center'
                                          }}>
                                            ‚úÖ {pregunta.metadata?.solution?.answer || pregunta.respuesta_correcta}
                                          </div>
                                          
                                          {pregunta.metadata?.solution?.explanation && (
                                            <div style={{
                                              background: 'rgba(59, 130, 246, 0.1)',
                                              padding: '0.75rem 1rem',
                                              borderRadius: '8px',
                                              fontSize: '0.9rem',
                                              marginTop: '0.75rem',
                                              borderLeft: '3px solid #3b82f6',
                                              color: '#cbd5e1'
                                            }}>
                                              <strong style={{color: '#93c5fd'}}>üìö Explicaci√≥n:</strong><br/>
                                              {pregunta.metadata.solution.explanation}
                                            </div>
                                          )}
                                          
                                          {pregunta.metadata?.solution?.key_points && pregunta.metadata.solution.key_points.length > 0 && (
                                            <div style={{
                                              background: 'rgba(249, 115, 22, 0.1)',
                                              padding: '0.75rem 1rem',
                                              borderRadius: '8px',
                                              fontSize: '0.9rem',
                                              marginTop: '0.75rem',
                                              borderLeft: '3px solid #f97316',
                                              color: '#cbd5e1'
                                            }}>
                                              <strong style={{color: '#fb923c'}}>üéØ Puntos Clave:</strong>
                                              <ul style={{marginTop: '0.5rem', paddingLeft: '1.5rem'}}>
                                                {pregunta.metadata.solution.key_points.map((punto, i) => (
                                                  <li key={i} style={{marginBottom: '0.3rem'}}>{punto}</li>
                                                ))}
                                              </ul>
                                            </div>
                                          )}
                                        </div>
                                      </details>
                                    </div>
                                  </div>
                                </div>
                              )}
                              
                              {/* √Årea de respuesta SEPARADA */}
                              <div className="flashcard-answer-area">
                                <label className="flashcard-answer-label">
                                  üìù Tu respuesta:
                                </label>
                                
                                {/* 4 OPCIONES CONFUSAS o Respuesta Corta */}
                                {pregunta.metadata?.confusing_options && Array.isArray(pregunta.metadata.confusing_options) && pregunta.metadata.confusing_options.length === 4 ? (
                                  <div className="opciones-confusas">
                                    {pregunta.metadata.confusing_options.map((opcion, i) => (
                                      <label key={i} className="opcion-confusa">
                                        <input
                                          type="radio"
                                          name={`flashcard-${index}`}
                                          value={opcion}
                                          checked={respuestasUsuario[index] === opcion}
                                          onChange={(e) => actualizarRespuesta(index, e.target.value)}
                                        />
                                        <span>{opcion}</span>
                                      </label>
                                    ))}
                                  </div>
                                ) : (
                                  <textarea
                                    value={respuestasUsuario[index] || ''}
                                    onChange={(e) => actualizarRespuesta(index, e.target.value)}
                                    placeholder="Escribe tu respuesta aqu√≠..."
                                    rows={3}
                                    className="flashcard-textarea"
                                  />
                                )}
                              </div>
                            </>
                          )}
                          
                          {/* MCQ - Opci√≥n M√∫ltiple */}
                          {(pregunta.tipo === 'multiple' || pregunta.tipo === 'mcq') && (
                            <div className="opciones-multiple">
                              {pregunta.opciones && pregunta.opciones.length > 0 ? (
                                pregunta.opciones.map((opcion, i) => (
                                  <label key={i} className="opcion-radio">
                                    <input
                                      type="radio"
                                      name={`pregunta-${index}`}
                                      value={opcion.charAt(0)}
                                      checked={respuestasUsuario[index] === opcion.charAt(0)}
                                      onChange={(e) => actualizarRespuesta(index, e.target.value)}
                                    />
                                    <span>{opcion}</span>
                                  </label>
                                ))
                              ) : (
                                <div className="opciones-no-disponibles">
                                  ‚ö†Ô∏è Las opciones no est√°n disponibles para este examen. 
                                  Solo puedes reintentar ex√°menes generados recientemente.
                                </div>
                              )}
                            </div>
                          )}
                          
                          {/* Verdadero/Falso */}
                          {(pregunta.tipo === 'verdadero_falso' || pregunta.tipo === 'verdadero-falso' || pregunta.tipo === 'true_false') && (
                            <div className="opciones-verdadero-falso">
                              <label className="opcion-vf">
                                <input
                                  type="radio"
                                  name={`pregunta-${index}`}
                                  value="verdadero"
                                  checked={respuestasUsuario[index] === 'verdadero' || respuestasUsuario[index] === 'true'}
                                  onChange={(e) => actualizarRespuesta(index, e.target.value)}
                                />
                                <span className="texto-vf verdadero">‚úì Verdadero</span>
                              </label>
                              <label className="opcion-vf">
                                <input
                                  type="radio"
                                  name={`pregunta-${index}`}
                                  value="falso"
                                  checked={respuestasUsuario[index] === 'falso' || respuestasUsuario[index] === 'false'}
                                  onChange={(e) => actualizarRespuesta(index, e.target.value)}
                                />
                                <span className="texto-vf falso">‚úó Falso</span>
                              </label>
                            </div>
                          )}
                          
                          {/* Cloze Test - Relleno de huecos */}
                          {pregunta.tipo === 'cloze' && (
                            <div className="respuesta-cloze">
                              <p className="cloze-text">{pregunta.pregunta}</p>
                              <textarea
                                className="respuesta-corta"
                                placeholder="Completa los espacios en blanco (separa respuestas con comas)..."
                                value={respuestasUsuario[index] || ''}
                                onChange={(e) => actualizarRespuesta(index, e.target.value)}
                                rows={3}
                              />
                            </div>
                          )}
                          
                          {/* Respuesta Corta */}
                          {(pregunta.tipo === 'corta' || pregunta.tipo === 'short_answer') && (
                            <div className="respuesta-con-voz">
                              <textarea
                                className="respuesta-corta"
                                placeholder="Escribe tu respuesta aqu√≠ (2-3 l√≠neas)..."
                                value={respuestasUsuario[index] || ''}
                                onChange={(e) => actualizarRespuesta(index, e.target.value)}
                                rows={3}
                              />
                              <button
                                type="button"
                                className={`btn-microfono ${escuchandoPregunta === index ? 'escuchando' : ''}`}
                                onClick={() => alternarEscuchaVoz(index)}
                                title={escuchandoPregunta === index ? 'Detener grabaci√≥n' : 'Responder con voz'}
                              >
                                {escuchandoPregunta === index ? 'üî¥' : 'üé§'}
                              </button>
                              {escuchandoPregunta === index && transcripcionTemp && (
                                <div className="transcripcion-temp">
                                  Escuchando: "{transcripcionTemp}"
                                </div>
                              )}
                            </div>
                          )}
                          
                          {/* Desarrollo / Open Question / Case Study */}
                          {(pregunta.tipo === 'desarrollo' || pregunta.tipo === 'open_question' || pregunta.tipo === 'case_study') && (
                            <div className="respuesta-con-voz">
                              <textarea
                                className="respuesta-desarrollo"
                                placeholder="Desarrolla tu respuesta completa aqu√≠..."
                                value={respuestasUsuario[index] || ''}
                                onChange={(e) => actualizarRespuesta(index, e.target.value)}
                                rows="8"
                              />
                              <button
                                type="button"
                                className={`btn-microfono ${escuchandoPregunta === index ? 'escuchando' : ''}`}
                                onClick={() => alternarEscuchaVoz(index)}
                                title={escuchandoPregunta === index ? 'Detener grabaci√≥n' : 'Responder con voz'}
                              >
                                {escuchandoPregunta === index ? 'üî¥' : 'üé§'}
                              </button>
                              {escuchandoPregunta === index && transcripcionTemp && (
                                <div className="transcripcion-temp">
                                  Escuchando: "{transcripcionTemp}"
                                </div>
                              )}
                            </div>
                          )}
                        </div>
                      );
                      })}
                    </div>

                    <div className="examen-info-guardado">
                      <p className="info-autosave">üíæ Tus respuestas se guardan autom√°ticamente en archivo local</p>
                      <p className="info-hint">Sobrevive al reinicio de PC. Para guardar en el servidor, haz clic en "Pausar"</p>
                    </div>

                    <div className="examen-acciones">
                      <button onClick={enviarExamen} className="btn-enviar-examen" disabled={generandoExamen}>
                        {generandoExamen ? '‚è≥ Calificando...' : '‚úÖ Enviar Examen'}

                      </button>
                      <button onClick={pausarExamen} className="btn-pausar-examen">
                        ‚è∏Ô∏è Pausar
                      </button>
                      <button onClick={cerrarExamen} className="btn-cancelar">
                        Cancelar
                      </button>
                    </div>
                  </>
                ) : (
                  <>
                    {/* Resultados del Examen */}
                    <div className="resultado-header">
                      <div className="resultado-puntuacion">
                        <h3>Calificaci√≥n: {resultadoExamen.puntos_obtenidos} / {resultadoExamen.puntos_totales}</h3>
                        <div className="resultado-porcentaje" style={{
                          color: resultadoExamen.porcentaje >= 70 ? '#22c55e' : resultadoExamen.porcentaje >= 50 ? '#fbbf24' : '#ef4444'
                        }}>
                          {resultadoExamen.porcentaje.toFixed(1)}%
                        </div>
                      </div>
                      
                      <div className="resultado-estado">
                        {resultadoExamen.porcentaje >= 70 ? (
                          <span className="estado-aprobado">‚úÖ APROBADO</span>
                        ) : resultadoExamen.porcentaje >= 50 ? (
                          <span className="estado-regular">‚ö†Ô∏è REGULAR</span>
                        ) : (
                          <span className="estado-reprobado">‚ùå REPROBADO</span>
                        )}
                      </div>
                    </div>

                    <div className="resultados-detalle">
                      {resultadoExamen.resultados.map((resultado, index) => (
                        <div key={index} className="resultado-pregunta">
                          <div className="resultado-pregunta-header">
                            <span className="pregunta-numero">Pregunta {index + 1}</span>
                            <span className="resultado-puntos" style={{
                              color: resultado.puntos === resultado.puntos_maximos ? '#22c55e' : 
                                     resultado.puntos > 0 ? '#fbbf24' : '#ef4444'
                            }}>
                              {resultado.puntos} / {resultado.puntos_maximos} pts
                              {resultado.porcentaje !== undefined && (
                                <span style={{marginLeft: '0.5rem', fontSize: '0.9em'}}>
                                  ({resultado.porcentaje.toFixed(0)}%)
                                </span>
                              )}
                            </span>
                          </div>
                          
                          {/* Mostrar pr√≥xima revisi√≥n si existe */}
                          {resultado.proximaRevision && (
                            <div className="resultado-proxima-revision" style={{
                              fontSize: '0.85rem',
                              color: '#a78bfa',
                              marginTop: '0.5rem',
                              padding: '0.5rem',
                              background: 'rgba(139, 92, 246, 0.1)',
                              borderRadius: '8px',
                              border: '1px solid rgba(139, 92, 246, 0.3)'
                            }}>
                              üîÑ Pr√≥xima revisi√≥n: {new Date(resultado.proximaRevision).toLocaleDateString('es-ES', { 
                                weekday: 'long',
                                day: 'numeric', 
                                month: 'long',
                                hour: '2-digit',
                                minute: '2-digit'
                              })}
                              {resultado.intervalo !== undefined && (
                                <span style={{marginLeft: '0.5rem', opacity: 0.8}}>
                                  ({resultado.intervalo >= 1 ? `${resultado.intervalo} d√≠as` : '12 horas'})
                                </span>
                              )}
                            </div>
                          )}
                          
                          <p className="resultado-pregunta-texto">{resultado.pregunta}</p>
                          
                          <div className="resultado-respuesta">
                            <strong>Tu respuesta:</strong>
                            <p>{resultado.respuesta_usuario || '(Sin respuesta)'}</p>
                          </div>
                          
                          {resultado.respuesta_correcta && (
                            <div className="resultado-respuesta-correcta">
                              <strong>Respuesta correcta:</strong>
                              <p>{resultado.respuesta_correcta}</p>
                            </div>
                          )}
                          
                          {/* Bot√≥n para marcar como comprendida si fall√≥ */}
                          {resultado.puntos < resultado.puntos_maximos && (
                            <div style={{marginTop: '0.5rem'}}>
                              {preguntasComprendidas[examenActivo?.id]?.[index] ? (
                                <div style={{
                                  padding: '0.5rem',
                                  background: '#22c55e',
                                  color: 'white',
                                  borderRadius: '4px',
                                  textAlign: 'center',
                                  fontSize: '0.9rem'
                                }}>
                                  ‚úÖ Pregunta comprendida y corregida
                                </div>
                              ) : (
                                <button
                                  onClick={() => marcarPreguntaComprendida(index)}
                                  style={{
                                    padding: '0.5rem 1rem',
                                    background: '#3b82f6',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer',
                                    fontSize: '0.9rem',
                                    width: '100%'
                                  }}
                                >
                                  ‚úì Marcar como Comprendida
                                </button>
                              )}
                            </div>
                          )}
                          
                          <div className="resultado-feedback" style={{
                            borderLeftColor: resultado.puntos === resultado.puntos_maximos ? '#22c55e' : 
                                            resultado.puntos > 0 ? '#fbbf24' : '#ef4444'
                          }}>
                            <strong>Retroalimentaci√≥n:</strong>
                            <p>{resultado.feedback}</p>
                          </div>
                        </div>
                      ))}
                    </div>

                    <div className="examen-acciones">
                      <button onClick={() => {
                        setModalExamenAbierto(false)
                        setViendoExamen(null)
                        setExamenActivo(null)
                        setPreguntasExamen([])
                        setRespuestasUsuario({})
                        setExamenCompletado(false)
                        setResultadoExamen(null)
                      }} className="btn-close-resultado">
                        Cerrar Pr√°ctica
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
          </div>
        )}

        {/* Modal para Ver Resultado de Examen Completado */}
        {viendoExamen && (
          <div className="modal-overlay" onClick={() => setViendoExamen(null)}>
            <div className="modal-examen" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üìä Resultado - {viendoExamen.carpeta_nombre}</h2>
                <button onClick={() => setViendoExamen(null)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body examen-body">
                <div className="resultado-header">
                  <div className="resultado-puntuacion">
                    <h3>Calificaci√≥n: {viendoExamen.puntos_obtenidos} / {viendoExamen.puntos_totales}</h3>
                    <div className="resultado-porcentaje" style={{
                      color: viendoExamen.porcentaje >= 70 ? '#22c55e' : viendoExamen.porcentaje >= 50 ? '#fbbf24' : '#ef4444'
                    }}>
                      {viendoExamen.porcentaje.toFixed(1)}%
                    </div>
                  </div>
                  
                  <div className="resultado-estado">
                    {viendoExamen.porcentaje >= 70 ? (
                      <span className="estado-aprobado">‚úÖ APROBADO</span>
                    ) : viendoExamen.porcentaje >= 50 ? (
                      <span className="estado-regular">‚ö†Ô∏è REGULAR</span>
                    ) : (
                      <span className="estado-reprobado">‚ùå REPROBADO</span>
                    )}
                  </div>
                </div>

                <div className="resultados-detalle">
                  {viendoExamen.resultados.map((resultado, index) => (
                    <div key={index} className="resultado-pregunta">
                      <div className="resultado-pregunta-header">
                        <span className="pregunta-numero">Pregunta {index + 1}</span>
                        <span className="resultado-puntos" style={{
                          color: resultado.puntos === resultado.puntos_maximos ? '#22c55e' : 
                                 resultado.puntos > 0 ? '#fbbf24' : '#ef4444'
                        }}>
                          {resultado.puntos} / {resultado.puntos_maximos} pts
                        </span>
                      </div>
                      
                      <p className="resultado-pregunta-texto">{resultado.pregunta}</p>
                      
                      <div className="resultado-respuesta">
                        <strong>Tu respuesta:</strong>
                        <p>{resultado.respuesta_usuario || '(Sin respuesta)'}</p>
                      </div>
                      
                      {resultado.respuesta_correcta && (
                        <div className="resultado-respuesta-correcta">
                          <strong>Respuesta correcta:</strong>
                          <p>{resultado.respuesta_correcta}</p>
                        </div>
                      )}
                      
                      <div className="resultado-feedback" style={{
                        borderLeftColor: resultado.puntos === resultado.puntos_maximos ? '#22c55e' : 
                                        resultado.puntos > 0 ? '#fbbf24' : '#ef4444'
                      }}>
                        <strong>Retroalimentaci√≥n:</strong>
                        <p>{resultado.feedback}</p>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="examen-acciones">
                  <button onClick={() => {
                    setModalExamenAbierto(false)
                    setViendoExamen(null)
                    setExamenActivo(null)
                    setPreguntasExamen([])
                    setRespuestasUsuario({})
                    setExamenCompletado(false)
                    setResultadoExamen(null)
                  }} className="btn-close-resultado">
                    Cerrar Pr√°ctica
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal para configurar pr√°ctica personalizada */}
        {modalPracticaAbierto && (
          <div className="modal-overlay" onClick={() => setModalPracticaAbierto(false)}>
            <div className="modal-content modal-config-practica" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üßë‚Äçüíª Configurar Pr√°ctica Personalizada</h2>
                <button onClick={() => setModalPracticaAbierto(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                {/* Flashcards */}
                <details className="practice-type-section" open>
                  <summary className="practice-type-header">
                    <span className="practice-icon">üÉè</span>
                    <span className="practice-title">Flashcards Inteligentes</span>
                    <span className="practice-count">{numFlashcards}</span>
                  </summary>
                  <div className="practice-type-content">
                    <p className="practice-description">
                      Pregunta en un lado, respuesta + explicaci√≥n en el otro. Ideal para memorizaci√≥n.
                    </p>
                    <div className="config-control">
                      <label>Cantidad:</label>
                      <input
                        type="number"
                        min="0"
                        max="20"
                        value={numFlashcards}
                        onChange={(e) => setNumFlashcards(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))}
                        className="input-number"
                      />
                    </div>
                    <div className="config-control" style={{marginTop: '10px'}}>
                      <label htmlFor="tipo-flashcard">Tipo de Flashcard:</label>
                      <select 
                        id="tipo-flashcard"
                        value={tipoFlashcard}
                        onChange={(e) => setTipoFlashcard(e.target.value)}
                        style={{
                          padding: '8px 12px',
                          borderRadius: '6px',
                          border: '1px solid #ccc',
                          fontSize: '14px',
                          cursor: 'pointer',
                          width: '100%',
                          marginTop: '5px'
                        }}
                      >
                        <option value="respuesta_corta">üìù Respuesta Corta - Escribe la respuesta</option>
                        <option value="seleccion_confusa">ü§î Selecci√≥n Confusa - Elige entre opciones similares</option>
                      </select>
                    </div>
                    
                    {/* 12 Flashcards Avanzadas */}
                    <details style={{
                      marginTop: '20px',
                      background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
                      borderRadius: '12px',
                      padding: '15px',
                      border: '1px solid rgba(148, 163, 184, 0.2)'
                    }}>
                      <summary style={{
                        fontSize: '1rem',
                        fontWeight: '600',
                        color: '#60a5fa',
                        cursor: 'pointer',
                        userSelect: 'none',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px',
                        padding: '8px'
                      }}>
                        <span>üéì</span>
                        <span>Flashcards Avanzadas ({
                          numFlashClassic + numFlashRecognition + numFlashCloze + 
                          numFlashScenario + numFlashMCQ + numFlashVisual + 
                          numFlashAudio + numFlashProduction + numFlashReversed + 
                          numFlashHierarchy + numFlashError + numFlashComparison
                        })</span>
                      </summary>
                      
                      <div style={{marginTop: '15px', display: 'flex', flexDirection: 'column', gap: '12px'}}>
                        
                        {/* 1. Cl√°sica */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>üìá</span>
                            <span>1. Cl√°sica (Anverso‚ÄìReverso)</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashClassic}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Pregunta en un lado, respuesta en el otro. Lo m√°s tradicional.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Memorizar vocabulario, fechas, f√≥rmulas, definiciones. Es como aprender cartas de memoria.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Te dar√°s cuenta cuando digas "¬°Ah! Ya no necesito buscar esa palabra, la s√© de memoria". Mejora tu velocidad de recordaci√≥n autom√°tica.</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> "¬øCapital de Jap√≥n?" ‚Üí "Tokio". Cuando viajes o veas una noticia, recordar√°s instant√°neamente sin pensar.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashClassic} onChange={(e) => setNumFlashClassic(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 2. Reconocimiento */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>üëÅÔ∏è</span>
                            <span>2. Reconocimiento</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashRecognition}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Te muestran una imagen, s√≠mbolo o estructura y debes identificar qu√© es.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Perfecto para anatom√≠a (huesos, m√∫sculos), qu√≠mica (mol√©culas), logos, mapas, diagramas.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Cuando veas un diagrama en un examen o una radiograf√≠a en la pr√°ctica, dir√°s "¬°Eso es el h√∫mero!" sin dudar.</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> Imagen de una mol√©cula ‚Üí "H‚ÇÇO, agua". En laboratorio o examen, reconocer√°s estructuras al instante.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashRecognition} onChange={(e) => setNumFlashRecognition(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 3. Cloze Deletion */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>üî≤</span>
                            <span>3. Cloze Deletion (Texto con Huecos)</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashCloze}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Un texto con palabras ocultas que debes rellenar. Ej: "La _____ es fundamental para..."</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Oro para memorizar leyes, art√≠culos, reglas, procesos paso a paso, p√°rrafos completos.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Cuando tengas que recitar una ley o explicar un proceso, las palabras fluir√°n autom√°ticamente. "¬°Ah, ya s√© qu√© sigue!"</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> "Art√≠culo 1: Todos los seres humanos nacen _____ en dignidad" ‚Üí "libres e iguales". En ex√°menes de derecho o presentaciones, lo recordar√°s completo.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashCloze} onChange={(e) => setNumFlashCloze(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 4. Escenarios */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>üé¨</span>
                            <span>4. Escenarios (Mini-Casos)</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashScenario}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Te presentan una situaci√≥n real y preguntan qu√© har√≠as. No es te√≥rica, es pr√°ctica.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Entrenar pensamiento cr√≠tico, toma de decisiones y aplicar conocimiento a casos reales.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> En tu trabajo o vida diaria, cuando enfrentes problemas similares, dir√°s "Esto ya lo resolv√≠ antes mentalmente".</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> "Un paciente llega con dolor tor√°cico, ¬øprimera acci√≥n?" ‚Üí "Evaluar signos vitales y ECG". En emergencias reales, actuar√°s con confianza.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashScenario} onChange={(e) => setNumFlashScenario(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 5. M√∫ltiples Opciones */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>üîÄ</span>
                            <span>5. M√∫ltiples Opciones (MCQ)</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashMCQ}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Pregunta con opciones donde algunas son muy parecidas (distractores). Debes elegir la correcta.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Crear "fricci√≥n cognitiva" - te hace pensar m√°s profundo para distinguir detalles sutiles.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Cuando debas tomar decisiones donde varias opciones parecen v√°lidas, sabr√°s elegir con criterio. "No es solo correcta, es LA correcta".</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> "¬øCu√°l es mitocondria?" A) N√∫cleo B) Ret√≠culo C) Mitocondria D) Ribosoma. En ex√°menes tipo test, evitar√°s trampas.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashMCQ} onChange={(e) => setNumFlashMCQ(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 6. Visuales */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>üñºÔ∏è</span>
                            <span>6. Visuales</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashVisual}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Solo im√°genes. T√∫ debes explicar o identificar lo que ves sin texto de ayuda.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Anatom√≠a, dise√±o, ingenier√≠a, mapas geogr√°ficos, reparaci√≥n t√©cnica, arquitectura.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Cuando veas un plano, esquema o parte del cuerpo, lo reconocer√°s instant√°neamente. "¬°Ah, ese es el ventr√≠culo izquierdo!"</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> Imagen de un circuito ‚Üí "Circuito serie con resistencias en paralelo". En pr√°cticas o trabajo de campo, no necesitar√°s manual.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashVisual} onChange={(e) => setNumFlashVisual(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 7. Auditivas */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>üîä</span>
                            <span>7. Auditivas</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashAudio}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Escuchas un audio: frase, acento, sonido, m√∫sica. Debes identificarlo o responder.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Aprender idiomas, fon√©tica, reconocimiento de acentos, m√∫sica, diagn√≥stico m√©dico (estetoscopio).</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Cuando hables con nativos o escuches s√≠ntomas, tu o√≠do estar√° entrenado. "¬°Ese acento es brit√°nico, no estadounidense!"</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> Audio: "I've already eaten" ‚Üí "Present Perfect con 'already'". En conversaciones reales, entender√°s matices autom√°ticamente.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashAudio} onChange={(e) => setNumFlashAudio(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 8. Producci√≥n Activa */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>‚úçÔ∏è</span>
                            <span>8. Producci√≥n Activa</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashProduction}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Debes CREAR algo desde cero: frase, c√≥digo, procedimiento, ecuaci√≥n. No solo recordar.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Programaci√≥n, idiomas (escribir oraciones), matem√°ticas (resolver paso a paso), recetas, protocolos.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Cuando tengas que escribir c√≥digo o una frase en otro idioma, lo har√°s sin pensar. "¬°Ah, ya s√© c√≥mo se construye esto!"</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> "Produce una funci√≥n en Python que sume dos n√∫meros" ‚Üí "def suma(a, b): return a + b". En entrevistas t√©cnicas, fluir√° naturalmente.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashProduction} onChange={(e) => setNumFlashProduction(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 9. Invertidas */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>üîÑ</span>
                            <span>9. Invertidas (Reversas)</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashReversed}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Te dan la RESPUESTA primero, t√∫ debes recordar cu√°l era la pregunta original.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Entrenar s√≠ntesis y asociaciones profundas. Conectas conceptos en ambas direcciones.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Cuando veas resultados o s√≠ntomas, recordar√°s las causas. "Si veo esto, s√© qu√© lo provoc√≥".</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> Respuesta: "Mitocondria" ‚Üí Pregunta: "¬øOrg√°nulo que genera ATP?". En diagn√≥sticos, ir√°s de s√≠ntoma a causa r√°pidamente.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashReversed} onChange={(e) => setNumFlashReversed(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 10. Jerarqu√≠as */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>üå≥</span>
                            <span>10. Jerarqu√≠as / Mapas Mentales</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashHierarchy}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Te muestran un nodo (concepto) y debes recordar todo lo que se conecta: ramas superiores e inferiores.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Sistemas complejos, taxonom√≠as (clasificaciones biol√≥gicas), organigramas, estructuras de datos.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Cuando expliques temas complejos, recordar√°s la estructura completa. "¬°Ah, esto va arriba de aquello y se divide en estas 3 ramas!"</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> Nodo: "Mam√≠feros" ‚Üí Recordar: "Animales (arriba), Primates/Cet√°ceos/Carn√≠voros (abajo)". En biolog√≠a, conectar√°s todo el √°rbol.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashHierarchy} onChange={(e) => setNumFlashHierarchy(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 11. Error Intencional */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>üêõ</span>
                            <span>11. Error Intencional</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashError}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Te presentan algo INCORRECTO. Tu trabajo es detectar el error y corregirlo.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Gram√°tica, c√≥digo con bugs, matem√°ticas, procedimientos m√©dicos, auditor√≠as.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Cuando revises documentos o c√≥digo, detectar√°s errores que otros no ven. "¬°Espera, ah√≠ hay un error!"</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> "She don't like coffee" ‚Üí Error: "don't", Correcci√≥n: "doesn't". En tus propios textos, evitar√°s esos errores.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashError} onChange={(e) => setNumFlashError(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                        {/* 12. Comparaci√≥n */}
                        <details style={{background: 'rgba(71, 85, 105, 0.3)', padding: '12px', borderRadius: '8px', border: '1px solid rgba(148, 163, 184, 0.2)'}}>
                          <summary style={{fontSize: '0.95rem', fontWeight: '600', color: '#93c5fd', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <span>‚öñÔ∏è</span>
                            <span>12. Comparaci√≥n</span>
                            <span style={{marginLeft: 'auto', background: '#3b82f6', color: 'white', padding: '2px 8px', borderRadius: '12px', fontSize: '0.85rem'}}>{numFlashComparison}</span>
                          </summary>
                          <div style={{marginTop: '12px', paddingTop: '12px', borderTop: '1px solid rgba(148, 163, 184, 0.2)', color: '#cbd5e1', fontSize: '0.9rem', lineHeight: '1.6'}}>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üìñ Qu√© es:</strong> Te piden comparar DOS conceptos y explicar diferencias y similitudes.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üéØ Para qu√© sirve:</strong> Entender reglas gramaticales, decisiones de dise√±o, categor√≠as, an√°lisis cr√≠tico.</p>
                            <p style={{marginBottom: '8px'}}><strong style={{color: '#93c5fd'}}>üí° C√≥mo te ayuda:</strong> Cuando debas elegir entre opciones o explicar diferencias, lo har√°s con claridad. "Esto es mejor que aquello porque..."</p>
                            <p style={{marginBottom: '12px'}}><strong style={{color: '#93c5fd'}}>‚ú® Ejemplo √∫til:</strong> "Compara mitosis vs meiosis" ‚Üí "Mitosis: 2 c√©lulas id√©nticas. Meiosis: 4 c√©lulas con mitad de cromosomas". En ex√°menes de ensayo, brillar√°s.</p>
                            <div className="config-control">
                              <label style={{color: '#e2e8f0'}}>Cantidad:</label>
                              <input type="number" min="0" max="20" value={numFlashComparison} onChange={(e) => setNumFlashComparison(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))} className="input-number" style={{background: '#334155', color: '#e2e8f0', border: '1px solid #475569'}} />
                            </div>
                          </div>
                        </details>

                      </div>
                    </details>
                  </div>
                </details>

                {/* Preguntas de opci√≥n m√∫ltiple */}
                <details className="practice-type-section" open>
                  <summary className="practice-type-header">
                    <span className="practice-icon">‚úÖ</span>
                    <span className="practice-title">Opci√≥n M√∫ltiple (MCQ)</span>
                    <span className="practice-count">{numMCQ}</span>
                  </summary>
                  <div className="practice-type-content">
                    <p className="practice-description">
                      Pregunta con 3-5 opciones. Una o varias correctas. Incluye explicaci√≥n de la respuesta.
                    </p>
                    <div className="config-control">
                      <label>Cantidad:</label>
                      <input
                        type="number"
                        min="0"
                        max="20"
                        value={numMCQ}
                        onChange={(e) => setNumMCQ(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))}
                        className="input-number"
                      />
                    </div>
                  </div>
                </details>

                {/* Verdadero/Falso */}
                <details className="practice-type-section" open>
                  <summary className="practice-type-header">
                    <span className="practice-icon">‚úì‚úó</span>
                    <span className="practice-title">Verdadero o Falso</span>
                    <span className="practice-count">{numVerdaderoFalso}</span>
                  </summary>
                  <div className="practice-type-content">
                    <p className="practice-description">
                      Afirmaci√≥n que debe evaluarse como verdadera o falsa. Incluye explicaci√≥n detallada.
                    </p>
                    <div className="config-control">
                      <label>Cantidad:</label>
                      <input
                        type="number"
                        min="0"
                        max="20"
                        value={numVerdaderoFalso}
                        onChange={(e) => setNumVerdaderoFalso(Math.max(0, Math.min(20, parseInt(e.target.value) || 0)))}
                        className="input-number"
                      />
                    </div>
                  </div>
                </details>

                {/* Relleno de huecos */}
                <details className="practice-type-section">
                  <summary className="practice-type-header">
                    <span className="practice-icon">üìù</span>
                    <span className="practice-title">Relleno de Huecos (Cloze)</span>
                    <span className="practice-count">{numCloze}</span>
                  </summary>
                  <div className="practice-type-content">
                    <p className="practice-description">
                      Texto con espacios en blanco. Completa las palabras faltantes. Perfecto para definiciones y conceptos.
                    </p>
                    <div className="config-control">
                      <label>Cantidad:</label>
                      <input
                        type="number"
                        min="0"
                        max="15"
                        value={numCloze}
                        onChange={(e) => setNumCloze(Math.max(0, Math.min(15, parseInt(e.target.value) || 0)))}
                        className="input-number"
                      />
                    </div>
                  </div>
                </details>

                {/* Respuesta Corta */}
                <details className="practice-type-section">
                  <summary className="practice-type-header">
                    <span className="practice-icon">‚úçÔ∏è</span>
                    <span className="practice-title">Respuesta Corta</span>
                    <span className="practice-count">{numRespuestaCorta}</span>
                  </summary>
                  <div className="practice-type-content">
                    <p className="practice-description">
                      Pregunta que requiere respuesta breve (1-3 frases). Evaluaci√≥n por palabras clave.
                    </p>
                    <div className="config-control">
                      <label>Cantidad:</label>
                      <input
                        type="number"
                        min="0"
                        max="15"
                        value={numRespuestaCorta}
                        onChange={(e) => setNumRespuestaCorta(Math.max(0, Math.min(15, parseInt(e.target.value) || 0)))}
                        className="input-number"
                      />
                    </div>
                  </div>
                </details>

                {/* Preguntas abiertas */}
                <details className="practice-type-section">
                  <summary className="practice-type-header">
                    <span className="practice-icon">üìñ</span>
                    <span className="practice-title">Explicaci√≥n Detallada</span>
                    <span className="practice-count">{numOpenQuestion}</span>
                  </summary>
                  <div className="practice-type-content">
                    <p className="practice-description">
                      Pregunta de desarrollo que requiere explicaci√≥n completa. El modelo eval√∫a seg√∫n puntos clave.
                    </p>
                    <div className="config-control">
                      <label>Cantidad:</label>
                      <input
                        type="number"
                        min="0"
                        max="10"
                        value={numOpenQuestion}
                        onChange={(e) => setNumOpenQuestion(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                        className="input-number"
                      />
                    </div>
                  </div>
                </details>

                {/* Casos de Estudio */}
                <details className="practice-type-section">
                  <summary className="practice-type-header">
                    <span className="practice-icon">üíº</span>
                    <span className="practice-title">Casos de Estudio</span>
                    <span className="practice-count">{numCasoEstudio}</span>
                  </summary>
                  <div className="practice-type-content">
                    <p className="practice-description">
                      Situaci√≥n pr√°ctica con descripci√≥n detallada. Presenta un escenario y pregunta qu√© har√≠as o c√≥mo lo resolver√≠as.
                    </p>
                    <div className="config-control">
                      <label>Cantidad:</label>
                      <input
                        type="number"
                        min="0"
                        max="5"
                        value={numCasoEstudio}
                        onChange={(e) => setNumCasoEstudio(Math.max(0, Math.min(5, parseInt(e.target.value) || 0)))}
                        className="input-number"
                      />
                    </div>
                    <div className="config-control" style={{marginTop: '10px'}}>
                      <label htmlFor="tipo-caso">Tipo de Caso:</label>
                      <select 
                        id="tipo-caso"
                        value={tipoCasoEstudio}
                        onChange={(e) => setTipoCasoEstudio(e.target.value)}
                        style={{
                          padding: '8px 12px',
                          borderRadius: '6px',
                          border: '1px solid #ccc',
                          fontSize: '14px',
                          cursor: 'pointer',
                          width: '100%',
                          marginTop: '5px'
                        }}
                      >
                        <option value="descriptivo">1. Descriptivo - Describe qu√© pas√≥</option>
                        <option value="analitico">2. Anal√≠tico - Causas, relaciones y consecuencias</option>
                        <option value="resolucion">3. Resoluci√≥n de Problemas - Apaga el incendio</option>
                        <option value="decision">4. Toma de Decisiones - Elige y justifica</option>
                        <option value="comparativo">5. Comparativo - Compara alternativas</option>
                        <option value="predictivo">6. Predictivo - Proyecta el futuro</option>
                        <option value="simulacion">7. Simulaci√≥n - Mundo con variables din√°micas</option>
                        <option value="inverso">8. Inverso - Reconstruye el proceso</option>
                        <option value="fallo">9. Fallo/Desastre - Qu√© sali√≥ mal</option>
                        <option value="creativo">10. Creativo - Innovaci√≥n sin respuesta √∫nica</option>
                        <option value="etico">11. √âtico - Negocio vs Moral</option>
                        <option value="tecnico">12. T√©cnico-Operativo - Optimiza el sistema</option>
                      </select>
                    </div>
                  </div>
                </details>

                {/* ========== PR√ÅCTICAS DE INGL√âS ========== */}
                <details className="practice-type-section" style={{borderLeft: '4px solid #4A90E2'}}>
                  <summary className="practice-type-header" style={{background: '#667eea', color: 'white'}}>
                    <span className="practice-icon">üá¨üáß</span>
                    <span className="practice-title">Pr√°cticas de Ingl√©s (Reading + Writing)</span>
                    <span className="practice-count">
                      {numReadingComprehension + numReadingTrueFalse + numReadingCloze + numReadingSkill + numReadingMatching + numReadingSequence + numWritingShort + numWritingParaphrase + numWritingCorrection + numWritingTransformation + numWritingEssay + numWritingSentenceBuilder + numWritingPictureDescription + numWritingEmail}
                    </span>
                  </summary>
                  <div className="practice-type-content">
                    
                    {/* Reading Comprehension */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üìñ</span>
                        <span className="practice-title">Reading Comprehension</span>
                        <span className="practice-count">{numReadingComprehension}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Texto en ingl√©s (100-200 palabras) + 3-5 preguntas (MCQ, V/F, respuesta corta).
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numReadingComprehension}
                            onChange={(e) => setNumReadingComprehension(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Reading True/False */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">‚úì‚úó</span>
                        <span className="practice-title">Reading True/False + Justification</span>
                        <span className="practice-count">{numReadingTrueFalse}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Texto + afirmaciones. Usuario debe responder verdadero/falso y justificar con evidencia del texto.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numReadingTrueFalse}
                            onChange={(e) => setNumReadingTrueFalse(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Reading Cloze */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üìù</span>
                        <span className="practice-title">Reading Cloze (Fill Gaps)</span>
                        <span className="practice-count">{numReadingCloze}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Texto con huecos. Eval√∫a vocabulario y gram√°tica en contexto.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numReadingCloze}
                            onChange={(e) => setNumReadingCloze(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Reading Skill */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üéØ</span>
                        <span className="practice-title">Reading Skills (Main Idea/Inference)</span>
                        <span className="practice-count">{numReadingSkill}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Eval√∫a habilidades espec√≠ficas: idea principal, detalles, inferencia, prop√≥sito, tono.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numReadingSkill}
                            onChange={(e) => setNumReadingSkill(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Reading Matching */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üîó</span>
                        <span className="practice-title">Reading Matching</span>
                        <span className="practice-count">{numReadingMatching}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Relacionar oraciones con p√°rrafos del texto. Eval√∫a comprensi√≥n detallada.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numReadingMatching}
                            onChange={(e) => setNumReadingMatching(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Reading Sequence */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üî¢</span>
                        <span className="practice-title">Reading Sequence</span>
                        <span className="practice-count">{numReadingSequence}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Ordenar eventos/p√°rrafos en secuencia l√≥gica. Ideal para narrativas.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numReadingSequence}
                            onChange={(e) => setNumReadingSequence(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Writing Short Answer */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">‚úçÔ∏è</span>
                        <span className="practice-title">Writing Short Answer</span>
                        <span className="practice-count">{numWritingShort}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Respuesta breve (30-50 palabras). Eval√∫a keywords, gram√°tica, coherencia.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numWritingShort}
                            onChange={(e) => setNumWritingShort(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Writing Paraphrase */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üîÑ</span>
                        <span className="practice-title">Writing Paraphrase</span>
                        <span className="practice-count">{numWritingParaphrase}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Reformular texto preservando significado. Eval√∫a vocabulario y estructura.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numWritingParaphrase}
                            onChange={(e) => setNumWritingParaphrase(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Writing Correction */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üîß</span>
                        <span className="practice-title">Writing Error Correction</span>
                        <span className="practice-count">{numWritingCorrection}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Corregir texto con errores gramaticales. Identifica tipo y cantidad de errores.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numWritingCorrection}
                            onChange={(e) => setNumWritingCorrection(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Writing Transformation */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üé≠</span>
                        <span className="practice-title">Writing Transformation</span>
                        <span className="practice-count">{numWritingTransformation}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Transformar oraciones (tiempo verbal, voz, negativa/pregunta). Gram√°tica aplicada.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numWritingTransformation}
                            onChange={(e) => setNumWritingTransformation(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Writing Essay */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üìÑ</span>
                        <span className="practice-title">Writing Mini-Essay</span>
                        <span className="practice-count">{numWritingEssay}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Ensayo breve (120-150 palabras). Eval√∫a estructura, coherencia, vocabulario, gram√°tica.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="5"
                            value={numWritingEssay}
                            onChange={(e) => setNumWritingEssay(Math.max(0, Math.min(5, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Writing Sentence Builder */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üß©</span>
                        <span className="practice-title">Writing Sentence Builder</span>
                        <span className="practice-count">{numWritingSentenceBuilder}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Armar oraciones con bloques dados. Eval√∫a estructura y sintaxis.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numWritingSentenceBuilder}
                            onChange={(e) => setNumWritingSentenceBuilder(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Writing Picture Description */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üñºÔ∏è</span>
                        <span className="practice-title">Writing Picture Description</span>
                        <span className="practice-count">{numWritingPictureDescription}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Describir escena imaginada (80-100 palabras). Eval√∫a lenguaje descriptivo y vocabulario.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numWritingPictureDescription}
                            onChange={(e) => setNumWritingPictureDescription(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                    {/* Writing Email */}
                    <details className="practice-type-section">
                      <summary className="practice-type-header">
                        <span className="practice-icon">üìß</span>
                        <span className="practice-title">Writing Email/Message</span>
                        <span className="practice-count">{numWritingEmail}</span>
                      </summary>
                      <div className="practice-type-content">
                        <p className="practice-description">
                          Email formal/informal (60-80 palabras). Eval√∫a formato, tono, claridad, cortes√≠a.
                        </p>
                        <div className="config-control">
                          <label>Cantidad:</label>
                          <input
                            type="number"
                            min="0"
                            max="10"
                            value={numWritingEmail}
                            onChange={(e) => setNumWritingEmail(Math.max(0, Math.min(10, parseInt(e.target.value) || 0)))}
                            className="input-number"
                          />
                        </div>
                      </div>
                    </details>

                  </div>
                </details>

                {/* Prompt personalizado */}
                <div className="config-section" style={{marginTop: '1.5rem'}}>
                  <label className="config-label">
                    <span className="label-icon">‚ú®</span>
                    <span>Prompt personalizado (opcional)</span>
                  </label>
                  <textarea
                    value={promptPractica}
                    onChange={(e) => setPromptPractica(e.target.value)}
                    rows={4}
                    className="textarea-prompt"
                    placeholder="Ejemplo: Enf√≥cate en conceptos pr√°cticos, incluye ejemplos de c√≥digo, usa un nivel intermedio..."
                  />
                  <p className="config-hint">Personaliza el enfoque y dificultad de las preguntas</p>
                </div>

                {/* Resumen */}
                <div className="config-info">
                  <div className="info-icon">‚ÑπÔ∏è</div>
                  <div className="info-content">
                    <p><strong>Total:</strong> {numFlashcards + numMCQ + numVerdaderoFalso + numCloze + numRespuestaCorta + numOpenQuestion + numCasoEstudio + numReadingComprehension + numReadingTrueFalse + numReadingCloze + numReadingSkill + numReadingMatching + numReadingSequence + numWritingShort + numWritingParaphrase + numWritingCorrection + numWritingTransformation + numWritingEssay + numWritingSentenceBuilder + numWritingPictureDescription + numWritingEmail} preguntas</p>
                    <p><strong>Fuente:</strong> {tipoFuentePractica === 'documento' ? 'Documento' : 'Carpeta + subcarpetas'}</p>
                    <p><strong>Carpeta:</strong> {carpetaPractica || 'Ra√≠z'}</p>
                  </div>
                </div>
              </div>

              <div className="modal-footer">
                <button 
                  onClick={() => setModalPracticaAbierto(false)} 
                  className="btn-cancelar"
                >
                  Cancelar
                </button>
                <button 
                  onClick={confirmarGenerarPractica} 
                  className="btn-primary"
                  disabled={numFlashcards + numMCQ + numVerdaderoFalso + numCloze + numRespuestaCorta + numOpenQuestion + numCasoEstudio + numReadingComprehension + numReadingTrueFalse + numReadingCloze + numReadingSkill + numReadingMatching + numReadingSequence + numWritingShort + numWritingParaphrase + numWritingCorrection + numWritingTransformation + numWritingEssay + numWritingSentenceBuilder + numWritingPictureDescription + numWritingEmail === 0}
                >
                  üöÄ Generar Pr√°ctica
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal del Editor de Notas con HTML Editor */}
        {editorNotaAbierto && (
          <div 
            className="modal-overlay modal-fullscreen" 
            onClick={cerrarEditorNota}
          >
            <div 
              className="modal-content modal-editor-nota modal-editor-fullscreen" 
              onClick={(e) => e.stopPropagation()}
            >
              <div className="modal-header">
                <h2>üìù {modoSoloLectura ? 'Ver Nota' : (notaActual ? 'Editar Nota' : 'Nueva Nota')}</h2>
                <div style={{display: 'flex', gap: '0.5rem', alignItems: 'center'}}>
                  {modoSoloLectura && (
                    <button 
                      onClick={() => setModoSoloLectura(false)} 
                      className="btn-primary"
                      style={{padding: '0.5rem 1rem'}}
                    >
                      ‚úèÔ∏è Editar
                    </button>
                  )}
                  <button onClick={cerrarEditorNota} className="btn-close">‚úï</button>
                </div>
              </div>
              
              <div className="modal-body">
                <div className="form-group">
                  <label className="form-label">
                    <span className="label-icon">‚úçÔ∏è</span>
                    <span>T√≠tulo</span>
                  </label>
                  <input
                    type="text"
                    value={tituloNota}
                    onChange={(e) => setTituloNota(e.target.value)}
                    placeholder="T√≠tulo de la nota..."
                    className="input-nota-titulo"
                    readOnly={modoSoloLectura}
                    style={modoSoloLectura ? {backgroundColor: '#f5f5f5', cursor: 'not-allowed'} : {}}
                  />
                </div>

                <div className="form-group">
                  <label className="form-label">
                    <span className="label-icon">üìÅ</span>
                    <span>Carpeta</span>
                  </label>
                  <div style={{display: 'flex', gap: '0.5rem'}}>
                    <input
                      type="text"
                      value={carpetaNota || 'Ra√≠z'}
                      readOnly
                      placeholder="Carpeta de destino"
                      className="input-nota-carpeta"
                      style={{ backgroundColor: '#f5f5f5', cursor: 'not-allowed', flex: 1 }}
                    />
                    <button
                      type="button"
                      onClick={() => {
                        setModalCarpetasNotaAbierto(true)
                        // Iniciar desde la carpeta actual m√°s relevante
                        const carpetaInicial = carpetaNota || 
                                              cursoActual?.carpeta_trabajo || 
                                              rutaContenidoActual || 
                                              rutaNotasActual || 
                                              '';
                        cargarCarpetasNotas(carpetaInicial)
                      }}
                      className="btn-primary"
                      style={{whiteSpace: 'nowrap'}}
                    >
                      üìÇ Seleccionar
                    </button>
                  </div>
                  <div className="nota-hint">
                    üí° La nota se guardar√° en: {carpetaNota || 'Ra√≠z'}
                  </div>
                </div>

                <div className="form-group">
                  <label className="form-label">
                    <span className="label-icon">üìÑ</span>
                    <span>Contenido</span>
                  </label>
                  
                  {!modoSoloLectura && (
                  <div className="editor-toolbar">
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('bold', false, null);
                    }} title="Negrita">
                      <strong>B</strong>
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('italic', false, null);
                    }} title="Cursiva">
                      <em>I</em>
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('underline', false, null);
                    }} title="Subrayado">
                      <u>U</u>
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('strikeThrough', false, null);
                    }} title="Tachado">
                      <s>S</s>
                    </button>
                    
                    <span style={{borderLeft: '1px solid #555', margin: '0 0.5rem'}}></span>
                    
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('formatBlock', false, 'p');
                    }} title="P√°rrafo normal">
                      P
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('formatBlock', false, 'h1');
                    }} title="T√≠tulo 1">
                      H1
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('formatBlock', false, 'h2');
                    }} title="T√≠tulo 2">
                      H2
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('formatBlock', false, 'h3');
                    }} title="T√≠tulo 3">
                      H3
                    </button>
                    
                    <span style={{borderLeft: '1px solid #555', margin: '0 0.5rem'}}></span>
                    
                    <label className="btn-toolbar" title="Color de texto" style={{cursor: 'pointer', display: 'inline-flex', alignItems: 'center'}}>
                      üé® Color
                      <input
                        type="color"
                        onChange={(e) => {
                          e.stopPropagation();
                          editorRef.current?.focus();
                          const color = e.target.value;
                          document.execCommand('styleWithCSS', false, true);
                          document.execCommand('foreColor', false, color);
                        }}
                        onClick={(e) => e.stopPropagation()}
                        style={{width: '0px', height: '0px', opacity: 0, position: 'absolute'}}
                      />
                    </label>
                    <label className="btn-toolbar" title="Color de fondo" style={{cursor: 'pointer', display: 'inline-flex', alignItems: 'center'}}>
                      üñçÔ∏è Fondo
                      <input
                        type="color"
                        onChange={(e) => {
                          e.stopPropagation();
                          editorRef.current?.focus();
                          const color = e.target.value;
                          document.execCommand('styleWithCSS', false, true);
                          document.execCommand('backColor', false, color);
                        }}
                        onClick={(e) => e.stopPropagation()}
                        style={{width: '0px', height: '0px', opacity: 0, position: 'absolute'}}
                      />
                    </label>
                    
                    <span style={{borderLeft: '1px solid #555', margin: '0 0.5rem'}}></span>
                    
                    <button 
                      type="button" 
                      className="btn-toolbar" 
                      onClick={() => setModalTipografias(true)}
                      title="Administrar tipograf√≠as"
                    >
                      üî§ Fuentes
                    </button>
                    
                    <span style={{borderLeft: '1px solid #555', margin: '0 0.5rem'}}></span>
                    
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('insertUnorderedList', false, null);
                    }} title="Lista con vi√±etas">
                      ‚Ä¢ Lista
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('insertOrderedList', false, null);
                    }} title="Lista numerada">
                      1. Numerada
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('indent', false, null);
                    }} title="Aumentar sangr√≠a">
                      ‚û°Ô∏è Sangr√≠a
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('outdent', false, null);
                    }} title="Reducir sangr√≠a">
                      ‚¨ÖÔ∏è Reducir
                    </button>
                    
                    <span style={{borderLeft: '1px solid #555', margin: '0 0.5rem'}}></span>
                    
                    <button type="button" className="btn-toolbar" onClick={() => {
                      const selection = window.getSelection();
                      const selectedText = selection.toString();
                      if (selectedText) {
                        setTextoSeleccionado(selectedText);
                        setModalHipervinculos(true);
                        setTipoHipervinculo('url');
                        setUrlHipervinculo('');
                        setNotaReferenciaId(null);
                      } else {
                        alert('‚ö†Ô∏è Selecciona texto primero para convertirlo en enlace');
                      }
                    }} title="Insertar enlace">
                      üîó Link
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      document.execCommand('unlink', false, null);
                    }} title="Quitar enlace">
                      üîó‚ùå Quitar Link
                    </button>
                    <label className="btn-toolbar" title="Insertar imagen" style={{cursor: 'pointer', display: 'inline-flex', alignItems: 'center'}}>
                      üñºÔ∏è Imagen
                      <input
                        type="file"
                        accept="image/*"
                        onChange={(e) => {
                          e.stopPropagation();
                          const file = e.target.files[0];
                          if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                              if (editorRef.current) {
                                // Asegurar foco en el editor
                                editorRef.current.focus();
                                
                                const imgId = 'img_' + Date.now();
                                const imgHtml = `<div class="imagen-contenedor" contenteditable="false" style="margin: 1rem 0; position: relative; display: block; max-width: 100%;" draggable="true">
                                  <img 
                                    id="${imgId}"
                                    src="${event.target.result}" 
                                    class="imagen-editable" 
                                    style="max-width: 100%; width: 400px; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: block; cursor: move;" 
                                    alt="Imagen insertada" 
                                    draggable="false"
                                  />
                                </div><p><br></p>`;
                                
                                // Insertar en posici√≥n del cursor
                                document.execCommand('insertHTML', false, imgHtml);
                                setContenidoNota(editorRef.current.innerHTML);
                                
                                // Agregar eventos despu√©s de insertar
                                setTimeout(() => {
                                  const img = document.getElementById(imgId);
                                  if (img) {
                                    // Click para seleccionar
                                    img.addEventListener('click', function(e) {
                                      e.stopPropagation();
                                      window.mostrarControlesImagen(this);
                                    });
                                    
                                    // Sistema de arrastre simple y efectivo
                                    const contenedor = img.parentElement;
                                    contenedor.draggable = true;
                                    
                                    contenedor.addEventListener('dragstart', function(e) {
                                      e.dataTransfer.effectAllowed = 'move';
                                      e.dataTransfer.setData('text/html', this.outerHTML);
                                      this.classList.add('arrastrando');
                                      
                                      // Guardar referencia para eliminar despu√©s
                                      window.elementoArrastrado = this;
                                    });
                                    
                                    contenedor.addEventListener('dragend', function(e) {
                                      this.classList.remove('arrastrando');
                                      window.elementoArrastrado = null;
                                    });
                                  }
                                }, 100);
                              }
                            };
                            reader.readAsDataURL(file);
                          }
                          e.target.value = ''; // Reset input
                        }}
                        onClick={(e) => e.stopPropagation()}
                        style={{width: '0px', height: '0px', opacity: 0, position: 'absolute'}}
                      />
                    </label>
                    
                    <span style={{borderLeft: '1px solid #555', margin: '0 0.5rem'}}></span>
                    
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('justifyLeft', false, null);
                    }} title="Alinear izquierda">
                      ‚¨Ö Izquierda
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('justifyCenter', false, null);
                    }} title="Centrar">
                      ‚Üî Centro
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('justifyRight', false, null);
                    }} title="Alinear derecha">
                      ‚û° Derecha
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('justifyFull', false, null);
                    }} title="Justificar">
                      ‚¨å Justificar
                    </button>
                    <button type="button" className="btn-toolbar" onClick={() => {
                      editorRef.current?.focus();
                      document.execCommand('removeFormat', false, null);
                    }} title="Limpiar formato">
                      üßπ Limpiar
                    </button>
                  </div>
                  )}
                  
                  <div
                    ref={editorRef}
                    contentEditable={!modoSoloLectura}
                    dir="ltr"
                    className="editor-html-simple"
                    onInput={(e) => {
                      if (!modoSoloLectura) {
                        setContenidoNota(e.currentTarget.innerHTML);
                      }
                    }}
                    onKeyDown={(e) => {
                      // Forzar direcci√≥n LTR al escribir
                      if (e.currentTarget) {
                        e.currentTarget.setAttribute('dir', 'ltr');
                        e.currentTarget.style.direction = 'ltr';
                        e.currentTarget.style.textAlign = 'left';
                      }
                    }}
                    onMouseUp={(e) => {
                      if (modoSoloLectura) return;
                      const selection = window.getSelection();
                      const selectedText = selection.toString();
                      
                      if (selectedText.length > 0) {
                        const range = selection.getRangeAt(0);
                        setRangoSeleccionado(range.cloneRange());
                        
                        const rect = range.getBoundingClientRect();
                        setMenuContextual({
                          visible: true,
                          x: rect.left + (rect.width / 2),
                          y: rect.top - 10
                        });
                      } else {
                        setMenuContextual({ visible: false, x: 0, y: 0 });
                      }
                    }}
                    onDragOver={(e) => {
                      e.preventDefault();
                      e.dataTransfer.dropEffect = 'move';
                      e.currentTarget.classList.add('drag-over');
                    }}
                    onDragLeave={(e) => {
                      e.currentTarget.classList.remove('drag-over');
                    }}
                    onDrop={(e) => {
                      e.preventDefault();
                      e.currentTarget.classList.remove('drag-over');
                      
                      // Si estamos moviendo una imagen existente
                      if (window.elementoArrastrado) {
                        // Obtener posici√≥n del cursor
                        const range = document.caretRangeFromPoint(e.clientX, e.clientY);
                        
                        if (range && editorRef.current.contains(range.startContainer)) {
                          // Eliminar elemento del lugar original
                          const elemento = window.elementoArrastrado.cloneNode(true);
                          window.elementoArrastrado.remove();
                          
                          // Insertar en nueva posici√≥n
                          range.insertNode(elemento);
                          
                          // Actualizar contenido
                          setContenidoNota(editorRef.current.innerHTML);
                          
                          // Reconfigurar eventos
                          setTimeout(() => {
                            const img = elemento.querySelector('img');
                            if (img) {
                              img.addEventListener('click', function(e) {
                                e.stopPropagation();
                                window.mostrarControlesImagen(this);
                              });
                            }
                          }, 100);
                        }
                      }
                    }}
                    suppressContentEditableWarning={true}
                    style={{
                      direction: 'ltr',
                      textAlign: 'left',
                      backgroundColor: '#ffffff',
                      color: '#000000',
                      writingMode: 'horizontal-tb',
                      unicodeBidi: 'bidi-override'
                    }}
                  />
                  
                  <div className="nota-hint">
                    üí° Editor HTML completo: selecciona texto y usa los botones para formato, colores, im√°genes y m√°s
                  </div>
                </div>
              </div>

              <div className="modal-footer">
                <button 
                  onClick={cerrarEditorNota} 
                  className="btn-cancelar"
                >
                  {modoSoloLectura ? 'Cerrar' : 'Cancelar'}
                </button>
                {!modoSoloLectura && (
                  <button 
                    onClick={guardarNota} 
                    className="btn-primary"
                  >
                    üíæ Guardar Nota
                  </button>
                )}
              </div>
            </div>
            
            {/* Men√∫ Contextual Flotante */}
            {menuContextual.visible && !modoSoloLectura && (
              <div 
                className="menu-contextual-flotante"
                style={{
                  position: 'fixed',
                  left: `${menuContextual.x}px`,
                  top: `${menuContextual.y}px`,
                  transform: 'translate(-50%, -100%)'
                }}
              >
                {/* Barra de arrastre */}
                <div 
                  onMouseDown={iniciarArrastreMenu}
                  style={{
                    background: 'rgba(100, 108, 255, 0.2)',
                    padding: '0.3rem',
                    marginBottom: '0.3rem',
                    borderRadius: '6px 6px 0 0',
                    cursor: 'move',
                    textAlign: 'center',
                    fontSize: '0.7rem',
                    color: 'rgba(255,255,255,0.6)',
                    userSelect: 'none',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                  }}
                >
                  <span style={{opacity: 0}}>‚úï</span>
                  <span>‚ãÆ‚ãÆ‚ãÆ</span>
                  <button 
                    onClick={cerrarMenuContextual}
                    style={{
                      background: 'transparent',
                      border: 'none',
                      color: 'rgba(255,255,255,0.8)',
                      cursor: 'pointer',
                      fontSize: '1rem',
                      padding: '0 0.3rem',
                      lineHeight: '1'
                    }}
                    title="Cerrar"
                  >
                    ‚úï
                  </button>
                </div>
                <div className="menu-fila">
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('bold', false, null);
                    }}
                    title="Negrita"
                  >
                    <strong>B</strong>
                  </button>
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('italic', false, null);
                    }}
                    title="Cursiva"
                  >
                    <em>I</em>
                  </button>
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('underline', false, null);
                    }}
                    title="Subrayado"
                  >
                    <u>U</u>
                  </button>
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('strikeThrough', false, null);
                    }}
                    title="Tachado"
                  >
                    <s>S</s>
                  </button>
                  
                  <div className="separador-menu"></div>
                  
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('formatBlock', false, 'p');
                    }}
                    title="P√°rrafo"
                  >
                    P
                  </button>
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('formatBlock', false, 'h1');
                    }}
                    title="T√≠tulo 1"
                  >
                    H1
                  </button>
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('formatBlock', false, 'h2');
                    }}
                    title="T√≠tulo 2"
                  >
                    H2
                  </button>
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('formatBlock', false, 'h3');
                    }}
                    title="T√≠tulo 3"
                  >
                    H3
                  </button>
                </div>
                
                <div className="menu-fila">
                  <label className="btn-menu-ctx" title="Color de texto">
                    üé®
                    <input
                      type="color"
                      onChange={(e) => {
                        restaurarSeleccion();
                        document.execCommand('styleWithCSS', false, true);
                        document.execCommand('foreColor', false, e.target.value);
                      }}
                      style={{width: '0px', height: '0px', opacity: 0, position: 'absolute'}}
                    />
                  </label>
                  <label className="btn-menu-ctx" title="Color de fondo">
                    üñçÔ∏è
                    <input
                      type="color"
                      onChange={(e) => {
                        restaurarSeleccion();
                        document.execCommand('styleWithCSS', false, true);
                        document.execCommand('backColor', false, e.target.value);
                      }}
                      style={{width: '0px', height: '0px', opacity: 0, position: 'absolute'}}
                    />
                  </label>
                  
                  <div className="separador-menu"></div>
                  
                  <button 
                    className="btn-menu-ctx" 
                    onClick={() => setSubmenuActivo(submenuActivo === 'tipografias' ? null : 'tipografias')} 
                    title="Cambiar tipograf√≠a"
                    style={{background: submenuActivo === 'tipografias' ? 'rgba(100, 108, 255, 0.4)' : 'rgba(100, 108, 255, 0.15)'}}
                  >
                    üî§
                  </button>
                  <button 
                    className="btn-menu-ctx" 
                    onClick={() => setSubmenuActivo(submenuActivo === 'enlaces' ? null : 'enlaces')} 
                    title="Insertar enlace"
                    style={{background: submenuActivo === 'enlaces' ? 'rgba(100, 108, 255, 0.4)' : 'rgba(100, 108, 255, 0.15)'}}
                  >
                    üîó
                  </button>
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('unlink', false, null);
                    }}
                    title="Quitar enlace"
                  >
                    üö´
                  </button>
                  
                  <div className="separador-menu"></div>
                  
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('justifyLeft', false, null);
                    }}
                    title="Alinear izquierda"
                  >
                    ‚¨ÖÔ∏è
                  </button>
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('justifyCenter', false, null);
                    }}
                    title="Centrar"
                  >
                    ‚ÜîÔ∏è
                  </button>
                  <button
                    className="btn-menu-ctx"
                    onClick={() => {
                      restaurarSeleccion();
                      document.execCommand('justifyRight', false, null);
                    }}
                    title="Alinear derecha"
                  >
                    ‚û°Ô∏è
                  </button>
                </div>
                
                {/* Submen√∫ de tipograf√≠as */}
                {submenuActivo === 'tipografias' && (
                  <div style={{
                    background: 'rgba(26, 26, 46, 0.98)',
                    border: '1px solid rgba(100, 108, 255, 0.3)',
                    borderRadius: '8px',
                    padding: '0.5rem',
                    marginTop: '0.3rem',
                    maxHeight: '200px',
                    overflowY: 'auto'
                  }}>
                    <div style={{marginBottom: '0.5rem', color: 'rgba(255,255,255,0.7)', fontSize: '0.8rem'}}>Sistema:</div>
                    {['Arial', 'Georgia', 'Times New Roman', 'Courier New', 'Verdana', 'Trebuchet MS', 'Comic Sans MS', 'Impact'].map(fuente => (
                      <button
                        key={fuente}
                        onClick={() => { aplicarTipografia(fuente + ', sans-serif'); setSubmenuActivo(null); }}
                        style={{
                          display: 'block',
                          width: '100%',
                          background: 'rgba(100, 108, 255, 0.1)',
                          border: '1px solid rgba(100, 108, 255, 0.2)',
                          borderRadius: '4px',
                          color: 'white',
                          padding: '0.5rem',
                          marginBottom: '0.3rem',
                          cursor: 'pointer',
                          textAlign: 'left',
                          fontFamily: fuente,
                          transition: 'all 0.15s'
                        }}
                        onMouseEnter={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.3)'}
                        onMouseLeave={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.1)'}
                      >
                        {fuente}
                      </button>
                    ))}
                    {tipografiasPersonalizadas.length > 0 && (
                      <>
                        <div style={{marginTop: '0.5rem', marginBottom: '0.5rem', color: 'rgba(255,255,255,0.7)', fontSize: '0.8rem'}}>Personalizadas:</div>
                        {tipografiasPersonalizadas.map(tipo => (
                          <button
                            key={tipo.id}
                            onClick={() => { aplicarTipografia(tipo.familia); setSubmenuActivo(null); }}
                            style={{
                              display: 'block',
                              width: '100%',
                              background: 'rgba(34, 197, 94, 0.1)',
                              border: '1px solid rgba(34, 197, 94, 0.2)',
                              borderRadius: '4px',
                              color: 'white',
                              padding: '0.5rem',
                              marginBottom: '0.3rem',
                              cursor: 'pointer',
                              textAlign: 'left',
                              fontFamily: tipo.familia,
                              transition: 'all 0.15s'
                            }}
                            onMouseEnter={(e) => e.target.style.background = 'rgba(34, 197, 94, 0.3)'}
                            onMouseLeave={(e) => e.target.style.background = 'rgba(34, 197, 94, 0.1)'}
                          >
                            {tipo.nombre}
                          </button>
                        ))}
                      </>
                    )}
                  </div>
                )}
                
                {/* Submen√∫ de enlaces */}
                {submenuActivo === 'enlaces' && (
                  <div style={{
                    background: 'rgba(26, 26, 46, 0.98)',
                    border: '1px solid rgba(100, 108, 255, 0.3)',
                    borderRadius: '8px',
                    padding: '0.5rem',
                    marginTop: '0.3rem'
                  }}>
                    <button
                      onClick={insertarEnlaceURL}
                      style={{
                        display: 'block',
                        width: '100%',
                        background: 'rgba(100, 108, 255, 0.2)',
                        border: '1px solid rgba(100, 108, 255, 0.3)',
                        borderRadius: '4px',
                        color: 'white',
                        padding: '0.6rem',
                        marginBottom: '0.5rem',
                        cursor: 'pointer',
                        textAlign: 'left',
                        fontWeight: 'bold',
                        transition: 'all 0.15s'
                      }}
                      onMouseEnter={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.4)'}
                      onMouseLeave={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.2)'}
                    >
                      üåê Enlace externo (URL)
                    </button>
                    <button
                      onClick={abrirModalSeleccionarNotaRef}
                      style={{
                        display: 'block',
                        width: '100%',
                        background: 'rgba(34, 197, 94, 0.2)',
                        border: '1px solid rgba(34, 197, 94, 0.3)',
                        borderRadius: '4px',
                        color: 'white',
                        padding: '0.6rem',
                        cursor: 'pointer',
                        textAlign: 'left',
                        fontWeight: 'bold',
                        transition: 'all 0.15s'
                      }}
                      onMouseEnter={(e) => e.target.style.background = 'rgba(34, 197, 94, 0.4)'}
                      onMouseLeave={(e) => e.target.style.background = 'rgba(34, 197, 94, 0.2)'}
                    >
                      üìù Referencia a nota...
                    </button>
                  </div>
                )}
                
                <div className="menu-fila">
                  <label className="btn-menu-ctx-wide" title="Insertar imagen">
                    üñºÔ∏è Insertar Imagen
                    <input
                      type="file"
                      accept="image/*"
                      onChange={(e) => {
                        const file = e.target.files[0];
                        if (file) {
                          const reader = new FileReader();
                          reader.onload = (event) => {
                            restaurarSeleccion();
                            const imgId = 'img_' + Date.now();
                            const imgHtml = `<div class="imagen-contenedor" contenteditable="false" style="margin: 1rem 0; position: relative; display: block; max-width: 100%;" draggable="true">
                              <img 
                                id="${imgId}"
                                src="${event.target.result}" 
                                class="imagen-editable" 
                                style="max-width: 100%; width: 400px; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: block; cursor: move;" 
                                alt="Imagen insertada" 
                                draggable="false"
                              />
                            </div><p><br></p>`;
                            document.execCommand('insertHTML', false, imgHtml);
                            setContenidoNota(editorRef.current.innerHTML);
                            
                            setTimeout(() => {
                              const img = document.getElementById(imgId);
                              if (img) {
                                img.addEventListener('click', function(e) {
                                  e.stopPropagation();
                                  window.mostrarControlesImagen(this);
                                });
                                
                                const contenedor = img.parentElement;
                                contenedor.draggable = true;
                                contenedor.addEventListener('dragstart', function(e) {
                                  e.dataTransfer.effectAllowed = 'move';
                                  e.dataTransfer.setData('text/html', this.outerHTML);
                                  this.classList.add('arrastrando');
                                  window.elementoArrastrado = this;
                                });
                                contenedor.addEventListener('dragend', function(e) {
                                  this.classList.remove('arrastrando');
                                  window.elementoArrastrado = null;
                                });
                              }
                            }, 100);
                            
                            cerrarMenuContextual();
                          };
                          reader.readAsDataURL(file);
                        }
                        e.target.value = '';
                      }}
                      style={{width: '0px', height: '0px', opacity: 0, position: 'absolute'}}
                    />
                  </label>
                </div>
              </div>
            )}
          </div>
        )}
        
        {/* Men√∫ Contextual Flotante */}
        {menuContextual.visible && !modoSoloLectura && (
          <div 
            className="menu-contextual-flotante"
            style={{
              position: 'fixed',
              left: `${menuContextual.x}px`,
              top: `${menuContextual.y}px`,
              transform: 'translate(-50%, -100%)'
            }}
          >
            {/* Barra de arrastre */}
            <div 
              onMouseDown={iniciarArrastreMenu}
              style={{
                background: 'rgba(100, 108, 255, 0.2)',
                padding: '0.3rem',
                marginBottom: '0.3rem',
                borderRadius: '6px 6px 0 0',
                cursor: 'move',
                textAlign: 'center',
                fontSize: '0.7rem',
                color: 'rgba(255,255,255,0.6)',
                userSelect: 'none',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center'
              }}
            >
              <span style={{opacity: 0}}>‚úï</span>
              <span>‚ãÆ‚ãÆ‚ãÆ</span>
              <button 
                onClick={cerrarMenuContextual}
                style={{
                  background: 'transparent',
                  border: 'none',
                  color: 'rgba(255,255,255,0.8)',
                  cursor: 'pointer',
                  fontSize: '1rem',
                  padding: '0 0.3rem',
                  lineHeight: '1'
                }}
                title="Cerrar"
              >
                ‚úï
              </button>
            </div>
            <div className="menu-fila">
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('bold', false, null); }} title="Negrita">
                <strong>B</strong>
              </button>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('italic', false, null); }} title="Cursiva">
                <em>I</em>
              </button>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('underline', false, null); }} title="Subrayado">
                <u>U</u>
              </button>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('strikeThrough', false, null); }} title="Tachado">
                <s>S</s>
              </button>
              <div className="separador-menu"></div>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('formatBlock', false, 'p'); }} title="P√°rrafo">P</button>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('formatBlock', false, 'h1'); }} title="T√≠tulo 1">H1</button>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('formatBlock', false, 'h2'); }} title="T√≠tulo 2">H2</button>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('formatBlock', false, 'h3'); }} title="T√≠tulo 3">H3</button>
            </div>
            <div className="menu-fila">
              <label className="btn-menu-ctx" title="Color de texto">üé®<input type="color" onChange={(e) => { restaurarSeleccion(); document.execCommand('styleWithCSS', false, true); document.execCommand('foreColor', false, e.target.value); }} style={{width: '0px', height: '0px', opacity: 0, position: 'absolute'}} /></label>
              <label className="btn-menu-ctx" title="Color de fondo">üñçÔ∏è<input type="color" onChange={(e) => { restaurarSeleccion(); document.execCommand('styleWithCSS', false, true); document.execCommand('backColor', false, e.target.value); }} style={{width: '0px', height: '0px', opacity: 0, position: 'absolute'}} /></label>
              <div className="separador-menu"></div>
              <button 
                className="btn-menu-ctx" 
                onClick={() => setSubmenuActivo(submenuActivo === 'tipografias' ? null : 'tipografias')} 
                title="Cambiar tipograf√≠a"
                style={{background: submenuActivo === 'tipografias' ? 'rgba(100, 108, 255, 0.4)' : 'rgba(100, 108, 255, 0.15)'}}
              >
                üî§
              </button>
              <button 
                className="btn-menu-ctx" 
                onClick={() => setSubmenuActivo(submenuActivo === 'enlaces' ? null : 'enlaces')} 
                title="Insertar enlace"
                style={{background: submenuActivo === 'enlaces' ? 'rgba(100, 108, 255, 0.4)' : 'rgba(100, 108, 255, 0.15)'}}
              >
                üîó
              </button>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('unlink', false, null); }} title="Quitar enlace">üö´</button>
              <div className="separador-menu"></div>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('justifyLeft', false, null); }} title="Izquierda">‚¨ÖÔ∏è</button>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('justifyCenter', false, null); }} title="Centro">‚ÜîÔ∏è</button>
              <button className="btn-menu-ctx" onClick={() => { restaurarSeleccion(); document.execCommand('justifyRight', false, null); }} title="Derecha">‚û°Ô∏è</button>
            </div>
            
            {/* Submen√∫ de tipograf√≠as */}
            {submenuActivo === 'tipografias' && (
              <div style={{
                background: 'rgba(26, 26, 46, 0.98)',
                border: '1px solid rgba(100, 108, 255, 0.3)',
                borderRadius: '8px',
                padding: '0.5rem',
                marginTop: '0.3rem',
                maxHeight: '200px',
                overflowY: 'auto'
              }}>
                <div style={{marginBottom: '0.5rem', color: 'rgba(255,255,255,0.7)', fontSize: '0.8rem'}}>Sistema:</div>
                {['Arial', 'Georgia', 'Times New Roman', 'Courier New', 'Verdana', 'Trebuchet MS', 'Comic Sans MS', 'Impact'].map(fuente => (
                  <button
                    key={fuente}
                    onClick={() => { aplicarTipografia(fuente + ', sans-serif'); setSubmenuActivo(null); }}
                    style={{
                      display: 'block',
                      width: '100%',
                      background: 'rgba(100, 108, 255, 0.1)',
                      border: '1px solid rgba(100, 108, 255, 0.2)',
                      borderRadius: '4px',
                      color: 'white',
                      padding: '0.5rem',
                      marginBottom: '0.3rem',
                      cursor: 'pointer',
                      textAlign: 'left',
                      fontFamily: fuente,
                      transition: 'all 0.15s'
                    }}
                    onMouseEnter={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.3)'}
                    onMouseLeave={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.1)'}
                  >
                    {fuente}
                  </button>
                ))}
                {tipografiasPersonalizadas.length > 0 && (
                  <>
                    <div style={{marginTop: '0.5rem', marginBottom: '0.5rem', color: 'rgba(255,255,255,0.7)', fontSize: '0.8rem'}}>Personalizadas:</div>
                    {tipografiasPersonalizadas.map(tipo => (
                      <button
                        key={tipo.id}
                        onClick={() => { aplicarTipografia(tipo.familia); setSubmenuActivo(null); }}
                        style={{
                          display: 'block',
                          width: '100%',
                          background: 'rgba(34, 197, 94, 0.1)',
                          border: '1px solid rgba(34, 197, 94, 0.2)',
                          borderRadius: '4px',
                          color: 'white',
                          padding: '0.5rem',
                          marginBottom: '0.3rem',
                          cursor: 'pointer',
                          textAlign: 'left',
                          fontFamily: tipo.familia,
                          transition: 'all 0.15s'
                        }}
                        onMouseEnter={(e) => e.target.style.background = 'rgba(34, 197, 94, 0.3)'}
                        onMouseLeave={(e) => e.target.style.background = 'rgba(34, 197, 94, 0.1)'}
                      >
                        {tipo.nombre}
                      </button>
                    ))}
                  </>
                )}
              </div>
            )}
            
            {/* Submen√∫ de enlaces */}
            {submenuActivo === 'enlaces' && (
              <div style={{
                background: 'rgba(26, 26, 46, 0.98)',
                border: '1px solid rgba(100, 108, 255, 0.3)',
                borderRadius: '8px',
                padding: '0.5rem',
                marginTop: '0.3rem'
              }}>
                <button
                  onClick={insertarEnlaceURL}
                  style={{
                    display: 'block',
                    width: '100%',
                    background: 'rgba(100, 108, 255, 0.2)',
                    border: '1px solid rgba(100, 108, 255, 0.3)',
                    borderRadius: '4px',
                    color: 'white',
                    padding: '0.6rem',
                    marginBottom: '0.5rem',
                    cursor: 'pointer',
                    textAlign: 'left',
                    fontWeight: 'bold',
                    transition: 'all 0.15s'
                  }}
                  onMouseEnter={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.4)'}
                  onMouseLeave={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.2)'}
                >
                  üåê Enlace externo (URL)
                </button>
                <button
                  onClick={abrirModalSeleccionarNotaRef}
                  style={{
                    display: 'block',
                    width: '100%',
                    background: 'rgba(34, 197, 94, 0.2)',
                    border: '1px solid rgba(34, 197, 94, 0.3)',
                    borderRadius: '4px',
                    color: 'white',
                    padding: '0.6rem',
                    cursor: 'pointer',
                    textAlign: 'left',
                    fontWeight: 'bold',
                    transition: 'all 0.15s'
                  }}
                  onMouseEnter={(e) => e.target.style.background = 'rgba(34, 197, 94, 0.4)'}
                  onMouseLeave={(e) => e.target.style.background = 'rgba(34, 197, 94, 0.2)'}
                >
                  üìù Referencia a nota...
                </button>
              </div>
            )}
            
            <div className="menu-fila">
              <label className="btn-menu-ctx-wide" title="Insertar imagen">
                üñºÔ∏è Insertar Imagen
                <input type="file" accept="image/*" onChange={(e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (event) => { restaurarSeleccion(); const imgId = 'img_' + Date.now(); const imgHtml = `<div class="imagen-contenedor" contenteditable="false" style="margin: 1rem 0; position: relative; display: block;" draggable="true"><img id="${imgId}" src="${event.target.result}" class="imagen-editable" style="max-width: 100%; width: 400px; height: auto;" draggable="false" /></div><p><br></p>`; document.execCommand('insertHTML', false, imgHtml); setContenidoNota(editorRef.current.innerHTML); setTimeout(() => { const img = document.getElementById(imgId); if (img) { img.addEventListener('click', function(e) { e.stopPropagation(); window.mostrarControlesImagen(this); }); const contenedor = img.parentElement; contenedor.addEventListener('dragstart', function(e) { e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', this.outerHTML); this.classList.add('arrastrando'); window.elementoArrastrado = this; }); contenedor.addEventListener('dragend', function(e) { this.classList.remove('arrastrando'); window.elementoArrastrado = null; }); } }, 100); cerrarMenuContextual(); }; reader.readAsDataURL(file); } e.target.value = ''; }} style={{width: '0px', height: '0px', opacity: 0, position: 'absolute'}} />
              </label>
            </div>
          </div>
        )}

        {/* Modal de Tipograf√≠as Personalizadas */}
        {modalTipografias && (
          <div className="modal-overlay" onClick={() => setModalTipografias(false)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '800px'}}>
              <div className="modal-header">
                <h2>üî§ Administrar Tipograf√≠as</h2>
                <button onClick={() => setModalTipografias(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body" style={{maxHeight: '70vh', overflowY: 'auto'}}>
                {/* Tipograf√≠as del sistema */}
                <div style={{marginBottom: '2rem'}}>
                  <h3 style={{color: '#646cff', marginBottom: '1rem', fontSize: '1.1rem'}}>üìö Tipograf√≠as del Sistema</h3>
                  <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '0.8rem'}}>
                    {['Arial, sans-serif', 'Georgia, serif', 'Times New Roman, serif', 'Courier New, monospace', 'Verdana, sans-serif', 'Trebuchet MS, sans-serif', 'Comic Sans MS, cursive', 'Impact, fantasy'].map(fuente => (
                      <button
                        key={fuente}
                        onClick={() => aplicarTipografia(fuente)}
                        className="btn-tipografia"
                        style={{
                          fontFamily: fuente,
                          background: tipografiaActual === fuente ? 'rgba(100, 108, 255, 0.3)' : 'rgba(100, 108, 255, 0.1)',
                          border: tipografiaActual === fuente ? '2px solid #646cff' : '1px solid rgba(100, 108, 255, 0.3)',
                          padding: '0.8rem',
                          borderRadius: '8px',
                          cursor: 'pointer',
                          color: 'white',
                          transition: 'all 0.2s ease',
                          textAlign: 'center'
                        }}
                        onMouseEnter={(e) => {
                          if (tipografiaActual !== fuente) {
                            e.target.style.background = 'rgba(100, 108, 255, 0.2)';
                          }
                        }}
                        onMouseLeave={(e) => {
                          if (tipografiaActual !== fuente) {
                            e.target.style.background = 'rgba(100, 108, 255, 0.1)';
                          }
                        }}
                      >
                        {fuente.split(',')[0]}
                      </button>
                    ))}
                  </div>
                </div>

                {/* Tipograf√≠as personalizadas */}
                <div style={{marginBottom: '1.5rem'}}>
                  <h3 style={{color: '#22c55e', marginBottom: '1rem', fontSize: '1.1rem'}}>‚ú® Tipograf√≠as Personalizadas</h3>
                  {tipografiasPersonalizadas.length === 0 ? (
                    <p style={{color: 'rgba(255,255,255,0.6)', textAlign: 'center', padding: '2rem'}}>
                      No hay tipograf√≠as personalizadas instaladas.
                    </p>
                  ) : (
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '0.8rem'}}>
                      {tipografiasPersonalizadas.map(tipo => (
                        <div
                          key={tipo.id}
                          style={{
                            background: tipografiaActual === tipo.familia ? 'rgba(34, 197, 94, 0.2)' : 'rgba(34, 197, 94, 0.1)',
                            border: tipografiaActual === tipo.familia ? '2px solid #22c55e' : '1px solid rgba(34, 197, 94, 0.3)',
                            borderRadius: '8px',
                            padding: '0.8rem',
                            display: 'flex',
                            flexDirection: 'column',
                            gap: '0.5rem'
                          }}
                        >
                          <button
                            onClick={() => aplicarTipografia(tipo.familia)}
                            style={{
                              fontFamily: tipo.familia,
                              background: 'transparent',
                              border: 'none',
                              color: 'white',
                              cursor: 'pointer',
                              fontSize: '1rem',
                              textAlign: 'center',
                              padding: '0.5rem 0'
                            }}
                          >
                            {tipo.nombre}
                          </button>
                          <button
                            onClick={() => eliminarTipografia(tipo.id)}
                            style={{
                              background: 'rgba(255, 50, 50, 0.3)',
                              border: '1px solid rgba(255, 50, 50, 0.5)',
                              borderRadius: '4px',
                              color: 'white',
                              cursor: 'pointer',
                              padding: '0.3rem',
                              fontSize: '0.8rem',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseEnter={(e) => {
                              e.target.style.background = 'rgba(255, 50, 50, 0.6)';
                            }}
                            onMouseLeave={(e) => {
                              e.target.style.background = 'rgba(255, 50, 50, 0.3)';
                            }}
                          >
                            üóëÔ∏è Eliminar
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                {/* Cargar nueva tipograf√≠a */}
                <div style={{textAlign: 'center', padding: '1.5rem', background: 'rgba(100, 108, 255, 0.1)', borderRadius: '12px', border: '2px dashed rgba(100, 108, 255, 0.3)'}}>
                  <label style={{cursor: 'pointer', display: 'inline-block'}}>
                    <div style={{
                      background: 'linear-gradient(135deg, #646cff 0%, #4338ca 100%)',
                      color: 'white',
                      padding: '1rem 2rem',
                      borderRadius: '8px',
                      fontWeight: 'bold',
                      fontSize: '1rem',
                      transition: 'all 0.2s ease'
                    }}
                    onMouseEnter={(e) => {
                      e.target.style.transform = 'scale(1.05)';
                      e.target.style.boxShadow = '0 6px 20px rgba(100, 108, 255, 0.6)';
                    }}
                    onMouseLeave={(e) => {
                      e.target.style.transform = 'scale(1)';
                      e.target.style.boxShadow = 'none';
                    }}
                    >
                      üìÅ Cargar Tipograf√≠a (.ttf, .otf, .woff, .woff2)
                    </div>
                    <input
                      type="file"
                      accept=".ttf,.otf,.woff,.woff2"
                      onChange={cargarTipografiaPersonalizada}
                      style={{display: 'none'}}
                    />
                  </label>
                  <p style={{marginTop: '1rem', fontSize: '0.9rem', color: 'rgba(255,255,255,0.6)'}}>
                    Sube archivos de fuentes en formato TTF, OTF, WOFF o WOFF2
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Selecci√≥n de Nota para Referencia */}
        {modalSeleccionarNotaRef && (
          <div className="modal-overlay" onClick={() => setModalSeleccionarNotaRef(false)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{maxWidth: '700px'}}>
              <div className="modal-header">
                <h2>üìù Seleccionar Nota para Referencia</h2>
                <button onClick={() => setModalSeleccionarNotaRef(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                {/* Breadcrumb de navegaci√≥n */}
                <div style={{
                  padding: '0.8rem',
                  background: 'rgba(100, 108, 255, 0.1)',
                  borderRadius: '8px',
                  marginBottom: '1rem',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem',
                  flexWrap: 'wrap'
                }}>
                  <button
                    onClick={() => cargarCarpetasModalNotaRef('')}
                    style={{
                      background: 'rgba(100, 108, 255, 0.2)',
                      border: '1px solid rgba(100, 108, 255, 0.3)',
                      borderRadius: '4px',
                      color: 'white',
                      padding: '0.4rem 0.8rem',
                      cursor: 'pointer',
                      fontSize: '0.9rem',
                      transition: 'all 0.2s'
                    }}
                    onMouseEnter={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.4)'}
                    onMouseLeave={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.2)'}
                  >
                    üè† Ra√≠z
                  </button>
                  {rutaModalNotaRef && rutaModalNotaRef.split('/').filter(Boolean).map((carpeta, index, arr) => {
                    const rutaParcial = arr.slice(0, index + 1).join('/');
                    return (
                      <React.Fragment key={rutaParcial}>
                        <span style={{color: 'rgba(255,255,255,0.5)'}}>‚Ä∫</span>
                        <button
                          onClick={() => cargarCarpetasModalNotaRef(rutaParcial)}
                          style={{
                            background: 'rgba(100, 108, 255, 0.2)',
                            border: '1px solid rgba(100, 108, 255, 0.3)',
                            borderRadius: '4px',
                            color: 'white',
                            padding: '0.4rem 0.8rem',
                            cursor: 'pointer',
                            fontSize: '0.9rem',
                            transition: 'all 0.2s'
                          }}
                          onMouseEnter={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.4)'}
                          onMouseLeave={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.2)'}
                        >
                          üìÅ {carpeta}
                        </button>
                      </React.Fragment>
                    );
                  })}
                  {rutaModalNotaRef && (
                    <>
                      <span style={{color: 'rgba(255,255,255,0.5)', marginLeft: 'auto'}}>|</span>
                      <button
                        onClick={() => {
                          const partes = rutaModalNotaRef.split('/').filter(Boolean);
                          partes.pop();
                          const rutaPadre = partes.join('/');
                          cargarCarpetasModalNotaRef(rutaPadre);
                        }}
                        style={{
                          background: 'rgba(100, 108, 255, 0.3)',
                          border: '1px solid rgba(100, 108, 255, 0.4)',
                          borderRadius: '4px',
                          color: 'white',
                          padding: '0.4rem 0.8rem',
                          cursor: 'pointer',
                          fontSize: '0.9rem',
                          fontWeight: 'bold',
                          transition: 'all 0.2s'
                        }}
                        onMouseEnter={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.5)'}
                        onMouseLeave={(e) => e.target.style.background = 'rgba(100, 108, 255, 0.3)'}
                      >
                        ‚¨ÖÔ∏è Atr√°s
                      </button>
                    </>
                  )}
                </div>

                {/* Carpetas */}
                {carpetasModalNotaRef.length > 0 && (
                  <div style={{marginBottom: '1.5rem'}}>
                    <h3 style={{color: '#646cff', marginBottom: '0.8rem', fontSize: '1rem'}}>üìÅ Carpetas</h3>
                    <div style={{display: 'grid', gap: '0.5rem'}}>
                      {carpetasModalNotaRef.map(carpeta => (
                        <button
                          key={carpeta}
                          onClick={() => cargarCarpetasModalNotaRef(rutaModalNotaRef ? `${rutaModalNotaRef}/${carpeta}` : carpeta)}
                          style={{
                            background: 'rgba(100, 108, 255, 0.1)',
                            border: '1px solid rgba(100, 108, 255, 0.3)',
                            borderRadius: '8px',
                            padding: '0.8rem 1rem',
                            color: 'white',
                            cursor: 'pointer',
                            textAlign: 'left',
                            fontSize: '0.95rem',
                            transition: 'all 0.2s',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '0.5rem'
                          }}
                          onMouseEnter={(e) => {
                            e.target.style.background = 'rgba(100, 108, 255, 0.3)';
                            e.target.style.transform = 'translateX(5px)';
                          }}
                          onMouseLeave={(e) => {
                            e.target.style.background = 'rgba(100, 108, 255, 0.1)';
                            e.target.style.transform = 'translateX(0)';
                          }}
                        >
                          üìÅ {carpeta}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Notas en la carpeta actual */}
                <div>
                  <h3 style={{color: '#22c55e', marginBottom: '0.8rem', fontSize: '1rem'}}>üìù Notas</h3>
                  {(notasGuardadas || []).filter(n => (n.carpeta || '') === rutaModalNotaRef).length === 0 ? (
                    <p style={{color: 'rgba(255,255,255,0.6)', textAlign: 'center', padding: '2rem'}}>
                      No hay notas en esta carpeta
                    </p>
                  ) : (
                    <div style={{display: 'grid', gap: '0.5rem', maxHeight: '300px', overflowY: 'auto'}}>
                      {(notasGuardadas || [])
                        .filter(n => (n.carpeta || '') === rutaModalNotaRef)
                        .map(nota => (
                          <button
                            key={nota.id}
                            onClick={() => seleccionarNotaReferencia(nota.id)}
                            style={{
                              background: 'rgba(34, 197, 94, 0.1)',
                              border: '1px solid rgba(34, 197, 94, 0.3)',
                              borderRadius: '8px',
                              padding: '0.8rem 1rem',
                              color: 'white',
                              cursor: 'pointer',
                              textAlign: 'left',
                              fontSize: '0.95rem',
                              transition: 'all 0.2s',
                              display: 'flex',
                              flexDirection: 'column',
                              gap: '0.3rem'
                            }}
                            onMouseEnter={(e) => {
                              e.target.style.background = 'rgba(34, 197, 94, 0.3)';
                              e.target.style.transform = 'translateX(5px)';
                            }}
                            onMouseLeave={(e) => {
                              e.target.style.background = 'rgba(34, 197, 94, 0.1)';
                              e.target.style.transform = 'translateX(0)';
                            }}
                          >
                            <div style={{fontWeight: 'bold'}}>üìù {nota.titulo}</div>
                            <div style={{fontSize: '0.8rem', color: 'rgba(255,255,255,0.6)'}}>
                              {new Date(nota.fecha).toLocaleDateString()}
                            </div>
                          </button>
                        ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Explorador para Guardar Contenido */}
        {modalGuardarContenido && (
          <div className="modal-overlay" onClick={() => setModalGuardarContenido(false)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>{tipoGuardado === 'txt' ? 'üìÑ Guardar como TXT' : 'üìù Guardar como Nota'}</h2>
                <button onClick={() => setModalGuardarContenido(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                {/* Breadcrumb */}
                <div className="breadcrumb-explorador">
                  <button 
                    onClick={() => cargarCarpetasGuardado('')}
                    className="breadcrumb-btn-explorador"
                  >
                    üè† Inicio
                  </button>
                  {rutaGuardadoActual && rutaGuardadoActual.split('\\').filter(Boolean).map((parte, idx, arr) => {
                    const rutaParcial = arr.slice(0, idx + 1).join('\\');
                    return (
                      <span key={idx}>
                        <span className="breadcrumb-separador">/</span>
                        <button 
                          onClick={() => cargarCarpetasGuardado(rutaParcial)}
                          className="breadcrumb-btn-explorador"
                        >
                          {parte}
                        </button>
                      </span>
                    );
                  })}
                </div>

                {/* Controles */}
                <div className="explorador-controles" style={{marginTop: '1rem'}}>
                  <button
                    className="btn-explorador btn-volver"
                    onClick={() => {
                      if (rutaGuardadoActual) {
                        const partes = rutaGuardadoActual.split('\\');
                        partes.pop();
                        const rutaPadre = partes.join('\\');
                        cargarCarpetasGuardado(rutaPadre);
                      }
                    }}
                    disabled={!rutaGuardadoActual}
                  >
                    ‚¨ÖÔ∏è Volver Atr√°s
                  </button>
                  
                  <button
                    className="btn-explorador btn-nueva-carpeta"
                    onClick={() => setModalNuevaCarpetaGuardado(true)}
                  >
                    ‚ûï Nueva Carpeta
                  </button>
                </div>

                {/* Info carpeta actual */}
                <div className="carpeta-seleccionada-info" style={{marginTop: '1rem'}}>
                  <div className="info-icon">üìÇ</div>
                  <div className="info-texto">
                    <span className="info-label">Guardar en:</span>
                    <span className="info-valor">{rutaGuardadoActual || 'Ra√≠z'}</span>
                  </div>
                </div>

                {/* Lista de carpetas */}
                <div className="carpetas-grid" style={{marginTop: '1rem', maxHeight: '250px'}}>
                  {carpetasGuardado.length > 0 ? (
                    carpetasGuardado.map((carpeta, idx) => (
                      <button
                        key={idx}
                        className="carpeta-card"
                        onClick={() => {
                          const nuevaRuta = rutaGuardadoActual 
                            ? `${rutaGuardadoActual}\\${carpeta.nombre}`
                            : carpeta.nombre;
                          cargarCarpetasGuardado(nuevaRuta);
                        }}
                      >
                        <div className="carpeta-icono">üìÅ</div>
                        <div className="carpeta-nombre">{carpeta.nombre}</div>
                      </button>
                    ))
                  ) : (
                    <div className="carpetas-vacio">
                      <p className="vacio-icon">üì≠</p>
                      <p className="vacio-texto">No hay subcarpetas</p>
                    </div>
                  )}
                </div>
              </div>

              <div className="modal-footer">
                <button 
                  onClick={() => setModalGuardarContenido(false)} 
                  className="btn-cancelar"
                >
                  Cancelar
                </button>
                <button 
                  onClick={() => {
                    if (tipoGuardado === 'txt') {
                      guardarContenidoComoTXT(rutaGuardadoActual);
                    } else {
                      guardarContenidoComoNota(rutaGuardadoActual);
                    }
                  }}
                  className="btn-primary"
                >
                  ‚úÖ Guardar Aqu√≠
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Nueva Carpeta - Guardado */}
        {modalNuevaCarpetaGuardado && (
          <div className="modal-overlay" onClick={() => setModalNuevaCarpetaGuardado(false)}>
            <div className="modal-content modal-small" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>‚ûï Nueva Carpeta</h2>
                <button onClick={() => setModalNuevaCarpetaGuardado(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                <div className="form-group">
                  <label className="form-label">
                    <span className="label-icon">üìÅ</span>
                    <span>Nombre de la carpeta</span>
                  </label>
                  <input
                    type="text"
                    id="input-nombre-carpeta-guardado"
                    placeholder="Ej: Apuntes, Res√∫menes, etc."
                    className="input-text"
                    onKeyPress={(e) => {
                      if (e.key === 'Enter') {
                        const nombre = e.target.value.trim();
                        if (nombre) {
                          crearCarpetaGuardado(nombre);
                        }
                      }
                    }}
                  />
                  <div className="form-hint">
                    üìç Se crear√° en: {rutaGuardadoActual || 'Ra√≠z'}
                  </div>
                </div>
              </div>

              <div className="modal-footer">
                <button 
                  onClick={() => setModalNuevaCarpetaGuardado(false)} 
                  className="btn-cancelar"
                >
                  Cancelar
                </button>
                <button 
                  onClick={() => {
                    const input = document.getElementById('input-nombre-carpeta-guardado');
                    const nombre = input?.value.trim();
                    if (nombre) {
                      crearCarpetaGuardado(nombre);
                    }
                  }}
                  className="btn-primary"
                >
                  ‚úÖ Crear Carpeta
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Nueva Carpeta - Calentamiento */}
        {modalNuevaCarpetaCalentamiento && (
          <div className="modal-overlay" onClick={() => setModalNuevaCarpetaCalentamiento(false)}>
            <div className="modal-content modal-small" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>‚ûï Nueva Carpeta</h2>
                <button onClick={() => setModalNuevaCarpetaCalentamiento(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                <div className="form-group">
                  <label className="form-label">
                    <span className="label-icon">üìÅ</span>
                    <span>Nombre de la carpeta</span>
                  </label>
                  <input
                    type="text"
                    id="input-nombre-carpeta-calentamiento"
                    placeholder="Ej: Matem√°ticas, Historia, etc."
                    className="input-text"
                    onKeyPress={(e) => {
                      if (e.key === 'Enter') {
                        const nombre = e.target.value.trim();
                        if (nombre) {
                          crearCarpetaCalentamiento(nombre);
                        }
                      }
                    }}
                  />
                  <div className="form-hint">
                    üìç Se crear√° en: {rutaCalentamientoActual || 'Ra√≠z'}
                  </div>
                </div>
              </div>

              <div className="modal-footer">
                <button 
                  onClick={() => setModalNuevaCarpetaCalentamiento(false)} 
                  className="btn-cancelar"
                >
                  Cancelar
                </button>
                <button 
                  onClick={() => {
                    const input = document.getElementById('input-nombre-carpeta-calentamiento');
                    const nombre = input?.value.trim();
                    if (nombre) {
                      crearCarpetaCalentamiento(nombre);
                    }
                  }}
                  className="btn-primary"
                >
                  ‚úÖ Crear Carpeta
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Selecci√≥n de Carpetas para Notas */}
        {modalCarpetasNotaAbierto && (
          <div className="modal-overlay" onClick={() => setModalCarpetasNotaAbierto(false)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üìÅ Seleccionar Carpeta para Nota</h2>
                <button onClick={() => setModalCarpetasNotaAbierto(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                <div className="breadcrumb-nav">
                  <button onClick={() => cargarCarpetasNotas('')} className="breadcrumb-btn">
                    üè† Inicio
                  </button>
                  {rutaNotasActual && rutaNotasActual.split('\\').filter(Boolean).map((parte, idx, arr) => {
                    const rutaParcial = arr.slice(0, idx + 1).join('\\');
                    return (
                      <span key={idx}>
                        <span className="breadcrumb-separator">/</span>
                        <button onClick={() => cargarCarpetasNotas(rutaParcial)} className="breadcrumb-btn">
                          {parte}
                        </button>
                      </span>
                    );
                  })}
                </div>

                <div className="carpetas-lista" style={{maxHeight: '400px', overflowY: 'auto'}}>
                  <button
                    className="carpeta-item"
                    onClick={() => {
                      if (notaActual) {
                        moverNota(notaActual.id, rutaNotasActual);
                        setModalCarpetasNotaAbierto(false);
                        setNotaActual(null);
                      } else {
                        seleccionarCarpetaNota(rutaNotasActual);
                      }
                    }}
                    style={{background: 'linear-gradient(135deg, #646cff 0%, #535bf2 100%)', color: 'white', marginBottom: '1rem'}}
                  >
                    ‚úÖ Seleccionar esta carpeta
                  </button>

                  {carpetasNotas.map((carpeta, idx) => (
                    <button
                      key={idx}
                      className="carpeta-item"
                      onClick={() => {
                        const nuevaRuta = rutaNotasActual 
                          ? `${rutaNotasActual}\\${carpeta.nombre}`
                          : carpeta.nombre;
                        cargarCarpetasNotas(nuevaRuta);
                      }}
                    >
                      <span className="carpeta-icon">üìÅ</span>
                      <span>{carpeta.nombre}</span>
                    </button>
                  ))}

                  {carpetasNotas.length === 0 && (
                    <div className="empty-state">
                      <p>No hay subcarpetas aqu√≠</p>
                    </div>
                  )}
                </div>
              </div>

              <div className="modal-footer">
                <button onClick={() => setModalCarpetasNotaAbierto(false)} className="btn-cancelar">
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Hiperv√≠nculos con Referencias a Notas */}
        {modalHipervinculos && (
          <div className="modal-overlay" onClick={() => setModalHipervinculos(false)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üîó Insertar Hiperv√≠nculo</h2>
                <button onClick={() => setModalHipervinculos(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                <p style={{marginBottom: '1rem', color: '#a0a0b0'}}>
                  Texto seleccionado: <strong>"{textoSeleccionado}"</strong>
                </p>

                <div className="config-section">
                  <label className="config-label">
                    <span>Tipo de enlace</span>
                  </label>
                  <div style={{display: 'flex', gap: '1rem', marginTop: '0.5rem'}}>
                    <button
                      type="button"
                      className={tipoHipervinculo === 'url' ? 'btn-primary' : 'btn-secondary'}
                      onClick={() => setTipoHipervinculo('url')}
                      style={{flex: 1}}
                    >
                      üåê URL Externa
                    </button>
                    <button
                      type="button"
                      className={tipoHipervinculo === 'nota' ? 'btn-primary' : 'btn-secondary'}
                      onClick={() => setTipoHipervinculo('nota')}
                      style={{flex: 1}}
                    >
                      üìù Referencia a Nota
                    </button>
                  </div>
                </div>

                {tipoHipervinculo === 'url' && (
                  <div className="config-section">
                    <label className="config-label">
                      <span>URL del enlace</span>
                    </label>
                    <input
                      type="url"
                      value={urlHipervinculo}
                      onChange={(e) => setUrlHipervinculo(e.target.value)}
                      placeholder="https://ejemplo.com"
                      className="input-nota-titulo"
                      style={{marginTop: '0.5rem'}}
                    />
                    <p className="config-hint">El enlace se abrir√° en una nueva ventana</p>
                  </div>
                )}

                {tipoHipervinculo === 'nota' && (
                  <div className="config-section">
                    <label className="config-label">
                      <span>Selecciona una nota</span>
                    </label>
                    <div style={{maxHeight: '300px', overflowY: 'auto', marginTop: '0.5rem', border: '1px solid rgba(255,255,255,0.1)', borderRadius: '8px', padding: '0.5rem'}}>
                      {notasGuardadas.length === 0 && (
                        <p style={{textAlign: 'center', color: '#808090', padding: '2rem'}}>
                          No hay notas guardadas
                        </p>
                      )}
                      {(notasGuardadas || []).map(nota => (
                        <button
                          key={nota.id}
                          type="button"
                          className={notaReferenciaId === nota.id ? 'btn-primary' : 'carpeta-item'}
                          onClick={() => setNotaReferenciaId(nota.id)}
                          style={{
                            width: '100%',
                            textAlign: 'left',
                            marginBottom: '0.5rem',
                            padding: '0.75rem',
                            background: notaReferenciaId === nota.id 
                              ? 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)' 
                              : 'rgba(255,255,255,0.05)'
                          }}
                        >
                          <div style={{fontWeight: 'bold', marginBottom: '0.25rem'}}>
                            üìù {nota.titulo}
                          </div>
                          <div style={{fontSize: '0.85rem', color: '#a0a0b0'}}>
                            üìÅ {nota.carpeta || 'Ra√≠z'}
                          </div>
                        </button>
                      ))}
                    </div>
                    <p className="config-hint">Al hacer clic en el enlace, se abrir√° la nota seleccionada</p>
                  </div>
                )}
              </div>

              <div className="modal-footer">
                <button onClick={() => setModalHipervinculos(false)} className="btn-cancelar">
                  Cancelar
                </button>
                <button 
                  onClick={insertarHipervinculo} 
                  className="btn-primary"
                  disabled={tipoHipervinculo === 'url' ? !urlHipervinculo : !notaReferenciaId}
                >
                  üîó Insertar Enlace
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal para Mover Pr√°cticas */}
        {modalMoverPractica && practicaAMover && (
          <div className="modal-overlay" onClick={() => setModalMoverPractica(false)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üìÇ Mover Pr√°ctica</h2>
                <button onClick={() => setModalMoverPractica(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                <p style={{marginBottom: '1rem', color: '#a0a0b0'}}>
                  Moviendo: <strong>{practicaAMover.ruta.split('/').pop()}</strong>
                </p>

                <div className="breadcrumb-nav">
                  <button onClick={() => cargarCarpetasPracticas('')} className="breadcrumb-btn">
                    üè† Inicio
                  </button>
                  {rutaPracticasActual && rutaPracticasActual.split('\\').filter(Boolean).map((parte, idx, arr) => {
                    const rutaParcial = arr.slice(0, idx + 1).join('\\');
                    return (
                      <span key={idx}>
                        <span className="breadcrumb-separator">/</span>
                        <button onClick={() => cargarCarpetasPracticas(rutaParcial)} className="breadcrumb-btn">
                          {parte}
                        </button>
                      </span>
                    );
                  })}
                </div>

                <div className="carpetas-lista" style={{maxHeight: '400px', overflowY: 'auto', marginTop: '1rem'}}>
                  <button
                    className="carpeta-item"
                    onClick={() => {
                      moverPractica(practicaAMover.id, rutaPracticasActual);
                      setModalMoverPractica(false);
                      setPracticaAMover(null);
                      setSelectedMenu('practicas'); // Forzar re-render
                    }}
                    style={{background: 'linear-gradient(135deg, #646cff 0%, #535bf2 100%)', color: 'white', marginBottom: '1rem'}}
                  >
                    ‚úÖ Mover aqu√≠
                  </button>

                  {carpetasPracticas.map((carpeta, idx) => (
                    <button
                      key={idx}
                      className="carpeta-item"
                      onClick={() => {
                        const nuevaRuta = rutaPracticasActual 
                          ? `${rutaPracticasActual}\\${carpeta.nombre}`
                          : carpeta.nombre;
                        cargarCarpetasPracticas(nuevaRuta);
                      }}
                    >
                      <span className="carpeta-icon">üìÅ</span>
                      <span>{carpeta.nombre}</span>
                    </button>
                  ))}

                  {carpetasPracticas.length === 0 && (
                    <div className="empty-state">
                      <p>No hay subcarpetas aqu√≠</p>
                    </div>
                  )}
                </div>
              </div>

              <div className="modal-footer">
                <button onClick={() => setModalMoverPractica(false)} className="btn-cancelar">
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Modal de Selecci√≥n de Archivos para Examen por Carpeta */}
        {modalSeleccionArchivos && (
          <div className="modal-overlay" onClick={() => setModalSeleccionArchivos(false)}>
            <div className="modal-content modal-seleccion-archivos" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <h2>üìö Generar Examen - {tipoCarpeta.toUpperCase()}</h2>
                <button onClick={() => setModalSeleccionArchivos(false)} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                <div className="info-carpeta">
                  <p>üìÅ <strong>Carpeta:</strong> {carpetaExamen?.nombre || carpetaExamen?.ruta || 'Sin nombre'}</p>
                  <p>üìÑ <strong>Archivos encontrados:</strong> {archivosEncontrados.length}</p>
                  <p>‚úÖ <strong>Seleccionados:</strong> {archivosEncontrados.length - archivosExcluidos.length}</p>
                </div>
                
                <div className="form-group">
                  <h3>‚öôÔ∏è Configuraci√≥n del Examen</h3>
                  <div className="config-grid">
                    <div className="config-item">
                      <label>Opci√≥n M√∫ltiple:</label>
                      <input 
                        type="number" 
                        value={configExamenCarpeta.num_multiple}
                        onChange={(e) => setConfigExamenCarpeta({...configExamenCarpeta, num_multiple: parseInt(e.target.value) || 0})}
                        min="0"
                        max="50"
                      />
                    </div>
                    <div className="config-item">
                      <label>Respuesta Corta:</label>
                      <input 
                        type="number" 
                        value={configExamenCarpeta.num_corta}
                        onChange={(e) => setConfigExamenCarpeta({...configExamenCarpeta, num_corta: parseInt(e.target.value) || 0})}
                        min="0"
                        max="30"
                      />
                    </div>
                    <div className="config-item">
                      <label>Verdadero/Falso:</label>
                      <input 
                        type="number" 
                        value={configExamenCarpeta.num_vf}
                        onChange={(e) => setConfigExamenCarpeta({...configExamenCarpeta, num_vf: parseInt(e.target.value) || 0})}
                        min="0"
                        max="20"
                      />
                    </div>
                    <div className="config-item">
                      <label>Desarrollo:</label>
                      <input 
                        type="number" 
                        value={configExamenCarpeta.num_desarrollo}
                        onChange={(e) => setConfigExamenCarpeta({...configExamenCarpeta, num_desarrollo: parseInt(e.target.value) || 0})}
                        min="0"
                        max="10"
                      />
                    </div>
                  </div>
                </div>
                
                <div className="form-group">
                  <h3>üìÇ Seleccionar Archivos a Incluir</h3>
                  <div className="archivos-seleccion-container">
                    <div className="archivos-acciones">
                      <button 
                        onClick={() => setArchivosExcluidos([])}
                        className="btn-secondary"
                      >
                        ‚úÖ Seleccionar Todos
                      </button>
                      <button 
                        onClick={() => setArchivosExcluidos(archivosEncontrados.map(a => a.ruta))}
                        className="btn-secondary"
                      >
                        ‚ùå Deseleccionar Todos
                      </button>
                    </div>
                    
                    <div className="archivos-lista">
                      {archivosEncontrados.map((archivo) => {
                        const excluido = archivosExcluidos.includes(archivo.ruta);
                        return (
                          <div 
                            key={archivo.ruta} 
                            className={`archivo-item ${excluido ? 'excluido' : 'incluido'}`}
                            onClick={() => {
                              if (excluido) {
                                setArchivosExcluidos(archivosExcluidos.filter(r => r !== archivo.ruta));
                              } else {
                                setArchivosExcluidos([...archivosExcluidos, archivo.ruta]);
                              }
                            }}
                          >
                            <div className="archivo-checkbox">
                              {excluido ? '‚òê' : '‚òë'}
                            </div>
                            <div className="archivo-info">
                              <div className="archivo-nombre">{archivo.nombre}</div>
                              <div className="archivo-ruta">{archivo.ruta}</div>
                              <div className="archivo-tama√±o">{archivo.tama√±o_kb} KB</div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>

              <div className="modal-footer">
                <button 
                  onClick={() => setModalSeleccionArchivos(false)} 
                  className="btn-cancelar"
                >
                  Cancelar
                </button>
                <button 
                  onClick={generarExamenPorBloques} 
                  className="btn-primary"
                  disabled={archivosEncontrados.length - archivosExcluidos.length === 0}
                >
                  üöÄ Generar Examen ({archivosEncontrados.length - archivosExcluidos.length} archivos)
                </button>
              </div>
            </div>
          </div>
        )}
        
        {/* Indicador de generaci√≥n por bloques */}
        {generandoExamenPorBloques && (
          <div className="modal-overlay">
            <div className="modal-content modal-progreso-bloques">
              <div className="modal-header">
                <h2>‚ö° Generando Examen por Bloques</h2>
              </div>
              <div className="modal-body">
                <div className="progreso-bloques">
                  <div className="bloque-info">
                    <span className="bloque-actual">{bloqueActual}</span>
                    <span className="bloque-separador">/</span>
                    <span className="bloque-total">{totalBloques}</span>
                  </div>
                  <div className="progreso-mensaje">{mensajeProgreso}</div>
                  <div className="progreso-barra">
                    <div className="progreso-fill" style={{width: `${progresoGeneracion}%`}}>
                      <span className="progreso-texto">{progresoGeneracion}%</span>
                    </div>
                  </div>
                  <p className="hint">Procesando archivos en bloques peque√±os para mejor calidad...</p>
                </div>
              </div>
            </div>
          </div>
        )}



        {/* Modal Instalador de Modelos */}
        {modalInstaladorModelo && (
          <div className="modal-overlay" onClick={() => !instalandoModelo && setModalInstaladorModelo(false)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '600px' }}>
              <div className="modal-header">
                <h2>üì¶ Instalar Modelo GGUF en Ollama</h2>
                <button 
                  className="btn-close" 
                  onClick={() => !instalandoModelo && setModalInstaladorModelo(false)}
                  disabled={instalandoModelo}
                >
                  ‚úï
                </button>
              </div>

              <div className="modal-body">
                <div style={{ marginBottom: '20px', padding: '15px', background: '#f0f9ff', borderRadius: '8px', border: '1px solid #0284c7' }}>
                  <p style={{ margin: 0, color: '#0c4a6e', lineHeight: '1.6' }}>
                    üí° <strong>¬øC√≥mo funciona?</strong><br/>
                    Selecciona un archivo .gguf de un modelo de IA y se instalar√° autom√°ticamente en Ollama para que puedas usarlo en Examinator.
                  </p>
                </div>

                <div className="form-group">
                  <label htmlFor="archivo-modelo">
                    <strong>üìÇ Seleccionar Archivo GGUF:</strong>
                  </label>
                  <input
                    id="archivo-modelo"
                    type="file"
                    accept=".gguf"
                    onChange={(e) => {
                      const file = e.target.files[0]
                      setArchivoModeloGGUF(file)
                      // Sugerir nombre del modelo basado en el archivo
                      if (file) {
                        const nombreBase = file.name.replace('.gguf', '').replace(/_/g, '-')
                        setNombreModeloNuevo(nombreBase + ':latest')
                      }
                    }}
                    disabled={instalandoModelo}
                    style={{
                      width: '100%',
                      padding: '10px',
                      border: '2px dashed #667eea',
                      borderRadius: '8px',
                      cursor: 'pointer',
                      background: '#f8f9fa'
                    }}
                  />
                  {archivoModeloGGUF && (
                    <div style={{ marginTop: '10px', padding: '10px', background: '#e7f3ff', borderRadius: '6px' }}>
                      <small>
                        ‚úÖ <strong>{archivoModeloGGUF.name}</strong><br/>
                        üìä Tama√±o: {(archivoModeloGGUF.size / (1024 * 1024)).toFixed(2)} MB
                      </small>
                    </div>
                  )}
                </div>

                <div className="form-group">
                  <label htmlFor="nombre-modelo">
                    <strong>üè∑Ô∏è Nombre del Modelo en Ollama:</strong>
                  </label>
                  <input
                    id="nombre-modelo"
                    type="text"
                    value={nombreModeloNuevo}
                    onChange={(e) => setNombreModeloNuevo(e.target.value)}
                    placeholder="mi-modelo:latest"
                    disabled={instalandoModelo}
                    style={{
                      width: '100%',
                      padding: '10px',
                      border: '1px solid #ddd',
                      borderRadius: '6px',
                      fontSize: '14px'
                    }}
                  />
                  <small style={{ color: '#666', display: 'block', marginTop: '5px' }}>
                    Ejemplo: llama3-spanish:latest, qwen2.5-coder:14b, mistral-7b:Q4_K_M
                  </small>
                </div>

                {instalandoModelo && (
                  <div style={{
                    padding: '15px',
                    background: '#fff3cd',
                    borderRadius: '8px',
                    border: '1px solid #ffc107',
                    marginTop: '15px'
                  }}>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                      <div className="spinner" style={{
                        width: '20px',
                        height: '20px',
                        border: '3px solid #f3f3f3',
                        borderTop: '3px solid #ffc107',
                        borderRadius: '50%',
                        animation: 'spin 1s linear infinite'
                      }}></div>
                      <span style={{ color: '#856404' }}>
                        <strong>Instalando modelo...</strong><br/>
                        Esto puede tomar varios minutos dependiendo del tama√±o del archivo.
                      </span>
                    </div>
                  </div>
                )}
              </div>

              <div className="modal-footer">
                <button 
                  className="btn-secondary" 
                  onClick={() => setModalInstaladorModelo(false)}
                  disabled={instalandoModelo}
                >
                  Cancelar
                </button>
                <button 
                  className="btn-primary" 
                  onClick={instalarModeloOllama}
                  disabled={!archivoModeloGGUF || !nombreModeloNuevo.trim() || instalandoModelo}
                  style={{
                    opacity: (!archivoModeloGGUF || !nombreModeloNuevo.trim() || instalandoModelo) ? 0.5 : 1,
                    cursor: (!archivoModeloGGUF || !nombreModeloNuevo.trim() || instalandoModelo) ? 'not-allowed' : 'pointer'
                  }}
                >
                  {instalandoModelo ? '‚è≥ Instalando...' : 'üöÄ Instalar Modelo'}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* ============= MODAL NUEVA/EDITAR FLASHCARD ============= */}
        {modalNuevaFlashcard && (
          <div className="modal-overlay" onClick={() => {
            setModalNuevaFlashcard(false);
            setFlashcardEditando(null);
          }}>
            <div className="modal-content modal-flashcard" onClick={(e) => e.stopPropagation()}>
              <div className="modal-header">
                <div>
                  <h2>{flashcardEditando ? '‚úèÔ∏è Editar Flashcard' : '‚ûï Nueva Flashcard'}</h2>
                  {(carpetaFlashcardActual || rutaFlashcardsActual) && (
                    <p style={{
                      margin: '0.5rem 0 0 0',
                      fontSize: '0.85rem',
                      color: '#94a3b8',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem'
                    }}>
                      üìÅ {carpetaFlashcardActual?.nombre || rutaFlashcardsActual.split('/').pop() || 'Ra√≠z'}
                    </p>
                  )}
                </div>
                <button onClick={() => {
                  setModalNuevaFlashcard(false);
                  setFlashcardEditando(null);
                }} className="btn-close">‚úï</button>
              </div>
              
              <div className="modal-body">
                <form onSubmit={(e) => {
                  e.preventDefault();
                  guardarFlashcard(formDataFlashcard);
                  setModalNuevaFlashcard(false);
                  setFlashcardEditando(null);
                }}>

                  {/* üé® SELECTOR DE MODOS VISUALES */}
                  <VisualModeSelector 
                    currentMode={modoVisual}
                    onModeChange={(mode) => {
                      setModoVisual(mode.id);
                      // Auto-seleccionar el primer tipo del modo
                      if (mode.tipos && mode.tipos.length > 0) {
                        setFormDataFlashcard({
                          ...formDataFlashcard,
                          tipo: mode.tipos[0]
                        });
                      }
                    }}
                  />

                  {/* Selecci√≥n de Tipo */}
                  <div className="config-section">
                    <label className="config-label">
                      <span className="label-icon">üéØ</span>
                      Tipo de Flashcard
                    </label>
                    <select
                      className="input-select"
                      value={formDataFlashcard.tipo}
                      onChange={(e) => setFormDataFlashcard({...formDataFlashcard, tipo: e.target.value})}
                    >
                      <option value="clasica">üìá Cl√°sica (Pregunta ‚Üí Respuesta)</option>
                      <option value="reconocimiento">üëÅÔ∏è Reconocimiento (Identificar concepto)</option>
                      <option value="cloze">üî§ Cloze (Completar espacios)</option>
                      <option value="escenario">üé¨ Escenario (Caso pr√°ctico)</option>
                      <option value="mcq">‚òëÔ∏è Opci√≥n M√∫ltiple</option>
                      <option value="visual">üñºÔ∏è Visual (Imagen/Diagrama)</option>
                      <option value="auditiva">üîä Auditiva (Audio/Pronunciaci√≥n)</option>
                      <option value="produccion">‚úçÔ∏è Producci√≥n (Generar respuesta)</option>
                      <option value="invertida">üîÑ Invertida (Respuesta ‚Üí Pregunta)</option>
                      <option value="jerarquia">üèóÔ∏è Jerarqu√≠a (Organizar niveles)</option>
                      <option value="error">‚ùå Error Com√∫n (Corregir)</option>
                      <option value="comparacion">‚öñÔ∏è Comparaci√≥n (A vs B)</option>
                      <option value="matematica">üî¢ Matem√°tica (F√≥rmulas/LaTeX)</option>
                      <option value="archivo">üìé Archivo (PDF/Documento)</option>
                      <option value="programacion">&lt;/&gt; Programaci√≥n (C√≥digo)</option>
                      <option value="quimica">üß™ Qu√≠mica (Estructuras/Mol√©culas)</option>
                      <option value="fisica">‚öõÔ∏è F√≠sica (Ecuaciones/Diagramas)</option>
                      <option value="ingenieria">üîß Ingenier√≠a (Circuitos/FBD/Vigas)</option>
                      <option value="programacion-avanzada">üíª Programaci√≥n Avanzada (UML/Flujo/Grafos)</option>
                      <option value="logica-discreta">üîÆ L√≥gica/Matem√°tica Discreta (Tablas/Conjuntos/Grafos)</option>
                      <option value="linguistica">üó£Ô∏è Lingu√≠stica/Fon√©tica (IPA/Stress/Entonaci√≥n)</option>
                      <option value="musica">üéº M√∫sica/Teor√≠a Musical (Pentagramas/Acordes/Escalas)</option>
                      <option value="geometria">üìê Geometr√≠a (Construcciones/√Ångulos/Trigonometr√≠a)</option>
                      <option value="quimica-avanzada">üß¨ Qu√≠mica Avanzada (Orbitales/VSEPR/MO/Mecanismos)</option>
                      <option value="probabilidad">üé≤ Probabilidad y Estad√≠stica (√Årboles/Venn/Distribuciones/Bayes)</option>
                      <option value="arte">üé® Arte y Dise√±o Visual (Figuras/Paletas/Composiciones/Estilos)</option>
                    </select>
                    
                    {/* Toggle LaTeX */}
                    <div style={{
                      marginTop: '1rem',
                      padding: '0.75rem',
                      background: 'rgba(59, 130, 246, 0.1)',
                      borderRadius: '8px',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.75rem'
                    }}>
                      <input
                        type="checkbox"
                        id="latex-toggle"
                        checked={formDataFlashcard.latex}
                        onChange={(e) => setFormDataFlashcard({...formDataFlashcard, latex: e.target.checked})}
                        style={{
                          width: '18px',
                          height: '18px',
                          cursor: 'pointer',
                          accentColor: '#3b82f6'
                        }}
                      />
                      <label htmlFor="latex-toggle" style={{
                        color: '#cbd5e1',
                        fontSize: '0.9rem',
                        cursor: 'pointer',
                        userSelect: 'none'
                      }}>
                        üìê Contiene f√≥rmulas matem√°ticas (LaTeX)
                      </label>
                    </div>
                    
                    {/* Preview del tipo seleccionado */}
                    <div style={{
                      marginTop: '1rem',
                      padding: '1rem',
                      background: 'rgba(102, 126, 234, 0.1)',
                      borderLeft: '3px solid #667eea',
                      borderRadius: '8px',
                      fontSize: '0.85rem',
                      color: '#cbd5e1',
                      whiteSpace: 'pre-line'
                    }}>
                      <strong style={{color: '#667eea'}}>üí° Estructura de este tipo:</strong>
                      <div style={{marginTop: '0.5rem', lineHeight: '1.6'}}>
                        {formDataFlashcard.tipo === 'clasica' && '‚Ä¢ Pregunta directa en el frente\n‚Ä¢ Respuesta concisa en el reverso'}
                        {formDataFlashcard.tipo === 'reconocimiento' && '‚Ä¢ Imagen o concepto visual\n‚Ä¢ Identifica el nombre/t√©rmino correcto'}
                        {formDataFlashcard.tipo === 'cloze' && '‚Ä¢ Texto con huecos marcados con []\n‚Ä¢ Completa las palabras faltantes'}
                        {formDataFlashcard.tipo === 'escenario' && '‚Ä¢ Caso pr√°ctico de 2-3 l√≠neas\n‚Ä¢ Pregunta: "¬øQu√© har√≠as?"'}
                        {formDataFlashcard.tipo === 'mcq' && '‚Ä¢ Pregunta + 4 opciones\n‚Ä¢ Formato: A) B) C) D)'}
                        {formDataFlashcard.tipo === 'visual' && '‚Ä¢ Imagen/diagrama centrado\n‚Ä¢ Pregunta: "Explica lo que ves"'}
                        {formDataFlashcard.tipo === 'auditiva' && '‚Ä¢ Audio o palabra para pronunciar\n‚Ä¢ Pregunta sobre sonido/pronunciaci√≥n'}
                        {formDataFlashcard.tipo === 'produccion' && '‚Ä¢ Prompt: "Produce..."\n‚Ä¢ Espacio para generar contenido'}
                        {formDataFlashcard.tipo === 'invertida' && '‚Ä¢ Respuesta visible primero\n‚Ä¢ Pregunta: "¬øCu√°l era la pregunta?"'}
                        {formDataFlashcard.tipo === 'jerarquia' && '‚Ä¢ Nodo principal + subnodos\n‚Ä¢ Estructura de √°rbol o niveles'}
                        {formDataFlashcard.tipo === 'error' && '‚Ä¢ Texto con error intencional\n‚Ä¢ Pregunta: "Corrige el error"'}
                        {formDataFlashcard.tipo === 'comparacion' && '‚Ä¢ Dos elementos lado a lado\n‚Ä¢ Pregunta: "Compara ambos"'}
                        {formDataFlashcard.tipo === 'matematica' && '‚Ä¢ F√≥rmula matem√°tica en LaTeX\n‚Ä¢ Expresi√≥n limpia y renderizada\n‚Ä¢ Ejemplo: ‚à´‚ÇÄ¬π x¬≤ dx = 1/3'}
                        {formDataFlashcard.tipo === 'archivo' && '‚Ä¢ Archivo adjunto (PDF/Documento)\n‚Ä¢ Miniatura o √≠cono del archivo\n‚Ä¢ Descripci√≥n del contenido'}
                        {formDataFlashcard.tipo === 'programacion' && '‚Ä¢ Bloque de c√≥digo en fuente monospace\n‚Ä¢ Puede ser: leer c√≥digo, encontrar bug, completar huecos, o escribir soluci√≥n\n‚Ä¢ Lenguaje: JavaScript, Python, C++, etc.'}
                      </div>
                    </div>
                  </div>

                  {/* ========== CONFIGURACI√ìN ESPEC√çFICA PARA PROGRAMACI√ìN ========== */}
                  {formDataFlashcard.tipo === 'programacion' && (
                    <>
                      {/* Selector de Lenguaje */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üíª</span>
                          Lenguaje de Programaci√≥n
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.lenguaje}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, lenguaje: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(148, 163, 184, 0.3)',
                            color: '#e2e8f0'
                          }}
                        >
                          <option value="javascript">JavaScript</option>
                          <option value="python">Python</option>
                          <option value="java">Java</option>
                          <option value="cpp">C++</option>
                          <option value="csharp">C#</option>
                          <option value="php">PHP</option>
                          <option value="ruby">Ruby</option>
                          <option value="go">Go</option>
                          <option value="rust">Rust</option>
                          <option value="typescript">TypeScript</option>
                          <option value="sql">SQL</option>
                          <option value="html">HTML</option>
                          <option value="css">CSS</option>
                        </select>
                      </div>

                      {/* Selector de Patr√≥n de C√≥digo */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üéØ</span>
                          Patr√≥n de Flashcard
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.patronCodigo}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, patronCodigo: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(148, 163, 184, 0.3)',
                            color: '#e2e8f0'
                          }}
                        >
                          <option value="comprension">üìñ Comprensi√≥n (¬øQu√© hace este c√≥digo?)</option>
                          <option value="bug">üêõ Error Intencional (Encuentra y corrige el bug)</option>
                          <option value="cloze">üî§ Cloze (Completa el c√≥digo con [])</option>
                          <option value="produccion">‚úçÔ∏è Producci√≥n (Escribe c√≥digo desde cero)</option>
                        </select>
                      </div>

                      {/* Selector de Dificultad */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">‚ö°</span>
                          Dificultad
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.dificultad}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, dificultad: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(148, 163, 184, 0.3)',
                            color: '#e2e8f0'
                          }}
                        >
                          <option value="facil">üü¢ F√°cil</option>
                          <option value="medio">üü° Medio</option>
                          <option value="dificil">üî¥ Dif√≠cil</option>
                        </select>
                      </div>

                      {/* Gu√≠a seg√∫n el patr√≥n seleccionado */}
                      <div style={{
                        marginTop: '1rem',
                        padding: '1rem',
                        background: 'rgba(20, 184, 166, 0.1)',
                        borderLeft: '3px solid #14b8a6',
                        borderRadius: '8px',
                        fontSize: '0.85rem',
                        color: '#cbd5e1',
                        whiteSpace: 'pre-line'
                      }}>
                        <strong style={{color: '#14b8a6'}}>üí° Gu√≠a para {
                          formDataFlashcard.patronCodigo === 'comprension' ? 'Comprensi√≥n' :
                          formDataFlashcard.patronCodigo === 'bug' ? 'Error Intencional' :
                          formDataFlashcard.patronCodigo === 'cloze' ? 'Cloze' :
                          'Producci√≥n'
                        }:</strong>
                        <div style={{marginTop: '0.5rem', lineHeight: '1.6'}}>
                          {formDataFlashcard.patronCodigo === 'comprension' && 
                            '‚Ä¢ Escribe c√≥digo funcional\n‚Ä¢ En el campo "Contenido", coloca el snippet\n‚Ä¢ En "Respuesta", explica qu√© hace el c√≥digo\n‚Ä¢ Ejemplo: function sum(arr) { return arr.reduce((a,b) => a+b, 0); }'
                          }
                          {formDataFlashcard.patronCodigo === 'bug' && 
                            '‚Ä¢ Escribe c√≥digo con un error intencional\n‚Ä¢ Marca visualmente el error con comentario // ‚ùå BUG AQU√ç\n‚Ä¢ En "Respuesta", explica el bug y la correcci√≥n\n‚Ä¢ Ejemplo: if (x = 5) { ... } // ‚ùå Deber√≠a ser =='
                          }
                          {formDataFlashcard.patronCodigo === 'cloze' && 
                            '‚Ä¢ Escribe c√≥digo con huecos usando []\n‚Ä¢ Ejemplo: for (let i = 0; i < []; i++)\n‚Ä¢ En "Respuesta", escribe lo que va en cada hueco\n‚Ä¢ Puedes tener m√∫ltiples huecos'
                          }
                          {formDataFlashcard.patronCodigo === 'produccion' && 
                            '‚Ä¢ Escribe la instrucci√≥n/prompt en "Contenido"\n‚Ä¢ Ejemplo: "Escribe una funci√≥n que filtre n√∫meros pares"\n‚Ä¢ Deja "Respuesta" con la soluci√≥n esperada\n‚Ä¢ No escribas c√≥digo en el campo de contenido, solo la tarea'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* ========== CONFIGURACI√ìN ESPEC√çFICA PARA QU√çMICA ========== */}
                  {formDataFlashcard.tipo === 'quimica' && (
                    <>
                      {/* Selector de Subtipo */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">‚öóÔ∏è</span>
                          Tipo de Flashcard Qu√≠mica
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.subtipoQuimica}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, subtipoQuimica: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(16, 185, 129, 0.3)',
                            color: '#d1fae5'
                          }}
                        >
                          <option value="estructura">üî¨ Estructura/Esqueleto (Identificar compuesto)</option>
                          <option value="enlace">üîó Enlaces y Geometr√≠a (Tipo de enlace/forma)</option>
                          <option value="funcional">‚öõÔ∏è Grupo Funcional (Identificar -OH, -COOH, etc.)</option>
                          <option value="reaccion">‚û°Ô∏è Reacci√≥n (Reactivos ‚Üí Productos)</option>
                          <option value="mecanismo">üéØ Mecanismo (Flechas curvas/pasos)</option>
                        </select>
                      </div>

                      {/* Selector de Rama */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìö</span>
                          Rama de la Qu√≠mica
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.rama}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, rama: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(16, 185, 129, 0.3)',
                            color: '#d1fae5'
                          }}
                        >
                          <option value="organica">üß™ Qu√≠mica Org√°nica</option>
                          <option value="inorganica">‚öóÔ∏è Qu√≠mica Inorg√°nica</option>
                          <option value="fisicoquimica">üî¨ Fisicoqu√≠mica</option>
                        </select>
                      </div>

                      {/* Selector de Nivel */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Dificultad
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.nivelQuimica}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, nivelQuimica: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(16, 185, 129, 0.3)',
                            color: '#d1fae5'
                          }}
                        >
                          <option value="basico">üü¢ B√°sico</option>
                          <option value="intermedio">üü° Intermedio</option>
                          <option value="avanzado">üî¥ Avanzado</option>
                        </select>
                      </div>

                      {/* Gu√≠a seg√∫n el subtipo seleccionado */}
                      <div style={{
                        marginTop: '1rem',
                        padding: '1rem',
                        background: 'rgba(16, 185, 129, 0.1)',
                        borderLeft: '3px solid #10b981',
                        borderRadius: '8px',
                        fontSize: '0.85rem',
                        color: '#cbd5e1',
                        whiteSpace: 'pre-line'
                      }}>
                        <strong style={{color: '#10b981'}}>üí° Gu√≠a para {
                          formDataFlashcard.subtipoQuimica === 'estructura' ? 'Estructura/Esqueleto' :
                          formDataFlashcard.subtipoQuimica === 'enlace' ? 'Enlaces y Geometr√≠a' :
                          formDataFlashcard.subtipoQuimica === 'funcional' ? 'Grupo Funcional' :
                          formDataFlashcard.subtipoQuimica === 'reaccion' ? 'Reacci√≥n' :
                          'Mecanismo'
                        }:</strong>
                        <div style={{marginTop: '0.5rem', lineHeight: '1.6'}}>
                          {formDataFlashcard.subtipoQuimica === 'estructura' && 
                            '‚Ä¢ Usa el panel para insertar estructuras (hex√°gonos, cadenas, etc.)\n‚Ä¢ Pregunta t√≠pica: "¬øQu√© compuesto es este?", "Nombra esta estructura"\n‚Ä¢ En "Respuesta", escribe el nombre del compuesto\n‚Ä¢ Ejemplo: Benceno, Ciclohexano, Tolueno'
                          }
                          {formDataFlashcard.subtipoQuimica === 'enlace' && 
                            '‚Ä¢ Muestra una mol√©cula simple\n‚Ä¢ Pregunta sobre: tipo de enlace (simple/doble/triple), polaridad, geometr√≠a\n‚Ä¢ En "Respuesta", explica el tipo de enlace y geometr√≠a\n‚Ä¢ Ejemplo: H-Cl ‚Üí enlace covalente polar, geometr√≠a lineal'
                          }
                          {formDataFlashcard.subtipoQuimica === 'funcional' && 
                            '‚Ä¢ Usa estructuras con grupos funcionales resaltados\n‚Ä¢ Pregunta: "¬øQu√© grupo funcional es?", "¬øA qu√© familia pertenece?"\n‚Ä¢ En "Respuesta", nombra el grupo funcional\n‚Ä¢ Ejemplo: -OH ‚Üí Alcohol, -COOH ‚Üí √Åcido carbox√≠lico'
                          }
                          {formDataFlashcard.subtipoQuimica === 'reaccion' && 
                            '‚Ä¢ Formato: Reactivo(s) ‚Üí Producto(s)\n‚Ä¢ Incluye condiciones (Œî, hv, catalizador)\n‚Ä¢ Pregunta: "¬øTipo de reacci√≥n?", "Completa el producto"\n‚Ä¢ En "Respuesta", explica tipo de reacci√≥n o producto'
                          }
                          {formDataFlashcard.subtipoQuimica === 'mecanismo' && 
                            '‚Ä¢ Muestra flechas curvas (movimiento de electrones)\n‚Ä¢ Pregunta: "¬øQu√© ocurre en este paso?"\n‚Ä¢ En "Respuesta", explica el mecanismo\n‚Ä¢ Ejemplo: Ataque nucle√≥filo, eliminaci√≥n, sustituci√≥n'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* ========== CONFIGURACI√ìN ESPEC√çFICA PARA F√çSICA ========== */}
                  {formDataFlashcard.tipo === 'fisica' && (
                    <>
                      {/* Selector de Subtipo */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">‚öõÔ∏è</span>
                          Tipo de Flashcard F√≠sica
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.subtipoFisica}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, subtipoFisica: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(245, 158, 11, 0.3)',
                            color: '#fef3c7'
                          }}
                        >
                          <option value="ecuacion">üìê Ecuaci√≥n/F√≥rmula (Ley o principio)</option>
                          <option value="diagrama-fuerzas">‚ûú Diagrama de Fuerzas (FBD)</option>
                          <option value="campo">‚ö° Campo Vectorial (E, B, gravitacional)</option>
                          <option value="proceso">üîÑ Proceso F√≠sico (Ciclo, transformaci√≥n)</option>
                          <option value="experimento">üî¨ Experimento/Medici√≥n (Setup)</option>
                        </select>
                      </div>

                      {/* Selector de Rama */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìö</span>
                          Rama de la F√≠sica
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.ramaFisica}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, ramaFisica: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(245, 158, 11, 0.3)',
                            color: '#fef3c7'
                          }}
                        >
                          <option value="mecanica">‚öôÔ∏è Mec√°nica Cl√°sica</option>
                          <option value="electromagnetismo">‚ö° Electromagnetismo</option>
                          <option value="optica">üî¶ √ìptica</option>
                          <option value="termodinamica">üå°Ô∏è Termodin√°mica</option>
                          <option value="cuantica">‚Ñè F√≠sica Cu√°ntica</option>
                        </select>
                      </div>

                      {/* Selector de Nivel */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Dificultad
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.nivelFisica}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, nivelFisica: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(245, 158, 11, 0.3)',
                            color: '#fef3c7'
                          }}
                        >
                          <option value="basico">üü¢ B√°sico (Secundaria)</option>
                          <option value="intermedio">üü° Intermedio (Bachillerato)</option>
                          <option value="avanzado">üî¥ Avanzado (Universidad)</option>
                        </select>
                      </div>

                      {/* Gu√≠a seg√∫n el subtipo seleccionado */}
                      <div style={{
                        marginTop: '1rem',
                        padding: '1rem',
                        background: 'rgba(245, 158, 11, 0.1)',
                        borderLeft: '3px solid #f59e0b',
                        borderRadius: '8px',
                        fontSize: '0.85rem',
                        color: '#cbd5e1',
                        whiteSpace: 'pre-line'
                      }}>
                        <strong style={{color: '#fbbf24'}}>üí° Gu√≠a para {
                          formDataFlashcard.subtipoFisica === 'ecuacion' ? 'Ecuaci√≥n/F√≥rmula' :
                          formDataFlashcard.subtipoFisica === 'diagrama-fuerzas' ? 'Diagrama de Fuerzas' :
                          formDataFlashcard.subtipoFisica === 'campo' ? 'Campo Vectorial' :
                          formDataFlashcard.subtipoFisica === 'proceso' ? 'Proceso F√≠sico' :
                          'Experimento/Medici√≥n'
                        }:</strong>
                        <div style={{marginTop: '0.5rem', lineHeight: '1.6'}}>
                          {formDataFlashcard.subtipoFisica === 'ecuacion' && 
                            '‚Ä¢ Usa el panel para insertar ecuaciones (F=ma, Maxwell, Schr√∂dinger)\n‚Ä¢ Pregunta t√≠pica: "¬øQu√© ley es?", "Cu√°l es la ecuaci√≥n de...?"\n‚Ä¢ En "Respuesta", explica la ley y sus variables\n‚Ä¢ Ejemplo: 2¬™ Ley de Newton, Ley de Coulomb, Ecuaci√≥n de estado'
                          }
                          {formDataFlashcard.subtipoFisica === 'diagrama-fuerzas' && 
                            '‚Ä¢ Dibuja flechas de fuerzas (peso, normal, fricci√≥n, tensi√≥n)\n‚Ä¢ Pregunta: "Identifica las fuerzas", "Dibuja el FBD"\n‚Ä¢ En "Respuesta", lista las fuerzas y direcciones\n‚Ä¢ Ejemplo: Bloque en plano inclinado, sistema de poleas'
                          }
                          {formDataFlashcard.subtipoFisica === 'campo' && 
                            '‚Ä¢ Representa campos E‚Éó, B‚Éó con vectores o l√≠neas de campo\n‚Ä¢ Pregunta: "Direcci√≥n del campo", "Intensidad en este punto"\n‚Ä¢ En "Respuesta", explica la geometr√≠a del campo\n‚Ä¢ Ejemplo: Campo el√©ctrico de carga puntual, campo magn√©tico de corriente'
                          }
                          {formDataFlashcard.subtipoFisica === 'proceso' && 
                            '‚Ä¢ Diagramas PV, Ts, o secuencias de estados\n‚Ä¢ Pregunta: "¬øQu√© tipo de proceso?", "Trabajo realizado"\n‚Ä¢ En "Respuesta", clasifica y calcula\n‚Ä¢ Ejemplo: Ciclo de Carnot, proceso adiab√°tico, transformaci√≥n isot√©rmica'
                          }
                          {formDataFlashcard.subtipoFisica === 'experimento' && 
                            '‚Ä¢ Describe montaje experimental (lentes, circuitos, p√©ndulos)\n‚Ä¢ Pregunta: "¬øQu√© se mide?", "¬øC√≥mo funciona?"\n‚Ä¢ En "Respuesta", explica el principio y procedimiento\n‚Ä¢ Ejemplo: Interferencia de Young, efecto fotoel√©ctrico, ley de Ohm'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* ========== CONFIGURACI√ìN ESPEC√çFICA PARA INGENIER√çA ========== */}
                  {formDataFlashcard.tipo === 'ingenieria' && (
                    <>
                      {/* Selector de Subtipo */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üîß</span>
                          Tipo de Diagrama/Sistema
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.subtipoIngenieria}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, subtipoIngenieria: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(239, 68, 68, 0.3)',
                            color: '#fecaca'
                          }}
                        >
                          <option value="circuito">‚ö° Circuito El√©ctrico (LTspice-style)</option>
                          <option value="fbd">‚ûú Diagrama de Cuerpo Libre (FBD)</option>
                          <option value="viga">üèóÔ∏è Viga/Estructura (Civil)</option>
                          <option value="material">üî¨ Diagrama de Materiales (Fe-C, TTT)</option>
                          <option value="mecanismo">‚öôÔ∏è Mecanismo/Articulaci√≥n</option>
                        </select>
                      </div>

                      {/* Selector de Rama */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìö</span>
                          Rama de Ingenier√≠a
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.ramaIngenieria}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, ramaIngenieria: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(239, 68, 68, 0.3)',
                            color: '#fecaca'
                          }}
                        >
                          <option value="electrica">‚ö° El√©ctrica/Electr√≥nica</option>
                          <option value="mecanica">‚öôÔ∏è Mec√°nica/Din√°mica</option>
                          <option value="materiales">üî¨ Materiales/Metalurgia</option>
                          <option value="civil">üèóÔ∏è Civil/Estructuras</option>
                        </select>
                      </div>

                      {/* Selector de Nivel */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Complejidad
                        </label>
                        <select
                          className="input-select"
                          value={formDataFlashcard.nivelIngenieria}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, nivelIngenieria: e.target.value})}
                          style={{
                            background: 'rgba(51, 65, 85, 0.4)',
                            border: '2px solid rgba(239, 68, 68, 0.3)',
                            color: '#fecaca'
                          }}
                        >
                          <option value="basico">üü¢ B√°sico (Conceptos fundamentales)</option>
                          <option value="intermedio">üü° Intermedio (Aplicaciones)</option>
                          <option value="avanzado">üî¥ Avanzado (Dise√±o/An√°lisis)</option>
                        </select>
                      </div>

                      {/* Gu√≠a seg√∫n el subtipo */}
                      <div style={{
                        marginTop: '1rem',
                        padding: '1rem',
                        background: 'rgba(239, 68, 68, 0.1)',
                        borderLeft: '3px solid #ef4444',
                        borderRadius: '8px',
                        fontSize: '0.85rem',
                        color: '#cbd5e1',
                        whiteSpace: 'pre-line'
                      }}>
                        <strong style={{color: '#fca5a5'}}>üí° Gu√≠a para {
                          formDataFlashcard.subtipoIngenieria === 'circuito' ? 'Circuitos El√©ctricos' :
                          formDataFlashcard.subtipoIngenieria === 'fbd' ? 'FBD (Diagrama de Cuerpo Libre)' :
                          formDataFlashcard.subtipoIngenieria === 'viga' ? 'Vigas y Estructuras' :
                          formDataFlashcard.subtipoIngenieria === 'material' ? 'Diagramas de Materiales' :
                          'Mecanismos'
                        }:</strong>
                        <div style={{marginTop: '0.5rem', lineHeight: '1.6'}}>
                          {formDataFlashcard.subtipoIngenieria === 'circuito' && 
                            '‚Ä¢ Lista componentes: [Resistencia] R = 10Œ©, [Capacitor] C = 100ŒºF\n‚Ä¢ Indica conexiones: serie, paralelo, nodos\n‚Ä¢ Pregunta: "Calcula corriente total", "Voltaje en R2"\n‚Ä¢ Ejemplo: Divisor de voltaje, filtro RC, puente de Wheatstone'
                          }
                          {formDataFlashcard.subtipoIngenieria === 'fbd' && 
                            '‚Ä¢ Describe fuerzas: [Peso] 50N ‚Üì, [Normal] N ‚Üë, [Fricci√≥n] 15N ‚Üê\n‚Ä¢ Identifica apoyos y restricciones\n‚Ä¢ Pregunta: "Suma de fuerzas", "Aceleraci√≥n del bloque"\n‚Ä¢ Ejemplo: Bloque en rampa, sistema de poleas, viga en equilibrio'
                          }
                          {formDataFlashcard.subtipoIngenieria === 'viga' && 
                            '‚Ä¢ Especifica: [Viga] L=5m, [Apoyo Simple] x=0, [Carga] P=10kN\n‚Ä¢ Indica tipo de apoyo (simple, empotrado, rodillo)\n‚Ä¢ Pregunta: "Reacciones", "Diagrama de momento"\n‚Ä¢ Ejemplo: Viga simplemente apoyada, voladizo, viga continua'
                          }
                          {formDataFlashcard.subtipoIngenieria === 'material' && 
                            '‚Ä¢ Describe fase o regi√≥n: [Diagrama Fe-C] 0.8% C, 727¬∞C ‚Üí Eutectoide\n‚Ä¢ Identifica microestructura: [Perlita], [Martensita]\n‚Ä¢ Pregunta: "¬øQu√© fase?", "Tratamiento t√©rmico"\n‚Ä¢ Ejemplo: Punto eut√©ctico, transformaci√≥n TTT, red cristalina'
                          }
                          {formDataFlashcard.subtipoIngenieria === 'mecanismo' && 
                            '‚Ä¢ Componentes: [Bisagra] punto A, [Slider] eje X, [Resorte] k=500N/m\n‚Ä¢ Describe movimiento: rotaci√≥n, traslaci√≥n, DOF\n‚Ä¢ Pregunta: "Grados de libertad", "Velocidad del punto B"\n‚Ä¢ Ejemplo: Mecanismo de 4 barras, leva-seguidor, engranajes'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* ========== CONFIGURACI√ìN ESPEC√çFICA PARA PROGRAMACI√ìN AVANZADA ========== */}
                  {formDataFlashcard.tipo === 'programacion-avanzada' && (
                    <>
                      {/* Selector de Subtipo de Diagrama */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìê</span>
                          Tipo de Diagrama
                        </label>
                        <select
                          value={formDataFlashcard.subtipoProgramacion}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            subtipoProgramacion: e.target.value
                          })}
                          style={{
                            width: '100%',
                            padding: '0.75rem 1rem',
                            background: 'rgba(139, 92, 246, 0.1)',
                            border: '2px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '10px',
                            color: '#e9d5ff',
                            fontSize: '1rem',
                            cursor: 'pointer'
                          }}
                        >
                          <option value="uml">üü£ UML (Clases/Interfaces/Relaciones)</option>
                          <option value="flujo">üü° Diagrama de Flujo</option>
                          <option value="algoritmo">üü© Tabla de Algoritmo</option>
                          <option value="grafo">üîµ √Årbol/Grafo</option>
                          <option value="automata">üü† Aut√≥mata Finito</option>
                        </select>
                      </div>

                      {/* Selector de Patr√≥n/Tipo */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üéØ</span>
                          Patr√≥n o Tipo Espec√≠fico
                        </label>
                        <select
                          value={formDataFlashcard.patronProgramacion}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            patronProgramacion: e.target.value
                          })}
                          style={{
                            width: '100%',
                            padding: '0.75rem 1rem',
                            background: 'rgba(139, 92, 246, 0.1)',
                            border: '2px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '10px',
                            color: '#e9d5ff',
                            fontSize: '1rem',
                            cursor: 'pointer'
                          }}
                        >
                          {formDataFlashcard.subtipoProgramacion === 'uml' && (
                            <>
                              <option value="clase">üì¶ Diagrama de Clases</option>
                              <option value="secuencia">‚è±Ô∏è Diagrama de Secuencia</option>
                              <option value="casos-uso">üë§ Casos de Uso</option>
                              <option value="actividad">üîÑ Diagrama de Actividad</option>
                              <option value="componentes">üß© Diagrama de Componentes</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoProgramacion === 'flujo' && (
                            <>
                              <option value="algoritmo">üî¢ Algoritmo B√°sico</option>
                              <option value="validacion">‚úÖ Validaci√≥n/Verificaci√≥n</option>
                              <option value="proceso">‚öôÔ∏è Proceso de Negocio</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoProgramacion === 'algoritmo' && (
                            <>
                              <option value="pseudocodigo">üìù Pseudoc√≥digo</option>
                              <option value="complejidad">‚è±Ô∏è An√°lisis de Complejidad</option>
                              <option value="traza">üîç Traza de Ejecuci√≥n</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoProgramacion === 'grafo' && (
                            <>
                              <option value="arbol-binario">üå≥ √Årbol Binario</option>
                              <option value="grafo-dirigido">‚û°Ô∏è Grafo Dirigido</option>
                              <option value="grafo-ponderado">‚öñÔ∏è Grafo Ponderado</option>
                              <option value="bfs-dfs">üîç Recorrido BFS/DFS</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoProgramacion === 'automata' && (
                            <>
                              <option value="afd">üéØ AFD (Aut√≥mata Finito Determinista)</option>
                              <option value="afn">üîÄ AFN (Aut√≥mata Finito No Determinista)</option>
                              <option value="pushdown">üìö Aut√≥mata Pushdown</option>
                              <option value="turing">üñ•Ô∏è M√°quina de Turing</option>
                            </>
                          )}
                        </select>
                      </div>

                      {/* Selector de Nivel */}
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Complejidad
                        </label>
                        <select
                          value={formDataFlashcard.nivelProgramacion}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            nivelProgramacion: e.target.value
                          })}
                          style={{
                            width: '100%',
                            padding: '0.75rem 1rem',
                            background: 'rgba(139, 92, 246, 0.1)',
                            border: '2px solid rgba(139, 92, 246, 0.3)',
                            borderRadius: '10px',
                            color: '#e9d5ff',
                            fontSize: '1rem',
                            cursor: 'pointer'
                          }}
                        >
                          <option value="basico">üü¢ B√°sico - Introducci√≥n</option>
                          <option value="intermedio">üü° Intermedio - Aplicaci√≥n</option>
                          <option value="avanzado">üü£ Avanzado - Dominio</option>
                        </select>
                      </div>

                      {/* Gu√≠a contextual espec√≠fica */}
                      <div style={{
                        marginTop: '1rem',
                        padding: '1rem',
                        background: 'rgba(139, 92, 246, 0.1)',
                        borderLeft: '4px solid #8b5cf6',
                        borderRadius: '8px',
                        fontSize: '0.85rem',
                        color: '#ddd6fe',
                        lineHeight: '1.6'
                      }}>
                        <strong style={{color: '#e9d5ff'}}>üí° Gu√≠a para {
                          formDataFlashcard.subtipoProgramacion === 'uml' ? 'UML' :
                          formDataFlashcard.subtipoProgramacion === 'flujo' ? 'Diagramas de Flujo' :
                          formDataFlashcard.subtipoProgramacion === 'algoritmo' ? 'Tablas de Algoritmos' :
                          formDataFlashcard.subtipoProgramacion === 'grafo' ? '√Årboles y Grafos' :
                          'Aut√≥matas Finitos'
                        }:</strong>
                        <div style={{marginTop: '0.5rem'}}>
                          {formDataFlashcard.subtipoProgramacion === 'uml' && 
                            '‚Ä¢ Define clases: [Clase] Usuario {+id, +nombre} {+login(), +logout()}\n‚Ä¢ Especifica relaciones: [Herencia] Usuario --|> Persona\n‚Ä¢ Pregunta: "Identifica el patr√≥n", "Completa el diagrama"\n‚Ä¢ Ejemplo: Sistema de biblioteca, red social, e-commerce'
                          }
                          {formDataFlashcard.subtipoProgramacion === 'flujo' && 
                            '‚Ä¢ Secuencia l√≥gica: [Inicio] ‚Üí [Proceso] Validar ‚Üí [Decisi√≥n] ¬øV√°lido?\n‚Ä¢ Usa formas est√°ndar: Proceso (rect√°ngulo), Decisi√≥n (rombo)\n‚Ä¢ Pregunta: "Traza el flujo", "Encuentra el error"\n‚Ä¢ Ejemplo: Login, b√∫squeda binaria, ordenamiento'
                          }
                          {formDataFlashcard.subtipoProgramacion === 'algoritmo' && 
                            '‚Ä¢ Tabla: [Paso | Acci√≥n] 1. Leer datos | 2. Ordenar\n‚Ä¢ Complejidad: [Caso | O()] Mejor: O(n) | Peor: O(n¬≤)\n‚Ä¢ Pregunta: "Analiza complejidad", "Completa traza"\n‚Ä¢ Ejemplo: Bubble sort, merge sort, b√∫squeda'
                          }
                          {formDataFlashcard.subtipoProgramacion === 'grafo' && 
                            '‚Ä¢ Nodos y aristas: [Nodo] 5, [Arista] A --> B (peso: 3)\n‚Ä¢ Especifica tipo: √°rbol binario, grafo dirigido, ponderado\n‚Ä¢ Pregunta: "Recorrido BFS/DFS", "Camino m√°s corto"\n‚Ä¢ Ejemplo: BST, grafo de rutas, √°rbol de expresi√≥n'
                          }
                          {formDataFlashcard.subtipoProgramacion === 'automata' && 
                            '‚Ä¢ Estados: [Estado Inicial] q0, [Estado Aceptaci√≥n] q2\n‚Ä¢ Transiciones: [Transici√≥n] q0 --a--> q1\n‚Ä¢ Pregunta: "Cadena aceptada?", "Completa aut√≥mata"\n‚Ä¢ Ejemplo: Reconocedor de patrones, validador, parser'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* Configuraci√≥n L√≥gica/Discreta */}
                  {formDataFlashcard.tipo === 'logica-discreta' && (
                    <>
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üîÆ</span>
                          Tipo de Estructura
                        </label>
                        <select
                          value={formDataFlashcard.subtipoDiscreta}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            subtipoDiscreta: e.target.value
                          })}
                          className="select-control"
                        >
                          <option value="logica">üü£ L√≥gica Proposicional</option>
                          <option value="conjuntos">üü´ Teor√≠a de Conjuntos</option>
                          <option value="venn">üü¢ Diagramas de Venn</option>
                          <option value="relaciones">üîµ Relaciones</option>
                          <option value="grafos">‚ö´ Grafos Discretos</option>
                          <option value="predicados">üü† L√≥gica de Predicados</option>
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üéØ</span>
                          Categor√≠a Espec√≠fica
                        </label>
                        <select
                          value={formDataFlashcard.categoriaDiscreta}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            categoriaDiscreta: e.target.value
                          })}
                          className="select-control"
                        >
                          {formDataFlashcard.subtipoDiscreta === 'logica' && (
                            <>
                              <option value="proposicional">Proposiciones (p, q, r)</option>
                              <option value="conectivos">Conectivos (¬¨, ‚àß, ‚à®, ‚Üí)</option>
                              <option value="tablas">Tablas de Verdad</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoDiscreta === 'conjuntos' && (
                            <>
                              <option value="operaciones">Operaciones (‚à™, ‚à©, \)</option>
                              <option value="relaciones">Relaciones (‚äÇ, ‚äÜ, ‚àà)</option>
                              <option value="numericos">Conjuntos Num√©ricos (‚Ñï, ‚Ñ§, ‚Ñö, ‚Ñù)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoDiscreta === 'venn' && (
                            <>
                              <option value="dos">Venn 2 C√≠rculos</option>
                              <option value="tres">Venn 3 C√≠rculos</option>
                              <option value="regiones">Regiones y Operaciones</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoDiscreta === 'relaciones' && (
                            <>
                              <option value="pares">Pares Ordenados</option>
                              <option value="matrices">Matrices de Relaci√≥n</option>
                              <option value="propiedades">Propiedades (Reflexiva, Sim√©trica)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoDiscreta === 'grafos' && (
                            <>
                              <option value="dirigidos">Grafos Dirigidos</option>
                              <option value="nodirigi">Grafos No Dirigidos</option>
                              <option value="especiales">Grafos Especiales (K‚ÇÉ, K‚ÇÑ)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoDiscreta === 'predicados' && (
                            <>
                              <option value="cuantificadores">Cuantificadores (‚àÄ, ‚àÉ)</option>
                              <option value="predicados">Predicados P(x)</option>
                              <option value="formulas">F√≥rmulas Bien Formadas</option>
                            </>
                          )}
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Complejidad
                        </label>
                        <select
                          value={formDataFlashcard.nivelDiscreta}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            nivelDiscreta: e.target.value
                          })}
                          className="select-control"
                        >
                          <option value="basico">üü¢ B√°sico - S√≠mbolos y operaciones simples</option>
                          <option value="intermedio">üü° Intermedio - Tablas de verdad, Venn 3</option>
                          <option value="avanzado">üî¥ Avanzado - Grafos complejos, predicados</option>
                        </select>
                      </div>

                      <div className="info-box" style={{background: 'rgba(124, 58, 237, 0.1)', borderLeft: '4px solid #7c3aed'}}>
                        <strong>üí° {
                          formDataFlashcard.subtipoDiscreta === 'logica' ? 'L√≥gica Proposicional' :
                          formDataFlashcard.subtipoDiscreta === 'conjuntos' ? 'Teor√≠a de Conjuntos' :
                          formDataFlashcard.subtipoDiscreta === 'venn' ? 'Diagramas de Venn' :
                          formDataFlashcard.subtipoDiscreta === 'relaciones' ? 'Relaciones' :
                          formDataFlashcard.subtipoDiscreta === 'grafos' ? 'Grafos Discretos' :
                          'L√≥gica de Predicados'
                        }:</strong>
                        <div style={{marginTop: '0.5rem'}}>
                          {formDataFlashcard.subtipoDiscreta === 'logica' && 
                            '‚Ä¢ Usa s√≠mbolos: ¬¨ (negaci√≥n), ‚àß (conjunci√≥n), ‚à® (disyunci√≥n), ‚Üí (implicaci√≥n)\n‚Ä¢ Crea tablas de verdad interactivas\n‚Ä¢ Pregunta: "Eval√∫a ¬¨p ‚à® q", "Construye tabla de p ‚Üí q"\n‚Ä¢ Ejemplo: (p ‚àß q) ‚Üí r, ¬¨(p ‚à® ¬¨q)'
                          }
                          {formDataFlashcard.subtipoDiscreta === 'conjuntos' && 
                            '‚Ä¢ Operaciones: A ‚à™ B, A ‚à© B, A \\ B, A √ó B\n‚Ä¢ Relaciones: ‚äÇ (subconjunto), ‚àà (pertenece), ‚àÖ (vac√≠o)\n‚Ä¢ Pregunta: "Calcula A ‚à© B", "¬øEs A ‚äÇ B?"\n‚Ä¢ Ejemplo: A = {1,2,3}, B = {2,3,4}, A ‚à™ B = {1,2,3,4}'
                          }
                          {formDataFlashcard.subtipoDiscreta === 'venn' && 
                            '‚Ä¢ Representa conjuntos visualmente con c√≠rculos\n‚Ä¢ Identifica regiones: solo A, A‚à©B, A‚à™B, universo\n‚Ä¢ Pregunta: "Sombrea A‚à©B", "Identifica regi√≥n"\n‚Ä¢ Ejemplo: Venn 3 con A, B, C y todas las intersecciones'
                          }
                          {formDataFlashcard.subtipoDiscreta === 'relaciones' && 
                            '‚Ä¢ Pares ordenados: R = {(1,2), (2,3), (3,1)}\n‚Ä¢ Matrices: representa relaci√≥n como matriz 0/1\n‚Ä¢ Propiedades: reflexiva, sim√©trica, transitiva\n‚Ä¢ Pregunta: "¬øEs sim√©trica?", "Completa matriz"\n‚Ä¢ Ejemplo: Relaci√≥n "es m√∫ltiplo de" en ‚Ñï'
                          }
                          {formDataFlashcard.subtipoDiscreta === 'grafos' && 
                            '‚Ä¢ Nodos y aristas: [A] ---> [B], [C] <---> [D]\n‚Ä¢ Pesos: arista con valor num√©rico\n‚Ä¢ Tipos: dirigidos, no dirigidos, completos (K‚Çô)\n‚Ä¢ Pregunta: "Encuentra camino", "¬øEs conexo?"\n‚Ä¢ Ejemplo: K‚ÇÑ, √°rbol, ciclo C‚ÇÖ'
                          }
                          {formDataFlashcard.subtipoDiscreta === 'predicados' && 
                            '‚Ä¢ Cuantificadores: ‚àÄx P(x) (para todo), ‚àÉx P(x) (existe)\n‚Ä¢ Predicados: P(x): "x es par", Q(x,y): "x > y"\n‚Ä¢ Pregunta: "Niega ‚àÄx P(x)", "Interpreta ‚àÉx (P(x) ‚àß Q(x))"\n‚Ä¢ Ejemplo: ‚àÄx‚àà‚Ñï (x‚â•0), ‚àÉx‚àà‚Ñ§ (x¬≤=4)'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* Configuraci√≥n Ling√º√≠stica/Fon√©tica */}
                  {formDataFlashcard.tipo === 'linguistica' && (
                    <>
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üó£Ô∏è</span>
                          Tipo de Contenido
                        </label>
                        <select
                          value={formDataFlashcard.subtipoLinguistica}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            subtipoLinguistica: e.target.value
                          })}
                          className="select-control"
                        >
                          <option value="ipa">üî§ S√≠mbolos IPA</option>
                          <option value="stress">üéµ Acento y Entonaci√≥n</option>
                          <option value="diagrams">üìê Diagramas de Articulaci√≥n</option>
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üéØ</span>
                          Categor√≠a Fon√©tica
                        </label>
                        <select
                          value={formDataFlashcard.categoriaLinguistica}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            categoriaLinguistica: e.target.value
                          })}
                          className="select-control"
                        >
                          {formDataFlashcard.subtipoLinguistica === 'ipa' && (
                            <>
                              <option value="vocales">Vocales IPA (iÀê, …™, e, √¶...)</option>
                              <option value="consonantes">Consonantes (Œ∏, √∞,  É,  í...)</option>
                              <option value="diptongos">Diptongos (e…™, a…™, …î…™...)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoLinguistica === 'stress' && (
                            <>
                              <option value="primario">Acento Primario (Àà)</option>
                              <option value="secundario">Acento Secundario (Àå)</option>
                              <option value="entonacion">Flechas Entonaci√≥n (‚Üó ‚Üò ‚Üí)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoLinguistica === 'diagrams' && (
                            <>
                              <option value="vocales_mapa">Mapa de Vocales</option>
                              <option value="lengua">Posici√≥n de la Lengua</option>
                              <option value="modo_lugar">Modo y Lugar de Articulaci√≥n</option>
                            </>
                          )}
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Complejidad
                        </label>
                        <select
                          value={formDataFlashcard.nivelLinguistica}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            nivelLinguistica: e.target.value
                          })}
                          className="select-control"
                        >
                          <option value="basico">üü¢ B√°sico - Vocales y consonantes comunes</option>
                          <option value="intermedio">üü° Intermedio - Diptongos, stress patterns</option>
                          <option value="avanzado">üî¥ Avanzado - Diagramas articulaci√≥n, al√≥fonos</option>
                        </select>
                      </div>

                      <div className="info-box" style={{background: 'rgba(236, 72, 153, 0.1)', borderLeft: '4px solid #ec4899'}}>
                        <strong>üí° {
                          formDataFlashcard.subtipoLinguistica === 'ipa' ? 'S√≠mbolos IPA' :
                          formDataFlashcard.subtipoLinguistica === 'stress' ? 'Acento y Entonaci√≥n' :
                          'Diagramas de Articulaci√≥n'
                        }:</strong>
                        <div style={{marginTop: '0.5rem'}}>
                          {formDataFlashcard.subtipoLinguistica === 'ipa' && 
                            '‚Ä¢ Vocales largas: iÀê (sheep), uÀê (food), …ëÀê (car)\n‚Ä¢ Vocales cortas: …™ (sit),  ä (good), …ô (about)\n‚Ä¢ Consonantes: Œ∏ (think), √∞ (this),  É (she),  í (measure)\n‚Ä¢ Pregunta: "Transcribe /Œ∏…™≈ãk/", "Identifica vocal en /k√¶t/"\n‚Ä¢ Ejemplo: /Ààw…îÀêt…ô/ (water), /Ààh√¶pi/ (happy)'
                          }
                          {formDataFlashcard.subtipoLinguistica === 'stress' && 
                            '‚Ä¢ Acento primario: Àà antes de s√≠laba t√≥nica (Ààhello)\n‚Ä¢ Acento secundario: Àå para s√≠labas secundarias\n‚Ä¢ Entonaci√≥n: ‚Üó (ascendente), ‚Üò (descendente), ‚Üí (plana)\n‚Ä¢ Pregunta: "Marca acento en photograph", "Identifica entonaci√≥n"\n‚Ä¢ Ejemplo: Ààf…ít…ôÀågr√¶f (photograph), hello ‚Üó (pregunta)'
                          }
                          {formDataFlashcard.subtipoLinguistica === 'diagrams' && 
                            '‚Ä¢ Mapa vocales: eje frontal/posterior, alto/medio/bajo\n‚Ä¢ Lengua: posici√≥n para cada vocal (alta, media, baja)\n‚Ä¢ Modo articulaci√≥n: oclusiva, fricativa, nasal\n‚Ä¢ Lugar: bilabial, alveolar, velar\n‚Ä¢ Pregunta: "Identifica posici√≥n de /i/", "Clasifica /p/"\n‚Ä¢ Ejemplo: /p/ = bilabial oclusiva sorda'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* Configuraci√≥n M√∫sica/Teor√≠a Musical */}
                  {formDataFlashcard.tipo === 'musica' && (
                    <>
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üéº</span>
                          Tipo de Contenido Musical
                        </label>
                        <select
                          value={formDataFlashcard.subtipoMusica}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            subtipoMusica: e.target.value
                          })}
                          className="select-control"
                        >
                          <option value="pentagramas">üéº Pentagramas y Compases</option>
                          <option value="notas">üéµ Notas Musicales</option>
                          <option value="acordes">üé∏ Acordes</option>
                          <option value="intervalos">üìè Intervalos</option>
                          <option value="escalas">üéπ Escalas</option>
                          <option value="progresiones">üîÑ Progresiones Arm√≥nicas</option>
                          <option value="ritmo">ü•Å Ritmo y Estructura</option>
                          <option value="simbolos">‚ôØ‚ô≠ S√≠mbolos Musicales</option>
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üéØ</span>
                          Categor√≠a Musical
                        </label>
                        <select
                          value={formDataFlashcard.categoriaMusica}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            categoriaMusica: e.target.value
                          })}
                          className="select-control"
                        >
                          {formDataFlashcard.subtipoMusica === 'pentagramas' && (
                            <>
                              <option value="claves">Claves (Sol, Fa, Do)</option>
                              <option value="compases">Compases (4/4, 3/4, 6/8)</option>
                              <option value="barras">Barras de comp√°s</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'notas' && (
                            <>
                              <option value="figuras">Figuras (redonda, blanca, negra)</option>
                              <option value="alturas">Alturas (Do, Re, Mi...)</option>
                              <option value="duraciones">Duraciones y puntillos</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'acordes' && (
                            <>
                              <option value="triadas">Tr√≠adas (mayor, menor, dim, aug)</option>
                              <option value="septima">Acordes de 7¬™ (maj7, m7, 7)</option>
                              <option value="extensiones">Extensiones (9, 11, 13)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'intervalos' && (
                            <>
                              <option value="simples">Intervalos simples (2¬™-8¬™)</option>
                              <option value="compuestos">Intervalos compuestos</option>
                              <option value="calidad">Calidad (M, m, P, A, d)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'escalas' && (
                            <>
                              <option value="mayores-menores">Escalas mayor y menor</option>
                              <option value="modos">Modos griegos</option>
                              <option value="pentatonicas">Pentat√≥nicas y blues</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'progresiones' && (
                            <>
                              <option value="tonales">Progresiones tonales (I-IV-V)</option>
                              <option value="jazz">Progresiones jazz (ii-V-I)</option>
                              <option value="pop">Progresiones pop (vi-IV-I-V)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'ritmo' && (
                            <>
                              <option value="silencios">Silencios</option>
                              <option value="patrones">Patrones r√≠tmicos</option>
                              <option value="subdivisiones">Subdivisiones</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'simbolos' && (
                            <>
                              <option value="alteraciones">Alteraciones (‚ôØ ‚ô≠ ‚ôÆ)</option>
                              <option value="dinamicas">Din√°micas (f, p, mf, mp)</option>
                              <option value="articulaciones">Articulaciones</option>
                            </>
                          )}
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Complejidad
                        </label>
                        <select
                          value={formDataFlashcard.nivelMusica}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            nivelMusica: e.target.value
                          })}
                          className="select-control"
                        >
                          <option value="basico">üü¢ B√°sico - Notas, figuras, acordes simples</option>
                          <option value="intermedio">üü° Intermedio - Escalas, progresiones comunes</option>
                          <option value="avanzado">üî¥ Avanzado - Modos, jazz, an√°lisis arm√≥nico</option>
                        </select>
                      </div>

                      <div className="info-box" style={{background: 'rgba(168, 85, 247, 0.1)', borderLeft: '4px solid #a855f7'}}>
                        <strong>üí° {
                          formDataFlashcard.subtipoMusica === 'pentagramas' ? 'Pentagramas y Compases' :
                          formDataFlashcard.subtipoMusica === 'notas' ? 'Notas Musicales' :
                          formDataFlashcard.subtipoMusica === 'acordes' ? 'Acordes' :
                          formDataFlashcard.subtipoMusica === 'intervalos' ? 'Intervalos' :
                          formDataFlashcard.subtipoMusica === 'escalas' ? 'Escalas' :
                          formDataFlashcard.subtipoMusica === 'progresiones' ? 'Progresiones Arm√≥nicas' :
                          formDataFlashcard.subtipoMusica === 'ritmo' ? 'Ritmo y Estructura' :
                          'S√≠mbolos Musicales'
                        }:</strong>
                        <div style={{marginTop: '0.5rem'}}>
                          {formDataFlashcard.subtipoMusica === 'pentagramas' && 
                            '‚Ä¢ Pentagramas con claves: ùÑû (sol), ùÑ¢ (fa), ùÑ° (do)\n‚Ä¢ Compases: 4/4, 3/4, 6/8, 2/4\n‚Ä¢ Barras: | (simple), || (doble), ||: (final)\n‚Ä¢ Pregunta: "Dibuja pentagrama con clave de fa", "Marca comp√°s 3/4"'
                          }
                          {formDataFlashcard.subtipoMusica === 'notas' && 
                            '‚Ä¢ Figuras: ùÖù (redonda), ùÖóùÖ• (blanca), ‚ô© (negra), ‚ô™ (corchea)\n‚Ä¢ Alturas: C D E F G A B (Do Re Mi Fa Sol La Si)\n‚Ä¢ Puntillo (¬∑) aumenta 50% la duraci√≥n\n‚Ä¢ Pregunta: "Identifica figura", "Escribe nota Mi", "Duraci√≥n de blanca con puntillo"'
                          }
                          {formDataFlashcard.subtipoMusica === 'acordes' && 
                            '‚Ä¢ Tr√≠adas: C (mayor), Cm (menor), Cdim (disminuido), Caug (aumentado)\n‚Ä¢ S√©ptimas: Cmaj7, Cm7, C7, Cdim7\n‚Ä¢ Slash chords: C/E (bajo diferente)\n‚Ä¢ Pregunta: "Construye acorde Cmaj7", "Identifica tr√≠ada", "Funciona como dominante?"'
                          }
                          {formDataFlashcard.subtipoMusica === 'intervalos' && 
                            '‚Ä¢ Notaci√≥n: m2, M2, m3, M3, P4, A4, P5, m6, M6, m7, M7, P8\n‚Ä¢ Calidad: M (mayor), m (menor), P (justa), A (aumentada), d (disminuida)\n‚Ä¢ Pregunta: "Intervalo de C a E?", "3¬™ menor desde Re?", "Identifica P5"'
                          }
                          {formDataFlashcard.subtipoMusica === 'escalas' && 
                            '‚Ä¢ Mayor: C-D-E-F-G-A-B-C (T-T-S-T-T-T-S)\n‚Ä¢ Menor natural: A-B-C-D-E-F-G-A (T-S-T-T-S-T-T)\n‚Ä¢ Modos: J√≥nico, D√≥rico, Frigio, Lidio, Mixolidio, E√≥lico, Locrio\n‚Ä¢ Pentat√≥nicas: 5 notas sin semitonos\n‚Ä¢ Pregunta: "Construye escala Re mayor", "Modo frigio desde Mi", "Pentat√≥nica menor de La"'
                          }
                          {formDataFlashcard.subtipoMusica === 'progresiones' && 
                            '‚Ä¢ Tonales: | I | IV | V | I | (rock/pop)\n‚Ä¢ Jazz: | iim7 | V7 | Imaj7 | (cadencia ii-V-I)\n‚Ä¢ Pop: | vi | IV | I | V | (eje de la balada)\n‚Ä¢ C√≠rculo de quintas: C‚ÜíF‚ÜíB‚ô≠‚ÜíE‚ô≠...\n‚Ä¢ Pregunta: "Completa progresi√≥n I-?-V", "Identifica funci√≥n dominante", "Transporta a Sol mayor"'
                          }
                          {formDataFlashcard.subtipoMusica === 'ritmo' && 
                            '‚Ä¢ Silencios: ùÑª (redonda), ùÑº (blanca), ùÑΩ (negra), ùÑæ (corchea)\n‚Ä¢ Tresillo: [3] 3 notas en tiempo de 2\n‚Ä¢ Comp√°s simple: subdivisi√≥n binaria (4/4)\n‚Ä¢ Comp√°s compuesto: subdivisi√≥n ternaria (6/8)\n‚Ä¢ Pregunta: "Dibuja patr√≥n r√≠tmico", "Completa comp√°s", "Identifica tresillo"'
                          }
                          {formDataFlashcard.subtipoMusica === 'simbolos' && 
                            '‚Ä¢ Alteraciones: ‚ôØ (sostenido +¬Ω tono), ‚ô≠ (bemol -¬Ω tono), ‚ôÆ (becuadro cancela)\n‚Ä¢ Din√°micas: f (forte), p (piano), mf, mp, ff, pp\n‚Ä¢ Articulaciones: ¬∑ (staccato), > (acento), ‚å¢ (ligadura)\n‚Ä¢ Otros: ùÑê (calder√≥n), tr~~~ (trino)\n‚Ä¢ Pregunta: "¬øQu√© es ‚ôØ?", "Interpreta mf", "Dibuja staccato"'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* Configuraci√≥n Geometr√≠a */}
                  {formDataFlashcard.tipo === 'geometria' && (
                    <>
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìê</span>
                          Tipo de Objeto Geom√©trico
                        </label>
                        <select
                          value={formDataFlashcard.subtipoGeometria}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            subtipoGeometria: e.target.value
                          })}
                          className="select-control"
                        >
                          <option value="puntos">‚ö´ Puntos</option>
                          <option value="rectas">üìè Rectas y Segmentos</option>
                          <option value="angulos">üìê √Ångulos</option>
                          <option value="poligonos">üî∑ Pol√≠gonos</option>
                          <option value="circulos">‚≠ï C√≠rculos</option>
                          <option value="construcciones">üî® Construcciones</option>
                          <option value="flechas">‚û°Ô∏è Flechas y Notaci√≥n</option>
                          <option value="medidas">üìä Medidas y Trigonometr√≠a</option>
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üéØ</span>
                          Categor√≠a Geom√©trica
                        </label>
                        <select
                          value={formDataFlashcard.categoriaGeometria}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            categoriaGeometria: e.target.value
                          })}
                          className="select-control"
                        >
                          {formDataFlashcard.subtipoGeometria === 'puntos' && (
                            <>
                              <option value="basicos">Puntos b√°sicos (A, B, C)</option>
                              <option value="coordenadas">Coordenadas (x, y)</option>
                              <option value="especiales">Puntos especiales</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'rectas' && (
                            <>
                              <option value="segmentos">Segmentos ABÃÖ</option>
                              <option value="rectas-infinitas">Rectas infinitas ‚Üî</option>
                              <option value="relaciones">Relaciones (‚üÇ, ‚à•)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'angulos' && (
                            <>
                              <option value="tipos">Tipos (agudo, recto, obtuso)</option>
                              <option value="medidas-grados">Medidas en grados</option>
                              <option value="medidas-radianes">Medidas en radianes (œÄ/6, œÄ/4)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'poligonos' && (
                            <>
                              <option value="triangulos">Tri√°ngulos</option>
                              <option value="cuadrilateros">Cuadril√°teros</option>
                              <option value="regulares">Pol√≠gonos regulares</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'circulos' && (
                            <>
                              <option value="basicos">C√≠rculos y circunferencias</option>
                              <option value="arcos">Arcos y sectores</option>
                              <option value="elementos">Elementos (radio, cuerda, tangente)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'construcciones' && (
                            <>
                              <option value="mediatriz-bisectriz">Mediatriz y bisectriz</option>
                              <option value="puntos-notables">Puntos notables del tri√°ngulo</option>
                              <option value="perpendiculares">Perpendiculares y paralelas</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'flechas' && (
                            <>
                              <option value="direccionales">Flechas direccionales</option>
                              <option value="vectores">Vectores</option>
                              <option value="marcas">Marcas y etiquetas</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'medidas' && (
                            <>
                              <option value="longitudes">Longitudes y distancias</option>
                              <option value="areas-perimetros">√Åreas y per√≠metros</option>
                              <option value="trigonometria">Trigonometr√≠a</option>
                            </>
                          )}
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Complejidad
                        </label>
                        <select
                          value={formDataFlashcard.nivelGeometria}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard,
                            nivelGeometria: e.target.value
                          })}
                          className="select-control"
                        >
                          <option value="basico">üü¢ B√°sico - Puntos, rectas, √°ngulos simples</option>
                          <option value="intermedio">üü° Intermedio - Pol√≠gonos, construcciones, œÄ/4</option>
                          <option value="avanzado">üî¥ Avanzado - Trigonometr√≠a, puntos notables, demostraciones</option>
                        </select>
                      </div>

                      <div className="info-box" style={{background: 'rgba(34, 197, 94, 0.1)', borderLeft: '4px solid #22c55e'}}>
                        <strong>üí° {
                          formDataFlashcard.subtipoGeometria === 'puntos' ? 'Puntos' :
                          formDataFlashcard.subtipoGeometria === 'rectas' ? 'Rectas y Segmentos' :
                          formDataFlashcard.subtipoGeometria === 'angulos' ? '√Ångulos' :
                          formDataFlashcard.subtipoGeometria === 'poligonos' ? 'Pol√≠gonos' :
                          formDataFlashcard.subtipoGeometria === 'circulos' ? 'C√≠rculos' :
                          formDataFlashcard.subtipoGeometria === 'construcciones' ? 'Construcciones' :
                          formDataFlashcard.subtipoGeometria === 'flechas' ? 'Flechas y Notaci√≥n' :
                          'Medidas y Trigonometr√≠a'
                        }:</strong>
                        <div style={{marginTop: '0.5rem'}}>
                          {formDataFlashcard.subtipoGeometria === 'puntos' && 
                            '‚Ä¢ Puntos etiquetados: ‚Ä¢ A, ‚Ä¢ B, ‚Ä¢ C\n‚Ä¢ Coordenadas: P(x, y), origen O(0,0)\n‚Ä¢ Puntos especiales: punto medio M, fijos (‚ú±), m√≥viles (‚óã)\n‚Ä¢ Pregunta: "Marca punto medio de AB", "Coordenadas de P", "Identifica punto fijo"'
                          }
                          {formDataFlashcard.subtipoGeometria === 'rectas' && 
                            '‚Ä¢ Segmento: ABÃÖ (limitado)\n‚Ä¢ Recta: ‚Üê‚Üí (infinita)\n‚Ä¢ Semirrecta: AB‚Üí (un extremo)\n‚Ä¢ Vector: AB‚Éó (direcci√≥n y magnitud)\n‚Ä¢ Relaciones: AB ‚üÇ CD (perpendicular), AB ‚à• CD (paralela)\n‚Ä¢ Pregunta: "Dibuja perpendicular", "ABÃÖ = 5cm, traza paralela"'
                          }
                          {formDataFlashcard.subtipoGeometria === 'angulos' && 
                            '‚Ä¢ Tipos: agudo (<90¬∞), recto (90¬∞), obtuso (>90¬∞), llano (180¬∞)\n‚Ä¢ Grados: 30¬∞, 45¬∞, 60¬∞, 90¬∞\n‚Ä¢ Radianes: œÄ/6 (30¬∞), œÄ/4 (45¬∞), œÄ/3 (60¬∞), œÄ/2 (90¬∞)\n‚Ä¢ Marcas: ‚åí (arco), ‚üÇ (√°ngulo recto)\n‚Ä¢ Pregunta: "‚à†ABC = œÄ/4, ¬øcu√°ntos grados?", "Construye √°ngulo 60¬∞"'
                          }
                          {formDataFlashcard.subtipoGeometria === 'poligonos' && 
                            '‚Ä¢ Tri√°ngulos: ‚ñ≥ABC, rect√°ngulo (90¬∞), equil√°tero (60¬∞-60¬∞-60¬∞), is√≥sceles (2 lados =)\n‚Ä¢ Cuadril√°teros: ‚ñ° (cuadrado), ‚ñ≠ (rect√°ngulo), ‚óä (rombo), ‚ñ± (paralelogramo)\n‚Ä¢ Regulares: pent√°gono (5), hex√°gono (6), oct√°gono (8)\n‚Ä¢ Pregunta: "Clasifica tri√°ngulo", "Propiedades del rombo", "Dibuja hex√°gono regular"'
                          }
                          {formDataFlashcard.subtipoGeometria === 'circulos' && 
                            '‚Ä¢ Circunferencia: ‚óã (borde), c√≠rculo: ‚óè (relleno)\n‚Ä¢ Radio r, di√°metro d = 2r\n‚Ä¢ Arco ‚åíAB, sector circular (porci√≥n), segmento circular\n‚Ä¢ Cuerda ABÃÖ, tangente ‚Üí|, secante ‚Üî\n‚Ä¢ Pregunta: "r = 5, calcula d", "Dibuja tangente en P", "Circunferencia por 3 puntos"'
                          }
                          {formDataFlashcard.subtipoGeometria === 'construcciones' && 
                            '‚Ä¢ Mediatriz: perpendicular en punto medio de ABÃÖ\n‚Ä¢ Bisectriz: divide ‚à†ABC en 2 partes iguales\n‚Ä¢ Altura: perpendicular desde v√©rtice a lado opuesto\n‚Ä¢ Mediana: une v√©rtice con punto medio del lado opuesto\n‚Ä¢ Puntos notables: circuncentro O, baricentro G, ortocentro H, incentro I\n‚Ä¢ Pregunta: "Construye mediatriz de ABÃÖ", "Marca baricentro de ‚ñ≥ABC"'
                          }
                          {formDataFlashcard.subtipoGeometria === 'flechas' && 
                            '‚Ä¢ Direccionales: ‚Üí ‚Üê ‚Üî ‚Üë ‚Üì\n‚Ä¢ Curvas: ‚Üª ‚Ü∫ (rotaci√≥n)\n‚Ä¢ Vectores: v‚Éó, AB‚Éó\n‚Ä¢ Marcas: √ó (cruz), ‚Ä¢ (punto), ‚üÇ (perpendicular), ‚à• (paralelo)\n‚Ä¢ Etiquetas: [Label], coordenadas\n‚Ä¢ Pregunta: "Dibuja vector AB‚Éó", "Marca √°ngulo con ‚åí"'
                          }
                          {formDataFlashcard.subtipoGeometria === 'medidas' && 
                            '‚Ä¢ Longitud: |AB| = ‚ñ°, distancia d(A,B)\n‚Ä¢ √Årea: A = ‚ñ°, per√≠metro: P = ‚ñ°\n‚Ä¢ Pendiente: m = Œîy/Œîx, positiva (/) o negativa (\\)\n‚Ä¢ Trigonometr√≠a: sen Œ∏ = opuesto/hipotenusa, cos Œ∏ = adyacente/hipotenusa, tan Œ∏ = opuesto/adyacente\n‚Ä¢ Pit√°goras: a¬≤ + b¬≤ = c¬≤\n‚Ä¢ Pregunta: "Calcula √°rea del ‚ñ≥", "Pendiente de AB", "sen(30¬∞) = ?"'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* Configuraci√≥n M√∫sica/Teor√≠a Musical */}
                  {formDataFlashcard.tipo === 'musica' && (
                    <>
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üéµ</span>
                          Tipo de Contenido Musical
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.subtipoMusica || 'pentagramas'}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard, 
                            subtipoMusica: e.target.value,
                            categoriaMusica: e.target.value === 'pentagramas' ? 'claves' :
                                           e.target.value === 'notas' ? 'duraciones' :
                                           e.target.value === 'acordes' ? 'triadas' :
                                           e.target.value === 'intervalos' ? 'melodicos' :
                                           e.target.value === 'escalas' ? 'mayores' :
                                           e.target.value === 'progresiones' ? 'basicas' :
                                           e.target.value === 'ritmo' ? 'silencios' : 'alteraciones'
                          })}
                        >
                          <option value="pentagramas">üéº Pentagramas y Claves</option>
                          <option value="notas">‚ô© Notas y Duraciones</option>
                          <option value="acordes">üéπ Acordes</option>
                          <option value="intervalos">üé∂ Intervalos</option>
                          <option value="escalas">üéµ Escalas</option>
                          <option value="progresiones">üé∏ Progresiones Arm√≥nicas</option>
                          <option value="ritmo">ü•Å Ritmo y Silencios</option>
                          <option value="simbolos">‚ôØ S√≠mbolos Musicales</option>
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üéº</span>
                          Categor√≠a Musical
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.categoriaMusica || 'claves'}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, categoriaMusica: e.target.value})}
                        >
                          {formDataFlashcard.subtipoMusica === 'pentagramas' && (
                            <>
                              <option value="claves">Claves Musicales</option>
                              <option value="compases">Compases</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'notas' && (
                            <>
                              <option value="duraciones">Duraciones</option>
                              <option value="alturas">Alturas</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'acordes' && (
                            <>
                              <option value="triadas">Tr√≠adas</option>
                              <option value="septimas">S√©ptimas</option>
                              <option value="suspendidos">Suspendidos</option>
                              <option value="aumentados">Aumentados/Disminuidos</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'intervalos' && (
                            <>
                              <option value="melodicos">Mel√≥dicos</option>
                              <option value="armonicos">Arm√≥nicos</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'escalas' && (
                            <>
                              <option value="mayores">Escalas Mayores</option>
                              <option value="menores">Escalas Menores</option>
                              <option value="pentatonicas">Pentat√≥nicas</option>
                              <option value="modales">Modos Griegos</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'progresiones' && (
                            <>
                              <option value="basicas">Progresiones B√°sicas</option>
                              <option value="jazz">Progresiones Jazz</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'ritmo' && (
                            <>
                              <option value="silencios">Silencios</option>
                              <option value="ritmos">Patrones R√≠tmicos</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoMusica === 'simbolos' && (
                            <>
                              <option value="alteraciones">Alteraciones</option>
                              <option value="dinamica">Din√°mica</option>
                              <option value="articulacion">Articulaci√≥n</option>
                            </>
                          )}
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Complejidad
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.nivelMusica || 'basico'}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, nivelMusica: e.target.value})}
                        >
                          <option value="basico">üü¢ B√°sico</option>
                          <option value="intermedio">üü° Intermedio</option>
                          <option value="avanzado">üî¥ Avanzado</option>
                        </select>
                      </div>

                      <div className="info-box" style={{background: 'rgba(168, 85, 247, 0.1)', borderLeft: '4px solid #a855f7'}}>
                        <strong>üí° {
                          formDataFlashcard.subtipoMusica === 'pentagramas' ? 'Pentagramas y Claves' :
                          formDataFlashcard.subtipoMusica === 'notas' ? 'Notas y Duraciones' :
                          formDataFlashcard.subtipoMusica === 'acordes' ? 'Acordes' :
                          formDataFlashcard.subtipoMusica === 'intervalos' ? 'Intervalos' :
                          formDataFlashcard.subtipoMusica === 'escalas' ? 'Escalas' :
                          formDataFlashcard.subtipoMusica === 'progresiones' ? 'Progresiones' :
                          formDataFlashcard.subtipoMusica === 'ritmo' ? 'Ritmo' :
                          'S√≠mbolos Musicales'
                        }:</strong>
                        <div style={{marginTop: '0.5rem'}}>
                          {formDataFlashcard.subtipoMusica === 'pentagramas' && 
                            '‚Ä¢ Claves: ùÑû (Sol), ùÑ¢ (Fa), ùÑ° (Do)\n‚Ä¢ Compases: 4/4, 3/4, 6/8, 2/4, 5/4\n‚Ä¢ Pregunta: "Identifica la clave", "¬øQu√© comp√°s es este?"\n‚Ä¢ Ejemplo: ùÑû 4/4 (clave de Sol en 4/4)'
                          }
                          {formDataFlashcard.subtipoMusica === 'notas' && 
                            '‚Ä¢ Duraciones: ùÖù (redonda), ùÖóùÖ• (blanca), ‚ô© (negra), ‚ô™ (corchea), ‚ô¨ (semicorchea)\n‚Ä¢ Alturas: Do, Re, Mi, Fa, Sol, La, Si\n‚Ä¢ Pregunta: "¬øCu√°ntos tiempos dura ‚ô©?", "Identifica la nota"\n‚Ä¢ Ejemplo: ‚ô© = 1 tiempo, ùÖóùÖ• = 2 tiempos'
                          }
                          {formDataFlashcard.subtipoMusica === 'acordes' && 
                            '‚Ä¢ Tr√≠adas: Cmaj, Cm, Caug, Cdim\n‚Ä¢ S√©ptimas: Cmaj7, Cm7, C7, Cdim7\n‚Ä¢ Suspendidos: Csus2, Csus4\n‚Ä¢ Pregunta: "¬øQu√© notas tiene Cmaj7?", "Identifica el acorde"\n‚Ä¢ Ejemplo: Cmaj7 = Do-Mi-Sol-Si'
                          }
                          {formDataFlashcard.subtipoMusica === 'intervalos' && 
                            '‚Ä¢ Intervalos: m2, M2, m3, M3, P4, TT, P5, m6, M6, m7, M7, P8\n‚Ä¢ Pregunta: "¬øQu√© intervalo hay entre Do y Mi?", "Identifica el intervalo"\n‚Ä¢ Ejemplo: Do‚ÜíMi = M3 (tercera mayor)'
                          }
                          {formDataFlashcard.subtipoMusica === 'escalas' && 
                            '‚Ä¢ Mayores: Do, Re, Mi, Fa, Sol, La, Si\n‚Ä¢ Menores: Do menor, Re menor, etc.\n‚Ä¢ Pentat√≥nicas: Mayor, Menor\n‚Ä¢ Modos: J√≥nico, D√≥rico, Frigio, Lidio, Mixolidio, E√≥lico, Locrio\n‚Ä¢ Pregunta: "Escribe la escala de Do mayor", "¬øQu√© modo es este?"\n‚Ä¢ Ejemplo: Do mayor = Do-Re-Mi-Fa-Sol-La-Si-Do'
                          }
                          {formDataFlashcard.subtipoMusica === 'progresiones' && 
                            '‚Ä¢ B√°sicas: I-IV-V, I-V-vi-IV, ii-V-I\n‚Ä¢ Jazz: ii-V-I, I-vi-ii-V, iii-VI-ii-V\n‚Ä¢ Pregunta: "¬øQu√© acordes forman I-IV-V en Do?", "Identifica la progresi√≥n"\n‚Ä¢ Ejemplo: I-IV-V en Do = C-F-G'
                          }
                          {formDataFlashcard.subtipoMusica === 'ritmo' && 
                            '‚Ä¢ Silencios: ùÑª (redonda), ùÑº (blanca), ùÑΩ (negra), ùÑæ (corchea), ùÑø (semicorchea)\n‚Ä¢ Patrones: ‚ô©‚ô©‚ô©‚ô©, ‚ô™‚ô™‚ô™‚ô™, ‚ô©ùÑΩ‚ô©ùÑΩ\n‚Ä¢ Pregunta: "¬øCu√°ntos tiempos dura ùÑΩ?", "Completa el comp√°s"\n‚Ä¢ Ejemplo: ùÑΩ = 1 tiempo de silencio'
                          }
                          {formDataFlashcard.subtipoMusica === 'simbolos' && 
                            '‚Ä¢ Alteraciones: ‚ôØ (sostenido), ‚ô≠ (bemol), ‚ôÆ (becuadro), ùÑ™ (doble sostenido), ùÑ´ (doble bemol)\n‚Ä¢ Din√°mica: ùÜèùÜè (pianissimo), ùÜë (forte), ùÜëùÜë (fortissimo)\n‚Ä¢ Pregunta: "¬øQu√© hace ‚ôØ?", "Identifica el s√≠mbolo"\n‚Ä¢ Ejemplo: ‚ôØ sube medio tono'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* Configuraci√≥n Geometr√≠a */}
                  {formDataFlashcard.tipo === 'geometria' && (
                    <>
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìê</span>
                          Tipo de Objeto Geom√©trico
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.subtipoGeometria || 'puntos'}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard, 
                            subtipoGeometria: e.target.value,
                            categoriaGeometria: e.target.value === 'puntos' ? 'basicos' :
                                              e.target.value === 'rectas' ? 'segmentos' :
                                              e.target.value === 'angulos' ? 'medidas' :
                                              e.target.value === 'poligonos' ? 'triangulos' :
                                              e.target.value === 'circulos' ? 'basicos' :
                                              e.target.value === 'construcciones' ? 'basicas' :
                                              e.target.value === 'flechas' ? 'direcciones' : 'distancias'
                          })}
                        >
                          <option value="puntos">‚Ä¢ Puntos</option>
                          <option value="rectas">üìè Rectas y Segmentos</option>
                          <option value="angulos">‚à† √Ångulos</option>
                          <option value="poligonos">‚ñ≥ Pol√≠gonos</option>
                          <option value="circulos">‚óã C√≠rculos y Arcos</option>
                          <option value="construcciones">üìê Construcciones Geom√©tricas</option>
                          <option value="flechas">‚Üí Vectores y Flechas</option>
                          <option value="medidas">üìä Medidas y C√°lculos</option>
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üîß</span>
                          Categor√≠a Geom√©trica
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.categoriaGeometria || 'basicos'}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, categoriaGeometria: e.target.value})}
                        >
                          {formDataFlashcard.subtipoGeometria === 'puntos' && (
                            <>
                              <option value="basicos">Puntos B√°sicos</option>
                              <option value="coordenadas">Coordenadas</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'rectas' && (
                            <>
                              <option value="segmentos">Segmentos</option>
                              <option value="rectas">Rectas Infinitas</option>
                              <option value="semirrectas">Semirrectas</option>
                              <option value="especiales">Perpendiculares/Paralelas</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'angulos' && (
                            <>
                              <option value="medidas">Medidas de √Ångulos</option>
                              <option value="radianes">Radianes</option>
                              <option value="grados">Grados</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'poligonos' && (
                            <>
                              <option value="triangulos">Tri√°ngulos</option>
                              <option value="cuadrilateros">Cuadril√°teros</option>
                              <option value="regulares">Pol√≠gonos Regulares</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'circulos' && (
                            <>
                              <option value="basicos">C√≠rculos B√°sicos</option>
                              <option value="arcos">Arcos y Sectores</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'construcciones' && (
                            <>
                              <option value="basicas">Construcciones B√°sicas</option>
                              <option value="centros">Puntos Notables</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'flechas' && (
                            <>
                              <option value="direcciones">Direcciones</option>
                              <option value="vectores">Vectores</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoGeometria === 'medidas' && (
                            <>
                              <option value="distancias">Distancias</option>
                              <option value="areas">√Åreas y Per√≠metros</option>
                              <option value="trigonometria">Trigonometr√≠a</option>
                            </>
                          )}
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Complejidad
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.nivelGeometria || 'basico'}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, nivelGeometria: e.target.value})}
                        >
                          <option value="basico">üü¢ B√°sico</option>
                          <option value="intermedio">üü° Intermedio</option>
                          <option value="avanzado">üî¥ Avanzado</option>
                        </select>
                      </div>

                      <div className="info-box" style={{background: 'rgba(34, 197, 94, 0.1)', borderLeft: '4px solid #22c55e'}}>
                        <strong>üí° {
                          formDataFlashcard.subtipoGeometria === 'puntos' ? 'Puntos y Coordenadas' :
                          formDataFlashcard.subtipoGeometria === 'rectas' ? 'Rectas y Segmentos' :
                          formDataFlashcard.subtipoGeometria === 'angulos' ? '√Ångulos' :
                          formDataFlashcard.subtipoGeometria === 'poligonos' ? 'Pol√≠gonos' :
                          formDataFlashcard.subtipoGeometria === 'circulos' ? 'C√≠rculos' :
                          formDataFlashcard.subtipoGeometria === 'construcciones' ? 'Construcciones' :
                          formDataFlashcard.subtipoGeometria === 'flechas' ? 'Vectores' :
                          'Medidas y C√°lculos'
                        }:</strong>
                        <div style={{marginTop: '0.5rem'}}>
                          {formDataFlashcard.subtipoGeometria === 'puntos' && 
                            '‚Ä¢ Puntos: ‚Ä¢A, ‚Ä¢B, P(x,y)\n‚Ä¢ Coordenadas: P(3,4), Q(-2,5)\n‚Ä¢ Pregunta: "Ubica el punto A", "¬øQu√© coordenadas tiene P?"\n‚Ä¢ Ejemplo: A(2,3) est√° en el primer cuadrante'
                          }
                          {formDataFlashcard.subtipoGeometria === 'rectas' && 
                            '‚Ä¢ Segmentos: ABÃÖ, longitud |AB|\n‚Ä¢ Rectas: ‚Üê‚ÜíAB (infinita)\n‚Ä¢ Perpendiculares: ‚üÇ, Paralelas: ‚à•\n‚Ä¢ Pregunta: "Traza ABÃÖ", "¬øSon paralelas?"\n‚Ä¢ Ejemplo: ABÃÖ ‚üÇ CDÃÖ (perpendiculares)'
                          }
                          {formDataFlashcard.subtipoGeometria === 'angulos' && 
                            '‚Ä¢ √Ångulos: ‚à†ABC, medida en grados o radianes\n‚Ä¢ Radianes: œÄ/6, œÄ/4, œÄ/3, œÄ/2\n‚Ä¢ Grados: 30¬∞, 45¬∞, 60¬∞, 90¬∞\n‚Ä¢ Pregunta: "Mide ‚à†ABC", "Convierte 45¬∞ a radianes"\n‚Ä¢ Ejemplo: ‚à†ABC = 60¬∞ = œÄ/3 rad'
                          }
                          {formDataFlashcard.subtipoGeometria === 'poligonos' && 
                            '‚Ä¢ Tri√°ngulos: ‚ñ≥ABC (equil√°tero, is√≥sceles, escaleno)\n‚Ä¢ Cuadril√°teros: ‚ñ° (cuadrado), ‚ñ± (paralelogramo), ‚óä (rombo)\n‚Ä¢ Pregunta: "Clasifica ‚ñ≥ABC", "¬øCu√°ntos lados tiene?"\n‚Ä¢ Ejemplo: ‚ñ≥ equil√°tero tiene 3 lados iguales'
                          }
                          {formDataFlashcard.subtipoGeometria === 'circulos' && 
                            '‚Ä¢ C√≠rculos: ‚óã con centro y radio\n‚Ä¢ Arcos: ‚åíAB\n‚Ä¢ Pregunta: "Calcula per√≠metro", "¬øQu√© es el radio?"\n‚Ä¢ Ejemplo: C = 2œÄr, A = œÄr¬≤'
                          }
                          {formDataFlashcard.subtipoGeometria === 'construcciones' && 
                            '‚Ä¢ Mediatriz: l√≠nea perpendicular que biseca un segmento\n‚Ä¢ Bisectriz: divide un √°ngulo en dos partes iguales\n‚Ä¢ Puntos notables: circuncentro, incentro, baricentro, ortocentro\n‚Ä¢ Pregunta: "Construye la mediatriz de ABÃÖ", "Ubica el baricentro"\n‚Ä¢ Ejemplo: La mediatriz de ABÃÖ pasa por su punto medio'
                          }
                          {formDataFlashcard.subtipoGeometria === 'flechas' && 
                            '‚Ä¢ Flechas: ‚Üí, ‚Üê, ‚Üî, ‚Üë, ‚Üì\n‚Ä¢ Vectores: v‚Éó = (x,y)\n‚Ä¢ Pregunta: "Representa el vector AB‚Éó", "¬øQu√© direcci√≥n tiene?"\n‚Ä¢ Ejemplo: AB‚Éó = (3,4) va de A a B'
                          }
                          {formDataFlashcard.subtipoGeometria === 'medidas' && 
                            '‚Ä¢ Distancia: d(A,B) = ‚àö[(x‚ÇÇ-x‚ÇÅ)¬≤ + (y‚ÇÇ-y‚ÇÅ)¬≤]\n‚Ä¢ √Årea: A = bh/2 (tri√°ngulo), A = œÄr¬≤ (c√≠rculo)\n‚Ä¢ Trigonometr√≠a: sen Œ∏, cos Œ∏, tan Œ∏\n‚Ä¢ Pit√°goras: a¬≤ + b¬≤ = c¬≤\n‚Ä¢ Pregunta: "Calcula d(A,B)", "¬øQu√© es sen(30¬∞)?"\n‚Ä¢ Ejemplo: d((0,0),(3,4)) = 5'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* Configuraci√≥n Qu√≠mica Avanzada */}
                  {formDataFlashcard.tipo === 'quimica-avanzada' && (
                    <>
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üß¨</span>
                          Tipo de Estructura Qu√≠mica
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.subtipoQuimicaAvanzada || 'orbitales'}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard, 
                            subtipoQuimicaAvanzada: e.target.value,
                            categoriaQuimicaAvanzada: e.target.value === 'orbitales' ? 'atomicos' :
                                                     e.target.value === 'hibridacion' ? 'sp' :
                                                     e.target.value === 'vsepr' ? 'ax2' :
                                                     e.target.value === 'electrones' ? 'flechas' :
                                                     e.target.value === 'cargas' ? 'parciales' :
                                                     e.target.value === 'mo' ? 'diatomicos' :
                                                     e.target.value === 'pares' ? 'libres' :
                                                     e.target.value === 'resonancia' ? 'estructuras' : 'sigma'
                          })}
                        >
                          <option value="orbitales">‚öõÔ∏è Orbitales At√≥micos</option>
                          <option value="hibridacion">üîÄ Hibridaci√≥n</option>
                          <option value="vsepr">üßÆ Geometr√≠a VSEPR</option>
                          <option value="electrones">‚Ü∑ Movimiento de Electrones</option>
                          <option value="cargas">‚ö° Cargas y Polaridad</option>
                          <option value="mo">üåå Diagramas MO</option>
                          <option value="pares">‚Ä¢‚Ä¢ Pares Electr√≥nicos</option>
                          <option value="resonancia">‚áå Resonancia</option>
                          <option value="enlaces">üîó Enlaces Especiales</option>
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">‚öóÔ∏è</span>
                          Categor√≠a Qu√≠mica
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.categoriaQuimicaAvanzada || 'atomicos'}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, categoriaQuimicaAvanzada: e.target.value})}
                        >
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'orbitales' && (
                            <>
                              <option value="atomicos">Orbitales s, p, d, f</option>
                              <option value="orientaciones">Orientaciones espaciales</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'hibridacion' && (
                            <>
                              <option value="sp">sp (lineal)</option>
                              <option value="sp2">sp¬≤ (trigonal)</option>
                              <option value="sp3">sp¬≥ (tetra√©drico)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'vsepr' && (
                            <>
                              <option value="ax2">AX‚ÇÇ (lineal)</option>
                              <option value="ax3">AX‚ÇÉ (trigonal plana)</option>
                              <option value="ax4">AX‚ÇÑ (tetra√©drica)</option>
                              <option value="ax5">AX‚ÇÖ (bipiramidal)</option>
                              <option value="ax6">AX‚ÇÜ (octa√©drica)</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'electrones' && (
                            <>
                              <option value="flechas">Flechas curvas</option>
                              <option value="mecanismos">Mecanismos de reacci√≥n</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'cargas' && (
                            <>
                              <option value="parciales">Cargas parciales Œ¥</option>
                              <option value="dipolos">Momentos dipolares</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'mo' && (
                            <>
                              <option value="diatomicos">Diat√≥micos homonucleares</option>
                              <option value="heteronucleares">Diat√≥micos heteronucleares</option>
                              <option value="generales">Diagramas generales</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'pares' && (
                            <>
                              <option value="libres">Pares libres</option>
                              <option value="enlazantes">Pares enlazantes</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'resonancia' && (
                            <>
                              <option value="estructuras">Estructuras resonantes</option>
                              <option value="hibridos">H√≠bridos de resonancia</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'enlaces' && (
                            <>
                              <option value="sigma">Enlaces œÉ</option>
                              <option value="pi">Enlaces œÄ</option>
                              <option value="coordinados">Enlaces coordinados</option>
                              <option value="parciales">Enlaces parciales</option>
                            </>
                          )}
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Complejidad
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.nivelQuimicaAvanzada || 'basico'}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, nivelQuimicaAvanzada: e.target.value})}
                        >
                          <option value="basico">üü¢ B√°sico</option>
                          <option value="intermedio">üü° Intermedio</option>
                          <option value="avanzado">üî¥ Avanzado</option>
                        </select>
                      </div>

                      <div className="info-box" style={{background: 'rgba(192, 132, 252, 0.1)', borderLeft: '4px solid #c084fc'}}>
                        <strong>üí° {
                          formDataFlashcard.subtipoQuimicaAvanzada === 'orbitales' ? 'Orbitales At√≥micos' :
                          formDataFlashcard.subtipoQuimicaAvanzada === 'hibridacion' ? 'Hibridaci√≥n' :
                          formDataFlashcard.subtipoQuimicaAvanzada === 'vsepr' ? 'Geometr√≠a VSEPR' :
                          formDataFlashcard.subtipoQuimicaAvanzada === 'electrones' ? 'Movimiento de Electrones' :
                          formDataFlashcard.subtipoQuimicaAvanzada === 'cargas' ? 'Cargas y Polaridad' :
                          formDataFlashcard.subtipoQuimicaAvanzada === 'mo' ? 'Orbitales Moleculares' :
                          formDataFlashcard.subtipoQuimicaAvanzada === 'pares' ? 'Pares Electr√≥nicos' :
                          formDataFlashcard.subtipoQuimicaAvanzada === 'resonancia' ? 'Resonancia' :
                          'Enlaces Especiales'
                        }:</strong>
                        <div style={{marginTop: '0.5rem'}}>
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'orbitales' && 
                            '‚Ä¢ Orbitales s: forma esf√©rica, 1 orbital\n‚Ä¢ Orbitales p: dos l√≥bulos, 3 orientaciones (px, py, pz)\n‚Ä¢ Orbitales d: 4-5 l√≥bulos, 5 orientaciones\n‚Ä¢ Orbitales f: formas complejas, 7 orientaciones\n‚Ä¢ Pregunta: "Dibuja orbital 2p", "¬øCu√°ntos l√≥bulos tiene d?"\n‚Ä¢ Ejemplo: [1s]‚óã [2px]‚àû [3dxy]‚ú•'
                          }
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'hibridacion' && 
                            '‚Ä¢ sp: 2 orbitales h√≠bridos, geometr√≠a lineal, 180¬∞\n‚Ä¢ sp¬≤: 3 orbitales h√≠bridos, geometr√≠a trigonal plana, 120¬∞\n‚Ä¢ sp¬≥: 4 orbitales h√≠bridos, geometr√≠a tetra√©drica, 109.5¬∞\n‚Ä¢ Pregunta: "¬øQu√© hibridaci√≥n tiene C en CH‚ÇÑ?", "Dibuja sp¬≤"\n‚Ä¢ Ejemplo: CH‚ÇÑ tiene sp¬≥ (109.5¬∞)'
                          }
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'vsepr' && 
                            '‚Ä¢ AX‚ÇÇ: lineal, 180¬∞ (CO‚ÇÇ)\n‚Ä¢ AX‚ÇÉ: trigonal plana, 120¬∞ (BF‚ÇÉ)\n‚Ä¢ AX‚ÇÑ: tetra√©drica, 109.5¬∞ (CH‚ÇÑ)\n‚Ä¢ AX‚ÇÖ: bipiramidal trigonal (PCl‚ÇÖ)\n‚Ä¢ AX‚ÇÜ: octa√©drica, 90¬∞ (SF‚ÇÜ)\n‚Ä¢ Pregunta: "¬øQu√© geometr√≠a tiene NH‚ÇÉ?", "Dibuja AX‚ÇÑ"\n‚Ä¢ Ejemplo: NH‚ÇÉ es AX‚ÇÉE (piramidal, 107¬∞)'
                          }
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'electrones' && 
                            '‚Ä¢ Flechas curvas: movimiento de pares electr√≥nicos\n‚Ä¢ Nucle√≥filo ‚Üí Electr√≥filo: Nu:‚Åª ‚Üí E‚Å∫\n‚Ä¢ Mecanismos: SN1, SN2, E1, E2\n‚Ä¢ Pregunta: "Dibuja el mecanismo", "¬øHacia d√≥nde van los e‚Åª?"\n‚Ä¢ Ejemplo: Nu:‚Åª ‚Ü∑ ‚Üí C‚Å∫ (ataque nucleof√≠lico)'
                          }
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'cargas' && 
                            '‚Ä¢ Cargas parciales: Œ¥‚Å∫ Œ¥‚Åª en enlaces polares\n‚Ä¢ Dipolos: ‚Üí indica direcci√≥n (de ‚Å∫ a ‚Åª)\n‚Ä¢ Pregunta: "Asigna Œ¥‚Å∫ y Œ¥‚Åª", "¬øHacia d√≥nde apunta el dipolo?"\n‚Ä¢ Ejemplo: H-Cl: HŒ¥‚Å∫-ClŒ¥‚Åª ‚Üí'
                          }
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'mo' && 
                            '‚Ä¢ Orbitales moleculares: œÉ, œÉ*, œÄ, œÄ*\n‚Ä¢ Enlazantes: œÉ‚ÇÅs, œÉ‚ÇÇs, œÄ‚ÇÇp, œÉ‚ÇÇp\n‚Ä¢ Antienlazantes: œÉ*‚ÇÅs, œÉ*‚ÇÇs, œÄ*‚ÇÇp, œÉ*‚ÇÇp\n‚Ä¢ Electrones: ‚Üë‚Üì (apareados), ‚Üë (desapareado)\n‚Ä¢ Pregunta: "Diagrama MO de O‚ÇÇ", "¬øCu√°ntos e‚Åª en œÄ‚ÇÇp?"\n‚Ä¢ Ejemplo: O‚ÇÇ tiene 2 e‚Åª desapareados en œÄ*‚ÇÇp'
                          }
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'pares' && 
                            '‚Ä¢ Pares libres: ‚Ä¢‚Ä¢ (dos puntos)\n‚Ä¢ Electrones individuales: ‚Ä¢ (un punto)\n‚Ä¢ Nubes electr√≥nicas: ‚äô\n‚Ä¢ Pregunta: "Marca pares libres en NH‚ÇÉ", "¬øCu√°ntos tiene O?"\n‚Ä¢ Ejemplo: NH‚ÇÉ tiene 1 par libre: H‚ÇÉN‚Ä¢‚Ä¢'
                          }
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'resonancia' && 
                            '‚Ä¢ Estructuras resonantes: A ‚áå B\n‚Ä¢ H√≠bridos: combinaci√≥n de estructuras\n‚Ä¢ Pregunta: "Dibuja formas resonantes de CO‚ÇÉ¬≤‚Åª", "¬øSon equivalentes?"\n‚Ä¢ Ejemplo: O=C-O‚Åª ‚áå ‚ÅªO-C=O (carbonato)'
                          }
                          {formDataFlashcard.subtipoQuimicaAvanzada === 'enlaces' && 
                            '‚Ä¢ Enlace œÉ: enlace simple, rotaci√≥n libre\n‚Ä¢ Enlace œÄ: enlace doble/triple, restricci√≥n rotacional\n‚Ä¢ Enlace coordinado: A‚ÜíB (par compartido de A)\n‚Ä¢ Enlace parcial: l√≠nea punteada\n‚Ä¢ Pregunta: "¬øCu√°ntos œÉ y œÄ en C‚â°N?", "Dibuja enlace coordinado"\n‚Ä¢ Ejemplo: C‚â°N tiene 1œÉ + 2œÄ'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* Configuraci√≥n Probabilidad y Estad√≠stica */}
                  {formDataFlashcard.tipo === 'probabilidad' && (
                    <>
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üé≤</span>
                          Tipo de Elemento Estad√≠stico
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.subtipoProbabilidad || 'arboles'}
                          onChange={(e) => setFormDataFlashcard({
                            ...formDataFlashcard, 
                            subtipoProbabilidad: e.target.value,
                            categoriaProbabilidad: e.target.value === 'arboles' ? 'simple' :
                                                  e.target.value === 'venn' ? 'dos-conjuntos' :
                                                  e.target.value === 'tablas' ? '2x2' :
                                                  e.target.value === 'distribuciones' ? 'normal' :
                                                  e.target.value === 'graficos' ? 'histograma' :
                                                  e.target.value === 'formulas' ? 'bayes' : 'dataset'
                          })}
                        >
                          <option value="arboles">üå≥ √Årboles de Probabilidad</option>
                          <option value="venn">‚≠ï Diagramas de Venn</option>
                          <option value="tablas">üìã Tablas de Contingencia</option>
                          <option value="distribuciones">üìä Distribuciones</option>
                          <option value="graficos">üìà Gr√°ficos</option>
                          <option value="formulas">üî£ F√≥rmulas Esenciales</option>
                          <option value="datos">üß™ Mini Datasets</option>
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Categor√≠a Estad√≠stica
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.categoriaProbabilidad || 'simple'}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, categoriaProbabilidad: e.target.value})}
                        >
                          {formDataFlashcard.subtipoProbabilidad === 'arboles' && (
                            <>
                              <option value="simple">√Årbol Simple</option>
                              <option value="dos-niveles">Dos Niveles</option>
                              <option value="tres-ramas">Tres Ramas</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoProbabilidad === 'venn' && (
                            <>
                              <option value="dos-conjuntos">Dos Conjuntos</option>
                              <option value="tres-conjuntos">Tres Conjuntos</option>
                              <option value="con-probabilidades">Con Probabilidades</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoProbabilidad === 'tablas' && (
                            <>
                              <option value="2x2">Tabla 2√ó2</option>
                              <option value="3x3">Tabla 3√ó3</option>
                              <option value="con-totales">Con Totales</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoProbabilidad === 'distribuciones' && (
                            <>
                              <option value="normal">Normal</option>
                              <option value="binomial">Binomial</option>
                              <option value="poisson">Poisson</option>
                              <option value="exponencial">Exponencial</option>
                              <option value="uniforme">Uniforme</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoProbabilidad === 'graficos' && (
                            <>
                              <option value="histograma">Histograma</option>
                              <option value="dispersion">Dispersi√≥n</option>
                              <option value="barras">Barras</option>
                              <option value="linea">L√≠nea</option>
                              <option value="boxplot">Box Plot</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoProbabilidad === 'formulas' && (
                            <>
                              <option value="bayes">Teorema de Bayes</option>
                              <option value="esperanza">Esperanza</option>
                              <option value="varianza">Varianza</option>
                              <option value="covarianza">Covarianza</option>
                            </>
                          )}
                          {formDataFlashcard.subtipoProbabilidad === 'datos' && (
                            <>
                              <option value="dataset">Dataset Simple</option>
                              <option value="medidas">Medidas de Tendencia</option>
                              <option value="cuartiles">Cuartiles</option>
                            </>
                          )}
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üìä</span>
                          Nivel de Complejidad
                        </label>
                        <select 
                          className="config-input"
                          value={formDataFlashcard.nivelProbabilidad || 'basico'}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, nivelProbabilidad: e.target.value})}
                        >
                          <option value="basico">üü¢ B√°sico</option>
                          <option value="intermedio">üü° Intermedio</option>
                          <option value="avanzado">üî¥ Avanzado</option>
                        </select>
                      </div>

                      <div className="info-box" style={{background: 'rgba(139, 92, 246, 0.1)', borderLeft: '4px solid #8b5cf6'}}>
                        <strong>üí° {
                          formDataFlashcard.subtipoProbabilidad === 'arboles' ? '√Årboles de Probabilidad' :
                          formDataFlashcard.subtipoProbabilidad === 'venn' ? 'Diagramas de Venn' :
                          formDataFlashcard.subtipoProbabilidad === 'tablas' ? 'Tablas de Contingencia' :
                          formDataFlashcard.subtipoProbabilidad === 'distribuciones' ? 'Distribuciones' :
                          formDataFlashcard.subtipoProbabilidad === 'graficos' ? 'Gr√°ficos Estad√≠sticos' :
                          formDataFlashcard.subtipoProbabilidad === 'formulas' ? 'F√≥rmulas Esenciales' :
                          'Mini Datasets'
                        }:</strong>
                        <div style={{marginTop: '0.5rem'}}>
                          {formDataFlashcard.subtipoProbabilidad === 'arboles' && 
                            '‚Ä¢ √ösalo para decisiones y caminos posibles\n‚Ä¢ Cada rama tiene probabilidad editable (‚ñ°)\n‚Ä¢ Perfecto para experimentos secuenciales\n‚Ä¢ Ejemplo: Lanzar una moneda dos veces'
                          }
                          {formDataFlashcard.subtipoProbabilidad === 'venn' && 
                            '‚Ä¢ Conjuntos A, B, C con intersecci√≥n\n‚Ä¢ A‚à©B (intersecci√≥n), A‚à™B (uni√≥n), A·∂ú (complemento)\n‚Ä¢ Con porcentajes editables\n‚Ä¢ Ejemplo: P(A‚à©B) = 30%, P(A‚à™B) = 70%'
                          }
                          {formDataFlashcard.subtipoProbabilidad === 'tablas' && 
                            '‚Ä¢ Tablas 2√ó2 o 3√ó3 para probabilidades conjuntas\n‚Ä¢ Probabilidad condicional: P(A|B)\n‚Ä¢ Con totales autom√°ticos\n‚Ä¢ Ejemplo: G√©nero vs Preferencia'
                          }
                          {formDataFlashcard.subtipoProbabilidad === 'distribuciones' && 
                            '‚Ä¢ Normal: N(Œº, œÉ) - campana de Gauss\n‚Ä¢ Binomial: n ensayos, p probabilidad\n‚Ä¢ Poisson: eventos raros\n‚Ä¢ Exponencial: tiempo entre eventos\n‚Ä¢ Par√°metros editables con ‚ñ°'
                          }
                          {formDataFlashcard.subtipoProbabilidad === 'graficos' && 
                            '‚Ä¢ Histograma: distribuci√≥n de datos\n‚Ä¢ Dispersi√≥n: relaci√≥n entre variables\n‚Ä¢ Box plot: cuartiles y outliers\n‚Ä¢ Barras/L√≠nea: comparaci√≥n/tendencia'
                          }
                          {formDataFlashcard.subtipoProbabilidad === 'formulas' && 
                            '‚Ä¢ Bayes: P(A|B) = P(B|A)¬∑P(A) / P(B)\n‚Ä¢ Esperanza: E[X] = Œ£ x·µ¢¬∑p·µ¢\n‚Ä¢ Varianza: Var(X) = E[X¬≤] - (E[X])¬≤\n‚Ä¢ Covarianza: relaci√≥n entre variables\n‚Ä¢ Valores editables con ‚ñ°'
                          }
                          {formDataFlashcard.subtipoProbabilidad === 'datos' && 
                            '‚Ä¢ Mini tabla de datos (x, y)\n‚Ä¢ Media: xÃÑ = Œ£x·µ¢ / n\n‚Ä¢ Mediana: valor central\n‚Ä¢ Moda: m√°s frecuente\n‚Ä¢ Cuartiles: Q‚ÇÅ, Me, Q‚ÇÉ'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* üé® Configuraci√≥n de ARTE */}
                  {formDataFlashcard.tipo === 'arte' && (
                    <>
                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üé®</span>
                          Tipo de Elemento Visual
                        </label>
                        <select
                          className="select-tipo"
                          value={formDataFlashcard.subtipoArte}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, subtipoArte: e.target.value})}
                        >
                          <option value="figuras">üî∑ Figuras b√°sicas (c√≠rculo, cuadrado, tri√°ngulo, flechas)</option>
                          <option value="paletas">üé® Paletas de color (pastel, ne√≥n, tierra, retro)</option>
                          <option value="composiciones">üìê Composiciones/Layouts (2 columnas, grid, diagonal)</option>
                          <option value="estilos">üñºÔ∏è Estilos art√≠sticos (impresionismo, cubismo, surrealismo)</option>
                          <option value="timeline">üìÖ Timeline historia del arte</option>
                          <option value="iconos">‚ú® Iconos art√≠sticos (pincel, paleta, museo)</option>
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üéØ</span>
                          Categor√≠a Visual
                        </label>
                        <select
                          className="select-tipo"
                          value={formDataFlashcard.categoriaArte}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, categoriaArte: e.target.value})}
                        >
                          <option value="basico">üü¢ B√°sico - Formas y colores simples</option>
                          <option value="intermedio">üü° Intermedio - Composiciones estructuradas</option>
                          <option value="avanzado">üü£ Avanzado - Estilos art√≠sticos complejos</option>
                        </select>
                      </div>

                      <div className="config-section">
                        <label className="config-label">
                          <span className="label-icon">üñºÔ∏è</span>
                          Estilo Art√≠stico Aplicado
                        </label>
                        <select
                          className="select-tipo"
                          value={formDataFlashcard.estiloArtistico}
                          onChange={(e) => setFormDataFlashcard({...formDataFlashcard, estiloArtistico: e.target.value})}
                        >
                          <option value="ninguno">Sin estilo (visual puro)</option>
                          <option value="impresionismo">üåÖ Impresionismo - Monet</option>
                          <option value="cubismo">üìê Cubismo - Picasso</option>
                          <option value="surrealismo">üåô Surrealismo - Dal√≠</option>
                          <option value="barroco">üëë Barroco - Caravaggio</option>
                          <option value="modernismo">üèõÔ∏è Modernismo - Klimt</option>
                          <option value="bauhaus">‚ñ≤‚ñ†‚óè Bauhaus - Minimalista</option>
                          <option value="ukiyo-e">üå∏ Ukiyo-e - Hokusai</option>
                          <option value="pop-art">üí• Pop Art - Warhol</option>
                        </select>
                      </div>

                      <div style={{
                        marginTop: '1rem',
                        padding: '1rem',
                        background: 'rgba(244, 114, 182, 0.1)',
                        borderRadius: '8px',
                        border: '1px solid rgba(244, 114, 182, 0.2)'
                      }}>
                        <strong style={{color: '#f9a8d4'}}>üí° Uso del Panel de Arte:</strong>
                        <div style={{marginTop: '0.5rem'}}>
                          {formDataFlashcard.subtipoArte === 'figuras' && 
                            '‚Ä¢ Inserta formas b√°sicas editables\n‚Ä¢ Perfecto para esquemas visuales\n‚Ä¢ C√≠rculos, cuadrados, flechas, l√≠neas\n‚Ä¢ Cambia colores con ‚ñ° placeholders'
                          }
                          {formDataFlashcard.subtipoArte === 'paletas' && 
                            '‚Ä¢ Aplica paletas de color profesionales\n‚Ä¢ Pastel, ne√≥n, tierra, retro, minimalista\n‚Ä¢ Vista previa de 5 colores\n‚Ä¢ Ideal para aprender dise√±o'
                          }
                          {formDataFlashcard.subtipoArte === 'composiciones' && 
                            '‚Ä¢ Layouts prearmados para organizar info\n‚Ä¢ 2 columnas, grid 3√ó3, divisi√≥n diagonal\n‚Ä¢ Estructuras editables con ‚ñ°\n‚Ä¢ Perfecto para notas visuales'
                          }
                          {formDataFlashcard.subtipoArte === 'estilos' && 
                            '‚Ä¢ Filtros art√≠sticos para estudiar historia del arte\n‚Ä¢ Impresionismo, cubismo, surrealismo\n‚Ä¢ Con descripci√≥n y artista representativo\n‚Ä¢ Para flashcards de identificaci√≥n de estilos'
                          }
                          {formDataFlashcard.subtipoArte === 'timeline' && 
                            '‚Ä¢ L√≠neas de tiempo de movimientos art√≠sticos\n‚Ä¢ Renacimiento, Barroco, Romanticismo\n‚Ä¢ Con artistas y obras editables\n‚Ä¢ Ideal para estudiar historia del arte'
                          }
                          {formDataFlashcard.subtipoArte === 'iconos' && 
                            '‚Ä¢ Iconos tem√°ticos de arte y cultura\n‚Ä¢ Pincel, paleta, museo, estatua\n‚Ä¢ Para enriquecer composiciones\n‚Ä¢ Complementa otras herramientas'
                          }
                        </div>
                      </div>
                    </>
                  )}

                  {/* Selector de Im√°genes/Archivos */}
                  {(formDataFlashcard.tipo === 'visual' || formDataFlashcard.tipo === 'archivo' || formDataFlashcard.tipo === 'matematica') && (
                    <div className="config-section">
                      <label className="config-label">
                        <span className="label-icon">{formDataFlashcard.tipo === 'visual' ? 'üñºÔ∏è' : 'üìé'}</span>
                        {formDataFlashcard.tipo === 'visual' ? 'Im√°genes' : 'Archivos Adjuntos'}
                      </label>
                      <div style={{
                        padding: '1.5rem',
                        background: 'rgba(51, 65, 85, 0.4)',
                        border: '2px dashed rgba(148, 163, 184, 0.3)',
                        borderRadius: '12px',
                        textAlign: 'center'
                      }}>
                        <input
                          type="file"
                          id="file-upload"
                          multiple={formDataFlashcard.tipo === 'visual'}
                          accept={formDataFlashcard.tipo === 'visual' ? 'image/*' : '*'}
                          onChange={async (e) => {
                            const files = Array.from(e.target.files);
                            
                            // üî• Convertir archivos a base64 para persistencia
                            const filePromises = files.map(file => {
                              return new Promise((resolve) => {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                  resolve({
                                    nombre: file.name,
                                    tipo: file.type,
                                    tamano: file.size,
                                    url: event.target.result, // Base64
                                    base64: event.target.result
                                  });
                                };
                                reader.readAsDataURL(file);
                              });
                            });
                            
                            const fileData = await Promise.all(filePromises);
                            
                            if (formDataFlashcard.tipo === 'visual') {
                              setFormDataFlashcard({...formDataFlashcard, imagenes: [...formDataFlashcard.imagenes, ...fileData]});
                            } else {
                              setFormDataFlashcard({...formDataFlashcard, archivos: [...formDataFlashcard.archivos, ...fileData]});
                            }
                          }}
                          style={{display: 'none'}}
                        />
                        <label htmlFor="file-upload" style={{
                          display: 'inline-block',
                          padding: '0.875rem 1.5rem',
                          background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                          color: 'white',
                          borderRadius: '10px',
                          cursor: 'pointer',
                          fontWeight: '600',
                          marginBottom: '0.75rem'
                        }}>
                          üìÅ Seleccionar {formDataFlashcard.tipo === 'visual' ? 'im√°genes' : 'archivos'}
                        </label>
                        <p style={{color: '#94a3b8', fontSize: '0.85rem', margin: '0.5rem 0 0 0'}}>
                          {formDataFlashcard.tipo === 'visual' 
                            ? 'Formatos: JPG, PNG, GIF, SVG' 
                            : 'Formatos: PDF, DOCX, XLSX, TXT, etc.'}
                        </p>
                        
                        {/* Preview de archivos/im√°genes */}
                        {(formDataFlashcard.imagenes.length > 0 || formDataFlashcard.archivos.length > 0) && (
                          <div style={{
                            marginTop: '1rem',
                            display: 'grid',
                            gridTemplateColumns: 'repeat(auto-fill, minmax(120px, 1fr))',
                            gap: '0.75rem'
                          }}>
                            {[...(formDataFlashcard.imagenes || []), ...(formDataFlashcard.archivos || [])].map((file, idx) => (
                              <div key={idx} style={{
                                position: 'relative',
                                padding: '0.5rem',
                                background: 'rgba(100, 116, 139, 0.3)',
                                borderRadius: '8px',
                                textAlign: 'center'
                              }}>
                                {file.tipo?.startsWith('image/') ? (
                                  <img src={file.url} alt={file.nombre} style={{
                                    width: '100%',
                                    height: '80px',
                                    objectFit: 'cover',
                                    borderRadius: '6px'
                                  }} />
                                ) : (
                                  <div style={{
                                    fontSize: '2rem',
                                    padding: '1rem 0'
                                  }}>üìÑ</div>
                                )}
                                <p style={{
                                  fontSize: '0.7rem',
                                  color: '#cbd5e1',
                                  margin: '0.25rem 0 0 0',
                                  overflow: 'hidden',
                                  textOverflow: 'ellipsis',
                                  whiteSpace: 'nowrap'
                                }}>{file.nombre}</p>
                                <button
                                  type="button"
                                  onClick={() => {
                                    if (formDataFlashcard.tipo === 'visual') {
                                      setFormDataFlashcard({
                                        ...formDataFlashcard,
                                        imagenes: formDataFlashcard.imagenes.filter((_, i) => i !== idx)
                                      });
                                    } else {
                                      setFormDataFlashcard({
                                        ...formDataFlashcard,
                                        archivos: formDataFlashcard.archivos.filter((_, i) => i !== idx)
                                      });
                                    }
                                  }}
                                  style={{
                                    position: 'absolute',
                                    top: '0.25rem',
                                    right: '0.25rem',
                                    background: 'rgba(244, 67, 54, 0.9)',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '50%',
                                    width: '20px',
                                    height: '20px',
                                    fontSize: '0.7rem',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                  }}
                                >√ó</button>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* T√≠tulo */}
                  <div className="config-section">
                    <label className="config-label">
                      <span className="label-icon">üìù</span>
                      T√≠tulo
                    </label>
                    <input
                      type="text"
                      className="input-text"
                      placeholder="T√≠tulo breve de la flashcard"
                      value={formDataFlashcard.titulo}
                      onChange={(e) => setFormDataFlashcard({...formDataFlashcard, titulo: e.target.value})}
                    />
                  </div>

                  {/* Contenido/Pregunta */}
                  <div className="config-section">
                    <label className="config-label">
                      <span className="label-icon">üí≠</span>
                      {formDataFlashcard.tipo === 'clasica' ? 'Pregunta' : 
                       formDataFlashcard.tipo === 'reconocimiento' ? 'Imagen/Concepto a Identificar' :
                       formDataFlashcard.tipo === 'cloze' ? 'Texto con espacios (usa [] para blancos)' :
                       formDataFlashcard.tipo === 'escenario' ? 'Descripci√≥n del Escenario' :
                       formDataFlashcard.tipo === 'mcq' ? 'Pregunta' :
                       formDataFlashcard.tipo === 'visual' ? 'Descripci√≥n de la Imagen' :
                       formDataFlashcard.tipo === 'auditiva' ? 'Audio/Pronunciaci√≥n' :
                       formDataFlashcard.tipo === 'produccion' ? 'Prompt de Producci√≥n' :
                       formDataFlashcard.tipo === 'invertida' ? 'Respuesta Visible' :
                       formDataFlashcard.tipo === 'jerarquia' ? 'Concepto Principal' :
                       formDataFlashcard.tipo === 'error' ? 'Texto con Error Intencional' :
                       formDataFlashcard.tipo === 'comparacion' ? 'Primer Elemento (A)' :
                       formDataFlashcard.tipo === 'matematica' ? 'Expresi√≥n Matem√°tica (Editor Visual)' :
                       formDataFlashcard.tipo === 'quimica' ? 'Estructura Qu√≠mica (Editor Molecular)' :
                       formDataFlashcard.tipo === 'fisica' ? 'Ecuaci√≥n/Diagrama F√≠sico (Editor LaTeX)' :
                       formDataFlashcard.tipo === 'ingenieria' ? 'Diagrama/Sistema de Ingenier√≠a (Circuito/FBD/Viga)' :
                       formDataFlashcard.tipo === 'programacion-avanzada' ? 'Diagrama de Programaci√≥n (UML/Flujo/Grafo)' :
                       formDataFlashcard.tipo === 'archivo' ? 'Descripci√≥n del Documento' :
                       formDataFlashcard.tipo === 'programacion' ? (
                         formDataFlashcard.patronCodigo === 'produccion' ? 'Instrucci√≥n/Tarea de Programaci√≥n' : 'C√≥digo (en fuente monospace)'
                       ) :
                       'Contenido'}
                    </label>

                    {/* EDITOR MATEM√ÅTICO INTERACTIVO ESTILO WOLFRAM */}
                    {formDataFlashcard.tipo === 'matematica' ? (
                      <div style={{
                        background: 'rgba(17, 24, 39, 0.8)',
                        border: '2px solid rgba(147, 51, 234, 0.3)',
                        borderRadius: '12px',
                        padding: '1.5rem',
                        marginBottom: '1rem'
                      }}>
                        <div style={{
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '1.5rem'
                        }}>
                          {/* Panel de herramientas matem√°ticas - ARRIBA */}
                          <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                            <MathToolbar 
                              onInsertTemplate={(latex) => {
                                // Obtener el math-field del DOM
                                const mathField = document.querySelector('math-field');
                                if (mathField) {
                                  mathField.executeCommand(['insert', latex]);
                                  mathField.focus();
                                }
                              }}
                            />
                          </div>

                          {/* Editor y vista previa - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            {/* Bot√≥n de salto de l√≠nea r√°pido */}
                            <div style={{ 
                              display: 'flex', 
                              gap: '0.5rem',
                              alignItems: 'center',
                              padding: '0.5rem',
                              background: 'rgba(147, 51, 234, 0.1)',
                              borderRadius: '8px'
                            }}>
                              <button
                                type="button"
                                onClick={() => {
                                  const mathField = document.querySelector('math-field');
                                  if (mathField) {
                                    mathField.executeCommand(['insert', '\\\\']);
                                    mathField.focus();
                                  }
                                }}
                                style={{
                                  padding: '0.5rem 1rem',
                                  background: 'linear-gradient(135deg, #9333ea, #7c3aed)',
                                  color: 'white',
                                  border: 'none',
                                  borderRadius: '6px',
                                  fontSize: '0.85rem',
                                  fontWeight: '600',
                                  cursor: 'pointer',
                                  display: 'flex',
                                  alignItems: 'center',
                                  gap: '0.5rem',
                                  transition: 'all 0.2s'
                                }}
                                onMouseEnter={(e) => {
                                  e.target.style.transform = 'translateY(-1px)'
                                  e.target.style.boxShadow = '0 4px 12px rgba(147, 51, 234, 0.4)'
                                }}
                                onMouseLeave={(e) => {
                                  e.target.style.transform = 'translateY(0)'
                                  e.target.style.boxShadow = 'none'
                                }}
                              >
                                ‚èé Salto de L√≠nea
                              </button>
                              <span style={{ color: '#c4b5fd', fontSize: '0.8rem' }}>
                                o presiona <strong>SHIFT + ENTER</strong>
                              </span>
                            </div>

                            <MathEditor
                              value={formDataFlashcard.contenido}
                              onChange={(latex) => setFormDataFlashcard({
                                ...formDataFlashcard, 
                                contenido: latex,
                                latex: true
                              })}
                              placeholder="Escribe matem√°ticas o usa el panel de herramientas..."
                            />

                            {/* Vista previa renderizada - FONDO OSCURO */}
                            {formDataFlashcard.contenido && (
                              <div style={{
                                background: 'rgba(30, 41, 59, 0.8)',
                                padding: '1.5rem',
                                borderRadius: '8px',
                                border: '2px solid rgba(147, 51, 234, 0.3)'
                              }}>
                                <div style={{
                                  color: '#c4b5fd',
                                  fontSize: '0.85rem',
                                  fontWeight: '600',
                                  marginBottom: '1rem',
                                  textTransform: 'uppercase',
                                  letterSpacing: '0.05em'
                                }}>
                                  üëÅÔ∏è Vista Previa
                                </div>
                                <div style={{
                                  fontSize: '1.2rem',
                                  textAlign: 'center',
                                  minHeight: '60px',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  color: '#e9d5ff'
                                }}>
                                  <BlockMath math={formDataFlashcard.contenido} />
                                </div>
                              </div>
                            )}

                            <div style={{
                              padding: '1rem',
                              background: 'rgba(147, 51, 234, 0.1)',
                              borderLeft: '4px solid #9333ea',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#c4b5fd',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#a855f7'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en los botones para insertar plantillas matem√°ticas<br/>
                              ‚Ä¢ Usa <strong>TAB</strong> para navegar entre cajas editables<br/>
                              ‚Ä¢ Usa <strong>SHIFT + ENTER</strong> para salto de l√≠nea<br/>
                              ‚Ä¢ Usa <strong>\\\\</strong> para nueva l√≠nea en ecuaciones<br/>
                              ‚Ä¢ Escribe directamente o usa atajos (sqrt, frac, etc.)<br/>
                              ‚Ä¢ El editor convierte autom√°ticamente a LaTeX
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'quimica' ? (
                      /* EDITOR QU√çMICO INTERACTIVO */
                      <div style={{
                        background: 'rgba(17, 24, 39, 0.8)',
                        border: '2px solid rgba(16, 185, 129, 0.3)',
                        borderRadius: '12px',
                        padding: '1.5rem',
                        marginBottom: '1rem'
                      }}>
                        <div style={{
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '1.5rem'
                        }}>
                          {/* Panel de herramientas qu√≠micas - ARRIBA */}
                          <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                            <ChemToolbar 
                              onInsertStructure={(smiles) => {
                                const currentContent = formDataFlashcard.contenido || '';
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: currentContent ? currentContent + '\n' + smiles : smiles
                                })
                              }}
                            />
                          </div>

                          {/* Editor qu√≠mico - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <ChemEditor
                              value={formDataFlashcard.contenido}
                              onChange={(smiles) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: smiles
                              })}
                              placeholder="Escribe notaci√≥n SMILES o usa el panel de herramientas..."
                            />

                            <div style={{
                              padding: '1rem',
                              background: 'rgba(16, 185, 129, 0.1)',
                              borderLeft: '4px solid #10b981',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#a7f3d0',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#10b981'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en los botones para insertar estructuras predefinidas<br/>
                              ‚Ä¢ Escribe notaci√≥n SMILES directamente para estructuras personalizadas<br/>
                              ‚Ä¢ La estructura se dibuja autom√°ticamente<br/>
                              ‚Ä¢ Ejemplos: <code style={{background: 'rgba(16, 185, 129, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>c1ccccc1</code> (benceno), <code style={{background: 'rgba(16, 185, 129, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>CCO</code> (etanol)
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'fisica' ? (
                      /* üî• EDITOR DE F√çSICA INTERACTIVO ESTILO WOLFRAM */
                      <div style={{
                        background: 'rgba(17, 24, 39, 0.8)',
                        border: '2px solid rgba(245, 158, 11, 0.3)',
                        borderRadius: '12px',
                        padding: '1.5rem',
                        marginBottom: '1rem'
                      }}>
                        <div style={{
                          display: 'flex',
                          flexDirection: 'column',
                          gap: '1.5rem'
                        }}>
                          {/* Panel de herramientas f√≠sicas - ARRIBA */}
                          <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                            <PhysicsToolbar 
                              onInsertTemplate={(latex) => {
                                const currentContent = formDataFlashcard.contenido || '';
                                const newContent = currentContent 
                                  ? currentContent + '\n\n' + latex
                                  : latex;
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: newContent
                                })
                              }}
                            />
                          </div>

                          {/* Editor f√≠sico - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <PhysicsEditor
                              value={formDataFlashcard.contenido}
                              onChange={(latex) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: latex
                              })}
                              placeholder="Escribe LaTeX o usa el panel de herramientas de f√≠sica..."
                            />

                            <div style={{
                              padding: '1rem',
                              background: 'rgba(245, 158, 11, 0.1)',
                              borderLeft: '4px solid #f59e0b',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#fef3c7',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#fbbf24'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en los botones para insertar ecuaciones y f√≥rmulas f√≠sicas<br/>
                              ‚Ä¢ Escribe LaTeX directamente para personalizar<br/>
                              ‚Ä¢ Las ecuaciones se renderizan en tiempo real en la vista previa<br/>
                              ‚Ä¢ Usa <code style={{background: 'rgba(245, 158, 11, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>\vec{'{F}'}</code> para vectores, <code style={{background: 'rgba(245, 158, 11, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>\nabla</code> para gradiente
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'ingenieria' ? (
                      /* Editor de ingenier√≠a */
                      <div style={{
                        background: 'linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(220, 38, 38, 0.12) 100%)',
                        border: '2px solid rgba(239, 68, 68, 0.3)',
                        borderRadius: '12px',
                        padding: '1.5rem',
                        boxShadow: '0 4px 12px rgba(239, 68, 68, 0.1)'
                      }}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                          {/* Panel de herramientas - ARRIBA */}
                          <div style={{
                            background: 'rgba(239, 68, 68, 0.05)',
                            borderRadius: '10px',
                            padding: '1rem',
                            border: '1px solid rgba(239, 68, 68, 0.2)'
                          }}>
                            <EngineeringToolbar
                              onInsertComponent={(comp) => {
                                const texto = `[${comp.nombre}] ${comp.latex || ''}`;
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: formDataFlashcard.contenido + '\n' + texto
                                });
                              }}
                            />
                          </div>

                          {/* Editor de ingenier√≠a - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <EngineeringCanvas
                              value={formDataFlashcard.contenido}
                              onChange={(texto) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: texto
                              })}
                              placeholder="Describe tu sistema de ingenier√≠a usando [Componentes]..."
                            />

                            <div style={{
                              padding: '1rem',
                              background: 'rgba(239, 68, 68, 0.1)',
                              borderLeft: '4px solid #ef4444',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#fca5a5',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#fecaca'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en componentes del panel superior para insertarlos<br/>
                              ‚Ä¢ Escribe directamente en formato: <code style={{background: 'rgba(239, 68, 68, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>[Componente] Par√°metros</code><br/>
                              ‚Ä¢ Ejemplo circuito: <code style={{background: 'rgba(239, 68, 68, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>[Resistencia] R = 10Œ©</code><br/>
                              ‚Ä¢ Ejemplo FBD: <code style={{background: 'rgba(239, 68, 68, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>[Fuerza] F = 50N ‚Üí</code>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'programacion-avanzada' ? (
                      /* Editor de programaci√≥n avanzada */
                      <div style={{
                        background: 'linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(124, 58, 237, 0.12) 100%)',
                        border: '2px solid rgba(139, 92, 246, 0.3)',
                        borderRadius: '12px',
                        padding: '1.5rem',
                        boxShadow: '0 4px 12px rgba(139, 92, 246, 0.1)'
                      }}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                          {/* Panel de herramientas - ARRIBA */}
                          <div style={{
                            background: 'rgba(139, 92, 246, 0.05)',
                            borderRadius: '10px',
                            padding: '1rem',
                            border: '1px solid rgba(139, 92, 246, 0.2)'
                          }}>
                            <ProgrammingToolbar
                              onInsertComponent={(comp) => {
                                const texto = `[${comp.nombre}] ${comp.latex || ''}`;
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: formDataFlashcard.contenido + '\n' + texto
                                });
                              }}
                            />
                          </div>

                          {/* Editor de programaci√≥n - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <ProgrammingCanvas
                              value={formDataFlashcard.contenido}
                              onChange={(texto) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: texto
                              })}
                              placeholder="Describe tu diagrama de programaci√≥n usando [Componentes]..."
                            />

                            <div style={{
                              padding: '1rem',
                              background: 'rgba(139, 92, 246, 0.1)',
                              borderLeft: '4px solid #8b5cf6',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#ddd6fe',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#e9d5ff'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en componentes del panel superior para insertarlos<br/>
                              ‚Ä¢ Escribe directamente en formato: <code style={{background: 'rgba(139, 92, 246, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>[Componente] Par√°metros</code><br/>
                              ‚Ä¢ Ejemplo UML: <code style={{background: 'rgba(139, 92, 246, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>[Clase] Usuario {'{+id, +nombre}'} {'{+login()}'}</code><br/>
                              ‚Ä¢ Ejemplo Flujo: <code style={{background: 'rgba(139, 92, 246, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>[Decisi√≥n] ¬øUsuario v√°lido?</code>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'logica-discreta' ? (
                      /* Editor de L√≥gica/Discreta */
                      <div style={{marginBottom: '1.5rem'}}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                          {/* Toolbar de L√≥gica/Discreta - ARRIBA */}
                          <div style={{
                            background: 'rgba(124, 58, 237, 0.05)',
                            borderRadius: '10px',
                            padding: '1rem',
                            border: '1px solid rgba(124, 58, 237, 0.2)'
                          }}>
                            <DiscreteToolbar
                              onInsertSymbol={(symbol) => {
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: formDataFlashcard.contenido + symbol
                                });
                              }}
                            />
                          </div>

                          {/* Editor de l√≥gica discreta - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <DiscreteCanvas
                              value={formDataFlashcard.contenido}
                              onChange={(texto) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: texto
                              })}
                              placeholder="Escribe expresiones l√≥gicas usando s√≠mbolos: ¬¨p ‚à® q, A ‚à™ B, etc..."
                            />

                            <div style={{
                              padding: '1rem',
                              background: 'rgba(124, 58, 237, 0.1)',
                              borderLeft: '4px solid #7c3aed',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#ddd6fe',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#e9d5ff'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en s√≠mbolos del panel superior para insertarlos<br/>
                              ‚Ä¢ L√≥gica: <code style={{background: 'rgba(124, 58, 237, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>¬¨p ‚à® q ‚Üí r</code><br/>
                              ‚Ä¢ Conjuntos: <code style={{background: 'rgba(124, 58, 237, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>A ‚à™ B = {'{1,2,3,4}'}</code><br/>
                              ‚Ä¢ Relaciones: <code style={{background: 'rgba(124, 58, 237, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>R = {'{(1,2), (2,3)}'}</code>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'linguistica' ? (
                      /* Editor de Ling√º√≠stica/Fon√©tica */
                      <div style={{marginBottom: '1.5rem'}}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                          {/* Toolbar de Ling√º√≠stica - ARRIBA */}
                          <div style={{
                            background: 'rgba(236, 72, 153, 0.05)',
                            borderRadius: '10px',
                            padding: '1rem',
                            border: '1px solid rgba(236, 72, 153, 0.2)'
                          }}>
                            <LinguisticsToolbar
                              onInsertSymbol={(symbol) => {
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: formDataFlashcard.contenido + symbol
                                });
                              }}
                            />
                          </div>

                          {/* Editor de ling√º√≠stica - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <LinguisticsCanvas
                              value={formDataFlashcard.contenido}
                              onChange={(texto) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: texto
                              })}
                              placeholder="Escribe transcripciones IPA: /Ààw…îÀêt…ô/, s√≠mbolos de stress: Ààhello ‚Üó, etc..."
                            />

                            <div style={{
                              padding: '1rem',
                              background: 'rgba(236, 72, 153, 0.1)',
                              borderLeft: '4px solid #ec4899',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#fce7f3',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#fbcfe8'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en s√≠mbolos IPA del panel superior para insertarlos<br/>
                              ‚Ä¢ Transcripci√≥n: <code style={{background: 'rgba(236, 72, 153, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>/Ààw…îÀêt…ô/ (water)</code><br/>
                              ‚Ä¢ Consonantes: <code style={{background: 'rgba(236, 72, 153, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>/Œ∏…™≈ãk/ (think)</code><br/>
                              ‚Ä¢ Stress: <code style={{background: 'rgba(236, 72, 153, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>Ààhello ‚Üó (pregunta)</code>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'musica' ? (
                      /* Editor de M√∫sica/Teor√≠a Musical */
                      <div style={{marginBottom: '1.5rem'}}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                          {/* Toolbar de M√∫sica - ARRIBA */}
                          <div style={{
                            background: 'rgba(168, 85, 247, 0.05)',
                            borderRadius: '10px',
                            padding: '1rem',
                            border: '1px solid rgba(168, 85, 247, 0.2)'
                          }}>
                            <MusicToolbar
                              onInsertSymbol={(symbol) => {
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: formDataFlashcard.contenido + symbol
                                });
                              }}
                            />
                          </div>

                          {/* Editor de m√∫sica - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <MusicCanvas
                              value={formDataFlashcard.contenido}
                              onChange={(texto) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: texto
                              })}
                            />

                            <div style={{
                              background: 'rgba(168, 85, 247, 0.08)',
                              padding: '1rem',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#f3e8ff',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#e9d5ff'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en s√≠mbolos musicales del panel superior para insertarlos<br/>
                              ‚Ä¢ Pentagrama: <code style={{background: 'rgba(168, 85, 247, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>ùÑû 4/4</code><br/>
                              ‚Ä¢ Acordes: <code style={{background: 'rgba(168, 85, 247, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>Cmaj7 = Do-Mi-Sol-Si</code><br/>
                              ‚Ä¢ Escala: <code style={{background: 'rgba(168, 85, 247, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>Do mayor: Do-Re-Mi-Fa-Sol-La-Si-Do</code>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'geometria' ? (
                      /* Editor de Geometr√≠a */
                      <div style={{marginBottom: '1.5rem'}}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                          {/* Toolbar de Geometr√≠a - ARRIBA */}
                          <div style={{
                            background: 'rgba(34, 197, 94, 0.05)',
                            borderRadius: '10px',
                            padding: '1rem',
                            border: '1px solid rgba(34, 197, 94, 0.2)'
                          }}>
                            <GeometryToolbar
                              onInsertSymbol={(symbol) => {
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: formDataFlashcard.contenido + symbol
                                });
                              }}
                            />
                          </div>

                          {/* Editor de geometr√≠a - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <GeometryCanvas
                              value={formDataFlashcard.contenido}
                              onChange={(texto) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: texto
                              })}
                            />

                            <div style={{
                              background: 'rgba(34, 197, 94, 0.08)',
                              padding: '1rem',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#d1fae5',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#a7f3d0'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en s√≠mbolos geom√©tricos del panel superior para insertarlos<br/>
                              ‚Ä¢ Tri√°ngulo: <code style={{background: 'rgba(34, 197, 94, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>‚ñ≥ABC</code><br/>
                              ‚Ä¢ √Ångulo: <code style={{background: 'rgba(34, 197, 94, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>‚à†ABC = 60¬∞</code><br/>
                              ‚Ä¢ Segmento: <code style={{background: 'rgba(34, 197, 94, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>ABÃÖ ‚üÇ CDÃÖ</code>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'quimica-avanzada' ? (
                      /* Editor de Qu√≠mica Avanzada */
                      <div style={{marginBottom: '1.5rem'}}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                          {/* Toolbar de Qu√≠mica Avanzada - ARRIBA */}
                          <div style={{
                            background: 'rgba(192, 132, 252, 0.05)',
                            borderRadius: '10px',
                            padding: '1rem',
                            border: '1px solid rgba(192, 132, 252, 0.2)'
                          }}>
                            <AdvancedChemistryToolbar
                              onInsertSymbol={(symbol) => {
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: formDataFlashcard.contenido + symbol
                                });
                              }}
                            />
                          </div>

                          {/* Editor de qu√≠mica avanzada - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <AdvancedChemistryCanvas
                              value={formDataFlashcard.contenido}
                              onChange={(texto) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: texto
                              })}
                            />

                            <div style={{
                              background: 'rgba(192, 132, 252, 0.08)',
                              padding: '1rem',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#f3e8ff',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#e9d5ff'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en s√≠mbolos qu√≠micos del panel superior para insertarlos<br/>
                              ‚Ä¢ Hibridaci√≥n: <code style={{background: 'rgba(192, 132, 252, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>[sp¬≥]‚ßìA 109.5¬∞</code><br/>
                              ‚Ä¢ VSEPR: <code style={{background: 'rgba(192, 132, 252, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>[AX‚ÇÑ] tetra√©drica</code><br/>
                              ‚Ä¢ Mecanismo: <code style={{background: 'rgba(192, 132, 252, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>Nu:‚Åª ‚Ü∑ ‚Üí E‚Å∫</code>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'probabilidad' ? (
                      /* Editor de Probabilidad y Estad√≠stica */
                      <div style={{marginBottom: '1.5rem'}}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                          {/* Toolbar de Probabilidad - ARRIBA */}
                          <div style={{
                            background: 'rgba(139, 92, 246, 0.05)',
                            borderRadius: '10px',
                            padding: '1rem',
                            border: '1px solid rgba(139, 92, 246, 0.2)'
                          }}>
                            <ProbabilityToolbar
                              onInsertElement={(element) => {
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: formDataFlashcard.contenido + '\n' + element
                                });
                              }}
                            />
                          </div>

                          {/* Editor de probabilidad - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <ProbabilityCanvas
                              value={formDataFlashcard.contenido}
                              onChange={(texto) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: texto
                              })}
                            />

                            <div style={{
                              background: 'rgba(139, 92, 246, 0.08)',
                              padding: '1rem',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              color: '#c4b5fd',
                              lineHeight: '1.6'
                            }}>
                              <strong style={{color: '#a78bfa'}}>üí° C√≥mo usar:</strong><br/>
                              ‚Ä¢ Haz clic en elementos del panel superior para insertarlos<br/>
                              ‚Ä¢ √Årbol: <code style={{background: 'rgba(139, 92, 246, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>‚Ä¢ ‚îÄ‚Üí [P=‚ñ°] ‚îÄ‚Üí ‚ñ°</code><br/>
                              ‚Ä¢ Bayes: <code style={{background: 'rgba(139, 92, 246, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>P(A|B) = P(B|A)¬∑P(A) / P(B)</code><br/>
                              ‚Ä¢ Normal: <code style={{background: 'rgba(139, 92, 246, 0.2)', padding: '2px 6px', borderRadius: '4px'}}>N(Œº=100, œÉ=15)</code>
                            </div>
                          </div>
                        </div>
                      </div>
                    ) : formDataFlashcard.tipo === 'arte' ? (
                      /* Editor de Arte y Dise√±o Visual */
                      <div style={{marginBottom: '1.5rem'}}>
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                          {/* Toolbar de Arte - ARRIBA */}
                          <div style={{
                            background: 'rgba(244, 114, 182, 0.05)',
                            borderRadius: '10px',
                            padding: '1rem',
                            border: '1px solid rgba(244, 114, 182, 0.2)'
                          }}>
                            <ArtToolbar
                              onInsertElement={(element) => {
                                setFormDataFlashcard({
                                  ...formDataFlashcard,
                                  contenido: formDataFlashcard.contenido + '\n' + element
                                });
                              }}
                            />
                          </div>

                          {/* Editor de arte - ABAJO */}
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                            <ArtCanvas
                              value={formDataFlashcard.contenido}
                              onChange={(texto) => setFormDataFlashcard({
                                ...formDataFlashcard,
                                contenido: texto
                              })}
                            />
                          </div>
                        </div>
                      </div>
                    ) : (
                      /* Textarea normal para otros tipos */
                      <textarea
                        className="textarea-prompt"
                        placeholder={
                          formDataFlashcard.tipo === 'clasica' ? '¬øCu√°l es la definici√≥n de...?\n¬øQu√© es...?\n¬øC√≥mo funciona...?' :
                          formDataFlashcard.tipo === 'reconocimiento' ? 'URL de imagen o descripci√≥n:\nIdentifica: [concepto clave]' :
                          formDataFlashcard.tipo === 'cloze' ? 'La capital de Francia es [].\nEl [] es un proceso de [].' :
                          formDataFlashcard.tipo === 'escenario' ? 'Un cliente llega con el siguiente problema:\n[Descripci√≥n del caso]\n¬øQu√© har√≠as?' :
                          formDataFlashcard.tipo === 'mcq' ? '¬øCu√°l de las siguientes opciones...?\n¬øQu√© es correcto sobre...?' :
                          formDataFlashcard.tipo === 'visual' ? 'Describe lo que ves en la imagen.\nURL/referencia de imagen' :
                          formDataFlashcard.tipo === 'auditiva' ? 'Audio: [palabra/frase]\n¬øC√≥mo se pronuncia...?' :
                          formDataFlashcard.tipo === 'produccion' ? 'Produce: Escribe un ejemplo de...\nGenera una lista de...' :
                          formDataFlashcard.tipo === 'invertida' ? 'Respuesta: [dato/definici√≥n]\nRecuerda: ¬øCu√°l era la pregunta?' :
                          formDataFlashcard.tipo === 'jerarquia' ? 'Nodo principal: [Concepto]\n‚îú‚îÄ Subnodo 1\n‚îú‚îÄ Subnodo 2\n‚îî‚îÄ Subnodo 3' :
                          formDataFlashcard.tipo === 'error' ? 'Texto con error:\nLa fotosintisis es un proceso...\n‚ö†Ô∏è Corrige el error' :
                          formDataFlashcard.tipo === 'comparacion' ? 'Elemento A:\n[Descripci√≥n/caracter√≠sticas]' :
                          formDataFlashcard.tipo === 'archivo' ? 'Describe el contenido del documento adjunto' :
                          formDataFlashcard.tipo === 'programacion' ? (
                            formDataFlashcard.patronCodigo === 'comprension' ? 'function sum(arr) {\n  return arr.reduce((acc, x) => acc + x, 0);\n}\n\n¬øQu√© hace esta funci√≥n?' :
                            formDataFlashcard.patronCodigo === 'bug' ? 'def divide(a, b):\n    return a / b\n    if b == 0:  # ‚ùå BUG AQU√ç\n        return 0' :
                            formDataFlashcard.patronCodigo === 'cloze' ? 'for (let i = 0; i < []; i++) {\n  console.log(i);\n}' :
                            'Escribe una funci√≥n que recibe un array de n√∫meros y devuelve solo los pares.'
                          ) :
                          'Escribe el contenido de la flashcard'
                        }
                        value={formDataFlashcard.contenido}
                        onChange={(e) => setFormDataFlashcard({...formDataFlashcard, contenido: e.target.value})}
                        rows={formDataFlashcard.tipo === 'escenario' || formDataFlashcard.tipo === 'jerarquia' || formDataFlashcard.tipo === 'programacion' ? 6 : 4}
                        style={formDataFlashcard.tipo === 'programacion' ? {
                          fontFamily: 'monospace',
                          fontSize: '0.9rem',
                          background: 'rgba(30, 41, 59, 0.6)',
                          border: '2px solid rgba(20, 184, 166, 0.3)'
                        } : {}}
                      />
                    )}
                  </div>

                  {/* Opciones (solo para MCQ) */}
                  {formDataFlashcard.tipo === 'mcq' && (
                    <div className="config-section">
                      <label className="config-label">
                        <span className="label-icon">‚òëÔ∏è</span>
                        Opciones de Respuesta
                      </label>
                      <textarea
                        className="textarea-prompt"
                        placeholder="A) Primera opci√≥n&#10;B) Segunda opci√≥n&#10;C) Tercera opci√≥n&#10;D) Cuarta opci√≥n"
                        value={Array.isArray(formDataFlashcard.opciones) ? formDataFlashcard.opciones.join('\n') : ''}
                        onChange={(e) => setFormDataFlashcard({
                          ...formDataFlashcard, 
                          opciones: e.target.value.split('\n').filter(o => o.trim())
                        })}
                        rows={4}
                      />
                      <p className="config-hint" style={{marginTop: '0.5rem', fontSize: '0.85rem', color: '#94a3b8'}}>
                        üí° Usa el formato: A) Opci√≥n 1, B) Opci√≥n 2, etc.
                      </p>
                    </div>
                  )}

                  {/* Campo adicional para Comparaci√≥n (Elemento B) */}
                  {formDataFlashcard.tipo === 'comparacion' && (
                    <div className="config-section">
                      <label className="config-label">
                        <span className="label-icon">‚öñÔ∏è</span>
                        Elemento B (para comparar)
                      </label>
                      <textarea
                        className="textarea-prompt"
                        placeholder="Elemento B:&#10;[Descripci√≥n/caracter√≠sticas del segundo elemento]"
                        value={formDataFlashcard.explicacion}
                        onChange={(e) => setFormDataFlashcard({...formDataFlashcard, explicacion: e.target.value})}
                        rows={4}
                      />
                      <p className="config-hint" style={{marginTop: '0.5rem', fontSize: '0.85rem', color: '#94a3b8'}}>
                        üí° Este campo se usar√° como el segundo elemento de la comparaci√≥n
                      </p>
                    </div>
                  )}

                  {/* Respuesta Correcta */}
                  <div className="config-section">
                    <label className="config-label">
                      <span className="label-icon">‚úÖ</span>
                      {formDataFlashcard.tipo === 'mcq' ? 'Respuesta Correcta (Indica la letra)' :
                       formDataFlashcard.tipo === 'cloze' ? 'Palabras que completan los []' :
                       formDataFlashcard.tipo === 'error' ? 'Versi√≥n Corregida' :
                       formDataFlashcard.tipo === 'reconocimiento' ? 'Concepto/Nombre Correcto' :
                       formDataFlashcard.tipo === 'invertida' ? 'Pregunta Original' :
                       formDataFlashcard.tipo === 'produccion' ? 'Ejemplo de Respuesta' :
                       'Respuesta Correcta'}
                    </label>
                    <textarea
                      className="textarea-prompt"
                      placeholder={
                        formDataFlashcard.tipo === 'mcq' ? 'Ejemplo: B) Segunda opci√≥n' :
                        formDataFlashcard.tipo === 'cloze' ? 'Palabra 1, Palabra 2, ...' :
                        formDataFlashcard.tipo === 'error' ? 'La fotos√≠ntesis es un proceso...' :
                        formDataFlashcard.tipo === 'reconocimiento' ? 'Nombre del concepto identificado' :
                        formDataFlashcard.tipo === 'invertida' ? '¬øCu√°l era la pregunta?' :
                        'La respuesta correcta es...'
                      }
                      value={formDataFlashcard.respuestaCorrecta}
                      onChange={(e) => setFormDataFlashcard({...formDataFlashcard, respuestaCorrecta: e.target.value})}
                      rows={3}
                    />
                  </div>

                  {/* Explicaci√≥n - Oculto para comparaci√≥n ya que usa este campo para Elemento B */}
                  {formDataFlashcard.tipo !== 'comparacion' && (
                    <div className="config-section">
                      <label className="config-label">
                        <span className="label-icon">üí°</span>
                        {formDataFlashcard.tipo === 'error' ? 'Explicaci√≥n del Error' :
                         formDataFlashcard.tipo === 'jerarquia' ? 'Relaciones entre Nodos' :
                         'Explicaci√≥n (opcional)'}
                      </label>
                      <textarea
                        className="textarea-prompt"
                        placeholder={
                          formDataFlashcard.tipo === 'error' ? 'Explica por qu√© es un error com√∫n y c√≥mo recordar la forma correcta' :
                          formDataFlashcard.tipo === 'jerarquia' ? 'Describe las relaciones jer√°rquicas entre conceptos' :
                          formDataFlashcard.tipo === 'escenario' ? 'Contexto adicional, pistas para resolver el caso' :
                          'Explicaci√≥n adicional, mnemotecnia, consejos para recordar...'
                        }
                        value={formDataFlashcard.explicacion}
                        onChange={(e) => setFormDataFlashcard({...formDataFlashcard, explicacion: e.target.value})}
                        rows={3}
                      />
                    </div>
                  )}

                  {/* Tema/Tags */}
                  <div className="config-section">
                    <label className="config-label">
                      <span className="label-icon">üè∑Ô∏è</span>
                      Tema/Etiqueta
                    </label>
                    <input
                      type="text"
                      className="input-text"
                      placeholder="Ej: JavaScript, Historia, Matem√°ticas"
                      value={formDataFlashcard.tema}
                      onChange={(e) => setFormDataFlashcard({...formDataFlashcard, tema: e.target.value})}
                    />
                  </div>

                  {/* Subtema (opcional) */}
                  <div className="config-section">
                    <label className="config-label">
                      <span className="label-icon">üìå</span>
                      Subtema (opcional)
                    </label>
                    <input
                      type="text"
                      className="input-text"
                      placeholder="Ej: √Ålgebra Lineal, Segunda Guerra Mundial, React Hooks"
                      value={formDataFlashcard.subtema}
                      onChange={(e) => setFormDataFlashcard({...formDataFlashcard, subtema: e.target.value})}
                    />
                  </div>

                  {/* Botones */}
                  <div className="modal-actions">
                    <button 
                      type="button" 
                      className="btn-secondary"
                      onClick={() => {
                        setModalNuevaFlashcard(false);
                        setFlashcardEditando(null);
                      }}
                    >
                      Cancelar
                    </button>
                    <button type="submit" className="btn-primary">
                      {flashcardEditando ? 'üíæ Guardar Cambios' : '‚ûï Crear Flashcard'}
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        )}

        {/* ============= MODAL VISTA COMPLETA DE FLASHCARD ============= */}
        {flashcardVistaCompleta && (
          <div className="modal-overlay" onClick={() => setFlashcardVistaCompleta(null)} style={{
            background: 'rgba(0, 0, 0, 0.85)',
            backdropFilter: 'blur(8px)'
          }}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{
              maxWidth: '900px',
              width: '95%',
              maxHeight: '90vh',
              overflow: 'auto',
              background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
              border: '1px solid rgba(148, 163, 184, 0.2)'
            }}>
              {/* Header con acciones */}
              <div style={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                padding: '1.5rem',
                borderBottom: '1px solid rgba(148, 163, 184, 0.15)'
              }}>
                <button 
                  onClick={() => setFlashcardVistaCompleta(null)}
                  style={{
                    padding: '0.75rem 1.25rem',
                    background: 'rgba(100, 116, 139, 0.3)',
                    border: '1px solid rgba(148, 163, 184, 0.3)',
                    borderRadius: '8px',
                    color: '#cbd5e1',
                    cursor: 'pointer',
                    fontWeight: '600',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem'
                  }}
                >
                  ‚Üê Volver
                </button>
                <button 
                  onClick={() => {
                    setFlashcardEditando(flashcardVistaCompleta);
                    setFormDataFlashcard(flashcardVistaCompleta);
                    setFlashcardVistaCompleta(null);
                    setModalNuevaFlashcard(true);
                  }}
                  style={{
                    padding: '0.75rem 1.25rem',
                    background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                    border: 'none',
                    borderRadius: '8px',
                    color: 'white',
                    cursor: 'pointer',
                    fontWeight: '600',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem'
                  }}
                >
                  ‚úèÔ∏è Editar flashcard
                </button>
              </div>

              {/* Contenido de la flashcard */}
              <div style={{padding: '2rem'}}>
                {/* Badge de tipo */}
                {(() => {
                  const tipoConfig = {
                    clasica: { color: '#667eea', icon: 'üìá', nombre: 'Cl√°sica' },
                    reconocimiento: { color: '#f093fb', icon: 'üëÅÔ∏è', nombre: 'Reconocimiento' },
                    cloze: { color: '#4facfe', icon: 'üî§', nombre: 'Cloze' },
                    escenario: { color: '#43e97b', icon: 'üé¨', nombre: 'Escenario' },
                    mcq: { color: '#fa709a', icon: '‚òëÔ∏è', nombre: 'Opci√≥n M√∫ltiple' },
                    visual: { color: '#30cfd0', icon: 'üñºÔ∏è', nombre: 'Visual' },
                    auditiva: { color: '#a8edea', icon: 'üîä', nombre: 'Auditiva' },
                    produccion: { color: '#ffa751', icon: '‚úçÔ∏è', nombre: 'Producci√≥n' },
                    invertida: { color: '#764ba2', icon: 'üîÑ', nombre: 'Invertida' },
                    jerarquia: { color: '#667eea', icon: 'üèóÔ∏è', nombre: 'Jerarqu√≠a' },
                    error: { color: '#f093fb', icon: '‚ùå', nombre: 'Error' },
                    comparacion: { color: '#4facfe', icon: '‚öñÔ∏è', nombre: 'Comparaci√≥n' },
                    matematica: { color: '#3b82f6', icon: 'üî¢', nombre: 'Matem√°tica' },
                    archivo: { color: '#64748b', icon: 'üìé', nombre: 'Archivo' },
                    programacion: { color: '#14b8a6', icon: '</>', nombre: 'PROGRAMACI√ìN' }, // Teal
                    quimica: { color: '#10b981', icon: 'üß™', nombre: 'QU√çMICA' }, // Verde esmeralda
                    fisica: { color: '#f59e0b', icon: '‚öõÔ∏è', nombre: 'F√çSICA' }, // Naranja/√Åmbar
                    ingenieria: { color: '#ef4444', icon: 'üîß', nombre: 'INGENIER√çA' }, // Rojo
                    'programacion-avanzada': { color: '#8b5cf6', icon: 'üíª', nombre: 'PROGRAMACI√ìN' }, // Morado
                    'logica-discreta': { color: '#7c3aed', icon: 'üîÆ', nombre: 'L√ìGICA' }, // Morado oscuro
                    linguistica: { color: '#ec4899', icon: 'üó£Ô∏è', nombre: 'LINGU√çSTICA' }, // Rosa
                    musica: { color: '#a855f7', icon: 'üéº', nombre: 'M√öSICA' }, // P√∫rpura
                    geometria: { color: '#22c55e', icon: 'üìê', nombre: 'GEOMETR√çA' }, // Verde
                    'quimica-avanzada': { color: '#c084fc', icon: 'üß¨', nombre: 'QCA AVANZADA' } // P√∫rpura claro
                  };
                  const config = tipoConfig[flashcardVistaCompleta.tipo] || tipoConfig.clasica;

                  return (
                    <div style={{
                      display: 'inline-flex',
                      alignItems: 'center',
                      gap: '0.5rem',
                      padding: '0.65rem 1.25rem',
                      background: `linear-gradient(135deg, ${config.color} 0%, ${config.color}dd 100%)`,
                      borderRadius: '20px',
                      color: 'white',
                      fontSize: '0.95rem',
                      fontWeight: '600',
                      marginBottom: '1.5rem',
                      boxShadow: `0 4px 12px ${config.color}40`
                    }}>
                      <span>{config.icon}</span>
                      <span>{config.nombre}</span>
                    </div>
                  );
                })()}

                {/* T√≠tulo */}
                <h1 style={{
                  color: '#f1f5f9',
                  fontSize: '2rem',
                  fontWeight: '700',
                  marginBottom: '1.5rem',
                  lineHeight: '1.3'
                }}>
                  {flashcardVistaCompleta.titulo}
                </h1>

                {/* Im√°genes */}
                {flashcardVistaCompleta.imagenes && flashcardVistaCompleta.imagenes.length > 0 && (
                  <div style={{
                    marginBottom: '2rem',
                    display: 'grid',
                    gridTemplateColumns: flashcardVistaCompleta.imagenes.length === 1 ? '1fr' : 'repeat(auto-fit, minmax(300px, 1fr))',
                    gap: '1rem'
                  }}>
                    {flashcardVistaCompleta.imagenes.map((img, idx) => (
                      <div key={idx} style={{
                        borderRadius: '12px',
                        overflow: 'hidden',
                        border: '2px solid rgba(148, 163, 184, 0.2)',
                        boxShadow: '0 4px 20px rgba(0, 0, 0, 0.3)',
                        cursor: 'zoom-in',
                        transition: 'transform 0.2s'
                      }}
                      onClick={() => setImagenZoom(img.url)}
                      onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.02)'}
                      onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                      >
                        <img src={img.url} alt={img.nombre} style={{
                          width: '100%',
                          height: 'auto',
                          display: 'block'
                        }} />
                      </div>
                    ))}
                  </div>
                )}

                {/* Contenido con LaTeX, C√≥digo, Qu√≠mica o F√≠sica */}
                <div style={{
                  background: flashcardVistaCompleta.latex 
                    ? 'rgba(59, 130, 246, 0.08)' 
                    : flashcardVistaCompleta.tipo === 'programacion'
                    ? 'rgba(20, 184, 166, 0.08)'
                    : flashcardVistaCompleta.tipo === 'quimica'
                    ? 'rgba(16, 185, 129, 0.08)'
                    : flashcardVistaCompleta.tipo === 'fisica'
                    ? 'rgba(245, 158, 11, 0.08)'
                    : flashcardVistaCompleta.tipo === 'musica'
                    ? 'rgba(168, 85, 247, 0.08)'
                    : flashcardVistaCompleta.tipo === 'geometria'
                    ? 'rgba(34, 197, 94, 0.08)'
                    : flashcardVistaCompleta.tipo === 'quimica-avanzada'
                    ? 'rgba(192, 132, 252, 0.08)'
                    : flashcardVistaCompleta.tipo === 'probabilidad'
                    ? 'rgba(139, 92, 246, 0.08)'
                    : flashcardVistaCompleta.tipo === 'arte'
                    ? 'rgba(244, 114, 182, 0.08)'
                    : 'rgba(100, 116, 139, 0.15)',
                  padding: '1.5rem',
                  borderRadius: '12px',
                  border: flashcardVistaCompleta.latex 
                    ? '2px solid rgba(59, 130, 246, 0.3)' 
                    : flashcardVistaCompleta.tipo === 'programacion'
                    ? '2px solid rgba(20, 184, 166, 0.3)'
                    : flashcardVistaCompleta.tipo === 'quimica'
                    ? '2px solid rgba(16, 185, 129, 0.3)'
                    : flashcardVistaCompleta.tipo === 'fisica'
                    ? '2px solid rgba(245, 158, 11, 0.3)'
                    : flashcardVistaCompleta.tipo === 'musica'
                    ? '2px solid rgba(168, 85, 247, 0.3)'
                    : flashcardVistaCompleta.tipo === 'geometria'
                    ? '2px solid rgba(34, 197, 94, 0.3)'
                    : flashcardVistaCompleta.tipo === 'quimica-avanzada'
                    ? '2px solid rgba(192, 132, 252, 0.3)'
                    : flashcardVistaCompleta.tipo === 'probabilidad'
                    ? '2px solid rgba(139, 92, 246, 0.3)'
                    : flashcardVistaCompleta.tipo === 'arte'
                    ? '2px solid rgba(244, 114, 182, 0.3)'
                    : '2px solid rgba(148, 163, 184, 0.15)',
                  marginBottom: '1.5rem'
                }}>
                  <h3 style={{
                    color: '#cbd5e1',
                    fontSize: '1rem',
                    fontWeight: '600',
                    marginBottom: '1rem',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em'
                  }}>
                    {flashcardVistaCompleta.tipo === 'clasica' ? 'Pregunta' :
                     flashcardVistaCompleta.tipo === 'cloze' ? 'Completa' :
                     flashcardVistaCompleta.tipo === 'escenario' ? 'Escenario' :
                     flashcardVistaCompleta.tipo === 'matematica' ? 'F√≥rmula' :
                     flashcardVistaCompleta.tipo === 'quimica' ? 'Estructura Qu√≠mica' :
                     flashcardVistaCompleta.tipo === 'fisica' ? 'Ecuaci√≥n/Diagrama F√≠sico' :
                     flashcardVistaCompleta.tipo === 'ingenieria' ? 'Diagrama de Ingenier√≠a' :
                     flashcardVistaCompleta.tipo === 'programacion-avanzada' ? 'Diagrama de Programaci√≥n' :
                     flashcardVistaCompleta.tipo === 'logica-discreta' ? 'Expresi√≥n L√≥gica/Discreta' :
                     flashcardVistaCompleta.tipo === 'linguistica' ? 'Transcripci√≥n Fon√©tica' :
                     flashcardVistaCompleta.tipo === 'musica' ? 'Notaci√≥n Musical' :
                     flashcardVistaCompleta.tipo === 'geometria' ? 'Construcci√≥n Geom√©trica' :
                     flashcardVistaCompleta.tipo === 'quimica-avanzada' ? 'Estructura Qu√≠mica Avanzada' :
                     flashcardVistaCompleta.tipo === 'probabilidad' ? 'Elemento Estad√≠stico' :
                     flashcardVistaCompleta.tipo === 'arte' ? 'Composici√≥n Visual' :
                     flashcardVistaCompleta.tipo === 'programacion' ? (
                       flashcardVistaCompleta.patronCodigo === 'produccion' ? 'Tarea' : 'C√≥digo'
                     ) :
                     'Contenido'}
                  </h3>
                  <div style={{
                    color: '#e2e8f0',
                    fontSize: '1.1rem',
                    lineHeight: '1.8',
                    whiteSpace: 'pre-wrap',
                    fontFamily: flashcardVistaCompleta.latex ? 'serif' : 
                                flashcardVistaCompleta.tipo === 'programacion' ? 'monospace' : 
                                flashcardVistaCompleta.tipo === 'quimica' ? 'monospace' :
                                flashcardVistaCompleta.tipo === 'fisica' ? 'serif' :
                                flashcardVistaCompleta.tipo === 'ingenieria' ? 'monospace' :
                                flashcardVistaCompleta.tipo === 'programacion-avanzada' ? 'monospace' :
                                flashcardVistaCompleta.tipo === 'logica-discreta' ? 'monospace' :
                                flashcardVistaCompleta.tipo === 'linguistica' ? 'monospace' :
                                flashcardVistaCompleta.tipo === 'musica' ? 'serif' :
                                flashcardVistaCompleta.tipo === 'geometria' ? 'serif' :
                                flashcardVistaCompleta.tipo === 'quimica-avanzada' ? 'monospace' :
                                flashcardVistaCompleta.tipo === 'probabilidad' ? 'monospace' :
                                flashcardVistaCompleta.tipo === 'arte' ? 'monospace' :
                                'inherit'
                  }}>
                    {flashcardVistaCompleta.latex ? (
                      // üî• Renderizado KaTeX real
                      <BlockMath math={flashcardVistaCompleta.contenido} />
                    ) : flashcardVistaCompleta.tipo === 'quimica' && flashcardVistaCompleta.contenido ? (
                      // üß™ Renderizado de estructura qu√≠mica con canvas
                      <div style={{textAlign: 'center', padding: '1rem 0'}}>
                        <ChemEditor 
                          value={flashcardVistaCompleta.contenido}
                          onChange={() => {}} // Solo lectura
                          placeholder=""
                        />
                      </div>
                    ) : flashcardVistaCompleta.tipo === 'fisica' && flashcardVistaCompleta.contenido ? (
                      // ‚öõÔ∏è Renderizado de ecuaciones f√≠sicas con KaTeX
                      <div style={{textAlign: 'center', padding: '1rem 0'}}>
                        {flashcardVistaCompleta.contenido.split('\n\n').map((line, idx) => (
                          line.trim() && (
                            <div key={idx} style={{ marginBottom: '1rem' }}>
                              <BlockMath math={line.trim()} />
                            </div>
                          )
                        ))}
                      </div>
                    ) : flashcardVistaCompleta.tipo === 'ingenieria' && flashcardVistaCompleta.contenido ? (
                      // üîß Renderizado de diagrama de ingenier√≠a
                      <div style={{
                        background: 'rgba(239, 68, 68, 0.05)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid rgba(239, 68, 68, 0.2)',
                        fontFamily: 'monospace',
                        whiteSpace: 'pre-wrap',
                        fontSize: '0.95rem',
                        lineHeight: '1.8'
                      }}>
                        {flashcardVistaCompleta.contenido}
                      </div>
                    ) : flashcardVistaCompleta.tipo === 'programacion-avanzada' && flashcardVistaCompleta.contenido ? (
                      // üíª Renderizado de diagrama de programaci√≥n
                      <div style={{
                        background: 'rgba(139, 92, 246, 0.05)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid rgba(139, 92, 246, 0.2)',
                        fontFamily: 'monospace',
                        whiteSpace: 'pre-wrap',
                        fontSize: '0.95rem',
                        lineHeight: '1.8'
                      }}>
                        {flashcardVistaCompleta.contenido}
                      </div>
                    ) : flashcardVistaCompleta.tipo === 'logica-discreta' && flashcardVistaCompleta.contenido ? (
                      // üîÆ Renderizado de l√≥gica/discreta
                      <div style={{
                        background: 'rgba(124, 58, 237, 0.05)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid rgba(124, 58, 237, 0.2)',
                        fontFamily: 'monospace',
                        whiteSpace: 'pre-wrap',
                        fontSize: '0.95rem',
                        lineHeight: '1.8'
                      }}>
                        {flashcardVistaCompleta.contenido}
                      </div>
                    ) : flashcardVistaCompleta.tipo === 'linguistica' && flashcardVistaCompleta.contenido ? (
                      // üó£Ô∏è Renderizado de ling√º√≠stica
                      <div style={{
                        background: 'rgba(236, 72, 153, 0.05)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid rgba(236, 72, 153, 0.2)',
                        fontFamily: 'monospace',
                        whiteSpace: 'pre-wrap',
                        fontSize: '0.95rem',
                        lineHeight: '1.8'
                      }}>
                        {flashcardVistaCompleta.contenido}
                      </div>
                    ) : flashcardVistaCompleta.tipo === 'musica' && flashcardVistaCompleta.contenido ? (
                      // üéº Renderizado de notaci√≥n musical
                      <div style={{
                        background: 'rgba(168, 85, 247, 0.05)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid rgba(168, 85, 247, 0.2)',
                        fontFamily: 'serif',
                        whiteSpace: 'pre-wrap',
                        fontSize: '1.3rem',
                        lineHeight: '2'
                      }}>
                        {flashcardVistaCompleta.contenido}
                      </div>
                    ) : flashcardVistaCompleta.tipo === 'geometria' && flashcardVistaCompleta.contenido ? (
                      // üìê Renderizado de geometr√≠a
                      <div style={{
                        background: 'rgba(34, 197, 94, 0.05)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid rgba(34, 197, 94, 0.2)',
                        fontFamily: 'serif',
                        whiteSpace: 'pre-wrap',
                        fontSize: '1.2rem',
                        lineHeight: '1.8'
                      }}>
                        {flashcardVistaCompleta.contenido}
                      </div>
                    ) : flashcardVistaCompleta.tipo === 'quimica-avanzada' && flashcardVistaCompleta.contenido ? (
                      // üß¨ Renderizado de qu√≠mica avanzada
                      <div style={{
                        background: 'rgba(192, 132, 252, 0.05)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid rgba(192, 132, 252, 0.2)',
                        fontFamily: 'monospace',
                        whiteSpace: 'pre-wrap',
                        fontSize: '1rem',
                        lineHeight: '2.2'
                      }}>
                        {flashcardVistaCompleta.contenido}
                      </div>
                    ) : flashcardVistaCompleta.tipo === 'probabilidad' && flashcardVistaCompleta.contenido ? (
                      // üé≤ Renderizado de Probabilidad y Estad√≠stica
                      <div style={{
                        background: 'rgba(139, 92, 246, 0.05)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid rgba(139, 92, 246, 0.2)',
                        fontFamily: 'monospace',
                        whiteSpace: 'pre-wrap',
                        fontSize: '1.1rem',
                        lineHeight: '2'
                      }}>
                        {flashcardVistaCompleta.contenido}
                      </div>
                    ) : flashcardVistaCompleta.tipo === 'arte' && flashcardVistaCompleta.contenido ? (
                      // üé® Renderizado de Arte y Dise√±o Visual
                      <div style={{
                        background: 'rgba(244, 114, 182, 0.05)',
                        padding: '1.5rem',
                        borderRadius: '8px',
                        border: '1px solid rgba(244, 114, 182, 0.2)',
                        fontFamily: 'monospace',
                        whiteSpace: 'pre-wrap',
                        fontSize: '1.1rem',
                        lineHeight: '2'
                      }}>
                        {flashcardVistaCompleta.contenido}
                      </div>
                    ) : (
                      flashcardVistaCompleta.contenido
                    )}
                  </div>
                  {flashcardVistaCompleta.latex && (
                    <div style={{
                      marginTop: '0.75rem',
                      padding: '0.5rem',
                      background: 'rgba(59, 130, 246, 0.15)',
                      borderRadius: '6px',
                      fontSize: '0.85rem',
                      color: '#60a5fa'
                    }}>
                      üìê Esta flashcard contiene notaci√≥n matem√°tica (LaTeX)
                    </div>
                  )}
                  {flashcardVistaCompleta.tipo === 'quimica' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.75rem',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(16, 185, 129, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#6ee7b7',
                        fontWeight: '600'
                      }}>
                        üß™ {flashcardVistaCompleta.rama?.toUpperCase() || 'QU√çMICA'}
                      </div>
                      {flashcardVistaCompleta.subtipoQuimica && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(16, 185, 129, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#a7f3d0',
                          fontWeight: '600'
                        }}>
                          ‚öóÔ∏è {flashcardVistaCompleta.subtipoQuimica.charAt(0).toUpperCase() + 
                               flashcardVistaCompleta.subtipoQuimica.slice(1)}
                        </div>
                      )}
                      {flashcardVistaCompleta.nivelQuimica && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.nivelQuimica === 'basico' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.nivelQuimica === 'intermedio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(168, 85, 247, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.nivelQuimica === 'basico' ? '#4ade80' :
                                 flashcardVistaCompleta.nivelQuimica === 'intermedio' ? '#fbbf24' :
                                 '#c084fc',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.nivelQuimica === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.nivelQuimica === 'intermedio' ? 'üü° Intermedio' :
                           'üü£ Avanzado'}
                        </div>
                      )}
                    </div>
                  )}
                  {flashcardVistaCompleta.tipo === 'ingenieria' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.75rem',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(239, 68, 68, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#fca5a5',
                        fontWeight: '600'
                      }}>
                        üîß {flashcardVistaCompleta.ramaIngenieria?.toUpperCase() || 'INGENIER√çA'}
                      </div>
                      {flashcardVistaCompleta.subtipoIngenieria && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(239, 68, 68, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#fecaca',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.subtipoIngenieria === 'circuito' ? '‚ö° Circuito' :
                           flashcardVistaCompleta.subtipoIngenieria === 'fbd' ? 'üéØ FBD' :
                           flashcardVistaCompleta.subtipoIngenieria === 'viga' ? 'üèóÔ∏è Viga' :
                           flashcardVistaCompleta.subtipoIngenieria === 'material' ? 'üî¨ Material' :
                           '‚öôÔ∏è Mecanismo'}
                        </div>
                      )}
                      {flashcardVistaCompleta.nivelIngenieria && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.nivelIngenieria === 'basico' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.nivelIngenieria === 'intermedio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(168, 85, 247, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.nivelIngenieria === 'basico' ? '#4ade80' :
                                 flashcardVistaCompleta.nivelIngenieria === 'intermedio' ? '#fbbf24' :
                                 '#c084fc',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.nivelIngenieria === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.nivelIngenieria === 'intermedio' ? 'üü° Intermedio' :
                           'üü£ Avanzado'}
                        </div>
                      )}
                    </div>
                  )}
                  {flashcardVistaCompleta.tipo === 'programacion-avanzada' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.75rem',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(139, 92, 246, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#ddd6fe',
                        fontWeight: '600'
                      }}>
                        üíª {flashcardVistaCompleta.subtipoProgramacion?.toUpperCase() || 'PROGRAMACI√ìN'}
                      </div>
                      {flashcardVistaCompleta.patronProgramacion && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(139, 92, 246, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#e9d5ff',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.patronProgramacion === 'clase' ? 'üì¶ Clases' :
                           flashcardVistaCompleta.patronProgramacion === 'secuencia' ? '‚è±Ô∏è Secuencia' :
                           flashcardVistaCompleta.patronProgramacion === 'casos-uso' ? 'üë§ Casos Uso' :
                           flashcardVistaCompleta.patronProgramacion === 'algoritmo' ? 'üî¢ Algoritmo' :
                           flashcardVistaCompleta.patronProgramacion === 'arbol-binario' ? 'üå≥ √Årbol' :
                           flashcardVistaCompleta.patronProgramacion === 'afd' ? 'üéØ AFD' :
                           flashcardVistaCompleta.patronProgramacion.charAt(0).toUpperCase() + 
                           flashcardVistaCompleta.patronProgramacion.slice(1)}
                        </div>
                      )}
                      {flashcardVistaCompleta.nivelProgramacion && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.nivelProgramacion === 'basico' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.nivelProgramacion === 'intermedio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(168, 85, 247, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.nivelProgramacion === 'basico' ? '#4ade80' :
                                 flashcardVistaCompleta.nivelProgramacion === 'intermedio' ? '#fbbf24' :
                                 '#c084fc',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.nivelProgramacion === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.nivelProgramacion === 'intermedio' ? 'üü° Intermedio' :
                           'üü£ Avanzado'}
                        </div>
                      )}
                    </div>
                  )}
                  {flashcardVistaCompleta.tipo === 'logica-discreta' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.75rem',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(124, 58, 237, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#ddd6fe',
                        fontWeight: '600'
                      }}>
                        üîÆ {flashcardVistaCompleta.subtipoDiscreta?.toUpperCase() || 'L√ìGICA'}
                      </div>
                      {flashcardVistaCompleta.categoriaDiscreta && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(124, 58, 237, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#e9d5ff',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.categoriaDiscreta === 'proposicional' ? 'üí≠ Proposiciones' :
                           flashcardVistaCompleta.categoriaDiscreta === 'conectivos' ? 'üîó Conectivos' :
                           flashcardVistaCompleta.categoriaDiscreta === 'tablas' ? 'üìä Tablas' :
                           flashcardVistaCompleta.categoriaDiscreta === 'operaciones' ? '‚ûï Operaciones' :
                           flashcardVistaCompleta.categoriaDiscreta === 'pares' ? 'üìå Pares' :
                           flashcardVistaCompleta.categoriaDiscreta === 'dirigidos' ? '‚û°Ô∏è Dirigidos' :
                           flashcardVistaCompleta.categoriaDiscreta.charAt(0).toUpperCase() + 
                           flashcardVistaCompleta.categoriaDiscreta.slice(1)}
                        </div>
                      )}
                      {flashcardVistaCompleta.nivelDiscreta && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.nivelDiscreta === 'basico' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.nivelDiscreta === 'intermedio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(168, 85, 247, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.nivelDiscreta === 'basico' ? '#4ade80' :
                                 flashcardVistaCompleta.nivelDiscreta === 'intermedio' ? '#fbbf24' :
                                 '#c084fc',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.nivelDiscreta === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.nivelDiscreta === 'intermedio' ? 'üü° Intermedio' :
                           'üü£ Avanzado'}
                        </div>
                      )}
                    </div>
                  )}
                  {flashcardVistaCompleta.tipo === 'linguistica' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.75rem',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(236, 72, 153, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#fce7f3',
                        fontWeight: '600'
                      }}>
                        üó£Ô∏è {flashcardVistaCompleta.subtipoLinguistica?.toUpperCase() || 'LING√ú√çSTICA'}
                      </div>
                      {flashcardVistaCompleta.categoriaLinguistica && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(236, 72, 153, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#fbcfe8',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.categoriaLinguistica === 'vocales' ? 'üî§ Vocales' :
                           flashcardVistaCompleta.categoriaLinguistica === 'consonantes' ? 'üî† Consonantes' :
                           flashcardVistaCompleta.categoriaLinguistica === 'diptongos' ? 'üì¢ Diptongos' :
                           flashcardVistaCompleta.categoriaLinguistica === 'primario' ? 'üéµ Primario' :
                           flashcardVistaCompleta.categoriaLinguistica === 'entonacion' ? '‚ÜóÔ∏è Entonaci√≥n' :
                           flashcardVistaCompleta.categoriaLinguistica === 'lengua' ? 'üëÖ Lengua' :
                           flashcardVistaCompleta.categoriaLinguistica.charAt(0).toUpperCase() + 
                           flashcardVistaCompleta.categoriaLinguistica.slice(1)}
                        </div>
                      )}
                      {flashcardVistaCompleta.nivelLinguistica && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.nivelLinguistica === 'basico' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.nivelLinguistica === 'intermedio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(168, 85, 247, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.nivelLinguistica === 'basico' ? '#4ade80' :
                                 flashcardVistaCompleta.nivelLinguistica === 'intermedio' ? '#fbbf24' :
                                 '#c084fc',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.nivelLinguistica === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.nivelLinguistica === 'intermedio' ? 'üü° Intermedio' :
                           'üü£ Avanzado'}
                        </div>
                      )}
                    </div>
                  )}

                  {/* Badges para M√∫sica */}
                  {flashcardVistaCompleta.tipo === 'musica' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.5rem',
                      alignItems: 'center',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(168, 85, 247, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#f0abfc',
                        fontWeight: '600'
                      }}>
                        üéº {flashcardVistaCompleta.subtipoMusica?.toUpperCase() || 'M√öSICA'}
                      </div>
                      {flashcardVistaCompleta.categoriaMusica && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(168, 85, 247, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#e9d5ff',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.categoriaMusica === 'claves' ? 'üéµ Claves' :
                           flashcardVistaCompleta.categoriaMusica === 'compases' ? 'üìè Compases' :
                           flashcardVistaCompleta.categoriaMusica === 'duraciones' ? '‚è±Ô∏è Duraciones' :
                           flashcardVistaCompleta.categoriaMusica === 'triadas' ? 'üéπ Tr√≠adas' :
                           flashcardVistaCompleta.categoriaMusica === 'septimas' ? 'üé∏ S√©ptimas' :
                           flashcardVistaCompleta.categoriaMusica === 'mayores' ? 'üéµ Mayores' :
                           flashcardVistaCompleta.categoriaMusica === 'menores' ? 'üé∂ Menores' :
                           flashcardVistaCompleta.categoriaMusica.charAt(0).toUpperCase() + 
                           flashcardVistaCompleta.categoriaMusica.slice(1)}
                        </div>
                      )}
                      {flashcardVistaCompleta.nivelMusica && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.nivelMusica === 'basico' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.nivelMusica === 'intermedio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(168, 85, 247, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.nivelMusica === 'basico' ? '#4ade80' :
                                 flashcardVistaCompleta.nivelMusica === 'intermedio' ? '#fbbf24' :
                                 '#c084fc',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.nivelMusica === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.nivelMusica === 'intermedio' ? 'üü° Intermedio' :
                           'üü£ Avanzado'}
                        </div>
                      )}
                    </div>
                  )}

                  {/* Badges para Geometr√≠a */}
                  {flashcardVistaCompleta.tipo === 'geometria' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.5rem',
                      alignItems: 'center',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(34, 197, 94, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#86efac',
                        fontWeight: '600'
                      }}>
                        üìê {flashcardVistaCompleta.subtipoGeometria?.toUpperCase() || 'GEOMETR√çA'}
                      </div>
                      {flashcardVistaCompleta.categoriaGeometria && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(34, 197, 94, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#a7f3d0',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.categoriaGeometria === 'basicos' ? '‚Ä¢ B√°sicos' :
                           flashcardVistaCompleta.categoriaGeometria === 'coordenadas' ? 'üìç Coordenadas' :
                           flashcardVistaCompleta.categoriaGeometria === 'segmentos' ? 'üìè Segmentos' :
                           flashcardVistaCompleta.categoriaGeometria === 'triangulos' ? '‚ñ≥ Tri√°ngulos' :
                           flashcardVistaCompleta.categoriaGeometria === 'cuadrilateros' ? '‚ñ° Cuadril√°teros' :
                           flashcardVistaCompleta.categoriaGeometria === 'construcciones' ? 'üîß Construcciones' :
                           flashcardVistaCompleta.categoriaGeometria.charAt(0).toUpperCase() + 
                           flashcardVistaCompleta.categoriaGeometria.slice(1)}
                        </div>
                      )}
                      {flashcardVistaCompleta.nivelGeometria && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.nivelGeometria === 'basico' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.nivelGeometria === 'intermedio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(168, 85, 247, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.nivelGeometria === 'basico' ? '#4ade80' :
                                 flashcardVistaCompleta.nivelGeometria === 'intermedio' ? '#fbbf24' :
                                 '#c084fc',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.nivelGeometria === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.nivelGeometria === 'intermedio' ? 'üü° Intermedio' :
                           'üü£ Avanzado'}
                        </div>
                      )}
                    </div>
                  )}

                  {/* Badges para Qu√≠mica Avanzada */}
                  {flashcardVistaCompleta.tipo === 'quimica-avanzada' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.5rem',
                      alignItems: 'center',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(192, 132, 252, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#e9d5ff',
                        fontWeight: '600'
                      }}>
                        üß¨ {flashcardVistaCompleta.subtipoQuimicaAvanzada?.toUpperCase() || 'QU√çMICA AVZ'}
                      </div>
                      {flashcardVistaCompleta.categoriaQuimicaAvanzada && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(192, 132, 252, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#ddd6fe',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.categoriaQuimicaAvanzada === 'atomicos' ? '‚öõÔ∏è At√≥micos' :
                           flashcardVistaCompleta.categoriaQuimicaAvanzada === 'sp' ? '‚Üí sp' :
                           flashcardVistaCompleta.categoriaQuimicaAvanzada === 'sp2' ? '‚üÅ sp¬≤' :
                           flashcardVistaCompleta.categoriaQuimicaAvanzada === 'sp3' ? '‚ßì sp¬≥' :
                           flashcardVistaCompleta.categoriaQuimicaAvanzada === 'diatomicos' ? 'üåå Diat√≥micos' :
                           flashcardVistaCompleta.categoriaQuimicaAvanzada === 'flechas' ? '‚Ü∑ Flechas' :
                           flashcardVistaCompleta.categoriaQuimicaAvanzada === 'mecanismos' ? '‚ö° Mecanismos' :
                           flashcardVistaCompleta.categoriaQuimicaAvanzada.charAt(0).toUpperCase() + 
                           flashcardVistaCompleta.categoriaQuimicaAvanzada.slice(1)}
                        </div>
                      )}
                      {flashcardVistaCompleta.nivelQuimicaAvanzada && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.nivelQuimicaAvanzada === 'basico' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.nivelQuimicaAvanzada === 'intermedio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(168, 85, 247, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.nivelQuimicaAvanzada === 'basico' ? '#4ade80' :
                                 flashcardVistaCompleta.nivelQuimicaAvanzada === 'intermedio' ? '#fbbf24' :
                                 '#c084fc',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.nivelQuimicaAvanzada === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.nivelQuimicaAvanzada === 'intermedio' ? 'üü° Intermedio' :
                           'üü£ Avanzado'}
                        </div>
                      )}
                    </div>
                  )}

                  {/* üé≤ Badges de Probabilidad y Estad√≠stica */}
                  {flashcardVistaCompleta.tipo === 'probabilidad' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.75rem',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(139, 92, 246, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#c4b5fd',
                        fontWeight: '600'
                      }}>
                        üé≤ {flashcardVistaCompleta.subtipoProbabilidad?.toUpperCase() || 'PROBABILIDAD'}
                      </div>
                      {flashcardVistaCompleta.categoriaProbabilidad && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(139, 92, 246, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#ddd6fe',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.categoriaProbabilidad === 'simple' ? 'üìä Simple' :
                           flashcardVistaCompleta.categoriaProbabilidad === 'condicional' ? 'üîó Condicional' :
                           flashcardVistaCompleta.categoriaProbabilidad === 'conjunta' ? '‚ö° Conjunta' :
                           flashcardVistaCompleta.categoriaProbabilidad === 'marginal' ? 'üìê Marginal' :
                           flashcardVistaCompleta.categoriaProbabilidad === 'total' ? 'üåê Total' :
                           flashcardVistaCompleta.categoriaProbabilidad.charAt(0).toUpperCase() + 
                           flashcardVistaCompleta.categoriaProbabilidad.slice(1)}
                        </div>
                      )}
                      {flashcardVistaCompleta.nivelProbabilidad && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.nivelProbabilidad === 'basico' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.nivelProbabilidad === 'intermedio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(168, 85, 247, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.nivelProbabilidad === 'basico' ? '#4ade80' :
                                 flashcardVistaCompleta.nivelProbabilidad === 'intermedio' ? '#fbbf24' :
                                 '#c084fc',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.nivelProbabilidad === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.nivelProbabilidad === 'intermedio' ? 'üü° Intermedio' :
                           'üü£ Avanzado'}
                        </div>
                      )}
                    </div>
                  )}

                  {/* üé® Badges de Arte y Dise√±o Visual */}
                  {flashcardVistaCompleta.tipo === 'arte' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.75rem',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(244, 114, 182, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#fbcfe8',
                        fontWeight: '600'
                      }}>
                        üé® {flashcardVistaCompleta.subtipoArte?.toUpperCase() || 'ARTE'}
                      </div>
                      {flashcardVistaCompleta.categoriaArte && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(244, 114, 182, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#f9a8d4',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.categoriaArte === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.categoriaArte === 'intermedio' ? 'üü° Intermedio' :
                           'üü£ Avanzado'}
                        </div>
                      )}
                      {flashcardVistaCompleta.estiloArtistico && flashcardVistaCompleta.estiloArtistico !== 'ninguno' && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(245, 158, 11, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#fbbf24',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.estiloArtistico === 'impresionismo' ? 'üåÖ Impresionismo' :
                           flashcardVistaCompleta.estiloArtistico === 'cubismo' ? 'üìê Cubismo' :
                           flashcardVistaCompleta.estiloArtistico === 'surrealismo' ? 'üåô Surrealismo' :
                           flashcardVistaCompleta.estiloArtistico === 'barroco' ? 'üëë Barroco' :
                           flashcardVistaCompleta.estiloArtistico === 'modernismo' ? 'üèõÔ∏è Modernismo' :
                           flashcardVistaCompleta.estiloArtistico === 'bauhaus' ? '‚ñ≤‚ñ†‚óè Bauhaus' :
                           flashcardVistaCompleta.estiloArtistico === 'ukiyo-e' ? 'üå∏ Ukiyo-e' :
                           flashcardVistaCompleta.estiloArtistico === 'pop-art' ? 'üí• Pop Art' :
                           flashcardVistaCompleta.estiloArtistico.charAt(0).toUpperCase() + flashcardVistaCompleta.estiloArtistico.slice(1)}
                        </div>
                      )}
                    </div>
                  )}

                  {flashcardVistaCompleta.tipo === 'fisica' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.75rem',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(245, 158, 11, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#fbbf24',
                        fontWeight: '600'
                      }}>
                        ‚öõÔ∏è {flashcardVistaCompleta.ramaFisica?.toUpperCase() || 'F√çSICA'}
                      </div>
                      {flashcardVistaCompleta.subtipoFisica && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(245, 158, 11, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#fef3c7',
                          fontWeight: '600'
                        }}>
                          üìê {flashcardVistaCompleta.subtipoFisica === 'diagrama-fuerzas' ? 'Diagrama Fuerzas' :
                               flashcardVistaCompleta.subtipoFisica.charAt(0).toUpperCase() + 
                               flashcardVistaCompleta.subtipoFisica.slice(1)}
                        </div>
                      )}
                      {flashcardVistaCompleta.nivelFisica && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.nivelFisica === 'basico' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.nivelFisica === 'intermedio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(239, 68, 68, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.nivelFisica === 'basico' ? '#4ade80' :
                                 flashcardVistaCompleta.nivelFisica === 'intermedio' ? '#fbbf24' :
                                 '#f87171',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.nivelFisica === 'basico' ? 'üü¢ B√°sico' :
                           flashcardVistaCompleta.nivelFisica === 'intermedio' ? 'üü° Intermedio' :
                           'üî¥ Avanzado'}
                        </div>
                      )}
                    </div>
                  )}
                  {flashcardVistaCompleta.tipo === 'programacion' && (
                    <div style={{
                      marginTop: '0.75rem',
                      display: 'flex',
                      gap: '0.75rem',
                      flexWrap: 'wrap'
                    }}>
                      <div style={{
                        padding: '0.5rem 1rem',
                        background: 'rgba(20, 184, 166, 0.15)',
                        borderRadius: '20px',
                        fontSize: '0.85rem',
                        color: '#5eead4',
                        fontWeight: '600'
                      }}>
                        üíª {flashcardVistaCompleta.lenguaje?.toUpperCase() || 'C√ìDIGO'}
                      </div>
                      {flashcardVistaCompleta.dificultad && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: flashcardVistaCompleta.dificultad === 'facil' ? 'rgba(34, 197, 94, 0.15)' :
                                     flashcardVistaCompleta.dificultad === 'medio' ? 'rgba(251, 191, 36, 0.15)' :
                                     'rgba(239, 68, 68, 0.15)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: flashcardVistaCompleta.dificultad === 'facil' ? '#4ade80' :
                                 flashcardVistaCompleta.dificultad === 'medio' ? '#fbbf24' :
                                 '#f87171',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.dificultad === 'facil' ? 'üü¢ F√°cil' :
                           flashcardVistaCompleta.dificultad === 'medio' ? 'üü° Medio' :
                           'üî¥ Dif√≠cil'}
                        </div>
                      )}
                      {flashcardVistaCompleta.patronCodigo && (
                        <div style={{
                          padding: '0.5rem 1rem',
                          background: 'rgba(100, 116, 139, 0.2)',
                          borderRadius: '20px',
                          fontSize: '0.85rem',
                          color: '#94a3b8',
                          fontWeight: '600'
                        }}>
                          {flashcardVistaCompleta.patronCodigo === 'comprension' ? 'üìñ Comprensi√≥n' :
                           flashcardVistaCompleta.patronCodigo === 'bug' ? 'üêõ Bug' :
                           flashcardVistaCompleta.patronCodigo === 'cloze' ? 'üî§ Cloze' :
                           '‚úçÔ∏è Producci√≥n'}
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {/* Opciones MCQ */}
                {flashcardVistaCompleta.tipo === 'mcq' && flashcardVistaCompleta.opciones && flashcardVistaCompleta.opciones.length > 0 && (
                  <div style={{marginBottom: '1.5rem'}}>
                    <h3 style={{
                      color: '#cbd5e1',
                      fontSize: '1rem',
                      fontWeight: '600',
                      marginBottom: '1rem',
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em'
                    }}>Opciones</h3>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                      {flashcardVistaCompleta.opciones.map((opcion, idx) => (
                        <div key={idx} style={{
                          padding: '1rem',
                          background: 'rgba(100, 116, 139, 0.2)',
                          border: '2px solid rgba(148, 163, 184, 0.2)',
                          borderRadius: '10px',
                          color: '#e2e8f0',
                          fontSize: '1rem',
                          transition: 'all 0.2s ease'
                        }}>
                          {opcion}
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Archivos adjuntos */}
                {flashcardVistaCompleta.archivos && flashcardVistaCompleta.archivos.length > 0 && (
                  <div style={{marginBottom: '1.5rem'}}>
                    <h3 style={{
                      color: '#cbd5e1',
                      fontSize: '1rem',
                      fontWeight: '600',
                      marginBottom: '1rem',
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em'
                    }}>üìé Archivos Adjuntos</h3>
                    <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))', gap: '1rem'}}>
                      {flashcardVistaCompleta.archivos.map((archivo, idx) => (
                        <div key={idx} style={{
                          padding: '1rem',
                          background: 'rgba(100, 116, 139, 0.2)',
                          border: '2px solid rgba(148, 163, 184, 0.2)',
                          borderRadius: '10px',
                          textAlign: 'center'
                        }}>
                          <div style={{fontSize: '2.5rem', marginBottom: '0.5rem'}}>
                            {archivo.tipo?.includes('pdf') ? 'üìï' :
                             archivo.tipo?.includes('word') || archivo.tipo?.includes('document') ? 'üìÑ' :
                             archivo.tipo?.includes('excel') || archivo.tipo?.includes('spreadsheet') ? 'üìä' :
                             'üìé'}
                          </div>
                          <p style={{
                            color: '#cbd5e1',
                            fontSize: '0.85rem',
                            marginBottom: '0.25rem',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap'
                          }}>{archivo.nombre}</p>
                          <p style={{
                            color: '#94a3b8',
                            fontSize: '0.75rem',
                            marginBottom: '0.75rem'
                          }}>{(archivo.tamano / 1024).toFixed(1)} KB</p>
                          {/* Bot√≥n de descarga */}
                          <a
                            href={archivo.url || archivo.base64}
                            download={archivo.nombre}
                            style={{
                              display: 'inline-block',
                              padding: '0.5rem 1rem',
                              background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                              color: 'white',
                              textDecoration: 'none',
                              borderRadius: '8px',
                              fontSize: '0.85rem',
                              fontWeight: '600',
                              cursor: 'pointer',
                              transition: 'all 0.2s'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.transform = 'scale(1.05)'}
                            onMouseLeave={(e) => e.currentTarget.style.transform = 'scale(1)'}
                          >
                            üì• Descargar
                          </a>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Respuesta */}
                <div style={{
                  background: 'rgba(34, 197, 94, 0.08)',
                  padding: '1.5rem',
                  borderRadius: '12px',
                  border: '2px solid rgba(34, 197, 94, 0.3)',
                  marginBottom: '1.5rem'
                }}>
                  <h3 style={{
                    color: '#4ade80',
                    fontSize: '1rem',
                    fontWeight: '600',
                    marginBottom: '1rem',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '0.5rem'
                  }}>
                    ‚úÖ Respuesta Correcta
                  </h3>
                  <div style={{
                    color: '#e2e8f0',
                    fontSize: '1.1rem',
                    lineHeight: '1.8',
                    whiteSpace: 'pre-wrap'
                  }}>
                    {flashcardVistaCompleta.respuestaCorrecta}
                  </div>
                </div>

                {/* Explicaci√≥n */}
                {flashcardVistaCompleta.explicacion && (
                  <div style={{
                    background: 'rgba(251, 191, 36, 0.08)',
                    padding: '1.5rem',
                    borderRadius: '12px',
                    border: '2px solid rgba(251, 191, 36, 0.3)',
                    marginBottom: '1.5rem'
                  }}>
                    <h3 style={{
                      color: '#fbbf24',
                      fontSize: '1rem',
                      fontWeight: '600',
                      marginBottom: '1rem',
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '0.5rem'
                    }}>
                      üí° Explicaci√≥n
                    </h3>
                    <div style={{
                      color: '#e2e8f0',
                      fontSize: '1rem',
                      lineHeight: '1.8',
                      whiteSpace: 'pre-wrap'
                    }}>
                      {flashcardVistaCompleta.explicacion}
                    </div>
                  </div>
                )}

                {/* Metadata */}
                <div style={{
                  display: 'flex',
                  flexWrap: 'wrap',
                  gap: '1rem',
                  padding: '1.5rem',
                  background: 'rgba(100, 116, 139, 0.1)',
                  borderRadius: '12px',
                  border: '1px solid rgba(148, 163, 184, 0.15)'
                }}>
                  {flashcardVistaCompleta.tema && (
                    <div style={{
                      padding: '0.5rem 1rem',
                      background: 'rgba(102, 126, 234, 0.2)',
                      borderRadius: '20px',
                      color: '#cbd5e1',
                      fontSize: '0.9rem'
                    }}>
                      üè∑Ô∏è {flashcardVistaCompleta.tema}
                    </div>
                  )}
                  {flashcardVistaCompleta.subtema && (
                    <div style={{
                      padding: '0.5rem 1rem',
                      background: 'rgba(100, 116, 139, 0.3)',
                      borderRadius: '20px',
                      color: '#94a3b8',
                      fontSize: '0.9rem'
                    }}>
                      üìå {flashcardVistaCompleta.subtema}
                    </div>
                  )}
                  <div style={{
                    padding: '0.5rem 1rem',
                    background: 'rgba(100, 116, 139, 0.3)',
                    borderRadius: '20px',
                    color: '#94a3b8',
                    fontSize: '0.85rem'
                  }}>
                    üìÖ {new Date(flashcardVistaCompleta.fecha).toLocaleDateString('es-ES', {
                      day: 'numeric',
                      month: 'long',
                      year: 'numeric'
                    })}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ============= MODAL ZOOM DE IMAGEN ============= */}
        {imagenZoom && (
          <div className="modal-overlay" onClick={() => setImagenZoom(null)} style={{
            background: 'rgba(0, 0, 0, 0.95)',
            backdropFilter: 'blur(10px)',
            zIndex: 10000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '2rem'
          }}>
            <div style={{
              position: 'relative',
              maxWidth: '95vw',
              maxHeight: '95vh',
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center'
            }}>
              <button
                onClick={() => setImagenZoom(null)}
                style={{
                  position: 'absolute',
                  top: '-50px',
                  right: '0',
                  background: 'rgba(244, 67, 54, 0.9)',
                  color: 'white',
                  border: 'none',
                  borderRadius: '50%',
                  width: '40px',
                  height: '40px',
                  fontSize: '1.5rem',
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  boxShadow: '0 4px 20px rgba(0, 0, 0, 0.5)'
                }}
              >
                ‚úï
              </button>
              <img
                src={imagenZoom}
                alt="Zoom"
                onClick={(e) => e.stopPropagation()}
                style={{
                  maxWidth: '100%',
                  maxHeight: '90vh',
                  objectFit: 'contain',
                  borderRadius: '12px',
                  boxShadow: '0 20px 60px rgba(0, 0, 0, 0.8)'
                }}
              />
            </div>
          </div>
        )}

        {/* ============= MODAL ASISTENTE LaTeX INTELIGENTE ============= */}
        {modalAsistenteLatex && (
          <div className="modal-overlay" onClick={() => setModalAsistenteLatex(false)}>
            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{
              maxWidth: '800px',
              width: '95%',
              background: 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
              border: '2px solid rgba(102, 126, 234, 0.3)',
              boxShadow: '0 20px 60px rgba(102, 126, 234, 0.3)'
            }}>
              <div className="modal-header" style={{
                background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                padding: '1.5rem',
                borderRadius: '14px 14px 0 0'
              }}>
                <h2 style={{
                  margin: 0,
                  color: 'white',
                  fontSize: '1.5rem',
                  fontWeight: '700',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.75rem'
                }}>
                  <span>üß†</span>
                  Asistente LaTeX Inteligente
                </h2>
                <button onClick={() => setModalAsistenteLatex(false)} className="btn-close">‚úï</button>
              </div>

              <div className="modal-body" style={{padding: '2rem'}}>
                <div style={{
                  marginBottom: '1.5rem',
                  padding: '1rem',
                  background: 'rgba(102, 126, 234, 0.1)',
                  borderLeft: '4px solid #667eea',
                  borderRadius: '8px',
                  color: '#cbd5e1',
                  fontSize: '0.95rem',
                  lineHeight: '1.6'
                }}>
                  <strong style={{color: '#667eea'}}>üí° C√≥mo usar:</strong><br/>
                  Describe la expresi√≥n matem√°tica en lenguaje natural y el asistente la convertir√° a LaTeX perfecto.<br/>
                  <br/>
                  <strong>Ejemplos:</strong><br/>
                  ‚Ä¢ "fracci√≥n de 3x sobre x-4"<br/>
                  ‚Ä¢ "integral de 0 a 1 de x al cuadrado"<br/>
                  ‚Ä¢ "ra√≠z cuadrada de x+1"<br/>
                  ‚Ä¢ "matriz de 2x2 con 1 2 3 4"<br/>
                  ‚Ä¢ "l√≠mite de x‚Üí0 de seno x sobre x"
                </div>

                {/* Input de lenguaje natural */}
                <div className="config-section">
                  <label className="config-label">
                    <span className="label-icon">üí¨</span>
                    Describe tu expresi√≥n matem√°tica
                  </label>
                  <textarea
                    className="textarea-prompt"
                    placeholder="Ejemplo: 'quiero una fracci√≥n de 3x m√°s 2 sobre x menos 4'"
                    value={promptLatex}
                    onChange={(e) => setPromptLatex(e.target.value)}
                    rows={3}
                    style={{
                      background: 'rgba(51, 65, 85, 0.4)',
                      border: '2px solid rgba(148, 163, 184, 0.3)',
                      color: '#e2e8f0'
                    }}
                  />
                </div>

                {/* Bot√≥n de generar */}
                <button
                  onClick={() => {
                    const latex = asistenteLaTeX(promptLatex);
                    setLatexGenerado(latex);
                  }}
                  style={{
                    width: '100%',
                    padding: '1rem',
                    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    color: 'white',
                    border: 'none',
                    borderRadius: '10px',
                    fontSize: '1rem',
                    fontWeight: '600',
                    cursor: 'pointer',
                    marginBottom: '1.5rem',
                    transition: 'all 0.2s'
                  }}
                >
                  ‚ú® Generar LaTeX
                </button>

                {/* LaTeX generado */}
                {latexGenerado && (
                  <>
                    <div className="config-section">
                      <label className="config-label">
                        <span className="label-icon">üìê</span>
                        LaTeX Generado
                      </label>
                      <textarea
                        className="textarea-prompt"
                        value={latexGenerado}
                        onChange={(e) => setLatexGenerado(e.target.value)}
                        rows={3}
                        style={{
                          background: 'rgba(59, 130, 246, 0.1)',
                          border: '2px solid rgba(59, 130, 246, 0.3)',
                          color: '#60a5fa',
                          fontFamily: 'monospace'
                        }}
                      />
                    </div>

                    {/* Vista previa renderizada */}
                    <div style={{
                      marginTop: '1rem',
                      padding: '1.5rem',
                      background: 'rgba(59, 130, 246, 0.05)',
                      border: '2px solid rgba(59, 130, 246, 0.3)',
                      borderRadius: '12px'
                    }}>
                      <h4 style={{
                        color: '#60a5fa',
                        fontSize: '0.9rem',
                        marginBottom: '1rem',
                        textTransform: 'uppercase',
                        letterSpacing: '0.05em'
                      }}>üëÅÔ∏è Vista Previa</h4>
                      <div style={{
                        background: 'white',
                        padding: '2rem',
                        borderRadius: '8px',
                        textAlign: 'center',
                        minHeight: '80px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center'
                      }}>
                        <BlockMath math={latexGenerado} />
                      </div>
                    </div>

                    {/* Bot√≥n de insertar */}
                    <button
                      onClick={() => {
                        setFormDataFlashcard({
                          ...formDataFlashcard,
                          contenido: latexGenerado,
                          latex: true
                        });
                        setModalAsistenteLatex(false);
                        setPromptLatex('');
                        setLatexGenerado('');
                      }}
                      style={{
                        width: '100%',
                        padding: '1rem',
                        background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                        color: 'white',
                        border: 'none',
                        borderRadius: '10px',
                        fontSize: '1rem',
                        fontWeight: '600',
                        cursor: 'pointer',
                        marginTop: '1.5rem',
                        transition: 'all 0.2s'
                      }}
                    >
                      ‚úÖ Insertar en Flashcard
                    </button>
                  </>
                )}
              </div>
            </div>
          </div>
        )}

        {/* MODAL DE CONFIGURACI√ìN DE SESI√ìN DE ESTUDIO */}
        {modalConfigSesion && (
          <div className="modal-overlay" onClick={() => setModalConfigSesion(false)}>
            <div className="modal-sesion" onClick={(e) => e.stopPropagation()}>
              <button 
                className="modal-close"
                onClick={() => setModalConfigSesion(false)}
              >
                ‚úï
              </button>
              
              <div className="sesion-header">
                <div className="sesion-icon">üéØ</div>
                <h2>Configura tu Sesi√≥n de Estudio</h2>
                <p>Personaliza tu experiencia de aprendizaje</p>
              </div>

              <div className="sesion-body">
                {/* RESTAURAR SESI√ìN SI EXISTE */}
                {sesionPersistente && !sesionActiva && (
                  <div className="restaurar-sesion-banner">
                    <div className="banner-icon">üîÑ</div>
                    <div className="banner-content">
                      <h3>Sesi√≥n Anterior Detectada</h3>
                      <p>Tienes una sesi√≥n de {sesionPersistente.configuracion?.tiempoSesion || '?'} minutos guardada. Contin√∫a donde lo dejaste.</p>
                      <div className="banner-acciones">
                        <button 
                          className="btn-restaurar"
                          onClick={() => {
                            restaurarSesion(sesionPersistente);
                            setModalConfigSesion(false);
                            setModalSesionAbierto(false);
                            setSelectedMenu('sesion');
                            console.log('‚úÖ Sesi√≥n restaurada y activada');
                          }}
                        >
                          ‚ñ∂Ô∏è Continuar Sesi√≥n
                        </button>
                        <button 
                          className="btn-nueva"
                          onClick={() => {
                            eliminarSesionGuardada();
                            setModalConfigSesion(false);
                            setTimeout(() => setModalConfigSesion(true), 100);
                          }}
                        >
                          üÜï Nueva Sesi√≥n
                        </button>
                      </div>
                    </div>
                  </div>
                )}
                
                <div className="config-section">
                  <label className="config-label">‚è±Ô∏è ¬øCu√°nto tiempo tienes hoy?</label>
                  <div className="tiempo-opciones">
                    {[15, 25, 30, 45, 60].map(minutos => (
                      <button
                        key={minutos}
                        className={`tiempo-opcion ${tiempoSesion === minutos && !modoLibreActivo ? 'active' : ''}`}
                        onClick={() => {
                          setTiempoSesion(minutos);
                          setModoLibreActivo(false);
                          setTiempoPersonalizado('');
                        }}
                      >
                        <span className="tiempo-valor">{minutos}</span>
                        <span className="tiempo-label">min</span>
                      </button>
                    ))}
                  </div>
                  
                  {/* TIEMPO PERSONALIZADO */}
                  <div className="tiempo-personalizado-container">
                    <div className="tiempo-personalizado-input">
                      <input
                        type="number"
                        min="1"
                        max="999"
                        placeholder="Ej: 90"
                        value={tiempoPersonalizado}
                        onChange={(e) => {
                          const valor = e.target.value;
                          setTiempoPersonalizado(valor);
                          if (valor && !isNaN(valor)) {
                            setTiempoSesion(parseInt(valor));
                            setModoLibreActivo(false);
                          }
                        }}
                        className="input-tiempo-custom"
                      />
                      <span className="input-tiempo-label">minutos</span>
                    </div>
                    
                    <div className="modo-libre-toggle">
                      <label className="toggle-container">
                        <input
                          type="checkbox"
                          checked={modoLibreActivo}
                          onChange={(e) => {
                            setModoLibreActivo(e.target.checked);
                            if (e.target.checked) {
                              setTiempoPersonalizado('');
                            }
                          }}
                        />
                        <span className="toggle-slider"></span>
                        <span className="toggle-label">‚ôæÔ∏è Modo Libre (sin l√≠mite)</span>
                      </label>
                    </div>
                  </div>
                </div>

                <div className="config-section">
                  <label className="config-label">üéØ ¬øQu√© quieres priorizar hoy?</label>
                  <div className="prioridad-opciones">
                    <button
                      className={`prioridad-opcion ${prioridadSesion === 'errores' ? 'active' : ''}`}
                      onClick={() => setPrioridadSesion('errores')}
                    >
                      <div className="prioridad-icon">üéØ</div>
                      <h4>Reforzar Errores</h4>
                      <p>Repasa preguntas que fallaste</p>
                    </button>
                    <button
                      className={`prioridad-opcion ${prioridadSesion === 'flashcards' ? 'active' : ''}`}
                      onClick={() => setPrioridadSesion('flashcards')}
                    >
                      <div className="prioridad-icon">üÉè</div>
                      <h4>Mantener Memoria</h4>
                      <p>Repaso espaciado de flashcards</p>
                    </button>
                    <button
                      className={`prioridad-opcion ${prioridadSesion === 'contenido' ? 'active' : ''}`}
                      onClick={() => setPrioridadSesion('contenido')}
                    >
                      <div className="prioridad-icon">üìö</div>
                      <h4>Avanzar Contenido</h4>
                      <p>Estudia material nuevo</p>
                    </button>
                  </div>
                </div>

                {!modoLibreActivo && (
                  <div className="fases-preview">
                    <h3>üìã Plan de tu Sesi√≥n ({tiempoSesion} min)</h3>
                    <div className="fases-lista">
                      {calcularFasesSesion(tiempoSesion, prioridadSesion).map((fase, index) => (
                        <React.Fragment key={fase.tipo}>
                          <div className="fase-preview-item">
                            <div className="fase-preview-emoji">{fase.emoji}</div>
                            <div className="fase-preview-info">
                              <h4>Fase {index + 1}: {fase.nombre}</h4>
                              <p>{Math.floor(fase.duracion / 60)} min - {fase.tipo === 'calentamiento' ? 'Contexto y preparaci√≥n' : 
                                  fase.tipo === 'errores' ? 'Repaso de preguntas falladas' :
                                  fase.tipo === 'flashcards' ? 'Repaso espaciado' :
                                  fase.tipo === 'contenido' ? 'Nuevo material y pr√°cticas' :
                                  'Resumen y reflexi√≥n'}</p>
                            </div>
                          </div>
                          {index < calcularFasesSesion(tiempoSesion, prioridadSesion).length - 1 && (
                            <div className="fase-preview-arrow">‚Üì</div>
                          )}
                        </React.Fragment>
                      ))}
                    </div>
                  </div>
                )}
                
                {modoLibreActivo && (
                  <div className="modo-libre-info">
                    <div className="info-icon">‚ôæÔ∏è</div>
                    <div className="info-content">
                      <h3>Modo Libre Activado</h3>
                      <p>Sin l√≠mite de tiempo. Avanza por las fases a tu ritmo. Puedes pausar y retomar cuando quieras.</p>
                      <p className="info-destacada">‚ú® Tu progreso se guardar√° autom√°ticamente cada 2 minutos</p>
                    </div>
                  </div>
                )}

                <button 
                  className="btn-iniciar-sesion"
                  onClick={iniciarSesionEstudio}
                >
                  <span className="btn-icon">üöÄ</span>
                  <span className="btn-text">Comenzar Sesi√≥n</span>
                  <span className="btn-arrow">‚Üí</span>
                </button>
              </div>
            </div>
          </div>
        )}

        {/* HEADER FIJO DE SESI√ìN ACTIVA - OCULTO, MOVIDO AL SIDEBAR */}
        {false && sesionActiva && (
          <div className={`header-sesion-fijo ${headerCompacto ? 'compacto' : ''}`}>
            <div className="header-sesion-content">
              {/* Izquierda: Info de sesi√≥n */}
              <div className="header-sesion-left">
                <div className="sesion-fase-badge">
                  <span className="fase-emoji">
                    {faseActual === 'calentamiento' ? 'üî•' :
                     faseActual === 'errores' ? '‚ùå' :
                     faseActual === 'flashcards' ? 'üé¥' :
                     faseActual === 'contenido' ? 'üìö' :
                     faseActual === 'descanso' ? (tiempoRestante > 600 ? 'üßò' : '‚òï') :
                     'üìä'}
                  </span>
                  <span className="fase-texto">{obtenerNombreFase(faseActual)}</span>
                </div>
                
                {!headerCompacto && (
                  <div className="sesion-siguiente-info">
                    <span className="siguiente-label">Despu√©s:</span>
                    <span className="siguiente-nombre">{obtenerSiguienteFase(faseActual)}</span>
                  </div>
                )}
                
                {estadoGuardado && (
                  <div className="sesion-guardado-indicator">
                    <span className="guardado-icon">üíæ</span>
                    <span className="guardado-texto">Guardado</span>
                  </div>
                )}
              </div>
              
              {/* Centro: Botones de acci√≥n */}
              <div className="header-sesion-center">
                <button
                  className="btn-header-sesion btn-pausar"
                  onClick={() => setSesionPausada(!sesionPausada)}
                  title={sesionPausada ? 'Reanudar' : 'Pausar'}
                >
                  {sesionPausada ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'}
                  <span className="btn-text">{sesionPausada ? 'Reanudar' : 'Pausar'}</span>
                </button>
                
                <button
                  className="btn-header-sesion btn-cursos"
                  onClick={() => setSelectorCursosAbierto(!selectorCursosAbierto)}
                  title="Explorar cursos"
                >
                  üìö
                  <span className="btn-text">Cursos</span>
                </button>
                
                <button
                  className="btn-header-sesion btn-detener"
                  onClick={detenerSesion}
                  title="Detener sesi√≥n"
                >
                  ‚èπÔ∏è
                  <span className="btn-text">Detener</span>
                </button>
              </div>
              
              {/* Derecha: Timer */}
              <div className="header-sesion-right">
                {!modoLibreActivo ? (
                  <div className="timer-compacto">
                    <div className="timer-icono">‚è±Ô∏è</div>
                    <div className="timer-display">
                      <span className="timer-minutos">{Math.floor(tiempoRestante / 60)}</span>
                      <span className="timer-separador">:</span>
                      <span className="timer-segundos">{String(tiempoRestante % 60).padStart(2, '0')}</span>
                    </div>
                    <div className="timer-progreso-mini">
                      <div 
                        className="timer-progreso-barra"
                        style={{width: `${(tiempoRestante / tiempoFaseActual) * 100}%`}}
                      ></div>
                    </div>
                  </div>
                ) : (
                  <div className="modo-libre-badge">
                    <span className="modo-libre-icon">‚ôæÔ∏è</span>
                    <span className="modo-libre-texto">Modo Libre</span>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}
      </main>
      
      {/* Modal de Mapa de Repetici√≥n Espaciada */}
      {itemMapaRepeticion && (
        <div className="modal-overlay" onClick={() => setItemMapaRepeticion(null)}>
          <div className="modal-mapa-repeticion" onClick={(e) => e.stopPropagation()}>
            <div className="modal-mapa-header">
              <h2>üìä Mapa de Repetici√≥n Espaciada</h2>
              <button 
                className="btn-close-modal"
                onClick={() => setItemMapaRepeticion(null)}
              >
                ‚úï
              </button>
            </div>
            
            <div className="modal-mapa-body">
              {(() => {
                const mapa = generarMapaRepeticiones(itemMapaRepeticion);
                const ahora = new Date();
                
                return (
                  <>
                    {/* Informaci√≥n del Item */}
                    <div className="mapa-item-info">
                      <div className="mapa-item-header">
                        <span className="mapa-item-tipo">{itemMapaRepeticion.tipo || 'üìÑ'}</span>
                        <h3>{itemMapaRepeticion.titulo || 'Sin t√≠tulo'}</h3>
                      </div>
                      <div className="mapa-item-stats">
                        <div className="stat">
                          <span className="stat-label">Estado:</span>
                          <span className={`stat-value estado-${itemMapaRepeticion.estadoRevision || 'nueva'}`}>
                            {itemMapaRepeticion.estadoRevision === 'nueva' && 'üÜï Nueva'}
                            {itemMapaRepeticion.estadoRevision === 'en_progreso' && 'üìñ En Progreso'}
                            {itemMapaRepeticion.estadoRevision === 'dominada' && '‚úÖ Dominada'}
                            {!itemMapaRepeticion.estadoRevision && 'üÜï Nueva'}
                          </span>
                        </div>
                        <div className="stat">
                          <span className="stat-label">Repeticiones:</span>
                          <span className="stat-value">{itemMapaRepeticion.repeticiones || 0}√ó</span>
                        </div>
                        <div className="stat">
                          <span className="stat-label">Facilidad:</span>
                          <span className="stat-value">‚ö° {(itemMapaRepeticion.facilidad || 2.5).toFixed(1)}</span>
                        </div>
                        <div className="stat">
                          <span className="stat-label">Intervalo Actual:</span>
                          <span className="stat-value">
                            {itemMapaRepeticion.intervalo ? 
                              (itemMapaRepeticion.intervalo === 1 ? '1 d√≠a' :
                               itemMapaRepeticion.intervalo < 7 ? `${itemMapaRepeticion.intervalo} d√≠as` :
                               itemMapaRepeticion.intervalo < 30 ? `${Math.round(itemMapaRepeticion.intervalo / 7)} semanas` :
                               `${Math.round(itemMapaRepeticion.intervalo / 30)} meses`) :
                              'Primera vez'}
                          </span>
                        </div>
                        {itemMapaRepeticion.proximaRevision && (
                          <div className="stat">
                            <span className="stat-label">Pr√≥xima Revisi√≥n:</span>
                            <span className="stat-value">
                              {new Date(itemMapaRepeticion.proximaRevision).toLocaleDateString('es-ES', {
                                weekday: 'short',
                                day: 'numeric',
                                month: 'short',
                                year: 'numeric'
                              })}
                            </span>
                          </div>
                        )}
                      </div>
                    </div>
                    
                    {/* Explicaci√≥n del sistema */}
                    <div className="mapa-explicacion">
                      <h4>üìö C√≥mo funciona la Repetici√≥n Espaciada</h4>
                      <p>
                        El sistema SM-2 programa autom√°ticamente tus repasos bas√°ndose en qu√© tan bien recuerdas el contenido.
                        A continuaci√≥n se muestran 3 escenarios simulados de las pr√≥ximas 10 repeticiones:
                      </p>
                    </div>
                    
                    {/* Escenarios de Repetici√≥n */}
                    <div className="mapa-escenarios">
                      {/* Escenario F√°cil */}
                      <div className="escenario escenario-facil">
                        <div className="escenario-header">
                          <span className="escenario-icono">üòä</span>
                          <h4>Si siempre eval√∫as como F√ÅCIL</h4>
                          <p>Los intervalos se extienden r√°pidamente</p>
                        </div>
                        <div className="escenario-timeline">
                          {mapa.escenarios.facil.map((rep, idx) => (
                            <div key={idx} className="timeline-item">
                              <div className="timeline-numero">#{rep.repeticion}</div>
                              <div className="timeline-info">
                                <div className="timeline-fecha">
                                  {rep.fecha.toLocaleDateString('es-ES', {
                                    day: 'numeric',
                                    month: 'short',
                                    year: 'numeric'
                                  })}
                                </div>
                                <div className="timeline-dias">
                                  En {rep.diasDesdeHoy} d√≠a{rep.diasDesdeHoy !== 1 ? 's' : ''}
                                </div>
                                <div className="timeline-intervalo">
                                  Intervalo: {rep.intervalo === 1 ? '1 d√≠a' :
                                    rep.intervalo < 7 ? `${rep.intervalo} d√≠as` :
                                    rep.intervalo < 30 ? `~${Math.round(rep.intervalo / 7)} semanas` :
                                    `~${Math.round(rep.intervalo / 30)} meses`}
                                </div>
                                <div className="timeline-facilidad">
                                  Factor: {rep.facilidad.toFixed(2)}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      {/* Escenario Medio */}
                      <div className="escenario escenario-medio">
                        <div className="escenario-header">
                          <span className="escenario-icono">üòê</span>
                          <h4>Si siempre eval√∫as como MEDIO</h4>
                          <p>Los intervalos crecen moderadamente</p>
                        </div>
                        <div className="escenario-timeline">
                          {mapa.escenarios.medio.map((rep, idx) => (
                            <div key={idx} className="timeline-item">
                              <div className="timeline-numero">#{rep.repeticion}</div>
                              <div className="timeline-info">
                                <div className="timeline-fecha">
                                  {rep.fecha.toLocaleDateString('es-ES', {
                                    day: 'numeric',
                                    month: 'short',
                                    year: 'numeric'
                                  })}
                                </div>
                                <div className="timeline-dias">
                                  En {rep.diasDesdeHoy} d√≠a{rep.diasDesdeHoy !== 1 ? 's' : ''}
                                </div>
                                <div className="timeline-intervalo">
                                  Intervalo: {rep.intervalo === 1 ? '1 d√≠a' :
                                    rep.intervalo < 7 ? `${rep.intervalo} d√≠as` :
                                    rep.intervalo < 30 ? `~${Math.round(rep.intervalo / 7)} semanas` :
                                    `~${Math.round(rep.intervalo / 30)} meses`}
                                </div>
                                <div className="timeline-facilidad">
                                  Factor: {rep.facilidad.toFixed(2)}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      {/* Escenario Dif√≠cil */}
                      <div className="escenario escenario-dificil">
                        <div className="escenario-header">
                          <span className="escenario-icono">üò∞</span>
                          <h4>Si siempre eval√∫as como DIF√çCIL</h4>
                          <p>Los intervalos se mantienen cortos para refuerzo</p>
                        </div>
                        <div className="escenario-timeline">
                          {mapa.escenarios.dificil.map((rep, idx) => (
                            <div key={idx} className="timeline-item">
                              <div className="timeline-numero">#{rep.repeticion}</div>
                              <div className="timeline-info">
                                <div className="timeline-fecha">
                                  {rep.fecha.toLocaleDateString('es-ES', {
                                    day: 'numeric',
                                    month: 'short',
                                    year: 'numeric'
                                  })}
                                </div>
                                <div className="timeline-dias">
                                  En {rep.diasDesdeHoy} d√≠a{rep.diasDesdeHoy !== 1 ? 's' : ''}
                                </div>
                                <div className="timeline-intervalo">
                                  Intervalo: {rep.intervalo === 1 ? '1 d√≠a' :
                                    rep.intervalo < 7 ? `${rep.intervalo} d√≠as` :
                                    rep.intervalo < 30 ? `~${Math.round(rep.intervalo / 7)} semanas` :
                                    `~${Math.round(rep.intervalo / 30)} meses`}
                                </div>
                                <div className="timeline-facilidad">
                                  Factor: {rep.facilidad.toFixed(2)}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                    
                    {/* Resumen */}
                    <div className="mapa-resumen">
                      <h4>üí° Resumen</h4>
                      <ul>
                        <li><strong>F√°cil:</strong> Despu√©s de 10 repeticiones ‚Üí Intervalo de ~{Math.round(mapa.escenarios.facil[9].intervalo / 30)} meses</li>
                        <li><strong>Medio:</strong> Despu√©s de 10 repeticiones ‚Üí Intervalo de ~{Math.round(mapa.escenarios.medio[9].intervalo / 30)} meses</li>
                        <li><strong>Dif√≠cil:</strong> Despu√©s de 10 repeticiones ‚Üí Intervalo de ~{mapa.escenarios.dificil[9].intervalo} d√≠as</li>
                      </ul>
                      <p className="mapa-nota">
                        ‚ú® El sistema se adapta a tu rendimiento real. Mezclar evaluaciones diferentes es completamente normal y esperado.
                      </p>
                    </div>
                  </>
                );
              })()}
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

export default App
